<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyKhuyenMaiView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quản lý Khuyến mãi" FontFamily="Segoe UI" Loaded="Page_Loaded"
      Background="#FFF8E1">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="StatusGreenBrush" Color="#E8F5E9"/>
        <SolidColorBrush x:Key="StatusGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="StatusRedBrush" Color="#FFEBEE"/>
        <Geometry x:Key="IconExcel">M21.17 3.25Q21.5 3.25 21.76 3.5 22 3.74 22 4.08V19.92Q22 20.26 21.76 20.5 21.5 20.75 21.17 20.75H7.83Q7.5 20.75 7.24 20.5 7 20.26 7 19.92V4.08Q7 3.74 7.24 3.5 7.5 3.25 7.83 3.25H21.17M13.83 18.25V15.7H11.5V14.05L13.72 10.63H11.6V9H16.33V10.65L14.12 14.07H16.25V15.7H13.83V18.25M6.25 15.5Q6.25 15.15 6.04 14.88 5.82 14.6 5.5 14.6H3.5Q3.18 14.6 2.96 14.88 2.75 15.15 2.75 15.5V17.5Q2.75 17.82 2.96 18.1 3.18 18.38 3.5 18.38H5.5Q5.82 18.38 6.04 18.1 6.25 17.82 6.25 17.5V15.5M6.25 9.5Q6.25 9.18 6.04 8.9 5.82 8.62 5.5 8.62H3.5Q3.18 8.62 2.96 8.9 2.75 9.18 2.75 9.5V11.5Q2.75 11.82 2.96 12.1 3.18 12.38 3.5 12.38H5.5Q5.82 12.38 6.04 12.1 6.25 11.82 6.25 11.5V9.5Z</Geometry>
        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconFilter">M14,12V19.88C14.04,20.18 13.94,20.5 13.71,20.71C13.32,21.1 12.69,21.1 12.3,20.71L10.29,18.7C10.06,18.47 9.96,18.16 10,17.87V12H14M15,9H9V4H15V9Z</Geometry>
        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>
        <Style x:Key="PromotionDataGridRowStyle" TargetType="DataGridRow">
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding TrangThai}" Value="Hoạt động">
                    <Setter Property="Background" Value="{StaticResource StatusGreenBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TrangThai}" Value="Tạm dừng">
                    <Setter Property="Background" Value="{StaticResource StatusRedBrush}"/>
                    <Setter Property="Foreground" Value="{StaticResource ActionRedBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TrangThai}" Value="Hết hạn">
                    <Setter Property="Background" Value="{StaticResource StatusGrayBrush}"/>
                    <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
                    <Setter Property="FontStyle" Value="Italic"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="450"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Margin="0,0,15,0" Style="{StaticResource CardBorder}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Text="Danh sách Khuyến mãi" Style="{StaticResource HeaderTextBlock}"/>

                    <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,15">
                        <TextBlock Text="Tìm Mã:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                        <TextBox x:Name="txtSearchMaKM" Width="120" TextChanged="Filter_Changed"/>

                        <TextBlock Text="Trạng thái:" VerticalAlignment="Center" Margin="15,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                        <ComboBox x:Name="cmbFilterTrangThai" Width="150" SelectionChanged="Filter_Changed">
                            <ComboBoxItem Content="Tất cả"/>
                            <ComboBoxItem Content="Hoạt động"/>
                            <ComboBoxItem Content="Tạm dừng"/>
                            <ComboBoxItem Content="Hết hạn"/>
                        </ComboBox>
                    </StackPanel>

                    <DataGrid Grid.Row="2" x:Name="dgKhuyenMai" AutoGenerateColumns="False" IsReadOnly="True" 
                              SelectionMode="Single" SelectionChanged="DgKhuyenMai_SelectionChanged"
                              BorderThickness="0" RowHeaderWidth="0"
                              RowStyle="{StaticResource PromotionDataGridRowStyle}">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Mã KM" Binding="{Binding MaKhuyenMai}" Width="100"/>
                            <DataGridTextColumn Header="Tên chương trình" Binding="{Binding TenKhuyenMai}" Width="*"/>
                            <DataGridTextColumn Header="Giảm" Binding="{Binding GiaTriGiam}" Width="80"/>
                            <DataGridTextColumn Header="Tối đa" Binding="{Binding GiamToiDa, StringFormat=N0}" Width="80"/>
                            <DataGridTextColumn Header="SL Còn" Binding="{Binding SoLuongConLai}" Width="80"/>
                            <DataGridTextColumn Header="Bắt đầu" Binding="{Binding NgayBatDau, StringFormat='dd/MM/yy'}" Width="80"/>
                            <DataGridTextColumn Header="Kết thúc" Binding="{Binding NgayKetThuc, StringFormat='dd/MM/yy'}" Width="80"/>
                            <DataGridTextColumn Header="Trạng thái" Binding="{Binding TrangThai}" Width="100"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="0,15,0,0">
                        <Button x:Name="btnQuayLai" Style="{StaticResource BackButton}"
                                HorizontalAlignment="Left" 
                                Click="BtnQuayLai_Click">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="&lt; Quay lại" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>

                        <Button x:Name="btnExportToExcel" HorizontalAlignment="Left" Margin="20,0,0,0"
                                Style="{StaticResource PrimaryButton}" Background="#00724C"
                                Click="BtnExportToExcel_Click">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconExcel}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="Xuất Excel" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <Border Grid.Column="1" Style="{StaticResource CardBorder}">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <TextBlock Text="Thông tin Chương trình Khuyến mãi" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,15"/>

                        <TextBlock Text="Mã Khuyến mãi (Không dấu, VIẾT LIỀN):" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtMaKhuyenMai" Margin="0,0,0,10"/>

                        <TextBlock Text="Tên chương trình:" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtTenKM" Margin="0,0,0,10"/>
                        <TextBlock Text="Mô tả (Ghi chú nội bộ):" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtMoTa" Height="40" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10"/>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,5,0">
                                <TextBlock Text="Loại giảm giá:" Margin="0,0,0,5"/>
                                <ComboBox x:Name="cmbLoaiGiamGia">
                                    <ComboBoxItem Content="Phần Trăm" Tag="PhanTram"/>
                                    <ComboBoxItem Content="Số Tiền" Tag="SoTien"/>
                                </ComboBox>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="5,0,0,0">
                                <TextBlock Text="Giá trị giảm (VND hoặc %):" Margin="0,0,0,5"/>
                                <TextBox x:Name="txtGiaTriGiam"/>
                            </StackPanel>
                        </Grid>

                        <TextBlock Text="Giảm tối đa (Nếu là %):" Margin="0,10,0,5"/>
                        <TextBox x:Name="txtGiamToiDa" Margin="0,0,0,10"/>

                        <TextBlock Text="Mô tả ĐK (Hiển thị ở bảng):" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtDieuKienApDung" Margin="0,0,0,10"/>

                        <TextBlock Text="Điều kiện áp dụng (tùy chọn):" FontWeight="SemiBold" Margin="0,15,0,5"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,5,0">
                                <TextBlock Text="Hóa đơn tối thiểu (VND):" Margin="0,0,0,5"/>
                                <TextBox x:Name="txtDonHangToiThieu"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="5,0,0,0">
                                <TextBlock Text="Số lượng còn lại:" Margin="0,0,0,5"/>
                                <TextBox x:Name="txtSoLuongConLai" ToolTip="Để 0 hoặc trống nếu không giới hạn"/>
                            </StackPanel>
                        </Grid>

                        <TextBlock Text="Sản phẩm áp dụng:" Margin="0,10,0,5"/>
                        <ComboBox x:Name="cmbSanPhamApDung" DisplayMemberPath="Ten" SelectedValuePath="Id"
                                  IsEditable="True" IsTextSearchEnabled="True" Margin="0,0,0,10"/>

                        <Grid Margin="0,10,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,5,0">
                                <TextBlock Text="Ngày Bắt đầu:" Margin="0,0,0,5"/>
                                <DatePicker x:Name="dpNgayBatDau"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="5,0,0,0">
                                <TextBlock Text="Ngày Kết thúc:" Margin="0,0,0,5"/>
                                <DatePicker x:Name="dpNgayKetThuc"/>
                            </StackPanel>
                        </Grid>

                        <Grid Margin="0,10,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,5,0">
                                <TextBlock Text="Thứ (vd: 2,3,4):" Margin="0,0,0,5"/>
                                <TextBox x:Name="txtDayOfWeek"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="5,0,5,0">
                                <TextBlock Text="Giờ Bắt đầu (HH:mm):" Margin="0,0,0,5"/>
                                <TextBox x:Name="txtTimeStart"/>
                            </StackPanel>
                            <StackPanel Grid.Column="2" Margin="5,0,0,0">
                                <TextBlock Text="Giờ Kết thúc (HH:mm):" Margin="0,0,0,5"/>
                                <TextBox x:Name="txtTimeEnd"/>
                            </StackPanel>
                        </Grid>

                        <Button x:Name="btnTamDung" Style="{StaticResource PrimaryButton}" Background="{StaticResource AccentOrangeBrush}" Margin="0,15,0,0" Click="BtnTamDung_Click">
                            <TextBlock Text="Tạm Dừng / Kích Hoạt Lại" VerticalAlignment="Center"/>
                        </Button>

                        <Grid Margin="0,20,0,0" Height="41">
                            <Button x:Name="btnLamMoi" ToolTip="Làm mới" Click="BtnLamMoi_Click" Background="Transparent" BorderThickness="0" Cursor="Hand" Width="41" HorizontalAlignment="Left">
                                <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="22" Height="22"/>
                            </Button>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button x:Name="btnThem" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionGreenBrush}" Click="BtnThem_Click" Margin="0,0,8,0">
                                    <StackPanel Orientation="Horizontal">
                                        <Viewbox Width="23" Height="23" Margin="0,0,8,0">
                                            <Path Data="{StaticResource IconAdd}" Fill="White"/>
                                        </Viewbox>
                                        <TextBlock Text="Thêm" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                                <Button x:Name="btnLuu" Style="{StaticResource PrimaryButton}" Margin="0,0,8,0" Click="BtnLuu_Click">
                                    <StackPanel Orientation="Horizontal">
                                        <Viewbox Width="23" Height="23" Margin="0,0,8,0">
                                            <Path Data="{StaticResource IconSave}" Fill="White"/>
                                        </Viewbox>
                                        <TextBlock Text="Lưu" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                                <Button x:Name="btnXoa" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionRedBrush}" Click="BtnXoa_Click">
                                    <StackPanel Orientation="Horizontal">
                                        <Viewbox Width="23" Height="23" Margin="0,0,8,0">
                                            <Path Data="{StaticResource IconDelete}" Fill="White"/>
                                        </Viewbox>
                                        <TextBlock Text="Xóa" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                        </Grid>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Đang tải..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>