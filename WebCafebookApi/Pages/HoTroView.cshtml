@page "/ho-tro"
@model WebCafebookApi.Pages.HoTroViewModel
@{
    ViewData["Title"] = "Trung tâm Hỗ trợ";
    Layout = "_Layout";
}

@section Styles {
    <style>
        /* === CAFEBOOK THEME VARIABLES === */
        :root {
            --cf-brown-dark: #4E342E;
            --cf-brown-light: #A1887F;
            --cf-terracotta-dark: #E65100; /* Primary accent */
            --cf-terracotta-light: #FF7043;
            --cf-beige: #F9F9F9; /* Chat history background */
            --cf-cream: #FFF8E1;
            --cf-white: #FFFFFF;
            --cf-text: #333;
            --cf-text-light: #757575;
            --cf-border: #EEEEEE;
        }

        .page-title-account {
            color: var(--cf-brown-dark);
            font-weight: 700;
        }

        .page-lead-account {
            color: var(--cf-text-light);
            font-size: 1.1rem;
        }

        /* === CHAT WINDOW === */
        .chat-window-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
            overflow: hidden;
        }

        .chat-window {
            display: flex;
            flex-direction: column;
            height: 70vh; /* Tăng chiều cao */
            max-height: 750px;
            background-color: var(--cf-white);
        }

        /* === CHAT HISTORY (Nâng cấp) === */
        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem; /* Tăng khoảng cách */
            background-color: var(--cf-beige);
        }

            /* Tùy chỉnh thanh cuộn */
            .chat-history::-webkit-scrollbar {
                width: 8px;
            }

            .chat-history::-webkit-scrollbar-track {
                background: var(--cf-beige);
            }

            .chat-history::-webkit-scrollbar-thumb {
                background-color: #D1C4E9; /* Màu tím nhạt từ theme Material */
                border-radius: 20px;
                border: 2px solid var(--cf-beige);
            }

                .chat-history::-webkit-scrollbar-thumb:hover {
                    background-color: #B39DDB;
                }

        /* === CHAT ROW (Cấu trúc mới với Avatar) === */
        .chat-message-row {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @@keyframes popIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .chat-message-row .message-content {
            display: flex;
            flex-direction: column;
            max-width: 75%;
        }

        /* === AVATAR === */
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--cf-white);
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .avatar-user {
            background-color: var(--cf-terracotta-dark);
        }

            .avatar-user .material-symbols-outlined {
                font-size: 24px;
            }

        .avatar-bot {
            background-color: var(--cf-brown-light);
        }

            .avatar-bot .material-symbols-outlined {
                font-size: 24px;
            }

        /* === CHAT BUBBLE (Nâng cấp) === */
        .chat-bubble {
            padding: 0.8rem 1.25rem;
            border-radius: 1.25rem;
            line-height: 1.6;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        /* Bot (AI/Nhân viên) */
        .bot-row .message-content {
            align-items: flex-start;
        }

        .chat-bubble-bot {
            background-color: var(--cf-white);
            color: var(--cf-text);
            border: 1px solid var(--cf-border);
            border-bottom-left-radius: 0.25rem;
        }

        /* User (Khách hàng) */
        .user-row {
            flex-direction: row-reverse; /* Đảo ngược hàng */
        }

            .user-row .message-content {
                align-items: flex-end;
            }

        .chat-bubble-user {
            background: linear-gradient(135deg, var(--cf-terracotta-light), var(--cf-terracotta-dark));
            color: white;
            border-bottom-right-radius: 0.25rem;
        }

        /* === THỜI GIAN === */
        .chat-bubble-time {
            font-size: 0.75rem;
            color: var(--cf-text-light);
            margin-top: 6px;
            padding: 0 0.5rem;
        }

        /* === INPUT FORM (Material Design) === */
        .chat-input-form {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--cf-border);
            background-color: var(--cf-white);
            gap: 1rem;
        }

        .chat-input-wrapper {
            position: relative;
            flex-grow: 1;
        }

        #chatMessageInput {
            border: none;
            border-bottom: 2px solid var(--cf-border);
            border-radius: 0;
            padding: 0.75rem 0.25rem;
            font-size: 1.1rem;
            width: 100%;
            transition: border-color 0.3s ease;
        }

            #chatMessageInput:focus {
                box-shadow: none;
                border-color: var(--cf-terracotta-dark);
            }

            #chatMessageInput::placeholder {
                color: #BDBDBD;
            }

        #sendButton {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--cf-terracotta-dark);
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

            #sendButton .material-symbols-outlined {
                color: var(--cf-white);
                font-size: 28px;
                transition: transform 0.3s ease;
            }

            #sendButton:hover {
                background-color: var(--cf-terracotta-light);
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
                transform: translateY(-2px);
            }

            #sendButton:disabled {
                background-color: #E0E0E0;
                box-shadow: none;
            }

                #sendButton:disabled .material-symbols-outlined {
                    color: #9E9E9E;
                }
    </style>
}

<div class="container my-5">

    <div class="main-content-card">
        <h3 class="page-title-account">@ViewData["Title"]</h3>
        <p class="page-lead-account">Chào @Model.HoTroData.TenKhachHang, bạn cần Cafebook hỗ trợ gì hôm nay?</p>

        <hr class="my-4" />

        <div class="row">
            <div class="col-lg-10 mx-auto">
                <div class="chat-window-card">
                    <div class="chat-window">

                        <div class="chat-history" id="chat-history">
                            @foreach (var msg in Model.HoTroData.LichSuChat)
                            {
                                <div class="chat-message-row @(msg.IsUser ? "user-row" : "bot-row")">
                                    <div class="chat-avatar @(msg.IsUser ? "avatar-user" : "avatar-bot")">
                                        <span class="material-symbols-outlined">
                                            @(msg.IsUser ? "person" : "support_agent")
                                        </span>
                                    </div>

                                    <div class="message-content">
                                        <div class="chat-bubble @(msg.IsUser ? "chat-bubble-user" : "chat-bubble-bot")">
                                            @Html.Raw(msg.NoiDung.Replace("\n", "<br />"))
                                        </div>
                                        <div class="chat-bubble-time @(msg.IsUser ? "text-end" : "text-start")">
                                            @msg.ThoiGian.ToString("HH:mm")
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <form method="post" id="chatForm" class="chat-input-form" asp-antiforgery="true">
                            <input type="hidden" id="IdKhachHang" value="@Model.HoTroData.IdKhachHang" />
                            <input type="hidden" id="GuestSessionId" value="@Model.HoTroData.GuestSessionId" />
                            <input type="hidden" id="JwtToken" value="@Model.JwtToken" />

                            <div class="chat-input-wrapper">
                                <input asp-for="Input.NoiDung" id="chatMessageInput" class="form-control" placeholder="Nhập câu hỏi của bạn..." autocomplete="off" />
                            </div>
                            <button type="submit" id="sendButton" class="btn">
                                <span class="material-symbols-outlined">send</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
@section Scripts {

    <partial name="_ValidationScriptsPartial" />
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script>
                const apiBaseUrl = '@Model.ApiBaseUrl';
        $(document).ready(function () {
                    const $chatHistory = $('#chat-history');
                    const $chatForm = $('#chatForm');
                    const $chatInput = $('#chatMessageInput');
                    const $sendButton = $('#sendButton');

                    // === DỮ LIỆU CHAT TỪ MODEL ===
                    const idKhachHang = parseInt($('#IdKhachHang').val()) || 0;

                  const guestSessionId = $('#GuestSessionId').val() || null;
                    const jwtToken = $('#JwtToken').val() || null;
                    const antiForgeryToken = $('input[name="__RequestVerificationToken"]').val();

                    const groupName = idKhachHang > 0 ? `khach_${idKhachHang}` : `guest_${guestSessionId}`;

                    // === NÂNG CẤP: KHAI BÁO BIẾN LƯU TRỮ ===
                    const storageKey = `chat_history_${groupName}`;
                    let currentIdThongBao = null; // ID phiếu hỗ trợ

        let isRealtimeMode = false; // Cờ đánh dấu chế độ chat
                    let hubConnection = null; // Đối tượng SignalR

                    // === NÂNG CẤP: CÁC HÀM LƯU TRỮ SESSION ===
                    function getHistoryFromSession() {
                        try {
                            return JSON.parse(sessionStorage.getItem(storageKey) || '[]');
                        } catch (e) {
                            return [];
                        }
                    }

                    function saveHistoryToSession(history) {
                        sessionStorage.setItem(storageKey, JSON.stringify(history));
                    }

                    function saveMessageToHistory(message) {
                        const history = getHistoryFromSession();
                        // Tránh lưu trùng lặp tin nhắn chào
                        if (message.idChat === 0 && history.length > 0) {
                            return;
                        }
                        history.push(message);
                        saveHistoryToSession(history);
                    }

                    // === HÀM VẼ UI (Đã đổi tên) ===
                    function drawMessage(message, isUser, isStaff = false) {
                        // (isStaff = true nếu là nhân viên)
                        const rowClass = isUser ?
        'user-row' : (isStaff ? 'staff-row' : 'bot-row');
                        const avatarClass = isUser ? 'avatar-user' : (isStaff ? 'avatar-staff' : 'avatar-bot');
        const avatarIcon = isUser ? 'person' : (isStaff ? 'support' : 'support_agent');
                        const bubbleClass = isUser ?
        'chat-bubble-user' : (isStaff ? 'chat-bubble-staff' : 'chat-bubble-bot');
                        const timeAlign = isUser ? 'text-end' : 'text-start';
        const formattedContent = (message.noiDung || '').replace(/\n/g, '<br />');
                        const time = new Date(message.thoiGian).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        const $row = $('<div></div>').addClass('chat-message-row ' + rowClass);
                        const $avatar = $('<div></div>').addClass('chat-avatar ' + avatarClass)
                            .html(`<span class="material-symbols-outlined">${avatarIcon}</span>`);
        const $content = $('<div></div>').addClass('message-content');
                        const $bubble = $('<div></div>').addClass('chat-bubble ' + bubbleClass).html(formattedContent);
                        const $time = $('<div></div>').addClass('chat-bubble-time ' + timeAlign).text(time);

                        $content.append($bubble).append($time);
                        $row.append($avatar).append($content);
        $chatHistory.append($row);
                    }

                    // === NÂNG CẤP: HÀM TẢI LỊCH SỬ CHAT KHI VÀO TRANG ===
                    function loadChatHistory() {
                        const history = getHistoryFromSession();

                        // Lấy tin nhắn chào mặc định từ server (nếu có)
                        const serverWelcomeMessage = @Html.Raw(Json.Serialize(Model.HoTroData.LichSuChat.FirstOrDefault()));

                        if (history.length === 0 && serverWelcomeMessage) {
                            // Nếu session rỗng, lưu tin nhắn chào của server vào
                            saveMessageToHistory(serverWelcomeMessage);
                            // (Không cần vẽ vì server đã vẽ rồi)
                        }
                        else if (history.length > 0) {
                            // Nếu session có, xóa tin nhắn server vẽ và vẽ lại toàn bộ
                            $chatHistory.html(''); // Xóa tin nhắn "Chào bạn" do server render
                            history.forEach(msg => {
                                const isUser = msg.loaiTinNhan === 'KhachHang';
                                const isStaff = msg.loaiTinNhan === 'NhanVien';
                                drawMessage(msg, isUser, isStaff);
                            });
                        }
                    }

                    function scrollToBottom() { $chatHistory.scrollTop($chatHistory[0].scrollHeight);
        }

                    // === CHẠY HÀM TẢI LỊCH SỬ ===
                    loadChatHistory();
                    scrollToBottom();


                    // === LOGIC CHAT HYBRID (Đã cập nhật) ===

                    $chatForm.on('submit', async function (e) {
                        e.preventDefault();
                        const messageText = $chatInput.val();
                        if (!messageText.trim()) return;


           $chatInput.val('').prop('disabled', true);
                        $sendButton.prop('disabled', true);

                        if (isRealtimeMode && hubConnection) {
                            // --- CHẾ ĐỘ 2: GỬI QUA SIGNALR (Chat với NV) ---
                            try {

                         await hubConnection.invoke("SendMessageFromClient",
                                    groupName,
                                    messageText,

          idKhachHang,
                                    guestSessionId,
                                    currentIdThongBao
                                );

          } catch (err) {
                                console.error(err.toString());
                                alert('Mất kết nối. Không thể gửi tin nhắn.');
        } finally {
                                $chatInput.prop('disabled', false).focus();
        $sendButton.prop('disabled', false);
                            }
                        } else {
                            // --- CHẾ ĐỘ 1: GỬI QUA FETCH (Chat với AI) ---
                            const payload = { noiDung: messageText, guestSessionId: guestSessionId };
        const headers = {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': antiForgeryToken
                            };
        if (jwtToken) { headers['Authorization'] = 'Bearer ' + jwtToken; }

                            try {
                                const response = await fetch(`${apiBaseUrl}/api/web/hotro/send`, {
                                    method: 'POST',

                        headers: headers,
                                    body: JSON.stringify(payload)
                                });
        if (response.status === 401) { /* ... (Xử lý 401) ... */ }
                                if (!response.ok) { throw new Error('Lỗi máy chủ');
        }

                                const result = await response.json();
        // SendChatResponseDto

                                // NÂNG CẤP: Vẽ và Lưu tin nhắn của khách
                                drawMessage(result.tinNhanCuaKhach, true, false);
                                saveMessageToHistory(result.tinNhanCuaKhach);

                                // NÂNG CẤP: Vẽ và Lưu tin nhắn của AI
                                if (result.tinNhanPhanHoi) {
                                    setTimeout(() => {
                                        drawMessage(result.tinNhanPhanHoi, false, false);
                                        saveMessageToHistory(result.tinNhanPhanHoi);

                                    scrollToBottom();
                                    }, 300);
        }

                                // === KÍCH HOẠT SIGNALR ===
                                if (result.idThongBaoHoTro && result.idThongBaoHoTro > 0) {
                                    currentIdThongBao = result.idThongBaoHoTro;
        isRealtimeMode = true; // Chuyển chế độ
                                    await startSignalRConnection();
        // Bắt đầu kết nối
                                }

                            } catch (error) {
                                console.error('Lỗi khi gửi tin nhắn (Fetch):', error);
        alert('Không thể gửi tin nhắn. Vui lòng thử lại.');
                            } finally {
                                $chatInput.prop('disabled', false).focus();
        $sendButton.prop('disabled', false);
                                scrollToBottom();
                            }
                        }
                    });
        // === HÀM KẾT NỐI VÀ LẮNG NGHE SIGNALR (Đã cập nhật) ===
                    async function startSignalRConnection() {
                        if (hubConnection) return;
        // Đã kết nối

                        hubConnection = new signalR.HubConnectionBuilder()
                            .withUrl(apiBaseUrl + "/chatHub")
                            .build();
        // Lắng nghe tin nhắn TỪ SERVER (của Nhân viên HOẶC của chính mình)
                        hubConnection.on("ReceiveMessage", function (message) {

                            const isUser = message.loaiTinNhan === 'KhachHang';
                            const isStaff = message.loaiTinNhan === 'NhanVien';

                            // NÂNG CẤP: Vẽ và Lưu
                            drawMessage(message, isUser, isStaff);
                            saveMessageToHistory(message);
                            scrollToBottom();
              });

                        // Bắt đầu kết nối
                        try {
                            await hubConnection.start();
        console.log("SignalR Connected (Client).");
                            await hubConnection.invoke("JoinGroup", groupName);
                            console.log(`Joined group (Client): ${groupName}`);
        } catch (err) {
                            console.error(err.toString());
        }
                    }
                });
    </script>
}