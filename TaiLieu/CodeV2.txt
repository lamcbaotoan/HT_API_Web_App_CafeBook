Solution 'AppCafebookApi'/
│
├── AppCafebookApi/ (Client WPF Desktop)
│   ├── Dependencies/
│   ├── Assets/ # Tài Nguyên
│   │   ├── Images/ # Hình Ảnh
│   │   │   ├── default-avatar.png
│   │   │   ├── default-book-cover.png
│   │   │   ├── default-food-icon.png
│   │   │   ├── logo.ico
│   │   │   └── logo.png
│   │   └── Fonts/ # Phông Chữ
│   │       └── Font Awesome 6 Free-Solid-900.otf
│   ├── Services/ # Các dịch vụ client (WPF)
│   │   ├── AuthService.cs
│   │   └── HinhAnhHelper.cs
│   ├── View/ # Các giao diện (Views/Windows)
│   │   ├── quanly/ #Chức Năng QuanLy
│   │   │   ├── pages/
│   │   │   │   ├── QuanLyBanView.xaml
│   │   │   │   └── TongQuanView.xaml
│   │   │   └── ManHinhQuanLy.xaml
│   │   ├── nhanvien/ #Chức Năng Nhân Viên
│   │   │   ├── pages/
│   │   │   │   └── SoDoBanView.xaml
│   │   │   └── ManHinhNhanVien.xaml
│   │   └── common/ #Các cửa sổ Window chung
│   │       ├── Baocao...PreviewWindow.xaml (và các file preview khác)
│   │       ├── CaiDatWindow.xaml
│   │       ├── InputDialogWindow.xaml
│   │       └── WelcomeWindow.xaml
│   ├── App.xaml
│   ├── AssemblyInfo.cs
│   ├── ManHinhDangNhap.xaml
│   └── logo.ico
│
├── CafebookApi/ (Backend - Web API)
│   ├── Connected Services/
│   ├── Dependencies/
│   ├── Properties/
│   │   └── launchSettings.json
│   ├── Controllers/ # Các Controller
│   │   ├── App/  # Controller cho Ứng Dụng WPF
│   │   │   ├── BanQuanLyController.cs
│   │   │   ├── BaoCaoHieuSuatController.cs
│   │   │   ├── BaoCaoSachController.cs
│   │   │   ├── BaoCaoTonKhoController.cs
│   │   │   ├── CaiDatController.cs
│   │   │   ├── DashboardController.cs
│   │   │   ├── SoDoBanController.cs
│   │   │   ├── TaiKhoanController.cs
│   │   │   └── ThongBaoController.cs
│   │   ├── Shared/ # Controller dùng chung
│   │   └── Web/ # Controller cho Web
│   │       ├── KhachHangTaiKhoanController.cs
│   │       ├── NhanVienTaiKhoanController.cs
│   │       └── TrangChuController.cs
│   ├── Data/ # Lớp Dữ Liệu
│   │   └── CafebookDbContext.cs
│   ├── Services/ # Các Dịch Vụ (Business Logic)
│   ├── appsettings.json
│   └── Program.cs
│
├── CafebookModel/ (Thư viện dùng chung)
│   ├── Dependencies/
│   ├── Model/ # Các Mô Hình Dữ Liệu
│   │   ├── Data/ # Lớp Dữ Liệu Chung
│   │   │   └── NhanVienDto.cs
│   │   ├── Entities/ # Các Thực Thể (Database Tables)
│   │   │   └── ThongBao.cs
│   │   ├── ModelApi/ # Mô Hình cho API
│   │   │   ├── LoginRequestModel.cs
│   │   │   └── LoginResponseModel.cs
│   │   ├── ModelApp/ # Mô Hình DTO cho Ứng Dụng WPF
│   │   │   ├── BanQuanLyDto.cs
│   │   │   ├── BaoCaoDto.cs
│   │   │   ├── BaoCaoHieuSuatDto.cs
│   │   │   ├── BaoCaoSachDto.cs
│   │   │   ├── BaoCaoTonKhoDto.cs
│   │   │   ├── CaiDatDto.cs
│   │   │   ├── ChartDataPoint.cs
│   │   │   ├── DashboardSummaryDto.cs
│   │   │   ├── SoDoBanDto.cs
│   │   │   └── ThongBaoDto.cs
│   │   └── ModelWeb/ # Mô Hình DTO cho Web
│   │       ├── DangKyRequestModel.cs
│   │       ├── KhachHangDto.cs
│   │       ├── TrangChuDto.cs
│   │       └── WebLoginResponseModel.cs
│   ├── Services/ # Các Dịch Vụ (chung)
│   └── Utils/ # Các Tiện Ích
│       ├── Entities.cs
│       └── HinhAnhPaths.cs
│
└── WebCafebookApi/ (Client Web - Razor Pages)
    ├── Connected Services/
    ├── Dependencies/
    ├── Properties/
    │   └── launchSettings.json
    ├── wwwroot/
    │   ├── css/
    │   │   └── site.css
    │   ├── images/
    │   │   ├── default-avatar.png
    │   │   ├── default-book-cover.png
    │   │   ├── default-food-icon.png
    │   │   ├── logo.ico
    │   │   └── logo.png
    │   ├── js/
    │   │   ├── profile.js
    │   │   └── site.js
    │   ├── lib/ (chứa bootstrap, jquery...)
    │   └── favicon.ico
    ├── Data/ # Lớp Dữ Liệu (của Web)
    ├── Pages/ # Các Trang Razor
    │   ├── account/  # Trang Tài Khoản
    │   │   ├── DangKyView.cshtml
    │   │   ├── DangNhapView.cshtml
    │   │   ├── DangXuat.cshtml
    │   │   └── QuenMatKhauView.cshtml
    │   ├── employee/ # Trang Nhân Viên
    │   │   ├── _Layout_Employee.cshtml
    │   │   ├── _ViewStart.cshtml
    │   │   ├── DangNhapEmployee.cshtml
    │   │   ├── DangXuat.cshtml
    │   │   ├── SoDoBanView.cshtml
    │   │   └── WebQuanLyView.cshtml
    │   ├── Shared/ # Các Thành Phần Chung
    │   │   ├── _Layout.cshtml
    │   │   ├── _LoginPartial.cshtml
    │   │   └── _ValidationScriptsPartial.cshtml
    │   ├── _ViewImports.cshtml
    │   ├── _ViewStart.cshtml
    │   └── TrangChuView.cshtml
    ├── Services/ # Các Dịch Vụ (của Web)
    ├── appsettings.json
    └── Program.cs
////////////////////////////

/// ///////////////////////////////
using CafebookModel.Model.Data;
using CafebookModel.Model.ModelApi;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;

namespace AppCafebookApi.Services
{
    public static class AuthService
    {
        // 1. Lưu trữ thông tin người dùng hiện tại
        public static NhanVienDto? CurrentUser { get; private set; }

        // 2. Cấu hình HttpClient
        private static readonly HttpClient _httpClient;

        static AuthService()
        {
            _httpClient = new HttpClient
            {
                // Lấy từ file launchSettings.json của API
                BaseAddress = new System.Uri("http://localhost:5166")
            };
            _httpClient.DefaultRequestHeaders.Accept.Clear();
            _httpClient.DefaultRequestHeaders.Accept.Add(
                new System.Net.Http.Headers.MediaTypeWithQualityHeaderValue("application/json"));
        }

        // 3. Đăng nhập bằng API
        public static async Task<LoginResponseModel> LoginAsync(LoginRequestModel model)
        {
            try
            {
                var response = await _httpClient.PostAsJsonAsync("/api/app/taikhoan/login", model);

                if (response.IsSuccessStatusCode)
                {
                    var loginResponse = await response.Content.ReadFromJsonAsync<LoginResponseModel>();
                    if (loginResponse != null && loginResponse.Success)
                    {
                        CurrentUser = loginResponse.UserData; // Lưu người dùng
                    }
                    return loginResponse ?? new LoginResponseModel { Success = false, Message = "Không thể đọc phản hồi." };
                }

                // Thử đọc nội dung lỗi nếu có
                var errorResponse = await response.Content.ReadFromJsonAsync<LoginResponseModel>();
                return errorResponse ?? new LoginResponseModel { Success = false, Message = $"Lỗi: {response.StatusCode}" };
            }
            catch (HttpRequestException ex)
            {
                return new LoginResponseModel { Success = false, Message = $"Lỗi kết nối API: {ex.Message}" };
            }
        }

        // 4. Kiểm tra tài khoản Backdoor
        public static LoginResponseModel LoginBackdoor(LoginRequestModel model)
        {
            if (model.TenDangNhap == "admin@cafebook.com" && model.MatKhau == "123456")
            {
                var user = new NhanVienDto
                {
                    HoTen = "Quản trị viên Hệ thống",
                    TenVaiTro = "Quản trị viên",
                    DanhSachQuyen = new List<string> { "FULL" }
                };
                CurrentUser = user; // Lưu người dùng
                return new LoginResponseModel { Success = true, UserData = user };
            }

            if (model.TenDangNhap == "nhanvien@cafebook.com" && model.MatKhau == "123456")
            {
                var user = new NhanVienDto
                {
                    HoTen = "Nhân viên Demo",
                    TenVaiTro = "Phục vụ",
                    DanhSachQuyen = new List<string> { "BanHang.Xem" }
                };
                CurrentUser = user; // Lưu người dùng
                return new LoginResponseModel { Success = true, UserData = user };
            }

            // Nếu không phải backdoor
            return new LoginResponseModel { Success = false };
        }

        // 1. HÀM ĐĂNG XUẤT (XÓA DỮ LIỆU SESSION)
        public static void Logout()
        {
            CurrentUser = null;
        }

        // 2. HÀM KIỂM TRA MỘT QUYỀN
        public static bool CoQuyen(string idQuyen)
        {
            if (CurrentUser == null || CurrentUser.DanhSachQuyen == null)
            {
                return false;
            }

            // Quản trị viên (từ CSDL) hoặc backdoor "FULL" luôn có quyền
            if (CurrentUser.TenVaiTro == "Quản trị viên" || CurrentUser.DanhSachQuyen.Contains("FULL"))
            {
                return true;
            }

            // Kiểm tra quyền cụ thể
            return CurrentUser.DanhSachQuyen.Contains(idQuyen);
        }

        // 3. HÀM KIỂM TRA NHIỀU QUYỀN (Logic "OR")
        // (Rất hữu ích để kiểm tra 1 trong nhiều quyền, ví dụ: QL Kho)
        public static bool CoQuyen(params string[] quyenIds)
        {
            if (CurrentUser == null || CurrentUser.DanhSachQuyen == null)
            {
                return false;
            }

            if (CurrentUser.TenVaiTro == "Quản trị viên" || CurrentUser.DanhSachQuyen.Contains("FULL"))
            {
                return true;
            }

            // Kiểm tra xem người dùng có BẤT KỲ quyền nào trong danh sách không
            return quyenIds.Any(id => CurrentUser.DanhSachQuyen.Contains(id));
        }
    }
}
////////////////////////////
/// using System;
using System.IO;
using System.Windows.Media; // Thêm
using System.Windows.Media.Imaging;

namespace AppCafebookApi.Services
{
    public static class HinhAnhHelper
    {
        public static BitmapImage LoadImageFromBase64(string? base64String, string defaultImagePath)
        {
            try
            {
                if (string.IsNullOrEmpty(base64String))
                {
                    // Nếu không có Base64, tải ảnh mặc định
                    return LoadImageFromUri(defaultImagePath);
                }

                // Thử giải mã Base64
                byte[] imageBytes = Convert.FromBase64String(base64String);
                using (var ms = new MemoryStream(imageBytes))
                {
                    var image = new BitmapImage();
                    image.BeginInit();
                    image.CacheOption = BitmapCacheOption.OnLoad;
                    image.StreamSource = ms;
                    image.EndInit();
                    image.Freeze();
                    return image;
                }
            }
            catch
            {
                // Nếu Base64 bị lỗi, cũng tải ảnh mặc định
                return LoadImageFromUri(defaultImagePath);
            }
        }

        private static BitmapImage LoadImageFromUri(string uriPath)
        {
            try
            {
                // Thử tải ảnh từ URI
                var image = new BitmapImage();
                var uri = new Uri($"pack://application:,,,/AppCafebookApi;component{uriPath}", UriKind.Absolute);

                image.BeginInit();
                image.UriSource = uri;
                image.CacheOption = BitmapCacheOption.OnLoad;
                image.EndInit();
                image.Freeze();
                return image;
            }
            catch (Exception)
            {
                // ---------- SỬA LỖI TẠI ĐÂY ----------
                // Nếu tải file bị lỗi (VÍ DỤ SAI BUILD ACTION)
                // Tạo một ảnh 1x1 pixel rỗng (Transparent) để không bị crash

                var image = new BitmapImage();

                // Sửa "Transparent" thành "Pbgra32"
                var writeableBitmap = new WriteableBitmap(1, 1, 96, 96, PixelFormats.Pbgra32, null);

                using (var stream = new MemoryStream())
                {
                    var encoder = new PngBitmapEncoder();
                    encoder.Frames.Add(BitmapFrame.Create(writeableBitmap));
                    encoder.Save(stream);
                    stream.Position = 0; // Reset stream về đầu

                    image.BeginInit();
                    image.CacheOption = BitmapCacheOption.OnLoad;
                    image.StreamSource = stream; // Dùng StreamSource thay vì UriSource
                    image.EndInit();
                }

                image.Freeze();
                return image;
            }
        }
    }
}
////////////////////////////
/// <Page x:Class="AppCafebookApi.View.common.BaocaodoanhthuPreviewWindow"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:local="clr-namespace:AppCafebookApi.View.common"
      mc:Ignorable="d"
      Title="Xem trước Báo cáo Doanh thu - Lợi nhuận" 
      d:DesignHeight="720" d:DesignWidth="1000"
      Background="#FFF8E1"
      FontFamily="Segoe UI"
      Loaded="Page_Loaded">
    
    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        
        <Style TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,8"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="KpiCard" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="15"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="KpiValue" TargetType="TextBlock">
            <Setter Property="FontSize" Value="24"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>
        <Style x:Key="KpiTitle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
        </Style>
        <Style TargetType="DataGrid">
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="CanUserAddRows" Value="False"/>
            <Setter Property="CanUserDeleteRows" Value="False"/>
            <Setter Property="IsReadOnly" Value="True"/>
            <Setter Property="AutoGenerateColumns" Value="False"/>
            <Setter Property="GridLinesVisibility" Value="None"/>
        </Style>
    </Page.Resources>

    <Grid Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="White" Padding="15" Margin="10" CornerRadius="8">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="Từ ngày:" VerticalAlignment="Center" Margin="5"/>
                <DatePicker x:Name="dpStartDate" Width="150" VerticalAlignment="Center"/>
                <TextBlock Text="Đến ngày:" VerticalAlignment="Center" Margin="20,5,5,5"/>
                <DatePicker x:Name="dpEndDate" Width="150" VerticalAlignment="Center"/>
                <Button x:Name="btnGenerate" Content="Tạo Báo Cáo" Margin="20,0,0,0" Click="BtnGenerate_Click"/>
            </StackPanel>
        </Border>

        <Grid Grid.Row="1" Margin="10,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblDoanhThuRong" Text="0" Style="{StaticResource KpiValue}" Foreground="#42A5F5"/>
                    <TextBlock Text="Doanh Thu Ròng" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="1" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblTongGiaVon" Text="0" Style="{StaticResource KpiValue}" Foreground="#EF5350"/>
                    <TextBlock Text="Tổng Giá Vốn (COGS)" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="2" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblLoiNhuanGop" Text="0" Style="{StaticResource KpiValue}" Foreground="#FFA726"/>
                    <TextBlock Text="Lợi Nhuận Gộp" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="3" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblChiPhiOpex" Text="0" Style="{StaticResource KpiValue}" Foreground="#EF5350"/>
                    <TextBlock Text="Chi Phí Vận Hành" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="4" Style="{StaticResource KpiCard}" Margin="0">
                <StackPanel>
                    <TextBlock x:Name="lblLoiNhuanRong" Text="0" Style="{StaticResource KpiValue}" Foreground="#66BB6A"/>
                    <TextBlock Text="Lợi Nhuận Ròng (Dự kiến)" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
        </Grid>

        <TabControl Grid.Row="2" Margin="10">
            <TabItem Header="Top Sản phẩm Bán chạy">
                <DataGrid x:Name="dgTopSanPham">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Tên Sản Phẩm" Binding="{Binding TenSanPham}" Width="*"/>
                        <DataGridTextColumn Header="Tổng Số Lượng" Binding="{Binding TongSoLuongBan}" Width="150"/>
                        <DataGridTextColumn Header="Tổng Doanh Thu" Binding="{Binding TongDoanhThu, StringFormat=N0}" Width="200"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="Chi tiết Doanh thu">
                <DataGrid x:Name="dgChiTietDoanhThu" MaxHeight="300" VerticalAlignment="Top">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Chỉ số" Binding="{Binding Key}" Width="*" FontWeight="SemiBold"/>
                        <DataGridTextColumn Header="Giá trị" Binding="{Binding Value, StringFormat=N0}" Width="200"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="Chi tiết Chi phí &amp; Giá vốn">
                <DataGrid x:Name="dgChiTietChiPhi" MaxHeight="300" VerticalAlignment="Top">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Chỉ số" Binding="{Binding Key}" Width="*" FontWeight="SemiBold"/>
                        <DataGridTextColumn Header="Giá trị" Binding="{Binding Value, StringFormat=N0}" Width="200"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
        </TabControl>

        <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="25">
            <Button x:Name="btnBack" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" 
                    Click="BtnBack_Click">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="&lt; Quay lại Trang Tổng Quan" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>

            <Button x:Name="btnExportToExcel" 
                    Content="Xuất Excel" 
                    Margin="20,0,0,0" 
                    HorizontalAlignment="Right"
                    Click="BtnExportToExcel_Click" />
        </StackPanel>

        <Border x:Name="LoadingOverlay" Grid.Row="1" Grid.RowSpan="3" Background="#80FFFFFF" Visibility="Collapsed">
            <TextBlock Text="Đang tạo báo cáo..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
////////////////////////////
/// using System;
using System.Collections.Generic;
using System.Globalization;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;

// --- THÊM CÁC USING ĐỂ XUẤT EXCEL ---
using System.IO;
using Microsoft.Win32;
using OfficeOpenXml;
using OfficeOpenXml.Style;

namespace AppCafebookApi.View.common
{
    public partial class BaocaodoanhthuPreviewWindow : Page
    {
        private static readonly HttpClient httpClient;
        private BaoCaoTongHopDto? currentReportData;

        static BaocaodoanhthuPreviewWindow()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public BaocaodoanhthuPreviewWindow()
        {
            InitializeComponent();
        }

        private void Page_Loaded(object sender, RoutedEventArgs e)
        {
            var now = DateTime.Now;
            dpStartDate.SelectedDate = new DateTime(now.Year, now.Month, 1);
            dpEndDate.SelectedDate = now;
        }

        private async void BtnGenerate_Click(object sender, RoutedEventArgs e)
        {
            if (dpStartDate.SelectedDate == null || dpEndDate.SelectedDate == null)
            {
                MessageBox.Show("Vui lòng chọn cả Ngày bắt đầu và Ngày kết thúc.", "Thiếu thông tin");
                return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            btnGenerate.IsEnabled = false;

            var request = new BaoCaoRequestDto
            {
                StartDate = dpStartDate.SelectedDate.Value,
                EndDate = dpEndDate.SelectedDate.Value
            };

            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/baocao/doanhthu", request);
                if (response.IsSuccessStatusCode)
                {
                    currentReportData = await response.Content.ReadFromJsonAsync<BaoCaoTongHopDto>();
                    if (currentReportData != null)
                    {
                        PopulateUi(currentReportData);
                    }
                }
                else
                {
                    MessageBox.Show($"Lỗi API: {response.ReasonPhrase}", "Lỗi");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Không thể kết nối API: {ex.Message}", "Lỗi");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
                btnGenerate.IsEnabled = true;
            }
        }

        private void PopulateUi(BaoCaoTongHopDto data)
        {
            var culture = CultureInfo.GetCultureInfo("vi-VN");

            lblDoanhThuRong.Text = data.Kpi.DoanhThuRong.ToString("C0", culture);
            lblTongGiaVon.Text = data.Kpi.TongGiaVon.ToString("C0", culture);
            lblLoiNhuanGop.Text = data.Kpi.LoiNhuanGop.ToString("C0", culture);
            lblChiPhiOpex.Text = data.Kpi.ChiPhiOpex.ToString("C0", culture);
            lblLoiNhuanRong.Text = data.Kpi.LoiNhuanRong.ToString("C0", culture);

            dgTopSanPham.ItemsSource = data.TopSanPham;

            var dtList = new List<KeyValuePair<string, decimal>>
            {
                new("Tổng doanh thu gốc", data.ChiTietDoanhThu.TongDoanhThuGoc),
                new("Tổng giảm giá", data.ChiTietDoanhThu.TongGiamGia),
                new("Tổng phụ thu", data.ChiTietDoanhThu.TongPhuThu),
                new("DOANH THU RÒNG", data.ChiTietDoanhThu.DoanhThuRong),
                new("Tổng số hóa đơn", data.ChiTietDoanhThu.SoLuongHoaDon),
                new("Giá trị trung bình HĐ", data.ChiTietDoanhThu.GiaTriTrungBinhHD)
            };
            dgChiTietDoanhThu.ItemsSource = dtList;

            var cpList = new List<KeyValuePair<string, decimal>>
            {
                new("Tổng Giá Vốn Hàng Bán (COGS)", data.ChiTietChiPhi.TongGiaVon_COGS),
                new("Tổng Chi Phí Lương", data.ChiTietChiPhi.TongChiPhiLuong),
                new("Tổng Chi Phí Hủy Hàng", data.ChiTietChiPhi.TongChiPhiHuyHang)
            };
            dgChiTietChiPhi.ItemsSource = cpList;
        }

        private async void BtnExportToExcel_Click(object sender, RoutedEventArgs e)
        {
            if (currentReportData == null)
            {
                MessageBox.Show("Chưa có dữ liệu báo cáo để xuất. Vui lòng nhấn 'Tạo Báo Cáo' trước.", "Chưa có dữ liệu");
                return;
            }

            // SỬA LỖI CS8629: Kiểm tra null cho DatePicker ở đây
            if (dpStartDate.SelectedDate == null || dpEndDate.SelectedDate == null)
            {
                MessageBox.Show("Ngày bắt đầu hoặc kết thúc không hợp lệ.", "Lỗi");
                return;
            }

            var sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                FileName = $"BaoCaoDoanhThu_{DateTime.Now:yyyyMMdd_HHmm}.xlsx"
            };

            if (sfd.ShowDialog() == true)
            {
                try
                {
                    LoadingOverlay.Visibility = Visibility.Visible;

                    // SỬA LỖI CS8629: Truyền ngày vào hàm
                    await CreateExcelReportAsync(
                        sfd.FileName,
                        currentReportData,
                        dpStartDate.SelectedDate.Value,
                        dpEndDate.SelectedDate.Value);

                    LoadingOverlay.Visibility = Visibility.Collapsed;
                    MessageBox.Show($"Đã xuất báo cáo thành công!\n\nĐường dẫn: {sfd.FileName}", "Thành công", MessageBoxButton.OK, MessageBoxImage.Information);
                }
                catch (Exception ex)
                {
                    LoadingOverlay.Visibility = Visibility.Collapsed;
                    MessageBox.Show($"Có lỗi khi xuất Excel: {ex.Message}\n\nĐảm bảo bạn đã đóng file Excel (nếu nó đang mở).", "Lỗi Xuất File", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        // Dán đè lên hàm CreateExcelReportAsync CŨ của bạn
        private async Task CreateExcelReportAsync(string filePath, BaoCaoTongHopDto data, DateTime startDate, DateTime endDate)
        {
            // Giấy phép EPPlus
            ExcelPackage.License.SetNonCommercialPersonal("CafeBook");
            var fileInfo = new FileInfo(filePath);

            // Xóa file cũ nếu tồn tại
            if (fileInfo.Exists)
            {
                fileInfo.Delete();
            }

            using (var package = new ExcelPackage(fileInfo))
            {
                // --- 1. ĐỊNH NGHĨA CÁC STYLE TÁI SỬ DỤNG ---

                // Style cho Tiêu đề chính (Merge cell, to, đậm)
                Action<ExcelRange> styleMainTitle = (range) =>
                {
                    range.Merge = true;
                    range.Style.Font.Bold = true;
                    range.Style.Font.Size = 16;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    range.Style.Fill.PatternType = ExcelFillStyle.Solid;
                    range.Style.Fill.BackgroundColor.SetColor(System.Drawing.ColorTranslator.FromHtml("#333366")); // Xanh đậm
                    range.Style.Font.Color.SetColor(System.Drawing.Color.White);
                };

                // Style cho Tiêu đề phụ (Merge cell, nghiêng)
                Action<ExcelRange> styleSubTitle = (range) =>
                {
                    range.Merge = true;
                    range.Style.Font.Italic = true;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                };

                // Style cho Tiêu đề nhóm (Đậm, nền xám)
                Action<ExcelRange> styleGroupHeader = (range) =>
                {
                    range.Merge = true;
                    range.Style.Font.Bold = true;
                    range.Style.Fill.PatternType = ExcelFillStyle.Solid;
                    range.Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);
                };

                // Định dạng tiền tệ VND (canh phải)
                var currencyFormat = "#,##0 \"đ\"";
                Action<ExcelRange> styleCurrency = (range) =>
                {
                    range.Style.Numberformat.Format = currencyFormat;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                };

                // Style cho Lợi nhuận (Xanh, đậm)
                Action<ExcelRange> styleProfit = (range) =>
                {
                    styleCurrency(range);
                    range.Style.Font.Bold = true;
                    range.Style.Font.Color.SetColor(System.Drawing.Color.Green);
                };

                // Style cho Chi phí (Đỏ)
                Action<ExcelRange> styleExpense = (range) =>
                {
                    styleCurrency(range);
                    range.Style.Font.Color.SetColor(System.Drawing.Color.Red);
                };

                // --- 2. SHEET 1: BÁO CÁO TỔNG QUAN (P&L) ---
                var wsPL = package.Workbook.Worksheets.Add("Báo Cáo Tổng Quan");

                // Tiêu đề
                wsPL.Cells["A1:D1"].Value = "BÁO CÁO KINH DOANH TỔNG QUAN";
                styleMainTitle(wsPL.Cells["A1:D1"]);

                wsPL.Cells["A2:D2"].Value = $"Từ ngày {startDate:dd/MM/yyyy} đến {endDate:dd/MM/yyyy}";
                styleSubTitle(wsPL.Cells["A2:D2"]);

                // P&L (Lợi nhuận & Lỗ)
                wsPL.Cells["A4:B4"].Value = "KẾT QUẢ KINH DOANH CHÍNH (P&L)";
                styleGroupHeader(wsPL.Cells["A4:B4"]);

                wsPL.Cells["A5"].Value = "Doanh Thu Ròng";
                wsPL.Cells["B5"].Value = data.Kpi.DoanhThuRong;
                styleCurrency(wsPL.Cells["B5"]);

                wsPL.Cells["A6"].Value = "(-) Tổng Giá Vốn (COGS)";
                wsPL.Cells["B6"].Value = data.Kpi.TongGiaVon;
                styleExpense(wsPL.Cells["B6"]);

                wsPL.Cells["A7"].Value = "(=) Lợi Nhuận Gộp";
                wsPL.Cells["B7"].Value = data.Kpi.LoiNhuanGop;
                styleProfit(wsPL.Cells["B7"]); // Lợi nhuận gộp nên luôn là màu xanh

                wsPL.Cells["A8"].Value = "(-) Chi Phí Vận Hành (OPEX)";
                wsPL.Cells["B8"].Value = data.Kpi.ChiPhiOpex;
                styleExpense(wsPL.Cells["B8"]);

                wsPL.Cells["A9"].Value = "(=) LỢI NHUẬN RÒNG";
                wsPL.Cells["B9"].Value = data.Kpi.LoiNhuanRong;
                // Lợi nhuận ròng có thể âm hoặc dương
                if (data.Kpi.LoiNhuanRong >= 0)
                {
                    styleProfit(wsPL.Cells["B9"]);
                }
                else
                {
                    styleExpense(wsPL.Cells["B9"]);
                }
                wsPL.Cells["A9"].Style.Font.Bold = true;

                // Kẻ viền cho bảng P&L
                wsPL.Cells["A4:B9"].Style.Border.BorderAround(ExcelBorderStyle.Medium);

                // Chi tiết Doanh thu
                wsPL.Cells["D4:E4"].Value = "CHI TIẾT DOANH THU";
                styleGroupHeader(wsPL.Cells["D4:E4"]);
                wsPL.Cells["D5"].Value = "Tổng doanh thu gốc";
                wsPL.Cells["E5"].Value = data.ChiTietDoanhThu.TongDoanhThuGoc;
                wsPL.Cells["D6"].Value = "Tổng giảm giá";
                wsPL.Cells["E6"].Value = data.ChiTietDoanhThu.TongGiamGia;
                wsPL.Cells["D7"].Value = "Tổng phụ thu";
                wsPL.Cells["E7"].Value = data.ChiTietDoanhThu.TongPhuThu;
                wsPL.Cells["D8"].Value = "DOANH THU RÒNG";
                wsPL.Cells["E8"].Value = data.ChiTietDoanhThu.DoanhThuRong;
                wsPL.Cells["D8,E8"].Style.Font.Bold = true;

                wsPL.Cells["D10"].Value = "Số lượng hóa đơn";
                wsPL.Cells["E10"].Value = data.ChiTietDoanhThu.SoLuongHoaDon;
                wsPL.Cells["D11"].Value = "Giá trị trung bình HĐ";
                wsPL.Cells["E11"].Value = data.ChiTietDoanhThu.GiaTriTrungBinhHD;

                // Định dạng tiền tệ cho nhóm Doanh Thu
                styleCurrency(wsPL.Cells["E5:E8"]);
                styleCurrency(wsPL.Cells["E11"]);
                wsPL.Cells["E10"].Style.Numberformat.Format = "#,##0";
                wsPL.Cells["D4:E11"].Style.Border.BorderAround(ExcelBorderStyle.Medium);

                // Chi tiết Chi Phí
                wsPL.Cells["D13:E13"].Value = "CHI TIẾT CHI PHÍ";
                styleGroupHeader(wsPL.Cells["D13:E13"]);
                wsPL.Cells["D14"].Value = "Tổng Giá Vốn (COGS)";
                wsPL.Cells["E14"].Value = data.ChiTietChiPhi.TongGiaVon_COGS;
                wsPL.Cells["D15"].Value = "Tổng Chi Phí Lương";
                wsPL.Cells["E15"].Value = data.ChiTietChiPhi.TongChiPhiLuong;
                wsPL.Cells["D16"].Value = "Tổng Chi Phí Hủy Hàng";
                wsPL.Cells["E16"].Value = data.ChiTietChiPhi.TongChiPhiHuyHang;

                // Định dạng tiền tệ cho nhóm Chi Phí
                styleCurrency(wsPL.Cells["E14:E16"]);
                wsPL.Cells["D13:E16"].Style.Border.BorderAround(ExcelBorderStyle.Medium);

                // Tự động căn chỉnh cột
                wsPL.Cells[wsPL.Dimension.Address].AutoFitColumns();
                wsPL.Column(1).Width = 25; // Cột A
                wsPL.Column(2).Width = 20; // Cột B
                wsPL.Column(4).Width = 25; // Cột D
                wsPL.Column(5).Width = 20; // Cột E

                // --- 3. SHEET 2: TOP SẢN PHẨM ---
                var wsTop = package.Workbook.Worksheets.Add("Top Sản Phẩm");

                wsTop.Cells["A1:C1"].Value = "TOP SẢN PHẨM BÁN CHẠY";
                styleMainTitle(wsTop.Cells["A1:C1"]);

                wsTop.Cells["A2:C2"].Value = $"Từ ngày {startDate:dd/MM/yyyy} đến {endDate:dd/MM/yyyy}";
                styleSubTitle(wsTop.Cells["A2:C2"]);

                // Dùng LoadFromCollection để tạo bảng tự động
                wsTop.Cells["A4"].LoadFromCollection(data.TopSanPham, true, OfficeOpenXml.Table.TableStyles.Medium9);

                // Định dạng lại cột số lượng và tiền tệ trong bảng
                var tbl = wsTop.Tables[0];
                tbl.Columns["TongSoLuongBan"].TotalsRowFunction = OfficeOpenXml.Table.RowFunctions.Sum;
                wsTop.Cells[tbl.Address.Start.Row + 1, tbl.Columns["TongSoLuongBan"].Position + 1, tbl.Address.End.Row, tbl.Columns["TongSoLuongBan"].Position + 1].Style.Numberformat.Format = "#,##0";

                tbl.Columns["TongDoanhThu"].TotalsRowFunction = OfficeOpenXml.Table.RowFunctions.Sum;
                wsTop.Cells[tbl.Address.Start.Row + 1, tbl.Columns["TongDoanhThu"].Position + 1, tbl.Address.End.Row, tbl.Columns["TongDoanhThu"].Position + 1].Style.Numberformat.Format = currencyFormat;

                wsTop.Cells[wsTop.Dimension.Address].AutoFitColumns();

                // --- 4. LƯU FILE ---
                await package.SaveAsync();
            }
        }

        private void BtnBack_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
/////////////////////////////
/// <Page x:Class="AppCafebookApi.View.common.BaoCaoHieuSuatNhanVientPreviewWindow"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.common"
      mc:Ignorable="d" 
      d:DesignHeight="720" d:DesignWidth="1000"
      Title="Báo cáo Hiệu suất Nhân viên"
      Background="#FFF8E1"
      FontFamily="Segoe UI"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>

        <Style TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,8"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="KpiCard" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="15"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="KpiValue" TargetType="TextBlock">
            <Setter Property="FontSize" Value="24"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>
        <Style x:Key="KpiTitle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
        </Style>
        <Style TargetType="DataGrid">
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="CanUserAddRows" Value="False"/>
            <Setter Property="CanUserDeleteRows" Value="False"/>
            <Setter Property="IsReadOnly" Value="True"/>
            <Setter Property="AutoGenerateColumns" Value="False"/>
            <Setter Property="GridLinesVisibility" Value="None"/>
        </Style>
    </Page.Resources>

    <Grid Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="White" Padding="15" Margin="10" CornerRadius="8">
            <WrapPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="Từ ngày:" VerticalAlignment="Center" Margin="5"/>
                <DatePicker x:Name="dpStartDate" Width="150" VerticalAlignment="Center" Margin="0,0,15,0"/>

                <TextBlock Text="Đến ngày:" VerticalAlignment="Center" Margin="5"/>
                <DatePicker x:Name="dpEndDate" Width="150" VerticalAlignment="Center" Margin="0,0,15,0"/>

                <TextBlock Text="Vai trò:" VerticalAlignment="Center" Margin="5"/>
                <ComboBox x:Name="cmbVaiTro" Width="150" VerticalAlignment="Center" Margin="0,0,15,0"
                          DisplayMemberPath="Ten" SelectedValuePath="Id"/>

                <TextBlock Text="Tên nhân viên:" VerticalAlignment="Center" Margin="5"/>
                <TextBox x:Name="txtSearchNhanVien" Width="150" VerticalAlignment="Center" Margin="0,0,15,0"/>

                <Button x:Name="btnGenerate" Content="Tạo Báo Cáo" Margin="20,15,0,0" Click="BtnGenerate_Click"/>
            </WrapPanel>
        </Border>

        <Grid Grid.Row="1" Margin="10,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblTongDoanhThu" Text="0" Style="{StaticResource KpiValue}" Foreground="#42A5F5"/>
                    <TextBlock Text="Tổng Doanh Thu (NV)" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="1" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblTongGioLam" Text="0" Style="{StaticResource KpiValue}" Foreground="#6F4E37"/>
                    <TextBlock Text="Tổng Giờ Làm (Đã CC)" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="2" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblTongSoCaLam" Text="0" Style="{StaticResource KpiValue}" Foreground="#66BB6A"/>
                    <TextBlock Text="Tổng Số Ca Làm" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="3" Style="{StaticResource KpiCard}" Margin="0">
                <StackPanel>
                    <TextBlock x:Name="lblTongLanHuyMon" Text="0" Style="{StaticResource KpiValue}" Foreground="#EF5350"/>
                    <TextBlock Text="Tổng Lần Hủy Món (Lỗi)" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
        </Grid>

        <TabControl x:Name="MainTabControl" Grid.Row="2" Margin="10">
            <TabItem Header="Hiệu suất Bán hàng">
                <DataGrid x:Name="dgSalesPerformance">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Tên Nhân Viên" Binding="{Binding HoTen}" Width="*"/>
                        <DataGridTextColumn Header="Vai Trò" Binding="{Binding TenVaiTro}" Width="120"/>
                        <DataGridTextColumn Header="Tổng Doanh Thu" Binding="{Binding TongDoanhThu, StringFormat=N0}" Width="130"/>
                        <DataGridTextColumn Header="Số HĐ" Binding="{Binding SoHoaDon}" Width="80"/>
                        <DataGridTextColumn Header="Doanh thu / HĐ" Binding="{Binding DoanhThuTrungBinh, StringFormat=N0}" Width="120"/>
                        <DataGridTextColumn Header="Số lần Hủy món" Binding="{Binding SoLanHuyMon}" Width="120"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="Hiệu suất Vận hành (Kho)">
                <DataGrid x:Name="dgOperationalPerformance">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Tên Nhân Viên" Binding="{Binding HoTen}" Width="*"/>
                        <DataGridTextColumn Header="Vai Trò" Binding="{Binding TenVaiTro}" Width="120"/>
                        <DataGridTextColumn Header="Số Phiếu Nhập" Binding="{Binding PhieuNhap}" Width="120"/>
                        <DataGridTextColumn Header="Số Phiếu Kiểm" Binding="{Binding PhieuKiem}" Width="120"/>
                        <DataGridTextColumn Header="Số Phiếu Hủy" Binding="{Binding PhieuHuy}" Width="120"/>
                        <DataGridTextColumn Header="Số Đơn Đã Duyệt" Binding="{Binding DonDuyet}" Width="120"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="Chuyên cần &amp; Vi phạm">
                <DataGrid x:Name="dgAttendance">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Tên Nhân Viên" Binding="{Binding HoTen}" Width="*"/>
                        <DataGridTextColumn Header="Tổng Số Ca Làm" Binding="{Binding TongSoCaLam}" Width="120"/>
                        <DataGridTextColumn Header="Tổng Giờ Làm (CC)" Binding="{Binding TongGioLam}" Width="140"/>
                        <DataGridTextColumn Header="Số Đơn Xin Nghỉ" Binding="{Binding SoDonXinNghi}" Width="120"/>
                        <DataGridTextColumn Header="Đã Duyệt" Binding="{Binding SoDonDaDuyet}" Width="100"/>
                        <DataGridTextColumn Header="Chờ Duyệt" Binding="{Binding SoDonChoDuyet}" Width="100"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
        </TabControl>

        <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="25">
            <Button x:Name="btnBack" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" 
                    Click="BtnBack_Click">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="&lt; Quay lại Trang Tổng Quan" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>

            <Button x:Name="btnExportToExcel" 
                    Content="Xuất Excel" 
                    Margin="20,0,0,0" 
                    HorizontalAlignment="Right"
                    Click="BtnExportToExcel_Click" />
        </StackPanel>

        <Border x:Name="LoadingOverlay" Grid.Row="1" Grid.RowSpan="3" Background="#80FFFFFF" Visibility="Collapsed">
            <TextBlock Text="Đang tạo báo cáo..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
/////////////////////////////
/// using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.IO;
using Microsoft.Win32;
using OfficeOpenXml;
using OfficeOpenXml.Style;
using System.Threading.Tasks;
using Newtonsoft.Json.Linq; // Cần NuGet Newtonsoft.Json
using System.Globalization;

namespace AppCafebookApi.View.common
{
    public partial class BaoCaoHieuSuatNhanVientPreviewWindow : Page
    {
        private static readonly HttpClient httpClient;
        private BaoCaoHieuSuatTongHopDto? currentReportData;

        static BaoCaoHieuSuatNhanVientPreviewWindow()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public BaoCaoHieuSuatNhanVientPreviewWindow()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            // Thiết lập ngày mặc định (ví dụ: tháng này)
            var now = DateTime.Now;
            dpStartDate.SelectedDate = new DateTime(now.Year, now.Month, 1);
            dpEndDate.SelectedDate = now;

            await LoadFiltersAsync();
            await GenerateReportAsync();
        }

        private async Task LoadFiltersAsync()
        {
            try
            {
                var response = await httpClient.GetStringAsync("api/app/baocaohieusuat/filters");
                var json = JObject.Parse(response);

                var vaiTros = json["vaiTros"]?.ToObject<List<FilterLookupDto>>() ?? new List<FilterLookupDto>();
                vaiTros.Insert(0, new FilterLookupDto { Id = 0, Ten = "Tất cả Vai trò" });
                cmbVaiTro.ItemsSource = vaiTros;
                cmbVaiTro.SelectedValue = 0;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Không thể tải bộ lọc: {ex.Message}", "Lỗi API");
            }
        }

        private async void BtnGenerate_Click(object sender, RoutedEventArgs e)
        {
            await GenerateReportAsync();
        }

        private async Task GenerateReportAsync()
        {
            if (dpStartDate.SelectedDate == null || dpEndDate.SelectedDate == null)
            {
                MessageBox.Show("Vui lòng chọn cả Ngày bắt đầu và Ngày kết thúc.", "Thiếu thông tin");
                return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            btnGenerate.IsEnabled = false;

            var request = new BaoCaoHieuSuatRequestDto
            {
                StartDate = dpStartDate.SelectedDate.Value,
                EndDate = dpEndDate.SelectedDate.Value,
                SearchText = string.IsNullOrEmpty(txtSearchNhanVien.Text) ? null : txtSearchNhanVien.Text,
                VaiTroId = (int)cmbVaiTro.SelectedValue == 0 ? (int?)null : (int)cmbVaiTro.SelectedValue,
            };

            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/baocaohieusuat/report", request);
                if (response.IsSuccessStatusCode)
                {
                    currentReportData = await response.Content.ReadFromJsonAsync<BaoCaoHieuSuatTongHopDto>();
                    if (currentReportData != null)
                    {
                        PopulateUi(currentReportData);
                    }
                }
                else
                {
                    MessageBox.Show($"Lỗi API: {response.ReasonPhrase}", "Lỗi");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Không thể kết nối API: {ex.Message}", "Lỗi");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
                btnGenerate.IsEnabled = true;
            }
        }

        private void PopulateUi(BaoCaoHieuSuatTongHopDto data)
        {
            var culture = CultureInfo.GetCultureInfo("vi-VN");

            // 1. Cập nhật Thẻ KPI
            lblTongDoanhThu.Text = data.Kpi.TongDoanhThu.ToString("C0", culture);
            lblTongGioLam.Text = data.Kpi.TongGioLam.ToString("N1");
            lblTongSoCaLam.Text = data.Kpi.TongSoCaLam.ToString();
            lblTongLanHuyMon.Text = data.Kpi.TongLanHuyMon.ToString();

            // 2. Cập nhật các Tab
            dgSalesPerformance.ItemsSource = data.SalesPerformance;
            dgOperationalPerformance.ItemsSource = data.OperationalPerformance;
            dgAttendance.ItemsSource = data.Attendance;
        }

        // Dán đè lên hàm BtnExportToExcel_Click CŨ
        private async void BtnExportToExcel_Click(object sender, RoutedEventArgs e)
        {
            if (currentReportData == null)
            {
                MessageBox.Show("Chưa có dữ liệu báo cáo để xuất. Vui lòng nhấn 'Lọc Báo Cáo' trước.", "Chưa có dữ liệu");
                return;
            }

            // KIỂM TRA QUAN TRỌNG: Đảm bảo ngày đã được chọn
            if (dpStartDate.SelectedDate == null || dpEndDate.SelectedDate == null)
            {
                MessageBox.Show("Vui lòng chọn ngày bắt đầu và kết thúc hợp lệ.", "Lỗi ngày");
                return;
            }

            var sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                FileName = $"BaoCaoHieuSuatNV_{DateTime.Now:yyyyMMdd_HHmm}.xlsx"
            };

            if (sfd.ShowDialog() == true)
            {
                try
                {
                    LoadingOverlay.Visibility = Visibility.Visible;

                    // SỬA LỖI: Truyền ngày vào hàm
                    await CreateExcelReportAsync(
                        sfd.FileName,
                        currentReportData,
                        dpStartDate.SelectedDate.Value,
                        dpEndDate.SelectedDate.Value);

                    LoadingOverlay.Visibility = Visibility.Collapsed;

                    MessageBox.Show($"Đã xuất báo cáo thành công!\n\nĐường dẫn: {sfd.FileName}", "Thành công", MessageBoxButton.OK, MessageBoxImage.Information);
                }
                catch (Exception ex)
                {
                    LoadingOverlay.Visibility = Visibility.Collapsed;
                    MessageBox.Show($"Có lỗi khi xuất Excel: {ex.Message}\n\nĐảm bảo bạn đã đóng file Excel (nếu nó đang mở).", "Lỗi Xuất File", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        // Dán đè lên hàm CreateExcelReportAsync CŨ của bạn
        private async Task CreateExcelReportAsync(string filePath, BaoCaoHieuSuatTongHopDto data, DateTime startDate, DateTime endDate)
        {
            ExcelPackage.License.SetNonCommercialPersonal("CafeBook");
            var fileInfo = new FileInfo(filePath);

            if (fileInfo.Exists)
            {
                fileInfo.Delete(); // Xóa file cũ nếu tồn tại
            }

            using (var package = new ExcelPackage(fileInfo))
            {
                // --- 1. ĐỊNH NGHĨA STYLES & FORMATS ---
                var currencyFormat = "#,##0 \"đ\"";
                var numberFormat = "#,##0";
                var decimalFormat = "#,##0.0";
                var culture = CultureInfo.GetCultureInfo("vi-VN");

                // Style cho Tiêu đề chính (Merge cell, to, đậm, nền xanh)
                Action<ExcelRange> styleMainTitle = (range) =>
                {
                    range.Merge = true;
                    range.Style.Font.Bold = true;
                    range.Style.Font.Size = 16;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    range.Style.Fill.PatternType = ExcelFillStyle.Solid;
                    range.Style.Fill.BackgroundColor.SetColor(System.Drawing.ColorTranslator.FromHtml("#333366")); // Xanh đậm
                    range.Style.Font.Color.SetColor(System.Drawing.Color.White);
                };

                // Style cho Tiêu đề phụ (Merge cell, nghiêng)
                Action<ExcelRange> styleSubTitle = (range) =>
                {
                    range.Merge = true;
                    range.Style.Font.Italic = true;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                };

                // --- 2. SHEET 1: TỔNG QUAN (Sheet MỚI) ---
                var wsTongQuan = package.Workbook.Worksheets.Add("Tổng Quan Hiệu Suất");

                // Tiêu đề
                wsTongQuan.Cells["A1:D1"].Value = "BÁO CÁO TỔNG QUAN HIỆU SUẤT";
                styleMainTitle(wsTongQuan.Cells["A1:D1"]);

                wsTongQuan.Cells["A2:D2"].Value = $"Báo cáo cho kỳ từ {startDate:dd/MM/yyyy} đến {endDate:dd/MM/yyyy}";
                styleSubTitle(wsTongQuan.Cells["A2:D2"]);

                // Hiển thị KPIs
                wsTongQuan.Cells["A4"].Value = "CHỈ SỐ KPI TOÀN QUÁN";
                wsTongQuan.Cells["A4:B4"].Merge = true;
                wsTongQuan.Cells["A4:B4"].Style.Font.Bold = true;
                wsTongQuan.Cells["A4:B4"].Style.Fill.PatternType = ExcelFillStyle.Solid;
                wsTongQuan.Cells["A4:B4"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);

                wsTongQuan.Cells["A5"].Value = "Tổng Doanh Thu";
                wsTongQuan.Cells["B5"].Value = data.Kpi.TongDoanhThu;
                wsTongQuan.Cells["B5"].Style.Numberformat.Format = currencyFormat;

                wsTongQuan.Cells["A6"].Value = "Tổng Giờ Làm";
                wsTongQuan.Cells["B6"].Value = data.Kpi.TongGioLam;
                wsTongQuan.Cells["B6"].Style.Numberformat.Format = decimalFormat;

                wsTongQuan.Cells["A7"].Value = "Tổng Số Ca Làm";
                wsTongQuan.Cells["B7"].Value = data.Kpi.TongSoCaLam;
                wsTongQuan.Cells["B7"].Style.Numberformat.Format = numberFormat;

                wsTongQuan.Cells["A8"].Value = "Tổng Lần Hủy Món";
                wsTongQuan.Cells["B8"].Value = data.Kpi.TongLanHuyMon;
                wsTongQuan.Cells["B8"].Style.Numberformat.Format = numberFormat;
                if (data.Kpi.TongLanHuyMon > 0)
                {
                    wsTongQuan.Cells["A8:B8"].Style.Font.Color.SetColor(System.Drawing.Color.Red);
                    wsTongQuan.Cells["A8:B8"].Style.Font.Bold = true;
                }

                // CHỈ SỐ MỚI (QUAN TRỌNG)
                decimal doanhThuPerGioLam = (data.Kpi.TongGioLam > 0) ? (data.Kpi.TongDoanhThu / (decimal)data.Kpi.TongGioLam) : 0;
                wsTongQuan.Cells["A10"].Value = "HIỆU SUẤT (Doanh Thu / Giờ)";
                wsTongQuan.Cells["B10"].Value = doanhThuPerGioLam;
                wsTongQuan.Cells["B10"].Style.Numberformat.Format = currencyFormat;
                wsTongQuan.Cells["A10:B10"].Style.Font.Bold = true;
                wsTongQuan.Cells["A10:B10"].Style.Font.Color.SetColor(System.Drawing.Color.Green);

                // Kẻ viền
                wsTongQuan.Cells["A4:B8"].Style.Border.BorderAround(ExcelBorderStyle.Medium);
                wsTongQuan.Cells["A10:B10"].Style.Border.BorderAround(ExcelBorderStyle.Medium);

                wsTongQuan.Cells[wsTongQuan.Dimension.Address].AutoFitColumns();

                // --- 3. SHEET 2: HIỆU SUẤT BÁN HÀNG ---
                var ws1 = package.Workbook.Worksheets.Add("Hiệu Suất Bán Hàng");
                ws1.Cells["A1:F1"].Value = "Báo cáo Hiệu suất Bán hàng (Thu ngân, Phục vụ)";
                styleMainTitle(ws1.Cells["A1:F1"]);

                ws1.Cells["A3"].LoadFromCollection(data.SalesPerformance, true, OfficeOpenXml.Table.TableStyles.Medium9);
                var tbl1 = ws1.Tables[0];

                // Định dạng cột
                ws1.Cells[tbl1.Address.Start.Row + 1, tbl1.Columns["TongDoanhThu"].Position + 1, tbl1.Address.End.Row, tbl1.Columns["TongDoanhThu"].Position + 1].Style.Numberformat.Format = currencyFormat;
                ws1.Cells[tbl1.Address.Start.Row + 1, tbl1.Columns["SoHoaDon"].Position + 1, tbl1.Address.End.Row, tbl1.Columns["SoHoaDon"].Position + 1].Style.Numberformat.Format = numberFormat;
                ws1.Cells[tbl1.Address.Start.Row + 1, tbl1.Columns["DoanhThuTrungBinh"].Position + 1, tbl1.Address.End.Row, tbl1.Columns["DoanhThuTrungBinh"].Position + 1].Style.Numberformat.Format = currencyFormat;

                // Định dạng có điều kiện: Tô đỏ cột "Hủy Món" nếu > 0
                var huyMonColRange = ws1.Cells[tbl1.Address.Start.Row + 1, tbl1.Columns["SoLanHuyMon"].Position + 1, tbl1.Address.End.Row, tbl1.Columns["SoLanHuyMon"].Position + 1];
                huyMonColRange.Style.Numberformat.Format = numberFormat;
                var cfRuleHuyMon = huyMonColRange.ConditionalFormatting.AddGreaterThan();
                cfRuleHuyMon.Formula = "0";
                cfRuleHuyMon.Style.Font.Color.SetColor(System.Drawing.Color.Red);
                cfRuleHuyMon.Style.Font.Bold = true;

                ws1.Cells[ws1.Dimension.Address].AutoFitColumns();

                // --- 4. SHEET 3: HIỆU SUẤT VẬN HÀNH (Kho, Quản lý) ---
                var ws2 = package.Workbook.Worksheets.Add("Hiệu Suất Vận Hành");
                ws2.Cells["A1:F1"].Value = "Báo cáo Hiệu suất Vận hành (Kho, Quản lý)";
                styleMainTitle(ws2.Cells["A1:F1"]);

                ws2.Cells["A3"].LoadFromCollection(data.OperationalPerformance, true, OfficeOpenXml.Table.TableStyles.Medium10);
                var tbl2 = ws2.Tables[0];

                // Định dạng số
                ws2.Cells[tbl2.Address.Start.Row + 1, 3, tbl2.Address.End.Row, tbl2.Address.End.Column].Style.Numberformat.Format = numberFormat;

                ws2.Cells[ws2.Dimension.Address].AutoFitColumns();

                // --- 5. SHEET 4: CHUYÊN CẦN ---
                var ws3 = package.Workbook.Worksheets.Add("Báo Cáo Chuyên Cần");
                ws3.Cells["A1:F1"].Value = "Báo cáo Chuyên cần & Vi phạm";
                styleMainTitle(ws3.Cells["A1:F1"]);

                ws3.Cells["A3"].LoadFromCollection(data.Attendance, true, OfficeOpenXml.Table.TableStyles.Medium11);
                var tbl3 = ws3.Tables[0];

                // Định dạng cột
                ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["TongGioLam"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["TongGioLam"].Position + 1].Style.Numberformat.Format = decimalFormat;
                ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["TongSoCaLam"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["TongSoCaLam"].Position + 1].Style.Numberformat.Format = numberFormat;
                ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["SoDonXinNghi"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["SoDonXinNghi"].Position + 1].Style.Numberformat.Format = numberFormat;
                ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["SoDonDaDuyet"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["SoDonDaDuyet"].Position + 1].Style.Numberformat.Format = numberFormat;

                // Định dạng có điều kiện: Tô vàng cột "Chờ Duyệt" nếu > 0 (để quản lý chú ý)
                var choDuyetColRange = ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["SoDonChoDuyet"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["SoDonChoDuyet"].Position + 1];
                choDuyetColRange.Style.Numberformat.Format = numberFormat;
                var cfRuleChoDuyet = choDuyetColRange.ConditionalFormatting.AddGreaterThan();
                cfRuleChoDuyet.Formula = "0";
                cfRuleChoDuyet.Style.Fill.PatternType = ExcelFillStyle.Solid;
                cfRuleChoDuyet.Style.Fill.BackgroundColor.Color = System.Drawing.Color.LightGoldenrodYellow;
                cfRuleChoDuyet.Style.Font.Bold = true;

                ws3.Cells[ws3.Dimension.Address].AutoFitColumns();

                // --- 6. LƯU FILE ---
                await package.SaveAsync();
            }
        }

        private void BtnBack_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
/////////////////////////
/// <Page x:Class="AppCafebookApi.View.common.BaoCaoTonKhoNguyenLieuPreviewWindow"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.common"
      mc:Ignorable="d" 
      d:DesignHeight="720" d:DesignWidth="1000"
      Title="Báo cáo Tồn kho Nguyên liệu"
      Background="#FFF8E1"
      FontFamily="Segoe UI"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>

        <Style TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,8"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="KpiCard" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="15"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="KpiValue" TargetType="TextBlock">
            <Setter Property="FontSize" Value="24"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>
        <Style x:Key="KpiTitle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
        </Style>
        <Style TargetType="DataGrid">
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="CanUserAddRows" Value="False"/>
            <Setter Property="CanUserDeleteRows" Value="False"/>
            <Setter Property="IsReadOnly" Value="True"/>
            <Setter Property="AutoGenerateColumns" Value="False"/>
            <Setter Property="GridLinesVisibility" Value="None"/>
        </Style>
    </Page.Resources>

    <Grid Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="White" Padding="15" Margin="10" CornerRadius="8">
            <WrapPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="Tên Nguyên liệu:" VerticalAlignment="Center" Margin="5"/>
                <TextBox x:Name="txtSearch" Width="200" VerticalAlignment="Center" Margin="0,0,15,0"/>

                <TextBlock Text="Nhà Cung cấp:" VerticalAlignment="Center" Margin="5"/>
                <ComboBox x:Name="cmbNhaCungCap" Width="180" VerticalAlignment="Center" Margin="0,0,15,0"
                          DisplayMemberPath="Ten" SelectedValuePath="Id"/>

                <CheckBox x:Name="chkLowStockOnly" Content="Chỉ hiển thị hàng sắp hết" 
                          VerticalAlignment="Center" Margin="15,0,0,0"/>

                    <Button x:Name="btnGenerate" Content="Lọc Báo Cáo" Margin="20,0,0,0" Click="BtnGenerate_Click"/>
            </WrapPanel>
        </Border>

        <Grid Grid.Row="1" Margin="10,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblGiaTriTonKho" Text="0" Style="{StaticResource KpiValue}" Foreground="#42A5F5"/>
                    <TextBlock Text="Tổng Giá Trị Tồn Kho" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="1" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblSPSapHet" Text="0" Style="{StaticResource KpiValue}" Foreground="#FFA726"/>
                    <TextBlock Text="Số Lượng SP Sắp Hết" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="2" Style="{StaticResource KpiCard}" Margin="0">
                <StackPanel>
                    <TextBlock x:Name="lblGiaTriDaHuy" Text="0" Style="{StaticResource KpiValue}" Foreground="#EF5350"/>
                    <TextBlock Text="Tổng Giá Trị Đã Hủy (30 ngày)" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
        </Grid>

        <TabControl x:Name="MainTabControl" Grid.Row="2" Margin="10">
            <TabItem Header="Báo cáo Tồn kho Hiện tại">
                <DataGrid x:Name="dgInventory">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Tên Nguyên Liệu" Binding="{Binding TenNguyenLieu}" Width="*"/> 
                        <DataGridTextColumn Header="Đơn vị tính" Binding="{Binding DonViTinh}" Width="100"/> 
                        <DataGridTextColumn Header="Tồn kho (HT)" Binding="{Binding TonKho}" Width="120"/> 
                        <DataGridTextColumn Header="Tồn kho Tối thiểu" Binding="{Binding TonKhoToiThieu}" Width="120"/> 
                        <DataGridTextColumn Header="Tình Trạng" Binding="{Binding TinhTrang}" Width="120"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="Lịch sử Kiểm Kê (Chênh lệch)">
                <DataGrid x:Name="dgAuditHistory">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Ngày Kiểm" Binding="{Binding NgayKiem, StringFormat='dd/MM/yyyy'}" Width="120"/>
                        <DataGridTextColumn Header="Tên Nguyên Liệu" Binding="{Binding TenNguyenLieu}" Width="*"/> 
                        <DataGridTextColumn Header="Tồn (Hệ thống)" Binding="{Binding TonKhoHeThong}" Width="120"/> 
                        <DataGridTextColumn Header="Tồn (Thực tế)" Binding="{Binding TonKhoThucTe}" Width="120"/> 
                        <DataGridTextColumn Header="Chênh lệch" Binding="{Binding ChenhLech}" Width="120"/> 
                        <DataGridTextColumn Header="Lý do" Binding="{Binding LyDoChenhLech}" Width="200"/> 
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="Lịch sử Hủy Hàng">
                <DataGrid x:Name="dgWasteHistory">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Ngày Hủy" Binding="{Binding NgayHuy, StringFormat='dd/MM/yyyy'}" Width="120"/>
                        <DataGridTextColumn Header="Tên Nguyên Liệu" Binding="{Binding TenNguyenLieu}" Width="*"/>
                        <DataGridTextColumn Header="Số Lượng Hủy" Binding="{Binding SoLuongHuy}" Width="120"/> 
                        <DataGridTextColumn Header="Giá trị Hủy" Binding="{Binding GiaTriHuy, StringFormat=N0}" Width="120"/> 
                        <DataGridTextColumn Header="Lý do Hủy" Binding="{Binding LyDoHuy}" Width="250"/> 
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
        </TabControl>

        <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="25">
            <Button x:Name="btnBack" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" 
                    Click="BtnBack_Click">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="&lt; Quay lại Trang Tổng Quan" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>

            <Button x:Name="btnExportToExcel" 
                    Content="Xuất Excel" 
                    Margin="20,0,0,0" 
                    HorizontalAlignment="Right"
                    Click="BtnExportToExcel_Click" />
        </StackPanel>

        <Border x:Name="LoadingOverlay" Grid.Row="1" Grid.RowSpan="3" Background="#80FFFFFF" Visibility="Collapsed">
            <TextBlock Text="Đang tạo báo cáo..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
//////////////////
/// using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.IO;
using Microsoft.Win32;
using OfficeOpenXml;
using OfficeOpenXml.Style;
using System.Threading.Tasks;
using Newtonsoft.Json.Linq; // Cần NuGet Newtonsoft.Json
using System.Globalization;

namespace AppCafebookApi.View.common
{
    public partial class BaoCaoTonKhoNguyenLieuPreviewWindow : Page
    {
        private static readonly HttpClient httpClient;
        private BaoCaoTonKhoTongHopDto? currentReportData;

        static BaoCaoTonKhoNguyenLieuPreviewWindow()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public BaoCaoTonKhoNguyenLieuPreviewWindow()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadFiltersAsync();
            await GenerateReportAsync();
        }

        private async Task LoadFiltersAsync()
        {
            try
            {
                // Dùng JObject để parse dynamic JSON
                var response = await httpClient.GetStringAsync("api/app/baocaokho/filters");
                var json = JObject.Parse(response);

                var nhaCungCaps = json["nhaCungCaps"]?.ToObject<List<FilterLookupDto>>() ?? new List<FilterLookupDto>();
                nhaCungCaps.Insert(0, new FilterLookupDto { Id = 0, Ten = "Tất cả NCC" });
                cmbNhaCungCap.ItemsSource = nhaCungCaps;
                cmbNhaCungCap.SelectedValue = 0;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Không thể tải bộ lọc: {ex.Message}", "Lỗi API");
            }
        }

        private async void BtnGenerate_Click(object sender, RoutedEventArgs e)
        {
            await GenerateReportAsync();
        }

        private async Task GenerateReportAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            btnGenerate.IsEnabled = false;

            var request = new BaoCaoTonKhoRequestDto
            {
                SearchText = string.IsNullOrEmpty(txtSearch.Text) ? null : txtSearch.Text,
                NhaCungCapId = (int)cmbNhaCungCap.SelectedValue == 0 ? (int?)null : (int)cmbNhaCungCap.SelectedValue,
                ShowLowStockOnly = chkLowStockOnly.IsChecked ?? false
            };

            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/baocaokho/report", request);
                if (response.IsSuccessStatusCode)
                {
                    currentReportData = await response.Content.ReadFromJsonAsync<BaoCaoTonKhoTongHopDto>();
                    if (currentReportData != null)
                    {
                        PopulateUi(currentReportData);
                    }
                }
                else
                {
                    MessageBox.Show($"Lỗi API: {response.ReasonPhrase}", "Lỗi");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Không thể kết nối API: {ex.Message}", "Lỗi");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
                btnGenerate.IsEnabled = true;
            }
        }

        private void PopulateUi(BaoCaoTonKhoTongHopDto data)
        {
            var culture = CultureInfo.GetCultureInfo("vi-VN");

            // 1. Cập nhật Thẻ KPI
            lblGiaTriTonKho.Text = data.Kpi.TongGiaTriTonKho.ToString("C0", culture);
            lblSPSapHet.Text = data.Kpi.SoLuongSPSapHet.ToString();
            lblGiaTriDaHuy.Text = data.Kpi.TongGiaTriDaHuy.ToString("C0", culture);

            // 2. Cập nhật các Tab
            dgInventory.ItemsSource = data.ChiTietTonKho;
            dgAuditHistory.ItemsSource = data.LichSuKiemKe;
            dgWasteHistory.ItemsSource = data.LichSuHuyHang;
        }

        private async void BtnExportToExcel_Click(object sender, RoutedEventArgs e)
        {
            if (currentReportData == null)
            {
                MessageBox.Show("Chưa có dữ liệu báo cáo để xuất. Vui lòng nhấn 'Lọc Báo Cáo' trước.", "Chưa có dữ liệu");
                return;
            }

            var sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                FileName = $"BaoCaoTonKhoNguyenLieu_{DateTime.Now:yyyyMMdd_HHmm}.xlsx"
            };

            if (sfd.ShowDialog() == true)
            {
                try
                {
                    LoadingOverlay.Visibility = Visibility.Visible;
                    await CreateExcelReportAsync(sfd.FileName, currentReportData);
                    LoadingOverlay.Visibility = Visibility.Collapsed;

                    MessageBox.Show($"Đã xuất báo cáo thành công!\n\nĐường dẫn: {sfd.FileName}", "Thành công", MessageBoxButton.OK, MessageBoxImage.Information);
                }
                catch (Exception ex)
                {
                    LoadingOverlay.Visibility = Visibility.Collapsed;
                    MessageBox.Show($"Có lỗi khi xuất Excel: {ex.Message}\n\nĐảm bảo bạn đã đóng file Excel (nếu nó đang mở).", "Lỗi Xuất File", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        // Dán đè lên hàm CreateExcelReportAsync CŨ của bạn
        private async Task CreateExcelReportAsync(string filePath, BaoCaoTonKhoTongHopDto data)
        {
            ExcelPackage.License.SetNonCommercialPersonal("CafeBook");
            var fileInfo = new FileInfo(filePath);

            if (fileInfo.Exists)
            {
                fileInfo.Delete(); // Xóa file cũ nếu tồn tại để tránh lỗi
            }

            using (var package = new ExcelPackage(fileInfo))
            {
                // --- 1. ĐỊNH NGHĨA CÁC STYLE TÁI SỬ DỤNG ---

                // Định dạng tiền tệ VND
                var currencyFormat = "#,##0 \"đ\"";
                // Định dạng số nguyên
                var numberFormat = "#,##0";
                // Định dạng số thập phân (cho kg, lít,...)
                var decimalFormat = "#,##0.00";
                // Định dạng ngày
                var dateFormat = "dd/MM/yyyy";

                // Style cho Tiêu đề chính (Merge cell, to, đậm, nền xanh)
                Action<ExcelRange> styleMainTitle = (range) =>
                {
                    range.Merge = true;
                    range.Style.Font.Bold = true;
                    range.Style.Font.Size = 16;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    range.Style.Fill.PatternType = ExcelFillStyle.Solid;
                    range.Style.Fill.BackgroundColor.SetColor(System.Drawing.ColorTranslator.FromHtml("#333366")); // Xanh đậm
                    range.Style.Font.Color.SetColor(System.Drawing.Color.White);
                };

                // Style cho Tiêu đề phụ (Merge cell, nghiêng)
                Action<ExcelRange> styleSubTitle = (range) =>
                {
                    range.Merge = true;
                    range.Style.Font.Italic = true;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                };

                // --- 2. SHEET 1: TỔNG QUAN KHO (Sheet MỚI) ---
                var wsTongQuan = package.Workbook.Worksheets.Add("Tổng Quan Kho");

                // Tiêu đề
                wsTongQuan.Cells["A1:C1"].Value = "BÁO CÁO TỔNG QUAN KHO";
                styleMainTitle(wsTongQuan.Cells["A1:C1"]);

                wsTongQuan.Cells["A2:C2"].Value = $"Báo cáo tạo lúc: {DateTime.Now:dd/MM/yyyy HH:mm}";
                styleSubTitle(wsTongQuan.Cells["A2:C2"]);

                // Hiển thị KPIs
                wsTongQuan.Cells["A4"].Value = "CHỈ SỐ QUAN TRỌNG";
                wsTongQuan.Cells["A4:B4"].Merge = true;
                wsTongQuan.Cells["A4:B4"].Style.Font.Bold = true;
                wsTongQuan.Cells["A4:B4"].Style.Fill.PatternType = ExcelFillStyle.Solid;
                wsTongQuan.Cells["A4:B4"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);

                wsTongQuan.Cells["A5"].Value = "Tổng Giá Trị Tồn Kho";
                wsTongQuan.Cells["B5"].Value = data.Kpi.TongGiaTriTonKho;
                wsTongQuan.Cells["B5"].Style.Numberformat.Format = currencyFormat;
                wsTongQuan.Cells["B5"].Style.Font.Bold = true;

                wsTongQuan.Cells["A6"].Value = "SL Nguyên Liệu Sắp Hết";
                wsTongQuan.Cells["B6"].Value = data.Kpi.SoLuongSPSapHet;
                wsTongQuan.Cells["B6"].Style.Numberformat.Format = numberFormat;

                // Tô màu cảnh báo nếu có hàng sắp hết
                if (data.Kpi.SoLuongSPSapHet > 0)
                {
                    wsTongQuan.Cells["B6"].Style.Font.Color.SetColor(System.Drawing.Color.OrangeRed);
                    wsTongQuan.Cells["B6"].Style.Font.Bold = true;
                }

                wsTongQuan.Cells["A7"].Value = "Giá Trị Hủy (30 ngày qua)";
                wsTongQuan.Cells["B7"].Value = data.Kpi.TongGiaTriDaHuy;
                wsTongQuan.Cells["B7"].Style.Numberformat.Format = currencyFormat;

                // Tô màu đỏ nếu có hàng bị hủy
                if (data.Kpi.TongGiaTriDaHuy > 0)
                {
                    wsTongQuan.Cells["B7"].Style.Font.Color.SetColor(System.Drawing.Color.Red);
                    wsTongQuan.Cells["B7"].Style.Font.Bold = true;
                }

                // Kẻ viền cho bảng KPI
                wsTongQuan.Cells["A4:B7"].Style.Border.BorderAround(ExcelBorderStyle.Medium);
                wsTongQuan.Cells[wsTongQuan.Dimension.Address].AutoFitColumns();

                // --- 3. SHEET 2: CHI TIẾT TỒN KHO ---
                var ws1 = package.Workbook.Worksheets.Add("Chi Tiết Tồn Kho");
                ws1.Cells["A1:E1"].Value = "Báo cáo Tồn kho Nguyên liệu Chi tiết";
                styleMainTitle(ws1.Cells["A1:E1"]);

                // Load dữ liệu vào Bảng (Table)
                ws1.Cells["A3"].LoadFromCollection(data.ChiTietTonKho, true, OfficeOpenXml.Table.TableStyles.Medium9);
                var tbl1 = ws1.Tables[0];

                // Định dạng số cho các cột trong bảng
                ws1.Cells[tbl1.Address.Start.Row + 1, tbl1.Columns["tonKho"].Position + 1, tbl1.Address.End.Row, tbl1.Columns["tonKho"].Position + 1].Style.Numberformat.Format = decimalFormat;
                ws1.Cells[tbl1.Address.Start.Row + 1, tbl1.Columns["TonKhoToiThieu"].Position + 1, tbl1.Address.End.Row, tbl1.Columns["TonKhoToiThieu"].Position + 1].Style.Numberformat.Format = decimalFormat;

                // *** ĐỊNH DẠNG CÓ ĐIỀU KIỆN (CONDITIONAL FORMATTING) ***
                // Tự động tô màu các dòng dựa trên "TinhTrang"
                var tinhTrangCol = tbl1.Columns["TinhTrang"].Position + 1;
                // Vùng áp dụng: toàn bộ bảng
                var dataRange1 = new ExcelAddress(tbl1.Address.Start.Row + 1, 1, tbl1.Address.End.Row, tbl1.Address.End.Column);

                // Quy tắc 1: Hết hàng
                var ruleHetHang = ws1.ConditionalFormatting.AddExpression(dataRange1);
                ruleHetHang.Formula = $"${ExcelCellAddress.GetColumnLetter(tinhTrangCol)}{dataRange1.Start.Row}=\"Hết hàng\"";
                ruleHetHang.Style.Fill.BackgroundColor.Color = System.Drawing.Color.IndianRed;
                ruleHetHang.Style.Font.Color.Color = System.Drawing.Color.White;

                // Quy tắc 2: Sắp hết
                var ruleSapHet = ws1.ConditionalFormatting.AddExpression(dataRange1);
                ruleSapHet.Formula = $"${ExcelCellAddress.GetColumnLetter(tinhTrangCol)}{dataRange1.Start.Row}=\"Sắp hết\"";
                ruleSapHet.Style.Fill.BackgroundColor.Color = System.Drawing.Color.LightGoldenrodYellow;

                ws1.Cells[ws1.Dimension.Address].AutoFitColumns();

                // --- 4. SHEET 3: LỊCH SỬ KIỂM KÊ ---
                var ws2 = package.Workbook.Worksheets.Add("Lịch Sử Kiểm Kê");
                ws2.Cells["A1:F1"].Value = "Lịch sử Kiểm Kê (Chênh lệch)";
                styleMainTitle(ws2.Cells["A1:F1"]);

                ws2.Cells["A3"].LoadFromCollection(data.LichSuKiemKe, true, OfficeOpenXml.Table.TableStyles.Medium10);
                var tbl2 = ws2.Tables[0];

                // Định dạng cột ngày
                var ngayKiemColRange = ws2.Cells[tbl2.Address.Start.Row + 1, tbl2.Columns["NgayKiem"].Position + 1, tbl2.Address.End.Row, tbl2.Columns["NgayKiem"].Position + 1];
                ngayKiemColRange.Style.Numberformat.Format = dateFormat;

                // Định dạng các cột số lượng
                ws2.Cells[tbl2.Address.Start.Row + 1, tbl2.Columns["TonKhoHeThong"].Position + 1, tbl2.Address.End.Row, tbl2.Columns["TonKhoHeThong"].Position + 1].Style.Numberformat.Format = decimalFormat;
                ws2.Cells[tbl2.Address.Start.Row + 1, tbl2.Columns["TonKhoThucTe"].Position + 1, tbl2.Address.End.Row, tbl2.Columns["TonKhoThucTe"].Position + 1].Style.Numberformat.Format = decimalFormat;

                // Định dạng có điều kiện cho cột Chênh Lệch
                var chenhLechColRange = ws2.Cells[tbl2.Address.Start.Row + 1, tbl2.Columns["ChenhLech"].Position + 1, tbl2.Address.End.Row, tbl2.Columns["ChenhLech"].Position + 1];
                chenhLechColRange.Style.Numberformat.Format = decimalFormat;
                // Tô đỏ nếu < 0 (mất mát)
                var cfRuleLoss = chenhLechColRange.ConditionalFormatting.AddLessThan();
                cfRuleLoss.Formula = "0"; // Gán giá trị so sánh là "0"
                cfRuleLoss.Style.Font.Color.Color = System.Drawing.Color.Red;
                // Tô xanh nếu > 0 (dư)
                var cfRuleGain = chenhLechColRange.ConditionalFormatting.AddGreaterThan();
                cfRuleGain.Formula = "0"; // Gán giá trị so sánh là "0"
                cfRuleGain.Style.Font.Color.Color = System.Drawing.Color.Green;

                ws2.Cells[ws2.Dimension.Address].AutoFitColumns();

                // --- 5. SHEET 4: LỊCH SỬ HỦY HÀNG ---
                var ws3 = package.Workbook.Worksheets.Add("Lịch Sử Hủy Hàng");
                ws3.Cells["A1:E1"].Value = "Lịch sử Hủy Hàng";
                styleMainTitle(ws3.Cells["A1:E1"]);

                ws3.Cells["A3"].LoadFromCollection(data.LichSuHuyHang, true, OfficeOpenXml.Table.TableStyles.Medium11);
                var tbl3 = ws3.Tables[0];

                // Định dạng cột ngày
                var ngayHuyColRange = ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["NgayHuy"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["NgayHuy"].Position + 1];
                ngayHuyColRange.Style.Numberformat.Format = dateFormat;

                // Định dạng cột số lượng hủy
                ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["SoLuongHuy"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["SoLuongHuy"].Position + 1].Style.Numberformat.Format = decimalFormat;

                // Định dạng cột giá trị hủy (tiền tệ)
                var giaTriHuyColRange = ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["GiaTriHuy"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["GiaTriHuy"].Position + 1];
                giaTriHuyColRange.Style.Numberformat.Format = currencyFormat;
                // Tô màu đỏ cho giá trị hủy
                var cfRuleHuy = giaTriHuyColRange.ConditionalFormatting.AddGreaterThan();
                cfRuleHuy.Formula = "0"; // Gán giá trị so sánh là "0"
                cfRuleHuy.Style.Font.Color.Color = System.Drawing.Color.Red;

                ws3.Cells[ws3.Dimension.Address].AutoFitColumns();

                // --- 6. LƯU FILE ---
                await package.SaveAsync();
            }
        }

        private void BtnBack_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
//////////////////////////
/// <Page x:Class="AppCafebookApi.View.common.BapCaoTonKhoSachPreviewWindow"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.common"
      mc:Ignorable="d" 
      d:DesignHeight="720" d:DesignWidth="1000"
      Title="Báo cáo Tồn kho Sách"
      Background="#FFF8E1"
      FontFamily="Segoe UI"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>

        <Style TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,8"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="KpiCard" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="15"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="KpiValue" TargetType="TextBlock">
            <Setter Property="FontSize" Value="24"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>
        <Style x:Key="KpiTitle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
        </Style>
        <Style TargetType="DataGrid">
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="CanUserAddRows" Value="False"/>
            <Setter Property="CanUserDeleteRows" Value="False"/>
            <Setter Property="IsReadOnly" Value="True"/>
            <Setter Property="AutoGenerateColumns" Value="False"/>
            <Setter Property="GridLinesVisibility" Value="None"/>
        </Style>
    </Page.Resources>

    <Grid Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="White" Padding="15" Margin="10" CornerRadius="8">
            <WrapPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="Tên sách:" VerticalAlignment="Center" Margin="5"/>
                <TextBox x:Name="txtSearch" Width="200" VerticalAlignment="Center" Margin="0,0,15,0"/>

                <TextBlock Text="Thể loại:" VerticalAlignment="Center" Margin="5"/>
                <ComboBox x:Name="cmbTheLoai" Width="150" VerticalAlignment="Center" Margin="0,0,15,0"
                          DisplayMemberPath="Ten" SelectedValuePath="Id"/>

                <TextBlock Text="Tác giả:" VerticalAlignment="Center" Margin="5"/>
                <ComboBox x:Name="cmbTacGia" Width="150" VerticalAlignment="Center" Margin="0,0,15,0"
                          DisplayMemberPath="Ten" SelectedValuePath="Id"/>

                <Button x:Name="btnGenerate" Content="Lọc Báo Cáo" Margin="20,0,0,0" Click="BtnGenerate_Click"/>
            </WrapPanel>
        </Border>

        <Grid Grid.Row="1" Margin="10,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblTongDauSach" Text="0" Style="{StaticResource KpiValue}" Foreground="#42A5F5"/>
                    <TextBlock Text="Tổng Đầu Sách" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="1" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblTongSoLuong" Text="0" Style="{StaticResource KpiValue}" Foreground="#6F4E37"/>
                    <TextBlock Text="Tổng Số Lượng Sách" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="2" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblDangChoThue" Text="0" Style="{StaticResource KpiValue}" Foreground="#EF5350"/>
                    <TextBlock Text="Đang Cho Thuê" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="3" Style="{StaticResource KpiCard}" Margin="0">
                <StackPanel>
                    <TextBlock x:Name="lblSanSang" Text="0" Style="{StaticResource KpiValue}" Foreground="#66BB6A"/>
                    <TextBlock Text="Sẵn Sàng" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
        </Grid>

        <TabControl x:Name="MainTabControl" Grid.Row="2" Margin="10">
            <TabItem Header="Báo cáo Tồn kho Chi tiết">
                <DataGrid x:Name="dgInventoryDetails">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Tên Sách" Binding="{Binding TenSach}" Width="*"/>
                        <DataGridTextColumn Header="Tác Giả" Binding="{Binding TenTacGia}" Width="150"/>
                        <DataGridTextColumn Header="Thể Loại" Binding="{Binding TenTheLoai}" Width="150"/>
                        <DataGridTextColumn Header="Tổng SL" Binding="{Binding SoLuongTong}" Width="80"/>
                        <DataGridTextColumn Header="Đang Thuê" Binding="{Binding SoLuongDangMuon}" Width="80"/>
                        <DataGridTextColumn Header="Còn Lại" Binding="{Binding SoLuongConLai}" Width="80"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="Sách Đang Thuê &amp; Trễ Hạn">
                <DataGrid x:Name="dgRentedOverdue">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Tên Sách" Binding="{Binding TenSach}" Width="*"/>
                        <DataGridTextColumn Header="Khách Hàng" Binding="{Binding HoTen}" Width="150"/>
                        <DataGridTextColumn Header="SĐT Khách" Binding="{Binding SoDienThoai}" Width="120"/>
                        <DataGridTextColumn Header="Ngày Thuê" Binding="{Binding NgayThue, StringFormat='dd/MM/yyyy'}" Width="120"/>
                        <DataGridTextColumn Header="Ngày Hẹn Trả" Binding="{Binding NgayHenTra, StringFormat='dd/MM/yyyy'}" Width="120"/>
                        <DataGridTextColumn Header="Tình Trạng" Binding="{Binding TinhTrang}" Width="120"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="Top Sách Được Thuê Nhiều Nhất">
                <DataGrid x:Name="dgTopRented">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Tên Sách" Binding="{Binding TenSach}" Width="*"/>
                        <DataGridTextColumn Header="Tác Giả" Binding="{Binding TenTacGia}" Width="200"/>
                        <DataGridTextColumn Header="Tổng Lượt Thuê" Binding="{Binding TongLuotThue}" Width="150"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
        </TabControl>

        <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="25">
            <Button x:Name="btnBack" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" 
                    Click="BtnBack_Click">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="&lt; Quay lại Trang Tổng Quan" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>

            <Button x:Name="btnExportToExcel" 
                    Content="Xuất Excel" 
                    Margin="20,0,0,0" 
                    HorizontalAlignment="Right"
                    Click="BtnExportToExcel_Click" />
        </StackPanel>

        <Border x:Name="LoadingOverlay" Grid.Row="1" Grid.RowSpan="3" Background="#80FFFFFF" Visibility="Collapsed">
            <TextBlock Text="Đang tạo báo cáo..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
///////////////////////////
/// using CafebookModel.Model.ModelApp;
using Microsoft.Win32;
// using Newtonsoft.Json.Linq; // Không cần using này
using OfficeOpenXml;
using OfficeOpenXml.Style;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;

// --- SỬA LỖI CS0246: THÊM 2 USING NÀY ---
using System.Text.Json;
using System.Text.Json.Serialization;
// --- KẾT THÚC SỬA LỖI ---

namespace AppCafebookApi.View.common
{
    public partial class BapCaoTonKhoSachPreviewWindow : Page
    {
        private static readonly HttpClient httpClient;
        private BaoCaoSachTongHopDto? currentReportData;

        static BapCaoTonKhoSachPreviewWindow()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public BapCaoTonKhoSachPreviewWindow()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadFiltersAsync();
            await GenerateReportAsync();
        }

        private async Task LoadFiltersAsync()
        {
            try
            {
                var response = await httpClient.GetFromJsonAsync<JsonElement?>("api/app/baocaosach/filters");

                // SỬA LỖI CS0019: Dùng .HasValue để kiểm tra null
                if (!response.HasValue)
                {
                    MessageBox.Show("Không nhận được dữ liệu lọc.", "Lỗi API");
                    return;
                }

                // Chuyển đổi an toàn
                var theLoais = response.Value.GetProperty("theLoais").Deserialize<List<FilterLookupDto>>() ?? new List<FilterLookupDto>();
                theLoais.Insert(0, new FilterLookupDto { Id = 0, Ten = "Tất cả Thể loại" });
                cmbTheLoai.ItemsSource = theLoais;
                cmbTheLoai.SelectedValue = 0;

                var tacGias = response.Value.GetProperty("tacGias").Deserialize<List<FilterLookupDto>>() ?? new List<FilterLookupDto>();
                tacGias.Insert(0, new FilterLookupDto { Id = 0, Ten = "Tất cả Tác giả" });
                cmbTacGia.ItemsSource = tacGias;
                cmbTacGia.SelectedValue = 0;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Không thể tải bộ lọc: {ex.Message}", "Lỗi API");
            }
        }

        private async void BtnGenerate_Click(object sender, RoutedEventArgs e)
        {
            await GenerateReportAsync();
        }

        private async Task GenerateReportAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            btnGenerate.IsEnabled = false;

            var request = new BaoCaoSachRequestDto
            {
                SearchText = string.IsNullOrEmpty(txtSearch.Text) ? null : txtSearch.Text,
                TheLoaiId = (int)cmbTheLoai.SelectedValue == 0 ? (int?)null : (int)cmbTheLoai.SelectedValue,
                TacGiaId = (int)cmbTacGia.SelectedValue == 0 ? (int?)null : (int)cmbTacGia.SelectedValue
            };

            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/baocaosach/report", request);
                if (response.IsSuccessStatusCode)
                {
                    currentReportData = await response.Content.ReadFromJsonAsync<BaoCaoSachTongHopDto>();
                    if (currentReportData != null)
                    {
                        PopulateUi(currentReportData);
                    }
                }
                else
                {
                    MessageBox.Show($"Lỗi API: {response.ReasonPhrase}", "Lỗi");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Không thể kết nối API: {ex.Message}", "Lỗi");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
                btnGenerate.IsEnabled = true;
            }
        }

        private void PopulateUi(BaoCaoSachTongHopDto data)
        {
            lblTongDauSach.Text = data.Kpi.TongDauSach.ToString();
            lblTongSoLuong.Text = data.Kpi.TongSoLuong.ToString();
            lblDangChoThue.Text = data.Kpi.DangChoThue.ToString();
            lblSanSang.Text = data.Kpi.SanSang.ToString();

            dgInventoryDetails.ItemsSource = data.ChiTietTonKho;
            dgRentedOverdue.ItemsSource = data.SachTreHan;
            dgTopRented.ItemsSource = data.TopSachThue;
        }

        private async void BtnExportToExcel_Click(object sender, RoutedEventArgs e)
        {
            if (currentReportData == null)
            {
                MessageBox.Show("Chưa có dữ liệu báo cáo để xuất. Vui lòng nhấn 'Lọc Báo Cáo' trước.", "Chưa có dữ liệu");
                return;
            }

            var sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                FileName = $"BaoCaoTonKhoSach_{DateTime.Now:yyyyMMdd_HHmm}.xlsx"
            };

            if (sfd.ShowDialog() == true)
            {
                try
                {
                    LoadingOverlay.Visibility = Visibility.Visible;
                    await CreateExcelReportAsync(sfd.FileName, currentReportData);
                    LoadingOverlay.Visibility = Visibility.Collapsed;

                    MessageBox.Show($"Đã xuất báo cáo thành công!\n\nĐường dẫn: {sfd.FileName}", "Thành công", MessageBoxButton.OK, MessageBoxImage.Information);
                }
                catch (Exception ex)
                {
                    LoadingOverlay.Visibility = Visibility.Collapsed;
                    MessageBox.Show($"Có lỗi khi xuất Excel: {ex.Message}\n\nĐảm bảo bạn đã đóng file Excel (nếu nó đang mở).", "Lỗi Xuất File", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        // Dán đè lên hàm CreateExcelReportAsync CŨ của bạn
        private async Task CreateExcelReportAsync(string filePath, BaoCaoSachTongHopDto data)
        {
            // Giấy phép EPPlus
            ExcelPackage.License.SetNonCommercialPersonal("CafeBook");
            var fileInfo = new FileInfo(filePath);

            // Xóa file cũ nếu tồn tại để tránh lỗi
            if (fileInfo.Exists)
            {
                fileInfo.Delete();
            }

            using (var package = new ExcelPackage(fileInfo))
            {
                // --- TÙY CHỈNH STYLE ---
                // Định nghĩa một style chung cho tiêu đề
                Action<ExcelRange> styleTitle = (range) =>
                {
                    range.Style.Font.Bold = true;
                    range.Style.Font.Size = 14;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    range.Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                    range.Style.Fill.PatternType = ExcelFillStyle.Solid;
                    range.Style.Fill.BackgroundColor.SetColor(System.Drawing.ColorTranslator.FromHtml("#4F81BD")); // Màu xanh đậm
                    range.Style.Font.Color.SetColor(System.Drawing.Color.White);
                };

                // --- Sheet 1: TỔNG QUAN (Sheet mới) ---
                var wsTongQuan = package.Workbook.Worksheets.Add("Tổng Quan");
                wsTongQuan.Cells["A1:D1"].Merge = true;
                wsTongQuan.Cells["A1"].Value = "BÁO CÁO TỔNG QUAN - CAFEBOOK";
                styleTitle(wsTongQuan.Cells["A1:D1"]);

                wsTongQuan.Cells["A3"].Value = "Báo cáo được tạo lúc:";
                wsTongQuan.Cells["B3"].Value = DateTime.Now;
                wsTongQuan.Cells["B3"].Style.Numberformat.Format = "dd/MM/yyyy HH:mm:ss";
                wsTongQuan.Cells["A3:B3"].Style.Font.Bold = true;

                // Thêm dữ liệu KPI
                wsTongQuan.Cells["A5"].Value = "Chỉ số";
                wsTongQuan.Cells["B5"].Value = "Số lượng";
                wsTongQuan.Cells["A5:B5"].Style.Font.Bold = true;
                wsTongQuan.Cells["A5:B5"].Style.Fill.PatternType = ExcelFillStyle.Solid;
                wsTongQuan.Cells["A5:B5"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);

                wsTongQuan.Cells["A6"].Value = "Tổng đầu sách";
                wsTongQuan.Cells["B6"].Value = data.Kpi.TongDauSach;

                wsTongQuan.Cells["A7"].Value = "Tổng số lượng (cuốn)";
                wsTongQuan.Cells["B7"].Value = data.Kpi.TongSoLuong;

                wsTongQuan.Cells["A8"].Value = "Đang cho thuê";
                wsTongQuan.Cells["B8"].Value = data.Kpi.DangChoThue;

                wsTongQuan.Cells["A9"].Value = "Sẵn sàng cho thuê";
                wsTongQuan.Cells["B9"].Value = data.Kpi.SanSang;

                // Kẻ viền cho bảng KPI
                var kpiRange = wsTongQuan.Cells["A5:B9"];
                kpiRange.Style.Border.Top.Style = ExcelBorderStyle.Thin;
                kpiRange.Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                kpiRange.Style.Border.Left.Style = ExcelBorderStyle.Thin;
                kpiRange.Style.Border.Right.Style = ExcelBorderStyle.Thin;

                wsTongQuan.Cells[wsTongQuan.Dimension.Address].AutoFitColumns();


                // --- Sheet 2: Tồn Kho Chi Tiết ---
                var ws1 = package.Workbook.Worksheets.Add("Chi Tiết Tồn Kho");
                ws1.Cells["A1:F1"].Merge = true;
                ws1.Cells["A1"].Value = "Báo cáo Tồn kho Chi tiết";
                styleTitle(ws1.Cells["A1:F1"]);

                // Load dữ liệu từ Collection và áp dụng Style Bảng chuyên nghiệp
                // "true" = in ra tên cột (headers)
                ws1.Cells["A3"].LoadFromCollection(data.ChiTietTonKho, true, OfficeOpenXml.Table.TableStyles.Medium9);
                ws1.Cells[ws1.Dimension.Address].AutoFitColumns();


                // --- Sheet 3: Sách Đang Thuê & Trễ Hạn ---
                var ws2 = package.Workbook.Worksheets.Add("Sách Trễ Hạn");
                ws2.Cells["A1:F1"].Merge = true;
                ws2.Cells["A1"].Value = "Báo cáo Sách Đang Thuê & Trễ Hạn";
                styleTitle(ws2.Cells["A1:F1"]);

                ws2.Cells["A3"].LoadFromCollection(data.SachTreHan, true, OfficeOpenXml.Table.TableStyles.Medium10);

                // Cần định dạng lại cột ngày tháng sau khi load
                // +3 là vì bắt đầu từ A3 (1 title, 1 header, 1 data row)
                int rowCountSheet2 = data.SachTreHan.Count + 3;
                ws2.Cells[$"D4:E{rowCountSheet2}"].Style.Numberformat.Format = "dd/MM/yyyy HH:mm";
                ws2.Cells[ws2.Dimension.Address].AutoFitColumns();


                // --- Sheet 4: Top Sách Thuê ---
                var ws3 = package.Workbook.Worksheets.Add("Top Sách Thuê");
                ws3.Cells["A1:C1"].Merge = true;
                ws3.Cells["A1"].Value = "Top Sách Được Thuê Nhiều Nhất";
                styleTitle(ws3.Cells["A1:C1"]);

                ws3.Cells["A3"].LoadFromCollection(data.TopSachThue, true, OfficeOpenXml.Table.TableStyles.Medium11);
                ws3.Cells[ws3.Dimension.Address].AutoFitColumns();

                // Lưu file
                await package.SaveAsync();
            }
        }

        private void BtnBack_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
//////////////////////////
/// <Page x:Class="AppCafebookApi.View.common.CaiDatWindow"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:local="clr-namespace:AppCafebookApi.View.common"
      mc:Ignorable="d"
      d:DesignHeight="700" d:DesignWidth="900"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>

        <Style TargetType="GroupItem">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="GroupItem">
                        <StackPanel>
                            <TextBlock Text="{Binding Name}" 
                                       FontSize="16" FontWeight="Bold" 
                                       Foreground="{StaticResource PrimaryBrownBrush}" 
                                       Margin="5,15,0,5" />
                            <ItemsPresenter />
                        </StackPanel>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="SettingTextBox" TargetType="Grid">
            <Setter Property="Margin" Value="0,2,0,10"/>
        </Style>
        
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        
        <Style x:Key="PlaceholderTextBlock" TargetType="TextBlock">
            <Setter Property="Foreground" Value="#AAAAAA"/>
            <Setter Property="IsHitTestVisible" Value="False"/>
            <Setter Property="Margin" Value="5,0"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Grid.Row" Value="0"/>
        </Style>

        <Style x:Key="HelperTextBlock" TargetType="TextBlock">
            <Setter Property="Foreground" Value="#757575"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="TextWrapping" Value="Wrap"/>
            <Setter Property="Grid.Row" Value="1"/>
            <Setter Property="Margin" Value="2,2,0,0"/>
        </Style>

        <Style x:Key="SaveButton" TargetType="Button">
            <Setter Property="Background" Value="#66BB6A"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Content" Value="Lưu"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>

    </Page.Resources>

    <Grid Margin="20" Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Text="Cài đặt Thông tin Quán &amp; Hệ thống" FontSize="20" FontWeight="Bold" Foreground="#4E342E" Margin="0,0,0,15"/>

        <ListView x:Name="lvSettings" Grid.Row="1" Background="White" BorderThickness="1" BorderBrush="#E0E0E0">

            <ListView.GroupStyle>
                <GroupStyle HidesIfEmpty="True"/>
            </ListView.GroupStyle>

            <ListView.View>
                <GridView>
                    <GridViewColumn Header="Giá trị" Width="550">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <Grid Style="{StaticResource SettingTextBox}">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <TextBox x:Name="txtValue" 
                                             Text="{Binding GiaTri, UpdateSourceTrigger=PropertyChanged}" 
                                             Padding="5" 
                                             BorderThickness="1" 
                                             BorderBrush="#BDBDBD"
                                             TextWrapping="Wrap" AcceptsReturn="True"
                                             MinHeight="30" MaxHeight="100" Grid.Row="0"/>

                                    <TextBlock Text="{Binding MoTa}">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock" BasedOn="{StaticResource PlaceholderTextBlock}">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Text, ElementName=txtValue}" Value="">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>

                                    <TextBlock Text="{Binding MoTa}">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock" BasedOn="{StaticResource HelperTextBlock}">
                                                <Setter Property="Visibility" Value="Visible"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Text, ElementName=txtValue}" Value="">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>

                                </Grid>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>

                    <GridViewColumn Header="Hành động" Width="100">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <Button Content="Lưu" 
                                        Style="{StaticResource SaveButton}"
                                        Click="BtnSaveRow_Click"
                                        Tag="{Binding}"/>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>

                    <GridViewColumn Header="Tên Cài Đặt (Ẩn)" Width="0" DisplayMemberBinding="{Binding TenCaiDat}"/>

                </GridView>
            </ListView.View>
        </ListView>

        <Border x:Name="LoadingOverlay" Grid.Row="1" Background="#80FFFFFF" Visibility="Collapsed">
            <TextBlock Text="Đang tải dữ liệu..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="16" FontWeight="SemiBold" Foreground="#4E342E"/>
        </Border>

        <Border x:Name="NotificationBorder" Grid.Row="2" Background="{StaticResource SuccessBrush}" 
                CornerRadius="4" Padding="15,10" Margin="0,15,0,0"
                Visibility="Collapsed">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.1" BlurRadius="10"/>
            </Border.Effect>
            <TextBlock x:Name="NotificationText" Text="Lưu thành công!" 
                       Foreground="White" FontWeight="SemiBold"
                       HorizontalAlignment="Center" VerticalAlignment="Center"/>
        </Border>
        <Button x:Name="btnBack" 
                Grid.Row="3" 
                Style="{StaticResource BackButton}"
                HorizontalAlignment="Left" 
                Margin="0,15,0,0" 
                Click="BtnBack_Click">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="&lt; Quay lại Trang Tổng Quan" VerticalAlignment="Center"/>
            </StackPanel>
        </Button>
    </Grid>
</Page>
//////////////////
/// using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Data;
using System.Windows.Controls;
using CafebookModel.Model.ModelApp;
using System.Windows.Threading; // Thêm
using System.Windows.Media; // Thêm

namespace AppCafebookApi.View.common
{
    // Lớp nội bộ để hỗ trợ grouping
    public class CaiDatViewItem : CaiDatDto
    {
        public string Nhom { get; set; } = "Cài Đặt Khác";
    }

    /// <summary>
    /// SỬA LỖI: Đổi base class từ Window sang Page
    /// </summary>
    public partial class CaiDatWindow : Page
    {
        private static readonly HttpClient httpClient;
        private ObservableCollection<CaiDatViewItem> settingsList = new ObservableCollection<CaiDatViewItem>();
        private DispatcherTimer notificationTimer; // Timer để ẩn thông báo

        static CaiDatWindow()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public CaiDatWindow()
        {
            InitializeComponent();

            // Khởi tạo timer
            notificationTimer = new DispatcherTimer
            {
                Interval = TimeSpan.FromSeconds(3) // 3 giây
            };
            notificationTimer.Tick += NotificationTimer_Tick;
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.GetFromJsonAsync<List<CaiDatDto>>("api/app/caidat/all");

                if (response != null)
                {
                    // 1. CHUYỂN DTO THÀNH VIEWITEM VÀ PHÂN NHÓM
                    var viewItems = response
                        .Where(s => !s.TenCaiDat.StartsWith("AI_Chat_")) // Ẩn cài đặt AI
                        .OrderBy(s => GetNhomOrder(s.TenCaiDat)) // Sắp xếp theo thứ tự logic
                        .ThenBy(s => s.MoTa)
                        .Select(dto => new CaiDatViewItem
                        {
                            TenCaiDat = dto.TenCaiDat,
                            GiaTri = dto.GiaTri,
                            MoTa = dto.MoTa,
                            Nhom = GetNhom(dto.TenCaiDat) // Hàm phân nhóm
                        });

                    settingsList = new ObservableCollection<CaiDatViewItem>(viewItems);

                    // 2. TẠO COLLECTIONVIEW ĐỂ GROUPING
                    var cvs = new CollectionViewSource();
                    cvs.Source = settingsList;
                    cvs.GroupDescriptions.Add(new PropertyGroupDescription("Nhom"));

                    // 3. GÁN VÀO LISTVIEW
                    lvSettings.ItemsSource = cvs.View;
                }
            }
            catch (Exception ex)
            {
                // SỬA LỖI: Hiển thị thông báo trong Page
                ShowNotification($"Không thể tải cài đặt: {ex.Message}", isError: true);
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        /// <summary>
        /// Hàm helper để phân loại cài đặt theo nhóm
        /// </summary>
        private string GetNhom(string tenCaiDat)
        {
            if (tenCaiDat == "TenQuan" || tenCaiDat == "DiaChi" || tenCaiDat == "SoDienThoai" || tenCaiDat == "Wifi_MatKhau")
            {
                return "1. Cài đặt thông tin hiển thị trên hóa đơn";
            }
            if (tenCaiDat.StartsWith("Sach_") || tenCaiDat == "GioiThieu" || tenCaiDat == "LienHe_GioMoCua" || tenCaiDat == "LienHe_GoogleMapsEmbed")
            {
                return "2. Cài đặt Thông Tin Quán";
            }
            if (tenCaiDat.StartsWith("LienHe_") || tenCaiDat == "LienHe_Website") // Đã sửa theo CSDL của bạn
            {
                return "3. Cài Đặt Thông Tin Mạng Xã Hội Quán";
            }
            return "4. Cài Đặt Khác";
        }

        // Hàm helper để sắp xếp nhóm theo thứ tự
        private int GetNhomOrder(string tenCaiDat)
        {
            if (tenCaiDat == "TenQuan" || tenCaiDat == "DiaChi" || tenCaiDat == "SoDienThoai" || tenCaiDat == "Wifi_MatKhau") return 1;
            if (tenCaiDat.StartsWith("Sach_") || tenCaiDat == "GioiThieu" || tenCaiDat == "LienHe_GioMoCua" || tenCaiDat == "LienHe_GoogleMapsEmbed") return 2;
            if (tenCaiDat.StartsWith("LienHe_") || tenCaiDat == "LienHe_Website") return 3;
            return 4;
        }

        /// <summary>
        /// Xử lý sự kiện "Lưu" cho từng dòng (theo yêu cầu)
        /// </summary>
        private async void BtnSaveRow_Click(object sender, RoutedEventArgs e)
        {
            var button = sender as Button;
            if (button == null) return;

            var itemToSave = button.Tag as CaiDatViewItem;
            if (itemToSave == null) return;

            button.IsEnabled = false;
            button.Content = "Đang lưu...";

            try
            {
                var dto = new CaiDatDto
                {
                    TenCaiDat = itemToSave.TenCaiDat,
                    GiaTri = itemToSave.GiaTri,
                    MoTa = itemToSave.MoTa
                };

                var response = await httpClient.PutAsJsonAsync("api/app/caidat/update-single", dto);

                if (response.IsSuccessStatusCode)
                {
                    // SỬA LỖI: Hiển thị thông báo trong Page
                    ShowNotification($"Đã lưu '{itemToSave.MoTa}' thành công!");
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    ShowNotification($"Lỗi khi lưu: {error}", isError: true);
                }
            }
            catch (Exception ex)
            {
                ShowNotification($"Không thể lưu: {ex.Message}", isError: true);
            }
            finally
            {
                button.IsEnabled = true;
                button.Content = "Lưu";
            }
        }

        /// <summary>
        /// SỬA LỖI: Hàm mới để hiển thị thông báo
        /// </summary>
        private void ShowNotification(string message, bool isError = false)
        {
            // Dừng timer cũ nếu đang chạy
            notificationTimer.Stop();

            NotificationText.Text = message;
            if (isError)
            {
                NotificationBorder.Background = (SolidColorBrush)FindResource("ErrorBrush");
            }
            else
            {
                NotificationBorder.Background = (SolidColorBrush)FindResource("SuccessBrush");
            }

            NotificationBorder.Visibility = Visibility.Visible;

            // Khởi động timer để tự động ẩn
            notificationTimer.Start();
        }

        private void NotificationTimer_Tick(object? sender, EventArgs e)
        {
            notificationTimer.Stop();
            NotificationBorder.Visibility = Visibility.Collapsed;
        }

        // --- THÊM HÀM MỚI ĐỂ XỬ LÝ NÚT QUAY LẠI ---
        private void BtnBack_Click(object sender, RoutedEventArgs e)
        {
            // Kiểm tra xem Frame có thể quay lại trang trước đó không
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                // Thực hiện quay lại (về Trang Tổng Quan)
                this.NavigationService.GoBack();
            }
        }
    }
}
/////////////////////
/// <Window x:Class="AppCafebookApi.View.common.InputDialogWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Nhập thông tin" Height="200" Width="400"
        WindowStartupLocation="CenterOwner" WindowStyle="ToolWindow"
        Background="#FFF8E1" FontFamily="Segoe UI">
    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock x:Name="lblPrompt" Grid.Row="0" Text="Vui lòng nhập:" TextWrapping="Wrap" Margin="0,0,0,10"/>

        <TextBox x:Name="txtInput" Grid.Row="1" VerticalAlignment="Top"
                 BorderBrush="#6F4E37" Padding="5" AcceptsReturn="True" TextWrapping="Wrap"/>

        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0">
            <Button x:Name="btnOk" Content="Đồng ý" Width="80" Click="BtnOk_Click" IsDefault="True"/>
            <Button x:Name="btnCancel" Content="Hủy" Width="80" Margin="10,0,0,0" IsCancel="True" Background="#757575"/>
        </StackPanel>
    </Grid>
</Window>
///////////////////
/// using System.Windows;

namespace AppCafebookApi.View.common
{
    public partial class InputDialogWindow : Window
    {
        public string InputText { get; private set; } = string.Empty;

        public InputDialogWindow(string title, string prompt)
        {
            InitializeComponent();
            this.Title = title;
            lblPrompt.Text = prompt;
        }

        private void BtnOk_Click(object sender, RoutedEventArgs e)
        {
            this.InputText = txtInput.Text;
            this.DialogResult = true;
            this.Close();
        }
    }
}
//////////////////////
/// <Window x:Class="AppCafebookApi.View.Common.WelcomeWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AppCafebookApi.View.Common"
        Title="Chào mừng" Height="280" Width="540"
        WindowStartupLocation="CenterOwner"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent"
        ShowInTaskbar="False" Topmost="True" ResizeMode="NoResize"
        Loaded="Window_Loaded">
    
    <Window.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="DarkTextBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>

        <Style TargetType="ProgressBar">
            <Setter Property="Background" Value="#E0D8C6"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Height" Value="6"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ProgressBar">
                        <Grid>
                            <Border x:Name="PART_Track" CornerRadius="3" Background="{TemplateBinding Background}"/>
                            <Border x:Name="PART_Indicator" CornerRadius="3" Background="{TemplateBinding Foreground}" HorizontalAlignment="Left"/>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid>
        <Border Background="#CC4E342E" CornerRadius="12"/>

        <Border x:Name="WelcomeCard" Width="460" Height="200" CornerRadius="12" 
                Background="{StaticResource LightCreamBrush}"
                HorizontalAlignment="Center" VerticalAlignment="Center"
                RenderTransformOrigin="0.5, 0.5">
            <Border.RenderTransform>
                <ScaleTransform ScaleX="0.9" ScaleY="0.9"/>
            </Border.RenderTransform>
            <Border.Effect>
                <DropShadowEffect Color="#000" BlurRadius="25" Opacity="0.2" ShadowDepth="5"/>
            </Border.Effect>
            <Border.Triggers>
                <EventTrigger RoutedEvent="Loaded">
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.4"/>
                            <DoubleAnimation Storyboard.TargetName="WelcomeCard" Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)" To="1" Duration="0:0:0.4">
                                <DoubleAnimation.EasingFunction>
                                    <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                                </DoubleAnimation.EasingFunction>
                            </DoubleAnimation>
                            <DoubleAnimation Storyboard.TargetName="WelcomeCard" Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)" To="1" Duration="0:0:0.4">
                                <DoubleAnimation.EasingFunction>
                                    <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                                </DoubleAnimation.EasingFunction>
                            </DoubleAnimation>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
            </Border.Triggers>

            <Grid>
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <TextBlock x:Name="txtWelcome" Text="CHÀO MỪNG" 
                               FontWeight="Bold" 
                               FontSize="28" 
                               TextAlignment="Center" 
                               Margin="0,0,0,15"/>

                    <StackPanel VerticalAlignment="Center">
                        <TextBlock x:Name="txtUserGreeting" 
                                   Text="Xin chào, [Tên]" 
                                   FontSize="18" 
                                   FontWeight="SemiBold" 
                                   Foreground="{StaticResource DarkTextBrush}"
                                   HorizontalAlignment="Center"/>
                        <TextBlock x:Name="txtSub" 
                                   Text="Đang chuẩn bị không gian làm việc cho bạn..." 
                                   FontSize="13" 
                                   Foreground="{StaticResource DarkTextBrush}" Opacity="0.7"
                                   Margin="0,6,0,12"
                                   HorizontalAlignment="Center"/>
                        <ProgressBar Width="280" IsIndeterminate="True"/>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
//////////////////////
/// using CafebookModel.Model.Data;
using System;
using System.Windows;
using System.Windows.Media; // Thêm
using System.Windows.Media.Imaging; // Thêm
using System.Windows.Threading;
using CafebookModel.Utils; // <--- SỬ DỤNG HELPER MỚI
using AppCafebookApi.Services; // <--- THÊM DÒNG NÀY

namespace AppCafebookApi.View.Common
{
    public partial class WelcomeWindow : Window
    {
        private readonly NhanVienDto? _user;
        private DispatcherTimer? _timer;

        public WelcomeWindow()
        {
            InitializeComponent();
        }

        public WelcomeWindow(NhanVienDto user)
        {
            InitializeComponent();
            _user = user;
        }

        private void Window_Loaded(object sender, RoutedEventArgs e)
        {
            if (_user != null)
            {
                txtUserGreeting.Text = $"Xin chào, {_user.HoTen}";

                // 1. Tải ảnh bằng HinhAnhHelper
                BitmapImage avatar = HinhAnhHelper.LoadImageFromBase64(
                    _user.AnhDaiDien ?? string.Empty, // Sửa lỗi CS8604
                    HinhAnhPaths.DefaultAvatar
                );

                // 2. GÁN ẢNH VÀO UI (BƯỚC QUAN TRỌNG NHẤT BỊ THIẾU)
                if (avatar != null)
                {
                    // !!! QUAN TRỌNG: 
                    // Mở file WelcomeWindow.xaml, tìm x:Name của Image/ImageBrush
                    // và thay thế 'AvatarControl' bên dưới bằng tên thật.

                    // Ví dụ nếu là <Image x:Name="imgAvatar" .../>
                    // imgAvatar.Source = avatar;

                    // Ví dụ nếu là <Border x:Name="AvatarBorder"> <Border.Background> <ImageBrush x:Name="AvatarBrush"/>
                    // AvatarBrush.ImageSource = avatar;
                }
            }

            // Cấu hình timer
            _timer = new DispatcherTimer
            {
                Interval = TimeSpan.FromMilliseconds(2500)
            };
            _timer.Tick += Timer_Tick;
            _timer.Start();
        }

        private void Timer_Tick(object? sender, EventArgs e)
        {
            _timer?.Stop();
            this.Close();
        }

        // XÓA 2 HÀM LoadImageFromBase64 VÀ LoadImageFromPath CŨ Ở ĐÂY
    }
}
/////////////////////
/// <Page x:Class="AppCafebookApi.View.nhanvien.pages.SoDoBanView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.nhanvien.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="SoDoBanView" FontFamily="Segoe UI" Loaded="Page_Loaded">

    <Page.Resources>
        <Geometry x:Key="IconSelectTable">M12,2C8.13,2 5,5.13 5,9C5,14.25 12,22 12,22C12,22 19,14.25 19,9C19,5.13 15.87,2 12,2M12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5Z</Geometry>
        <Geometry x:Key="IconRefresh">M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z</Geometry>
        <Geometry x:Key="IconMenu">M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z</Geometry>

        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#EEEEEE"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="StatusGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="StatusRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="StatusYellowBrush" Color="#FFA726"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="StatusBlueBrush" Color="#42A5F5"/>
        <ExponentialEase x:Key="ExpoEaseOut" EasingMode="EaseOut"/>
        <FontFamily x:Key="FontAwesomeSolid">/Fonts/Font Awesome 6 Free-Solid-900.otf#Font Awesome 6 Free Solid</FontFamily>
        <Style x:Key="TableCardStyle" TargetType="Button">
            <Setter Property="Width" Value="150"/>
            <Setter Property="Height" Value="130"/>
            <Setter Property="Margin" Value="15"/>
            <Setter Property="Background" Value="{StaticResource LightCreamBrush}"/>
            <Setter Property="BorderThickness" Value="0,5,0,0"/>
            <Setter Property="BorderBrush" Value="{StaticResource StatusGreenBrush}"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="cardBorder" 
                                Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}" 
                                BorderThickness="{TemplateBinding BorderThickness}" 
                                CornerRadius="8"
                                RenderTransformOrigin="0.5,0.5">
                            <Border.RenderTransform>
                                <ScaleTransform ScaleX="1" ScaleY="1"/>
                            </Border.RenderTransform>
                            <Border.Effect>
                                <DropShadowEffect x:Name="shadow" ShadowDepth="1" Color="#000" Opacity="0.1" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" Margin="5"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <EventTrigger RoutedEvent="MouseEnter">
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetName="cardBorder" Storyboard.TargetProperty="RenderTransform.ScaleX" To="1.04" Duration="0:0:0.2"/>
                                        <DoubleAnimation Storyboard.TargetName="cardBorder" Storyboard.TargetProperty="RenderTransform.ScaleY" To="1.04" Duration="0:0:0.2"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </EventTrigger>
                            <EventTrigger RoutedEvent="MouseLeave">
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetName="cardBorder" Storyboard.TargetProperty="RenderTransform.ScaleX" To="1.0" Duration="0:0:0.2"/>
                                        <DoubleAnimation Storyboard.TargetName="cardBorder" Storyboard.TargetProperty="RenderTransform.ScaleY" To="1.0" Duration="0:0:0.2"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </EventTrigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Trigger.EnterActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetName="cardBorder" Storyboard.TargetProperty="RenderTransform.ScaleX" To="0.98" Duration="0:0:0.05"/>
                                            <DoubleAnimation Storyboard.TargetName="cardBorder" Storyboard.TargetProperty="RenderTransform.ScaleY" To="0.98" Duration="0:0:0.05"/>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </Trigger.EnterActions>
                                <Trigger.ExitActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetName="cardBorder" Storyboard.TargetProperty="RenderTransform.ScaleX" To="1.04" Duration="0:0:0.1"/>
                                            <DoubleAnimation Storyboard.TargetName="cardBorder" Storyboard.TargetProperty="RenderTransform.ScaleY" To="1.04" Duration="0:0:0.1"/>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </Trigger.ExitActions>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <DataTrigger Binding="{Binding TrangThai}" Value="Có khách">
                    <Setter Property="BorderBrush" Value="{StaticResource StatusRedBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TrangThai}" Value="Đã đặt">
                    <Setter Property="BorderBrush" Value="{StaticResource StatusYellowBrush}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <!-- STYLE MỚI CHO CÁC NÚT THAO TÁC -->
        <Style x:Key="ActionButtonStyle" TargetType="Button">
            <!-- Tăng Padding theo chiều dọc (giá trị thứ 2) để nút cao hơn -->
            <Setter Property="Padding" Value="12,20"/>
            <Setter Property="Margin" Value="0,5"/>
            <!-- Tăng nhẹ FontSize để chữ to và cân đối hơn -->
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" 
                                CornerRadius="4" 
                                Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <!-- Áp dụng animation cho Grid gốc này -->
    <Grid x:Name="MainPanel"  >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <!-- Toàn bộ nội dung gốc được giữ nguyên -->
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="320"/>
        </Grid.ColumnDefinitions>

        <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled" Background="{StaticResource LightCreamBrush}">
            <ItemsControl x:Name="icBan" Margin="15">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Button Style="{StaticResource TableCardStyle}" Click="BtnBan_Click">
                            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                                <TextBlock FontSize="28" Margin="0,0,0,8" HorizontalAlignment="Center">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Text" Value="&#xf00c;"/>
                                            <Setter Property="FontFamily" Value="{StaticResource FontAwesomeSolid}"/>
                                            <Setter Property="Foreground" Value="{StaticResource StatusGreenBrush}"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding TrangThai}" Value="Có khách">
                                                    <Setter Property="Text" Value="&#xf0c0;"/>
                                                    <Setter Property="Foreground" Value="{StaticResource StatusRedBrush}"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding TrangThai}" Value="Đã đặt">
                                                    <Setter Property="Text" Value="&#xf017;"/>
                                                    <Setter Property="Foreground" Value="{StaticResource StatusYellowBrush}"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                                <TextBlock Text="{Binding SoBan}" FontSize="24" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding TrangThai}" FontSize="13" Foreground="{StaticResource TextGrayBrush}" HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding TongTienHienTai, StringFormat={}{0:N0} đ}" FontSize="13" Foreground="{StaticResource StatusRedBrush}" FontWeight="SemiBold" HorizontalAlignment="Center" Margin="0,4,0,0">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding TrangThai}" Value="Có khách">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </StackPanel>
                        </Button>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <Border Grid.Column="1" Background="#FAFFFFFF" CornerRadius="10,0,0,10">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="2" Direction="270" Color="Black" Opacity="0.05" BlurRadius="20"/>
            </Border.Effect>
            <Grid x:Name="panelThaoTac" Margin="25">
                <StackPanel x:Name="panelChuaChon" VerticalAlignment="Center" HorizontalAlignment="Center" Opacity="0.5">
                    <Path Data="{StaticResource IconSelectTable}" Fill="{StaticResource BorderGrayBrush}" Width="60" Height="60" Stretch="Uniform"/>
                    <TextBlock Text="Chọn một bàn để bắt đầu thao tác" FontSize="16" Foreground="{StaticResource TextGrayBrush}" TextWrapping="Wrap" TextAlignment="Center" Margin="0,20,0,0"/>
                </StackPanel>

                <StackPanel x:Name="panelDaChon" Visibility="Collapsed">
                    <TextBlock Text="Thông Tin Bàn" FontSize="22" FontWeight="Bold" Margin="0,0,0,15" Foreground="{StaticResource DarkBrownBrush}"/>
                    <Separator Background="#EEEEEE"/>
                    <TextBlock FontSize="40" FontWeight="Bold" Margin="0,20,0,0" Foreground="{StaticResource PrimaryBrownBrush}">Bàn <Run x:Name="runSoBan"/></TextBlock>
                    <TextBlock FontSize="16" Margin="0,5,0,0" Foreground="{StaticResource TextGrayBrush}">Trạng thái: <Run x:Name="runTrangThai" FontWeight="SemiBold"/></TextBlock>
                    <TextBlock x:Name="tbGhiChu" FontStyle="Italic" Foreground="{StaticResource TextGrayBrush}" Margin="0,5,0,0" TextWrapping="Wrap" Visibility="Collapsed"/>
                    <TextBlock x:Name="tbTongTienWrapper" FontSize="16" Margin="0,10,0,0" Foreground="{StaticResource DarkBrownBrush}">Tổng tiền tạm tính: <Run x:Name="runTongTien" FontWeight="Bold" Foreground="{StaticResource StatusRedBrush}"/></TextBlock>

                    <StackPanel Margin="0,30,0,0">
                        <Button x:Name="btnGoiMon" Padding="20,18" FontSize="16" FontWeight="Bold" Background="{StaticResource PrimaryBrownBrush}" Foreground="White" Click="BtnGoiMon_Click" Cursor="Hand">
                            <Button.Resources>
                                <Style TargetType="Border">
                                    <Setter Property="CornerRadius" Value="4"/>
                                </Style>
                            </Button.Resources>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Viewbox Grid.Column="0" Width="18" Height="18" Margin="0,0,12,0" VerticalAlignment="Center">
                                    <Path Data="{StaticResource IconMenu}" Fill="White"/>
                                </Viewbox>
                                <TextBlock Grid.Column="1" Text="Gọi Món / Thanh Toán" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            </Grid>
                        </Button>

                        <!-- Áp dụng Style cho các nút -->
                        <Button x:Name="btnChuyenBan" Content="Chuyển Bàn" Style="{StaticResource ActionButtonStyle}" Click="BtnChuyenBan_Click" Background="#F5F5F5" BorderBrush="#E0E0E0" Foreground="{StaticResource DarkBrownBrush}"/>
                        <Button x:Name="btnGopBan" Content="Gộp Bàn" Style="{StaticResource ActionButtonStyle}" Click="BtnGopBan_Click" Background="#F5F5F5" BorderBrush="#E0E0E0" Foreground="{StaticResource DarkBrownBrush}"/>
                        <Button x:Name="btnBaoCaoSuCo" Content="Báo cáo Sự cố" Style="{StaticResource ActionButtonStyle}" Background="{StaticResource StatusYellowBrush}" BorderBrush="{StaticResource StatusYellowBrush}" Foreground="White" Margin="0,20,0,0" Click="BtnBaoCaoSuCo_Click"/>
                    </StackPanel>

                    <Button x:Name="btnLamMoi" VerticalAlignment="Bottom" HorizontalAlignment="Stretch" Margin="0,50,0,0" Click="BtnLamMoi_Click" Style="{StaticResource ActionButtonStyle}" Background="Transparent" BorderBrush="#E0E0E0" Foreground="{StaticResource TextGrayBrush}" FontWeight="Normal">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="15" Height="15" Margin="0,0,10,0" VerticalAlignment="Center">
                                <Path Data="{StaticResource IconRefresh}" Fill="{StaticResource TextGrayBrush}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Làm mới Sơ đồ" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Page>
/////////////////////
/// using System;
using System.Collections.Generic;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media;
using CafebookModel.Model.ModelApp;
using AppCafebookApi.Services;
using AppCafebookApi.View.common; // <-- SỬA LỖI CS0246 (InputDialogWindow)

namespace AppCafebookApi.View.nhanvien.pages
{
    public partial class SoDoBanView : Page
    {
        private static readonly HttpClient httpClient;
        private BanSoDoDto? _selectedBan = null;
        private List<BanSoDoDto> _allTables = new List<BanSoDoDto>();

        static SoDoBanView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public SoDoBanView()
        {
            InitializeComponent();
            this.DataContext = this;
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadTablesAsync();
        }

        private async Task LoadTablesAsync()
        {
            panelChuaChon.Visibility = Visibility.Visible;
            panelDaChon.Visibility = Visibility.Collapsed;
            _selectedBan = null;
            MainPanel.Opacity = 0.5;

            try
            {
                // SỬA LỖI CS8601: Thêm '?? new ...' để xử lý null
                _allTables = (await httpClient.GetFromJsonAsync<List<BanSoDoDto>>("api/app/sodoban/tables"))
                             ?? new List<BanSoDoDto>();

                icBan.ItemsSource = _allTables;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Không thể tải sơ đồ bàn: {ex.Message}", "Lỗi API", MessageBoxButton.OK, MessageBoxImage.Error);
            }
            finally
            {
                MainPanel.Opacity = 1.0;
            }
        }

        private void BtnBan_Click(object sender, RoutedEventArgs e)
        {
            var button = sender as Button;
            _selectedBan = button?.DataContext as BanSoDoDto;

            if (_selectedBan == null) return;

            panelChuaChon.Visibility = Visibility.Collapsed;
            panelDaChon.Visibility = Visibility.Visible;

            runSoBan.Text = _selectedBan.SoBan;
            runTrangThai.Text = _selectedBan.TrangThai;

            if (!string.IsNullOrEmpty(_selectedBan.GhiChu))
            {
                tbGhiChu.Text = $"Ghi chú: {_selectedBan.GhiChu}";
                tbGhiChu.Visibility = Visibility.Visible;
            }
            else
            {
                tbGhiChu.Visibility = Visibility.Collapsed;
            }

            switch (_selectedBan.TrangThai)
            {
                case "Trống":
                    btnGoiMon.Content = "Tạo Hóa Đơn Mới";
                    btnGoiMon.IsEnabled = true;
                    btnChuyenBan.IsEnabled = false;
                    btnGopBan.IsEnabled = false;
                    btnBaoCaoSuCo.IsEnabled = true;
                    tbTongTienWrapper.Visibility = Visibility.Collapsed;
                    break;

                case "Có khách":
                    btnGoiMon.Content = "Gọi Món / Thanh Toán";
                    btnGoiMon.IsEnabled = true;
                    btnChuyenBan.IsEnabled = true;
                    btnGopBan.IsEnabled = true;
                    btnBaoCaoSuCo.IsEnabled = false;
                    tbTongTienWrapper.Visibility = Visibility.Visible;
                    runTongTien.Text = _selectedBan.TongTienHienTai.ToString("N0") + " đ";
                    break;

                case "Đã đặt":
                    btnGoiMon.Content = "Khách đặt (Mở Hóa Đơn)";
                    btnGoiMon.IsEnabled = true;
                    btnChuyenBan.IsEnabled = false;
                    btnGopBan.IsEnabled = false;
                    btnBaoCaoSuCo.IsEnabled = true;
                    tbTongTienWrapper.Visibility = Visibility.Collapsed;
                    break;

                case "Bảo trì":
                case "Tạm ngưng": // Thêm
                    btnGoiMon.Content = "BÀN ĐANG BẢO TRÌ";
                    btnGoiMon.IsEnabled = false;
                    btnChuyenBan.IsEnabled = false;
                    btnGopBan.IsEnabled = false;
                    btnBaoCaoSuCo.IsEnabled = false;
                    tbTongTienWrapper.Visibility = Visibility.Collapsed;
                    break;
            }
        }

        private async void BtnGoiMon_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedBan == null) return;

            int? idHoaDon = _selectedBan.IdHoaDonHienTai;

            if (_selectedBan.TrangThai == "Trống" || _selectedBan.TrangThai == "Đã đặt")
            {
                if (AuthService.CurrentUser == null)
                {
                    MessageBox.Show("Lỗi: Không tìm thấy thông tin nhân viên đăng nhập.", "Lỗi Phiên");
                    return;
                }
                int idNhanVien = AuthService.CurrentUser.IdNhanVien;

                try
                {
                    var response = await httpClient.PostAsJsonAsync($"api/app/sodoban/createorder/{_selectedBan.IdBan}/{idNhanVien}", new { });

                    if (response.IsSuccessStatusCode)
                    {
                        // SỬA LỖI CS1061: Dùng ReadFromJsonAsync (hiện đại)
                        dynamic? result = await response.Content.ReadFromJsonAsync<dynamic>();
                        if (result != null)
                        {
                            // Cần deserialize JObject
                            var resultObj = System.Text.Json.JsonSerializer.Deserialize<dynamic>(result.ToString());
                            idHoaDon = (int)resultObj.idHoaDon;
                        }

                        await LoadTablesAsync();
                    }
                    else
                    {
                        MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lỗi tạo hóa đơn");
                        return;
                    }
                }
                catch (Exception ex) { MessageBox.Show($"Lỗi API: {ex.Message}", "Lỗi"); return; }
            }

            if (idHoaDon.HasValue)
            {
                // ** YÊU CẦU: Bạn cần tạo trang 'ChiTietHoaDonView.xaml' **
                // this.NavigationService.Navigate(new ChiTietHoaDonView(idHoaDon.Value));
                MessageBox.Show($"Sẵn sàng điều hướng đến trang gọi món cho Hóa đơn ID: {idHoaDon.Value}");
            }
        }

        private async void BtnLamMoi_Click(object sender, RoutedEventArgs e)
        {
            await LoadTablesAsync();
        }

        private async void BtnBaoCaoSuCo_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedBan == null) return;

            // Lấy ID nhân viên đang đăng nhập
            if (AuthService.CurrentUser == null)
            {
                MessageBox.Show("Lỗi: Không tìm thấy thông tin nhân viên đăng nhập.", "Lỗi Phiên");
                return;
            }
            int idNhanVien = AuthService.CurrentUser.IdNhanVien;

            var inputDialog = new InputDialogWindow("Báo cáo sự cố", $"Vui lòng mô tả sự cố cho bàn {_selectedBan.SoBan}:");
            if (inputDialog.ShowDialog() == true)
            {
                string ghiChu = inputDialog.InputText;
                if (string.IsNullOrWhiteSpace(ghiChu)) return;

                try
                {
                    var request = new BaoCaoSuCoRequestDto { GhiChuSuCo = ghiChu };

                    // SỬA LỖI: Gửi cả idNhanVien
                    var response = await httpClient.PostAsJsonAsync($"api/app/sodoban/reportproblem/{_selectedBan.IdBan}/{idNhanVien}", request);

                    if (response.IsSuccessStatusCode)
                    {
                        // Không cần MessageBox, quản lý sẽ thấy
                        await LoadTablesAsync(); // Làm mới
                    }
                    else
                    {
                        MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lỗi báo cáo");
                    }
                }
                catch (Exception ex) { MessageBox.Show($"Lỗi API: {ex.Message}", "Lỗi"); }
            }
        }

        private void BtnChuyenBan_Click(object sender, RoutedEventArgs e)
        {
            MessageBox.Show("Chức năng 'Chuyển Bàn' đang được phát triển. Yêu cầu tạo Popup chọn bàn đích.", "Thông báo");
        }

        private void BtnGopBan_Click(object sender, RoutedEventArgs e)
        {
            MessageBox.Show("Chức năng 'Gộp Bàn' đang được phát triển. Yêu cầu tạo Popup chọn bàn đích.", "Thông báo");
        }
    }
}
/////////////////////
/// <Window x:Class="AppCafebookApi.View.nhanvien.ManHinhNhanVien"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AppCafebookApi.View.nhanvien"
        mc:Ignorable="d"
        Title="Cafebook - Copyright by © Lâm Chu Bảo Toàn | Contact:[lamchubaotoan@gmail.com]" Height="800" Width="1440"
        Icon="/Assets/logo.ico"        
        WindowStartupLocation="CenterScreen"
        FontFamily="Segoe UI"
        WindowState="Maximized">

    <Window.Resources>
        <!-- Bảng màu thống nhất -->
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="SubtleWhiteTextBrush" Color="#BCAAA4"/>
        <SolidColorBrush x:Key="HoverBrownBrush" Color="#8D6E63"/>

        <!-- Bộ Icons -->
        <Geometry x:Key="IconDashboard">M13,3V9H21V3M13,21H21V11H13M3,21H11V15H3M3,13H11V3H3V13Z</Geometry>
        <Geometry x:Key="IconBooking">M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1M17,12H12V17H17V12Z</Geometry>
        <Geometry x:Key="IconProfile">M12,12A5,5 0 0,1 7,7A5,5 0 0,1 12,2A5,5 0 0,1 17,7A5,5 0 0,1 12,12M12,14C14.67,14 20,15.33 20,18V20H4V18C4,15.33 9.33,14 12,14Z</Geometry>
        <Geometry x:Key="IconClock">M12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z</Geometry>
        <Geometry x:Key="IconLogout">M16,17V14H9V12H16V9L20,13L16,17M14,2A2,2 0 0,1 16,4V6H14V4H5V20H14V18H16V20A2,2 0 0,1 14,22H5A2,2 0 0,1 3,20V4A2,2 0 0,1 5,2H14Z</Geometry>

        <!-- Style cho các nút điều hướng chính, giống hệt ManHinhAdmin -->
        <Style x:Key="NavToggleButton" TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource SubtleWhiteTextBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Padding" Value="20,12"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="border" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" CornerRadius="5" Margin="8,2">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Border x:Name="indicator" Width="4" Height="20" Background="Transparent" CornerRadius="2" VerticalAlignment="Center" Margin="-20,0,10,0"/>
                                <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,15,0">
                                    <Path Data="{Binding Path=Tag, RelativeSource={RelativeSource TemplatedParent}}" Fill="{TemplateBinding Foreground}" Stretch="Uniform" VerticalAlignment="Center"/>
                                </Viewbox>
                                <ContentPresenter Grid.Column="1" HorizontalAlignment="Left" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource HoverBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                                <Setter TargetName="indicator" Property="Background" Value="{StaticResource AccentOrangeBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Style cho các nút ở footer, giống hệt ManHinhAdmin -->
        <Style x:Key="FooterButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource SubtleWhiteTextBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Padding" Value="20,12"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" CornerRadius="5" Margin="8,2">
                            <ContentPresenter/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource HoverBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="250"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Sidebar (Thanh điều hướng bên trái) -->
        <Border Grid.Column="0" Background="{StaticResource PrimaryBrownBrush}">
            <!-- Sử dụng Grid 3 hàng giống màn hình Admin -->
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <!-- Header: Thông tin người dùng -->
                    <RowDefinition Height="*"/>
                    <!-- Content: Menu điều hướng -->
                    <RowDefinition Height="Auto"/>
                    <!-- Footer: Nút đăng xuất -->
                </Grid.RowDefinitions>

                <!-- Header: Thông tin người dùng -->
                <StackPanel Grid.Row="0" Margin="20">
                    <!-- Avatar Icon -->
                    <Border x:Name="AvatarBorder" 
                            Height="70" Width="70"
                            Background="{StaticResource LightCreamBrush}"
                            CornerRadius="35"
                            Margin="0,0,0,10">
                        <Viewbox Margin="12,10,18,20">
                            <Path Data="{StaticResource IconProfile}" Fill="{StaticResource PrimaryBrownBrush}">
                                <Path.RenderTransform>
                                    <TranslateTransform Y="1.5" />
                                </Path.RenderTransform>
                            </Path>
                        </Viewbox>
                    </Border>
                    <TextBlock x:Name="txtUserName" Text="Tên Nhân Viên" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource WhiteTextBrush}" HorizontalAlignment="Center" TextWrapping="Wrap" TextAlignment="Center"/>
                    <TextBlock x:Name="txtUserRole" Text="Nhân viên" FontSize="13" Foreground="{StaticResource SubtleWhiteTextBrush}" HorizontalAlignment="Center"/>
                </StackPanel>

                <!-- Content: Menu điều hướng trong ScrollViewer -->
                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <ToggleButton x:Name="btnSoDoBan" Content="Sơ đồ bàn" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconDashboard}" Click="BtnSoDoBan_Click" IsChecked="True"/>
                        <ToggleButton x:Name="btnDatBanSach" Content="Quản lý Đặt bàn" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconBooking}" Click="BtnDatBanSach_Click"/>

                        <Separator Margin="15,20" Background="{StaticResource HoverBrownBrush}"/>

                        <ToggleButton x:Name="btnThongTinCaNhan" Content="Thông tin cá nhân" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconProfile}" Click="BtnThongTinCaNhan_Click"/>
                        <ToggleButton x:Name="btnChamCong" Content="Chấm công" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconClock}" Click="BtnChamCong_Click"/>
                    </StackPanel>
                </ScrollViewer>

                <!-- Footer: Nút đăng xuất -->
                <StackPanel Grid.Row="2" VerticalAlignment="Bottom" Margin="0,0,0,5">
                    <Separator Margin="15" Background="{StaticResource HoverBrownBrush}"/>
                    <Button x:Name="btnDangXuat" Style="{StaticResource FooterButton}" Click="BtnDangXuat_Click"
                             Background="{StaticResource AccentOrangeBrush}"
                             Foreground="{StaticResource WhiteTextBrush}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,15,0">
                                <Path Data="{StaticResource IconLogout}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Đăng xuất" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Content (Nội dung chính) -->
        <Border Grid.Column="1" Background="{StaticResource LightCreamBrush}">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="2" Direction="270" Color="Black" Opacity="0.1" BlurRadius="10"/>
            </Border.Effect>
            <Frame x:Name="MainFrame" NavigationUIVisibility="Hidden"/>
        </Border>
    </Grid>
</Window>

///////////////////////////
/// using AppCafebookApi.Services; // Thêm
using AppCafebookApi.View.nhanvien.pages; // <-- THÊM USING NÀY
using CafebookModel.Utils; // Thêm
using System.Windows;
using System.Windows.Controls;
using System.Windows.Controls.Primitives; // Thêm
using System.Windows.Media; // Thêm
using System.Windows.Media.Imaging; // Thêm

namespace AppCafebookApi.View.nhanvien
{
    public partial class ManHinhNhanVien : Window
    {
        public ManHinhNhanVien()
        {
            InitializeComponent();
            // Sự kiện Loaded có thể được thêm từ XAML hoặc ở đây
            this.Loaded += ManHinhNhanVien_Loaded;
        }

        private void ManHinhNhanVien_Loaded(object sender, RoutedEventArgs e)
        {

            btnSoDoBan.IsChecked = true;
            NavigateToPage(btnSoDoBan, new SoDoBanView());

            var currentUser = AuthService.CurrentUser;
            if (currentUser != null)
            {
                // 1. Cập nhật tên và vai trò (Bạn đã có)
                txtUserName.Text = currentUser.HoTen;
                txtUserRole.Text = currentUser.TenVaiTro;

                // 2. Cập nhật Avatar (Bạn đã có)
                AvatarBorder.Child = null;
                BitmapImage avatarImage = HinhAnhHelper.LoadImageFromBase64(
                    currentUser.AnhDaiDien,
                    HinhAnhPaths.DefaultAvatar
                );
                AvatarBorder.Background = new ImageBrush(avatarImage)
                {
                    Stretch = Stretch.UniformToFill
                };

                // --- 3. BẮT ĐẦU PHÂN QUYỀN CHỨC NĂNG ---

                // Dựa trên CSDL, 'Thu ngân' và 'Quản lý' có quyền 'HoaDon.Tao'.
                // 'Pha chế' và 'Phục vụ' (tài khoản 'service') không có.
                // Chúng ta ẩn các nút nghiệp vụ chính nếu không có quyền.
                if (!AuthService.CoQuyen("HoaDon.Tao", "HoaDon.ThanhToan"))
                {
                    btnSoDoBan.Visibility = Visibility.Collapsed;
                    btnDatBanSach.Visibility = Visibility.Collapsed;
                }

                // Các nút cá nhân (Thông tin, Chấm công) được giữ lại cho mọi người
            }


        }
        // --- SỬA LẠI CÁC HÀM CLICK ĐIỀU HƯỚNG ---

        private void UncheckOtherButtons(ToggleButton? exception)
        {
            var navButtons = new List<ToggleButton>
            {
                btnSoDoBan, btnDatBanSach, btnThongTinCaNhan, btnChamCong
            };

            foreach (var button in navButtons)
            {
                if (button != null && button != exception)
                {
                    button.IsChecked = false;
                }
            }
        }

        // Hàm này giờ đã hợp lệ vì 'Page' đã được 'using'
        private void NavigateToPage(ToggleButton? clickedButton, Page pageInstance)
        {
            if (clickedButton == null) return;
            UncheckOtherButtons(clickedButton);
            clickedButton.IsChecked = true;
            MainFrame.Navigate(pageInstance);
        }

        private void BtnSoDoBan_Click(object sender, RoutedEventArgs e)
        {
            NavigateToPage(sender as ToggleButton, new SoDoBanView());
        }

        private void BtnDatBanSach_Click(object sender, RoutedEventArgs e)
        {
            MessageBox.Show("Chức năng 'Đặt Bàn Sách' đang được phát triển.");

            // SỬA LỖI CS8602: Thêm kiểm tra null
            if (sender is ToggleButton btn)
            {
                btn.IsChecked = false;
                btnSoDoBan.IsChecked = true; // Trả về trang mặc định
            }
        }

        private void BtnThongTinCaNhan_Click(object sender, RoutedEventArgs e)
        {
            MessageBox.Show("Chức năng 'Thông tin cá nhân' đang được phát triển.");

            // SỬA LỖI CS8602: Thêm kiểm tra null
            if (sender is ToggleButton btn)
            {
                btn.IsChecked = false;
                btnSoDoBan.IsChecked = true; // Trả về trang mặc định
            }
        }

        private void BtnChamCong_Click(object sender, RoutedEventArgs e)
        {
            MessageBox.Show("Chức năng 'Chấm công' đang được phát triển.");

            // SỬA LỖI CS8602: Thêm kiểm tra null
            if (sender is ToggleButton btn)
            {
                btn.IsChecked = false;
                btnSoDoBan.IsChecked = true; // Trả về trang mặc định
            }
        }

        // ... (Hàm Đăng xuất)
        private void BtnDangXuat_Click(object sender, RoutedEventArgs e)
        {
            var result = MessageBox.Show("Bạn có chắc chắn muốn đăng xuất?",
                                         "Xác nhận đăng xuất",
                                         MessageBoxButton.YesNo,
                                         MessageBoxImage.Question);

            if (result == MessageBoxResult.Yes)
            {
                AuthService.Logout();
                ManHinhDangNhap loginWindow = new ManHinhDangNhap();
                loginWindow.Show();
                this.Close();
            }
        }
    }
}
////////////////////////
<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyBanView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      xmlns:dto="clr-namespace:CafebookModel.Model.ModelApp;assembly=CafebookModel"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="QuanLyBanView"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="BackgroundHoverBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="BackgroundSelectedBrush" Color="#EFEBE9"/>

        <Geometry x:Key="IconAddFolder">M20,6H12L10,4H4C2.89,4 2,4.89 2,6V18C2,19.1 2.89,20 4,20H20C21.1,20 22,19.1 22,18V8C22,6.89 21.1,6 20,6M18,14H15V17H13V14H10V12H13V9H15V12H18V14Z</Geometry>
        <Geometry x:Key="IconAddTable">M4,6H20V8H4V6M4,10H20V12H4V10M4,14H11V16H4V14M19,16V19H16V21H14V19H11V16H14V14H16V16H19Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconHistory">M13.5,8H12V13L16.28,15.54L17,14.33L13.5,12.25V8M13,3C8.03,3 4,7.03 4,12C4,16.97 8.03,21 13,21C17.97,21 22,16.97 22,12C22,7.03 17.97,3 13,3M13,19C9.13,19 6,15.87 6,12C6,8.13 9.13,5 13,5C16.87,5 20,8.13 20,12C20,15.87 16.87,19 13,19Z</Geometry>
        <Geometry x:Key="IconClearFilter">M14.12,12.5L19.31,7.31L17.89,5.89L12.71,11.08L7.5,5.89L6.09,7.31L11.28,12.5L6.09,17.69L7.5,19.11L12.71,13.92L17.89,19.11L19.31,17.69L14.12,12.5M3,5H21V3H3V5Z</Geometry>
        <Geometry x:Key="IconCheck">M9,20.42L2.79,14.21L4.21,12.79L9,17.58L19.79,6.79L21.21,8.21L9,20.42Z</Geometry>

        <Style x:Key="ActionButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,10"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="4" Padding="{TemplateBinding Padding}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.1" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.8"/>
                                <Setter TargetName="border" Property="Effect" Value="{x:Null}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="DeleteButton" TargetType="Button" BasedOn="{StaticResource ActionButton}">
            <Setter Property="Background" Value="{StaticResource ErrorBrush}"/>
        </Style>

        <Style TargetType="Label">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,15,0,5"/>
        </Style>
        <Style x:Key="MaterialTextBox" TargetType="TextBox">
            <Setter Property="Padding" Value="8,10"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TextBox">
                        <Border x:Name="border" 
                                Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}" 
                                BorderThickness="{TemplateBinding BorderThickness}">
                            <ScrollViewer x:Name="PART_ContentHost" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsKeyboardFocused" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="BorderThickness" Value="0,0,0,2"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="IconButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="20" Padding="{TemplateBinding Padding}">
                            <Path Data="{Binding Content, RelativeSource={RelativeSource TemplatedParent}}" 
                                  Fill="{Binding Foreground, RelativeSource={RelativeSource TemplatedParent}}" 
                                  Width="16" Height="16" Stretch="Uniform"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource BackgroundHoverBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="MaterialComboBox" TargetType="ComboBox">
            <Setter Property="Padding" Value="8,10"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="SearchTextBox" TargetType="TextBox" BasedOn="{StaticResource MaterialTextBox}">
            <Setter Property="Padding" Value="8,8"/>
        </Style>
        <Style x:Key="FilterComboBox" TargetType="ComboBox" BasedOn="{StaticResource MaterialComboBox}">
            <Setter Property="Padding" Value="8,8"/>
        </Style>
        <Style TargetType="TabControl">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
        <Style TargetType="TabItem">
            <Setter Property="Background" Value="#E0E0E0"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border x:Name="border" BorderThickness="0,0,0,3" BorderBrush="Transparent" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" Margin="0,0,5,0">
                            <ContentPresenter ContentSource="Header" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="Background" Value="White"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
                                <Setter TargetName="border" Property="Background" Value="#F5F5F5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>


        <Style x:Key="MaterialIconButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="20">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BackgroundHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="MaterialIconToggleButton" TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="20">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BackgroundHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BackgroundSelectedBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
    </Page.Resources>

    <Grid Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="460"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Background="White" CornerRadius="8" Margin="10">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
            </Border.Effect>

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TabControl Grid.Row="0" Margin="5">

                    <TabItem Header="Tất cả Bàn (Dạng Lưới)">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10,5,10,10">
                                <TextBlock Text="Lọc Khu vực:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                                <ComboBox x:Name="cmbFilterKhuVuc" 
                                          Width="180" 
                                          DisplayMemberPath="TenKhuVuc" 
                                          SelectedValuePath="IdKhuVuc"
                                          Style="{StaticResource FilterComboBox}"
                                          SelectionChanged="CmbFilterKhuVuc_SelectionChanged"/>

                                <TextBlock Text="Tìm kiếm:" VerticalAlignment="Center" Margin="15,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                                <TextBox x:Name="txtSearch" 
                                         Width="200" 
                                         Style="{StaticResource SearchTextBox}"
                                         TextChanged="TxtSearch_TextChanged"/>

                                <Button x:Name="btnClearFilter" ToolTip="Xóa Lọc"
                                        Style="{StaticResource MaterialIconButton}" 
                                        Click="BtnClearFilter_Click" Margin="5,0,0,0">
                                    <Path Data="{StaticResource IconClearFilter}" Fill="{StaticResource TextGrayBrush}" Width="25" Height="25"/>
                                </Button>
                            </StackPanel>
                            <DataGrid Grid.Row="1" x:Name="dgAllBans" AutoGenerateColumns="False" IsReadOnly="True"
                                      SelectionMode="Single" SelectionChanged="DgAllBans_SelectionChanged"
                                      BorderThickness="0" RowHeaderWidth="0" Margin="10,0,10,10">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="ID" Binding="{Binding IdBan}" Width="50"/>
                                    <DataGridTextColumn Header="Số Bàn" Binding="{Binding SoBan}" Width="120"/>
                                    <DataGridTextColumn Header="Khu Vực" Binding="{Binding TenKhuVuc}" Width="120"/>
                                    <DataGridTextColumn Header="Số Ghế" Binding="{Binding SoGhe}" Width="80"/>
                                    <DataGridTextColumn Header="Trạng thái" Binding="{Binding TrangThai}" Width="120"/>
                                    <DataGridTextColumn Header="Ghi chú" Binding="{Binding GhiChu}" Width="*"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </TabItem>

                    <TabItem Header="Sự cố Bàn">
                        <Grid Margin="10">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <Grid Grid.Row="0" Margin="0,5,0,10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <TextBlock Grid.Column="0" x:Name="lblSuCoTitle" 
                                           Text="Sự cố Bàn cần xử lý" 
                                           FontSize="18" FontWeight="Bold" 
                                           Foreground="{StaticResource DarkBrownBrush}"
                                           VerticalAlignment="Center"/>

                                <ToggleButton Grid.Column="1" x:Name="btnToggleSuCoHistory"
                                              Style="{StaticResource MaterialIconToggleButton}"
                                              ToolTip="Xem lịch sử sự cố đã xử lý"
                                              Click="BtnToggleSuCoHistory_Click">
                                    <Path Data="{StaticResource IconHistory}" Fill="{StaticResource TextGrayBrush}" Width="25" Height="25"/>
                                </ToggleButton>
                            </Grid>

                            <ListBox Grid.Row="1" x:Name="lbThongBaoBan" BorderThickness="0" ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Border BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="0,0,0,1" Padding="5,10">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <StackPanel Grid.Column="0">
                                                    <TextBlock Text="{Binding NoiDung}" TextWrapping="Wrap"/>
                                                    <TextBlock FontStyle="Italic" FontSize="11" Foreground="Gray">
                                                        <Run Text="{Binding TenNhanVienTao}"/> - <Run Text="{Binding ThoiGianTao, StringFormat='HH:mm dd/MM'}"/>
                                                    </TextBlock>
                                                </StackPanel>

                                                <Button Grid.Column="1" ToolTip="Đánh dấu đã xử lý" Margin="10,0,0,0" x:Name="btnDanhDauDaDoc" 
                                                        Click="BtnDanhDauDaDoc_Click" 
                                                        Style="{StaticResource IconButton}"
                                                        Content="{StaticResource IconCheck}"
                                                        Foreground="{StaticResource SuccessBrush}"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Grid>
                    </TabItem>
                </TabControl>

                <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,10,0,10">
                    <Button x:Name="btnThemKhuVuc" Click="BtnThemKhuVuc_Click" 
                            Style="{StaticResource MaterialIconButton}" 
                            ToolTip="Thêm Khu Vực Mới" Margin="0,0,10,0">
                        <Path Data="{StaticResource IconAddFolder}" Fill="{StaticResource DarkBrownBrush}" Width="25" Height="25" Stretch="Fill"/>
                    </Button>
                    <Button x:Name="btnThemBan" Click="BtnThemBan_Click" 
                            Style="{StaticResource MaterialIconButton}" 
                            ToolTip="Thêm Bàn Mới">
                        <Path Data="{StaticResource IconAddTable}" Fill="{StaticResource DarkBrownBrush}" Width="25" Height="25" Stretch="Fill"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <Border Grid.Column="1" Background="White" CornerRadius="8" Padding="25" Margin="0,10,10,10">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
            </Border.Effect>
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <TextBlock x:Name="lblFormTitle" Text="Chọn một mục để xem chi tiết" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,5,0,15"/>
                    <Grid x:Name="formChiTiet" IsEnabled="False">
                        <StackPanel x:Name="panelKhuVuc">
                            <Label Content="Tên Khu Vực"/>
                            <TextBox x:Name="txtTenKhuVuc" Text="{Binding TenKhuVuc, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                     Style="{StaticResource MaterialTextBox}"/>
                            <Label Content="Mô tả Khu Vực"/>
                            <TextBox x:Name="txtMoTaKhuVuc" Text="{Binding MoTa, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                     Style="{StaticResource MaterialTextBox}"
                                     Height="80" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"/>
                        </StackPanel>
                        <StackPanel x:Name="panelBan" Visibility="Collapsed">
                            <Label Content="Số Bàn (Tên Bàn)"/>
                            <TextBox x:Name="txtSoBan" Text="{Binding SoBan, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                     Style="{StaticResource MaterialTextBox}"/>
                            <Label Content="Số Ghế"/>
                            <TextBox x:Name="txtSoGhe" Text="{Binding SoGhe, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                     Style="{StaticResource MaterialTextBox}"/>
                            <Label Content="Thuộc Khu Vực"/>
                            <ComboBox x:Name="cmbKhuVuc" DisplayMemberPath="TenKhuVuc" SelectedValuePath="IdKhuVuc"
                                      Style="{StaticResource MaterialComboBox}"/>
                            <Label Content="Trạng thái (Khóa Bàn)"/>
                            <ComboBox x:Name="cmbTrangThai" SelectedValuePath="Content"
                                      Style="{StaticResource MaterialComboBox}">
                                <ComboBoxItem Content="Trống"/>
                                <ComboBoxItem Content="Đang phục vụ"/>
                                <ComboBoxItem Content="Bảo trì"/>
                                <ComboBoxItem Content="Tạm ngưng"/>
                            </ComboBox>
                            <Label Content="Ghi chú (Lý do sự cố)"/>
                            <TextBox x:Name="txtGhiChu" Text="{Binding GhiChu, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                     Style="{StaticResource MaterialTextBox}"
                                     Height="80" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"/>
                        </StackPanel>
                    </Grid>
                    <StackPanel x:Name="panelActions" Orientation="Horizontal" Margin="0,25,0,0">
                        <Button x:Name="btnLuu" Click="BtnLuu_Click" Margin="0,0,10,0" Style="{StaticResource ActionButton}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconSave}" Fill="White" Width="25" Height="25" Margin="0,0,8,0" VerticalAlignment="Center" Stretch="Fill"/>
                                <TextBlock Text="Lưu Thay Đổi" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        <Button x:Name="btnXoa" Click="BtnXoa_Click" Margin="0,0,10,0" Style="{StaticResource DeleteButton}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconDelete}" Fill="White" Width="25" Height="25" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                <TextBlock Text="Xóa" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        <Button x:Name="btnXemLichSu" Visibility="Collapsed" Click="BtnXemLichSu_Click" 
                                Background="#42A5F5" Style="{StaticResource ActionButton}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconHistory}" Fill="White" Width="25" Height="25" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                <TextBlock Text="Xem Lịch sử" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                    <Border x:Name="LoadingOverlay" Background="#80FFFFFF" Visibility="Collapsed"
                            Grid.RowSpan="2" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                        <TextBlock Text="Đang xử lý..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
                    </Border>
                </StackPanel>
            </ScrollViewer>
        </Border>
    </Grid>
</Page>
//////////////////////
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using System.Windows.Controls.Primitives; // <-- THÊM MỚI để dùng ToggleButton

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyBanView : Page
    {
        private static readonly HttpClient httpClient;
        private List<KhuVucDto> _khuVucList = new List<KhuVucDto>();
        private object? _selectedItem;
        private bool _isAddingNew = false;
        private int? _navigateToBanId = null;

        // Class nội bộ
        private class BanGridItem : BanDto
        {
            public string? TenKhuVuc { get; set; }
        }

        private List<BanGridItem> _allBansList = new List<BanGridItem>();
        private List<KhuVucDto> _filterKhuVucList = new List<KhuVucDto>();

        // --- THÊM MỚI: Cache cho danh sách sự cố ---
        private List<ThongBaoDto> _allThongBaoList = new List<ThongBaoDto>();
        private bool _showSuCoHistory = false; // Mặc định xem các mục CHƯA XỬ LÝ


        static QuanLyBanView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyBanView()
        {
            InitializeComponent();
        }

        public QuanLyBanView(int banIdToNavigate) : this()
        {
            _navigateToBanId = banIdToNavigate;
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadDataAsync();
            await LoadThongBaoSuCoAsync();

            if (_navigateToBanId.HasValue)
            {
                SelectAndShowBan(_navigateToBanId.Value);
                _navigateToBanId = null;
            }
        }

        private async Task LoadDataAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                _khuVucList = (await httpClient.GetFromJsonAsync<List<KhuVucDto>>("api/app/banquanly/tree"))
                                 ?? new List<KhuVucDto>();

                cmbKhuVuc.ItemsSource = _khuVucList;

                _allBansList = _khuVucList.SelectMany(kv => kv.Bans.Select(b => new BanGridItem
                {
                    IdBan = b.IdBan,
                    SoBan = b.SoBan,
                    SoGhe = b.SoGhe,
                    TrangThai = b.TrangThai,
                    GhiChu = b.GhiChu,
                    IdKhuVuc = b.IdKhuVuc,
                    TenKhuVuc = kv.TenKhuVuc
                })).OrderBy(b => b.IdBan).ToList();

                dgAllBans.ItemsSource = _allBansList;

                _filterKhuVucList = new List<KhuVucDto>(_khuVucList);
                _filterKhuVucList.Insert(0, new KhuVucDto { IdKhuVuc = 0, TenKhuVuc = "--- Tất cả Khu vực ---" });
                cmbFilterKhuVuc.ItemsSource = _filterKhuVucList;
                cmbFilterKhuVuc.SelectedIndex = 0;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải dữ liệu: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
                if (_navigateToBanId == null)
                    ResetForm();
            }
        }

        // --- SỬA ĐỔI: Tải và Lọc Sự cố Bàn ---
        private async Task LoadThongBaoSuCoAsync()
        {
            try
            {
                // 1. Tải TẤT CẢ thông báo và lưu vào cache
                _allThongBaoList = (await httpClient.GetFromJsonAsync<List<ThongBaoDto>>("api/app/thongbao/all"))
                                     ?? new List<ThongBaoDto>();

                // (Giả sử bạn muốn lọc chỉ các sự cố bàn)
                _allThongBaoList = _allThongBaoList.Where(t => t.LoaiThongBao == "SuCoBan").ToList();

                // 2. Áp dụng bộ lọc hiện tại (mặc định là xem mục chưa xử lý)
                ApplySuCoFilter();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải thông báo sự cố: {ex.Message}");
            }
        }

        // --- THÊM MỚI: Hàm lọc danh sách sự cố ---
        private void ApplySuCoFilter()
        {
            if (_showSuCoHistory)
            {
                // Chế độ LỊCH SỬ (Đã xem = true)
                lblSuCoTitle.Text = "Lịch sử Sự cố (Đã xử lý)";
                lbThongBaoBan.ItemsSource = _allThongBaoList
                    .Where(t => t.DaXem == true)
                    .OrderByDescending(t => t.ThoiGianTao)
                    .ToList();
            }
            else
            {
                // Chế độ MẶC ĐỊNH (Chưa xem = false)
                lblSuCoTitle.Text = "Sự cố Bàn cần xử lý";
                lbThongBaoBan.ItemsSource = _allThongBaoList
                    .Where(t => t.DaXem == false)
                    .OrderByDescending(t => t.ThoiGianTao)
                    .ToList();
            }
        }

        // --- THÊM MỚI: Xử lý nút bật/tắt Lịch sử ---
        private void BtnToggleSuCoHistory_Click(object sender, RoutedEventArgs e)
        {
            _showSuCoHistory = (sender as ToggleButton).IsChecked == true;
            ApplySuCoFilter();
        }

        // --- SỬA ĐỔI: Xử lý nút "Đã xử lý" (API Thật) ---
        private async void BtnDanhDauDaDoc_Click(object sender, RoutedEventArgs e)
        {
            var button = sender as Button;
            var thongBao = button?.DataContext as ThongBaoDto;

            if (thongBao != null)
            {
                // Chỉ xử lý nếu nó chưa được xem (tránh gọi API 2 lần)
                if (thongBao.DaXem == false)
                {
                    try
                    {
                        var idThongBao = thongBao.IdThongBao;
                        var response = await httpClient.PostAsync($"api/app/thongbao/mark-as-read/{idThongBao}", null);

                        if (response.IsSuccessStatusCode)
                        {
                            // Cập nhật cache (nhanh hơn gọi API)
                            var itemInCache = _allThongBaoList.FirstOrDefault(t => t.IdThongBao == idThongBao);
                            if (itemInCache != null)
                            {
                                itemInCache.DaXem = true;
                            }
                            // Tải lại danh sách lọc (item sẽ tự động biến mất)
                            ApplySuCoFilter();
                        }
                        else
                        {
                            MessageBox.Show($"Lỗi cập nhật: {await response.Content.ReadAsStringAsync()}");
                        }
                    }
                    catch (Exception ex)
                    {
                        MessageBox.Show($"Lỗi cập nhật: {ex.Message}");
                    }
                }
                else
                {
                    // Nếu người dùng đang ở tab Lịch sử và bấm vào mục đã xử lý, 
                    // ta có thể làm gì đó, ví dụ: xóa hẳn
                    // Tạm thời: Không làm gì
                    MessageBox.Show("Sự cố này đã được xử lý trước đó.");
                }
            }
        }


        private void SelectAndShowBan(int banId)
        {
            var ban = _khuVucList.SelectMany(kv => kv.Bans).FirstOrDefault(b => b.IdBan == banId);
            if (ban != null)
            {
                _selectedItem = ban;
                PopulateForm();

                var gridItem = _allBansList.FirstOrDefault(b => b.IdBan == banId);
                if (gridItem != null)
                {
                    dgAllBans.SelectedItem = gridItem;
                    dgAllBans.ScrollIntoView(gridItem);
                }
            }
        }

        // (Các hàm Lọc/Tìm kiếm giữ nguyên)
        private void CmbFilterKhuVuc_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            ApplyFilter();
        }

        private void TxtSearch_TextChanged(object sender, TextChangedEventArgs e)
        {
            ApplyFilter();
        }

        private void BtnClearFilter_Click(object sender, RoutedEventArgs e)
        {
            if (cmbFilterKhuVuc.SelectedIndex != 0)
                cmbFilterKhuVuc.SelectedIndex = 0;

            if (!string.IsNullOrEmpty(txtSearch.Text))
                txtSearch.Text = "";

            ApplyFilter();
        }

        private void ApplyFilter()
        {
            if (_allBansList == null) return;

            IEnumerable<BanGridItem> filteredView = _allBansList;

            if (cmbFilterKhuVuc.SelectedItem is KhuVucDto selectedKhuVuc && selectedKhuVuc.IdKhuVuc != 0)
            {
                filteredView = filteredView.Where(b => b.IdKhuVuc == selectedKhuVuc.IdKhuVuc);
            }

            string searchText = txtSearch.Text.Trim();
            if (!string.IsNullOrEmpty(searchText))
            {
                filteredView = filteredView.Where(b =>
                    b.SoBan.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                    (b.GhiChu != null && b.GhiChu.Contains(searchText, StringComparison.OrdinalIgnoreCase)) ||
                    b.TrangThai.Contains(searchText, StringComparison.OrdinalIgnoreCase)
                );
            }

            dgAllBans.ItemsSource = filteredView.ToList();
        }

        private void DgAllBans_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgAllBans.SelectedItem == null)
            {
                return;
            }

            if (dgAllBans.SelectedItem is BanGridItem selectedBan)
            {
                _selectedItem = _khuVucList
                    .SelectMany(kv => kv.Bans)
                    .FirstOrDefault(b => b.IdBan == selectedBan.IdBan);

                _isAddingNew = false;

                PopulateForm();
            }
        }

        // (Toàn bộ các hàm còn lại: PopulateForm, BtnThemKhuVuc_Click, BtnThemBan_Click, ResetForm, BtnLuu_Click, BtnXoa_Click, BtnXemLichSu_Click giữ nguyên)
        // ...
        private void PopulateForm()
        {
            panelKhuVuc.Visibility = Visibility.Collapsed;
            panelBan.Visibility = Visibility.Collapsed;
            formChiTiet.IsEnabled = false;
            btnXemLichSu.Visibility = Visibility.Collapsed;
            formChiTiet.DataContext = null;

            if (_selectedItem == null)
            {
                lblFormTitle.Text = "Chọn một mục để xem chi tiết";
                return;
            }

            formChiTiet.IsEnabled = true;

            if (_selectedItem is KhuVucDto kv)
            {
                lblFormTitle.Text = "Chi tiết Khu Vực";
                panelKhuVuc.Visibility = Visibility.Visible;
                formChiTiet.DataContext = kv;
            }
            else if (_selectedItem is BanDto ban)
            {
                lblFormTitle.Text = "Chi tiết Bàn";
                panelBan.Visibility = Visibility.Visible;
                formChiTiet.DataContext = ban;

                cmbKhuVuc.SelectedValue = ban.IdKhuVuc;
                cmbTrangThai.Text = ban.TrangThai;
                btnXemLichSu.Visibility = Visibility.Visible;
            }
        }

        private void BtnThemKhuVuc_Click(object sender, RoutedEventArgs e)
        {
            _selectedItem = new KhuVucDto();
            _isAddingNew = true;
            PopulateForm();
            lblFormTitle.Text = "Thêm Khu Vực Mới";
            formChiTiet.DataContext = _selectedItem;
        }

        private void BtnThemBan_Click(object sender, RoutedEventArgs e)
        {
            int defaultKhuVucId = _khuVucList.FirstOrDefault()?.IdKhuVuc ?? 0;

            _selectedItem = new BanDto { IdKhuVuc = defaultKhuVucId, TrangThai = "Trống" };
            _isAddingNew = true;
            PopulateForm();
            lblFormTitle.Text = "Thêm Bàn Mới";
            formChiTiet.DataContext = _selectedItem;
        }

        private void ResetForm()
        {
            _selectedItem = null;
            _isAddingNew = false;
            dgAllBans.SelectedItem = null;
            PopulateForm();
        }

        private async void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedItem == null) return;
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                HttpResponseMessage response;
                if (_selectedItem is KhuVucDto kv)
                {
                    var dto = new KhuVucUpdateRequestDto { TenKhuVuc = txtTenKhuVuc.Text, MoTa = txtMoTaKhuVuc.Text };
                    if (_isAddingNew)
                        response = await httpClient.PostAsJsonAsync("api/app/banquanly/khuvuc", dto);
                    else
                        response = await httpClient.PutAsJsonAsync($"api/app/banquanly/khuvuc/{kv.IdKhuVuc}", dto);
                }
                else if (_selectedItem is BanDto ban)
                {
                    var dto = new BanUpdateRequestDto
                    {
                        SoBan = txtSoBan.Text,
                        SoGhe = int.TryParse(txtSoGhe.Text, out int ghe) ? ghe : 0,
                        IdKhuVuc = (int)cmbKhuVuc.SelectedValue,
                        TrangThai = cmbTrangThai.Text,
                        GhiChu = txtGhiChu.Text
                    };

                    if (_isAddingNew)
                        response = await httpClient.PostAsJsonAsync("api/app/banquanly/ban", dto);
                    else
                        response = await httpClient.PutAsJsonAsync($"api/app/banquanly/ban/{ban.IdBan}", dto);
                }
                else
                {
                    throw new InvalidOperationException("Loại đối tượng không xác định.");
                }

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Lưu thành công!", "Thông báo");
                    await LoadDataAsync();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi: {ex.Message}", "Lỗi");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXoa_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedItem == null) return;
            string endpoint;
            string tenMuc;

            if (_selectedItem is KhuVucDto kv)
            {
                endpoint = $"api/app/banquanly/khuvuc/{kv.IdKhuVuc}";
                tenMuc = kv.TenKhuVuc;
            }
            else if (_selectedItem is BanDto ban)
            {
                endpoint = $"api/app/banquanly/ban/{ban.IdBan}";
                tenMuc = ban.SoBan;
            }
            else
            {
                return;
            }

            if (MessageBox.Show($"Bạn có chắc chắn muốn xóa '{tenMuc}' không?", "Xác nhận xóa", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.No)
            {
                return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync(endpoint);

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Xóa thành công!", "Thông báo");
                    await LoadDataAsync();
                }
                else if (response.StatusCode == HttpStatusCode.Conflict)
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Không thể xóa");
                }
                else
                {
                    MessageBox.Show($"Lỗi: {response.ReasonPhrase}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi: {ex.Message}", "Lỗi");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXemLichSu_Click(object sender, RoutedEventArgs e)
        {
            if (!(_selectedItem is BanDto ban)) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var history = await httpClient.GetFromJsonAsync<BanHistoryDto>($"api/app/banquanly/ban/{ban.IdBan}/history");
                if (history != null)
                {
                    MessageBox.Show(
                        $"Lịch sử Bàn: {ban.SoBan}\n\n" +
                        $"- Tổng số lượt phục vụ (HĐ đã thanh toán): {history.SoLuotPhucVu}\n" +
                        $"- Tổng doanh thu mang lại: {history.TongDoanhThu:N0} VND\n" +
                        $"- Tổng số lượt đặt trước: {history.SoLuotDatTruoc}",
                        "Lịch sử Bàn"
                    );
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải lịch sử: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }
    }
}
//////////////////////
/// <Page x:Class="AppCafebookApi.View.quanly.pages.TongQuanView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      
      xmlns:lvc="clr-namespace:LiveCharts.Wpf;assembly=LiveCharts.Wpf"
      
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="DashboardView"
      FontFamily="Segoe UI"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionOrangeBrush" Color="#FFA726"/>

        <Geometry x:Key="IconRevenue">M11.8,10.9C11.4,11.2 10.8,11.5 10,11.5C8.6,11.5 7.5,10.4 7.5,9C7.5,7.6 8.6,6.5 10,6.5C10.8,6.5 11.4,6.8 11.8,7.1L12.9,6C12,5.2 11,4.5 10,4.5C7.2,4.5 5,6.7 5,9.5C5,12.3 7.2,14.5 10,14.5C11,14.5 12,13.8 12.9,13L11.8,10.9M12,3H1V1H12V3M12,21H1V19H12V21M17.5,12.5A1.5,1.5 0 0,1 16,11A1.5,1.5 0 0,1 17.5,9.5A1.5,1.5 0 0,1 19,11A1.5,1.5 0 0,1 17.5,12.5M15.5,17H19.5V15H15.5V17Z</Geometry>
        <Geometry x:Key="IconOrder">M17,17H7V15H17M17,13H7V11H17M17,9H7V7H17M19,3H5C3.9,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.9 20.1,3 19,3Z</Geometry>
        <Geometry x:Key="IconStar">M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z</Geometry>
        <Geometry x:Key="IconDownload">M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z</Geometry>
        <Geometry x:Key="IconSettings">M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M12,22C11.6,22 11.2,21.9 10.8,21.7L9.1,20.9C5.1,19.3 2,15.2 2,10.9V5L12,2L22,5V10.9C22,15.2 18.9,19.3 14.9,20.9L13.2,21.7C12.8,21.9 12.4,22 12,22Z</Geometry>

        <Style x:Key="KpiCard" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Margin" Value="0,0,20,0"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="ReportButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource SubtleGrayBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="12"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Margin" Value="0,0,0,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="6">
                            <ContentPresenter Margin="{TemplateBinding Padding}" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid x:Name="MainPanel" Background="{StaticResource LightCreamBrush}" Margin="10" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Text="Tổng quan Hôm nay" FontSize="28" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,10,0,20"/>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Style="{StaticResource KpiCard}">
                <Grid>
                    <Path Data="{StaticResource IconRevenue}" Fill="{StaticResource ActionGreenBrush}" Width="48" Height="48" Stretch="Uniform" HorizontalAlignment="Right" VerticalAlignment="Top" Opacity="0.1"/>
                    <StackPanel>
                        <TextBlock x:Name="lblDoanhThu" Text="0 VND" FontSize="26" FontWeight="Bold" Foreground="{StaticResource ActionGreenBrush}"/>
                        <TextBlock Text="DOANH THU" FontSize="14" Foreground="{StaticResource TextGrayBrush}" Margin="0,5,0,0"/>
                    </StackPanel>
                </Grid>
            </Border>
            <Border Grid.Column="1" Style="{StaticResource KpiCard}">
                <Grid>
                    <Path Data="{StaticResource IconOrder}" Fill="{StaticResource ActionBlueBrush}" Width="48" Height="48" Stretch="Uniform" HorizontalAlignment="Right" VerticalAlignment="Top" Opacity="0.1"/>
                    <StackPanel>
                        <TextBlock x:Name="lblDonHang" Text="0" FontSize="26" FontWeight="Bold" Foreground="{StaticResource ActionBlueBrush}"/>
                        <TextBlock Text="ĐƠN HÀNG" FontSize="14" Foreground="{StaticResource TextGrayBrush}" Margin="0,5,0,0"/>
                    </StackPanel>
                </Grid>
            </Border>
            <Border Grid.Column="2" Style="{StaticResource KpiCard}" Margin="0">
                <Grid>
                    <Path Data="{StaticResource IconStar}" Fill="{StaticResource ActionOrangeBrush}" Width="48" Height="48" Stretch="Uniform" HorizontalAlignment="Right" VerticalAlignment="Top" Opacity="0.1"/>
                    <StackPanel>
                        <TextBlock x:Name="lblSanPhamBanChay" Text="Chưa có" FontSize="22" FontWeight="Bold" Foreground="{StaticResource ActionOrangeBrush}" TextTrimming="CharacterEllipsis"/>
                        <TextBlock Text="SẢN PHẨM BÁN CHẠY" FontSize="14" Foreground="{StaticResource TextGrayBrush}" Margin="0,5,0,0"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>

        <Grid Grid.Row="2" Margin="0,20,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="3*"/>
                <ColumnDefinition Width="1*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Style="{StaticResource KpiCard}" Margin="0,0,20,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <TextBlock Grid.Row="0" Text="Doanh thu 30 ngày qua" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>

                    <lvc:CartesianChart Grid.Row="1" Margin="0,15,0,0" Series="{Binding SeriesCollection}">
                        <lvc:CartesianChart.Resources>
                            <Style TargetType="lvc:LineSeries">
                                <Setter Property="Stroke" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter Property="Fill" Value="#406F4E37"/>
                                <Setter Property="StrokeThickness" Value="3"/>
                                <Setter Property="PointGeometry" Value="{x:Null}"/>
                            </Style>
                            <Style TargetType="lvc:DefaultTooltip">
                                <Setter Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                                <Setter Property="CornerRadius" Value="4"/>
                            </Style>
                        </lvc:CartesianChart.Resources>
                        <lvc:CartesianChart.AxisX>
                            <lvc:Axis Title="Ngày" Labels="{Binding Labels}">
                                <lvc:Axis.Separator>
                                    <lvc:Separator Stroke="#E0E0E0" StrokeThickness="1"/>
                                </lvc:Axis.Separator>
                            </lvc:Axis>
                        </lvc:CartesianChart.AxisX>
                        <lvc:CartesianChart.AxisY>
                            <lvc:Axis Title="Doanh thu" LabelFormatter="{Binding YFormatter}">
                                <lvc:Axis.Separator>
                                    <lvc:Separator Stroke="#E0E0E0" StrokeThickness="1"/>
                                </lvc:Axis.Separator>
                            </lvc:Axis>
                        </lvc:CartesianChart.AxisY>
                    </lvc:CartesianChart>

                </Grid>
            </Border>

            <Border Grid.Column="1" Style="{StaticResource KpiCard}" Margin="0">
                <StackPanel>
                    <TextBlock Text="Báo cáo &amp; Tác vụ" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,15" Foreground="{StaticResource DarkBrownBrush}"/>
                    <Button x:Name="btnExportRevenue" Style="{StaticResource ReportButton}" Click="BtnExportRevenue_Click">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,10,0">
                                <Path Data="{StaticResource IconDownload}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Xuất Báo cáo Doanh thu" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                    <Button x:Name="btnExportTonKhoSach" Style="{StaticResource ReportButton}" Click="BtnExportTonKhoSach_Click">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,10,0">
                                <Path Data="{StaticResource IconDownload}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Xuất Tồn kho Sách" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                    <Button x:Name="btnExportNguyenLieu" Style="{StaticResource ReportButton}" Click="BtnExportNguyenLieu_Click">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,10,0">
                                <Path Data="{StaticResource IconDownload}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Xuất Tồn kho Nguyên liệu" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                    <Button x:Name="btnExportPerformance" Style="{StaticResource ReportButton}" Click="BtnExportPerformance_Click">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,10,0">
                                <Path Data="{StaticResource IconDownload}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Xuất Hiệu suất NV" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                    <Button x:Name="btnCaiDat" Style="{StaticResource ReportButton}" Margin="0,20,0,0" Click="BtnCaiDat_Click">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,10,0">
                                <Path Data="{StaticResource IconSettings}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Cài đặt thông tin hiển thị" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</Page>
/////////////////////
/// using AppCafebookApi.View.common;
using CafebookModel.Model.ModelApp;
// --- 1. SỬ DỤNG CÁC USING CŨ CỦA LIVECHARTS ---
using LiveCharts;
using LiveCharts.Wpf;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation; // <-- Đảm bảo bạn có using này

namespace AppCafebookApi.View.quanly.pages
{
    public partial class TongQuanView : Page
    {
        // --- 2. KHAI BÁO HTTPCLIENT ---
        private static readonly HttpClient httpClient;

        static TongQuanView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166") // URL của API
            };
        }

        // --- 3. KHAI BÁO CÁC THUỘC TÍNH BINDING CŨ ---
        public SeriesCollection SeriesCollection { get; set; }
        public string[] Labels { get; set; }
        public Func<double, string> YFormatter { get; set; }

        // --- 4. CONSTRUCTOR ---
        public TongQuanView()
        {
            InitializeComponent();

            // Khởi tạo các giá trị cho biểu đồ
            SeriesCollection = new SeriesCollection
            {
                new LineSeries
                {
                    Title = "Doanh thu",
                    Values = new ChartValues<decimal>(), // Khởi tạo rỗng
                    LineSmoothness = 0 // Tắt làm mịn
                }
            };

            Labels = Array.Empty<string>(); // Khởi tạo rỗng
            YFormatter = value => value.ToString("N0") + " VND"; // Định dạng tiền

            // Set DataContext để XAML có thể binding
            DataContext = this;
        }

        // --- 5. HÀM LOAD DỮ LIỆU TỪ API ---
        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            try
            {
                // Gọi API (API Controller giữ nguyên, không cần sửa)
                var data = await httpClient.GetFromJsonAsync<DashboardSummaryDto>("api/app/dashboard/summary");

                if (data != null)
                {
                    // 1. Cập nhật các Thẻ KPI
                    lblDoanhThu.Text = data.TongDoanhThuHomNay.ToString("N0") + " VND";
                    lblDonHang.Text = data.TongDonHangHomNay.ToString();
                    lblSanPhamBanChay.Text = data.SanPhamBanChayHomNay;

                    // 2. Cập nhật Biểu đồ (theo cách của LVC 0.9.7)

                    // Xóa dữ liệu cũ
                    SeriesCollection[0].Values.Clear();

                    // Thêm dữ liệu mới
                    foreach (var item in data.DoanhThu30Ngay)
                    {
                        SeriesCollection[0].Values.Add(item.TongTien);
                    }

                    // Cập nhật nhãn trục X
                    Labels = data.DoanhThu30Ngay.Select(d => d.Ngay.ToString("dd/MM")).ToArray();

                    // Cập nhật lại DataContext để binding nhận thay đổi (cho Labels)
                    DataContext = null;
                    DataContext = this;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Không thể tải dữ liệu Dashboard: {ex.Message}", "Lỗi API", MessageBoxButton.OK, MessageBoxImage.Error);
                lblDoanhThu.Text = "Lỗi";
                lblDonHang.Text = "Lỗi";
                lblSanPhamBanChay.Text = "Lỗi";
            }
        }


        // --- CÁC HÀM XỬ LÝ NÚT BẤM (BÁO CÁO) ---
        // (Giữ nguyên không thay đổi)

        // THAY THẾ HÀM NÀY
        private void BtnExportRevenue_Click(object sender, RoutedEventArgs e)
        {
            // Lỗi của bạn là do dùng code cũ (ShowDialog)
            // Code mới phải là điều hướng (Navigate)
            if (this.NavigationService != null)
            {
                this.NavigationService.Navigate(new BaocaodoanhthuPreviewWindow());
            }
        }

        // --- THAY THẾ HÀM NÀY ---
        private void BtnExportTonKhoSach_Click(object sender, RoutedEventArgs e)
        {
            // Điều hướng Frame (MainFrame) đến trang Báo cáo Sách
            if (this.NavigationService != null)
            {
                this.NavigationService.Navigate(new BapCaoTonKhoSachPreviewWindow());
            }
        }

        // --- THAY THẾ HÀM NÀY ---
        private void BtnExportNguyenLieu_Click(object sender, RoutedEventArgs e)
        {
            // Điều hướng Frame (MainFrame) đến trang Báo cáo Kho
            this.NavigationService?.Navigate(new BaoCaoTonKhoNguyenLieuPreviewWindow());
        }

        // --- THAY THẾ HÀM NÀY ---
        private void BtnExportPerformance_Click(object sender, RoutedEventArgs e)
        {
            // Điều hướng Frame (MainFrame) đến trang Báo cáo Hiệu suất
            this.NavigationService?.Navigate(new BaoCaoHieuSuatNhanVientPreviewWindow());
        }

        // THAY THẾ HÀM NÀY
        private void BtnCaiDat_Click(object sender, RoutedEventArgs e)
        {
            // SỬA LỖI: Dùng trực tiếp NavigationService của Page
            if (this.NavigationService != null)
            {
                // Điều hướng Frame (MainFrame) đến trang CaiDatWindow
                this.NavigationService.Navigate(new CaiDatWindow());
            }
            else
            {
                MessageBox.Show("Không tìm thấy dịch vụ điều hướng.");
            }
        }
    }
}
//////////////////////
/// <Window x:Class="AppCafebookApi.View.quanly.ManHinhQuanly"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AppCafebookApi.View.quanly"
        mc:Ignorable="d" 
        Title="Cafebook - Copyright by © Lâm Chu Bảo Toàn | Contact: [lamchubaotoan@gmail.com]" Height="800" Width="1440"
        WindowStartupLocation="CenterScreen"
        FontFamily="Segoe UI"
        WindowState="Maximized"
        Loaded="Window_Loaded">

    <Window.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="SubtleWhiteTextBrush" Color="#BCAAA4"/>
        <SolidColorBrush x:Key="HoverBrownBrush" Color="#8D6E63"/>

        <Geometry x:Key="IconDashboard">M13,3V9H21V3M13,21H21V11H13M3,21H11V15H3M3,13H11V3H3V13Z</Geometry>
        <Geometry x:Key="IconCoffee">M16,5H14V3H12V5H10A3,3 0 0,0 7,8V14H18V8A3,3 0 0,0 15,5M20,19H4V17H20V19Z</Geometry>
        <Geometry x:Key="IconTable">M4,6H20V8H4V6M4,10H20V12H4V10M4,14H20V16H4V14M4,18H20V20H4V18Z</Geometry>
        <Geometry x:Key="IconWarehouse">M12,3L2,8V21H22V8L12,3M19,19H15V13H9V19H5V9.4L12,5.5L19,9.4V19Z</Geometry>
        <Geometry x:Key="IconOrder">M17,17H7V15H17M17,13H7V11H17M17,9H7V7H17M19,3H5C3.9,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.9 20.1,3 19,3Z</Geometry>
        <Geometry x:Key="IconBook">M18,2H6C4.9,2 4,2.9 4,4V20C4,21.1 4.9,22 6,22H18C19.1,22 20,21.1 20,20V4C20,2.9 19.1,2 18,2M11,4H13V12L11,10.8L9,12V4H11Z</Geometry>
        <Geometry x:Key="IconUsers">M16,13C17.7,13 21,13.9 21,15.5V17H11V15.5C11,13.9 14.3,13 16,13M8,13C9.7,13 13,13.9 13,15.5V17H3V15.5C3,13.9 6.3,13 8,13M8,11.5A3.5,3.5 0 0,0 11.5,8A3.5,3.5 0 0,0 8,4.5A3.5,3.5 0 0,0 4.5,8A3.5,3.5 0 0,0 8,11.5M16,11.5A3.5,3.5 0 0,0 19.5,8A3.5,3.5 0 0,0 16,4.5A3.5,3.5 0 0,0 12.5,8A3.5,3.5 0 0,0 16,11.5Z</Geometry>
        <Geometry x:Key="IconCustomer">M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5,5.61 6.79,4 9,4C11.21,4 13,5.61 13,8C13,10.39 11.21,12 9,12C6.79,12 5,10.39 5,8M9,13C11.67,13 17,14.34 17,17V20H1V17C1,14.34 6.33,13 9,13M17.75,10.5A3.75,3.75 0 0,0 21.5,6.75A3.75,3.75 0 0,0 17.75,3A3.75,3.75 0 0,0 14,6.75A3.75,3.75 0 0,0 17.75,10.5M14,17.25C14,16.5 15.17,16 16.5,16C17.83,16 19,16.5 19,17.25V18H14V17.25Z</Geometry>
        <Geometry x:Key="IconNotification">M12,22C13.1,22 14,21.1 14,20H10C10,21.1 10.9,22 12,22M18,16V11C18,7.93 16.36,5.36 13.5,4.68V4C13.5,3.17 12.83,2.5 12,2.5C11.17,2.5 10.5,3.17 10.5,4V4.68C7.63,5.36 6,7.93 6,11V16L4,18V19H20V18L18,16Z</Geometry>
        <Geometry x:Key="IconLogout">M16,17V14H9V12H16V9L20,13L16,17M14,2A2,2 0 0,1 16,4V6H14V4H5V20H14V18H16V20A2,2 0 0,1 14,22H5A2,2 0 0,1 3,20V4A2,2 0 0,1 5,2H14Z</Geometry>
        <Geometry x:Key="IconPromotion">M12.41,2.58C12.03,2.2 11.53,2 11,2H4C2.9,2 2,2.9 2,4V11C2,11.53 2.2,12.03 2.59,12.41L12.42,22.24C12.81,22.63 13.44,22.63 13.83,22.24L22.24,13.82C22.63,13.43 22.63,12.8 22.24,12.41L12.41,2.58M7,7A1.5,1.5 0 0,1 5.5,8.5A1.5,1.5 0 0,1 4,7A1.5,1.5 0 0,1 5.5,5.5A1.5,1.5 0 0,1 7,7Z</Geometry>
        <Geometry x:Key="IconProfile">M12,12A5,5 0 0,1 7,7A5,5 0 0,1 12,2A5,5 0 0,1 17,7A5,5 0 0,1 12,12M12,14C14.67,14 20,15.33 20,18V20H4V18C4,15.33 9.33,14 12,14Z</Geometry>

        <Style x:Key="NavToggleButton" TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource SubtleWhiteTextBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Padding" Value="20,12"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="border" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" CornerRadius="5" Margin="8,2">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Border x:Name="indicator" Width="4" Height="20" Background="Transparent" CornerRadius="2" VerticalAlignment="Center" Margin="-20,0,10,0"/>
                                <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,15,0">
                                    <Path Data="{Binding Path=Tag, RelativeSource={RelativeSource TemplatedParent}}" Fill="{TemplateBinding Foreground}" Stretch="Uniform" VerticalAlignment="Center"/>
                                </Viewbox>
                                <ContentPresenter Grid.Column="1" HorizontalAlignment="Left" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource HoverBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                                <Setter TargetName="indicator" Property="Background" Value="{StaticResource AccentOrangeBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="FooterButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource SubtleWhiteTextBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Padding" Value="20,12"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" CornerRadius="5" Margin="8,2">
                            <ContentPresenter/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource HoverBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="250"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Background="{StaticResource PrimaryBrownBrush}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <StackPanel Grid.Row="0" Margin="20">
                    <!-- Avatar Icon -->
                    <Border x:Name="AvatarBorder"
                            Height="70" Width="70"
                            Background="{StaticResource LightCreamBrush}"
                            CornerRadius="35"
                            Margin="0,0,0,10">
                        <Viewbox Margin="12,10,18,20">
                            <Path Data="{StaticResource IconProfile}" Fill="{StaticResource PrimaryBrownBrush}">
                                <Path.RenderTransform>
                                    <TranslateTransform Y="1.5" />
                                </Path.RenderTransform>
                            </Path>
                        </Viewbox>
                    </Border>
                    <TextBlock x:Name="txtAdminName" Text="Admin" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource WhiteTextBrush}" HorizontalAlignment="Center"/>
                    <TextBlock x:Name="txtUserRole" Text="Quản trị viên" FontSize="13" Foreground="{StaticResource SubtleWhiteTextBrush}" HorizontalAlignment="Center"/>
                </StackPanel>

                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <ToggleButton x:Name="btnTongQuan" Content="Tổng quan &amp; Báo cáo" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconDashboard}" Click="NavButton_Click" IsChecked="True"/>
                        <ToggleButton x:Name="btnSanPham" Content="Quản lý Sản phẩm" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconCoffee}" Click="NavButton_Click"/>
                        <ToggleButton x:Name="btnBan" Content="Quản lý Bàn" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconTable}" Click="NavButton_Click"/>
                        <ToggleButton x:Name="btnKho" Content="Quản lý Kho" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconWarehouse}" Click="NavButton_Click"/>
                        <ToggleButton x:Name="btnDonHang" Content="Quản lý Đơn hàng" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconOrder}" Click="NavButton_Click"/>
                        <ToggleButton x:Name="btnSach" Content="Quản lý Sách" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconBook}" Click="NavButton_Click"/>
                        <ToggleButton x:Name="btnNhanSu" Content="Quản lý Nhân sự" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconUsers}" Click="NavButton_Click"/>
                        <ToggleButton x:Name="btnKhachHang" Content="Quản lý KH &amp; KM" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconPromotion}" Click="NavButton_Click"/>
                    </StackPanel>
                </ScrollViewer>

                <StackPanel Grid.Row="2" VerticalAlignment="Bottom" Margin="0,0,0,5">
                    <Separator Margin="15" Background="{StaticResource HoverBrownBrush}"/>
                    <Button x:Name="btnThongBao" Style="{StaticResource FooterButton}" Click="BtnThongBao_Click" ToolTip="Xem thông báo mới">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,15,0">
                                <Path Data="{StaticResource IconNotification}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" />
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Thông báo" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            <Border Grid.Column="2" x:Name="BadgeThongBao" Background="Red" CornerRadius="10" Padding="5,1" MinWidth="20" Visibility="Collapsed" VerticalAlignment="Center">
                                <TextBlock x:Name="lblSoThongBao" Text="0" Foreground="White" FontSize="10" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                        </Grid>
                    </Button>
                    <Button x:Name="btnDangXuat" Style="{StaticResource FooterButton}" Click="BtnDangXuat_Click"
                             Background="{StaticResource AccentOrangeBrush}"
                             Foreground="{StaticResource WhiteTextBrush}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,15,0">
                                <Path Data="{StaticResource IconLogout}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Đăng xuất" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <Border Grid.Column="1" Background="{StaticResource LightCreamBrush}">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="2" Direction="270" Color="Black" Opacity="0.1" BlurRadius="10"/>
            </Border.Effect>
            <Frame x:Name="MainFrame" NavigationUIVisibility="Hidden"/>
        </Border>

        <Popup x:Name="PopupThongBao" IsOpen="False" StaysOpen="False" PlacementTarget="{Binding ElementName=btnThongBao}"
               Placement="Top" AllowsTransparency="True" PopupAnimation="Fade"
               Panel.ZIndex="1" Margin="5,0,0,0">
            <Border Background="White" BorderBrush="#DDD" BorderThickness="1" CornerRadius="8"
                    Width="350" MaxHeight="400">
                <Border.Effect>
                    <DropShadowEffect ShadowDepth="2" Color="#CCC" Opacity="0.5" BlurRadius="10"/>
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <TextBlock Text="Thông báo mới" Grid.Row="0" FontWeight="Bold" FontSize="16" Margin="15" Foreground="{StaticResource DarkBrownBrush}"/>
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <ItemsControl x:Name="icThongBaoPopup">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border BorderBrush="#EEE" BorderThickness="0,0,0,1" Padding="15,10"
                                            x:Name="ThongBaoItemBorder" MouseLeftButtonUp="ThongBaoItem_MouseLeftButtonUp"
                                            Background="Transparent" Cursor="Hand">
                                        <StackPanel>
                                            <TextBlock Text="{Binding NoiDung}" TextWrapping="Wrap"/>
                                            <TextBlock FontStyle="Italic" FontSize="11" Foreground="Gray" Margin="0,5,0,0">
                                                <Run Text="{Binding TenNhanVien}"/> - <Run Text="{Binding ThoiGianTao, StringFormat='HH:mm dd/MM'}"/>
                                            </TextBlock>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Popup>
    </Grid>
</Window>
/////////////////////
/// using AppCafebookApi.Services;
using AppCafebookApi.View;
using AppCafebookApi.View.common;
using AppCafebookApi.View.quanly.pages;
using CafebookModel.Model.Data;
using CafebookModel.Model.ModelApp;
using CafebookModel.Utils;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Controls.Primitives;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Threading;

namespace AppCafebookApi.View.quanly
{
    public partial class ManHinhQuanly : Window
    {
        private ToggleButton? currentNavButton;
        private NhanVienDto? currentUser;
        private DispatcherTimer _notificationTimer;
        private static readonly HttpClient httpClient;

        static ManHinhQuanly()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public ManHinhQuanly()
        {
            InitializeComponent();
            _notificationTimer = new DispatcherTimer();
            _notificationTimer.Interval = TimeSpan.FromSeconds(30);
            _notificationTimer.Tick += _notificationTimer_Tick;
        }

        private async void Window_Loaded(object sender, RoutedEventArgs e)
        {
            currentUser = AuthService.CurrentUser;
            if (currentUser != null)
            {
                // ... (Code cập nhật Avatar, Tên, Phân quyền giữ nguyên) ...
                txtAdminName.Text = currentUser.HoTen;
                txtUserRole.Text = currentUser.TenVaiTro;
                AvatarBorder.Child = null;
                BitmapImage avatarImage = HinhAnhHelper.LoadImageFromBase64(
                    currentUser.AnhDaiDien,
                    HinhAnhPaths.DefaultAvatar
                );
                AvatarBorder.Background = new ImageBrush(avatarImage)
                {
                    Stretch = Stretch.UniformToFill
                };

                btnTongQuan.Visibility = Visibility.Collapsed;
                btnSanPham.Visibility = Visibility.Collapsed;
                btnBan.Visibility = Visibility.Collapsed;
                btnKho.Visibility = Visibility.Collapsed;
                btnDonHang.Visibility = Visibility.Collapsed;
                btnSach.Visibility = Visibility.Collapsed;
                btnNhanSu.Visibility = Visibility.Collapsed;
                btnKhachHang.Visibility = Visibility.Collapsed;

                if (AuthService.CoQuyen("Dashboard.Xem"))
                    btnTongQuan.Visibility = Visibility.Visible;
                if (AuthService.CoQuyen("SanPham.QuanLy"))
                {
                    btnSanPham.Visibility = Visibility.Visible;
                    btnBan.Visibility = Visibility.Visible;
                    btnSach.Visibility = Visibility.Visible;
                }
                if (AuthService.CoQuyen("Kho.Nhap", "Kho.KiemKe"))
                    btnKho.Visibility = Visibility.Visible;
                if (AuthService.CoQuyen("HoaDon.Tao", "HoaDon.ThanhToan", "HoaDon.Huy"))
                    btnDonHang.Visibility = Visibility.Visible;
                if (AuthService.CoQuyen("NhanSu.QuanLy", "NhanSu.TinhLuong"))
                    btnNhanSu.Visibility = Visibility.Visible;
                if (AuthService.CoQuyen("NhanSu.QuanLy"))
                    btnKhachHang.Visibility = Visibility.Visible;
            }

            if (btnTongQuan.Visibility == Visibility.Visible)
            {
                UpdateSelectedButton(btnTongQuan);
                MainFrame.Navigate(new TongQuanView());
            }

            await CheckNotificationsAsync();
            _notificationTimer.Start();
        }

        private async void _notificationTimer_Tick(object? sender, EventArgs e)
        {
            await CheckNotificationsAsync();
        }

        private async Task CheckNotificationsAsync()
        {
            try
            {
                var result = await httpClient.GetFromJsonAsync<ThongBaoCountDto>("api/app/thongbao/unread-count");
                if (result != null && result.UnreadCount > 0)
                {
                    lblSoThongBao.Text = result.UnreadCount.ToString();
                    BadgeThongBao.Visibility = Visibility.Visible;
                }
                else
                {
                    BadgeThongBao.Visibility = Visibility.Collapsed;
                }
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"Lỗi kiểm tra thông báo: {ex.Message}");
            }
        }

        /// <summary>
        /// Hàm Click chính, đã được sửa lại
        /// </summary>
        private void NavButton_Click(object sender, RoutedEventArgs e)
        {
            var clickedButton = sender as ToggleButton;
            if (clickedButton == null || clickedButton == currentNavButton)
            {
                if (clickedButton != null) clickedButton.IsChecked = true;
                return;
            }

            Page? pageToNavigate = null;

            if (clickedButton == btnTongQuan)
            {
                pageToNavigate = new TongQuanView();
            }
            else if (clickedButton == btnBan)
            {
                pageToNavigate = new QuanLyBanView(); // Điều hướng đến Quản lý Bàn
            }

            // --- THÊM LOGIC ĐIỀU HƯỚNG CHO BÁO CÁO NHÂN SỰ ---
            else if (clickedButton == btnNhanSu)
            {
                // (Giả sử btnNhanSu cũng dùng để xem báo cáo)
                // (Nếu bạn có trang QL Nhân Sự riêng, hãy đổi new QuanLyNhanSuView())
                pageToNavigate = new BaoCaoHieuSuatNhanVientPreviewWindow();
            }
            // --- KẾT THÚC THÊM LOGIC ---

            // (Các 'else if' khác của bạn...)

            if (pageToNavigate != null)
            {
                UpdateSelectedButton(clickedButton);
                MainFrame.Navigate(pageToNavigate);
            }
            else
            {
                MessageBox.Show($"Chức năng '{clickedButton.Content}' đang được phát triển!", "Thông báo");
                clickedButton.IsChecked = false;
                if (currentNavButton != null)
                {
                    currentNavButton.IsChecked = true;
                }
            }

            // --- SỬA LỖI CS0136: XÓA KHỐI CODE BỊ TRÙNG LẶP (từ dòng 211 đến 250) ---
        }

        private void UpdateSelectedButton(ToggleButton newButton)
        {
            if (currentNavButton != null && currentNavButton != newButton)
            {
                currentNavButton.IsChecked = false;
            }
            currentNavButton = newButton;
            currentNavButton.IsChecked = true;
        }

        private async void BtnThongBao_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                var notifications = await httpClient.GetFromJsonAsync<List<ThongBaoDto>>("api/app/thongbao/all");
                icThongBaoPopup.ItemsSource = notifications;
                PopupThongBao.IsOpen = true;
                await CheckNotificationsAsync();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Không thể tải thông báo: {ex.Message}", "Lỗi API");
            }
        }

        private async void ThongBaoItem_MouseLeftButtonUp(object sender, System.Windows.Input.MouseButtonEventArgs e)
        {
            if (sender is FrameworkElement element && element.DataContext is ThongBaoDto thongBao)
            {
                PopupThongBao.IsOpen = false;
                _ = httpClient.PostAsync($"api/app/thongbao/mark-as-read/{thongBao.IdThongBao}", null);

                if (thongBao.LoaiThongBao == "SuCoBan" && thongBao.IdLienQuan.HasValue)
                {
                    int idBanCanDen = thongBao.IdLienQuan.Value;
                    UpdateSelectedButton(btnBan);
                    MainFrame.Navigate(new QuanLyBanView(idBanCanDen)); // Lỗi CS1729 ở đây
                }

                await CheckNotificationsAsync();
            }
        }

        private void BtnDangXuat_Click(object sender, RoutedEventArgs e)
        {
            var result = MessageBox.Show("Bạn có chắc chắn muốn đăng xuất?",
                                         "Xác nhận đăng xuất",
                                         MessageBoxButton.YesNo,
                                         MessageBoxImage.Question);

            if (result == MessageBoxResult.Yes)
            {
                AuthService.Logout();
                ManHinhDangNhap loginWindow = new ManHinhDangNhap();
                loginWindow.Show();
                this.Close();
            }
        }
    }
}
//////////////////////
/// <Window x:Class="AppCafebookApi.View.ManHinhDangNhap"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AppCafebookApi.View"
        mc:Ignorable="d"
        Title="Đăng nhập hệ thống CafeBook" Height="500" Width="850"
        WindowStartupLocation="CenterScreen"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent"
        ResizeMode="NoResize"
        FontFamily="Segoe UI"
        Loaded="Window_Loaded"
        KeyDown="Window_KeyDown">

    <Window.Resources>
        <SolidColorBrush x:Key="PrimaryBrown" Color="#6F4E37"/>
        <SolidColorBrush x:Key="AccentOrange" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCream" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="DarkText" Color="#4E342E"/>
        <SolidColorBrush x:Key="SubtleGray" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="WhiteText" Color="#FFFFFF"/>

        <Geometry x:Key="UserIcon">M12,12A5,5 0 0,1 7,7A5,5 0 0,1 12,2A5,5 0 0,1 17,7A5,5 0 0,1 12,12M12,14C14.67,14 20,15.33 20,18V20H4V18C4,15.33 9.33,14 12,14Z</Geometry>
        <Geometry x:Key="LockIcon">M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8H17V6A5,5 0 0,0 12,1A5,5 0 0,0 7,6V8H6A2,2 0 0,0 4,10V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V10A2,2 0 0,0 18,8Z</Geometry>
        <Geometry x:Key="LogoIcon">M16,5H14V3H12V5H10A3,3 0 0,0 7,8V14H18V8A3,3 0 0,0 15,5M20,19H4V17H20V19Z</Geometry>

        <Style TargetType="TextBox">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="{StaticResource SubtleGray}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="Foreground" Value="{StaticResource DarkText}"/>
            <Setter Property="Padding" Value="35,8,8,8"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TextBox">
                        <Border x:Name="border"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                SnapsToDevicePixels="True">
                            <ScrollViewer x:Name="PART_ContentHost" Focusable="False" HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Hidden"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsKeyboardFocused" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource AccentOrange}"/>
                                <Setter TargetName="border" Property="BorderThickness" Value="0,0,0,2"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrown}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="PasswordBox">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="{StaticResource SubtleGray}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="Foreground" Value="{StaticResource DarkText}"/>
            <Setter Property="Padding" Value="35,8,8,8"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="PasswordBox">
                        <Border x:Name="border"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                SnapsToDevicePixels="True">

                            <ScrollViewer x:Name="PART_ContentHost" Focusable="False" HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Hidden"/>

                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsKeyboardFocused" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource AccentOrange}"/>
                                <Setter TargetName="border" Property="BorderThickness" Value="0,0,0,2"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrown}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrown}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteText}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Height" Value="42"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                CornerRadius="21"
                                Background="{TemplateBinding Background}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="2" Color="#6F4E37" Opacity="0.3" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource AccentOrange}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="TextButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrown}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Height" Value="42"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Foreground" Value="{StaticResource AccentOrange}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

    </Window.Resources>

    <Border CornerRadius="12" Background="{StaticResource LightCream}">
        <Border.Effect>
            <DropShadowEffect Color="#000000" Opacity="0.15" BlurRadius="30" ShadowDepth="0"/>
        </Border.Effect>
        <Grid x:Name="MainGrid">
            <Grid.Triggers>
                <EventTrigger RoutedEvent="Loaded">
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation Storyboard.TargetName="MainGrid" Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
            </Grid.Triggers>

            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="320"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Background="{StaticResource PrimaryBrown}" CornerRadius="12,0,0,12">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <Ellipse Width="100" Height="100" Margin="0,0,0,20">
                        <Ellipse.Effect>
                            <DropShadowEffect ShadowDepth="1" BlurRadius="15" Opacity="0.2"/>
                        </Ellipse.Effect>
                        <Ellipse.Fill>
                            <!-- Thay đổi "/Assets/logo.png" thành đường dẫn chính xác tới file của bạn -->
                            <ImageBrush ImageSource="/Assets/logo.png"/>
                        </Ellipse.Fill>
                    </Ellipse>
                    <TextBlock Text="CafeBook" FontSize="36" FontWeight="Bold" Foreground="{StaticResource WhiteText}" HorizontalAlignment="Center"/>
                    <TextBlock Text="Awaken your senses" Opacity="0.8" FontSize="14" Foreground="{StaticResource WhiteText}" HorizontalAlignment="Center" Margin="0,5,0,0"/>
                </StackPanel>
            </Border>

            <Grid Grid.Column="1" Margin="50,40">
                <StackPanel VerticalAlignment="Center">
                    <TextBlock Text="Đăng Nhập"
                               FontSize="28"
                               FontWeight="Bold"
                               Foreground="{StaticResource DarkText}"
                               Margin="0,0,0,10"/>
                    <TextBlock Text="Chào mừng trở lại! Vui lòng nhập thông tin của bạn."
                               FontSize="14"
                               Foreground="{StaticResource DarkText}"
                               Opacity="0.7"
                               TextWrapping="Wrap"
                               Margin="0,0,0,30"/>

                    <Grid Margin="0,10,0,0">
                        <TextBlock Text="Tên đăng nhập" Foreground="{StaticResource PrimaryBrown}" VerticalAlignment="Top" Margin="0,-8,0,0" FontSize="12"/>
                        <Path Data="{StaticResource UserIcon}" Fill="{StaticResource SubtleGray}" Width="18" Height="18" Stretch="Uniform" VerticalAlignment="Center" HorizontalAlignment="Left" Margin="5,0,0,0"/>
                        <TextBox x:Name="txtUsername"/>
                    </Grid>

                    <Grid Margin="0,25,0,0">
                        <TextBlock Text="Mật khẩu" Foreground="{StaticResource PrimaryBrown}" VerticalAlignment="Top" Margin="0,-8,0,0" FontSize="12"/>
                        <Path Data="{StaticResource LockIcon}" Fill="{StaticResource SubtleGray}" Width="18" Height="18" Stretch="Uniform" VerticalAlignment="Center" HorizontalAlignment="Left" Margin="5,0,0,0"/>
                        <TextBox x:Name="txtVisiblePassword" Visibility="Collapsed" TextChanged="TxtVisiblePassword_TextChanged"/>
                        <PasswordBox x:Name="txtPassword" PasswordChanged="TxtPassword_PasswordChanged"/>
                    </Grid>

                    <CheckBox x:Name="chkShowPassword"
                              Content="Hiển thị mật khẩu"
                              FontSize="12"
                              Foreground="{StaticResource DarkText}"
                              HorizontalAlignment="Right"
                              Margin="0,15,0,0"
                              Checked="ChkShowPassword_Checked" Unchecked="ChkShowPassword_Unchecked"/>

                    <Button x:Name="btnLogin" Content="ĐĂNG NHẬP" Style="{StaticResource PrimaryButton}" Margin="0,30,0,0" Click="BtnLogin_Click"/>
                    <Button x:Name="btnExit" Content="Thoát chương trình" Style="{StaticResource TextButton}" Margin="0,10,0,0" Click="BtnExit_Click"/>
                </StackPanel>
            </Grid>
        </Grid>
    </Border>
</Window>
//////////////////
/// using System.Windows;
using System.Windows.Input;
using AppCafebookApi.Services;
using CafebookModel.Model.ModelApi;
using CafebookModel.Model.Data;
using AppCafebookApi.View.Common;
using AppCafebookApi.View.quanly;
using AppCafebookApi.View.nhanvien;
using System.Windows.Controls;

namespace AppCafebookApi.View
{
    public partial class ManHinhDangNhap : Window
    {
        // ... (Code constructor, Window_Loaded, BtnLogin_Click, ... giữ nguyên)
        public ManHinhDangNhap()
        {
            InitializeComponent();
        }

        private void Window_Loaded(object sender, RoutedEventArgs e)
        {
            txtUsername.Focus();
        }

        private async void BtnLogin_Click(object sender, RoutedEventArgs e)
        {
            var loginRequest = new LoginRequestModel
            {
                TenDangNhap = txtUsername.Text,
                MatKhau = chkShowPassword.IsChecked == true ? txtVisiblePassword.Text : txtPassword.Password
            };

            btnLogin.IsEnabled = false;
            btnLogin.Content = "ĐANG KIỂM TRA...";

            LoginResponseModel response = AuthService.LoginBackdoor(loginRequest);

            if (!response.Success)
            {
                response = await AuthService.LoginAsync(loginRequest);
            }

            btnLogin.IsEnabled = true;
            btnLogin.Content = "ĐĂNG NHẬP";

            if (response.Success && response.UserData != null)
            {
                HienThiManHinhChao(response.UserData);
            }
            else
            {
                MessageBox.Show(response.Message, "Đăng nhập thất bại", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void HienThiManHinhChao(NhanVienDto user)
        {
            var welcomeWindow = new WelcomeWindow(user);
            welcomeWindow.Owner = this;
            welcomeWindow.ShowDialog();

            // SỬA LỖI CS8604: Thêm '?? string.Empty'
            // Đảm bảo rằng chúng ta không bao giờ truyền giá trị null
            PhanQuyenVaChuyenHuong(user.TenVaiTro ?? string.Empty);
        }

        private void PhanQuyenVaChuyenHuong(string tenVaiTro)
        {
            if (tenVaiTro == "Quản trị viên" || tenVaiTro == "Quản lý")
            {
                ManHinhQuanly adminWindow = new ManHinhQuanly();
                adminWindow.Show();
            }
            else
            {
                ManHinhNhanVien employeeWindow = new ManHinhNhanVien();
                employeeWindow.Show();
            }

            this.Close();
        }

        private void BtnExit_Click(object sender, RoutedEventArgs e)
        {
            Application.Current.Shutdown();
        }

        private async void Window_KeyDown(object sender, KeyEventArgs e)
        {
            // Cho phép nhấn Enter để đăng nhập
            if (e.Key == Key.Enter)
            {
                BtnLogin_Click(sender, e);
                e.Handled = true; // <-- THÊM DÒNG NÀY
            }
        }

        // --- Logic Hiển thị Mật khẩu ---

        // 1. Khi nhấn checkbox (Checked)
        private void ChkShowPassword_Checked(object sender, RoutedEventArgs e)
        {
            // Copy mật khẩu từ ô ẩn sang ô hiện
            txtVisiblePassword.Text = txtPassword.Password;

            // Đổi hiển thị
            txtVisiblePassword.Visibility = Visibility.Visible;
            txtPassword.Visibility = Visibility.Collapsed;
        }

        // 2. Khi bỏ nhấn checkbox (Unchecked)
        private void ChkShowPassword_Unchecked(object sender, RoutedEventArgs e)
        {
            // Copy mật khẩu từ ô hiện về ô ẩn
            txtPassword.Password = txtVisiblePassword.Text;

            // Đổi hiển thị
            txtVisiblePassword.Visibility = Visibility.Collapsed;
            txtPassword.Visibility = Visibility.Visible;
        }

        // 3. Khi gõ vào ô mật khẩu ẨN
        private void TxtPassword_PasswordChanged(object sender, RoutedEventArgs e)
        {
            // Chỉ cập nhật giá trị cho ô HIỆN nếu checkbox đang được chọn
            if (chkShowPassword.IsChecked == true)
            {
                txtVisiblePassword.Text = txtPassword.Password;
            }
        }

        // 4. Khi gõ vào ô mật khẩu HIỆN
        private void TxtVisiblePassword_TextChanged(object sender, TextChangedEventArgs e)
        {
            // Chỉ cập nhật giá trị cho ô ẨN nếu checkbox KHÔNG được chọn
            if (chkShowPassword.IsChecked == false)
            {
                txtPassword.Password = txtVisiblePassword.Text;
            }
        }
    }
}
///////////////////
/// <Application x:Class="AppCafebookApi.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:AppCafebookApi"
             StartupUri="View/ManHinhDangNhap.xaml">
    <Application.Resources>
         
    </Application.Resources>
</Application>

/////////////////
/// using System.Windows;

[assembly: ThemeInfo(
    ResourceDictionaryLocation.None,            //where theme specific resource dictionaries are located
                                                //(used if a resource is not found in the page,
                                                // or application resource dictionaries)
    ResourceDictionaryLocation.SourceAssembly   //where the generic resource dictionary is located
                                                //(used if a resource is not found in the page,
                                                // app, or any theme specific resource dictionaries)
)]

//////////////////////
/// {
  "$schema": "http://json.schemastore.org/launchsettings.json",
  "iisSettings": {
    "windowsAuthentication": false,
    "anonymousAuthentication": true,
    "iisExpress": {
      "applicationUrl": "http://localhost:51436",
      "sslPort": 0
    }
  },
  "profiles": {
    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "http://localhost:5166",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "launchUrl": "swagger",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}

///////////////////////////
/// using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using CafebookModel.Model.Entities;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/banquanly")]
    [ApiController]
    public class BanQuanLyController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public BanQuanLyController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// Lấy toàn bộ cây Khu Vực và Bàn
        /// </summary>
        [HttpGet("tree")]
        public async Task<IActionResult> GetKhuVucTree()
        {
            var data = await _context.KhuVucs
                .AsNoTracking()
                .Select(kv => new KhuVucDto // Chuyển đổi sang DTO
                {
                    IdKhuVuc = kv.IdKhuVuc,
                    TenKhuVuc = kv.TenKhuVuc,
                    MoTa = kv.MoTa,
                    Bans = kv.Bans.Select(b => new BanDto
                    {
                        IdBan = b.IdBan,
                        SoBan = b.SoBan,
                        SoGhe = b.SoGhe,
                        TrangThai = b.TrangThai,
                        GhiChu = b.GhiChu,
                        IdKhuVuc = b.IdKhuVuc ?? 0
                    }).ToList()
                })
                .ToListAsync();

            return Ok(data);
        }

        // --- API CHO KHU VỰC ---

        [HttpPost("khuvuc")]
        public async Task<IActionResult> CreateKhuVuc([FromBody] KhuVucUpdateRequestDto dto)
        {
            var khuVuc = new KhuVuc
            {
                TenKhuVuc = dto.TenKhuVuc,
                MoTa = dto.MoTa
            };
            _context.KhuVucs.Add(khuVuc);
            await _context.SaveChangesAsync();
            return Ok(khuVuc); // Trả về đối tượng đã tạo
        }

        [HttpPut("khuvuc/{id}")]
        public async Task<IActionResult> UpdateKhuVuc(int id, [FromBody] KhuVucUpdateRequestDto dto)
        {
            var khuVuc = await _context.KhuVucs.FindAsync(id);
            if (khuVuc == null) return NotFound();

            khuVuc.TenKhuVuc = dto.TenKhuVuc;
            khuVuc.MoTa = dto.MoTa;
            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpDelete("khuvuc/{id}")]
        public async Task<IActionResult> DeleteKhuVuc(int id)
        {
            // Kiểm tra ràng buộc (còn bàn không)
            if (await _context.Bans.AnyAsync(b => b.IdKhuVuc == id))
            {
                return Conflict("Không thể xóa khu vực đang chứa bàn. Vui lòng di chuyển hoặc xóa các bàn trước.");
            }

            var khuVuc = await _context.KhuVucs.FindAsync(id);
            if (khuVuc == null) return NotFound();

            _context.KhuVucs.Remove(khuVuc);
            await _context.SaveChangesAsync();
            return Ok();
        }

        // --- API CHO BÀN ---

        [HttpPost("ban")]
        public async Task<IActionResult> CreateBan([FromBody] BanUpdateRequestDto dto)
        {
            var ban = new Ban
            {
                SoBan = dto.SoBan,
                SoGhe = dto.SoGhe,
                IdKhuVuc = dto.IdKhuVuc,
                TrangThai = "Trống", // Mặc định khi thêm mới
                GhiChu = dto.GhiChu
            };
            _context.Bans.Add(ban);
            await _context.SaveChangesAsync();
            return Ok(ban);
        }

        [HttpPut("ban/{id}")]
        public async Task<IActionResult> UpdateBan(int id, [FromBody] BanUpdateRequestDto dto)
        {
            var ban = await _context.Bans.FindAsync(id);
            if (ban == null) return NotFound();

            ban.SoBan = dto.SoBan;
            ban.SoGhe = dto.SoGhe;
            ban.IdKhuVuc = dto.IdKhuVuc;   // Cho phép di chuyển bàn
            ban.TrangThai = dto.TrangThai; // Cho phép khóa bàn
            ban.GhiChu = dto.GhiChu;

            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpDelete("ban/{id}")]
        public async Task<IActionResult> DeleteBan(int id)
        {
            // Kiểm tra ràng buộc theo yêu cầu
            if (await _context.HoaDons.AnyAsync(h => h.IdBan == id && h.TrangThai != "Đã thanh toán"))
            {
                return Conflict("Không thể xóa. Bàn đang có hóa đơn CHƯA thanh toán.");
            }
            if (await _context.PhieuDatBans.AnyAsync(p => p.IdBan == id && p.ThoiGianDat > DateTime.Now))
            {
                return Conflict("Không thể xóa. Bàn đang có phiếu đặt trước CHƯA diễn ra.");
            }

            var ban = await _context.Bans.FindAsync(id);
            if (ban == null) return NotFound();

            _context.Bans.Remove(ban);
            await _context.SaveChangesAsync();
            return Ok();
        }

        // --- API NÂNG CAO ---

        [HttpGet("ban/{id}/history")]
        public async Task<IActionResult> GetBanHistory(int id)
        {
            var history = new BanHistoryDto
            {
                SoLuotPhucVu = await _context.HoaDons.CountAsync(h => h.IdBan == id && h.TrangThai == "Đã thanh toán"),
                TongDoanhThu = await _context.HoaDons
                                    .Where(h => h.IdBan == id && h.TrangThai == "Đã thanh toán")
                                    .SumAsync(h => h.ThanhTien),
                SoLuotDatTruoc = await _context.PhieuDatBans.CountAsync(p => p.IdBan == id)
            };
            return Ok(history);
        }
    }
}
/////////////////////////
/// using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/baocao")]
    [ApiController]
    public class BaoCaoController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public BaoCaoController(CafebookDbContext context)
        {
            _context = context;
        }

        [HttpPost("doanhthu")]
        public async Task<IActionResult> GetDoanhThuReport([FromBody] BaoCaoRequestDto request)
        {
            var startDate = request.StartDate.Date;
            var endDate = request.EndDate.Date.AddDays(1);

            // 1. TÍNH DOANH THU (Code này đã đúng)
            var chiTietDoanhThu = (await _context.Database.SqlQuery<BaoCaoChiTietDoanhThuDto>($@"
                    SELECT
                        ISNULL(SUM(tongTienGoc), 0) AS TongDoanhThuGoc,
                        ISNULL(SUM(giamGia), 0) AS TongGiamGia,
                        ISNULL(SUM(TongPhuThu), 0) AS TongPhuThu,
                        ISNULL(SUM(thanhTien), 0) AS DoanhThuRong,
                        ISNULL(COUNT(idHoaDon), 0) AS SoLuongHoaDon,
                        ISNULL(AVG(thanhTien), 0) AS GiaTriTrungBinhHD
                    FROM dbo.HoaDon
                    WHERE trangThai = N'Đã thanh toán'
                    AND thoiGianThanhToan >= {startDate} AND thoiGianThanhToan < {endDate};
                ").ToListAsync()).FirstOrDefault() ?? new BaoCaoChiTietDoanhThuDto();

            // 2. TÍNH GIÁ VỐN (COGS) (Sửa lỗi CS1503 tại đây)
            // Xóa 'var cogsSql = ...' và truyền chuỗi nội suy TRỰC TIẾP
            var cogsResult = await _context.Database.SqlQuery<decimal>($@"
                WITH GiaVonNguyenLieu AS (
                    SELECT idNguyenLieu, AVG(donGiaNhap) AS GiaVonTrungBinh
                    FROM dbo.ChiTietNhapKho GROUP BY idNguyenLieu
                ),
                SanPhamDaBan AS (
                    SELECT cthd.idSanPham, SUM(cthd.soLuong) AS TongSoLuongBan
                    FROM dbo.ChiTietHoaDon cthd
                    JOIN dbo.HoaDon hd ON cthd.idHoaDon = hd.idHoaDon
                    WHERE hd.trangThai = N'Đã thanh toán'
                    AND hd.thoiGianThanhToan >= {startDate} AND hd.thoiGianThanhToan < {endDate}
                    GROUP BY cthd.idSanPham
                )
                SELECT ISNULL(SUM(spb.TongSoLuongBan * dl.soLuong * gv.GiaVonTrungBinh), 0)
                FROM SanPhamDaBan spb
                JOIN dbo.DinhLuong dl ON spb.idSanPham = dl.idSanPham
                JOIN GiaVonNguyenLieu gv ON dl.idNguyenLieu = gv.idNguyenLieu;
            ").ToListAsync(); // Lỗi CS1503 đã được sửa

            decimal tongGiaVon_COGS = cogsResult.FirstOrDefault();

            // 3. TÍNH CHI PHÍ VẬN HÀNH (OPEX) (Code này đã đúng)
            var opexResult = (await _context.Database.SqlQuery<OpexDto>($@"
                    SELECT 
                    ISNULL((SELECT SUM(thucLanh) 
                        FROM dbo.PhieuLuong
                        WHERE trangThai = N'Đã thanh toán'
                        AND ngayTao >= {startDate} AND ngayTao < {endDate}
                    ), 0) AS TongChiPhiLuong,
                    
                    ISNULL((SELECT SUM(TongGiaTriHuy) 
                        FROM dbo.PhieuXuatHuy
                        WHERE NgayXuatHuy >= {startDate} AND NgayXuatHuy < {endDate}
                    ), 0) AS TongChiPhiHuyHang;
                ").ToListAsync()).FirstOrDefault() ?? new OpexDto();

            // 4. TOP SẢN PHẨM (Code này đã đúng)
            var topSanPham = await _context.Database.SqlQuery<TopSanPhamDto>($@"
                    SELECT TOP 10
                        sp.tenSanPham,
                        SUM(cthd.soLuong) AS TongSoLuongBan,
                        SUM(cthd.thanhTien) AS TongDoanhThu
                    FROM dbo.ChiTietHoaDon cthd
                    JOIN dbo.SanPham sp ON cthd.idSanPham = sp.idSanPham
                    JOIN dbo.HoaDon hd ON cthd.idHoaDon = hd.idHoaDon
                    WHERE hd.trangThai = N'Đã thanh toán'
                    AND hd.thoiGianThanhToan >= {startDate} AND hd.thoiGianThanhToan < {endDate}
                    GROUP BY sp.tenSanPham
                    ORDER BY TongSoLuongBan DESC;
                ").ToListAsync();

            // 5. TỔNG HỢP KẾT QUẢ (Code này đã đúng)
            var dto = new BaoCaoTongHopDto
            {
                ChiTietDoanhThu = chiTietDoanhThu,
                ChiTietChiPhi = new BaoCaoChiPhiDto
                {
                    TongGiaVon_COGS = tongGiaVon_COGS,
                    TongChiPhiLuong = opexResult.TongChiPhiLuong,
                    TongChiPhiHuyHang = opexResult.TongChiPhiHuyHang
                },
                TopSanPham = topSanPham,
                Kpi = new BaoCaoKpiDto() // Tính toán KPI
            };

            // Tính toán KPI cuối cùng
            dto.Kpi.DoanhThuRong = dto.ChiTietDoanhThu.DoanhThuRong;
            dto.Kpi.TongGiaVon = dto.ChiTietChiPhi.TongGiaVon_COGS;
            dto.Kpi.LoiNhuanGop = dto.Kpi.DoanhThuRong - dto.Kpi.TongGiaVon;
            dto.Kpi.ChiPhiOpex = dto.ChiTietChiPhi.TongChiPhiLuong + dto.ChiTietChiPhi.TongChiPhiHuyHang;
            dto.Kpi.LoiNhuanRong = dto.Kpi.LoiNhuanGop - dto.Kpi.ChiPhiOpex;

            return Ok(dto);
        }
    }
}
////////////////////////
/// using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Data.SqlClient;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;
using System;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/baocaohieusuat")]
    [ApiController]
    public class BaoCaoHieuSuatController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public BaoCaoHieuSuatController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API để lấy dữ liệu cho ComboBox Vai Trò
        /// </summary>
        [HttpGet("filters")]
        public async Task<IActionResult> GetFilterData()
        {
            var vaiTros = await _context.VaiTros
                .Select(t => new FilterLookupDto { Id = t.IdVaiTro, Ten = t.TenVaiTro })
                .OrderBy(t => t.Ten)
                .ToListAsync();

            return Ok(new { vaiTros });
        }

        /// <summary>
        /// API tạo báo cáo chính
        /// </summary>
        [HttpPost("report")]
        public async Task<IActionResult> GetHieuSuatReport([FromBody] BaoCaoHieuSuatRequestDto request)
        {
            var startDate = request.StartDate.Date;
            var endDate = request.EndDate.Date.AddDays(1);

            // Tham số hóa
            object pSearchTextValue = string.IsNullOrEmpty(request.SearchText) ? DBNull.Value : $"%{request.SearchText}%";
            var pStartDate = new SqlParameter("@StartDate", startDate);
            var pEndDate = new SqlParameter("@EndDate", endDate);
            var pVaiTroId = new SqlParameter("@VaiTroId", (object)request.VaiTroId ?? DBNull.Value);
            var pSearchText = new SqlParameter("@SearchText", string.IsNullOrEmpty(request.SearchText) ? (object)DBNull.Value : $"%{request.SearchText}%");

            // 1. TÍNH KPIs
            var kpi = (await _context.Database.SqlQuery<BaoCaoHieuSuatKpiDto>($@"
                SELECT
                    ISNULL(SUM(hd.thanhTien), 0) AS TongDoanhThu,
                    ISNULL(SUM(bc.soGioLam), 0) AS TongGioLam,
                    ISNULL(COUNT(bc.idChamCong), 0) AS TongSoCaLam,
                    ISNULL(COUNT(nkhm.idNhatKy), 0) AS TongLanHuyMon
                FROM dbo.NhanVien nv
                LEFT JOIN dbo.HoaDon hd ON nv.idNhanVien = hd.idNhanVien 
                    AND hd.trangThai = N'Đã thanh toán' AND hd.thoiGianThanhToan >= {pStartDate} AND hd.thoiGianThanhToan < {pEndDate}
                LEFT JOIN dbo.LichLamViec llv ON nv.idNhanVien = llv.idNhanVien 
                    AND llv.ngayLam >= {pStartDate} AND llv.ngayLam < {pEndDate}
                LEFT JOIN dbo.BangChamCong bc ON llv.idLichLamViec = bc.idLichLamViec
                LEFT JOIN dbo.NhatKyHuyMon nkhm ON nv.idNhanVien = nkhm.idNhanVienHuy 
                    AND nkhm.ThoiGianHuy >= {pStartDate} AND nkhm.ThoiGianHuy < {pEndDate}
                WHERE (nv.hoTen LIKE {pSearchText} OR {pSearchText} IS NULL)
                  AND (nv.idVaiTro = {pVaiTroId} OR {pVaiTroId} IS NULL);
            ").ToListAsync()).FirstOrDefault() ?? new BaoCaoHieuSuatKpiDto();
            
            // 2. TAB 1: HIỆU SUẤT BÁN HÀNG
            var salesPerformance = await _context.Database.SqlQuery<BaoCaoSalesDto>($@"
                SELECT
                    nv.hoTen,
                    vt.tenVaiTro,
                    ISNULL(SUM(hd.thanhTien), 0) AS TongDoanhThu,
                    ISNULL(COUNT(DISTINCT hd.idHoaDon), 0) AS SoHoaDon,
                    ISNULL(AVG(hd.thanhTien), 0) AS DoanhThuTrungBinh,
                    (SELECT COUNT(nkhm.idNhatKy) 
                     FROM dbo.NhatKyHuyMon nkhm 
                     WHERE nkhm.idNhanVienHuy = nv.idNhanVien 
                     AND nkhm.ThoiGianHuy >= {pStartDate} AND nkhm.ThoiGianHuy < {pEndDate}) AS SoLanHuyMon
                FROM dbo.NhanVien nv
                JOIN dbo.VaiTro vt ON nv.idVaiTro = vt.idVaiTro
                LEFT JOIN dbo.HoaDon hd ON nv.idNhanVien = hd.idNhanVien 
                    AND hd.trangThai = N'Đã thanh toán' 
                    AND hd.thoiGianThanhToan >= {pStartDate} AND hd.thoiGianThanhToan < {pEndDate}
                WHERE
                    (vt.tenVaiTro IN (N'Thu ngân', N'Phục vụ', N'Quản lý', N'Quản trị viên'))
                    AND (nv.hoTen LIKE {pSearchText} OR {pSearchText} IS NULL)
                    AND (nv.idVaiTro = {pVaiTroId} OR {pVaiTroId} IS NULL)
                GROUP BY nv.idNhanVien, nv.hoTen, vt.tenVaiTro
                ORDER BY TongDoanhThu DESC;
            ").ToListAsync();
            
            // 3. TAB 2: HIỆU SUẤT VẬN HÀNH
            var operationalPerformance = await _context.Database.SqlQuery<BaoCaoOperationsDto>($@"
                SELECT
                    nv.hoTen,
                    vt.tenVaiTro,
                    (SELECT COUNT(idPhieuNhapKho) FROM PhieuNhapKho WHERE idNhanVien = nv.idNhanVien AND ngayNhap >= {pStartDate} AND ngayNhap < {pEndDate}) AS PhieuNhap,
                    (SELECT COUNT(idPhieuKiemKho) FROM PhieuKiemKho WHERE idNhanVienKiem = nv.idNhanVien AND NgayKiem >= {pStartDate} AND NgayKiem < {pEndDate}) AS PhieuKiem,
                    (SELECT COUNT(idPhieuXuatHuy) FROM PhieuXuatHuy WHERE idNhanVienXuat = nv.idNhanVien AND NgayXuatHuy >= {pStartDate} AND NgayXuatHuy < {pEndDate}) AS PhieuHuy,
                    (SELECT COUNT(idDonXinNghi) FROM DonXinNghi WHERE idNguoiDuyet = nv.idNhanVien AND NgayDuyet >= {pStartDate} AND NgayDuyet < {pEndDate}) AS DonDuyet
                FROM dbo.NhanVien nv
                JOIN dbo.VaiTro vt ON nv.idVaiTro = vt.idVaiTro
                WHERE
                    (vt.tenVaiTro IN (N'Quản lý', N'Quản trị viên', N'Pha chế'))
                    AND (nv.hoTen LIKE {pSearchText} OR {pSearchText} IS NULL)
                    AND (nv.idVaiTro = {pVaiTroId} OR {pVaiTroId} IS NULL)
                GROUP BY nv.idNhanVien, nv.hoTen, vt.tenVaiTro;
            ").ToListAsync();

            // 4. TAB 3: CHUYÊN CẦN
            var attendance = await _context.Database.SqlQuery<BaoCaoAttendanceDto>($@"
                SELECT
                    nv.hoTen,
                    ISNULL(COUNT(llv.idLichLamViec), 0) AS TongSoCaLam,
                    ISNULL(SUM(bc.soGioLam), 0) AS TongGioLam,
                    (SELECT COUNT(idDonXinNghi) FROM DonXinNghi WHERE idNhanVien = nv.idNhanVien AND NgayBatDau >= {pStartDate} AND NgayKetThuc < {pEndDate}) AS SoDonXinNghi,
                    (SELECT COUNT(idDonXinNghi) FROM DonXinNghi WHERE idNhanVien = nv.idNhanVien AND TrangThai = N'Đã duyệt' AND NgayBatDau >= {pStartDate} AND NgayKetThuc < {pEndDate}) AS SoDonDaDuyet,
                    (SELECT COUNT(idDonXinNghi) FROM DonXinNghi WHERE idNhanVien = nv.idNhanVien AND TrangThai = N'Chờ duyệt' AND NgayBatDau >= {pStartDate} AND NgayKetThuc < {pEndDate}) AS SoDonChoDuyet
                FROM dbo.NhanVien nv
                LEFT JOIN dbo.LichLamViec llv ON nv.idNhanVien = llv.idNhanVien
                    AND llv.ngayLam >= {pStartDate} AND llv.ngayLam < {pEndDate}
                LEFT JOIN dbo.BangChamCong bc ON llv.idLichLamViec = bc.idLichLamViec
                WHERE (nv.hoTen LIKE {pSearchText} OR {pSearchText} IS NULL)
                  AND (nv.idVaiTro = {pVaiTroId} OR {pVaiTroId} IS NULL)
                GROUP BY nv.idNhanVien, nv.hoTen;
            ").ToListAsync();

            // 5. TỔNG HỢP KẾT QUẢ
            var dto = new BaoCaoHieuSuatTongHopDto
            {
                Kpi = kpi,
                SalesPerformance = salesPerformance,
                OperationalPerformance = operationalPerformance,
                Attendance = attendance
            };

            return Ok(dto);
        }
    }
}
//////////////////////
/// using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Data.SqlClient;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;
using System; // Thêm

namespace CafebookApi.Controllers.App
{
    [Route("api/app/baocaosach")]
    [ApiController]
    public class BaoCaoSachController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public BaoCaoSachController(CafebookDbContext context)
        {
            _context = context;
        }

        [HttpGet("filters")]
        public async Task<IActionResult> GetFilterData()
        {
            var theLoais = await _context.TheLoais
                .Select(t => new FilterLookupDto { Id = t.IdTheLoai, Ten = t.TenTheLoai })
                .OrderBy(t => t.Ten)
                .ToListAsync();

            var tacGias = await _context.TacGias
                .Select(t => new FilterLookupDto { Id = t.IdTacGia, Ten = t.TenTacGia })
                .OrderBy(t => t.Ten)
                .ToListAsync();

            return Ok(new { theLoais, tacGias });
        }

        [HttpPost("report")]
        public async Task<IActionResult> GetSachReport([FromBody] BaoCaoSachRequestDto request)
        {
            // --- SỬA LỖI CS8600 TẠI ĐÂY ---
            // Khởi tạo an toàn hơn
            var pSearchText = new SqlParameter("@SearchText", (object)DBNull.Value);
            if (!string.IsNullOrEmpty(request.SearchText))
            {
                pSearchText.Value = $"%{request.SearchText}%";
            }

            var pTheLoaiId = new SqlParameter("@TheLoaiId", (object)request.TheLoaiId ?? DBNull.Value);
            var pTacGiaId = new SqlParameter("@TacGiaId", (object)request.TacGiaId ?? DBNull.Value);
            // --- KẾT THÚC SỬA LỖI ---

            // 1. TÍNH KPIs (Code này OK)
            var kpi = (await _context.Database.SqlQuery<BaoCaoSachKpiDto>($@"
                SELECT
                    ISNULL(COUNT(DISTINCT idSach), 0) AS TongDauSach,
                    ISNULL(SUM(soLuongTong), 0) AS TongSoLuong,
                    (SELECT ISNULL(COUNT(idSach), 0) FROM dbo.ChiTietPhieuThue WHERE ngayTraThucTe IS NULL) AS DangChoThue,
                    (ISNULL(SUM(soLuongTong), 0) - (SELECT ISNULL(COUNT(idSach), 0) FROM dbo.ChiTietPhieuThue WHERE ngayTraThucTe IS NULL)) AS SanSang
                FROM dbo.Sach;
            ").ToListAsync()).FirstOrDefault() ?? new BaoCaoSachKpiDto();

            // 2. TAB 1: TỒN KHO CHI TIẾT
            var chiTietTonKho = await _context.Database.SqlQuery<BaoCaoSachChiTietDto>($@"
                WITH SachDangThue AS (
                    SELECT idSach, COUNT(idSach) AS SoLuongDangMuon
                    FROM dbo.ChiTietPhieuThue
                    WHERE ngayTraThucTe IS NULL
                    GROUP BY idSach
                )
                SELECT
                    s.tenSach,
                    tg.tenTacGia,
                    tl.tenTheLoai,
                    s.soLuongTong,
                    ISNULL(sdt.SoLuongDangMuon, 0) AS SoLuongDangMuon,
                    (s.soLuongTong - ISNULL(sdt.SoLuongDangMuon, 0)) AS SoLuongConLai
                FROM dbo.Sach s
                LEFT JOIN dbo.TheLoai tl ON s.idTheLoai = tl.idTheLoai
                LEFT JOIN dbo.TacGia tg ON s.idTacGia = tg.idTacGia
                LEFT JOIN SachDangThue sdt ON s.idSach = sdt.idSach
                WHERE
                    (s.tenSach LIKE {pSearchText} OR {pSearchText} IS NULL)
                    AND (s.idTheLoai = {pTheLoaiId} OR {pTheLoaiId} IS NULL)
                    AND (s.idTacGia = {pTacGiaId} OR {pTacGiaId} IS NULL)
                ORDER BY SoLuongConLai ASC, s.tenSach;
            ").ToListAsync();

            // 3. TAB 2: SÁCH TRỄ HẠN (Code này OK)
            var sachTreHan = await _context.Database.SqlQuery<BaoCaoSachTreHanDto>($@"
                SELECT
                    s.tenSach,
                    kh.hoTen,
                    kh.soDienThoai,
                    pts.ngayThue,
                    ctpt.ngayHenTra,
                    CASE
                        WHEN ctpt.ngayHenTra < GETDATE() 
                        THEN N'Trễ ' + CAST(DATEDIFF(DAY, ctpt.ngayHenTra, GETDATE()) AS NVARCHAR) + N' ngày'
                        ELSE N'Đang thuê'
                    END AS TinhTrang
                FROM dbo.ChiTietPhieuThue ctpt
                JOIN dbo.PhieuThueSach pts ON ctpt.idPhieuThueSach = pts.idPhieuThueSach
                JOIN dbo.Sach s ON ctpt.idSach = s.idSach
                JOIN dbo.KhachHang kh ON pts.idKhachHang = kh.idKhachHang
                WHERE ctpt.ngayTraThucTe IS NULL
                ORDER BY ctpt.ngayHenTra ASC;
            ").ToListAsync();

            // 4. TAB 3: TOP SÁCH THUÊ (Code này OK)
            var topSachThue = await _context.Database.SqlQuery<TopSachDuocThueDto>($@"
                SELECT TOP 10
                    s.tenSach,
                    tg.tenTacGia,
                    COUNT(ctpt.idSach) AS TongLuotThue
                FROM dbo.ChiTietPhieuThue ctpt
                JOIN dbo.Sach s ON ctpt.idSach = s.idSach
                LEFT JOIN dbo.TacGia tg ON s.idTacGia = tg.idTacGia
                GROUP BY s.tenSach, tg.tenTacGia
                ORDER BY TongLuotThue DESC;
            ").ToListAsync();

            // 5. TỔNG HỢP KẾT QUẢ (Code này OK)
            var dto = new BaoCaoSachTongHopDto
            {
                Kpi = kpi,
                ChiTietTonKho = chiTietTonKho,
                SachTreHan = sachTreHan,
                TopSachThue = topSachThue
            };

            return Ok(dto);
        }
    }
}
//////////////////////
/// using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Data.SqlClient;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;
using System;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/baocaokho")]
    [ApiController]
    public class BaoCaoTonKhoController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public BaoCaoTonKhoController(CafebookDbContext context)
        {
            _context = context;
        }

        [HttpGet("filters")]
        public async Task<IActionResult> GetFilterData()
        {
            var nhaCungCaps = await _context.NhaCungCaps
                .Select(t => new FilterLookupDto { Id = t.IdNhaCungCap, Ten = t.TenNhaCungCap })
                .OrderBy(t => t.Ten)
                .ToListAsync();

            return Ok(new { nhaCungCaps });
        }

        [HttpPost("report")]
        public async Task<IActionResult> GetKhoReport([FromBody] BaoCaoTonKhoRequestDto request)
        {
            // --- 1. TÍNH KPIs ---

            // KPI a: Tổng giá trị tồn kho (ĐÃ XÓA CÁC THẺ [cite] GÂY LỖI)
            var kpiGiaTriKho = await _context.Database.SqlQuery<decimal>($@"
                WITH GiaVonNguyenLieu AS (
                    SELECT idNguyenLieu, AVG(donGiaNhap) AS GiaVonTrungBinh
                    FROM dbo.ChiTietNhapKho
                    GROUP BY idNguyenLieu
                )
                SELECT ISNULL(SUM(nl.tonKho * ISNULL(gv.GiaVonTrungBinh, 0)), 0)
                FROM dbo.NguyenLieu nl
                LEFT JOIN GiaVonNguyenLieu gv ON nl.idNguyenLieu = gv.idNguyenLieu;
            ").ToListAsync();

            // KPI b: Số lượng SP sắp hết
            var kpiSapHet = await _context.Database.SqlQuery<int>($@"
                SELECT ISNULL(COUNT(idNguyenLieu), 0) FROM NguyenLieu WHERE tonKho <= TonKhoToiThieu;
            ").ToListAsync();

            // KPI c: Tổng giá trị đã hủy (trong kỳ, giả sử 30 ngày)
            var kpiHuyHang = await _context.Database.SqlQuery<decimal>($@"
                SELECT ISNULL(SUM(TongGiaTriHuy), 0) FROM PhieuXuatHuy
                WHERE NgayXuatHuy >= DATEADD(day, -30, GETDATE());
            ").ToListAsync();

            var kpi = new BaoCaoTonKhoKpiDto
            {
                TongGiaTriTonKho = kpiGiaTriKho.FirstOrDefault(),
                SoLuongSPSapHet = kpiSapHet.FirstOrDefault(),
                TongGiaTriDaHuy = kpiHuyHang.FirstOrDefault()
            };

            // --- 2. TAB 1: TỒN KHO CHI TIẾT ---
            var pSearchText = new SqlParameter("@SearchText", string.IsNullOrEmpty(request.SearchText) ? (object)DBNull.Value : $"%{request.SearchText}%");
            var pShowLowStockOnly = new SqlParameter("@ShowLowStockOnly", request.ShowLowStockOnly);
            // (Lưu ý: Lọc theo NCC bị bỏ qua vì logic phức tạp, không có trong thiết kế SQL)

            var chiTietTonKho = await _context.Database.SqlQuery<BaoCaoTonKhoChiTietDto>($@"
                SELECT
                    tenNguyenLieu,
                    donViTinh,
                    tonKho,
                    TonKhoToiThieu,
                    CASE
                        WHEN tonKho = 0 THEN N'Hết hàng'
                        WHEN tonKho <= TonKhoToiThieu THEN N'Sắp hết'
                        ELSE N'Đủ dùng'
                    END AS TinhTrang
                FROM dbo.NguyenLieu
                WHERE
                    (tenNguyenLieu LIKE {pSearchText} OR {pSearchText} IS NULL)
                    AND ({pShowLowStockOnly} = 0 OR tonKho <= TonKhoToiThieu)
                ORDER BY
                    tonKho ASC;
            ").ToListAsync();

            // --- 3. TAB 2: LỊCH SỬ KIỂM KÊ ---
            var lichSuKiemKe = await _context.Database.SqlQuery<BaoCaoKiemKeDto>($@"
                SELECT
                    pkk.NgayKiem,
                    nl.tenNguyenLieu,
                    ctkk.TonKhoHeThong,
                    ctkk.TonKhoThucTe,
                    ctkk.ChenhLech,
                    ctkk.LyDoChenhLech
                FROM dbo.ChiTietKiemKho ctkk
                JOIN dbo.PhieuKiemKho pkk ON ctkk.idPhieuKiemKho = pkk.idPhieuKiemKho
                JOIN dbo.NguyenLieu nl ON ctkk.idNguyenLieu = nl.idNguyenLieu
                WHERE
                    ctkk.ChenhLech != 0
                ORDER BY
                    pkk.NgayKiem DESC;
            ").ToListAsync();

            // --- 4. TAB 3: LỊCH SỬ HỦY HÀNG ---
            var lichSuHuyHang = await _context.Database.SqlQuery<BaoCaoHuyHangDto>($@"
                SELECT
                    pxh.NgayXuatHuy AS NgayHuy,
                    nl.tenNguyenLieu,
                    ctxh.SoLuong AS SoLuongHuy,
                    ctxh.ThanhTien AS GiaTriHuy,
                    pxh.LyDoXuatHuy AS LyDoHuy
                FROM dbo.ChiTietXuatHuy ctxh
                JOIN dbo.PhieuXuatHuy pxh ON ctxh.idPhieuXuatHuy = pxh.idPhieuXuatHuy
                JOIN dbo.NguyenLieu nl ON ctxh.idNguyenLieu = nl.idNguyenLieu
                ORDER BY
                    pxh.NgayXuatHuy DESC;
            ").ToListAsync();

            // --- 5. TỔNG HỢP KẾT QUẢ ---
            var dto = new BaoCaoTonKhoTongHopDto
            {
                Kpi = kpi,
                ChiTietTonKho = chiTietTonKho,
                LichSuKiemKe = lichSuKiemKe,
                LichSuHuyHang = lichSuHuyHang
            };

            return Ok(dto);
        }
    }
}
///////////////////
/// using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using CafebookModel.Model.Entities; // Thêm
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/caidat")]
    [ApiController]
    public class CaiDatController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public CaiDatController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API để lấy tất cả cài đặt
        /// </summary>
        [HttpGet("all")]
        public async Task<IActionResult> GetAllSettings()
        {
            var settings = await _context.CaiDats
                .Select(c => new CaiDatDto
                {
                    TenCaiDat = c.TenCaiDat,
                    GiaTri = c.GiaTri,
                    MoTa = c.MoTa
                })
                .ToListAsync();

            return Ok(settings);
        }

        /// <summary>
        /// API để cập nhật MỘT cài đặt (lưu từng cái một)
        /// </summary>
        [HttpPut("update-single")]
        public async Task<IActionResult> UpdateSingleSetting([FromBody] CaiDatDto settingToSave)
        {
            if (settingToSave == null)
            {
                return BadRequest("Dữ liệu không hợp lệ.");
            }

            try
            {
                var settingInDb = await _context.CaiDats.FindAsync(settingToSave.TenCaiDat);

                if (settingInDb != null)
                {
                    settingInDb.GiaTri = settingToSave.GiaTri; // Chỉ cập nhật giá trị
                    await _context.SaveChangesAsync();
                    return Ok(new { message = "Cập nhật thành công!" });
                }

                return NotFound("Không tìm thấy cài đặt.");
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Lỗi máy chủ: {ex.Message}");
            }
        }
    }
}
////////////////////////
/// using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/dashboard")]
    [ApiController]
    public class DashboardController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public DashboardController(CafebookDbContext context)
        {
            _context = context;
        }

        [HttpGet("summary")]
        public async Task<IActionResult> GetDashboardSummary()
        {
            var dto = new DashboardSummaryDto();

            DateTime today = DateTime.Today;
            DateTime tomorrow = today.AddDays(1);
            DateTime startDate30Days = today.AddDays(-29);

            // 1. Lấy các hóa đơn đã thanh toán hôm nay
            var hoaDonsHomNay = _context.HoaDons
                .Where(h => h.ThoiGianThanhToan >= today &&
                            h.ThoiGianThanhToan < tomorrow &&
                            h.TrangThai == "Đã thanh toán");

            // 2. Tính KPI Thẻ
            dto.TongDoanhThuHomNay = await hoaDonsHomNay.SumAsync(h => h.ThanhTien);
            dto.TongDonHangHomNay = await hoaDonsHomNay.CountAsync();

            // 3. Lấy sản phẩm bán chạy hôm nay
            var spBanChayQuery = await _context.ChiTietHoaDons
                .Where(ct => ct.HoaDon.ThoiGianThanhToan >= today && ct.HoaDon.ThoiGianThanhToan < tomorrow && ct.HoaDon.TrangThai == "Đã thanh toán")
                .GroupBy(ct => ct.IdSanPham)
                .Select(g => new {
                    Id = g.Key,
                    SoLuong = g.Sum(ct => ct.SoLuong)
                })
                .OrderByDescending(x => x.SoLuong)
                .FirstOrDefaultAsync();

            if (spBanChayQuery != null)
            {
                var sanPham = await _context.SanPhams.FindAsync(spBanChayQuery.Id);
                dto.SanPhamBanChayHomNay = sanPham?.TenSanPham ?? "Không rõ";
            }

            // 4. Lấy dữ liệu biểu đồ 30 ngày
            var doanhThuQuery = await _context.HoaDons
                .Where(h => h.ThoiGianThanhToan >= startDate30Days && h.TrangThai == "Đã thanh toán")
                .GroupBy(h => h.ThoiGianThanhToan!.Value.Date) // Group by ngày
                .Select(g => new ChartDataPoint
                {
                    Ngay = g.Key,
                    TongTien = g.Sum(h => h.ThanhTien)
                })
                .OrderBy(dp => dp.Ngay)
                .ToListAsync();

            // Điền vào các ngày bị thiếu (nếu không có doanh thu)
            dto.DoanhThu30Ngay = Enumerable.Range(0, 30)
                .Select(i => startDate30Days.AddDays(i))
                .GroupJoin(doanhThuQuery, // Left join
                           ngay => ngay,
                           data => data.Ngay,
                           (ngay, data) => data.SingleOrDefault(new ChartDataPoint { Ngay = ngay, TongTien = 0 }))
                .ToList();

            return Ok(dto);
        }
    }
}
//////////////
/// using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using CafebookModel.Model.Entities; // Thêm
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;
using System;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/sodoban")]
    [ApiController]
    public class SoDoBanController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public SoDoBanController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API chính: Lấy trạng thái của tất cả các bàn
        /// </summary>
        [HttpGet("tables")]
        public async Task<IActionResult> GetSoDoBan()
        {
            // Dùng LINQ để truy vấn trạng thái và hóa đơn chưa thanh toán
            var data = await _context.Bans
                .AsNoTracking()
                .Select(b => new BanSoDoDto
                {
                    IdBan = b.IdBan,
                    SoBan = b.SoBan,
                    TrangThai = b.TrangThai,
                    GhiChu = b.GhiChu,

                    // Tìm hóa đơn 'Chưa thanh toán' tương ứng
                    IdHoaDonHienTai = _context.HoaDons
                                      .Where(h => h.IdBan == b.IdBan && h.TrangThai == "Chưa thanh toán")
                                      .Select(h => (int?)h.IdHoaDon)
                                      .FirstOrDefault(),

                    TongTienHienTai = _context.HoaDons
                                      .Where(h => h.IdBan == b.IdBan && h.TrangThai == "Chưa thanh toán")
                                      .Select(h => h.ThanhTien) // 'thanhTien' là cột computed
                                      .FirstOrDefault()
                })
                .OrderBy(b => b.SoBan) // Sắp xếp theo tên bàn
                .ToListAsync();

            return Ok(data);
        }

        /// <summary>
        /// API tạo một Hóa đơn mới cho bàn Trống
        /// </summary>
        [HttpPost("createorder/{idBan}/{idNhanVien}")]
        public async Task<IActionResult> CreateOrder(int idBan, int idNhanVien)
        {
            var ban = await _context.Bans.FindAsync(idBan);
            if (ban == null) return NotFound("Không tìm thấy bàn.");
            if (ban.TrangThai != "Trống" && ban.TrangThai != "Đã đặt")
                return Conflict("Bàn này đang bận hoặc đang bảo trì.");

            // Kiểm tra xem nhân viên có tồn tại không
            var nhanVien = await _context.NhanViens.FindAsync(idNhanVien);
            if (nhanVien == null) return NotFound("Nhân viên không hợp lệ.");

            var hoaDon = new HoaDon
            {
                IdBan = idBan,
                IdNhanVien = idNhanVien,
                TrangThai = "Chưa thanh toán",
                LoaiHoaDon = "Tại quán",
                ThoiGianTao = DateTime.Now
            };

            _context.HoaDons.Add(hoaDon);

            // Cập nhật trạng thái bàn
            ban.TrangThai = "Có khách";

            await _context.SaveChangesAsync();

            // Trả về Hóa đơn vừa tạo
            return Ok(new { idHoaDon = hoaDon.IdHoaDon });
        }

        /// <summary>
        /// API báo cáo sự cố (Khóa bàn)
        /// </summary>
        [HttpPost("reportproblem/{idBan}/{idNhanVien}")] // Thêm idNhanVien
        public async Task<IActionResult> BaoCaoSuCo(int idBan, int idNhanVien, [FromBody] BaoCaoSuCoRequestDto request)
        {
            var ban = await _context.Bans.FindAsync(idBan);
            if (ban == null) return NotFound("Không tìm thấy bàn.");

            if (ban.TrangThai == "Có khách")
                return Conflict("Không thể báo cáo sự cố bàn đang có khách.");

            ban.TrangThai = "Bảo trì";
            ban.GhiChu = $"[Sự cố NV báo]: {request.GhiChuSuCo}";

            // --- NÂNG CẤP: TẠO THÔNG BÁO MỚI ---
            var thongBao = new ThongBao
            {
                IdNhanVienTao = idNhanVien,
                NoiDung = $"Bàn {ban.SoBan} vừa được báo cáo sự cố: {request.GhiChuSuCo}",
                LoaiThongBao = "SuCoBan",
                IdLienQuan = idBan,
                ThoiGianTao = DateTime.Now,
                DaXem = false
            };
            _context.ThongBaos.Add(thongBao);
            // --- KẾT THÚC NÂNG CẤP ---

            await _context.SaveChangesAsync();
            return Ok(new { message = "Báo cáo sự cố thành công. Bàn đã được khóa." });
        }
    }
}
/
////////////////////////
/// using CafebookApi.Data;
using CafebookModel.Model.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApi;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq; // Thêm
using System.Threading.Tasks; // Thêm

namespace CafebookApi.Controllers.App
{
    [Route("api/app/taikhoan")]
    [ApiController]
    public class TaiKhoanController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public TaiKhoanController(CafebookDbContext context)
        {
            _context = context;
        }

        [HttpPost("login")]
        public async Task<IActionResult> Login([FromBody] LoginRequestModel model)
        {
            if (model == null || string.IsNullOrEmpty(model.TenDangNhap) || string.IsNullOrEmpty(model.MatKhau))
            {
                return BadRequest(new LoginResponseModel { Success = false, Message = "Tên đăng nhập và mật khẩu không được rỗng." });
            }

            // ---------- BẮT ĐẦU SỬA ĐỔI ----------

            // 1. Lấy thông tin đăng nhập và trim()
            // Biến "userInput" có thể là TenDangNhap, Email, hoặc SoDienThoai
            var userInput = model.TenDangNhap.Trim();
            var passInput = model.MatKhau.Trim();

            // 2. Sửa câu lệnh truy vấn để kiểm tra 3 cột
            var nhanVien = await _context.NhanViens
                .Include(nv => nv.VaiTro)
                    .ThenInclude(vt => vt.VaiTroQuyens)
                    .ThenInclude(vtq => vtq.Quyen)
                .FirstOrDefaultAsync(nv =>
                    // Kiểm tra 1 trong 3 cột này
                    (nv.TenDangNhap == userInput || nv.SoDienThoai == userInput || nv.Email == userInput) &&
                    // VÀ mật khẩu phải khớp
                    (nv.MatKhau == passInput)
                );

            // ---------- KẾT THÚC SỬA ĐỔI ----------

            if (nhanVien == null)
            {
                return Ok(new LoginResponseModel { Success = false, Message = "Sai tên đăng nhập hoặc mật khẩu." });
            }

            if (nhanVien.VaiTro == null)
            {
                return Ok(new LoginResponseModel { Success = false, Message = "Tài khoản không có vai trò." });
            }

            // Tạo DTO để trả về
            var userDto = new NhanVienDto
            {
                IdNhanVien = nhanVien.IdNhanVien,
                HoTen = nhanVien.HoTen,
                AnhDaiDien = nhanVien.AnhDaiDien, // Chuỗi Base64
                TenVaiTro = nhanVien.VaiTro.TenVaiTro,
                DanhSachQuyen = nhanVien.VaiTro.VaiTroQuyens
                                    .Select(vtq => vtq.IdQuyen) // Sửa: Lấy IdQuyen
                                    .ToList()
            };

            // TODO: Tạo JWT Token ở đây nếu cần
            string token = "day_la_jwt_token_tam_thoi";

            return Ok(new LoginResponseModel
            {
                Success = true,
                Message = "Đăng nhập thành công!",
                Token = token,
                UserData = userDto
            });
        }
    }
}
/////////////////////////
/// using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/thongbao")]
    [ApiController]
    public class ThongBaoController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public ThongBaoController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API đếm số thông báo chưa đọc
        /// </summary>
        [HttpGet("unread-count")]
        public async Task<IActionResult> GetUnreadCount()
        {
            var count = await _context.ThongBaos.CountAsync(t => !t.DaXem);
            return Ok(new ThongBaoCountDto { UnreadCount = count });
        }

        /// <summary>
        /// API lấy tất cả thông báo (mới nhất trước)
        /// </summary>
        [HttpGet("all")]
        public async Task<IActionResult> GetAllNotifications()
        {
            var notifications = await _context.ThongBaos
                .Include(t => t.NhanVienTao) // Join để lấy tên NV
                .OrderByDescending(t => t.ThoiGianTao)
                .Take(20) // Chỉ lấy 20 thông báo mới nhất
                .Select(t => new ThongBaoDto
                {
                    IdThongBao = t.IdThongBao,
                    NoiDung = t.NoiDung,
                    ThoiGianTao = t.ThoiGianTao,
                    LoaiThongBao = t.LoaiThongBao,
                    IdLienQuan = t.IdLienQuan,
                    DaXem = t.DaXem,
                    TenNhanVienTao = t.NhanVienTao != null ? t.NhanVienTao.HoTen : "Hệ thống"
                })
                .ToListAsync();

            return Ok(notifications);
        }

        /// <summary>
        /// API đánh dấu 1 thông báo là đã đọc
        /// </summary>
        [HttpPost("mark-as-read/{id}")]
        public async Task<IActionResult> MarkAsRead(int id)
        {
            var thongBao = await _context.ThongBaos.FindAsync(id);
            if (thongBao == null) return NotFound();

            if (!thongBao.DaXem)
            {
                thongBao.DaXem = true;
                await _context.SaveChangesAsync();
            }
            return Ok();
        }
    }
}
////////////////////////
/// using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApi;
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace CafebookApi.Controllers.Web
{
    [Route("api/web/taikhoankhach")]
    [ApiController]
    public class KhachHangTaiKhoanController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public KhachHangTaiKhoanController(CafebookDbContext context)
        {
            _context = context;
        }

        [HttpPost("login")]
        public async Task<IActionResult> Login([FromBody] LoginRequestModel model)
        {
            if (model == null || string.IsNullOrEmpty(model.TenDangNhap) || string.IsNullOrEmpty(model.MatKhau))
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "Thông tin không hợp lệ." });
            }

            var userInput = model.TenDangNhap.Trim();
            var passInput = model.MatKhau.Trim();

            // 1. TÌM KIẾM KHÁCH HÀNG
            var khachHang = await _context.KhachHangs.FirstOrDefaultAsync(k =>
                (k.TenDangNhap == userInput || k.SoDienThoai == userInput || k.Email == userInput) &&
                (k.MatKhau == passInput) // LƯU Ý: Phải HASH mật khẩu trong thực tế
            );

            if (khachHang == null)
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "Sai thông tin đăng nhập hoặc mật khẩu." });
            }

            // 2. TẠO DTO TRẢ VỀ
            var dto = new KhachHangDto
            {
                IdKhachHang = khachHang.IdKhachHang,
                HoTen = khachHang.HoTen,
                Email = khachHang.Email,
                SoDienThoai = khachHang.SoDienThoai,
                TenDangNhap = khachHang.TenDangNhap
            };

            return Ok(new WebLoginResponseModel { Success = true, KhachHangData = dto });
        }
        // THÊM API MỚI CHO ĐĂNG KÝ
        [HttpPost("register")]
        public async Task<IActionResult> Register([FromBody] DangKyRequestModel model)
        {
            if (model == null || string.IsNullOrEmpty(model.HoTen) || string.IsNullOrEmpty(model.Email) || string.IsNullOrEmpty(model.SoDienThoai) || string.IsNullOrEmpty(model.Password))
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "Vui lòng điền đầy đủ thông tin bắt buộc." });
            }

            // KIỂM TRA TRÙNG LẶP
            if (await _context.KhachHangs.AnyAsync(k => k.Email == model.Email))
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "Email này đã được sử dụng." });
            }
            if (await _context.KhachHangs.AnyAsync(k => k.SoDienThoai == model.SoDienThoai))
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "SĐT này đã được sử dụng." });
            }
            if (!string.IsNullOrEmpty(model.TenDangNhap) && await _context.KhachHangs.AnyAsync(k => k.TenDangNhap == model.TenDangNhap))
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "Tên đăng nhập này đã được sử dụng." });
            }

            // TẠO KHÁCH HÀNG MỚI
            var khachHang = new KhachHang // <-- Dùng Entity
            {
                HoTen = model.HoTen,
                Email = model.Email,
                SoDienThoai = model.SoDienThoai,
                TenDangNhap = string.IsNullOrEmpty(model.TenDangNhap) ? null : model.TenDangNhap,
                MatKhau = model.Password, // LƯU Ý: PHẢI HASH MẬT KHẨU
                NgayTao = DateTime.Now,
                DiemTichLuy = 0
            };

            _context.KhachHangs.Add(khachHang);
            await _context.SaveChangesAsync();

            // Trả về thông tin khách hàng (để tự động đăng nhập)
            var dto = new KhachHangDto
            {
                IdKhachHang = khachHang.IdKhachHang,
                HoTen = khachHang.HoTen,
                Email = khachHang.Email,
                SoDienThoai = khachHang.SoDienThoai,
                TenDangNhap = khachHang.TenDangNhap
            };

            return Ok(new WebLoginResponseModel { Success = true, KhachHangData = dto });
        }
    }
}
////////////////////////////
/// using CafebookApi.Data;
using CafebookModel.Model.Data;
using CafebookModel.Model.ModelApi;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace CafebookApi.Controllers.Web
{
    [Route("api/web/taikhoannv")]
    [ApiController]
    public class NhanVienTaiKhoanController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public NhanVienTaiKhoanController(CafebookDbContext context)
        {
            _context = context;
        }

        [HttpPost("login")]
        public async Task<IActionResult> Login([FromBody] LoginRequestModel model)
        {
            if (model == null || string.IsNullOrEmpty(model.TenDangNhap) || string.IsNullOrEmpty(model.MatKhau))
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "Thông tin không hợp lệ." });
            }

            var userInput = model.TenDangNhap.Trim();
            var passInput = model.MatKhau.Trim();

            // 1. TÌM KIẾM NHÂN VIÊN (Tận dụng logic từ API của WPF)
            var nhanVien = await _context.NhanViens
                .Include(nv => nv.VaiTro)
                .ThenInclude(vt => vt.VaiTroQuyens)
                .ThenInclude(vtq => vtq.Quyen)
                .FirstOrDefaultAsync(nv =>
                    (nv.TenDangNhap == userInput || nv.SoDienThoai == userInput || nv.Email == userInput) &&
                    (nv.MatKhau == passInput)
                );

            if (nhanVien == null || nhanVien.VaiTro == null)
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "Sai thông tin đăng nhập hoặc mật khẩu." });
            }

            // 2. TẠO NhanVienDto (Tận dụng DTO của WPF)
            var dto = new NhanVienDto
            {
                IdNhanVien = nhanVien.IdNhanVien,
                HoTen = nhanVien.HoTen,
                AnhDaiDien = nhanVien.AnhDaiDien, // Base64
                TenVaiTro = nhanVien.VaiTro.TenVaiTro,
                DanhSachQuyen = nhanVien.VaiTro.VaiTroQuyens
                                    .Select(vtq => vtq.IdQuyen)
                                    .ToList()
            };

            return Ok(new WebLoginResponseModel { Success = true, NhanVienData = dto });
        }
    }
}
/////////////////////////
/// using CafebookApi.Data;
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace CafebookApi.Controllers.Web
{
    [Route("api/web/trangchu")]
    [ApiController]
    public class TrangChuController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        public TrangChuController(CafebookDbContext context) { _context = context; }

        [HttpGet("data")] // API endpoint
        public async Task<IActionResult> GetTrangChuData()
        {
            // 1. Lấy thông tin chung (từ bảng CaiDat)
            var settings = await _context.CaiDats.ToListAsync();
            var thongTinChung = new ThongTinChungDto
            {
                TenQuan = settings.FirstOrDefault(c => c.TenCaiDat == "TenQuan")?.GiaTri ?? "Cafebook",
                GioiThieu = "Nơi bạn có thể thưởng thức cà phê thơm ngon...",
                DiaChi = settings.FirstOrDefault(c => c.TenCaiDat == "DiaChi")?.GiaTri,
                SoDienThoai = settings.FirstOrDefault(c => c.TenCaiDat == "SoDienThoai")?.GiaTri,
                EmailLienHe = "contact@cafebook.vn",
                GioMoCua = "07:00 - 22:00",
                SoBanTrong = await _context.Bans.CountAsync(b => b.TrangThai == "Trống"),
                SoSachDangDuocThue = await _context.ChiTietPhieuThues.CountAsync(ct => ct.NgayTraThucTe == null)
            };

            // 2. Lấy 3 khuyến mãi mới nhất
            var promotions = await _context.KhuyenMais
                .Where(km => km.NgayKetThuc > DateTime.Now && km.NgayBatDau < DateTime.Now)
                .OrderByDescending(km => km.NgayBatDau)
                .Take(3)
                .Select(km => new KhuyenMaiDto
                {
                    TenKhuyenMai = km.TenChuongTrinh,
                    MoTa = km.MoTa,
                    dieuKienApDung = km.DieuKienApDung
                }).ToListAsync();

            // 3. Lấy 5 món nổi bật
            var monNoiBat = await _context.SanPhams
                .Where(sp => sp.TrangThaiKinhDoanh == true)
                .OrderByDescending(sp => sp.IdSanPham) // Giả lập món mới = nổi bật
                .Take(5)
                .Select(sp => new SanPhamDto
                {
                    TenSanPham = sp.TenSanPham,
                    DonGia = sp.GiaBan,
                    AnhSanPhamBase64 = sp.HinhAnh // Giả sử đây là Base64
                }).ToListAsync();

            // 4. Lấy 4 sách nổi bật
            var sachNoiBat = await _context.Sachs
                .Include(s => s.TacGia) // Join bảng Tác giả
                .OrderByDescending(s => s.SoLuongHienCo)
                .Take(4)
                .Select(s => new SachDto
                {
                    IdSach = s.IdSach,
                    TieuDe = s.TenSach,
                    TacGia = s.TacGia != null ? s.TacGia.TenTacGia : "Không rõ",
                    AnhBia = s.AnhBia // Base64
                }).ToListAsync();

            // 5. Gộp tất cả vào DTO
            var dto = new TrangChuDto
            {
                Info = thongTinChung,
                Promotions = promotions,
                MonNoiBat = monNoiBat,
                SachNoiBat = sachNoiBat
            };

            return Ok(dto);
        }
    }
}
////////////////////////
/// using CafebookModel.Model.Entities;
using Microsoft.EntityFrameworkCore;

namespace CafebookApi.Data
{
    public class CafebookDbContext : DbContext
    {
        public CafebookDbContext(DbContextOptions<CafebookDbContext> options)
            : base(options)
        {
        }

        // --- Khai báo tất cả các Bảng (DbSet) ---
        public DbSet<KhuVuc> KhuVucs { get; set; }
        public DbSet<Ban> Bans { get; set; }
        public DbSet<NguoiGiaoHang> NguoiGiaoHangs { get; set; }
        public DbSet<HoaDon> HoaDons { get; set; }
        public DbSet<DanhMuc> DanhMucs { get; set; }
        public DbSet<SanPham> SanPhams { get; set; }
        public DbSet<ChiTietHoaDon> ChiTietHoaDons { get; set; }
        public DbSet<PhuThu> PhuThus { get; set; }
        public DbSet<ChiTietPhuThuHoaDon> ChiTietPhuThuHoaDons { get; set; }
        public DbSet<NhatKyHuyMon> NhatKyHuyMons { get; set; }
        public DbSet<NguyenLieu> NguyenLieus { get; set; }
        public DbSet<DinhLuong> DinhLuongs { get; set; }
        public DbSet<NhaCungCap> NhaCungCaps { get; set; }
        public DbSet<PhieuNhapKho> PhieuNhapKhos { get; set; }
        public DbSet<ChiTietNhapKho> ChiTietNhapKhos { get; set; }
        public DbSet<PhieuKiemKho> PhieuKiemKhos { get; set; }
        public DbSet<ChiTietKiemKho> ChiTietKiemKhos { get; set; }
        public DbSet<PhieuXuatHuy> PhieuXuatHuys { get; set; }
        public DbSet<ChiTietXuatHuy> ChiTietXuatHuys { get; set; }
        public DbSet<KhachHang> KhachHangs { get; set; }
        public DbSet<PhieuDatBan> PhieuDatBans { get; set; }
        public DbSet<KhuyenMai> KhuyenMais { get; set; }
        public DbSet<HoaDon_KhuyenMai> HoaDonKhuyenMais { get; set; }
        public DbSet<TheLoai> TheLoais { get; set; }
        public DbSet<TacGia> TacGias { get; set; }
        public DbSet<NhaXuatBan> NhaXuatBans { get; set; }
        public DbSet<Sach> Sachs { get; set; }
        public DbSet<PhieuThueSach> PhieuThueSachs { get; set; }
        public DbSet<ChiTietPhieuThue> ChiTietPhieuThues { get; set; }
        public DbSet<VaiTro> VaiTros { get; set; }
        public DbSet<NhanVien> NhanViens { get; set; }
        public DbSet<CaLamViec> CaLamViecs { get; set; }
        public DbSet<LichLamViec> LichLamViecs { get; set; }
        public DbSet<BangChamCong> BangChamCongs { get; set; }
        public DbSet<PhieuLuong> PhieuLuongs { get; set; }
        public DbSet<DonXinNghi> DonXinNghis { get; set; }
        public DbSet<CaiDat> CaiDats { get; set; }
        public DbSet<Quyen> Quyens { get; set; }
        public DbSet<VaiTro_Quyen> VaiTroQuyens { get; set; }
        public DbSet<GiaoDichThanhToan> GiaoDichThanhToans { get; set; }
        public DbSet<ChatLichSu> ChatLichSus { get; set; }
        public DbSet<DeXuatSanPham> DeXuatSanPhams { get; set; }
        public DbSet<DeXuatSach> DeXuatSachs { get; set; }
        public DbSet<ThongBao> ThongBaos { get; set; }

        // --- Cấu hình Khóa (Fluent API) ---
        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);

            // Cấu hình Khóa chính tổng hợp (Composite Primary Keys)
            modelBuilder.Entity<ChiTietPhuThuHoaDon>().HasKey(c => new { c.IdHoaDon, c.IdPhuThu });
            modelBuilder.Entity<DinhLuong>().HasKey(c => new { c.IdSanPham, c.IdNguyenLieu });
            modelBuilder.Entity<ChiTietNhapKho>().HasKey(c => new { c.IdPhieuNhapKho, c.IdNguyenLieu });
            modelBuilder.Entity<ChiTietKiemKho>().HasKey(c => new { c.IdPhieuKiemKho, c.IdNguyenLieu });
            modelBuilder.Entity<ChiTietXuatHuy>().HasKey(c => new { c.IdPhieuXuatHuy, c.IdNguyenLieu });
            modelBuilder.Entity<HoaDon_KhuyenMai>().HasKey(c => new { c.IdHoaDon, c.IdKhuyenMai });
            modelBuilder.Entity<ChiTietPhieuThue>().HasKey(c => new { c.IdPhieuThueSach, c.IdSach });
            modelBuilder.Entity<VaiTro_Quyen>().HasKey(c => new { c.IdVaiTro, c.IdQuyen });
            modelBuilder.Entity<DeXuatSanPham>().HasKey(c => new { c.IdSanPhamGoc, c.IdSanPhamDeXuat, c.LoaiDeXuat });
            modelBuilder.Entity<DeXuatSach>().HasKey(c => new { c.IdSachGoc, c.IdSachDeXuat, c.LoaiDeXuat });

            // Cấu hình Quan hệ đặc biệt (ví dụ: Tự tham chiếu)
            modelBuilder.Entity<DanhMuc>()
                .HasOne(d => d.DanhMucCha)
                .WithMany(d => d.DanhMucCons)
                .HasForeignKey(d => d.IdDanhMucCha)
                .OnDelete(DeleteBehavior.NoAction); // Tránh lỗi self-referencing cascade

            modelBuilder.Entity<DonXinNghi>()
                .HasOne(d => d.NguoiDuyet)
                .WithMany(nv => nv.DonXinNghiNguoiDuyets)
                .HasForeignKey(d => d.IdNguoiDuyet)
                .OnDelete(DeleteBehavior.NoAction);

            // Cấu hình Quan hệ cho DeXuatSanPham
            modelBuilder.Entity<DeXuatSanPham>()
                .HasOne(d => d.SanPhamGoc)
                .WithMany(p => p.DeXuatSanPhamGocs)
                .HasForeignKey(d => d.IdSanPhamGoc)
                .OnDelete(DeleteBehavior.NoAction);

            modelBuilder.Entity<DeXuatSanPham>()
                .HasOne(d => d.SanPhamDeXuat)
                .WithMany(p => p.DeXuatSanPhamDeXuats)
                .HasForeignKey(d => d.IdSanPhamDeXuat)
                .OnDelete(DeleteBehavior.NoAction);

            // Cấu hình Quan hệ cho DeXuatSach
            modelBuilder.Entity<DeXuatSach>()
               .HasOne(d => d.SachGoc)
               .WithMany(p => p.DeXuatSachGocs)
               .HasForeignKey(d => d.IdSachGoc)
               .OnDelete(DeleteBehavior.NoAction);

            modelBuilder.Entity<DeXuatSach>()
                .HasOne(d => d.SachDeXuat)
                .WithMany(p => p.DeXuatSachDeXuats)
                .HasForeignKey(d => d.IdSachDeXuat)
                .OnDelete(DeleteBehavior.NoAction);

            // Tắt ON DELETE CASCADE cho các khóa ngoại gây lỗi (nếu cần)
            // Ví dụ: Bảng NhatKyHuyMon
            modelBuilder.Entity<NhatKyHuyMon>()
                .HasOne(n => n.HoaDon)
                .WithMany(h => h.NhatKyHuyMons)
                .HasForeignKey(n => n.IdHoaDon)
                .OnDelete(DeleteBehavior.NoAction);

            modelBuilder.Entity<NhatKyHuyMon>()
                .HasOne(n => n.NhanVienHuy)
                .WithMany(nv => nv.NhatKyHuyMons)
                .HasForeignKey(n => n.IdNhanVienHuy)
                .OnDelete(DeleteBehavior.NoAction);
        }
    }
}
//////////////////////
/// {
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "CafeBookConnectionString": "Server=localhost\\SQLEXPRESS;Database=CAFEBOOKDB_v2;Integrated Security=True;Encrypt=False;"
  }
}
///////////////////////////////////
/// using CafebookApi.Data; // Thêm
using Microsoft.EntityFrameworkCore; // Thêm

var builder = WebApplication.CreateBuilder(args);

// 1. LẤY CHUỖI KẾT NỐI
var connectionString = builder.Configuration.GetConnectionString("CafeBookConnectionString");

// 2. THÊM DbContext VÀO API
builder.Services.AddDbContext<CafebookDbContext>(options =>
    options.UseSqlServer(connectionString));

// Add services to the container.
builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseAuthorization();

app.MapControllers();

app.Run();
////////////////////////?
/// using System.Collections.Generic;

namespace CafebookModel.Model.Data
{
    // Lớp này chứa thông tin người dùng sẽ được lưu trữ
    // trong WPF app sau khi đăng nhập thành công.
    public class NhanVienDto
    {
        public int IdNhanVien { get; set; }
        public string? HoTen { get; set; }
        public string? TenVaiTro { get; set; }
        public string? AnhDaiDien { get; set; } // Đây là chuỗi Base64
        public List<string> DanhSachQuyen { get; set; } = new List<string>();
    }
}
//////////////////////
/// using System;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace CafebookModel.Model.Entities
{
    [Table("ThongBao")]
    public class ThongBao
    {
        [Key]
        public int IdThongBao { get; set; }

        public int? IdNhanVienTao { get; set; }

        [Required]
        [StringLength(500)]
        public string NoiDung { get; set; } = string.Empty;

        public DateTime ThoiGianTao { get; set; }

        [StringLength(50)]
        public string? LoaiThongBao { get; set; }

        public int? IdLienQuan { get; set; } // Sẽ là idBan

        public bool DaXem { get; set; }

        [ForeignKey("IdNhanVienTao")]
        public virtual NhanVien? NhanVienTao { get; set; }
    }
}
//////////////////////////
/// namespace CafebookModel.Model.ModelApi
{
    public class LoginRequestModel
    {
        public string? TenDangNhap { get; set; }
        public string? MatKhau { get; set; }
    }
}
////////////////////////
/// using CafebookModel.Model.Data;

namespace CafebookModel.Model.ModelApi
{
    public class LoginResponseModel
    {
        public bool Success { get; set; }
        public string Message { get; set; } = string.Empty;
        public string? Token { get; set; }
        public NhanVienDto? UserData { get; set; }
    }
}
///////////////////////
/// using System;
using System.Collections.Generic;

namespace CafebookModel.Model.ModelApp
{
    /// <summary>
    /// DTO cho một bàn (Node con)
    /// </summary>
    public class BanDto
    {
        public int IdBan { get; set; }
        public string SoBan { get; set; } = string.Empty;
        public int SoGhe { get; set; }
        public string TrangThai { get; set; } = string.Empty;
        public string? GhiChu { get; set; }
        public int IdKhuVuc { get; set; }
    }

    /// <summary>
    /// DTO cho một khu vực (Node cha), chứa danh sách các bàn
    /// </summary>
    public class KhuVucDto
    {
        public int IdKhuVuc { get; set; }
        public string TenKhuVuc { get; set; } = string.Empty;
        public string? MoTa { get; set; }
        public List<BanDto> Bans { get; set; } = new List<BanDto>();
    }

    /// <summary>
    /// DTO cho chức năng "Xem Lịch sử" (Advanced Function 3)
    /// </summary>
    public class BanHistoryDto
    {
        public int SoLuotPhucVu { get; set; }
        public decimal TongDoanhThu { get; set; }
        public int SoLuotDatTruoc { get; set; }
    }

    /// <summary>
    /// DTO dùng để gửi dữ liệu CẬP NHẬT/THÊM MỚI Bàn
    /// </summary>
    public class BanUpdateRequestDto
    {
        public string SoBan { get; set; } = string.Empty;
        public int SoGhe { get; set; }
        public int IdKhuVuc { get; set; }
        public string TrangThai { get; set; } = string.Empty;
        public string? GhiChu { get; set; }
    }

    /// <summary>
    /// DTO dùng để gửi dữ liệu CẬP NHẬT/THÊM MỚI Khu Vực
    /// </summary>
    public class KhuVucUpdateRequestDto
    {
        public string TenKhuVuc { get; set; } = string.Empty;
        public string? MoTa { get; set; }
    }
}
////////////////////////
/// using System.Collections.Generic;

namespace CafebookModel.Model.ModelApp
{
    /// <summary>
    /// DTO để gửi yêu cầu (Từ ngày/Đến ngày) lên API
    /// </summary>
    public class BaoCaoRequestDto
    {
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
    }

    /// <summary>
    /// DTO chứa toàn bộ kết quả báo cáo
    /// </summary>
    public class BaoCaoTongHopDto
    {
        public BaoCaoKpiDto Kpi { get; set; } = new();
        public BaoCaoChiTietDoanhThuDto ChiTietDoanhThu { get; set; } = new();
        public BaoCaoChiPhiDto ChiTietChiPhi { get; set; } = new();
        public List<TopSanPhamDto> TopSanPham { get; set; } = new();
    }

    // -- Các lớp con cho báo cáo chi tiết --

    public class BaoCaoKpiDto
    {
        public decimal DoanhThuRong { get; set; }
        public decimal TongGiaVon { get; set; }
        public decimal LoiNhuanGop { get; set; }
        public decimal ChiPhiOpex { get; set; }
        public decimal LoiNhuanRong { get; set; }
    }

    // Kết quả của truy vấn 3.1
    public class BaoCaoChiTietDoanhThuDto
    {
        public decimal TongDoanhThuGoc { get; set; }
        public decimal TongGiamGia { get; set; }
        public decimal TongPhuThu { get; set; }
        public decimal DoanhThuRong { get; set; }
        public int SoLuongHoaDon { get; set; }
        public decimal GiaTriTrungBinhHD { get; set; }
    }

    // Kết quả của truy vấn 3.2b
    public class OpexDto
    {
        public decimal TongChiPhiLuong { get; set; }
        public decimal TongChiPhiHuyHang { get; set; }
    }

    // DTO cho Tab 2
    public class BaoCaoChiPhiDto
    {
        public decimal TongGiaVon_COGS { get; set; }
        public decimal TongChiPhiLuong { get; set; }
        public decimal TongChiPhiHuyHang { get; set; }
    }

    // Kết quả của truy vấn 3.3
    public class TopSanPhamDto
    {
        public string TenSanPham { get; set; } = string.Empty;
        public int TongSoLuongBan { get; set; }
        public decimal TongDoanhThu { get; set; }
    }
}
///////////////////////
/// using System;
using System.Collections.Generic;

namespace CafebookModel.Model.ModelApp
{
    /// <summary>
    /// DTO để gửi yêu cầu lọc (filters) lên API
    /// </summary>
    public class BaoCaoHieuSuatRequestDto
    {
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public int? VaiTroId { get; set; }
        public string? SearchText { get; set; }
    }

    /// <summary>
    /// DTO chứa toàn bộ kết quả báo cáo
    /// </summary>
    public class BaoCaoHieuSuatTongHopDto
    {
        public BaoCaoHieuSuatKpiDto Kpi { get; set; } = new();
        public List<BaoCaoSalesDto> SalesPerformance { get; set; } = new();
        public List<BaoCaoOperationsDto> OperationalPerformance { get; set; } = new();
        public List<BaoCaoAttendanceDto> Attendance { get; set; } = new();
    }

    // -- Các lớp con cho báo cáo chi tiết --

    // Dùng cho KPI
    public class BaoCaoHieuSuatKpiDto
    {
        public decimal TongDoanhThu { get; set; }
        public decimal TongGioLam { get; set; } // SỬA TỪ double -> decimal
        public int TongSoCaLam { get; set; }
        public int TongLanHuyMon { get; set; }
    }

    // Dùng cho Tab 1: Sales
    public class BaoCaoSalesDto
    {
        public string HoTen { get; set; } = string.Empty;
        public string TenVaiTro { get; set; } = string.Empty;
        public decimal TongDoanhThu { get; set; }
        public int SoHoaDon { get; set; }
        public decimal DoanhThuTrungBinh { get; set; }
        public int SoLanHuyMon { get; set; }
    }

    // Dùng cho Tab 2: Operations
    public class BaoCaoOperationsDto
    {
        public string HoTen { get; set; } = string.Empty;
        public string TenVaiTro { get; set; } = string.Empty;
        public int PhieuNhap { get; set; }
        public int PhieuKiem { get; set; }
        public int PhieuHuy { get; set; }
        public int DonDuyet { get; set; }
    }

    // Dùng cho Tab 3: Attendance
    public class BaoCaoAttendanceDto
    {
        public string HoTen { get; set; } = string.Empty;
        public int TongSoCaLam { get; set; }
        public decimal TongGioLam { get; set; } // SỬA TỪ double -> decimal
        public int SoDonXinNghi { get; set; }
        public int SoDonDaDuyet { get; set; }
        public int SoDonChoDuyet { get; set; }
    }
}
///////////////////////
/// using System;
using System.Collections.Generic;

namespace CafebookModel.Model.ModelApp
{
    /// <summary>
    /// DTO để gửi yêu cầu lọc (filters) lên API
    /// </summary>
    public class BaoCaoSachRequestDto
    {
        public string? SearchText { get; set; }
        public int? TheLoaiId { get; set; }
        public int? TacGiaId { get; set; }
    }

    /// <summary>
    /// DTO chứa dữ liệu cho các ComboBox lọc
    /// </summary>
    public class FilterLookupDto
    {
        public int Id { get; set; }
        public string Ten { get; set; } = string.Empty;
    }

    /// <summary>
    /// DTO chứa toàn bộ kết quả báo cáo Sách
    /// </summary>
    public class BaoCaoSachTongHopDto
    {
        public BaoCaoSachKpiDto Kpi { get; set; } = new();
        public List<BaoCaoSachChiTietDto> ChiTietTonKho { get; set; } = new();
        public List<BaoCaoSachTreHanDto> SachTreHan { get; set; } = new();
        public List<TopSachDuocThueDto> TopSachThue { get; set; } = new();
    }

    // -- Các lớp con cho báo cáo chi tiết --

    // Dùng cho KPI
    public class BaoCaoSachKpiDto
    {
        public int TongDauSach { get; set; }
        public int TongSoLuong { get; set; }
        public int DangChoThue { get; set; }
        public int SanSang { get; set; }
    }

    // Dùng cho Tab 1
    public class BaoCaoSachChiTietDto
    {
        public string TenSach { get; set; } = string.Empty;
        public string? TenTacGia { get; set; }
        public string? TenTheLoai { get; set; }
        public int SoLuongTong { get; set; }
        public int SoLuongDangMuon { get; set; }
        public int SoLuongConLai { get; set; }
    }

    // Dùng cho Tab 2
    public class BaoCaoSachTreHanDto
    {
        public string TenSach { get; set; } = string.Empty;
        public string HoTen { get; set; } = string.Empty;
        public string? SoDienThoai { get; set; }
        public DateTime NgayThue { get; set; }
        public DateTime NgayHenTra { get; set; }
        public string TinhTrang { get; set; } = string.Empty;
    }

    // Dùng cho Tab 3
    public class TopSachDuocThueDto
    {
        public string TenSach { get; set; } = string.Empty;
        public string? TenTacGia { get; set; }
        public int TongLuotThue { get; set; }
    }
}
///////////////////////
/// using System;
using System.Collections.Generic;

namespace CafebookModel.Model.ModelApp
{
    /// <summary>
    /// DTO để gửi yêu cầu lọc (filters) lên API
    /// </summary>
    public class BaoCaoTonKhoRequestDto
    {
        public string? SearchText { get; set; }
        public int? NhaCungCapId { get; set; }
        public bool ShowLowStockOnly { get; set; }
    }

    /// <summary>
    /// DTO chứa toàn bộ kết quả báo cáo Kho
    /// </summary>
    public class BaoCaoTonKhoTongHopDto
    {
        public BaoCaoTonKhoKpiDto Kpi { get; set; } = new();
        public List<BaoCaoTonKhoChiTietDto> ChiTietTonKho { get; set; } = new();
        public List<BaoCaoKiemKeDto> LichSuKiemKe { get; set; } = new();
        public List<BaoCaoHuyHangDto> LichSuHuyHang { get; set; } = new();
    }

    // -- Các lớp con cho báo cáo chi tiết --

    // Dùng cho KPI
    public class BaoCaoTonKhoKpiDto
    {
        public decimal TongGiaTriTonKho { get; set; }
        public int SoLuongSPSapHet { get; set; }
        public decimal TongGiaTriDaHuy { get; set; }
    }

    // Dùng cho Tab 1
    public class BaoCaoTonKhoChiTietDto
    {
        public string TenNguyenLieu { get; set; } = string.Empty;
        public string DonViTinh { get; set; } = string.Empty; 
        public decimal TonKho { get; set; }
        public decimal TonKhoToiThieu { get; set; }
        public string TinhTrang { get; set; } = string.Empty;
    }

    // Dùng cho Tab 2
    public class BaoCaoKiemKeDto
    {
        public DateTime NgayKiem { get; set; }
        public string TenNguyenLieu { get; set; } = string.Empty; 
        public decimal TonKhoHeThong { get; set; }
        public decimal TonKhoThucTe { get; set;}
        public decimal ChenhLech { get; set; }
        public string? LyDoChenhLech { get; set; }
    }

    // Dùng cho Tab 3
    public class BaoCaoHuyHangDto
    {
        public DateTime NgayHuy { get; set; }
        public string TenNguyenLieu { get; set; } = string.Empty; 
        public decimal SoLuongHuy { get; set; }
        public decimal GiaTriHuy { get; set; }
        public string LyDoHuy { get; set; } = string.Empty; 
    }
}
//////////////////////
/// namespace CafebookModel.Model.ModelApp
{
    // DTO để truyền dữ liệu từ bảng CaiDat
    public class CaiDatDto
    {
        // Khóa chính
        public string TenCaiDat { get; set; } = string.Empty;

        // Dữ liệu cần sửa
        public string GiaTri { get; set; } = string.Empty;

        // Chỉ để hiển thị
        public string? MoTa { get; set; }
    }
}
////////////////////////
/// using System;

namespace CafebookModel.Model.ModelApp
{
    public class ChartDataPoint
    {
        public DateTime Ngay { get; set; }
        public decimal TongTien { get; set; }
    }
}
///////////////////////////
/// using System.Collections.Generic;

namespace CafebookModel.Model.ModelApp
{
    public class DashboardSummaryDto
    {
        public decimal TongDoanhThuHomNay { get; set; }
        public int TongDonHangHomNay { get; set; }
        public string SanPhamBanChayHomNay { get; set; } = "Chưa có";
        public List<ChartDataPoint> DoanhThu30Ngay { get; set; } = new();
    }
}
//////////////////////////
/// using System.Collections.Generic;

namespace CafebookModel.Model.ModelApp
{
    /// <summary>
    /// DTO để hiển thị một thẻ 'Bàn' trên sơ đồ
    /// </summary>
    public class BanSoDoDto
    {
        public int IdBan { get; set; }
        public string SoBan { get; set; } = string.Empty;
        public string TrangThai { get; set; } = string.Empty; // Trống, Có khách, Đã đặt, Bảo trì
        public string? GhiChu { get; set; }

        // Tổng tiền của hóa đơn 'Chưa thanh toán' (nếu có)
        public decimal TongTienHienTai { get; set; }

        // ID của hóa đơn 'Chưa thanh toán' (nếu có)
        public int? IdHoaDonHienTai { get; set; }
    }

    /// <summary>
    /// DTO dùng để báo cáo sự cố (Khóa bàn)
    /// </summary>
    public class BaoCaoSuCoRequestDto
    {
        public string GhiChuSuCo { get; set; } = string.Empty;
    }

    /// <summary>
    // DTO cho các thao tác phức tạp (Chuyển/Gộp bàn)
    /// </summary>
    public class BanActionRequestDto
    {
        public int IdHoaDonNguon { get; set; } // Hóa đơn/Bàn gốc
        public int IdBanDich { get; set; }     // Bàn chuyển đến
        public int? IdHoaDonDich { get; set; } // Hóa đơn (nếu gộp)
    }
}
/////////////////////////
/// using System;

namespace CafebookModel.Model.ModelApp
{
    public class ThongBaoDto
    {
        public int IdThongBao { get; set; }
        public string NoiDung { get; set; } = string.Empty;
        public DateTime ThoiGianTao { get; set; }
        public string? LoaiThongBao { get; set; }
        public int? IdLienQuan { get; set; } // idBan
        public bool DaXem { get; set; }
        public string? TenNhanVienTao { get; set; }
    }

    public class ThongBaoCountDto
    {
        public int UnreadCount { get; set; }
    }
}
///////////////////////
/// namespace CafebookModel.Model.ModelWeb
{
    public class DangKyRequestModel
    {
        public string HoTen { get; set; } = string.Empty;
        public string SoDienThoai { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string? TenDangNhap { get; set; }
        public string Password { get; set; } = string.Empty;
    }
}
///////////////////////
/// namespace CafebookModel.Model.ModelWeb
{
    public class KhachHangDto
    {
        public int IdKhachHang { get; set; }
        public string HoTen { get; set; } = string.Empty; // <-- SỬA LỖI CS8618
        public string? SoDienThoai { get; set; }
        public string? Email { get; set; }
        public string? TenDangNhap { get; set; }
    }
}
////////////////////////
/// namespace CafebookModel.Model.ModelWeb
{
    // Lớp cha chứa tất cả
    public class TrangChuDto
    {
        public ThongTinChungDto? Info { get; set; }
        public List<KhuyenMaiDto> Promotions { get; set; } = new();
        public List<SanPhamDto> MonNoiBat { get; set; } = new();
        public List<SachDto> SachNoiBat { get; set; } = new();
    }

    // Lớp cho Model.Info
    public class ThongTinChungDto
    {
        public string TenQuan { get; set; } = "Cafebook";
        public string? GioiThieu { get; set; }
        public string? BannerImageUrl { get; set; }
        public int SoBanTrong { get; set; }
        public int SoSachDangDuocThue { get; set; }
        public string? DiaChi { get; set; }
        public string? SoDienThoai { get; set; }
        public string? EmailLienHe { get; set; }
        public string? GioMoCua { get; set; }
    }

    // Lớp cho Model.Promotions
    public class KhuyenMaiDto
    {
        public string TenKhuyenMai { get; set; } = string.Empty;
        public string? MoTa { get; set; }
        public string? dieuKienApDung { get; set; }
    }

    // Lớp cho Model.MonNoiBat
    public class SanPhamDto
    {
        public string TenSanPham { get; set; } = string.Empty;
        public string? AnhSanPhamBase64 { get; set; }
        public decimal DonGia { get; set; }
    }

    // Lớp cho Model.SachNoiBat
    public class SachDto
    {
        public int IdSach { get; set; }
        public string TieuDe { get; set; } = string.Empty;
        public string? TacGia { get; set; }
        public string? AnhBia { get; set; } // Base64
    }
}
//////////////////////
/// using CafebookModel.Model.Data; // Cho NhanVienDto
using CafebookModel.Model.ModelWeb; // Cho KhachHangDto

namespace CafebookModel.Model.ModelApi
{
    public class WebLoginResponseModel
    {
        public bool Success { get; set; }
        public string Message { get; set; } = string.Empty;

        // Dùng một trong hai
        public KhachHangDto? KhachHangData { get; set; }
        public NhanVienDto? NhanVienData { get; set; } // Tận dụng NhanVienDto từ WPF
    }
}
/////////////////////
/// using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace CafebookModel.Model.Entities
{
    [Table("KhuVuc")]
    public class KhuVuc
    {
        [Key]
        public int IdKhuVuc { get; set; }
        [Required]
        [StringLength(100)]
        public string TenKhuVuc { get; set; } = string.Empty;
        [StringLength(500)]
        public string? MoTa { get; set; }

        public virtual ICollection<Ban> Bans { get; set; } = new List<Ban>();
    }

    [Table("Ban")]
    public class Ban
    {
        [Key]
        public int IdBan { get; set; }
        [Required]
        [StringLength(50)]
        public string SoBan { get; set; } = string.Empty;
        public int SoGhe { get; set; }
        [Required]
        [StringLength(50)]
        public string TrangThai { get; set; } = string.Empty;
        [StringLength(500)]
        public string? GhiChu { get; set; }

        public int? IdKhuVuc { get; set; }
        [ForeignKey("IdKhuVuc")]
        public virtual KhuVuc? KhuVuc { get; set; }

        public virtual ICollection<HoaDon> HoaDons { get; set; } = new List<HoaDon>();
        public virtual ICollection<PhieuDatBan> PhieuDatBans { get; set; } = new List<PhieuDatBan>();
    }

    [Table("NguoiGiaoHang")]
    public class NguoiGiaoHang
    {
        [Key]
        public int IdNguoiGiaoHang { get; set; }
        [Required]
        [StringLength(100)]
        public string TenNguoiGiaoHang { get; set; } = string.Empty;
        [Required]
        [StringLength(20)]
        public string SoDienThoai { get; set; } = string.Empty;
        [StringLength(50)]
        public string? TrangThai { get; set; }

        public virtual ICollection<HoaDon> HoaDons { get; set; } = new List<HoaDon>();
    }

    [Table("HoaDon")]
    public class HoaDon
    {
        [Key]
        public int IdHoaDon { get; set; }
        public int? IdBan { get; set; }
        public int IdNhanVien { get; set; }
        public int? IdKhachHang { get; set; }
        public DateTime ThoiGianTao { get; set; }
        public DateTime? ThoiGianThanhToan { get; set; }
        [Required]
        [StringLength(50)]
        public string TrangThai { get; set; } = string.Empty;
        [Column(TypeName = "decimal(18, 2)")]
        public decimal TongTienGoc { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        public decimal GiamGia { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        public decimal TongPhuThu { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        [DatabaseGenerated(DatabaseGeneratedOption.Computed)]
        public decimal ThanhTien { get; set; }
        [StringLength(50)]
        public string? PhuongThucThanhToan { get; set; }
        public string? GhiChu { get; set; }
        [Required]
        [StringLength(50)]
        public string LoaiHoaDon { get; set; } = string.Empty;
        [StringLength(100)]
        public string? TrangThaiGiaoHang { get; set; }
        [StringLength(500)]
        public string? DiaChiGiaoHang { get; set; }
        [StringLength(20)]
        public string? SoDienThoaiGiaoHang { get; set; }
        public int? IdNguoiGiaoHang { get; set; }

        [ForeignKey("IdBan")]
        public virtual Ban? Ban { get; set; }
        [ForeignKey("IdNhanVien")]
        public virtual NhanVien NhanVien { get; set; } = null!;
        [ForeignKey("IdKhachHang")]
        public virtual KhachHang? KhachHang { get; set; }
        [ForeignKey("IdNguoiGiaoHang")]
        public virtual NguoiGiaoHang? NguoiGiaoHang { get; set; }

        public virtual ICollection<ChiTietHoaDon> ChiTietHoaDons { get; set; } = new List<ChiTietHoaDon>();
        public virtual ICollection<NhatKyHuyMon> NhatKyHuyMons { get; set; } = new List<NhatKyHuyMon>();
        public virtual ICollection<GiaoDichThanhToan> GiaoDichThanhToans { get; set; } = new List<GiaoDichThanhToan>();
        public virtual ICollection<ChiTietPhuThuHoaDon> ChiTietPhuThuHoaDons { get; set; } = new List<ChiTietPhuThuHoaDon>();
        public virtual ICollection<HoaDon_KhuyenMai> HoaDonKhuyenMais { get; set; } = new List<HoaDon_KhuyenMai>();
    }

    [Table("DanhMuc")]
    public class DanhMuc
    {
        [Key]
        public int IdDanhMuc { get; set; }
        [Required]
        [StringLength(255)]
        public string TenDanhMuc { get; set; } = string.Empty;
        public int? IdDanhMucCha { get; set; }

        [ForeignKey("IdDanhMucCha")]
        public virtual DanhMuc? DanhMucCha { get; set; }
        public virtual ICollection<DanhMuc> DanhMucCons { get; set; } = new List<DanhMuc>();
        public virtual ICollection<SanPham> SanPhams { get; set; } = new List<SanPham>();
    }

    [Table("SanPham")]
    public class SanPham
    {
        [Key]
        public int IdSanPham { get; set; }
        [Required]
        [StringLength(255)]
        public string TenSanPham { get; set; } = string.Empty;
        public int IdDanhMuc { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        public decimal GiaBan { get; set; }
        public string? MoTa { get; set; }
        public bool TrangThaiKinhDoanh { get; set; }
        public string? HinhAnh { get; set; } // Base64
        [StringLength(50)]
        public string? NhomIn { get; set; }

        [ForeignKey("IdDanhMuc")]
        public virtual DanhMuc DanhMuc { get; set; } = null!;

        public virtual ICollection<ChiTietHoaDon> ChiTietHoaDons { get; set; } = new List<ChiTietHoaDon>();
        public virtual ICollection<NhatKyHuyMon> NhatKyHuyMons { get; set; } = new List<NhatKyHuyMon>();
        public virtual ICollection<DinhLuong> DinhLuongs { get; set; } = new List<DinhLuong>();
        public virtual ICollection<DeXuatSanPham> DeXuatSanPhamGocs { get; set; } = new List<DeXuatSanPham>();
        public virtual ICollection<DeXuatSanPham> DeXuatSanPhamDeXuats { get; set; } = new List<DeXuatSanPham>();
    }

    [Table("ChiTietHoaDon")]
    public class ChiTietHoaDon
    {
        [Key]
        public int IdChiTietHoaDon { get; set; }
        public int IdHoaDon { get; set; }
        public int IdSanPham { get; set; }
        public int SoLuong { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        public decimal DonGia { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        [DatabaseGenerated(DatabaseGeneratedOption.Computed)]
        public decimal ThanhTien { get; set; }
        [StringLength(500)]
        public string? GhiChu { get; set; }

        [ForeignKey("IdHoaDon")]
        public virtual HoaDon HoaDon { get; set; } = null!;
        [ForeignKey("IdSanPham")]
        public virtual SanPham SanPham { get; set; } = null!;
    }

    [Table("PhuThu")]
    public class PhuThu
    {
        [Key]
        public int IdPhuThu { get; set; }
        [Required]
        [StringLength(100)]
        public string TenPhuThu { get; set; } = string.Empty;
        [Column(TypeName = "decimal(18, 2)")]
        public decimal GiaTri { get; set; }
        [Required]
        [StringLength(20)]
        public string LoaiGiaTri { get; set; } = string.Empty;

        public virtual ICollection<ChiTietPhuThuHoaDon> ChiTietPhuThuHoaDons { get; set; } = new List<ChiTietPhuThuHoaDon>();
    }

    [Table("ChiTietPhuThuHoaDon")]
    public class ChiTietPhuThuHoaDon
    {
        public int IdHoaDon { get; set; }
        public int IdPhuThu { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        public decimal SoTien { get; set; }

        [ForeignKey("IdHoaDon")]
        public virtual HoaDon HoaDon { get; set; } = null!;
        [ForeignKey("IdPhuThu")]
        public virtual PhuThu PhuThu { get; set; } = null!;
    }

    [Table("NhatKyHuyMon")]
    public class NhatKyHuyMon
    {
        [Key]
        public int IdNhatKy { get; set; }
        public int IdHoaDon { get; set; }
        public int IdSanPham { get; set; }
        public int SoLuongHuy { get; set; }
        [Required]
        [StringLength(255)]
        public string LyDo { get; set; } = string.Empty;
        public int IdNhanVienHuy { get; set; }
        public DateTime ThoiGianHuy { get; set; }

        [ForeignKey("IdHoaDon")]
        public virtual HoaDon HoaDon { get; set; } = null!;
        [ForeignKey("IdSanPham")]
        public virtual SanPham SanPham { get; set; } = null!;
        [ForeignKey("IdNhanVienHuy")]
        public virtual NhanVien NhanVienHuy { get; set; } = null!;
    }

    [Table("NguyenLieu")]
    public class NguyenLieu
    {
        [Key]
        public int IdNguyenLieu { get; set; }
        [Required]
        [StringLength(255)]
        public string TenNguyenLieu { get; set; } = string.Empty;
        [Required]
        [StringLength(50)]
        public string DonViTinh { get; set; } = string.Empty;
        [Column(TypeName = "decimal(18, 2)")]
        public decimal TonKho { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        public decimal TonKhoToiThieu { get; set; }

        public virtual ICollection<DinhLuong> DinhLuongs { get; set; } = new List<DinhLuong>();
        public virtual ICollection<ChiTietNhapKho> ChiTietNhapKhos { get; set; } = new List<ChiTietNhapKho>();
        public virtual ICollection<ChiTietKiemKho> ChiTietKiemKhos { get; set; } = new List<ChiTietKiemKho>();
        public virtual ICollection<ChiTietXuatHuy> ChiTietXuatHuys { get; set; } = new List<ChiTietXuatHuy>();
    }

    [Table("DinhLuong")]
    public class DinhLuong
    {
        public int IdSanPham { get; set; }
        public int IdNguyenLieu { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        public decimal SoLuong { get; set; }

        [ForeignKey("IdSanPham")]
        public virtual SanPham SanPham { get; set; } = null!;
        [ForeignKey("IdNguyenLieu")]
        public virtual NguyenLieu NguyenLieu { get; set; } = null!;
    }

    [Table("NhaCungCap")]
    public class NhaCungCap
    {
        [Key]
        public int IdNhaCungCap { get; set; }
        [Required]
        [StringLength(255)]
        public string TenNhaCungCap { get; set; } = string.Empty;
        [StringLength(20)]
        public string? SoDienThoai { get; set; }
        [StringLength(500)]
        public string? DiaChi { get; set; }
        [StringLength(100)]
        public string? Email { get; set; }

        public virtual ICollection<PhieuNhapKho> PhieuNhapKhos { get; set; } = new List<PhieuNhapKho>();
    }

    [Table("PhieuNhapKho")]
    public class PhieuNhapKho
    {
        [Key]
        public int IdPhieuNhapKho { get; set; }
        public int? IdNhaCungCap { get; set; }
        public int IdNhanVien { get; set; }
        public DateTime NgayNhap { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        public decimal TongTien { get; set; }
        [StringLength(500)]
        public string? GhiChu { get; set; }
        [Required]
        [StringLength(50)]
        public string TrangThai { get; set; } = string.Empty;

        [ForeignKey("IdNhaCungCap")]
        public virtual NhaCungCap? NhaCungCap { get; set; }
        [ForeignKey("IdNhanVien")]
        public virtual NhanVien NhanVien { get; set; } = null!;

        public virtual ICollection<ChiTietNhapKho> ChiTietNhapKhos { get; set; } = new List<ChiTietNhapKho>();
    }

    [Table("ChiTietNhapKho")]
    public class ChiTietNhapKho
    {
        public int IdPhieuNhapKho { get; set; }
        public int IdNguyenLieu { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        public decimal SoLuongNhap { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        public decimal DonGiaNhap { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        [DatabaseGenerated(DatabaseGeneratedOption.Computed)]
        public decimal ThanhTien { get; set; }

        [ForeignKey("IdPhieuNhapKho")]
        public virtual PhieuNhapKho PhieuNhapKho { get; set; } = null!;
        [ForeignKey("IdNguyenLieu")]
        public virtual NguyenLieu NguyenLieu { get; set; } = null!;
    }

    [Table("PhieuKiemKho")]
    public class PhieuKiemKho
    {
        [Key]
        public int IdPhieuKiemKho { get; set; }
        public int IdNhanVienKiem { get; set; }
        public DateTime NgayKiem { get; set; }
        [StringLength(500)]
        public string? GhiChu { get; set; }
        [Required]
        [StringLength(50)]
        public string TrangThai { get; set; } = string.Empty;

        [ForeignKey("IdNhanVienKiem")]
        public virtual NhanVien NhanVienKiem { get; set; } = null!;

        public virtual ICollection<ChiTietKiemKho> ChiTietKiemKhos { get; set; } = new List<ChiTietKiemKho>();
    }

    [Table("ChiTietKiemKho")]
    public class ChiTietKiemKho
    {
        public int IdPhieuKiemKho { get; set; }
        public int IdNguyenLieu { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        public decimal TonKhoHeThong { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        public decimal TonKhoThucTe { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        [DatabaseGenerated(DatabaseGeneratedOption.Computed)]
        public decimal ChenhLech { get; set; }
        [StringLength(255)]
        public string? LyDoChenhLech { get; set; }

        [ForeignKey("IdPhieuKiemKho")]
        public virtual PhieuKiemKho PhieuKiemKho { get; set; } = null!;
        [ForeignKey("IdNguyenLieu")]
        public virtual NguyenLieu NguyenLieu { get; set; } = null!;
    }

    [Table("PhieuXuatHuy")]
    public class PhieuXuatHuy
    {
        [Key]
        public int IdPhieuXuatHuy { get; set; }
        public int IdNhanVienXuat { get; set; }
        public DateTime NgayXuatHuy { get; set; }
        [Required]
        [StringLength(500)]
        public string LyDoXuatHuy { get; set; } = string.Empty;
        [Column(TypeName = "decimal(18, 2)")]
        public decimal TongGiaTriHuy { get; set; }

        [ForeignKey("IdNhanVienXuat")]
        public virtual NhanVien NhanVienXuat { get; set; } = null!;

        public virtual ICollection<ChiTietXuatHuy> ChiTietXuatHuys { get; set; } = new List<ChiTietXuatHuy>();
    }

    [Table("ChiTietXuatHuy")]
    public class ChiTietXuatHuy
    {
        public int IdPhieuXuatHuy { get; set; }
        public int IdNguyenLieu { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        public decimal SoLuong { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        public decimal DonGiaVon { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        [DatabaseGenerated(DatabaseGeneratedOption.Computed)]
        public decimal ThanhTien { get; set; }

        [ForeignKey("IdPhieuXuatHuy")]
        public virtual PhieuXuatHuy PhieuXuatHuy { get; set; } = null!;
        [ForeignKey("IdNguyenLieu")]
        public virtual NguyenLieu NguyenLieu { get; set; } = null!;
    }

    [Table("KhachHang")]
    public class KhachHang
    {
        [Key]
        public int IdKhachHang { get; set; }
        [Required]
        [StringLength(255)]
        public string HoTen { get; set; } = string.Empty;
        [StringLength(20)]
        public string? SoDienThoai { get; set; }
        [StringLength(100)]
        public string? Email { get; set; }
        [StringLength(500)]
        public string? DiaChi { get; set; }
        public int DiemTichLuy { get; set; }
        [StringLength(100)]
        public string? TenDangNhap { get; set; }
        [StringLength(255)]
        public string? MatKhau { get; set; }
        public DateTime NgayTao { get; set; }

        public virtual ICollection<HoaDon> HoaDons { get; set; } = new List<HoaDon>();
        public virtual ICollection<PhieuDatBan> PhieuDatBans { get; set; } = new List<PhieuDatBan>();
        public virtual ICollection<PhieuThueSach> PhieuThueSachs { get; set; } = new List<PhieuThueSach>();
        public virtual ICollection<ChatLichSu> ChatLichSus { get; set; } = new List<ChatLichSu>();
    }

    [Table("PhieuDatBan")]
    public class PhieuDatBan
    {
        [Key]
        public int IdPhieuDatBan { get; set; }
        public int? IdKhachHang { get; set; }
        public int IdBan { get; set; }
        [StringLength(100)]
        public string? HoTenKhach { get; set; }
        [StringLength(20)]
        public string? SdtKhach { get; set; }
        public DateTime ThoiGianDat { get; set; }
        public int SoLuongKhach { get; set; }
        [Required]
        [StringLength(50)]
        public string TrangThai { get; set; } = string.Empty;
        [StringLength(500)]
        public string? GhiChu { get; set; }

        [ForeignKey("IdKhachHang")]
        public virtual KhachHang? KhachHang { get; set; }
        [ForeignKey("IdBan")]
        public virtual Ban Ban { get; set; } = null!;
    }

    [Table("KhuyenMai")]
    public class KhuyenMai
    {
        [Key]
        public int IdKhuyenMai { get; set; }
        [Required]
        [StringLength(50)]
        public string MaKhuyenMai { get; set; } = string.Empty;
        [Required]
        [StringLength(255)]
        public string TenChuongTrinh { get; set; } = string.Empty;
        public string? MoTa { get; set; }
        [Required]
        [StringLength(20)]
        public string LoaiGiamGia { get; set; } = string.Empty;
        [Column(TypeName = "decimal(18, 2)")]
        public decimal GiaTriGiam { get; set; }
        public DateTime NgayBatDau { get; set; }
        public DateTime NgayKetThuc { get; set; }
        [StringLength(500)]
        public string? DieuKienApDung { get; set; }
        public int? SoLuongConLai { get; set; }

        public virtual ICollection<HoaDon_KhuyenMai> HoaDonKhuyenMais { get; set; } = new List<HoaDon_KhuyenMai>();
    }

    [Table("HoaDon_KhuyenMai")]
    public class HoaDon_KhuyenMai
    {
        public int IdHoaDon { get; set; }
        public int IdKhuyenMai { get; set; }

        [ForeignKey("IdHoaDon")]
        public virtual HoaDon HoaDon { get; set; } = null!;
        [ForeignKey("IdKhuyenMai")]
        public virtual KhuyenMai KhuyenMai { get; set; } = null!;
    }

    [Table("TheLoai")]
    public class TheLoai
    {
        [Key]
        public int IdTheLoai { get; set; }
        [Required]
        [StringLength(255)]
        public string TenTheLoai { get; set; } = string.Empty;

        public virtual ICollection<Sach> Sachs { get; set; } = new List<Sach>();
    }

    [Table("TacGia")]
    public class TacGia
    {
        [Key]
        public int IdTacGia { get; set; }
        [Required]
        [StringLength(255)]
        public string TenTacGia { get; set; } = string.Empty;
        public string? GioiThieu { get; set; }

        public virtual ICollection<Sach> Sachs { get; set; } = new List<Sach>();
    }

    [Table("NhaXuatBan")]
    public class NhaXuatBan
    {
        [Key]
        public int IdNhaXuatBan { get; set; }
        [Required]
        [StringLength(255)]
        public string TenNhaXuatBan { get; set; } = string.Empty;

        public virtual ICollection<Sach> Sachs { get; set; } = new List<Sach>();
    }

    [Table("Sach")]
    public class Sach
    {
        [Key]
        public int IdSach { get; set; }
        [Required]
        [StringLength(500)]
        public string TenSach { get; set; } = string.Empty;
        public int? IdTheLoai { get; set; }
        public int? IdTacGia { get; set; }
        public int? IdNhaXuatBan { get; set; }
        public int? NamXuatBan { get; set; }
        public string? MoTa { get; set; }
        public int SoLuongTong { get; set; }
        public int SoLuongHienCo { get; set; }
        public string? AnhBia { get; set; } // Base64

        [ForeignKey("IdTheLoai")]
        public virtual TheLoai? TheLoai { get; set; }
        [ForeignKey("IdTacGia")]
        public virtual TacGia? TacGia { get; set; }
        [ForeignKey("IdNhaXuatBan")]
        public virtual NhaXuatBan? NhaXuatBan { get; set; }

        public virtual ICollection<ChiTietPhieuThue> ChiTietPhieuThues { get; set; } = new List<ChiTietPhieuThue>();
        public virtual ICollection<DeXuatSach> DeXuatSachGocs { get; set; } = new List<DeXuatSach>();
        public virtual ICollection<DeXuatSach> DeXuatSachDeXuats { get; set; } = new List<DeXuatSach>();
    }

    [Table("PhieuThueSach")]
    public class PhieuThueSach
    {
        [Key]
        public int IdPhieuThueSach { get; set; }
        public int IdKhachHang { get; set; }
        public int IdNhanVien { get; set; }
        public DateTime NgayThue { get; set; }
        [Required]
        [StringLength(50)]
        public string TrangThai { get; set; } = string.Empty;
        [Column(TypeName = "decimal(18, 2)")]
        public decimal TongTienCoc { get; set; }

        [ForeignKey("IdKhachHang")]
        public virtual KhachHang KhachHang { get; set; } = null!;
        [ForeignKey("IdNhanVien")]
        public virtual NhanVien NhanVien { get; set; } = null!;

        public virtual ICollection<ChiTietPhieuThue> ChiTietPhieuThues { get; set; } = new List<ChiTietPhieuThue>();
    }

    [Table("ChiTietPhieuThue")]
    public class ChiTietPhieuThue
    {
        public int IdPhieuThueSach { get; set; }
        public int IdSach { get; set; }
        public DateTime NgayHenTra { get; set; }
        public DateTime? NgayTraThucTe { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        public decimal TienCoc { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        public decimal? TienPhatTraTre { get; set; }

        [ForeignKey("IdPhieuThueSach")]
        public virtual PhieuThueSach PhieuThueSach { get; set; } = null!;
        [ForeignKey("IdSach")]
        public virtual Sach Sach { get; set; } = null!;
    }

    [Table("VaiTro")]
    public class VaiTro
    {
        [Key]
        public int IdVaiTro { get; set; }
        [Required]
        [StringLength(100)]
        public string TenVaiTro { get; set; } = string.Empty;
        [StringLength(500)]
        public string? MoTa { get; set; }

        public virtual ICollection<NhanVien> NhanViens { get; set; } = new List<NhanVien>();
        public virtual ICollection<VaiTro_Quyen> VaiTroQuyens { get; set; } = new List<VaiTro_Quyen>();
    }

    [Table("NhanVien")]
    public class NhanVien
    {
        [Key]
        public int IdNhanVien { get; set; }
        [Required]
        [StringLength(255)]
        public string HoTen { get; set; } = string.Empty;
        [Required]
        [StringLength(20)]
        public string SoDienThoai { get; set; } = string.Empty;
        [StringLength(100)]
        public string? Email { get; set; }
        [StringLength(500)]
        public string? DiaChi { get; set; }
        public DateTime NgayVaoLam { get; set; }
        public int IdVaiTro { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        public decimal LuongCoBan { get; set; }
        [Required]
        [StringLength(50)]
        public string TrangThaiLamViec { get; set; } = string.Empty;
        [Required]
        [StringLength(100)]
        public string TenDangNhap { get; set; } = string.Empty;
        [Required]
        [StringLength(255)]
        public string MatKhau { get; set; } = string.Empty;
        public string? AnhDaiDien { get; set; } // Base64

        [ForeignKey("IdVaiTro")]
        public virtual VaiTro VaiTro { get; set; } = null!;

        public virtual ICollection<HoaDon> HoaDons { get; set; } = new List<HoaDon>();
        public virtual ICollection<NhatKyHuyMon> NhatKyHuyMons { get; set; } = new List<NhatKyHuyMon>();
        public virtual ICollection<PhieuNhapKho> PhieuNhapKhos { get; set; } = new List<PhieuNhapKho>();
        public virtual ICollection<PhieuKiemKho> PhieuKiemKhos { get; set; } = new List<PhieuKiemKho>();
        public virtual ICollection<PhieuXuatHuy> PhieuXuatHuys { get; set; } = new List<PhieuXuatHuy>();
        public virtual ICollection<PhieuThueSach> PhieuThueSachs { get; set; } = new List<PhieuThueSach>();
        public virtual ICollection<LichLamViec> LichLamViecs { get; set; } = new List<LichLamViec>();
        public virtual ICollection<PhieuLuong> PhieuLuongs { get; set; } = new List<PhieuLuong>();
        public virtual ICollection<DonXinNghi> DonXinNghis { get; set; } = new List<DonXinNghi>();
        public virtual ICollection<DonXinNghi> DonXinNghiNguoiDuyets { get; set; } = new List<DonXinNghi>();
        public virtual ICollection<ChatLichSu> ChatLichSus { get; set; } = new List<ChatLichSu>();
    }

    [Table("CaLamViec")]
    public class CaLamViec
    {
        [Key]
        public int IdCa { get; set; }
        [Required]
        [StringLength(100)]
        public string TenCa { get; set; } = string.Empty;
        public TimeSpan GioBatDau { get; set; }
        public TimeSpan GioKetThuc { get; set; }

        public virtual ICollection<LichLamViec> LichLamViecs { get; set; } = new List<LichLamViec>();
    }

    [Table("LichLamViec")]
    public class LichLamViec
    {
        [Key]
        public int IdLichLamViec { get; set; }
        public int IdNhanVien { get; set; }
        public int IdCa { get; set; }
        public DateTime NgayLam { get; set; }

        [ForeignKey("IdNhanVien")]
        public virtual NhanVien NhanVien { get; set; } = null!;
        [ForeignKey("IdCa")]
        public virtual CaLamViec CaLamViec { get; set; } = null!;

        public virtual ICollection<BangChamCong> BangChamCongs { get; set; } = new List<BangChamCong>();
    }

    [Table("BangChamCong")]
    public class BangChamCong
    {
        [Key]
        public int IdChamCong { get; set; }
        public int IdLichLamViec { get; set; }
        public DateTime? GioVao { get; set; }
        public DateTime? GioRa { get; set; }
        [DatabaseGenerated(DatabaseGeneratedOption.Computed)]
        public double? SoGioLam { get; set; }

        [ForeignKey("IdLichLamViec")]
        public virtual LichLamViec LichLamViec { get; set; } = null!;
    }

    [Table("PhieuLuong")]
    public class PhieuLuong
    {
        [Key]
        public int IdPhieuLuong { get; set; }
        public int IdNhanVien { get; set; }
        public int Thang { get; set; }
        public int Nam { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        public decimal LuongCoBan { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        public decimal TongGioLam { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        public decimal TienThuong { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        public decimal KhauTru { get; set; }
        [Column(TypeName = "decimal(18, 2)")]
        public decimal ThucLanh { get; set; }
        public DateTime NgayTao { get; set; }
        [Required]
        [StringLength(50)]
        public string TrangThai { get; set; } = string.Empty;

        [ForeignKey("IdNhanVien")]
        public virtual NhanVien NhanVien { get; set; } = null!;
    }

    [Table("DonXinNghi")]
    public class DonXinNghi
    {
        [Key]
        public int IdDonXinNghi { get; set; }
        public int IdNhanVien { get; set; }
        [Required]
        [StringLength(100)]
        public string LoaiDon { get; set; } = string.Empty;
        [Required]
        [StringLength(500)]
        public string LyDo { get; set; } = string.Empty;
        public DateTime NgayBatDau { get; set; }
        public DateTime NgayKetThuc { get; set; }
        [Required]
        [StringLength(50)]
        public string TrangThai { get; set; } = string.Empty;
        public int? IdNguoiDuyet { get; set; }
        public DateTime? NgayDuyet { get; set; }
        [StringLength(255)]
        public string? GhiChuPheDuyet { get; set; }

        [ForeignKey("IdNhanVien")]
        public virtual NhanVien NhanVien { get; set; } = null!;
        [ForeignKey("IdNguoiDuyet")]
        public virtual NhanVien? NguoiDuyet { get; set; }
    }

    [Table("CaiDat")]
    public class CaiDat
    {
        [Key]
        [StringLength(100)]
        public string TenCaiDat { get; set; } = string.Empty;
        [Required]
        public string GiaTri { get; set; } = string.Empty;
        [StringLength(500)]
        public string? MoTa { get; set; }
    }

    [Table("Quyen")]
    public class Quyen
    {
        [Key]
        [StringLength(100)]
        public string IdQuyen { get; set; } = string.Empty;
        [Required]
        [StringLength(255)]
        public string TenQuyen { get; set; } = string.Empty;
        [Required]
        [StringLength(100)]
        public string NhomQuyen { get; set; } = string.Empty;

        public virtual ICollection<VaiTro_Quyen> VaiTroQuyens { get; set; } = new List<VaiTro_Quyen>();
    }

    [Table("VaiTro_Quyen")]
    public class VaiTro_Quyen
    {
        public int IdVaiTro { get; set; }
        [StringLength(100)]
        public string IdQuyen { get; set; } = string.Empty;

        [ForeignKey("IdVaiTro")]
        public virtual VaiTro VaiTro { get; set; } = null!;
        [ForeignKey("IdQuyen")]
        public virtual Quyen Quyen { get; set; } = null!;
    }

    [Table("GiaoDichThanhToan")]
    public class GiaoDichThanhToan
    {
        [Key]
        public int IdGiaoDich { get; set; }
        public int IdHoaDon { get; set; }
        [Required]
        [StringLength(100)]
        public string MaGiaoDichNgoai { get; set; } = string.Empty;
        [Required]
        [StringLength(50)]
        public string CongThanhToan { get; set; } = string.Empty;
        [Column(TypeName = "decimal(18, 2)")]
        public decimal SoTien { get; set; }
        public DateTime ThoiGianGiaoDich { get; set; }
        [Required]
        [StringLength(100)]
        public string TrangThai { get; set; } = string.Empty;
        [StringLength(50)]
        public string? MaLoi { get; set; }
        [StringLength(500)]
        public string? MoTaLoi { get; set; }

        [ForeignKey("IdHoaDon")]
        public virtual HoaDon HoaDon { get; set; } = null!;
    }

    [Table("ChatLichSu")]
    public class ChatLichSu
    {
        [Key]
        public long IdChat { get; set; }
        public int? IdKhachHang { get; set; }
        public int? IdNhanVien { get; set; }
        [Required]
        public string NoiDungHoi { get; set; } = string.Empty;
        [Required]
        public string NoiDungTraLoi { get; set; } = string.Empty;
        public DateTime ThoiGian { get; set; }
        [StringLength(50)]
        public string? LoaiChat { get; set; }

        [ForeignKey("IdKhachHang")]
        public virtual KhachHang? KhachHang { get; set; }
        [ForeignKey("IdNhanVien")]
        public virtual NhanVien? NhanVien { get; set; }
    }

    [Table("DeXuatSanPham")]
    public class DeXuatSanPham
    {
        public int IdSanPhamGoc { get; set; }
        public int IdSanPhamDeXuat { get; set; }
        public double DoLienQuan { get; set; }
        [Required]
        [StringLength(100)]
        public string LoaiDeXuat { get; set; } = string.Empty;

        [ForeignKey("IdSanPhamGoc")]
        public virtual SanPham SanPhamGoc { get; set; } = null!;
        [ForeignKey("IdSanPhamDeXuat")]
        public virtual SanPham SanPhamDeXuat { get; set; } = null!;
    }

    [Table("DeXuatSach")]
    public class DeXuatSach
    {
        public int IdSachGoc { get; set; }
        public int IdSachDeXuat { get; set; }
        public double DoLienQuan { get; set; }
        [Required]
        [StringLength(100)]
        public string LoaiDeXuat { get; set; } = string.Empty;

        [ForeignKey("IdSachGoc")]
        public virtual Sach SachGoc { get; set; } = null!;
        [ForeignKey("IdSachDeXuat")]
        public virtual Sach SachDeXuat { get; set; } = null!;
    }
}
/////////////////
/// namespace CafebookModel.Utils
{
    // Lớp này chỉ lưu các hằng số đường dẫn, có thể dùng chung cho cả Web và App
    public static class HinhAnhPaths
    {
        public const string DefaultAvatar = "/Assets/Images/default-avatar.png";
        public const string DefaultBookCover = "/Assets/Images/default-book-cover.png";
        public const string DefaultFoodIcon = "/Assets/Images/default-food-icon.png";
    }
}
//////////////////////
/// /*
================================================
 CAFEBOOK WEB THEME (v1.0 - MATERIAL DESIGN)
================================================
Yêu cầu 1: Chủ đề (Theme)
Định nghĩa bảng màu từ thiết kế WPF
*/
:root {
    --cf-brown: #6F4E37; /* PrimaryBrown */
    --cf-dark-brown: #4E342E; /* DarkText / DarkBrown */
    --cf-orange: #D27D2D; /* AccentOrange */
    --cf-cream: #FFF8E1; /* LightCream */
    --cf-white: #FFFFFF;
    --cf-text: #4E342E;
    --cf-gray: #BDBDBD; /* SubtleGray */
    --cf-shadow: rgba(78, 52, 46, 0.15); /* Bóng đổ màu nâu mờ */
    /* Ghi đè màu Bootstrap */
    --bs-primary: var(--cf-brown);
    --bs-secondary: var(--cf-gray);
    --bs-body-bg: var(--cf-cream);
    --bs-body-color: var(--cf-text);
    --bs-link-color: var(--cf-orange);
    --bs-link-hover-color: var(--cf-dark-brown);
}

/*
Yêu cầu 3: Bố cục (Layout)
Áp dụng font chữ, màu nền
*/
html {
    font-size: 16px;
    position: relative;
    min-height: 100%;
}

body {
    font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, Roboto, "Helvetica Neue", Arial, sans-serif;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

.main-container {
    flex-grow: 1; /* Đẩy footer xuống dưới */
}

h1, h2, h3, h4, h5, h6, .navbar-brand, .fw-bold {
    font-weight: 600; /* Nhất quán độ đậm */
    color: var(--cf-dark-brown);
}

/* Header (Navbar) */
.navbar {
    background-color: var(--cf-white) !important;
    box-shadow: 0 4px 12px var(--cf-shadow);
}

.navbar-brand img {
    height: 30px;
    margin-right: 8px;
    transition: transform 0.3s ease;
}

.navbar-brand:hover img {
    transform: rotate(15deg);
}

/* Footer */
.footer {
    background-color: var(--cf-dark-brown);
    color: var(--cf-gray);
    border-top: none;
    padding-top: 1rem;
    padding-bottom: 1rem;
    flex-shrink: 0;
}

.footer-link {
    color: var(--cf-white);
    text-decoration: none;
    margin-left: 1rem;
    transition: color 0.3s ease;
}

    .footer-link:hover {
        color: var(--cf-orange);
    }


/*
Yêu cầu 2 & 4: Hiệu ứng & Biểu tượng (Buttons)
*/
.btn {
    border-radius: 21px; /* Bo tròn như WPF */
    padding: 0.6rem 1.5rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: none;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    box-shadow: 0 2px 4px var(--cf-shadow);
}

.btn-lg {
    padding: 0.8rem 2rem;
    font-size: 1.1rem;
}

.btn-primary {
    background-color: var(--cf-brown);
    color: var(--cf-white);
    border-color: var(--cf-brown);
}

    .btn-primary:hover, .btn-primary:focus {
        background-color: var(--cf-orange);
        color: var(--cf-white);
        border-color: var(--cf-orange);
        transform: translateY(-3px); /* Hiệu ứng hover */
        box-shadow: 0 6px 12px rgba(78, 52, 46, 0.25);
    }

/* Nút phác thảo (ví dụ: 'Khám Phá Sách' trên banner) */
.btn-outline-light {
    border-radius: 21px;
    padding: 0.6rem 1.5rem;
    font-weight: 600;
    transition: all 0.3s ease;
    border-width: 2px;
}

    .btn-outline-light:hover {
        background-color: var(--cf-orange);
        color: var(--cf-white);
        border-color: var(--cf-orange);
        transform: translateY(-3px);
    }

/* Nút phác thảo (ví dụ: 'Xem chi tiết' sách) */
.btn-outline-primary {
    border-radius: 21px;
    color: var(--cf-brown);
    border-color: var(--cf-brown);
}

    .btn-outline-primary:hover {
        background-color: var(--cf-brown);
        color: var(--cf-white);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px var(--cf-shadow);
    }

/* Nút Success (ví dụ: 'Đặt bàn') */
.btn-success {
    background-color: var(--cf-orange);
    border-color: var(--cf-orange);
}

    .btn-success:hover {
        background-color: #a96323; /* Cam đậm hơn */
        border-color: #a96323;
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(78, 52, 46, 0.25);
    }

/*
Yêu cầu 3 & 4: Bố cục (Cards)
*/
.card {
    border: none;
    border-radius: 12px; /* Bo tròn như WPF */
    box-shadow: 0 4px 12px var(--cf-shadow);
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

    .card:hover {
        transform: translateY(-5px); /* Hiệu ứng hover */
        box-shadow: 0 10px 20px rgba(78, 52, 46, 0.2);
    }

.card-title {
    color: var(--cf-dark-brown);
    font-weight: 600;
}

.card-img-top {
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
}

.card-footer {
    background-color: var(--cf-white);
    border-bottom-left-radius: 12px;
    border-bottom-right-radius: 12px;
}

/*
================================================
 THIẾT KẾ TRANG LOGIN/REGISTER
================================================
*/
.login-page-body {
    background-color: var(--cf-cream);
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding-top: 0;
    padding-bottom: 0;
}

.login-wrapper {
    max-width: 850px;
    width: 100%;
    margin: 2rem;
}

.login-container {
    display: flex;
    border-radius: 12px; /* Bo tròn như WPF */
    box-shadow: 0 15px 30px rgba(78, 52, 46, 0.2);
    overflow: hidden; /* Giữ bo tròn cho 2 cột con */
    animation: fadeIn 0.8s ease-out;
}

.login-brand-col {
    background-color: var(--cf-brown); /* Cột màu nâu */
    color: var(--cf-white);
    padding: 4rem;
    width: 320px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
}

    .login-brand-col img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    .login-brand-col h1 {
        color: var(--cf-white);
        font-size: 2.5rem;
        font-weight: 700;
    }

.login-form-col {
    background-color: var(--cf-white); /* Nền form màu trắng */
    padding: 3rem 4rem;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

    .login-form-col h2 {
        color: var(--cf-dark-brown);
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .login-form-col .text-muted {
        margin-bottom: 2.5rem;
    }

/* Material Textbox */
.form-floating-material {
    position: relative;
    margin-bottom: 2rem;
}

    .form-floating-material .form-control {
        background-color: transparent;
        border: none;
        border-radius: 0;
        border-bottom: 1px solid var(--cf-gray);
        /* Thêm padding trái cho icon */
        padding: 0.75rem 0.75rem 0.75rem 2.5rem;
        font-size: 1rem;
        transition: border-color 0.3s ease;
    }

        .form-floating-material .form-control:focus {
            box-shadow: none;
            border-bottom: 2px solid var(--cf-orange);
        }

    .form-floating-material .form-label {
        padding-left: 2.5rem; /* Căn label với icon */
        color: var(--cf-gray);
        transition: all 0.3s ease;
    }

    /* Khi focus hoặc có giá trị */
    .form-floating-material .form-control:focus ~ .form-label,
    .form-floating-material .form-control:not(:placeholder-shown) ~ .form-label {
        color: var(--cf-orange);
        transform: scale(.85) translateY(-.75rem) translateX(-.15rem);
    }


    .form-floating-material .material-symbols-outlined {
        position: absolute;
        top: 0.75rem;
        left: 0.25rem;
        color: var(--cf-gray);
        transition: color 0.3s ease;
    }

    .form-floating-material .form-control:focus ~ .material-symbols-outlined {
        color: var(--cf-orange);
    }

.form-check-input:checked {
    background-color: var(--cf-orange);
    border-color: var(--cf-orange);
}

/* Hiệu ứng mờ dần */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: scale(0.95);
    }

    to {
        opacity: 1;
        transform: scale(1);
    }
}

/* Responsive cho mobile */
@media (max-width: 768px) {
    .login-container {
        flex-direction: column;
    }

    .login-brand-col {
        width: 100%;
        padding: 2rem;
    }

    .login-form-col {
        padding: 2rem;
    }
}
/*
========================================
 STYLES CHO EMPLOYEE (NHÂN VIÊN)
========================================
*/

/* Layout chính */
.employee-body {
    background-color: #f8f9fa; /* Màu nền xám nhạt */
}

.sidebar-nav {
    width: 250px;
    min-height: 100vh;
    padding-top: 15px;
    background-color: var(--cf-dark-brown) !important; /* Dùng màu Nâu Đậm */
}

.sidebar-header {
    padding: 0 1.5rem 1rem 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.sidebar-nav .nav-link {
    color: rgba(255, 255, 255, 0.7);
    font-size: 1.1rem;
    padding: 12px 1.5rem;
    transition: all 0.3s ease;
}

    .sidebar-nav .nav-link i {
        width: 20px;
        margin-right: 12px;
        text-align: center;
    }

    .sidebar-nav .nav-link:hover,
    .sidebar-nav .nav-link.active {
        color: #fff;
        background-color: var(--cf-brown); /* Dùng màu Nâu chính */
    }

.main-content {
    width: calc(100% - 250px);
}

.header-nav {
    background-color: #fff;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

    .header-nav .nav-link {
        padding: 0;
    }

/*
========================================
 STYLES CHO SƠ ĐỒ BÀN (WEB)
========================================
*/
#table-layout-container {
    gap: 20px;
}

.table-card {
    width: 150px;
    height: 130px;
    border-radius: 8px;
    border-top: 5px solid;
    background-color: #fff;
    box-shadow: 0 4px 12px var(--cf-shadow);
    padding: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

    .table-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(78, 52, 46, 0.2);
    }

.table-icon {
    font-size: 24px;
    margin-bottom: 5px;
}

.table-name {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
}

.table-status {
    font-size: 0.9rem;
    color: #757575;
}

.table-price {
    font-size: 1rem;
    font-weight: 700;
    color: var(--cf-orange); /* Màu cam */
    margin-top: 5px;
}

/* Trạng thái */
.table-card.status-trong {
    border-color: #66BB6A;
}

    .table-card.status-trong .table-icon {
        color: #66BB6A;
    }

.table-card.status-co-khach {
    border-color: #EF5350;
}

    .table-card.status-co-khach .table-icon {
        color: #EF5350;
    }

.table-card.status-da-dat {
    border-color: #FFA726;
}

    .table-card.status-da-dat .table-icon {
        color: #FFA726;
    }

.table-card.status-bao-tri {
    border-color: #757575;
    background-color: #f0f0f0;
    cursor: not-allowed;
    opacity: 0.7;
}

    .table-card.status-bao-tri .table-icon {
        color: #757575;
    }

/* Chú thích */
.status-box {
    display: inline-block;
    width: 15px;
    height: 15px;
    border-radius: 3px;
    margin-right: 5px;
    vertical-align: middle;
}

    .status-box.status-trong {
        background-color: #66BB6A;
    }

    .status-box.status-co-khach {
        background-color: #EF5350;
    }

    .status-box.status-da-dat {
        background-color: #FFA726;
    }

    .status-box.status-bao-tri {
        background-color: #757575;
    }
    //////////////////////
    /// // wwwroot/js/profile.js
document.addEventListener('DOMContentLoaded', function () {
    const avatarUploadInput = document.getElementById('avatarUploadInput');
    const avatarPreview = document.getElementById('avatarPreview');
    const avatarSizeError = document.getElementById('avatarSizeError');
    const avatarTypeError = document.getElementById('avatarTypeError');
    const maxSize = 3 * 1024 * 1024; // 3MB in bytes
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];

    if (avatarUploadInput && avatarPreview) {
        avatarUploadInput.addEventListener('change', function (event) {
            avatarSizeError.style.display = 'none'; // Reset errors
            avatarTypeError.style.display = 'none';

            const file = event.target.files[0];
            if (file) {
                // Check size
                if (file.size > maxSize) {
                    avatarSizeError.style.display = 'block';
                    avatarUploadInput.value = ''; // Clear selection
                    avatarPreview.src = avatarPreview.dataset.originalSrc || '/images/default-avatar.png'; // Revert preview
                    return;
                }

                // Check type
                if (!allowedTypes.includes(file.type.toLowerCase())) {
                     avatarTypeError.style.display = 'block';
                     avatarUploadInput.value = ''; // Clear selection
                     avatarPreview.src = avatarPreview.dataset.originalSrc || '/images/default-avatar.png'; // Revert preview
                     return;
                }


                // Show preview
                const reader = new FileReader();
                reader.onload = function (e) {
                    // Store original src if not already stored
                    if (!avatarPreview.dataset.originalSrc) {
                        avatarPreview.dataset.originalSrc = avatarPreview.src;
                    }
                    avatarPreview.src = e.target.result;
                }
                reader.readAsDataURL(file);
            } else {
                 // No file selected, revert preview if needed
                 avatarPreview.src = avatarPreview.dataset.originalSrc || '/images/default-avatar.png';
            }
        });
    }
});
////////////////////////
/// // Please see documentation at https://learn.microsoft.com/aspnet/core/client-side/bundling-and-minification
// for details on configuring this project to bundle and minify static web assets.

// Write your JavaScript code.
// (Mã site.js hiện có của bạn)

// =========================================
// LOGIC SƠ ĐỒ BÀN (NHÂN VIÊN)
// =========================================
$(document).ready(function () {

    // Chỉ chạy code này nếu chúng ta ở đúng trang
    if ($('#table-layout-container').length > 0) {

        const apiBaseUrl = "http://localhost:5166"; // Đảm bảo API này đang chạy

        // Hàm để tải và hiển thị bàn
        function loadSoDoBan() {
            const container = $("#table-layout-container");
            container.html('<div class="text-center w-100 p-5"><div class="spinner-border text-primary" role="status"></div><p>Đang tải...</p></div>');

            $.ajax({
                url: `${apiBaseUrl}/api/app/sodoban/tables`,
                type: 'GET',
                dataType: 'json',
                success: function (tables) {
                    container.empty();
                    if (tables.length === 0) {
                        container.html("<p>Không tìm thấy bàn nào.</p>");
                        return;
                    }

                    tables.forEach(ban => {
                        let statusClass = '';
                        let statusIcon = '';
                        switch (ban.trangThai) {
                            case 'Trống':
                                statusClass = 'status-trong';
                                statusIcon = 'fa-solid fa-check';
                                break;
                            case 'Có khách':
                                statusClass = 'status-co-khach';
                                statusIcon = 'fa-solid fa-users';
                                break;
                            case 'Đã đặt':
                                statusClass = 'status-da-dat';
                                statusIcon = 'fa-solid fa-clock';
                                break;
                            case 'Bảo trì':
                            case 'Tạm ngưng':
                                statusClass = 'status-bao-tri';
                                statusIcon = 'fa-solid fa-triangle-exclamation';
                                break;
                        }

                        let tongTienHtml = ban.trangThai === 'Có khách'
                            ? `<p class="table-price">${ban.tongTienHienTai.toLocaleString('vi-VN')} đ</p>` : '';

                        let tableCardHtml = `
                            <div class="table-card ${statusClass}" data-id-ban="${ban.idBan}" data-id-hoadon="${ban.idHoaDonHienTai}">
                                <div class="table-icon"><i class="${statusIcon}"></i></div>
                                <h5 class="table-name">${ban.soBan}</h5>
                                <p class="table-status">${ban.trangThai}</p>
                                ${tongTienHtml}
                            </div>
                        `;
                        container.append(tableCardHtml);
                    });
                },
                error: function (xhr, status, error) {
                    container.html(`<div class="alert alert-danger w-100">Không thể tải sơ đồ bàn. Đảm bảo API (localhost:5166) đang chạy. Lỗi: ${error}</div>`);
                }
            });
        }

        // Tải lần đầu
        loadSoDoBan();

        // Tự động làm mới mỗi 30 giây
        setInterval(loadSoDoBan, 30000);

        // Click nút làm mới
        $("#refresh-tables-btn").click(function () {
            loadSoDoBan();
        });

        // Click vào một bàn
        $(document).on("click", ".table-card", function () {
            let idBan = $(this).data("id-ban");
            let idHoaDon = $(this).data("id-hoadon");
            alert(`Bạn đã chọn Bàn ID: ${idBan}. Hóa đơn ID (nếu có): ${idHoaDon}`);
            // TODO: Mở modal/trang chi tiết hóa đơn
        });
    }
});
//////////////////////
/// @page "/Account/Register"
@model WebCafebookApi.Pages.Account.DangKyViewModel
@{
    ViewData["Title"] = "Đăng ký";
    Layout = null; // Dùng layout riêng của trang Login
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Cafebook</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body class="login-page-body">

    <div class="login-wrapper">
        <div class="login-container">

            <div class="login-brand-col d-none d-md-flex">
                <img src="/images/logo.png" alt="Cafebook Logo">
                <h1 class="mb-2">Cafebook</h1>
                <p class="fs-5 opacity-75">Tham gia cộng đồng</p>
            </div>

            <div class="login-form-col">

                <h2>@ViewData["Title"]</h2>
                <p class="text-muted">Tạo tài khoản mới để đặt bàn và thuê sách.</p>

                <form id="registerForm" asp-route-returnUrl="@Model.ReturnUrl" method="post">

                    <div asp-validation-summary="ModelOnly" class="text-danger mb-2" role="alert"></div>

                    <div class="form-floating-material">
                        <input asp-for="Input.HoTen" class="form-control" aria-required="true" placeholder=" " />
                        <label asp-for="Input.HoTen"></label>
                        <span class="material-symbols-outlined">badge</span>
                        <span asp-validation-for="Input.HoTen" class="text-danger small"></span>
                    </div>

                    <div class="form-floating-material">
                        <input asp-for="Input.SoDienThoai" class="form-control" autocomplete="tel" aria-required="true" placeholder=" " />
                        <label asp-for="Input.SoDienThoai"></label>
                        <span class="material-symbols-outlined">phone</span>
                        <span asp-validation-for="Input.SoDienThoai" class="text-danger small"></span>
                    </div>

                    <div class="form-floating-material">
                        <input asp-for="Input.Email" class="form-control" autocomplete="email" aria-required="true" placeholder=" " />
                        <label asp-for="Input.Email"></label>
                        <span class="material-symbols-outlined">mail</span>
                        <span asp-validation-for="Input.Email" class="text-danger small"></span>
                    </div>

                    <div class="form-floating-material">
                        <input asp-for="Input.TenDangNhap" class="form-control" autocomplete="username" aria-required="true" placeholder=" " />
                        <label asp-for="Input.TenDangNhap">Tên đăng nhập (Tùy chọn)</label>
                        <span class="material-symbols-outlined">person</span>
                        <span asp-validation-for="Input.TenDangNhap" class="text-danger small"></span>
                    </div>

                    <div class="form-floating-material">
                        <input asp-for="Input.Password" class="form-control" type="password" autocomplete="new-password" aria-required="true" placeholder=" " />
                        <label asp-for="Input.Password"></label>
                        <span class="material-symbols-outlined">lock</span>
                        <span asp-validation-for="Input.Password" class="text-danger small"></span>
                    </div>

                    <div class="form-floating-material">
                        <input asp-for="Input.ConfirmPassword" class="form-control" type="password" autocomplete="new-password" aria-required="true" placeholder=" " />
                        <label asp-for="Input.ConfirmPassword"></label>
                        <span class="material-symbols-outlined">password</span>
                        <span asp-validation-for="Input.ConfirmPassword" class="text-danger small"></span>
                    </div>

                    <div>
                        <button id="registerSubmit" type="submit" class="w-100 btn btn-lg btn-primary">Đăng ký</button>
                    </div>

                    <div class="mt-4 text-center">
                        <p class="text-muted mb-0">
                            Đã có tài khoản?
                            <a asp-page="/account/DangNhapView">Quay lại Đăng nhập</a>
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <partial name="_ValidationScriptsPartial" />
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
//////////////////////////
/// using System.ComponentModel.DataAnnotations;
using System.Security.Claims;
using CafebookModel.Model.ModelApi; // Thêm
using CafebookModel.Model.ModelWeb; // Thêm
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Json; // Thêm

// XÓA CÁC USING LIÊN QUAN ĐẾN DbContext VÀ ENTITIES
// using Microsoft.EntityFrameworkCore;
// using CafebookModel.Model.Entities;

namespace WebCafebookApi.Pages.Account
{
    public class DangKyViewModel : PageModel
    {
        // SỬA LỖI CS0246: Xóa DbContext, dùng HttpClientFactory
        private readonly IHttpClientFactory _httpClientFactory;
        public DangKyViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        // SỬA LỖI CS8618: Khởi tạo Input
        [BindProperty]
        public InputModel Input { get; set; } = new();

        // SỬA LỖI CS8618: Dùng string? và khởi tạo
        public string? ReturnUrl { get; set; }

        public class InputModel
        {
            // SỬA LỖI CS8618: Khởi tạo string
            [Required(ErrorMessage = "Vui lòng nhập họ tên")]
            [Display(Name = "Họ và Tên")]
            public string HoTen { get; set; } = string.Empty;

            [Required(ErrorMessage = "Vui lòng nhập SĐT")]
            [Phone(ErrorMessage = "Số điện thoại không hợp lệ")]
            [Display(Name = "Số điện thoại")]
            public string SoDienThoai { get; set; } = string.Empty;

            [Required(ErrorMessage = "Vui lòng nhập Email")]
            [EmailAddress(ErrorMessage = "Email không hợp lệ")]
            [Display(Name = "Email")]
            public string Email { get; set; } = string.Empty;

            [Display(Name = "Tên đăng nhập")]
            public string? TenDangNhap { get; set; } // Nullable là OK

            [Required(ErrorMessage = "Vui lòng nhập mật khẩu")]
            [StringLength(100, ErrorMessage = "{0} phải dài từ {2} đến {1} ký tự.", MinimumLength = 6)]
            [DataType(DataType.Password)]
            [Display(Name = "Mật khẩu")]
            public string Password { get; set; } = string.Empty;

            [DataType(DataType.Password)]
            [Display(Name = "Xác nhận mật khẩu")]
            [Compare("Password", ErrorMessage = "Mật khẩu và mật khẩu xác nhận không khớp.")]
            public string ConfirmPassword { get; set; } = string.Empty;
        }

        public void OnGet(string? returnUrl = null) // Sửa lỗi CS8625
        {
            ReturnUrl = returnUrl;
        }

        public async Task<IActionResult> OnPostAsync(string? returnUrl = null) // Sửa lỗi CS8625
        {
            returnUrl ??= Url.Content("~/");
            if (!ModelState.IsValid)
            {
                return Page();
            }

            // GỌI API ĐĂNG KÝ
            var httpClient = _httpClientFactory.CreateClient();
            var apiRequest = new DangKyRequestModel
            {
                HoTen = Input.HoTen,
                Email = Input.Email,
                SoDienThoai = Input.SoDienThoai,
                TenDangNhap = Input.TenDangNhap,
                Password = Input.Password
            };

            var response = await httpClient.PostAsJsonAsync("http://localhost:5166/api/web/taikhoankhach/register", apiRequest);

            if (response.IsSuccessStatusCode)
            {
                var apiResponse = await response.Content.ReadFromJsonAsync<WebLoginResponseModel>();

                if (apiResponse != null && apiResponse.Success && apiResponse.KhachHangData != null)
                {
                    // TỰ ĐỘNG ĐĂNG NHẬP SAU KHI ĐĂNG KÝ
                    var user = apiResponse.KhachHangData;
                    var claims = new List<Claim>
                    {
                        new Claim(ClaimTypes.NameIdentifier, user.IdKhachHang.ToString()),
                        new Claim(ClaimTypes.Name, user.TenDangNhap ?? user.Email ?? ""),
                        new Claim(ClaimTypes.GivenName, user.HoTen),
                        new Claim(ClaimTypes.Email, user.Email ?? ""),
                        new Claim(ClaimTypes.MobilePhone, user.SoDienThoai ?? ""),
                        new Claim(ClaimTypes.Role, "KhachHang")
                    };

                    var claimsIdentity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
                    await HttpContext.SignInAsync(
                        CookieAuthenticationDefaults.AuthenticationScheme,
                        new ClaimsPrincipal(claimsIdentity));

                    return LocalRedirect(returnUrl);
                }
                else
                {
                    // Hiển thị lỗi từ API (ví dụ: "Email đã tồn tại")
                    ModelState.AddModelError(string.Empty, apiResponse?.Message ?? "Lỗi đăng ký.");
                    return Page();
                }
            }

            ModelState.AddModelError(string.Empty, "Không thể kết nối máy chủ đăng ký.");
            return Page();
        }
    }
}
////////////////////////
/// @page "/Account/Login"
@model WebCafebookApi.Pages.Account.DangNhapViewModel
@{
    ViewData["Title"] = "Đăng nhập";
    // Chúng ta sẽ không dùng Layout chính cho trang đăng nhập
    Layout = null;
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Cafebook</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body class="login-page-body">

    <div class="login-wrapper">
        <div class="login-container">

            <div class="login-brand-col d-none d-md-flex">
                <img src="/images/logo.png" alt="Cafebook Logo">
                <h1 class="mb-2">Cafebook</h1>
                <p class="fs-5 opacity-75">Awaken your senses</p>
            </div>

            <div class="login-form-col">
                <a asp-page="/TrangChuView" class="text-decoration-none mb-3" style="align-self: flex-start;">
                    <span class="material-symbols-outlined" style="vertical-align: middle;">arrow_back</span>
                    Về Trang Chủ
                </a>

                <h2>@ViewData["Title"]</h2>
                <p class="text-muted">Chào mừng trở lại! Vui lòng nhập thông tin của bạn.</p>

                <form id="account" method="post">

                    <div asp-validation-summary="ModelOnly" class="text-danger mb-2" role="alert"></div>

                    <div class="form-floating-material">
                        <input asp-for="Input.LoginIdentifier" class="form-control" autocomplete="username" aria-required="true" placeholder=" " />
                        <label asp-for="Input.LoginIdentifier" class="form-label">Email, Username hoặc SĐT</label>
                        <span class="material-symbols-outlined">person</span>
                        <span asp-validation-for="Input.LoginIdentifier" class="text-danger small"></span>
                    </div>

                    <div class="form-floating-material">
                        <input asp-for="Input.Password" type="password" class="form-control" autocomplete="current-password" aria-required="true" placeholder=" " />
                        <label asp-for="Input.Password" class="form-label">Mật khẩu</label>
                        <span class="material-symbols-outlined">lock</span>
                        <span asp-validation-for="Input.Password" class="text-danger small"></span>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="form-check">
                            <input class="form-check-input" asp-for="Input.RememberMe" />
                            <label asp-for="Input.RememberMe" class="form-check-label small">
                                @Html.DisplayNameFor(m => m.Input.RememberMe)
                            </label>
                        </div>
                        <a asp-page="/account/QuenMatKhauView" class="small">Quên mật khẩu?</a>
                    </div>

                    <div>
                        <button id="login-submit" type="submit" class="w-100 btn btn-lg btn-primary">Đăng nhập</button>
                    </div>

                    <div class="mt-4 text-center">
                        <p class="text-muted mb-0">
                            Chưa có tài khoản?
                            <a asp-page="/account/DangKyView" asp-route-returnUrl="@Model.ReturnUrl">Đăng ký ngay</a>
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <partial name="_ValidationScriptsPartial" />
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
/////////////////////
/// using System.ComponentModel.DataAnnotations;
using System.Security.Claims;
using CafebookModel.Model.ModelApi; // Thêm
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Json; // Thêm

namespace WebCafebookApi.Pages.Account
{
    public class DangNhapViewModel : PageModel
    {
        // 1. XÓA DbContext, THAY BẰNG HttpClientFactory
        private readonly IHttpClientFactory _httpClientFactory;

        public DangNhapViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        [BindProperty]
        public InputModel Input { get; set; } = new();

        public string? ReturnUrl { get; set; }

        [TempData]
        public string? ErrorMessage { get; set; }

        public class InputModel
        {
            [Required(ErrorMessage = "Vui lòng nhập Tên đăng nhập, Email hoặc SĐT")]
            [Display(Name = "Tên đăng nhập, Email hoặc SĐT")]
            public string LoginIdentifier { get; set; } = string.Empty;

            [Required(ErrorMessage = "Vui lòng nhập Mật khẩu")]
            [DataType(DataType.Password)]
            [Display(Name = "Mật khẩu")]
            public string Password { get; set; } = string.Empty;

            [Display(Name = "Ghi nhớ đăng nhập")]
            public bool RememberMe { get; set; }
        }

        public async Task OnGetAsync(string? returnUrl = null)
        {
            if (!string.IsNullOrEmpty(ErrorMessage))
            {
                ModelState.AddModelError(string.Empty, ErrorMessage);
            }
            returnUrl ??= Url.Content("~/");
            await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
            ReturnUrl = returnUrl;
        }

        public async Task<IActionResult> OnPostAsync(string? returnUrl = null)
        {
            returnUrl ??= Url.Content("~/");
            if (!ModelState.IsValid)
            {
                return Page();
            }

            // 2. TẠO YÊU CẦU GỌI API
            var httpClient = _httpClientFactory.CreateClient();
            var apiRequest = new LoginRequestModel
            {
                TenDangNhap = Input.LoginIdentifier,
                MatKhau = Input.Password
            };

            // Lấy URL của API (giả sử là localhost:5166)
            var response = await httpClient.PostAsJsonAsync("http://localhost:5166/api/web/taikhoankhach/login", apiRequest);

            if (response.IsSuccessStatusCode)
            {
                var apiResponse = await response.Content.ReadFromJsonAsync<WebLoginResponseModel>();

                if (apiResponse != null && apiResponse.Success && apiResponse.KhachHangData != null)
                {
                    // 3. ĐĂNG NHẬP THÀNH CÔNG -> TẠO COOKIE
                    var user = apiResponse.KhachHangData;
                    var claims = new List<Claim>
                    {
                        new Claim(ClaimTypes.NameIdentifier, user.IdKhachHang.ToString()),
                        new Claim(ClaimTypes.Name, user.TenDangNhap ?? user.Email ?? ""),
                        new Claim(ClaimTypes.GivenName, user.HoTen),
                        new Claim(ClaimTypes.Email, user.Email ?? ""),
                        new Claim(ClaimTypes.MobilePhone, user.SoDienThoai ?? ""),
                        new Claim(ClaimTypes.Role, "KhachHang") // Gán Role
                    };

                    var claimsIdentity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
                    var authProperties = new AuthenticationProperties { IsPersistent = Input.RememberMe };

                    await HttpContext.SignInAsync(
                        CookieAuthenticationDefaults.AuthenticationScheme,
                        new ClaimsPrincipal(claimsIdentity),
                        authProperties);

                    // 4. LƯU AVATAR (Mặc định, vì KhachHang không có)
                    HttpContext.Session.SetString("AvatarBase64", "");

                    return LocalRedirect(returnUrl);
                }
                else
                {
                    ModelState.AddModelError(string.Empty, apiResponse?.Message ?? "Lỗi không xác định từ API.");
                    return Page();
                }
            }

            ModelState.AddModelError(string.Empty, "Không thể kết nối đến máy chủ đăng nhập.");
            return Page();
        }
    }
}
////////////////////////////
/// @page
@model WebCafebookApi.Pages.Account.DangXuatModel
@{
    // Trang này không cần hiển thị gì đặc biệt,
    // chỉ cần để PageModel xử lý logic đăng xuất trong OnPost.
    ViewData["Title"] = "Đăng xuất";
}

<header>
    <h1>@ViewData["Title"]</h1>
    <p>Bạn đã đăng xuất thành công.</p>
    @* Có thể thêm nút quay lại trang chủ *@
    <a asp-page="/TrangChuView">Quay lại Trang Chủ</a>
</header>
////////////////////////
/// using System.Threading.Tasks;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;

namespace WebCafebookApi.Pages.Account
{
    public class DangXuatModel : PageModel
    {
        // Sửa lỗi CS8625: string -> string?
        public async Task<IActionResult> OnPostAsync(string? returnUrl = null)
        {
            await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
            HttpContext.Session.Clear();

            if (returnUrl != null)
            {
                return LocalRedirect(returnUrl);
            }
            else
            {
                return RedirectToPage("/TrangChuView");
            }
        }

        public async Task<IActionResult> OnGetAsync(string? returnUrl = null) // Sửa lỗi CS8625
        {
            return await OnPostAsync(returnUrl);
        }
    }
}
/////////////////////////
/// @page
@model WebCafebookApi.Pages.Account.QuenMatKhauViewModel
@{
}

////////////////////////
/// using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;

namespace WebCafebookApi.Pages.Account
{
    public class QuenMatKhauViewModel : PageModel
    {
        public void OnGet()
        {
        }
    }
}

//////////////////////////
/// @using System.Security.Claims
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Quản lý Cafebook</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
</head>
<body class="employee-body">
    <div class="d-flex">
        <nav class="sidebar-nav bg-dark">
            <div class="sidebar-header">
                <a class="navbar-brand text-white fs-4" asp-page="/employee/WebQuanLyView">
                    <i class="fa-solid fa-mug-hot"></i> Cafebook
                </a>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" asp-page="/employee/WebQuanLyView">
                        <i class="fa-solid fa-chart-line"></i> Tổng quan
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" asp-page="/employee/SoDoBanView">
                        <i class="fa-solid fa-border-all"></i> Sơ Đồ Bàn
                    </a>
                </li>
            </ul>
        </nav>

        <div class="main-content flex-grow-1">
            <header class="header-nav shadow-sm">
                <span class="navbar-text">
                    Xin chào, @(User.FindFirstValue(ClaimTypes.GivenName) ?? User.Identity.Name)!
                </span>
                <form method="post" asp-page="/employee/DangXuat">
                    <button type="submit" class="btn btn-link nav-link text-danger">
                        <i class="fa-solid fa-right-from-bracket"></i> Đăng xuất
                    </button>
                </form>
            </header>

            <main role="main" class="p-4">
                @RenderBody()
            </main>
        </div>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
////////////////////
/// @{
    Layout = "_Layout_Employee";
}
////////////////////
/// @page "/Employee/Login"
@model WebCafebookApi.Pages.employee.DangNhapEmployeeModel
@{
    ViewData["Title"] = "Đăng nhập Nhân viên";
    Layout = null; // Dùng layout riêng của trang Login
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Cafebook</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body class="login-page-body">

    <div class="login-wrapper" style="max-width: 450px;">
        <div class="login-container" style="flex-direction: column;">

            <div class="login-form-col">
                <a asp-page="/TrangChuView" class="text-decoration-none mb-3" style="align-self: flex-start;">
                    <span class="material-symbols-outlined" style="vertical-align: middle;">arrow_back</span>
                    Về Trang Chủ
                </a>

                <h2 class="text-center">@ViewData["Title"]</h2>
                <p class="text-muted text-center">Sử dụng tài khoản nội bộ của bạn.</p>

                <form id="account" method="post">

                    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                    {
                        <div class="alert alert-danger" role="alert">@Model.ErrorMessage</div>
                    }
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-2" role="alert"></div>

                    <div class="form-floating-material">
                        <input asp-for="Input.TenDangNhap" class="form-control" autocomplete="username" aria-required="true" placeholder=" " />
                        <label asp-for="Input.TenDangNhap">Tài khoản (Username, Email hoặc SĐT)</label>
                        <span class="material-symbols-outlined">shield_person</span>
                        <span asp-validation-for="Input.TenDangNhap" class="text-danger small"></span>
                    </div>

                    <div class="form-floating-material">
                        <input asp-for="Input.MatKhau" type="password" class="form-control" autocomplete="current-password" aria-required="true" placeholder=" " />
                        <label asp-for="Input.MatKhau">Mật khẩu</label>
                        <span class="material-symbols-outlined">lock</span>
                        <span asp-validation-for="Input.MatKhau" class="text-danger small"></span>
                    </div>

                    <div>
                        <button id="login-submit" type="submit" class="w-100 btn btn-lg btn-primary">Đăng nhập</button>
                    </div>

                </form>
            </div>
        </div>
    </div>

    <partial name="_ValidationScriptsPartial" />
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
///////////////////
/// using System.ComponentModel.DataAnnotations;
using System.Security.Claims;
using CafebookModel.Model.ModelApi; // Thêm
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Json; // Thêm

namespace WebCafebookApi.Pages.employee
{
    public class DangNhapEmployeeModel : PageModel
    {
        // 1. XÓA DbContext, THAY BẰNG HttpClientFactory
        private readonly IHttpClientFactory _httpClientFactory;

        public DangNhapEmployeeModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        [BindProperty]
        public InputModel Input { get; set; } = new();

        [TempData]
        public string? ErrorMessage { get; set; }

        public class InputModel
        {
            [Required(ErrorMessage = "Vui lòng nhập tài khoản")]
            public string TenDangNhap { get; set; } = string.Empty;

            [Required(ErrorMessage = "Vui lòng nhập mật khẩu")]
            [DataType(DataType.Password)]
            public string MatKhau { get; set; } = string.Empty;
        }

        public async Task OnGetAsync()
        {
            await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
        }

        public async Task<IActionResult> OnPostAsync()
        {
            if (!ModelState.IsValid)
            {
                return Page();
            }

            // 2. TẠO YÊU CẦU GỌI API
            var httpClient = _httpClientFactory.CreateClient();
            var apiRequest = new LoginRequestModel
            {
                TenDangNhap = Input.TenDangNhap,
                MatKhau = Input.MatKhau
            };

            var response = await httpClient.PostAsJsonAsync("http://localhost:5166/api/web/taikhoannv/login", apiRequest);

            if (response.IsSuccessStatusCode)
            {
                var apiResponse = await response.Content.ReadFromJsonAsync<WebLoginResponseModel>();

                if (apiResponse != null && apiResponse.Success && apiResponse.NhanVienData != null)
                {
                    // 3. ĐĂNG NHẬP THÀNH CÔNG -> TẠO COOKIE
                    var user = apiResponse.NhanVienData;
                    var claims = new List<Claim>
                    {
                        new Claim(ClaimTypes.NameIdentifier, user.IdNhanVien.ToString()),
                        new Claim(ClaimTypes.Name, user.HoTen ?? ""),
                        new Claim(ClaimTypes.GivenName, user.HoTen ?? ""),
                        new Claim(ClaimTypes.Role, user.TenVaiTro ?? "NhanVien")
                    };

                    // Thêm các quyền chi tiết
                    foreach (var quyen in user.DanhSachQuyen)
                    {
                        claims.Add(new Claim("Permission", quyen));
                    }

                    var claimsIdentity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
                    var authProperties = new AuthenticationProperties { ExpiresUtc = DateTimeOffset.UtcNow.AddHours(8) };

                    await HttpContext.SignInAsync(
                        CookieAuthenticationDefaults.AuthenticationScheme,
                        new ClaimsPrincipal(claimsIdentity),
                        authProperties);

                    // 4. LƯU AVATAR VÀO SESSION
                    HttpContext.Session.SetString("AvatarBase64", user.AnhDaiDien ?? "");

                    return LocalRedirect(Url.Content("~/Employee/WebQuanLyView"));
                }
                else
                {
                    ErrorMessage = apiResponse?.Message ?? "Lỗi không xác định từ API.";
                    return Page();
                }
            }

            ErrorMessage = "Không thể kết nối đến máy chủ đăng nhập.";
            return Page();
        }
    }
}
////////////////////
/// @page "/Employee/Logout"
@model WebCafebookApi.Pages.employee.DangXuatModel
@{
    ViewData["Title"] = "Đăng xuất";
}
<p>Đang đăng xuất...</p>
//////////////////////
/// using System.Threading.Tasks;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;

namespace WebCafebookApi.Pages.employee
{
    public class DangXuatModel : PageModel
    {
        // OnPost được gọi từ form trong _Layout_Employee
        public async Task<IActionResult> OnPostAsync()
        {
            // Xóa cookie đăng nhập
            await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);

            // Xóa session (nếu có)
            HttpContext.Session.Clear();

            // Quay về trang đăng nhập của Nhân viên
            return RedirectToPage("/Employee/DangNhapEmployee");
        }

        // Nếu người dùng truy cập bằng GET, cũng đăng xuất
        public async Task<IActionResult> OnGetAsync()
        {
            return await OnPostAsync();
        }
    }
}
////////////////////////
/// @page "/Employee/SoDoBan"
@model WebCafebookApi.Pages.employee.SoDoBanViewModel
@{
    ViewData["Title"] = "Sơ Đồ Bàn";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 text-gray-800">@ViewData["Title"]</h1>
    <button id="refresh-tables-btn" class="btn btn-primary">
        <i class="fa-solid fa-sync"></i> Làm mới
    </button>
</div>

<div class="d-flex justify-content-start mb-3">
    <div class="me-3"><span class="status-box status-trong"></span> Trống</div>
    <div class="me-3"><span class="status-box status-co-khach"></span> Có khách</div>
    <div class="me-3"><span class="status-box status-da-dat"></span> Đã đặt</div>
    <div class="me-3"><span class="status-box status-bao-tri"></span> Bảo trì</div>
</div>

<div id="table-layout-container" class="d-flex flex-wrap">
    <div class="text-center w-100 p-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Đang tải...</span>
        </div>
        <p>Đang tải sơ đồ bàn...</p>
    </div>
</div>

@section Scripts {
    <script>
        // URL của API (đảm bảo CafebookApi đang chạy)
        const apiBaseUrl = "http://localhost:5166";

        // Hàm để tải và hiển thị bàn
        function loadSoDoBan() {
            const container = $("#table-layout-container");
            container.html('<div class="text-center w-100 p-5"><div class="spinner-border text-primary" role="status"></div><p>Đang tải...</p></div>'); // Hiển thị loading

            $.ajax({
                url: `${apiBaseUrl}/api/app/sodoban/tables`,
                type: 'GET',
                dataType: 'json',
                success: function (tables) {
                    container.empty(); // Xóa loading
                    if (tables.length === 0) {
                        container.html("<p>Không tìm thấy bàn nào.</p>");
                        return;
                    }

                    // Lặp qua dữ liệu và tạo HTML
                    tables.forEach(ban => {
                        let statusClass = '';
                        let statusIcon = '';
                        switch (ban.trangThai) {
                            case 'Trống':
                                statusClass = 'status-trong';
                                statusIcon = 'fa-solid fa-check';
                                break;
                            case 'Có khách':
                                statusClass = 'status-co-khach';
                                statusIcon = 'fa-solid fa-users';
                                break;
                            case 'Đã đặt':
                                statusClass = 'status-da-dat';
                                statusIcon = 'fa-solid fa-clock';
                                break;
                            case 'Bảo trì':
                            case 'Tạm ngưng':
                                statusClass = 'status-bao-tri';
                                statusIcon = 'fa-solid fa-triangle-exclamation';
                                break;
                        }

                        let tongTienHtml = ban.trangThai === 'Có khách'
                            ? `<p class="table-price">${ban.tongTienHienTai.toLocaleString('vi-VN')} đ</p>` : '';

                        let tableCardHtml = `
                            <div class="table-card ${statusClass}" data-id-ban="${ban.idBan}" data-id-hoadon="${ban.idHoaDonHienTai}">
                                <div class="table-icon"><i class="${statusIcon}"></i></div>
                                <h5 class="table-name">${ban.soBan}</h5>
                                <p class="table-status">${ban.trangThai}</p>
                                ${tongTienHtml}
                            </div>
                        `;
                        container.append(tableCardHtml);
                    });
                },
                error: function (xhr, status, error) {
                    container.html(`<div class="alert alert-danger w-100">Không thể tải sơ đồ bàn. Đảm bảo API (localhost:5166) đang chạy. Lỗi: ${error}</div>`);
                }
            });
        }

        // Chạy khi trang tải xong
        $(document).ready(function () {
            loadSoDoBan();

            // Tự động làm mới mỗi 30 giây
            setInterval(loadSoDoBan, 30000);

            // Click nút làm mới
            $("#refresh-tables-btn").click(function() {
                loadSoDoBan();
            });

            // (Logic Click vào bàn - sẽ được thêm sau)
            $(document).on("click", ".table-card", function() {
                let idBan = $(this).data("id-ban");
                let idHoaDon = $(this).data("id-hoadon");
                alert(`Bạn đã chọn Bàn ID: ${idBan}. Hóa đơn ID (nếu có): ${idHoaDon}`);
                // TODO: Mở modal/trang chi tiết hóa đơn
            });
        });
    </script>
}
///////////////////////
/// using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;

namespace WebCafebookApi.Pages.employee
{
    public class SoDoBanViewModel : PageModel
    {
        public void OnGet()
        {
        }
    }
}

///////////////////////
/// @page "/Employee/Dashboard"
@model WebCafebookApi.Pages.employee.WebQuanLyViewModel
@{
    ViewData["Title"] = "Tổng quan";
}

<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">@ViewData["Title"]</h1>
    <p>Chào mừng đến với trang quản lý nhân viên.</p>

</div>
///////////////////////
/// using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;

namespace WebCafebookApi.Pages.employee
{
    public class WebQuanLyViewModel : PageModel
    {
        public void OnGet()
        {
        }
    }
}
////////////////////////
/// @using System.Security.Claims
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Cafebook</title>

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />

    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

    @await RenderSectionAsync("Styles", required: false)
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-white border-bottom box-shadow-sm mb-3">
            <div class="container">
                <a class="navbar-brand" asp-page="/Index">
                    <img src="/images/logo.png" alt="Cafebook Logo" style="height: 30px; margin-right: 8px;">
                    Cafebook
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target=".navbar-collapse" aria-controls="navbarSupportedContent"
                        aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="navbar-collapse collapse d-sm-inline-flex justify-content-between">
                    <ul class="navbar-nav flex-grow-1">
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-page="/Index">Trang Chủ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-page="/ThucDonView">Thực Đơn</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-page="/ThuVienSachView">Thư Viện Sách</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-page="/DatBanView">Đặt Bàn</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-page="/LienHeView">Liên Hệ</a>
                        </li>
                    </ul>

                    <partial name="_LoginPartial" />

                </div>
            </div>
        </nav>
    </header>

    <div class="main-container">
        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>

    <footer class="footer text-muted mt-5">
        <div class="container d-flex justify-content-between align-items-center py-4">
            <div>
                &copy; @DateTime.Now.Year - Cafebook
                <a class="footer-link" asp-page="/LienHeView">Liên Hệ</a>
                <a class="footer-link" asp-page="/Privacy">Chính sách</a>
            </div>
            <div>
                <a class="footer-link" asp-page="/Employee/DangNhapEmployee">Đăng nhập nhân viên</a>
            </div>
        </div>
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
///////////////////////
/// /* Please see documentation at https://learn.microsoft.com/aspnet/core/client-side/bundling-and-minification
for details on configuring this project to bundle and minify static web assets. */

a.navbar-brand {
  white-space: normal;
  text-align: center;
  word-break: break-all;
}

a {
  color: #0077cc;
}

.btn-primary {
  color: #fff;
  background-color: #1b6ec2;
  border-color: #1861ac;
}

.nav-pills .nav-link.active, .nav-pills .show > .nav-link {
  color: #fff;
  background-color: #1b6ec2;
  border-color: #1861ac;
}

.border-top {
  border-top: 1px solid #e5e5e5;
}
.border-bottom {
  border-bottom: 1px solid #e5e5e5;
}

.box-shadow {
  box-shadow: 0 .25rem .75rem rgba(0, 0, 0, .05);
}

button.accept-policy {
  font-size: 1rem;
  line-height: inherit;
}

.footer {
  position: absolute;
  bottom: 0;
  width: 100%;
  white-space: nowrap;
  line-height: 60px;
}

////////////////////////////
/// @using System.Security.Claims
@using Microsoft.AspNetCore.Http

<ul class="navbar-nav align-items-center">
    @if (User.Identity?.IsAuthenticated == true && User.IsInRole("KhachHang"))
    {
        var displayName = User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.GivenName)?.Value;
        if (string.IsNullOrWhiteSpace(displayName))
        {
            displayName = User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Name)?.Value ?? "Người dùng";
        }

        // SỬA LỖI BASE64: Thêm tiền tố "data:image/png;base64,"
        var avatarBase64Claim = Context.Session.GetString("AvatarBase64");
        var avatarSrc = string.IsNullOrEmpty(avatarBase64Claim)
        ? "/images/default-avatar.png" // 1. Lấy ảnh MẶC ĐỊNH
        : $"data:image/png;base64,{avatarBase64Claim}"; // 2. Thêm tiền tố Base64

        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <img src="@avatarSrc" alt="Avatar" class="rounded-circle" style="width: 30px; height: 30px; object-fit: cover; margin-right: 8px;" />
                Xin chào, @displayName!
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <li>
                    <a class="dropdown-item" asp-page="/account/ThongTinCaNhanView">
                        <span class="material-symbols-outlined" style="vertical-align: sub; font-size: 1.2rem; margin-right: 8px;">account_circle</span>
                        Thông tin cá nhân
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" asp-page="/account/LichSuDatBanView">
                        <span class="material-symbols-outlined" style="vertical-align: sub; font-size: 1.2rem; margin-right: 8px;">history</span>
                        Lịch sử đặt bàn
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" asp-page="/account/SachDangThueView">
                        <span class="material-symbols-outlined" style="vertical-align: sub; font-size: 1.2rem; margin-right: 8px;">book</span>
                        Sách đang thuê
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <form class="form-inline" asp-page="/Account/DangXuat" asp-route-returnUrl="@Url.Page("/Index", new { area = "" })" method="post">
                        <button type="submit" class="dropdown-item">
                            <span class="material-symbols-outlined" style="vertical-align: sub; font-size: 1.2rem; margin-right: 8px;">logout</span>
                            Đăng xuất
                        </button>
                    </form>
                </li>
            </ul>
        </li>
    }
    else
    {
        <li class="nav-item">
            <a class="nav-link text-dark" asp-page="/Account/DangKyView">Đăng ký</a>
        </li>
        <li class="nav-item">
            <a class="nav-link text-dark" asp-page="/Account/DangNhapView">Đăng nhập</a>
        </li>
    }
</ul>
////////////////////////
/// <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
<script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>

/////////////////////////
/// @using WebCafebookApi
@namespace WebCafebookApi.Pages
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@using Microsoft.AspNetCore.Mvc.TagHelpers
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
//////////////////////
/// @{
    Layout = "_Layout";
}

///////////////////
/// @page "/"
@model WebCafebookApi.Pages.TrangChuViewModel
@{
    ViewData["Title"] = "Trang Chủ";
    var bannerStyle = string.IsNullOrEmpty(Model.Info?.BannerImageUrl)
        ? "background-color: #4E342E; color: #FFF8E1;"
        : $"background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('{Model.Info.BannerImageUrl}'); background-size: cover; background-position: center; color: white;";
}

<div class="container-fluid px-0 mb-5">
    <div class="text-center p-5" style="@bannerStyle min-height: 40vh; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <h1 class="display-3 fw-bold" style="color: inherit;">
            @(Model.Info?.TenQuan ?? "Chào mừng đến Cafebook")
        </h1>
        <p class="lead fs-4 col-md-8" style="color: inherit; opacity: 0.9;">
            @(Model.Info?.GioiThieu ?? "Nơi bạn có thể thưởng thức cà phê thơm ngon, đọc những cuốn sách hay và tìm thấy không gian yên tĩnh cho riêng mình.")
        </p>
        <div class="mt-4">
            <a asp-page="/ThucDonView" class="btn btn-primary btn-lg me-2">Xem Thực Đơn</a>
            <a asp-page="/ThuVienSachView" class="btn btn-outline-light btn-lg">Khám Phá Sách</a>
        </div>
    </div>
</div>


<div class="container">

    @if (Model.Promotions != null && Model.Promotions.Any())
    {
    }

    <div class="row mt-5">
        <h2 class="text-center mb-4 pb-2 border-bottom">☕ Món Nổi Bật</h2>
        @if (Model.MonNoiBat != null && Model.MonNoiBat.Any())
        {
            @foreach (var item in Model.MonNoiBat)
            {
                <div class="col-lg col-md-4 col-sm-6 mb-4">
                    <div class="card h-100">
                        @{
                            // SỬA LỖI LOGIC Ở ĐÂY
                            var imgSrc = string.IsNullOrEmpty(item.AnhSanPhamBase64)
                            ? "/images/default-food-icon.png"  // 1. Lấy ảnh MẶC ĐỊNH từ wwwroot
                            : $"data:image/png;base64,{item.AnhSanPhamBase64}"; // 2. Thêm tiền tố cho Base64
                        }
                        <img src="@imgSrc" class="card-img-top" alt="@item.TenSanPham" style="height: 180px; object-fit: cover;">
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title">@item.TenSanPham</h6>
                            <p class="card-text text-danger fw-bold mt-auto mb-0">@item.DonGia.ToString("N0") đ</p>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <p class="text-center text-muted">⚙️ Dữ liệu món nổi bật đang được cập nhật...</p>
        }
    </div>

    <div class="row mt-5">
        <h2 class="text-center mb-4 pb-2 border-bottom">📚 Sách Hay Nên Đọc</h2>
        @if (Model.SachNoiBat != null && Model.SachNoiBat.Any())
        {
            @foreach (var sach in Model.SachNoiBat)
            {
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card h-100">
                        @{
                            // SỬA LỖI TƯƠNG TỰ
                            var imgSrc = string.IsNullOrEmpty(sach.AnhBia)
                            ? "/images/default-book-cover.png" // 1. Lấy ảnh MẶC ĐỊNH
                            : $"data:image/png;base64,{sach.AnhBia}"; // 2. Thêm tiền tố Base64
                        }
                        <img src="@imgSrc" class="card-img-top" alt="@sach.TieuDe" style="height: 250px; object-fit: cover;">
                        <div class="card-body">
                            <h6 class="card-title" style="height: 2.5em; overflow: hidden;">@sach.TieuDe</h6>
                            <p class="card-text text-muted small">@sach.TacGia</p>
                        </div>
                        <div class="card-footer bg-transparent border-0 pb-3">
                            <a asp-page="/ChiTietSachView" asp-route-id="@sach.IdSach" class="btn btn-outline-primary btn-sm w-100">
                                Xem chi tiết
                            </a>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <p class="text-center text-muted">⚙️ Dữ liệu sách nổi bật đang được cập nhật...</p>
        }
    </div>

</div>
///////////////////////
/// using CafebookModel.Model.ModelWeb; // Thêm DTO
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Json; // Thêm

namespace WebCafebookApi.Pages // Giả sử namespace là WebCafebookApi.Pages
{
    // Đảm bảo tên class khớp với @model
    public class TrangChuViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;
        public TrangChuViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        // KHAI BÁO CÁC THUỘC TÍNH MÀ .cshtml CẦN
        // (Sửa lỗi CS1061)
        public ThongTinChungDto? Info { get; set; }
        public List<KhuyenMaiDto> Promotions { get; set; } = new();
        public List<SanPhamDto> MonNoiBat { get; set; } = new();
        public List<SachDto> SachNoiBat { get; set; } = new();

        public async Task OnGetAsync()
        {
            var httpClient = _httpClientFactory.CreateClient();
            try
            {
                // Gọi API Trang chủ
                var response = await httpClient.GetFromJsonAsync<TrangChuDto>("http://localhost:5166/api/web/trangchu/data");

                if (response != null)
                {
                    Info = response.Info;
                    Promotions = response.Promotions;
                    MonNoiBat = response.MonNoiBat;
                    SachNoiBat = response.SachNoiBat;
                }
            }
            catch (Exception)
            {
                // Nếu API lỗi, trang vẫn hiển thị (với dữ liệu rỗng)
                // Khởi tạo Info để tránh lỗi null ở .cshtml
                Info = new ThongTinChungDto();
            }
        }
    }
}
///////////////////////////
/// {
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}

//////////////////////////
/// using Microsoft.AspNetCore.Authentication.Cookies;

var builder = WebApplication.CreateBuilder(args);

// 1. THÊM DỊCH VỤ HTTPCLIENT (ĐỂ GỌI API)
builder.Services.AddHttpClient();

// 2. THÊM DỊCH VỤ SESSION (ĐỂ LƯU AVATAR)
builder.Services.AddDistributedMemoryCache();
builder.Services.AddSession(options =>
{
    options.IdleTimeout = TimeSpan.FromMinutes(30);
    options.Cookie.HttpOnly = true;
    options.Cookie.IsEssential = true;
});

// 3. THÊM DỊCH VỤ AUTHENTICATION (ĐỂ TẠO COOKIE)
builder.Services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
    .AddCookie(options =>
    {
        options.LoginPath = "/Account/Login";
        options.AccessDeniedPath = "/AccessDenied";
        options.LogoutPath = "/Account/DangXuat";
    });

// 4. THÊM RAZOR PAGES (của bạn đã có)
builder.Services.AddRazorPages(options =>
{
    //options.Conventions.AddPageRoute("/Account/DangNhapView", "/Account/Login");
    //options.Conventions.AddPageRoute("/Account/DangKyView", "/Account/Register");
    //options.Conventions.AddPageRoute("/Employee/DangNhapEmployee", "/Employee/Login");
});

var app = builder.Build();

// Configure the HTTP request pipeline.
if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/Error");
}
app.UseStaticFiles();

app.UseRouting();

// 5. KÍCH HOẠT CÁC DỊCH VỤ (Thứ tự quan trọng)
app.UseSession(); // Kích hoạt Session
app.UseAuthentication(); // Kích hoạt Authentication
app.UseAuthorization(); // Kích hoạt Authorization

app.MapRazorPages();

app.Run();
//////////////////////////
/// 
/// 