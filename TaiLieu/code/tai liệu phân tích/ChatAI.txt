# ğŸ§© Äáº¶C Táº¢ CHá»¨C NÄ‚NG: CHAT Há»– TRá»¢ KIá»‚U â€œAI â€“ NHÃ‚N VIÃŠNâ€

---

## ğŸ”· 1. Má»¥c tiÃªu

XÃ¢y dá»±ng há»‡ thá»‘ng **Chat há»— trá»£ thÃ´ng minh**, nÆ¡i khÃ¡ch hÃ ng cÃ³ thá»ƒ:

* Trao Ä‘á»•i trá»±c tiáº¿p vá»›i **AI Há»— trá»£ tá»± Ä‘á»™ng (Chatbot)**.
* Náº¿u **AI khÃ´ng hiá»ƒu / khÃ´ng cÃ³ cÃ¢u tráº£ lá»i phÃ¹ há»£p**, há»‡ thá»‘ng **tá»± Ä‘á»™ng chuyá»ƒn tiáº¿p yÃªu cáº§u cho nhÃ¢n viÃªn tháº­t**.
* NhÃ¢n viÃªn sáº½ nháº­n thÃ´ng bÃ¡o vÃ  cÃ³ thá»ƒ tráº£ lá»i trá»±c tiáº¿p tá»« giao diá»‡n **mÃ n hÃ¬nh Há»— trá»£ khÃ¡ch hÃ ng (SupportView)**.

---

## ğŸ”· 2. Actor liÃªn quan

| Actor                | Vai trÃ²                                       |
| -------------------- | --------------------------------------------- |
| **KhÃ¡ch hÃ ng**       | Gá»­i cÃ¢u há»i / yÃªu cáº§u há»— trá»£                  |
| **AI Chatbot**       | Tá»± Ä‘á»™ng phÃ¢n tÃ­ch, tráº£ lá»i cÃ¢u há»i thÆ°á»ng gáº·p |
| **NhÃ¢n viÃªn há»— trá»£** | Tiáº¿p nháº­n vÃ  tráº£ lá»i khi AI khÃ´ng xá»­ lÃ½ Ä‘Æ°á»£c  |
| **Quáº£n trá»‹ viÃªn**    | Theo dÃµi bÃ¡o cÃ¡o, thá»‘ng kÃª sá»‘ cuá»™c chat       |

---

## ğŸ”· 3. MÃ´ hÃ¬nh tÆ°Æ¡ng tÃ¡c tá»•ng quan

```
[KhÃ¡ch hÃ ng] â‡„ [AI Chatbot]
                      â†“
             (Náº¿u khÃ´ng tráº£ lá»i Ä‘Æ°á»£c)
                      â†“
            [Táº¡o yÃªu cáº§u há»— trá»£]
                      â†“
             [NhÃ¢n viÃªn há»— trá»£]
                      â†“
             [Tráº£ lá»i láº¡i khÃ¡ch hÃ ng]
```

---

## ğŸ”· 4. MÃ´ táº£ nghiá»‡p vá»¥ chi tiáº¿t

### **FS-08: Chat há»— trá»£ khÃ¡ch hÃ ng**

#### ğŸ¯ Má»¥c Ä‘Ã­ch

Cung cáº¥p kÃªnh trÃ² chuyá»‡n trá»±c tuyáº¿n giá»¯a khÃ¡ch hÃ ng vÃ  há»‡ thá»‘ng AI, cÃ³ thá»ƒ chuyá»ƒn sang nhÃ¢n viÃªn há»— trá»£ khi AI khÃ´ng tráº£ lá»i Ä‘Æ°á»£c.

---

#### ğŸ§© Tiá»n Ä‘iá»u kiá»‡n

* KhÃ¡ch hÃ ng **Ä‘Ã£ Ä‘Äƒng nháº­p tÃ i khoáº£n**.
* Há»‡ thá»‘ng AI há»— trá»£ Ä‘Æ°á»£c cáº¥u hÃ¬nh sáºµn (vÃ­ dá»¥: OpenAI API hoáº·c ná»™i bá»™).

---

#### ğŸ§© Háº­u Ä‘iá»u kiá»‡n

* Tin nháº¯n Ä‘Æ°á»£c lÆ°u vÃ o báº£ng `ChatLichSu`.
* Náº¿u AI khÃ´ng tráº£ lá»i â†’ táº¡o **ThÃ´ng bÃ¡o há»— trá»£ má»›i** cho nhÃ¢n viÃªn (`ThongBaoHoTro`).

---

### ğŸ§­ Luá»“ng hoáº¡t Ä‘á»™ng chÃ­nh

| BÆ°á»›c | MÃ´ táº£ hÃ nh Ä‘á»™ng                            | Há»‡ thá»‘ng xá»­ lÃ½                                           |
| ---- | ------------------------------------------ | -------------------------------------------------------- |
| 1    | KhÃ¡ch má»Ÿ trang **â€œTrung tÃ¢m há»— trá»£â€**      | Hiá»ƒn thá»‹ khung chat AI                                   |
| 2    | KhÃ¡ch nháº­p cÃ¢u há»i                         | Gá»­i yÃªu cáº§u Ä‘áº¿n AI                                       |
| 3    | Há»‡ thá»‘ng AI xá»­ lÃ½ cÃ¢u há»i                  | Gá»­i pháº£n há»“i náº¿u cÃ³                                      |
| 4    | Náº¿u AI **khÃ´ng cÃ³ cÃ¢u tráº£ lá»i há»£p lá»‡**     | Táº¡o **PhiÃªn há»— trá»£ nhÃ¢n viÃªn**                           |
| 5    | ThÃ´ng bÃ¡o Ä‘Æ°á»£c gá»­i tá»›i giao diá»‡n nhÃ¢n viÃªn | NhÃ¢n viÃªn tháº¥y trong mÃ n hÃ¬nh â€œHá»— trá»£ khÃ¡ch hÃ ngâ€        |
| 6    | NhÃ¢n viÃªn tráº£ lá»i thá»§ cÃ´ng                 | Tin nháº¯n gá»­i ngÆ°á»£c láº¡i khÃ¡ch hÃ ng                        |
| 7    | Há»‡ thá»‘ng lÆ°u toÃ n bá»™ ná»™i dung chat         | Ghi vÃ o `ChatLichSu` (bao gá»“m loáº¡i chat: â€œAIâ€ hoáº·c â€œNVâ€) |

---

### ğŸ§­ Luá»“ng phá»¥ (AI tháº¥t báº¡i)

**Äiá»u kiá»‡n:**

* AI tráº£ vá» lá»—i, hoáº·c confidence tháº¥p (â‰¤ threshold).

**HÃ nh Ä‘á»™ng:**

1. LÆ°u tin nháº¯n vÃ o `ChatLichSu` vá»›i `LoaiChat = 'AI'` vÃ  `NoiDungTraLoi = 'ChÆ°a thá»ƒ tráº£ lá»i, Ä‘Ã£ chuyá»ƒn nhÃ¢n viÃªn há»— trá»£'`.
2. Táº¡o báº£n ghi trong `ThongBaoHoTro`:

   * `IdKhachHang`
   * `NoiDungYeuCau`
   * `TrangThai = 'Chá» xá»­ lÃ½'`
   * `ThoiGianTao = GETDATE()`
3. Gá»­i **thÃ´ng bÃ¡o real-time (SignalR hoáº·c polling)** Ä‘áº¿n giao diá»‡n nhÃ¢n viÃªn.

---

## ğŸ”· 5. Thiáº¿t káº¿ cÆ¡ sá»Ÿ dá»¯ liá»‡u (CSDL)

### ğŸ—‚ï¸ **Báº£ng ChatLichSu** *(Ä‘Ã£ cÃ³ trong DB cá»§a báº¡n)*

Bá»• sung cÃ¡c cá»™t / sá»­a nháº¹:

```sql
ALTER TABLE ChatLichSu
ADD LoaiTinNhan NVARCHAR(20) NULL, -- "KhachHang" / "AI" / "NhanVien"
    IdThongBao INT NULL;            -- LiÃªn káº¿t vá»›i yÃªu cáº§u há»— trá»£
```

---

### ğŸ—‚ï¸ **Báº£ng ThongBaoHoTro** *(báº£ng má»›i)*

```sql
CREATE TABLE ThongBaoHoTro (
    IdThongBao INT IDENTITY PRIMARY KEY,
    IdKhachHang INT NOT NULL,
    NoiDung NVARCHAR(MAX),
    ThoiGianTao DATETIME DEFAULT GETDATE(),
    TrangThai NVARCHAR(50) DEFAULT N'Chá» xá»­ lÃ½', -- "Chá» xá»­ lÃ½", "Äang xá»­ lÃ½", "ÄÃ£ pháº£n há»“i"
    IdNhanVien INT NULL,
    ThoiGianPhanHoi DATETIME NULL,
    GhiChu NVARCHAR(500) NULL
);
```

---

## ğŸ”· 6. Giao diá»‡n ngÆ°á»i dÃ¹ng (UI logic)

### **1ï¸âƒ£ Trang Chat cá»§a khÃ¡ch hÃ ng (ChatView.cshtml)**

* Hiá»ƒn thá»‹ 2 luá»“ng chat:

  * Tin cá»§a khÃ¡ch (`class="chat-user"`)
  * Pháº£n há»“i cá»§a AI / nhÃ¢n viÃªn (`class="chat-ai"`)

VÃ­ dá»¥:

```html
<div class="chat-container">
    <div class="chat-bubble user">Xin chÃ o, tÃ´i muá»‘n há»i vá» viá»‡c thuÃª sÃ¡ch.</div>
    <div class="chat-bubble ai">ChÃ o báº¡n! Báº¡n muá»‘n thuÃª sÃ¡ch gÃ¬ áº¡?</div>
</div>

<form method="post" id="chatForm">
    <input type="text" name="message" class="form-control" placeholder="Nháº­p cÃ¢u há»i...">
    <button type="submit" class="btn btn-primary">Gá»­i</button>
</form>
```

---

### **2ï¸âƒ£ Trang há»— trá»£ nhÃ¢n viÃªn (HoTroNhanVienView.cshtml)**

Hiá»ƒn thá»‹ danh sÃ¡ch cÃ¡c yÃªu cáº§u chá» xá»­ lÃ½:

| KhÃ¡ch hÃ ng | Ná»™i dung                             | Thá»i gian | Tráº¡ng thÃ¡i | Thao tÃ¡c  |
| ---------- | ------------------------------------ | --------- | ---------- | --------- |
| Nguyá»…n An  | â€œAI khÃ´ng hiá»ƒu cÃ¢u há»i vá» thuÃª sÃ¡châ€ | 10:21 AM  | Chá» xá»­ lÃ½  | [Tráº£ lá»i] |

Khi nhÃ¢n viÃªn nháº¥n â€œTráº£ lá»iâ€, má»Ÿ khung chat real-time vá»›i khÃ¡ch.

---

### **3ï¸âƒ£ ThÃ´ng bÃ¡o real-time (náº¿u cÃ³)**

Sá»­ dá»¥ng **SignalR / WebSocket**:

* Khi táº¡o `ThongBaoHoTro`, gá»i Hub:

  ```csharp
  await _hubContext.Clients.Group("NhanVienHoTro")
      .SendAsync("NewSupportRequest", thongBao);
  ```
* NhÃ¢n viÃªn sáº½ tháº¥y thÃ´ng bÃ¡o ná»•i:
  ğŸ”” *â€œKhÃ¡ch hÃ ng Nguyá»…n An cáº§n há»— trá»£ â€” AI khÃ´ng tráº£ lá»i Ä‘Æ°á»£c.â€*

---

## ğŸ”· 7. TÃ­ch há»£p AI Chatbot

AI cÃ³ thá»ƒ lÃ :

* **MÃ´ hÃ¬nh OpenAI GPT API** (qua endpoint API key).
* Hoáº·c **mÃ´ hÃ¬nh ná»™i bá»™** (xá»­ lÃ½ keyword, dá»¯ liá»‡u ná»™i bá»™ tá»« FAQ).

Khi nháº­n cÃ¢u há»i:

```csharp
var aiResponse = await _aiService.GetAnswerAsync(userQuestion);
if (string.IsNullOrEmpty(aiResponse) || aiResponse.Contains("khÃ´ng rÃµ"))
{
    // Chuyá»ƒn yÃªu cáº§u sang nhÃ¢n viÃªn
    await _supportService.CreateThongBaoHoTro(userId, userQuestion);
}
else
{
    // Gá»­i pháº£n há»“i AI bÃ¬nh thÆ°á»ng
    SaveToChatLichSu(userId, "AI", aiResponse);
}
```

---

## ğŸ”· 8. BÃ¡o cÃ¡o thá»‘ng kÃª há»— trá»£

Táº¡o bÃ¡o cÃ¡o tá»« 2 báº£ng: `ChatLichSu`, `ThongBaoHoTro`

VÃ­ dá»¥:

```sql
SELECT 
    COUNT(*) AS TongYeuCau,
    SUM(CASE WHEN TrangThai = N'Chá» xá»­ lÃ½' THEN 1 ELSE 0 END) AS ChuaXuLy,
    SUM(CASE WHEN TrangThai = N'ÄÃ£ pháº£n há»“i' THEN 1 ELSE 0 END) AS DaXuLy,
    COUNT(DISTINCT IdKhachHang) AS SoKhachHang,
    COUNT(DISTINCT IdNhanVien) AS SoNhanVienPhanHoi
FROM ThongBaoHoTro;
```

> CÃ³ thá»ƒ hiá»ƒn thá»‹ trong trang â€œBÃ¡o cÃ¡o há»— trá»£ khÃ¡ch hÃ ngâ€,
> vá»›i biá»ƒu Ä‘á»“ trÃ²n: â€œTá»‰ lá»‡ AI xá»­ lÃ½ vs NhÃ¢n viÃªn xá»­ lÃ½â€.

---

## âœ… 9. Káº¿t luáº­n thiáº¿t káº¿

| ThÃ nh pháº§n                    | MÃ´ táº£                             | Tráº¡ng thÃ¡i                      |
| ----------------------------- | --------------------------------- | ------------------------------- |
| **Chat AI tá»± Ä‘á»™ng**           | Nháº­n vÃ  tráº£ lá»i cÃ¢u há»i cÆ¡ báº£n    | âœ… HoÃ n thiá»‡n                    |
| **Chuyá»ƒn tiáº¿p cho nhÃ¢n viÃªn** | Khi AI khÃ´ng tráº£ lá»i Ä‘Æ°á»£c         | âœ… CÃ³ luá»“ng rÃµ rÃ ng              |
| **ThÃ´ng bÃ¡o nhÃ¢n viÃªn**       | Hiá»ƒn thá»‹ real-time hoáº·c danh sÃ¡ch | âœ… CÃ³ báº£ng riÃªng `ThongBaoHoTro` |
| **LÆ°u lá»‹ch sá»­ chat**          | DÃ¹ng báº£ng `ChatLichSu` (má»Ÿ rá»™ng)  | âœ… Giá»¯ nguyÃªn DB cÅ©              |
| **BÃ¡o cÃ¡o thá»‘ng kÃª**          | Sá»‘ cuá»™c chat AI / NhÃ¢n viÃªn       | âœ… Dá»… triá»ƒn khai qua SQL View    |

---

## ğŸ’¡ 10. Gá»£i Ã½ má»Ÿ rá»™ng

1. **PhÃ¢n loáº¡i tá»± Ä‘á»™ng yÃªu cáº§u há»— trá»£ (báº±ng AI)**
   â†’ VÃ­ dá»¥: â€œthuÃª sÃ¡châ€, â€œhoÃ n tiá»nâ€, â€œváº­n chuyá»ƒnâ€, â€¦
2. **Tá»± Ä‘á»™ng gá»£i Ã½ cÃ¢u tráº£ lá»i cho nhÃ¢n viÃªn**
   â†’ AI Ä‘Æ°a ra â€œgá»£i Ã½ tráº£ lá»i nhanhâ€, nhÃ¢n viÃªn cÃ³ thá»ƒ chá»‰nh vÃ  gá»­i.
3. **Cháº¥m Ä‘iá»ƒm hiá»‡u quáº£ há»— trá»£ (CSAT)**
   â†’ Sau má»—i phiÃªn chat, khÃ¡ch cÃ³ thá»ƒ Ä‘Ã¡nh giÃ¡ â€œHÃ i lÃ²ng / KhÃ´ng hÃ i lÃ²ngâ€.

---

e:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\HoTroView.cshtml
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\HoTroView.cshtml.cs
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookModel\Model\ModelWeb\HoTroDto.cs
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\Web\HoTroControllers.cs
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Services\AiService.cs
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Services\ChatHub.cs

- hiá»‡n táº¡i khÃ¡ch hÃ ng Ä‘Ã£ nháº­n Ä‘Æ°á»£c tin nháº¯n theo thá»i gian thá»±c, nhÆ°ng nhÃ¢n viÃªn thÃ¬ nÃ³ chÆ°a cáº­p nháº­t tin nháº¯n theo thá»i gian thá»±c.
- khi khÃ¡ch hÃ ng chat vá»›i nhÃ¢n viÃªn thÃ¬ dá»«ng AI vÃ  hiá»‡n nÃºt chat vá»›i nhÃ¢n viÃªn khÃ¡ch hÃ ng- náº¿u cÃ³ yÃªu cáº§u khÃ¡ch hÃ ng má»›i hiá»‡n lÃªn trÃªn cÃ¹ng Danh sÃ¡ch Phiáº¿u Há»— Trá»£ vÃ  thÃªm 1 cháº¥m Ä‘á»