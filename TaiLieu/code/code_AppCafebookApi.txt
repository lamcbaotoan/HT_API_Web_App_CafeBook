=== MÃ NGUỒN DỰ ÁN: AppCafebookApi ===

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi.slnLaunch.user
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi.slnx
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi\CopilotIndices\18.0.923.20550\CodeChunks.db
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi\CopilotIndices\18.0.923.20550\CodeChunks.db-shm
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi\CopilotIndices\18.0.923.20550\CodeChunks.db-wal
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi\CopilotIndices\18.0.923.20550\SemanticSymbols.db
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi\CopilotIndices\18.0.923.20550\SemanticSymbols.db-shm
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi\CopilotIndices\18.0.923.20550\SemanticSymbols.db-wal
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi\CopilotIndices\18.3.95.3864\CodeChunks.db
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi\CopilotIndices\18.3.95.3864\CodeChunks.db-shm
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi\CopilotIndices\18.3.95.3864\CodeChunks.db-wal
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi\CopilotIndices\18.3.95.3864\SemanticSymbols.db
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi\CopilotIndices\18.3.95.3864\SemanticSymbols.db-shm
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi\CopilotIndices\18.3.95.3864\SemanticSymbols.db-wal
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi.slnx\config\applicationhost.config
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi.slnx\copilot-chat\0986bd90\sessions\2e962a96-ebeb-4440-b29d-ce75a4a6de55
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi.slnx\DesignTimeBuild\.dtbcache.v2
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi.slnx\FileContentIndex\0eb86ccf-c385-4061-beba-9da0ffcb019d.vsidx
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi.slnx\FileContentIndex\3250ec98-3c1c-4351-90d0-cd93b4b6621d.vsidx
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi.slnx\FileContentIndex\5544ba18-87a5-4f04-9f48-c1f6d9f4b92c.vsidx
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi.slnx\FileContentIndex\c8eb00ca-2367-4458-b85e-804f0c5e2396.vsidx
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi.slnx\FileContentIndex\d35ac808-8e33-417d-93d2-892830410180.vsidx
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi.slnx\v18\.futdcache.v2
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi.slnx\v18\.suo
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi.slnx\v18\DocumentLayout.backup.json
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi.slnx\v18\DocumentLayout.json
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\AppCafebookApi.slnx\v18\HierarchyCache.v1.txt
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\ProjectEvaluation\appcafebookapi.metadata.v10.bin
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\ProjectEvaluation\appcafebookapi.projects.v10.bin
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\.vs\ProjectEvaluation\appcafebookapi.strings.v10.bin
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\App.xaml
================================================================================
﻿<Application x:Class="AppCafebookApi.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:AppCafebookApi"
             StartupUri="View/ManHinhDangNhap.xaml">
    <Application.Resources>
         
    </Application.Resources>
</Application>

================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\App.xaml.cs
================================================================================
﻿using System.Configuration;
using System.Data;
using System.Windows;

namespace AppCafebookApi
{
    /// <summary>
    /// Interaction logic for App.xaml
    /// </summary>
    public partial class App : Application
    {
    }

}

================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\AppCafebookApi.csproj
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\AppCafebookApi.csproj.user
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\logo.ico
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\Assets\logo.ico
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\Assets\logo.png
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\Assets\images\default-avatar.png
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\Assets\images\default-book-cover.png
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\Assets\images\default-food-icon.png
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\Converters\NullToVisibilityConverter.cs
================================================================================
﻿using System;
using System.Globalization;
using System.Windows;
using System.Windows.Data;

namespace AppCafebookApi.Converters
{
    /// <summary>
    /// Converter này chuyển giá trị null hoặc string rỗng thành Collapsed (ẩn)
    /// và giá trị không-null thành Visible (hiện).
    /// </summary>
    public class NullToVisibilityConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            // Nếu value là null, hoặc là string rỗng/khoảng trắng
            if (value == null || (value is string s && string.IsNullOrWhiteSpace(s)))
            {
                return Visibility.Collapsed; // Ẩn đi
            }

            return Visibility.Visible; // Hiện
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\Fonts\Font Awesome 6 Free-Solid-900.otf
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\Services\ApiClient.cs
================================================================================
﻿using System.Net.Http;
using System.Net.Http.Headers;
using System; // Thêm
using AppCafebookApi.Services; // Thêm

namespace AppCafebookApi.Services
{
    public static class ApiClient
    {
        private static HttpClient? _instance;

        public static HttpClient Instance
        {
            get
            {
                if (_instance == null)
                {
                    _instance = new HttpClient
                    {
                        // SỬA DÒNG NÀY:
                        BaseAddress = new System.Uri("http://127.0.0.1:5166")
                    };
                    _instance.DefaultRequestHeaders.Accept.Clear();
                    _instance.DefaultRequestHeaders.Accept.Add(
                        new MediaTypeWithQualityHeaderValue("application/json"));
                }

                if (!string.IsNullOrEmpty(AuthService.AuthToken))
                {
                    _instance.DefaultRequestHeaders.Authorization =
                        new AuthenticationHeaderValue("Bearer", AuthService.AuthToken);
                    Console.WriteLine($"[ApiClient] Authorization header set: {AuthService.AuthToken.Substring(0, 20)}...");
                }
                else
                {
                    _instance.DefaultRequestHeaders.Authorization = null;
                    Console.WriteLine("[ApiClient] AuthToken trống, không thêm Authorization header.");
                }

                return _instance;
            }
        }
        /// <summary>
        /// Gọi hàm này SAU KHI đăng nhập thành công
        /// </summary>
        public static void SetAuthorizationHeader(string token)
        {
            // Xóa header cũ và thêm token mới
            Instance.DefaultRequestHeaders.Authorization = null;
            if (!string.IsNullOrEmpty(token))
            {
                Instance.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);
            }
        }

        /// <summary>
        /// Gọi hàm này khi đăng xuất
        /// </summary>
        public static void ClearAuthorizationHeader()
        {
            Instance.DefaultRequestHeaders.Authorization = null;
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\Services\AuthService.cs
================================================================================
﻿using CafebookModel.Model.Data;
using CafebookModel.Model.ModelApi;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Collections.Generic;

namespace AppCafebookApi.Services
{
    public static class AuthService
    {
        public static NhanVienDto? CurrentUser { get; private set; }
        public static string? AuthToken { get; private set; }

        private static readonly HttpClient _httpClient;

        static AuthService()
        {
            _httpClient = new HttpClient
            {
                // SỬA DÒNG NÀY:
                BaseAddress = new System.Uri("http://127.0.0.1:5166")
            };
            _httpClient.DefaultRequestHeaders.Accept.Clear();
            _httpClient.DefaultRequestHeaders.Accept.Add(
              new System.Net.Http.Headers.MediaTypeWithQualityHeaderValue("application/json"));
        }

        public static async Task<LoginResponseModel> LoginAsync(LoginRequestModel model)
        {
            try
            {
                var response = await _httpClient.PostAsJsonAsync("/api/app/taikhoan/login", model);

                if (response.IsSuccessStatusCode)
                {
                    var loginResponse = await response.Content.ReadFromJsonAsync<LoginResponseModel>();
                    if (loginResponse != null && loginResponse.Success)
                    {
                        CurrentUser = loginResponse.UserData;
                        AuthToken = loginResponse.Token; // <-- Dòng quan trọng lấy token
                    }
                    return loginResponse ?? new LoginResponseModel { Success = false, Message = "Không thể đọc phản hồi." };
                }

                var errorResponse = await response.Content.ReadFromJsonAsync<LoginResponseModel>();
                return errorResponse ?? new LoginResponseModel { Success = false, Message = $"Lỗi: {response.StatusCode}" };
            }
            catch (HttpRequestException ex)
            {
                return new LoginResponseModel { Success = false, Message = $"Lỗi kết nối API: {ex.Message}" };
            }
        }

        public static LoginResponseModel LoginBackdoor(LoginRequestModel model)
        {
            AuthToken = null;
            return new LoginResponseModel { Success = false };
        }

        public static void Logout()
        {
            CurrentUser = null;
            AuthToken = null;
        }

        public static bool CoQuyen(string idQuyen)
        {
            if (CurrentUser == null || CurrentUser.DanhSachQuyen == null) return false;
            if (CurrentUser.TenVaiTro == "Quản trị viên" || CurrentUser.DanhSachQuyen.Contains("FULL")) return true;
            return CurrentUser.DanhSachQuyen.Contains(idQuyen);
        }

        public static bool CoQuyen(params string[] quyenIds)
        {
            if (CurrentUser == null || CurrentUser.DanhSachQuyen == null) return false;
            if (CurrentUser.TenVaiTro == "Quản trị viên" || CurrentUser.DanhSachQuyen.Contains("FULL")) return true;
            return quyenIds.Any(id => CurrentUser.DanhSachQuyen.Contains(id));
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\Services\HinhAnhHelper.cs
================================================================================
﻿// Tập tin: AppCafebookApi/Services/HinhAnhHelper.cs
using System;
using System.IO;
using System.Windows.Media;
using System.Windows.Media.Imaging;
// KHÔNG CẦN using System.Windows; nữa

namespace AppCafebookApi.Services
{
    public static class HinhAnhHelper
    {
        /// <summary>
        /// SỬA ĐỔI: Tải ảnh từ URL Web hoặc Đường dẫn File cục bộ.
        /// </summary>
        public static BitmapImage LoadImage(string? imageSource, string defaultImagePath)
        {
            if (string.IsNullOrEmpty(imageSource))
            {
                // 1. Không có nguồn -> Tải ảnh mặc định (pack://)
                return LoadImageFromPackUri(defaultImagePath);
            }

            // 2. Nguồn là URL (http://...)
            if (imageSource.StartsWith("http", StringComparison.OrdinalIgnoreCase))
            {
                try
                {
                    var image = new BitmapImage();
                    image.BeginInit();
                    image.UriSource = new Uri(imageSource, UriKind.Absolute);
                    image.CreateOptions = BitmapCreateOptions.IgnoreImageCache;
                    image.CacheOption = BitmapCacheOption.OnLoad;
                    image.EndInit();

                    // SỬA: ĐÃ XÓA DÒNG image.Freeze();

                    return image;
                }
                catch (Exception) // SỬA: Xóa MessageBox, chỉ trả về ảnh mặc định
                {
                    return LoadImageFromPackUri(defaultImagePath); // Lỗi URL -> Tải mặc định
                }
            }

            // 3. (SỬA) Nguồn là một đường dẫn file cục bộ (Dùng cho Preview)
            if (File.Exists(imageSource))
            {
                try
                {
                    var image = new BitmapImage();
                    image.BeginInit();
                    image.UriSource = new Uri(imageSource, UriKind.Absolute);
                    image.CacheOption = BitmapCacheOption.OnLoad;
                    image.EndInit();
                    // SỬA: ĐÃ XÓA DÒNG image.Freeze();
                    return image;
                }
                catch
                {
                    return LoadImageFromPackUri(defaultImagePath);
                }
            }

            return LoadImageFromPackUri(defaultImagePath);
        }

        /// <summary>
        /// (Giữ nguyên) Hàm tải ảnh từ Resource (pack://)
        /// </summary>
        private static BitmapImage LoadImageFromPackUri(string uriPath)
        {
            try
            {
                var image = new BitmapImage();
                var uri = new Uri($"pack://application:,,,/AppCafebookApi;component{uriPath}", UriKind.Absolute);

                image.BeginInit();
                image.UriSource = uri;
                image.CacheOption = BitmapCacheOption.OnLoad;
                image.EndInit();
                image.Freeze(); // Freeze ở đây thì an toàn, vì file nằm sẵn trong app
                return image;
            }
            catch (Exception)
            {
                // Tạo ảnh 1x1 trong suốt nếu resource bị lỗi
                var image = new BitmapImage();
                var writeableBitmap = new WriteableBitmap(1, 1, 96, 96, PixelFormats.Pbgra32, null);
                using (var stream = new MemoryStream())
                {
                    var encoder = new PngBitmapEncoder();
                    encoder.Frames.Add(BitmapFrame.Create(writeableBitmap));
                    encoder.Save(stream);
                    stream.Position = 0;
                    image.BeginInit();
                    image.CacheOption = BitmapCacheOption.OnLoad;
                    image.StreamSource = stream;
                    image.EndInit();
                }
                image.Freeze();
                return image;
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\ManHinhDangNhap.xaml
================================================================================
﻿<Window x:Class="AppCafebookApi.View.ManHinhDangNhap"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AppCafebookApi.View"
        mc:Ignorable="d"
        Title="Đăng nhập hệ thống CafeBook" Height="500" Width="850"
        WindowStartupLocation="CenterScreen"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent"
        ResizeMode="NoResize"
        FontFamily="Segoe UI"
        Loaded="Window_Loaded"
        KeyDown="Window_KeyDown">

    <Window.Resources>
        <SolidColorBrush x:Key="PrimaryBrown" Color="#6F4E37"/>
        <SolidColorBrush x:Key="AccentOrange" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCream" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="DarkText" Color="#4E342E"/>
        <SolidColorBrush x:Key="SubtleGray" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="WhiteText" Color="#FFFFFF"/>

        <Geometry x:Key="UserIcon">M12,12A5,5 0 0,1 7,7A5,5 0 0,1 12,2A5,5 0 0,1 17,7A5,5 0 0,1 12,12M12,14C14.67,14 20,15.33 20,18V20H4V18C4,15.33 9.33,14 12,14Z</Geometry>
        <Geometry x:Key="LockIcon">M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8H17V6A5,5 0 0,0 12,1A5,5 0 0,0 7,6V8H6A2,2 0 0,0 4,10V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V10A2,2 0 0,0 18,8Z</Geometry>
        <Geometry x:Key="LogoIcon">M16,5H14V3H12V5H10A3,3 0 0,0 7,8V14H18V8A3,3 0 0,0 15,5M20,19H4V17H20V19Z</Geometry>

        <Style TargetType="TextBox">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="{StaticResource SubtleGray}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="Foreground" Value="{StaticResource DarkText}"/>
            <Setter Property="Padding" Value="35,8,8,8"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TextBox">
                        <Border x:Name="border"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                SnapsToDevicePixels="True">
                            <ScrollViewer x:Name="PART_ContentHost" Focusable="False" HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Hidden"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsKeyboardFocused" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource AccentOrange}"/>
                                <Setter TargetName="border" Property="BorderThickness" Value="0,0,0,2"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrown}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="PasswordBox">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="{StaticResource SubtleGray}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="Foreground" Value="{StaticResource DarkText}"/>
            <Setter Property="Padding" Value="35,8,8,8"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="PasswordBox">
                        <Border x:Name="border"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                SnapsToDevicePixels="True">

                            <ScrollViewer x:Name="PART_ContentHost" Focusable="False" HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Hidden"/>

                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsKeyboardFocused" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource AccentOrange}"/>
                                <Setter TargetName="border" Property="BorderThickness" Value="0,0,0,2"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrown}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrown}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteText}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Height" Value="42"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                CornerRadius="21"
                                Background="{TemplateBinding Background}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="2" Color="#6F4E37" Opacity="0.3" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource AccentOrange}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="TextButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrown}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Height" Value="42"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Foreground" Value="{StaticResource AccentOrange}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

    </Window.Resources>

    <Border CornerRadius="12" Background="{StaticResource LightCream}">
        <Border.Effect>
            <DropShadowEffect Color="#000000" Opacity="0.15" BlurRadius="30" ShadowDepth="0"/>
        </Border.Effect>
        <Grid x:Name="MainGrid">
            <Grid.Triggers>
                <EventTrigger RoutedEvent="Loaded">
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation Storyboard.TargetName="MainGrid" Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
            </Grid.Triggers>

            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="320"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Background="{StaticResource PrimaryBrown}" CornerRadius="12,0,0,12">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <Ellipse Width="100" Height="100" Margin="0,0,0,20">
                        <Ellipse.Effect>
                            <DropShadowEffect ShadowDepth="1" BlurRadius="15" Opacity="0.2"/>
                        </Ellipse.Effect>
                        <Ellipse.Fill>
                            <!-- Thay đổi "/Assets/logo.png" thành đường dẫn chính xác tới file của bạn -->
                            <ImageBrush ImageSource="/Assets/logo.png"/>
                        </Ellipse.Fill>
                    </Ellipse>
                    <TextBlock Text="CafeBook" FontSize="36" FontWeight="Bold" Foreground="{StaticResource WhiteText}" HorizontalAlignment="Center"/>
                    <TextBlock Text="Awaken your senses" Opacity="0.8" FontSize="14" Foreground="{StaticResource WhiteText}" HorizontalAlignment="Center" Margin="0,5,0,0"/>
                </StackPanel>
            </Border>

            <Grid Grid.Column="1" Margin="50,40">
                <StackPanel VerticalAlignment="Center">
                    <TextBlock Text="Đăng Nhập"
                               FontSize="28"
                               FontWeight="Bold"
                               Foreground="{StaticResource DarkText}"
                               Margin="0,0,0,10"/>
                    <TextBlock Text="Chào mừng trở lại! Vui lòng nhập thông tin của bạn."
                               FontSize="14"
                               Foreground="{StaticResource DarkText}"
                               Opacity="0.7"
                               TextWrapping="Wrap"
                               Margin="0,0,0,30"/>

                    <Grid Margin="0,10,0,0">
                        <TextBlock Text="Tên đăng nhập" Foreground="{StaticResource PrimaryBrown}" VerticalAlignment="Top" Margin="0,-8,0,0" FontSize="12"/>
                        <Path Data="{StaticResource UserIcon}" Fill="{StaticResource SubtleGray}" Width="18" Height="18" Stretch="Uniform" VerticalAlignment="Center" HorizontalAlignment="Left" Margin="5,0,0,0"/>
                        <TextBox x:Name="txtUsername"/>
                    </Grid>

                    <Grid Margin="0,25,0,0">
                        <TextBlock Text="Mật khẩu" Foreground="{StaticResource PrimaryBrown}" VerticalAlignment="Top" Margin="0,-8,0,0" FontSize="12"/>
                        <Path Data="{StaticResource LockIcon}" Fill="{StaticResource SubtleGray}" Width="18" Height="18" Stretch="Uniform" VerticalAlignment="Center" HorizontalAlignment="Left" Margin="5,0,0,0"/>
                        <TextBox x:Name="txtVisiblePassword" Visibility="Collapsed" TextChanged="TxtVisiblePassword_TextChanged"/>
                        <PasswordBox x:Name="txtPassword" PasswordChanged="TxtPassword_PasswordChanged"/>
                    </Grid>

                    <CheckBox x:Name="chkShowPassword"
                              Content="Hiển thị mật khẩu"
                              FontSize="12"
                              Foreground="{StaticResource DarkText}"
                              HorizontalAlignment="Right"
                              Margin="0,15,0,0"
                              Checked="ChkShowPassword_Checked" Unchecked="ChkShowPassword_Unchecked"/>

                    <Button x:Name="btnLogin" Content="ĐĂNG NHẬP" Style="{StaticResource PrimaryButton}" Margin="0,30,0,0" Click="BtnLogin_Click"/>
                    <Button x:Name="btnExit" Content="Thoát chương trình" Style="{StaticResource TextButton}" Margin="0,10,0,0" Click="BtnExit_Click"/>
                </StackPanel>
            </Grid>
        </Grid>
    </Border>
</Window>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\ManHinhDangNhap.xaml.cs
================================================================================
﻿using System.Windows;
using System.Windows.Input;
using AppCafebookApi.Services;
using CafebookModel.Model.ModelApi;
using CafebookModel.Model.Data;
using AppCafebookApi.View.Common;
using AppCafebookApi.View.quanly;
using AppCafebookApi.View.nhanvien;
using System.Windows.Controls;
using System.Threading.Tasks; // <-- Thêm using này

namespace AppCafebookApi.View
{
    public partial class ManHinhDangNhap : Window
    {
        public ManHinhDangNhap()
        {
            InitializeComponent();
        }

        private void Window_Loaded(object sender, RoutedEventArgs e)
        {
            txtUsername.Focus();
        }

        private async void BtnLogin_Click(object sender, RoutedEventArgs e)
        {
            var loginRequest = new LoginRequestModel
            {
                TenDangNhap = txtUsername.Text,
                MatKhau = chkShowPassword.IsChecked == true ? txtVisiblePassword.Text : txtPassword.Password
            };

            btnLogin.IsEnabled = false;
            btnLogin.Content = "ĐANG KIỂM TRA...";

            LoginResponseModel response = AuthService.LoginBackdoor(loginRequest);

            if (!response.Success)
            {
                response = await AuthService.LoginAsync(loginRequest);
            }

            if (response.Success && response.UserData != null)
            {
                // === BẮT ĐẦU SỬA LUỒNG (FLOW) ===

                // 1. Ẩn màn hình đăng nhập ngay lập tức
                this.Hide();

                // 2. Hiển thị màn hình chào mừng (ShowDialog để chặn tương tác)
                HienThiManHinhChao(response.UserData);

                // 3. (Sau khi màn hình chào mừng đóng) Phân quyền và mở màn hình chính
                PhanQuyenVaChuyenHuong(response.UserData.TenVaiTro ?? string.Empty);

                // 4. Đóng hẳn màn hình đăng nhập
                this.Close();

                // === KẾT THÚC SỬA LUỒNG ===
            }
            else
            {
                // Đăng nhập thất bại, hiện lại nút
                btnLogin.IsEnabled = true;
                btnLogin.Content = "ĐĂNG NHẬP";
                MessageBox.Show(response.Message, "Đăng nhập thất bại", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void HienThiManHinhChao(NhanVienDto user)
        {
            var welcomeWindow = new WelcomeWindow(user);
            // Không cần gán Owner nữa vì màn hình đăng nhập đã Hide()
            welcomeWindow.ShowDialog();
        }

        private void PhanQuyenVaChuyenHuong(string tenVaiTro)
        {
            if (tenVaiTro == "Quản trị viên" || tenVaiTro == "Quản lý")
            {
                ManHinhQuanly adminWindow = new ManHinhQuanly();
                adminWindow.Show();
            }
            else
            {
                ManHinhNhanVien employeeWindow = new ManHinhNhanVien();
                employeeWindow.Show();
            }

            // this.Close(); // Đã chuyển lên hàm BtnLogin_Click
        }

        private void BtnExit_Click(object sender, RoutedEventArgs e)
        {
            Application.Current.Shutdown();
        }

        private async void Window_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.Key == Key.Enter && btnLogin.IsEnabled) // Chỉ chạy nếu nút đang bật
            {
                BtnLogin_Click(sender, e);
                e.Handled = true;
            }
        }

        // --- Logic Hiển thị Mật khẩu ---

        private void ChkShowPassword_Checked(object sender, RoutedEventArgs e)
        {
            txtVisiblePassword.Text = txtPassword.Password;
            txtVisiblePassword.Visibility = Visibility.Visible;
            txtPassword.Visibility = Visibility.Collapsed;
        }

        private void ChkShowPassword_Unchecked(object sender, RoutedEventArgs e)
        {
            txtPassword.Password = txtVisiblePassword.Text;
            txtVisiblePassword.Visibility = Visibility.Collapsed;
            txtPassword.Visibility = Visibility.Visible;
        }

        private void TxtPassword_PasswordChanged(object sender, RoutedEventArgs e)
        {
            if (chkShowPassword.IsChecked == true)
            {
                txtVisiblePassword.Text = txtPassword.Password;
            }
        }

        private void TxtVisiblePassword_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (chkShowPassword.IsChecked == false)
            {
                txtPassword.Password = txtVisiblePassword.Text;
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\BaocaodoanhthuPreviewWindow.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.common.BaocaodoanhthuPreviewWindow"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:local="clr-namespace:AppCafebookApi.View.common"
      mc:Ignorable="d"
      Title="Xem trước Báo cáo Doanh thu - Lợi nhuận" 
      d:DesignHeight="720" d:DesignWidth="1000"
      Background="#FFF8E1"
      FontFamily="Segoe UI"
      Loaded="Page_Loaded">
    
    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        
        <Style TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,8"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="KpiCard" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="15"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="KpiValue" TargetType="TextBlock">
            <Setter Property="FontSize" Value="24"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>
        <Style x:Key="KpiTitle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
        </Style>
        <Style TargetType="DataGrid">
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="CanUserAddRows" Value="False"/>
            <Setter Property="CanUserDeleteRows" Value="False"/>
            <Setter Property="IsReadOnly" Value="True"/>
            <Setter Property="AutoGenerateColumns" Value="False"/>
            <Setter Property="GridLinesVisibility" Value="None"/>
        </Style>
    </Page.Resources>

    <Grid Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="White" Padding="15" Margin="10" CornerRadius="8">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="Từ ngày:" VerticalAlignment="Center" Margin="5"/>
                <DatePicker x:Name="dpStartDate" Width="150" VerticalAlignment="Center"/>
                <TextBlock Text="Đến ngày:" VerticalAlignment="Center" Margin="20,5,5,5"/>
                <DatePicker x:Name="dpEndDate" Width="150" VerticalAlignment="Center"/>
                <Button x:Name="btnGenerate" Content="Tạo Báo Cáo" Margin="20,0,0,0" Click="BtnGenerate_Click"/>
            </StackPanel>
        </Border>

        <Grid Grid.Row="1" Margin="10,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblDoanhThuRong" Text="0" Style="{StaticResource KpiValue}" Foreground="#42A5F5"/>
                    <TextBlock Text="Doanh Thu Ròng" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="1" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblTongGiaVon" Text="0" Style="{StaticResource KpiValue}" Foreground="#EF5350"/>
                    <TextBlock Text="Tổng Giá Vốn (COGS)" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="2" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblLoiNhuanGop" Text="0" Style="{StaticResource KpiValue}" Foreground="#FFA726"/>
                    <TextBlock Text="Lợi Nhuận Gộp" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="3" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblChiPhiOpex" Text="0" Style="{StaticResource KpiValue}" Foreground="#EF5350"/>
                    <TextBlock Text="Chi Phí Vận Hành" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="4" Style="{StaticResource KpiCard}" Margin="0">
                <StackPanel>
                    <TextBlock x:Name="lblLoiNhuanRong" Text="0" Style="{StaticResource KpiValue}" Foreground="#66BB6A"/>
                    <TextBlock Text="Lợi Nhuận Ròng (Dự kiến)" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
        </Grid>

        <TabControl Grid.Row="2" Margin="10">
            <TabItem Header="Top Sản phẩm Bán chạy">
                <DataGrid x:Name="dgTopSanPham">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Tên Sản Phẩm" Binding="{Binding TenSanPham}" Width="*"/>
                        <DataGridTextColumn Header="Tổng Số Lượng" Binding="{Binding TongSoLuongBan}" Width="150"/>
                        <DataGridTextColumn Header="Tổng Doanh Thu" Binding="{Binding TongDoanhThu, StringFormat=N0}" Width="200"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="Chi tiết Doanh thu">
                <DataGrid x:Name="dgChiTietDoanhThu" MaxHeight="300" VerticalAlignment="Top">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Chỉ số" Binding="{Binding Key}" Width="*" FontWeight="SemiBold"/>
                        <DataGridTextColumn Header="Giá trị" Binding="{Binding Value, StringFormat=N0}" Width="200"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="Chi tiết Chi phí &amp; Giá vốn">
                <DataGrid x:Name="dgChiTietChiPhi" MaxHeight="300" VerticalAlignment="Top">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Chỉ số" Binding="{Binding Key}" Width="*" FontWeight="SemiBold"/>
                        <DataGridTextColumn Header="Giá trị" Binding="{Binding Value, StringFormat=N0}" Width="200"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
        </TabControl>

        <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="25">
            <Button x:Name="btnBack" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" 
                    Click="BtnBack_Click">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="&lt; Quay lại" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>

            <Button x:Name="btnExportToExcel" 
                    Content="Xuất Excel" 
                    Margin="20,0,0,0" 
                    HorizontalAlignment="Right"
                    Click="BtnExportToExcel_Click" />
        </StackPanel>

        <Border x:Name="LoadingOverlay" Grid.Row="1" Grid.RowSpan="3" Background="#80FFFFFF" Visibility="Collapsed">
            <TextBlock Text="Đang tạo báo cáo..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\BaocaodoanhthuPreviewWindow.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Globalization;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;

// --- THÊM CÁC USING ĐỂ XUẤT EXCEL ---
using System.IO;
using Microsoft.Win32;
using OfficeOpenXml;
using OfficeOpenXml.Style;

namespace AppCafebookApi.View.common
{
    public partial class BaocaodoanhthuPreviewWindow : Page
    {
        private static readonly HttpClient httpClient;
        private BaoCaoTongHopDto? currentReportData;

        static BaocaodoanhthuPreviewWindow()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public BaocaodoanhthuPreviewWindow()
        {
            InitializeComponent();
        }

        private void Page_Loaded(object sender, RoutedEventArgs e)
        {
            var now = DateTime.Now;
            dpStartDate.SelectedDate = new DateTime(now.Year, now.Month, 1);
            dpEndDate.SelectedDate = now;
        }

        private async void BtnGenerate_Click(object sender, RoutedEventArgs e)
        {
            if (dpStartDate.SelectedDate == null || dpEndDate.SelectedDate == null)
            {
                MessageBox.Show("Vui lòng chọn cả Ngày bắt đầu và Ngày kết thúc.", "Thiếu thông tin");
                return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            btnGenerate.IsEnabled = false;

            var request = new BaoCaoRequestDto
            {
                StartDate = dpStartDate.SelectedDate.Value,
                EndDate = dpEndDate.SelectedDate.Value
            };

            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/baocao/doanhthu", request);
                if (response.IsSuccessStatusCode)
                {
                    currentReportData = await response.Content.ReadFromJsonAsync<BaoCaoTongHopDto>();
                    if (currentReportData != null)
                    {
                        PopulateUi(currentReportData);
                    }
                }
                else
                {
                    MessageBox.Show($"Lỗi API: {response.ReasonPhrase}", "Lỗi");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Không thể kết nối API: {ex.Message}", "Lỗi");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
                btnGenerate.IsEnabled = true;
            }
        }

        private void PopulateUi(BaoCaoTongHopDto data)
        {
            var culture = CultureInfo.GetCultureInfo("vi-VN");

            lblDoanhThuRong.Text = data.Kpi.DoanhThuRong.ToString("C0", culture);
            lblTongGiaVon.Text = data.Kpi.TongGiaVon.ToString("C0", culture);
            lblLoiNhuanGop.Text = data.Kpi.LoiNhuanGop.ToString("C0", culture);
            lblChiPhiOpex.Text = data.Kpi.ChiPhiOpex.ToString("C0", culture);
            lblLoiNhuanRong.Text = data.Kpi.LoiNhuanRong.ToString("C0", culture);

            dgTopSanPham.ItemsSource = data.TopSanPham;

            var dtList = new List<KeyValuePair<string, decimal>>
            {
                new("Tổng doanh thu gốc", data.ChiTietDoanhThu.TongDoanhThuGoc),
                new("Tổng giảm giá", data.ChiTietDoanhThu.TongGiamGia),
                new("Tổng phụ thu", data.ChiTietDoanhThu.TongPhuThu),
                new("DOANH THU RÒNG", data.ChiTietDoanhThu.DoanhThuRong),
                new("Tổng số hóa đơn", data.ChiTietDoanhThu.SoLuongHoaDon),
                new("Giá trị trung bình HĐ", data.ChiTietDoanhThu.GiaTriTrungBinhHD)
            };
            dgChiTietDoanhThu.ItemsSource = dtList;

            var cpList = new List<KeyValuePair<string, decimal>>
            {
                new("Tổng Giá Vốn Hàng Bán (COGS)", data.ChiTietChiPhi.TongGiaVon_COGS),
                new("Tổng Chi Phí Lương", data.ChiTietChiPhi.TongChiPhiLuong),
                new("Tổng Chi Phí Hủy Hàng", data.ChiTietChiPhi.TongChiPhiHuyHang)
            };
            dgChiTietChiPhi.ItemsSource = cpList;
        }

        private async void BtnExportToExcel_Click(object sender, RoutedEventArgs e)
        {
            if (currentReportData == null)
            {
                MessageBox.Show("Chưa có dữ liệu báo cáo để xuất. Vui lòng nhấn 'Tạo Báo Cáo' trước.", "Chưa có dữ liệu");
                return;
            }

            // SỬA LỖI CS8629: Kiểm tra null cho DatePicker ở đây
            if (dpStartDate.SelectedDate == null || dpEndDate.SelectedDate == null)
            {
                MessageBox.Show("Ngày bắt đầu hoặc kết thúc không hợp lệ.", "Lỗi");
                return;
            }

            var sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                FileName = $"BaoCaoDoanhThu_{DateTime.Now:yyyyMMdd_HHmm}.xlsx"
            };

            if (sfd.ShowDialog() == true)
            {
                try
                {
                    LoadingOverlay.Visibility = Visibility.Visible;

                    // SỬA LỖI CS8629: Truyền ngày vào hàm
                    await CreateExcelReportAsync(
                        sfd.FileName,
                        currentReportData,
                        dpStartDate.SelectedDate.Value,
                        dpEndDate.SelectedDate.Value);

                    LoadingOverlay.Visibility = Visibility.Collapsed;
                    MessageBox.Show($"Đã xuất báo cáo thành công!\n\nĐường dẫn: {sfd.FileName}", "Thành công", MessageBoxButton.OK, MessageBoxImage.Information);
                }
                catch (Exception ex)
                {
                    LoadingOverlay.Visibility = Visibility.Collapsed;
                    MessageBox.Show($"Có lỗi khi xuất Excel: {ex.Message}\n\nĐảm bảo bạn đã đóng file Excel (nếu nó đang mở).", "Lỗi Xuất File", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        // Dán đè lên hàm CreateExcelReportAsync CŨ của bạn
        private async Task CreateExcelReportAsync(string filePath, BaoCaoTongHopDto data, DateTime startDate, DateTime endDate)
        {
            // Giấy phép EPPlus
            ExcelPackage.License.SetNonCommercialPersonal("CafeBook");
            var fileInfo = new FileInfo(filePath);

            // Xóa file cũ nếu tồn tại
            if (fileInfo.Exists)
            {
                fileInfo.Delete();
            }

            using (var package = new ExcelPackage(fileInfo))
            {
                // --- 1. ĐỊNH NGHĨA CÁC STYLE TÁI SỬ DỤNG ---

                // Style cho Tiêu đề chính (Merge cell, to, đậm)
                Action<ExcelRange> styleMainTitle = (range) =>
                {
                    range.Merge = true;
                    range.Style.Font.Bold = true;
                    range.Style.Font.Size = 16;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    range.Style.Fill.PatternType = ExcelFillStyle.Solid;
                    range.Style.Fill.BackgroundColor.SetColor(System.Drawing.ColorTranslator.FromHtml("#333366")); // Xanh đậm
                    range.Style.Font.Color.SetColor(System.Drawing.Color.White);
                };

                // Style cho Tiêu đề phụ (Merge cell, nghiêng)
                Action<ExcelRange> styleSubTitle = (range) =>
                {
                    range.Merge = true;
                    range.Style.Font.Italic = true;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                };

                // Style cho Tiêu đề nhóm (Đậm, nền xám)
                Action<ExcelRange> styleGroupHeader = (range) =>
                {
                    range.Merge = true;
                    range.Style.Font.Bold = true;
                    range.Style.Fill.PatternType = ExcelFillStyle.Solid;
                    range.Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);
                };

                // Định dạng tiền tệ VND (canh phải)
                var currencyFormat = "#,##0 \"đ\"";
                Action<ExcelRange> styleCurrency = (range) =>
                {
                    range.Style.Numberformat.Format = currencyFormat;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                };

                // Style cho Lợi nhuận (Xanh, đậm)
                Action<ExcelRange> styleProfit = (range) =>
                {
                    styleCurrency(range);
                    range.Style.Font.Bold = true;
                    range.Style.Font.Color.SetColor(System.Drawing.Color.Green);
                };

                // Style cho Chi phí (Đỏ)
                Action<ExcelRange> styleExpense = (range) =>
                {
                    styleCurrency(range);
                    range.Style.Font.Color.SetColor(System.Drawing.Color.Red);
                };

                // --- 2. SHEET 1: BÁO CÁO TỔNG QUAN (P&L) ---
                var wsPL = package.Workbook.Worksheets.Add("Báo Cáo Tổng Quan");

                // Tiêu đề
                wsPL.Cells["A1:D1"].Value = "BÁO CÁO KINH DOANH TỔNG QUAN";
                styleMainTitle(wsPL.Cells["A1:D1"]);

                wsPL.Cells["A2:D2"].Value = $"Từ ngày {startDate:dd/MM/yyyy} đến {endDate:dd/MM/yyyy}";
                styleSubTitle(wsPL.Cells["A2:D2"]);

                // P&L (Lợi nhuận & Lỗ)
                wsPL.Cells["A4:B4"].Value = "KẾT QUẢ KINH DOANH CHÍNH (P&L)";
                styleGroupHeader(wsPL.Cells["A4:B4"]);

                wsPL.Cells["A5"].Value = "Doanh Thu Ròng";
                wsPL.Cells["B5"].Value = data.Kpi.DoanhThuRong;
                styleCurrency(wsPL.Cells["B5"]);

                wsPL.Cells["A6"].Value = "(-) Tổng Giá Vốn (COGS)";
                wsPL.Cells["B6"].Value = data.Kpi.TongGiaVon;
                styleExpense(wsPL.Cells["B6"]);

                wsPL.Cells["A7"].Value = "(=) Lợi Nhuận Gộp";
                wsPL.Cells["B7"].Value = data.Kpi.LoiNhuanGop;
                styleProfit(wsPL.Cells["B7"]); // Lợi nhuận gộp nên luôn là màu xanh

                wsPL.Cells["A8"].Value = "(-) Chi Phí Vận Hành (OPEX)";
                wsPL.Cells["B8"].Value = data.Kpi.ChiPhiOpex;
                styleExpense(wsPL.Cells["B8"]);

                wsPL.Cells["A9"].Value = "(=) LỢI NHUẬN RÒNG";
                wsPL.Cells["B9"].Value = data.Kpi.LoiNhuanRong;
                // Lợi nhuận ròng có thể âm hoặc dương
                if (data.Kpi.LoiNhuanRong >= 0)
                {
                    styleProfit(wsPL.Cells["B9"]);
                }
                else
                {
                    styleExpense(wsPL.Cells["B9"]);
                }
                wsPL.Cells["A9"].Style.Font.Bold = true;

                // Kẻ viền cho bảng P&L
                wsPL.Cells["A4:B9"].Style.Border.BorderAround(ExcelBorderStyle.Medium);

                // Chi tiết Doanh thu
                wsPL.Cells["D4:E4"].Value = "CHI TIẾT DOANH THU";
                styleGroupHeader(wsPL.Cells["D4:E4"]);
                wsPL.Cells["D5"].Value = "Tổng doanh thu gốc";
                wsPL.Cells["E5"].Value = data.ChiTietDoanhThu.TongDoanhThuGoc;
                wsPL.Cells["D6"].Value = "Tổng giảm giá";
                wsPL.Cells["E6"].Value = data.ChiTietDoanhThu.TongGiamGia;
                wsPL.Cells["D7"].Value = "Tổng phụ thu";
                wsPL.Cells["E7"].Value = data.ChiTietDoanhThu.TongPhuThu;
                wsPL.Cells["D8"].Value = "DOANH THU RÒNG";
                wsPL.Cells["E8"].Value = data.ChiTietDoanhThu.DoanhThuRong;
                wsPL.Cells["D8,E8"].Style.Font.Bold = true;

                wsPL.Cells["D10"].Value = "Số lượng hóa đơn";
                wsPL.Cells["E10"].Value = data.ChiTietDoanhThu.SoLuongHoaDon;
                wsPL.Cells["D11"].Value = "Giá trị trung bình HĐ";
                wsPL.Cells["E11"].Value = data.ChiTietDoanhThu.GiaTriTrungBinhHD;

                // Định dạng tiền tệ cho nhóm Doanh Thu
                styleCurrency(wsPL.Cells["E5:E8"]);
                styleCurrency(wsPL.Cells["E11"]);
                wsPL.Cells["E10"].Style.Numberformat.Format = "#,##0";
                wsPL.Cells["D4:E11"].Style.Border.BorderAround(ExcelBorderStyle.Medium);

                // Chi tiết Chi Phí
                wsPL.Cells["D13:E13"].Value = "CHI TIẾT CHI PHÍ";
                styleGroupHeader(wsPL.Cells["D13:E13"]);
                wsPL.Cells["D14"].Value = "Tổng Giá Vốn (COGS)";
                wsPL.Cells["E14"].Value = data.ChiTietChiPhi.TongGiaVon_COGS;
                wsPL.Cells["D15"].Value = "Tổng Chi Phí Lương";
                wsPL.Cells["E15"].Value = data.ChiTietChiPhi.TongChiPhiLuong;
                wsPL.Cells["D16"].Value = "Tổng Chi Phí Hủy Hàng";
                wsPL.Cells["E16"].Value = data.ChiTietChiPhi.TongChiPhiHuyHang;

                // Định dạng tiền tệ cho nhóm Chi Phí
                styleCurrency(wsPL.Cells["E14:E16"]);
                wsPL.Cells["D13:E16"].Style.Border.BorderAround(ExcelBorderStyle.Medium);

                // Tự động căn chỉnh cột
                wsPL.Cells[wsPL.Dimension.Address].AutoFitColumns();
                wsPL.Column(1).Width = 25; // Cột A
                wsPL.Column(2).Width = 20; // Cột B
                wsPL.Column(4).Width = 25; // Cột D
                wsPL.Column(5).Width = 20; // Cột E

                // --- 3. SHEET 2: TOP SẢN PHẨM ---
                var wsTop = package.Workbook.Worksheets.Add("Top Sản Phẩm");

                wsTop.Cells["A1:C1"].Value = "TOP SẢN PHẨM BÁN CHẠY";
                styleMainTitle(wsTop.Cells["A1:C1"]);

                wsTop.Cells["A2:C2"].Value = $"Từ ngày {startDate:dd/MM/yyyy} đến {endDate:dd/MM/yyyy}";
                styleSubTitle(wsTop.Cells["A2:C2"]);

                // Dùng LoadFromCollection để tạo bảng tự động
                wsTop.Cells["A4"].LoadFromCollection(data.TopSanPham, true, OfficeOpenXml.Table.TableStyles.Medium9);

                // Định dạng lại cột số lượng và tiền tệ trong bảng
                var tbl = wsTop.Tables[0];
                tbl.Columns["TongSoLuongBan"].TotalsRowFunction = OfficeOpenXml.Table.RowFunctions.Sum;
                wsTop.Cells[tbl.Address.Start.Row + 1, tbl.Columns["TongSoLuongBan"].Position + 1, tbl.Address.End.Row, tbl.Columns["TongSoLuongBan"].Position + 1].Style.Numberformat.Format = "#,##0";

                tbl.Columns["TongDoanhThu"].TotalsRowFunction = OfficeOpenXml.Table.RowFunctions.Sum;
                wsTop.Cells[tbl.Address.Start.Row + 1, tbl.Columns["TongDoanhThu"].Position + 1, tbl.Address.End.Row, tbl.Columns["TongDoanhThu"].Position + 1].Style.Numberformat.Format = currencyFormat;

                wsTop.Cells[wsTop.Dimension.Address].AutoFitColumns();

                // --- 4. LƯU FILE ---
                await package.SaveAsync();
            }
        }

        private void BtnBack_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\BaoCaoHieuSuatNhanVientPreview.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.common.BaoCaoHieuSuatNhanVientPreviewWindow"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.common"
      mc:Ignorable="d" 
      d:DesignHeight="720" d:DesignWidth="1000"
      Title="Báo cáo Hiệu suất Nhân viên"
      Background="#FFF8E1"
      FontFamily="Segoe UI"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>

        <Style TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,8"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="KpiCard" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="15"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="KpiValue" TargetType="TextBlock">
            <Setter Property="FontSize" Value="24"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>
        <Style x:Key="KpiTitle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
        </Style>
        <Style TargetType="DataGrid">
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="CanUserAddRows" Value="False"/>
            <Setter Property="CanUserDeleteRows" Value="False"/>
            <Setter Property="IsReadOnly" Value="True"/>
            <Setter Property="AutoGenerateColumns" Value="False"/>
            <Setter Property="GridLinesVisibility" Value="None"/>
        </Style>
    </Page.Resources>

    <Grid Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="White" Padding="15" Margin="10" CornerRadius="8">
            <WrapPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="Từ ngày:" VerticalAlignment="Center" Margin="5"/>
                <DatePicker x:Name="dpStartDate" Width="150" VerticalAlignment="Center" Margin="0,0,15,0"/>

                <TextBlock Text="Đến ngày:" VerticalAlignment="Center" Margin="5"/>
                <DatePicker x:Name="dpEndDate" Width="150" VerticalAlignment="Center" Margin="0,0,15,0"/>

                <TextBlock Text="Vai trò:" VerticalAlignment="Center" Margin="5"/>
                <ComboBox x:Name="cmbVaiTro" Width="150" VerticalAlignment="Center" Margin="0,0,15,0"
                          DisplayMemberPath="Ten" SelectedValuePath="Id"/>

                <TextBlock Text="Tên nhân viên:" VerticalAlignment="Center" Margin="5"/>
                <TextBox x:Name="txtSearchNhanVien" Width="150" VerticalAlignment="Center" Margin="0,0,15,0"/>

                <Button x:Name="btnGenerate" Content="Tạo Báo Cáo" Margin="20,15,0,0" Click="BtnGenerate_Click"/>
            </WrapPanel>
        </Border>

        <Grid Grid.Row="1" Margin="10,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblTongDoanhThu" Text="0" Style="{StaticResource KpiValue}" Foreground="#42A5F5"/>
                    <TextBlock Text="Tổng Doanh Thu (NV)" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="1" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblTongGioLam" Text="0" Style="{StaticResource KpiValue}" Foreground="#6F4E37"/>
                    <TextBlock Text="Tổng Giờ Làm (Đã CC)" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="2" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblTongSoCaLam" Text="0" Style="{StaticResource KpiValue}" Foreground="#66BB6A"/>
                    <TextBlock Text="Tổng Số Ca Làm" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="3" Style="{StaticResource KpiCard}" Margin="0">
                <StackPanel>
                    <TextBlock x:Name="lblTongLanHuyMon" Text="0" Style="{StaticResource KpiValue}" Foreground="#EF5350"/>
                    <TextBlock Text="Tổng Lần Hủy Món (Lỗi)" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
        </Grid>

        <TabControl x:Name="MainTabControl" Grid.Row="2" Margin="10">
            <TabItem Header="Hiệu suất Bán hàng">
                <DataGrid x:Name="dgSalesPerformance">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Tên Nhân Viên" Binding="{Binding HoTen}" Width="*"/>
                        <DataGridTextColumn Header="Vai Trò" Binding="{Binding TenVaiTro}" Width="120"/>
                        <DataGridTextColumn Header="Tổng Doanh Thu" Binding="{Binding TongDoanhThu, StringFormat=N0}" Width="130"/>
                        <DataGridTextColumn Header="Số HĐ" Binding="{Binding SoHoaDon}" Width="80"/>
                        <DataGridTextColumn Header="Doanh thu / HĐ" Binding="{Binding DoanhThuTrungBinh, StringFormat=N0}" Width="120"/>
                        <DataGridTextColumn Header="Số lần Hủy món" Binding="{Binding SoLanHuyMon}" Width="120"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="Hiệu suất Vận hành (Kho)">
                <DataGrid x:Name="dgOperationalPerformance">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Tên Nhân Viên" Binding="{Binding HoTen}" Width="*"/>
                        <DataGridTextColumn Header="Vai Trò" Binding="{Binding TenVaiTro}" Width="120"/>
                        <DataGridTextColumn Header="Số Phiếu Nhập" Binding="{Binding PhieuNhap}" Width="120"/>
                        <DataGridTextColumn Header="Số Phiếu Kiểm" Binding="{Binding PhieuKiem}" Width="120"/>
                        <DataGridTextColumn Header="Số Phiếu Hủy" Binding="{Binding PhieuHuy}" Width="120"/>
                        <DataGridTextColumn Header="Số Đơn Đã Duyệt" Binding="{Binding DonDuyet}" Width="120"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="Chuyên cần &amp; Vi phạm">
                <DataGrid x:Name="dgAttendance">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Tên Nhân Viên" Binding="{Binding HoTen}" Width="*"/>
                        <DataGridTextColumn Header="Tổng Số Ca Làm" Binding="{Binding TongSoCaLam}" Width="120"/>
                        <DataGridTextColumn Header="Tổng Giờ Làm (CC)" Binding="{Binding TongGioLam}" Width="140"/>
                        <DataGridTextColumn Header="Số Đơn Xin Nghỉ" Binding="{Binding SoDonXinNghi}" Width="120"/>
                        <DataGridTextColumn Header="Đã Duyệt" Binding="{Binding SoDonDaDuyet}" Width="100"/>
                        <DataGridTextColumn Header="Chờ Duyệt" Binding="{Binding SoDonChoDuyet}" Width="100"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
        </TabControl>

        <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="25">
            <Button x:Name="btnBack" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" 
                    Click="BtnBack_Click">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="&lt; Quay lại" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>

            <Button x:Name="btnExportToExcel" 
                    Content="Xuất Excel" 
                    Margin="20,0,0,0" 
                    HorizontalAlignment="Right"
                    Click="BtnExportToExcel_Click" />
        </StackPanel>

        <Border x:Name="LoadingOverlay" Grid.Row="1" Grid.RowSpan="3" Background="#80FFFFFF" Visibility="Collapsed">
            <TextBlock Text="Đang tạo báo cáo..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\BaoCaoHieuSuatNhanVientPreview.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.IO;
using Microsoft.Win32;
using OfficeOpenXml;
using OfficeOpenXml.Style;
using System.Threading.Tasks;
using Newtonsoft.Json.Linq; // Cần NuGet Newtonsoft.Json
using System.Globalization;
using System.Text.Json; // THÊM

namespace AppCafebookApi.View.common
{
    public partial class BaoCaoHieuSuatNhanVientPreviewWindow : Page
    {
        private static readonly HttpClient httpClient;
        private BaoCaoHieuSuatTongHopDto? currentReportData;

        static BaoCaoHieuSuatNhanVientPreviewWindow()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public BaoCaoHieuSuatNhanVientPreviewWindow()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            // Thiết lập ngày mặc định (ví dụ: tháng này)
            var now = DateTime.Now;
            dpStartDate.SelectedDate = new DateTime(now.Year, now.Month, 1);
            dpEndDate.SelectedDate = now;

            await LoadFiltersAsync();
            await GenerateReportAsync();
        }

        private async Task LoadFiltersAsync()
        {
            try
            {
                // SỬA: Dùng GetFromJsonAsync<JsonElement?>
                var response = await httpClient.GetFromJsonAsync<JsonElement?>("api/app/baocaohieusuat/filters");

                if (!response.HasValue) // SỬA: Dùng .HasValue
                {
                    MessageBox.Show("Không nhận được dữ liệu lọc.", "Lỗi API");
                    return;
                }

                // SỬA: Dùng .GetProperty().Deserialize<>()
                var vaiTros = response.Value.GetProperty("vaiTros").Deserialize<List<FilterLookupDto>>() ?? new List<FilterLookupDto>();

                vaiTros.Insert(0, new FilterLookupDto { Id = 0, Ten = "Tất cả Vai trò" });
                cmbVaiTro.ItemsSource = vaiTros;
                cmbVaiTro.SelectedValue = 0;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Không thể tải bộ lọc: {ex.Message}", "Lỗi API");
            }
        }

        private async void BtnGenerate_Click(object sender, RoutedEventArgs e)
        {
            await GenerateReportAsync();
        }

        private async Task GenerateReportAsync()
        {
            if (dpStartDate.SelectedDate == null || dpEndDate.SelectedDate == null)
            {
                MessageBox.Show("Vui lòng chọn cả Ngày bắt đầu và Ngày kết thúc.", "Thiếu thông tin");
                return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            btnGenerate.IsEnabled = false;

            var request = new BaoCaoHieuSuatRequestDto
            {
                StartDate = dpStartDate.SelectedDate.Value,
                EndDate = dpEndDate.SelectedDate.Value,
                SearchText = string.IsNullOrEmpty(txtSearchNhanVien.Text) ? null : txtSearchNhanVien.Text,
                VaiTroId = (int)cmbVaiTro.SelectedValue == 0 ? (int?)null : (int)cmbVaiTro.SelectedValue,
            };

            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/baocaohieusuat/report", request);
                if (response.IsSuccessStatusCode)
                {
                    currentReportData = await response.Content.ReadFromJsonAsync<BaoCaoHieuSuatTongHopDto>();
                    if (currentReportData != null)
                    {
                        PopulateUi(currentReportData);
                    }
                }
                else
                {
                    MessageBox.Show($"Lỗi API: {response.ReasonPhrase}", "Lỗi");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Không thể kết nối API: {ex.Message}", "Lỗi");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
                btnGenerate.IsEnabled = true;
            }
        }

        private void PopulateUi(BaoCaoHieuSuatTongHopDto data)
        {
            var culture = CultureInfo.GetCultureInfo("vi-VN");

            // 1. Cập nhật Thẻ KPI
            lblTongDoanhThu.Text = data.Kpi.TongDoanhThu.ToString("C0", culture);
            lblTongGioLam.Text = data.Kpi.TongGioLam.ToString("N1");
            lblTongSoCaLam.Text = data.Kpi.TongSoCaLam.ToString();
            lblTongLanHuyMon.Text = data.Kpi.TongLanHuyMon.ToString();

            // 2. Cập nhật các Tab
            dgSalesPerformance.ItemsSource = data.SalesPerformance;
            dgOperationalPerformance.ItemsSource = data.OperationalPerformance;
            dgAttendance.ItemsSource = data.Attendance;
        }

        // Dán đè lên hàm BtnExportToExcel_Click CŨ
        private async void BtnExportToExcel_Click(object sender, RoutedEventArgs e)
        {
            if (currentReportData == null)
            {
                MessageBox.Show("Chưa có dữ liệu báo cáo để xuất. Vui lòng nhấn 'Lọc Báo Cáo' trước.", "Chưa có dữ liệu");
                return;
            }

            // KIỂM TRA QUAN TRỌNG: Đảm bảo ngày đã được chọn
            if (dpStartDate.SelectedDate == null || dpEndDate.SelectedDate == null)
            {
                MessageBox.Show("Vui lòng chọn ngày bắt đầu và kết thúc hợp lệ.", "Lỗi ngày");
                return;
            }

            var sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                FileName = $"BaoCaoHieuSuatNV_{DateTime.Now:yyyyMMdd_HHmm}.xlsx"
            };

            if (sfd.ShowDialog() == true)
            {
                try
                {
                    LoadingOverlay.Visibility = Visibility.Visible;

                    // SỬA LỖI: Truyền ngày vào hàm
                    await CreateExcelReportAsync(
                        sfd.FileName,
                        currentReportData,
                        dpStartDate.SelectedDate.Value,
                        dpEndDate.SelectedDate.Value);

                    LoadingOverlay.Visibility = Visibility.Collapsed;

                    MessageBox.Show($"Đã xuất báo cáo thành công!\n\nĐường dẫn: {sfd.FileName}", "Thành công", MessageBoxButton.OK, MessageBoxImage.Information);
                }
                catch (Exception ex)
                {
                    LoadingOverlay.Visibility = Visibility.Collapsed;
                    MessageBox.Show($"Có lỗi khi xuất Excel: {ex.Message}\n\nĐảm bảo bạn đã đóng file Excel (nếu nó đang mở).", "Lỗi Xuất File", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        // Dán đè lên hàm CreateExcelReportAsync CŨ của bạn
        private async Task CreateExcelReportAsync(string filePath, BaoCaoHieuSuatTongHopDto data, DateTime startDate, DateTime endDate)
        {
            ExcelPackage.License.SetNonCommercialPersonal("CafeBook");
            var fileInfo = new FileInfo(filePath);

            if (fileInfo.Exists)
            {
                fileInfo.Delete(); // Xóa file cũ nếu tồn tại
            }

            using (var package = new ExcelPackage(fileInfo))
            {
                // --- 1. ĐỊNH NGHĨA STYLES & FORMATS ---
                var currencyFormat = "#,##0 \"đ\"";
                var numberFormat = "#,##0";
                var decimalFormat = "#,##0.0";
                var culture = CultureInfo.GetCultureInfo("vi-VN");

                // Style cho Tiêu đề chính (Merge cell, to, đậm, nền xanh)
                Action<ExcelRange> styleMainTitle = (range) =>
                {
                    range.Merge = true;
                    range.Style.Font.Bold = true;
                    range.Style.Font.Size = 16;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    range.Style.Fill.PatternType = ExcelFillStyle.Solid;
                    range.Style.Fill.BackgroundColor.SetColor(System.Drawing.ColorTranslator.FromHtml("#333366")); // Xanh đậm
                    range.Style.Font.Color.SetColor(System.Drawing.Color.White);
                };

                // Style cho Tiêu đề phụ (Merge cell, nghiêng)
                Action<ExcelRange> styleSubTitle = (range) =>
                {
                    range.Merge = true;
                    range.Style.Font.Italic = true;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                };

                // --- 2. SHEET 1: TỔNG QUAN (Sheet MỚI) ---
                var wsTongQuan = package.Workbook.Worksheets.Add("Tổng Quan Hiệu Suất");

                // Tiêu đề
                wsTongQuan.Cells["A1:D1"].Value = "BÁO CÁO TỔNG QUAN HIỆU SUẤT";
                styleMainTitle(wsTongQuan.Cells["A1:D1"]);

                wsTongQuan.Cells["A2:D2"].Value = $"Báo cáo cho kỳ từ {startDate:dd/MM/yyyy} đến {endDate:dd/MM/yyyy}";
                styleSubTitle(wsTongQuan.Cells["A2:D2"]);

                // Hiển thị KPIs
                wsTongQuan.Cells["A4"].Value = "CHỈ SỐ KPI TOÀN QUÁN";
                wsTongQuan.Cells["A4:B4"].Merge = true;
                wsTongQuan.Cells["A4:B4"].Style.Font.Bold = true;
                wsTongQuan.Cells["A4:B4"].Style.Fill.PatternType = ExcelFillStyle.Solid;
                wsTongQuan.Cells["A4:B4"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);

                wsTongQuan.Cells["A5"].Value = "Tổng Doanh Thu";
                wsTongQuan.Cells["B5"].Value = data.Kpi.TongDoanhThu;
                wsTongQuan.Cells["B5"].Style.Numberformat.Format = currencyFormat;

                wsTongQuan.Cells["A6"].Value = "Tổng Giờ Làm";
                wsTongQuan.Cells["B6"].Value = data.Kpi.TongGioLam;
                wsTongQuan.Cells["B6"].Style.Numberformat.Format = decimalFormat;

                wsTongQuan.Cells["A7"].Value = "Tổng Số Ca Làm";
                wsTongQuan.Cells["B7"].Value = data.Kpi.TongSoCaLam;
                wsTongQuan.Cells["B7"].Style.Numberformat.Format = numberFormat;

                wsTongQuan.Cells["A8"].Value = "Tổng Lần Hủy Món";
                wsTongQuan.Cells["B8"].Value = data.Kpi.TongLanHuyMon;
                wsTongQuan.Cells["B8"].Style.Numberformat.Format = numberFormat;
                if (data.Kpi.TongLanHuyMon > 0)
                {
                    wsTongQuan.Cells["A8:B8"].Style.Font.Color.SetColor(System.Drawing.Color.Red);
                    wsTongQuan.Cells["A8:B8"].Style.Font.Bold = true;
                }

                // CHỈ SỐ MỚI (QUAN TRỌNG)
                decimal doanhThuPerGioLam = (data.Kpi.TongGioLam > 0) ? (data.Kpi.TongDoanhThu / (decimal)data.Kpi.TongGioLam) : 0;
                wsTongQuan.Cells["A10"].Value = "HIỆU SUẤT (Doanh Thu / Giờ)";
                wsTongQuan.Cells["B10"].Value = doanhThuPerGioLam;
                wsTongQuan.Cells["B10"].Style.Numberformat.Format = currencyFormat;
                wsTongQuan.Cells["A10:B10"].Style.Font.Bold = true;
                wsTongQuan.Cells["A10:B10"].Style.Font.Color.SetColor(System.Drawing.Color.Green);

                // Kẻ viền
                wsTongQuan.Cells["A4:B8"].Style.Border.BorderAround(ExcelBorderStyle.Medium);
                wsTongQuan.Cells["A10:B10"].Style.Border.BorderAround(ExcelBorderStyle.Medium);

                wsTongQuan.Cells[wsTongQuan.Dimension.Address].AutoFitColumns();

                // --- 3. SHEET 2: HIỆU SUẤT BÁN HÀNG ---
                var ws1 = package.Workbook.Worksheets.Add("Hiệu Suất Bán Hàng");
                ws1.Cells["A1:F1"].Value = "Báo cáo Hiệu suất Bán hàng (Thu ngân, Phục vụ)";
                styleMainTitle(ws1.Cells["A1:F1"]);

                ws1.Cells["A3"].LoadFromCollection(data.SalesPerformance, true, OfficeOpenXml.Table.TableStyles.Medium9);
                var tbl1 = ws1.Tables[0];

                // Định dạng cột
                ws1.Cells[tbl1.Address.Start.Row + 1, tbl1.Columns["TongDoanhThu"].Position + 1, tbl1.Address.End.Row, tbl1.Columns["TongDoanhThu"].Position + 1].Style.Numberformat.Format = currencyFormat;
                ws1.Cells[tbl1.Address.Start.Row + 1, tbl1.Columns["SoHoaDon"].Position + 1, tbl1.Address.End.Row, tbl1.Columns["SoHoaDon"].Position + 1].Style.Numberformat.Format = numberFormat;
                ws1.Cells[tbl1.Address.Start.Row + 1, tbl1.Columns["DoanhThuTrungBinh"].Position + 1, tbl1.Address.End.Row, tbl1.Columns["DoanhThuTrungBinh"].Position + 1].Style.Numberformat.Format = currencyFormat;

                // Định dạng có điều kiện: Tô đỏ cột "Hủy Món" nếu > 0
                var huyMonColRange = ws1.Cells[tbl1.Address.Start.Row + 1, tbl1.Columns["SoLanHuyMon"].Position + 1, tbl1.Address.End.Row, tbl1.Columns["SoLanHuyMon"].Position + 1];
                huyMonColRange.Style.Numberformat.Format = numberFormat;
                var cfRuleHuyMon = huyMonColRange.ConditionalFormatting.AddGreaterThan();
                cfRuleHuyMon.Formula = "0";
                cfRuleHuyMon.Style.Font.Color.SetColor(System.Drawing.Color.Red);
                cfRuleHuyMon.Style.Font.Bold = true;

                ws1.Cells[ws1.Dimension.Address].AutoFitColumns();

                // --- 4. SHEET 3: HIỆU SUẤT VẬN HÀNH (Kho, Quản lý) ---
                var ws2 = package.Workbook.Worksheets.Add("Hiệu Suất Vận Hành");
                ws2.Cells["A1:F1"].Value = "Báo cáo Hiệu suất Vận hành (Kho, Quản lý)";
                styleMainTitle(ws2.Cells["A1:F1"]);

                ws2.Cells["A3"].LoadFromCollection(data.OperationalPerformance, true, OfficeOpenXml.Table.TableStyles.Medium10);
                var tbl2 = ws2.Tables[0];

                // Định dạng số
                ws2.Cells[tbl2.Address.Start.Row + 1, 3, tbl2.Address.End.Row, tbl2.Address.End.Column].Style.Numberformat.Format = numberFormat;

                ws2.Cells[ws2.Dimension.Address].AutoFitColumns();

                // --- 5. SHEET 4: CHUYÊN CẦN ---
                var ws3 = package.Workbook.Worksheets.Add("Báo Cáo Chuyên Cần");
                ws3.Cells["A1:F1"].Value = "Báo cáo Chuyên cần & Vi phạm";
                styleMainTitle(ws3.Cells["A1:F1"]);

                ws3.Cells["A3"].LoadFromCollection(data.Attendance, true, OfficeOpenXml.Table.TableStyles.Medium11);
                var tbl3 = ws3.Tables[0];

                // Định dạng cột
                ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["TongGioLam"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["TongGioLam"].Position + 1].Style.Numberformat.Format = decimalFormat;
                ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["TongSoCaLam"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["TongSoCaLam"].Position + 1].Style.Numberformat.Format = numberFormat;
                ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["SoDonXinNghi"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["SoDonXinNghi"].Position + 1].Style.Numberformat.Format = numberFormat;
                ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["SoDonDaDuyet"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["SoDonDaDuyet"].Position + 1].Style.Numberformat.Format = numberFormat;

                // Định dạng có điều kiện: Tô vàng cột "Chờ Duyệt" nếu > 0 (để quản lý chú ý)
                var choDuyetColRange = ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["SoDonChoDuyet"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["SoDonChoDuyet"].Position + 1];
                choDuyetColRange.Style.Numberformat.Format = numberFormat;
                var cfRuleChoDuyet = choDuyetColRange.ConditionalFormatting.AddGreaterThan();
                cfRuleChoDuyet.Formula = "0";
                cfRuleChoDuyet.Style.Fill.PatternType = ExcelFillStyle.Solid;
                cfRuleChoDuyet.Style.Fill.BackgroundColor.Color = System.Drawing.Color.LightGoldenrodYellow;
                cfRuleChoDuyet.Style.Font.Bold = true;

                ws3.Cells[ws3.Dimension.Address].AutoFitColumns();

                // --- 6. LƯU FILE ---
                await package.SaveAsync();
            }
        }

        private void BtnBack_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\BaoCaoTonKhoNguyenLieuPreviewWindow.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.common.BaoCaoTonKhoNguyenLieuPreviewWindow"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.common"
      mc:Ignorable="d" 
      d:DesignHeight="720" d:DesignWidth="1000"
      Title="Báo cáo Tồn kho Nguyên liệu"
      Background="#FFF8E1"
      FontFamily="Segoe UI"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>

        <Style TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,8"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="KpiCard" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="15"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="KpiValue" TargetType="TextBlock">
            <Setter Property="FontSize" Value="24"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>
        <Style x:Key="KpiTitle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
        </Style>
        <Style TargetType="DataGrid">
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="CanUserAddRows" Value="False"/>
            <Setter Property="CanUserDeleteRows" Value="False"/>
            <Setter Property="IsReadOnly" Value="True"/>
            <Setter Property="AutoGenerateColumns" Value="False"/>
            <Setter Property="GridLinesVisibility" Value="None"/>
        </Style>
    </Page.Resources>

    <Grid Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="White" Padding="15" Margin="10" CornerRadius="8">
            <WrapPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="Tên Nguyên liệu:" VerticalAlignment="Center" Margin="5"/>
                <TextBox x:Name="txtSearch" Width="200" VerticalAlignment="Center" Margin="0,0,15,0"/>

                <TextBlock Text="Nhà Cung cấp:" VerticalAlignment="Center" Margin="5"/>
                <ComboBox x:Name="cmbNhaCungCap" Width="180" VerticalAlignment="Center" Margin="0,0,15,0"
                          DisplayMemberPath="Ten" SelectedValuePath="Id"/>

                <CheckBox x:Name="chkLowStockOnly" Content="Chỉ hiển thị hàng sắp hết" 
                          VerticalAlignment="Center" Margin="15,0,0,0"/>

                    <Button x:Name="btnGenerate" Content="Lọc Báo Cáo" Margin="20,0,0,0" Click="BtnGenerate_Click"/>
            </WrapPanel>
        </Border>

        <Grid Grid.Row="1" Margin="10,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblGiaTriTonKho" Text="0" Style="{StaticResource KpiValue}" Foreground="#42A5F5"/>
                    <TextBlock Text="Tổng Giá Trị Tồn Kho" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="1" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblSPSapHet" Text="0" Style="{StaticResource KpiValue}" Foreground="#FFA726"/>
                    <TextBlock Text="Số Lượng SP Sắp Hết" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="2" Style="{StaticResource KpiCard}" Margin="0">
                <StackPanel>
                    <TextBlock x:Name="lblGiaTriDaHuy" Text="0" Style="{StaticResource KpiValue}" Foreground="#EF5350"/>
                    <TextBlock Text="Tổng Giá Trị Đã Hủy (30 ngày)" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
        </Grid>

        <TabControl x:Name="MainTabControl" Grid.Row="2" Margin="10">
            <TabItem Header="Báo cáo Tồn kho Hiện tại">
                <DataGrid x:Name="dgInventory">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Tên Nguyên Liệu" Binding="{Binding TenNguyenLieu}" Width="*"/> 
                        <DataGridTextColumn Header="Đơn vị tính" Binding="{Binding DonViTinh}" Width="100"/> 
                        <DataGridTextColumn Header="Tồn kho (HT)" Binding="{Binding TonKho}" Width="120"/> 
                        <DataGridTextColumn Header="Tồn kho Tối thiểu" Binding="{Binding TonKhoToiThieu}" Width="120"/> 
                        <DataGridTextColumn Header="Tình Trạng" Binding="{Binding TinhTrang}" Width="120"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="Lịch sử Kiểm Kê (Chênh lệch)">
                <DataGrid x:Name="dgAuditHistory">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Ngày Kiểm" Binding="{Binding NgayKiem, StringFormat='dd/MM/yyyy'}" Width="120"/>
                        <DataGridTextColumn Header="Tên Nguyên Liệu" Binding="{Binding TenNguyenLieu}" Width="*"/> 
                        <DataGridTextColumn Header="Tồn (Hệ thống)" Binding="{Binding TonKhoHeThong}" Width="120"/> 
                        <DataGridTextColumn Header="Tồn (Thực tế)" Binding="{Binding TonKhoThucTe}" Width="120"/> 
                        <DataGridTextColumn Header="Chênh lệch" Binding="{Binding ChenhLech}" Width="120"/> 
                        <DataGridTextColumn Header="Lý do" Binding="{Binding LyDoChenhLech}" Width="200"/> 
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="Lịch sử Hủy Hàng">
                <DataGrid x:Name="dgWasteHistory">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Ngày Hủy" Binding="{Binding NgayHuy, StringFormat='dd/MM/yyyy'}" Width="120"/>
                        <DataGridTextColumn Header="Tên Nguyên Liệu" Binding="{Binding TenNguyenLieu}" Width="*"/>
                        <DataGridTextColumn Header="Số Lượng Hủy" Binding="{Binding SoLuongHuy}" Width="120"/> 
                        <DataGridTextColumn Header="Giá trị Hủy" Binding="{Binding GiaTriHuy, StringFormat=N0}" Width="120"/> 
                        <DataGridTextColumn Header="Lý do Hủy" Binding="{Binding LyDoHuy}" Width="250"/> 
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
        </TabControl>

        <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="25">
            <Button x:Name="btnBack" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" 
                    Click="BtnBack_Click">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="&lt; Quay lại" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>

            <Button x:Name="btnExportToExcel" 
                    Content="Xuất Excel" 
                    Margin="20,0,0,0" 
                    HorizontalAlignment="Right"
                    Click="BtnExportToExcel_Click" />
        </StackPanel>

        <Border x:Name="LoadingOverlay" Grid.Row="1" Grid.RowSpan="3" Background="#80FFFFFF" Visibility="Collapsed">
            <TextBlock Text="Đang tạo báo cáo..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\BaoCaoTonKhoNguyenLieuPreviewWindow.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.IO;
using Microsoft.Win32;
using OfficeOpenXml;
using OfficeOpenXml.Style;
using System.Threading.Tasks;
using Newtonsoft.Json.Linq; // Cần NuGet Newtonsoft.Json
using System.Globalization;
using System.Text.Json; // THÊM

namespace AppCafebookApi.View.common
{
    public partial class BaoCaoTonKhoNguyenLieuPreviewWindow : Page
    {
        private static readonly HttpClient httpClient;
        private BaoCaoTonKhoTongHopDto? currentReportData;

        static BaoCaoTonKhoNguyenLieuPreviewWindow()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public BaoCaoTonKhoNguyenLieuPreviewWindow()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadFiltersAsync();
            await GenerateReportAsync();
        }

        private async Task LoadFiltersAsync()
        {
            try
            {
                // SỬA: Dùng GetFromJsonAsync<JsonElement?>
                var response = await httpClient.GetFromJsonAsync<JsonElement?>("api/app/baocaohieusuat/filters");

                if (!response.HasValue) // SỬA: Dùng .HasValue
                {
                    MessageBox.Show("Không nhận được dữ liệu lọc.", "Lỗi API");
                    return;
                }

                // SỬA: Dùng .GetProperty().Deserialize<>()
                var vaiTros = response.Value.GetProperty("vaiTros").Deserialize<List<FilterLookupDto>>() ?? new List<FilterLookupDto>();

                vaiTros.Insert(0, new FilterLookupDto { Id = 0, Ten = "Tất cả Vai trò" });
                cmbNhaCungCap.ItemsSource = vaiTros;
                cmbNhaCungCap.SelectedValue = 0;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Không thể tải bộ lọc: {ex.Message}", "Lỗi API");
            }
        }

        private async void BtnGenerate_Click(object sender, RoutedEventArgs e)
        {
            await GenerateReportAsync();
        }

        private async Task GenerateReportAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            btnGenerate.IsEnabled = false;

            var request = new BaoCaoTonKhoRequestDto
            {
                SearchText = string.IsNullOrEmpty(txtSearch.Text) ? null : txtSearch.Text,
                NhaCungCapId = (int)cmbNhaCungCap.SelectedValue == 0 ? (int?)null : (int)cmbNhaCungCap.SelectedValue,
                ShowLowStockOnly = chkLowStockOnly.IsChecked ?? false
            };

            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/baocaokho/report", request);
                if (response.IsSuccessStatusCode)
                {
                    currentReportData = await response.Content.ReadFromJsonAsync<BaoCaoTonKhoTongHopDto>();
                    if (currentReportData != null)
                    {
                        PopulateUi(currentReportData);
                    }
                }
                else
                {
                    MessageBox.Show($"Lỗi API: {response.ReasonPhrase}", "Lỗi");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Không thể kết nối API: {ex.Message}", "Lỗi");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
                btnGenerate.IsEnabled = true;
            }
        }

        private void PopulateUi(BaoCaoTonKhoTongHopDto data)
        {
            var culture = CultureInfo.GetCultureInfo("vi-VN");

            // 1. Cập nhật Thẻ KPI
            lblGiaTriTonKho.Text = data.Kpi.TongGiaTriTonKho.ToString("C0", culture);
            lblSPSapHet.Text = data.Kpi.SoLuongSPSapHet.ToString();
            lblGiaTriDaHuy.Text = data.Kpi.TongGiaTriDaHuy.ToString("C0", culture);

            // 2. Cập nhật các Tab
            dgInventory.ItemsSource = data.ChiTietTonKho;
            dgAuditHistory.ItemsSource = data.LichSuKiemKe;
            dgWasteHistory.ItemsSource = data.LichSuHuyHang;
        }

        private async void BtnExportToExcel_Click(object sender, RoutedEventArgs e)
        {
            if (currentReportData == null)
            {
                MessageBox.Show("Chưa có dữ liệu báo cáo để xuất. Vui lòng nhấn 'Lọc Báo Cáo' trước.", "Chưa có dữ liệu");
                return;
            }

            var sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                FileName = $"BaoCaoTonKhoNguyenLieu_{DateTime.Now:yyyyMMdd_HHmm}.xlsx"
            };

            if (sfd.ShowDialog() == true)
            {
                try
                {
                    LoadingOverlay.Visibility = Visibility.Visible;
                    await CreateExcelReportAsync(sfd.FileName, currentReportData);
                    LoadingOverlay.Visibility = Visibility.Collapsed;

                    MessageBox.Show($"Đã xuất báo cáo thành công!\n\nĐường dẫn: {sfd.FileName}", "Thành công", MessageBoxButton.OK, MessageBoxImage.Information);
                }
                catch (Exception ex)
                {
                    LoadingOverlay.Visibility = Visibility.Collapsed;
                    MessageBox.Show($"Có lỗi khi xuất Excel: {ex.Message}\n\nĐảm bảo bạn đã đóng file Excel (nếu nó đang mở).", "Lỗi Xuất File", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        // Dán đè lên hàm CreateExcelReportAsync CŨ của bạn
        private async Task CreateExcelReportAsync(string filePath, BaoCaoTonKhoTongHopDto data)
        {
            ExcelPackage.License.SetNonCommercialPersonal("CafeBook");
            var fileInfo = new FileInfo(filePath);

            if (fileInfo.Exists)
            {
                fileInfo.Delete(); // Xóa file cũ nếu tồn tại để tránh lỗi
            }

            using (var package = new ExcelPackage(fileInfo))
            {
                // --- 1. ĐỊNH NGHĨA CÁC STYLE TÁI SỬ DỤNG ---

                // Định dạng tiền tệ VND
                var currencyFormat = "#,##0 \"đ\"";
                // Định dạng số nguyên
                var numberFormat = "#,##0";
                // Định dạng số thập phân (cho kg, lít,...)
                var decimalFormat = "#,##0.00";
                // Định dạng ngày
                var dateFormat = "dd/MM/yyyy";

                // Style cho Tiêu đề chính (Merge cell, to, đậm, nền xanh)
                Action<ExcelRange> styleMainTitle = (range) =>
                {
                    range.Merge = true;
                    range.Style.Font.Bold = true;
                    range.Style.Font.Size = 16;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    range.Style.Fill.PatternType = ExcelFillStyle.Solid;
                    range.Style.Fill.BackgroundColor.SetColor(System.Drawing.ColorTranslator.FromHtml("#333366")); // Xanh đậm
                    range.Style.Font.Color.SetColor(System.Drawing.Color.White);
                };

                // Style cho Tiêu đề phụ (Merge cell, nghiêng)
                Action<ExcelRange> styleSubTitle = (range) =>
                {
                    range.Merge = true;
                    range.Style.Font.Italic = true;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                };

                // --- 2. SHEET 1: TỔNG QUAN KHO (Sheet MỚI) ---
                var wsTongQuan = package.Workbook.Worksheets.Add("Tổng Quan Kho");

                // Tiêu đề
                wsTongQuan.Cells["A1:C1"].Value = "BÁO CÁO TỔNG QUAN KHO";
                styleMainTitle(wsTongQuan.Cells["A1:C1"]);

                wsTongQuan.Cells["A2:C2"].Value = $"Báo cáo tạo lúc: {DateTime.Now:dd/MM/yyyy HH:mm}";
                styleSubTitle(wsTongQuan.Cells["A2:C2"]);

                // Hiển thị KPIs
                wsTongQuan.Cells["A4"].Value = "CHỈ SỐ QUAN TRỌNG";
                wsTongQuan.Cells["A4:B4"].Merge = true;
                wsTongQuan.Cells["A4:B4"].Style.Font.Bold = true;
                wsTongQuan.Cells["A4:B4"].Style.Fill.PatternType = ExcelFillStyle.Solid;
                wsTongQuan.Cells["A4:B4"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);

                wsTongQuan.Cells["A5"].Value = "Tổng Giá Trị Tồn Kho";
                wsTongQuan.Cells["B5"].Value = data.Kpi.TongGiaTriTonKho;
                wsTongQuan.Cells["B5"].Style.Numberformat.Format = currencyFormat;
                wsTongQuan.Cells["B5"].Style.Font.Bold = true;

                wsTongQuan.Cells["A6"].Value = "SL Nguyên Liệu Sắp Hết";
                wsTongQuan.Cells["B6"].Value = data.Kpi.SoLuongSPSapHet;
                wsTongQuan.Cells["B6"].Style.Numberformat.Format = numberFormat;

                // Tô màu cảnh báo nếu có hàng sắp hết
                if (data.Kpi.SoLuongSPSapHet > 0)
                {
                    wsTongQuan.Cells["B6"].Style.Font.Color.SetColor(System.Drawing.Color.OrangeRed);
                    wsTongQuan.Cells["B6"].Style.Font.Bold = true;
                }

                wsTongQuan.Cells["A7"].Value = "Giá Trị Hủy (30 ngày qua)";
                wsTongQuan.Cells["B7"].Value = data.Kpi.TongGiaTriDaHuy;
                wsTongQuan.Cells["B7"].Style.Numberformat.Format = currencyFormat;

                // Tô màu đỏ nếu có hàng bị hủy
                if (data.Kpi.TongGiaTriDaHuy > 0)
                {
                    wsTongQuan.Cells["B7"].Style.Font.Color.SetColor(System.Drawing.Color.Red);
                    wsTongQuan.Cells["B7"].Style.Font.Bold = true;
                }

                // Kẻ viền cho bảng KPI
                wsTongQuan.Cells["A4:B7"].Style.Border.BorderAround(ExcelBorderStyle.Medium);
                wsTongQuan.Cells[wsTongQuan.Dimension.Address].AutoFitColumns();

                // --- 3. SHEET 2: CHI TIẾT TỒN KHO ---
                var ws1 = package.Workbook.Worksheets.Add("Chi Tiết Tồn Kho");
                ws1.Cells["A1:E1"].Value = "Báo cáo Tồn kho Nguyên liệu Chi tiết";
                styleMainTitle(ws1.Cells["A1:E1"]);

                // Load dữ liệu vào Bảng (Table)
                ws1.Cells["A3"].LoadFromCollection(data.ChiTietTonKho, true, OfficeOpenXml.Table.TableStyles.Medium9);
                var tbl1 = ws1.Tables[0];

                // Định dạng số cho các cột trong bảng
                ws1.Cells[tbl1.Address.Start.Row + 1, tbl1.Columns["tonKho"].Position + 1, tbl1.Address.End.Row, tbl1.Columns["tonKho"].Position + 1].Style.Numberformat.Format = decimalFormat;
                ws1.Cells[tbl1.Address.Start.Row + 1, tbl1.Columns["TonKhoToiThieu"].Position + 1, tbl1.Address.End.Row, tbl1.Columns["TonKhoToiThieu"].Position + 1].Style.Numberformat.Format = decimalFormat;

                // *** ĐỊNH DẠNG CÓ ĐIỀU KIỆN (CONDITIONAL FORMATTING) ***
                // Tự động tô màu các dòng dựa trên "TinhTrang"
                var tinhTrangCol = tbl1.Columns["TinhTrang"].Position + 1;
                // Vùng áp dụng: toàn bộ bảng
                var dataRange1 = new ExcelAddress(tbl1.Address.Start.Row + 1, 1, tbl1.Address.End.Row, tbl1.Address.End.Column);

                // Quy tắc 1: Hết hàng
                var ruleHetHang = ws1.ConditionalFormatting.AddExpression(dataRange1);
                ruleHetHang.Formula = $"${ExcelCellAddress.GetColumnLetter(tinhTrangCol)}{dataRange1.Start.Row}=\"Hết hàng\"";
                ruleHetHang.Style.Fill.BackgroundColor.Color = System.Drawing.Color.IndianRed;
                ruleHetHang.Style.Font.Color.Color = System.Drawing.Color.White;

                // Quy tắc 2: Sắp hết
                var ruleSapHet = ws1.ConditionalFormatting.AddExpression(dataRange1);
                ruleSapHet.Formula = $"${ExcelCellAddress.GetColumnLetter(tinhTrangCol)}{dataRange1.Start.Row}=\"Sắp hết\"";
                ruleSapHet.Style.Fill.BackgroundColor.Color = System.Drawing.Color.LightGoldenrodYellow;

                ws1.Cells[ws1.Dimension.Address].AutoFitColumns();

                // --- 4. SHEET 3: LỊCH SỬ KIỂM KÊ ---
                var ws2 = package.Workbook.Worksheets.Add("Lịch Sử Kiểm Kê");
                ws2.Cells["A1:F1"].Value = "Lịch sử Kiểm Kê (Chênh lệch)";
                styleMainTitle(ws2.Cells["A1:F1"]);

                ws2.Cells["A3"].LoadFromCollection(data.LichSuKiemKe, true, OfficeOpenXml.Table.TableStyles.Medium10);
                var tbl2 = ws2.Tables[0];

                // Định dạng cột ngày
                var ngayKiemColRange = ws2.Cells[tbl2.Address.Start.Row + 1, tbl2.Columns["NgayKiem"].Position + 1, tbl2.Address.End.Row, tbl2.Columns["NgayKiem"].Position + 1];
                ngayKiemColRange.Style.Numberformat.Format = dateFormat;

                // Định dạng các cột số lượng
                ws2.Cells[tbl2.Address.Start.Row + 1, tbl2.Columns["TonKhoHeThong"].Position + 1, tbl2.Address.End.Row, tbl2.Columns["TonKhoHeThong"].Position + 1].Style.Numberformat.Format = decimalFormat;
                ws2.Cells[tbl2.Address.Start.Row + 1, tbl2.Columns["TonKhoThucTe"].Position + 1, tbl2.Address.End.Row, tbl2.Columns["TonKhoThucTe"].Position + 1].Style.Numberformat.Format = decimalFormat;

                // Định dạng có điều kiện cho cột Chênh Lệch
                var chenhLechColRange = ws2.Cells[tbl2.Address.Start.Row + 1, tbl2.Columns["ChenhLech"].Position + 1, tbl2.Address.End.Row, tbl2.Columns["ChenhLech"].Position + 1];
                chenhLechColRange.Style.Numberformat.Format = decimalFormat;
                // Tô đỏ nếu < 0 (mất mát)
                var cfRuleLoss = chenhLechColRange.ConditionalFormatting.AddLessThan();
                cfRuleLoss.Formula = "0"; // Gán giá trị so sánh là "0"
                cfRuleLoss.Style.Font.Color.Color = System.Drawing.Color.Red;
                // Tô xanh nếu > 0 (dư)
                var cfRuleGain = chenhLechColRange.ConditionalFormatting.AddGreaterThan();
                cfRuleGain.Formula = "0"; // Gán giá trị so sánh là "0"
                cfRuleGain.Style.Font.Color.Color = System.Drawing.Color.Green;

                ws2.Cells[ws2.Dimension.Address].AutoFitColumns();

                // --- 5. SHEET 4: LỊCH SỬ HỦY HÀNG ---
                var ws3 = package.Workbook.Worksheets.Add("Lịch Sử Hủy Hàng");
                ws3.Cells["A1:E1"].Value = "Lịch sử Hủy Hàng";
                styleMainTitle(ws3.Cells["A1:E1"]);

                ws3.Cells["A3"].LoadFromCollection(data.LichSuHuyHang, true, OfficeOpenXml.Table.TableStyles.Medium11);
                var tbl3 = ws3.Tables[0];

                // Định dạng cột ngày
                var ngayHuyColRange = ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["NgayHuy"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["NgayHuy"].Position + 1];
                ngayHuyColRange.Style.Numberformat.Format = dateFormat;

                // Định dạng cột số lượng hủy
                ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["SoLuongHuy"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["SoLuongHuy"].Position + 1].Style.Numberformat.Format = decimalFormat;

                // Định dạng cột giá trị hủy (tiền tệ)
                var giaTriHuyColRange = ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["GiaTriHuy"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["GiaTriHuy"].Position + 1];
                giaTriHuyColRange.Style.Numberformat.Format = currencyFormat;
                // Tô màu đỏ cho giá trị hủy
                var cfRuleHuy = giaTriHuyColRange.ConditionalFormatting.AddGreaterThan();
                cfRuleHuy.Formula = "0"; // Gán giá trị so sánh là "0"
                cfRuleHuy.Style.Font.Color.Color = System.Drawing.Color.Red;

                ws3.Cells[ws3.Dimension.Address].AutoFitColumns();

                // --- 6. LƯU FILE ---
                await package.SaveAsync();
            }
        }

        private void BtnBack_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\BapCaoTonKhoSachPreviewWindow.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.common.BapCaoTonKhoSachPreviewWindow"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.common"
      mc:Ignorable="d" 
      d:DesignHeight="720" d:DesignWidth="1000"
      Title="Báo cáo Tồn kho Sách"
      Background="#FFF8E1"
      FontFamily="Segoe UI"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>

        <Style TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,8"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="KpiCard" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="15"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="KpiValue" TargetType="TextBlock">
            <Setter Property="FontSize" Value="24"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>
        <Style x:Key="KpiTitle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
        </Style>
        <Style TargetType="DataGrid">
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="CanUserAddRows" Value="False"/>
            <Setter Property="CanUserDeleteRows" Value="False"/>
            <Setter Property="IsReadOnly" Value="True"/>
            <Setter Property="AutoGenerateColumns" Value="False"/>
            <Setter Property="GridLinesVisibility" Value="None"/>
        </Style>
    </Page.Resources>

    <Grid Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="White" Padding="15" Margin="10" CornerRadius="8">
            <WrapPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="Tên sách:" VerticalAlignment="Center" Margin="5"/>
                <TextBox x:Name="txtSearch" Width="200" VerticalAlignment="Center" Margin="0,0,15,0"/>

                <TextBlock Text="Thể loại:" VerticalAlignment="Center" Margin="5"/>
                <ComboBox x:Name="cmbTheLoai" Width="150" VerticalAlignment="Center" Margin="0,0,15,0"
                          DisplayMemberPath="Ten" SelectedValuePath="Id"/>

                <TextBlock Text="Tác giả:" VerticalAlignment="Center" Margin="5"/>
                <ComboBox x:Name="cmbTacGia" Width="150" VerticalAlignment="Center" Margin="0,0,15,0"
                          DisplayMemberPath="Ten" SelectedValuePath="Id"/>

                <Button x:Name="btnGenerate" Content="Lọc Báo Cáo" Margin="20,0,0,0" Click="BtnGenerate_Click"/>
            </WrapPanel>
        </Border>

        <Grid Grid.Row="1" Margin="10,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblTongDauSach" Text="0" Style="{StaticResource KpiValue}" Foreground="#42A5F5"/>
                    <TextBlock Text="Tổng Đầu Sách" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="1" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblTongSoLuong" Text="0" Style="{StaticResource KpiValue}" Foreground="#6F4E37"/>
                    <TextBlock Text="Tổng Số Lượng Sách" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="2" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblDangChoThue" Text="0" Style="{StaticResource KpiValue}" Foreground="#EF5350"/>
                    <TextBlock Text="Đang Cho Thuê" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="3" Style="{StaticResource KpiCard}" Margin="0">
                <StackPanel>
                    <TextBlock x:Name="lblSanSang" Text="0" Style="{StaticResource KpiValue}" Foreground="#66BB6A"/>
                    <TextBlock Text="Sẵn Sàng" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
        </Grid>

        <TabControl x:Name="MainTabControl" Grid.Row="2" Margin="10">
            <TabItem Header="Báo cáo Tồn kho Chi tiết">
                <DataGrid x:Name="dgInventoryDetails">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Tên Sách" Binding="{Binding TenSach}" Width="*"/>
                        <DataGridTextColumn Header="Tác Giả" Binding="{Binding TenTacGia}" Width="150"/>
                        <DataGridTextColumn Header="Thể Loại" Binding="{Binding TenTheLoai}" Width="150"/>
                        <DataGridTextColumn Header="Tổng SL" Binding="{Binding SoLuongTong}" Width="80"/>
                        <DataGridTextColumn Header="Đang Thuê" Binding="{Binding SoLuongDangMuon}" Width="80"/>
                        <DataGridTextColumn Header="Còn Lại" Binding="{Binding SoLuongConLai}" Width="80"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="Sách Đang Thuê &amp; Trễ Hạn">
                <DataGrid x:Name="dgRentedOverdue">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Tên Sách" Binding="{Binding TenSach}" Width="*"/>
                        <DataGridTextColumn Header="Khách Hàng" Binding="{Binding HoTen}" Width="150"/>
                        <DataGridTextColumn Header="SĐT Khách" Binding="{Binding SoDienThoai}" Width="120"/>
                        <DataGridTextColumn Header="Ngày Thuê" Binding="{Binding NgayThue, StringFormat='dd/MM/yyyy'}" Width="120"/>
                        <DataGridTextColumn Header="Ngày Hẹn Trả" Binding="{Binding NgayHenTra, StringFormat='dd/MM/yyyy'}" Width="120"/>
                        <DataGridTextColumn Header="Tình Trạng" Binding="{Binding TinhTrang}" Width="120"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="Top Sách Được Thuê Nhiều Nhất">
                <DataGrid x:Name="dgTopRented">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Tên Sách" Binding="{Binding TenSach}" Width="*"/>
                        <DataGridTextColumn Header="Tác Giả" Binding="{Binding TenTacGia}" Width="200"/>
                        <DataGridTextColumn Header="Tổng Lượt Thuê" Binding="{Binding TongLuotThue}" Width="150"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
        </TabControl>

        <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="25">
            <Button x:Name="btnBack" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" 
                    Click="BtnBack_Click">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="&lt; Quay lại" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>

            <Button x:Name="btnExportToExcel" 
                    Content="Xuất Excel" 
                    Margin="20,0,0,0" 
                    HorizontalAlignment="Right"
                    Click="BtnExportToExcel_Click" />
        </StackPanel>

        <Border x:Name="LoadingOverlay" Grid.Row="1" Grid.RowSpan="3" Background="#80FFFFFF" Visibility="Collapsed">
            <TextBlock Text="Đang tạo báo cáo..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\BapCaoTonKhoSachPreviewWindow.xaml.cs
================================================================================
﻿using CafebookModel.Model.ModelApp;
using Microsoft.Win32;
// using Newtonsoft.Json.Linq; // Không cần using này
using OfficeOpenXml;
using OfficeOpenXml.Style;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;

// --- SỬA LỖI CS0246: THÊM 2 USING NÀY ---
using System.Text.Json;
using System.Text.Json.Serialization;
// --- KẾT THÚC SỬA LỖI ---

namespace AppCafebookApi.View.common
{
    public partial class BapCaoTonKhoSachPreviewWindow : Page
    {
        private static readonly HttpClient httpClient;
        private BaoCaoSachTongHopDto? currentReportData;

        static BapCaoTonKhoSachPreviewWindow()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public BapCaoTonKhoSachPreviewWindow()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadFiltersAsync();
            await GenerateReportAsync();
        }

        private async Task LoadFiltersAsync()
        {
            try
            {
                var response = await httpClient.GetFromJsonAsync<JsonElement?>("api/app/baocaosach/filters");

                // SỬA LỖI CS0019: Dùng .HasValue để kiểm tra null
                if (!response.HasValue)
                {
                    MessageBox.Show("Không nhận được dữ liệu lọc.", "Lỗi API");
                    return;
                }

                // Chuyển đổi an toàn
                var theLoais = response.Value.GetProperty("theLoais").Deserialize<List<FilterLookupDto>>() ?? new List<FilterLookupDto>();
                theLoais.Insert(0, new FilterLookupDto { Id = 0, Ten = "Tất cả Thể loại" });
                cmbTheLoai.ItemsSource = theLoais;
                cmbTheLoai.SelectedValue = 0;

                var tacGias = response.Value.GetProperty("tacGias").Deserialize<List<FilterLookupDto>>() ?? new List<FilterLookupDto>();
                tacGias.Insert(0, new FilterLookupDto { Id = 0, Ten = "Tất cả Tác giả" });
                cmbTacGia.ItemsSource = tacGias;
                cmbTacGia.SelectedValue = 0;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Không thể tải bộ lọc: {ex.Message}", "Lỗi API");
            }
        }

        private async void BtnGenerate_Click(object sender, RoutedEventArgs e)
        {
            await GenerateReportAsync();
        }

        private async Task GenerateReportAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            btnGenerate.IsEnabled = false;

            var request = new BaoCaoSachRequestDto
            {
                SearchText = string.IsNullOrEmpty(txtSearch.Text) ? null : txtSearch.Text,
                TheLoaiId = (int)cmbTheLoai.SelectedValue == 0 ? (int?)null : (int)cmbTheLoai.SelectedValue,
                TacGiaId = (int)cmbTacGia.SelectedValue == 0 ? (int?)null : (int)cmbTacGia.SelectedValue
            };

            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/baocaosach/report", request);
                if (response.IsSuccessStatusCode)
                {
                    currentReportData = await response.Content.ReadFromJsonAsync<BaoCaoSachTongHopDto>();
                    if (currentReportData != null)
                    {
                        PopulateUi(currentReportData);
                    }
                }
                else
                {
                    MessageBox.Show($"Lỗi API: {response.ReasonPhrase}", "Lỗi");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Không thể kết nối API: {ex.Message}", "Lỗi");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
                btnGenerate.IsEnabled = true;
            }
        }

        private void PopulateUi(BaoCaoSachTongHopDto data)
        {
            lblTongDauSach.Text = data.Kpi.TongDauSach.ToString();
            lblTongSoLuong.Text = data.Kpi.TongSoLuong.ToString();
            lblDangChoThue.Text = data.Kpi.DangChoThue.ToString();
            lblSanSang.Text = data.Kpi.SanSang.ToString();

            dgInventoryDetails.ItemsSource = data.ChiTietTonKho;
            dgRentedOverdue.ItemsSource = data.SachTreHan;
            dgTopRented.ItemsSource = data.TopSachThue;
        }

        private async void BtnExportToExcel_Click(object sender, RoutedEventArgs e)
        {
            if (currentReportData == null)
            {
                MessageBox.Show("Chưa có dữ liệu báo cáo để xuất. Vui lòng nhấn 'Lọc Báo Cáo' trước.", "Chưa có dữ liệu");
                return;
            }

            var sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                FileName = $"BaoCaoTonKhoSach_{DateTime.Now:yyyyMMdd_HHmm}.xlsx"
            };

            if (sfd.ShowDialog() == true)
            {
                try
                {
                    LoadingOverlay.Visibility = Visibility.Visible;
                    await CreateExcelReportAsync(sfd.FileName, currentReportData);
                    LoadingOverlay.Visibility = Visibility.Collapsed;

                    MessageBox.Show($"Đã xuất báo cáo thành công!\n\nĐường dẫn: {sfd.FileName}", "Thành công", MessageBoxButton.OK, MessageBoxImage.Information);
                }
                catch (Exception ex)
                {
                    LoadingOverlay.Visibility = Visibility.Collapsed;
                    MessageBox.Show($"Có lỗi khi xuất Excel: {ex.Message}\n\nĐảm bảo bạn đã đóng file Excel (nếu nó đang mở).", "Lỗi Xuất File", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        // Dán đè lên hàm CreateExcelReportAsync CŨ của bạn
        private async Task CreateExcelReportAsync(string filePath, BaoCaoSachTongHopDto data)
        {
            // Giấy phép EPPlus
            ExcelPackage.License.SetNonCommercialPersonal("CafeBook");
            var fileInfo = new FileInfo(filePath);

            // Xóa file cũ nếu tồn tại để tránh lỗi
            if (fileInfo.Exists)
            {
                fileInfo.Delete();
            }

            using (var package = new ExcelPackage(fileInfo))
            {
                // --- TÙY CHỈNH STYLE ---
                // Định nghĩa một style chung cho tiêu đề
                Action<ExcelRange> styleTitle = (range) =>
                {
                    range.Style.Font.Bold = true;
                    range.Style.Font.Size = 14;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    range.Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                    range.Style.Fill.PatternType = ExcelFillStyle.Solid;
                    range.Style.Fill.BackgroundColor.SetColor(System.Drawing.ColorTranslator.FromHtml("#4F81BD")); // Màu xanh đậm
                    range.Style.Font.Color.SetColor(System.Drawing.Color.White);
                };

                // --- Sheet 1: TỔNG QUAN (Sheet mới) ---
                var wsTongQuan = package.Workbook.Worksheets.Add("Tổng Quan");
                wsTongQuan.Cells["A1:D1"].Merge = true;
                wsTongQuan.Cells["A1"].Value = "BÁO CÁO TỔNG QUAN - CAFEBOOK";
                styleTitle(wsTongQuan.Cells["A1:D1"]);

                wsTongQuan.Cells["A3"].Value = "Báo cáo được tạo lúc:";
                wsTongQuan.Cells["B3"].Value = DateTime.Now;
                wsTongQuan.Cells["B3"].Style.Numberformat.Format = "dd/MM/yyyy HH:mm:ss";
                wsTongQuan.Cells["A3:B3"].Style.Font.Bold = true;

                // Thêm dữ liệu KPI
                wsTongQuan.Cells["A5"].Value = "Chỉ số";
                wsTongQuan.Cells["B5"].Value = "Số lượng";
                wsTongQuan.Cells["A5:B5"].Style.Font.Bold = true;
                wsTongQuan.Cells["A5:B5"].Style.Fill.PatternType = ExcelFillStyle.Solid;
                wsTongQuan.Cells["A5:B5"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);

                wsTongQuan.Cells["A6"].Value = "Tổng đầu sách";
                wsTongQuan.Cells["B6"].Value = data.Kpi.TongDauSach;

                wsTongQuan.Cells["A7"].Value = "Tổng số lượng (cuốn)";
                wsTongQuan.Cells["B7"].Value = data.Kpi.TongSoLuong;

                wsTongQuan.Cells["A8"].Value = "Đang cho thuê";
                wsTongQuan.Cells["B8"].Value = data.Kpi.DangChoThue;

                wsTongQuan.Cells["A9"].Value = "Sẵn sàng cho thuê";
                wsTongQuan.Cells["B9"].Value = data.Kpi.SanSang;

                // Kẻ viền cho bảng KPI
                var kpiRange = wsTongQuan.Cells["A5:B9"];
                kpiRange.Style.Border.Top.Style = ExcelBorderStyle.Thin;
                kpiRange.Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                kpiRange.Style.Border.Left.Style = ExcelBorderStyle.Thin;
                kpiRange.Style.Border.Right.Style = ExcelBorderStyle.Thin;

                wsTongQuan.Cells[wsTongQuan.Dimension.Address].AutoFitColumns();


                // --- Sheet 2: Tồn Kho Chi Tiết ---
                var ws1 = package.Workbook.Worksheets.Add("Chi Tiết Tồn Kho");
                ws1.Cells["A1:F1"].Merge = true;
                ws1.Cells["A1"].Value = "Báo cáo Tồn kho Chi tiết";
                styleTitle(ws1.Cells["A1:F1"]);

                // Load dữ liệu từ Collection và áp dụng Style Bảng chuyên nghiệp
                // "true" = in ra tên cột (headers)
                ws1.Cells["A3"].LoadFromCollection(data.ChiTietTonKho, true, OfficeOpenXml.Table.TableStyles.Medium9);
                ws1.Cells[ws1.Dimension.Address].AutoFitColumns();


                // --- Sheet 3: Sách Đang Thuê & Trễ Hạn ---
                var ws2 = package.Workbook.Worksheets.Add("Sách Trễ Hạn");
                ws2.Cells["A1:F1"].Merge = true;
                ws2.Cells["A1"].Value = "Báo cáo Sách Đang Thuê & Trễ Hạn";
                styleTitle(ws2.Cells["A1:F1"]);

                ws2.Cells["A3"].LoadFromCollection(data.SachTreHan, true, OfficeOpenXml.Table.TableStyles.Medium10);

                // Cần định dạng lại cột ngày tháng sau khi load
                // +3 là vì bắt đầu từ A3 (1 title, 1 header, 1 data row)
                int rowCountSheet2 = data.SachTreHan.Count + 3;
                ws2.Cells[$"D4:E{rowCountSheet2}"].Style.Numberformat.Format = "dd/MM/yyyy HH:mm";
                ws2.Cells[ws2.Dimension.Address].AutoFitColumns();


                // --- Sheet 4: Top Sách Thuê ---
                var ws3 = package.Workbook.Worksheets.Add("Top Sách Thuê");
                ws3.Cells["A1:C1"].Merge = true;
                ws3.Cells["A1"].Value = "Top Sách Được Thuê Nhiều Nhất";
                styleTitle(ws3.Cells["A1:C1"]);

                ws3.Cells["A3"].LoadFromCollection(data.TopSachThue, true, OfficeOpenXml.Table.TableStyles.Medium11);
                ws3.Cells[ws3.Dimension.Address].AutoFitColumns();

                // Lưu file
                await package.SaveAsync();
            }
        }

        private void BtnBack_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\CaiDatWindow.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.common.CaiDatWindow"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:local="clr-namespace:AppCafebookApi.View.common"
      mc:Ignorable="d"
      d:DesignHeight="700" d:DesignWidth="900"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <Style TargetType="GroupItem">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="GroupItem">
                        <StackPanel>
                            <TextBlock Text="{Binding Name}" 
                                       FontSize="16" FontWeight="Bold" 
                                       Foreground="{StaticResource PrimaryBrownBrush}" 
                                       Margin="5,15,0,5" />
                            <ItemsPresenter />
                        </StackPanel>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="SettingTextBox" TargetType="Grid">
            <Setter Property="Margin" Value="0,2,0,10"/>
        </Style>

        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style x:Key="PlaceholderTextBlock" TargetType="TextBlock">
            <Setter Property="Foreground" Value="#AAAAAA"/>
            <Setter Property="IsHitTestVisible" Value="False"/>
            <Setter Property="Margin" Value="5,0"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Grid.Row" Value="0"/>
        </Style>

        <Style x:Key="HelperTextBlock" TargetType="TextBlock">
            <Setter Property="Foreground" Value="#757575"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="TextWrapping" Value="Wrap"/>
            <Setter Property="Grid.Row" Value="1" />
            <Setter Property="Margin" Value="2,2,0,0"/>
        </Style>

        <Style x:Key="SaveButton" TargetType="Button">
            <Setter Property="Background" Value="#66BB6A"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Content" Value="Lưu"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>

        <Style TargetType="TextBox">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>

    </Page.Resources>

    <Grid Margin="20" Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Text="Cài đặt Thông tin Quán &amp; Hệ thống" FontSize="20" FontWeight="Bold" Foreground="#4E342E" Margin="0,0,0,15"/>

        <ListView x:Name="lvSettings" Grid.Row="1" Background="White" BorderThickness="1" BorderBrush="#E0E0E0">

            <ListView.GroupStyle>
                <GroupStyle HidesIfEmpty="True"/>
            </ListView.GroupStyle>

            <ListView.View>
                <GridView>
                    <GridViewColumn Header="Giá trị" Width="550">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <Grid Style="{StaticResource SettingTextBox}">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <TextBox x:Name="txtValue" 
                                             Text="{Binding GiaTri, UpdateSourceTrigger=PropertyChanged}" 
                                             Padding="5" 
                                             BorderThickness="1" 
                                             BorderBrush="#BDBDBD"
                                             TextWrapping="Wrap" AcceptsReturn="True"
                                             MinHeight="30" MaxHeight="100" Grid.Row="0"/>

                                    <TextBlock Text="{Binding MoTa}">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock" BasedOn="{StaticResource PlaceholderTextBlock}">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Text, ElementName=txtValue}" Value="">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>

                                    <TextBlock Text="{Binding MoTa}">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock" BasedOn="{StaticResource HelperTextBlock}">
                                                <Setter Property="Visibility" Value="Visible"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Text, ElementName=txtValue}" Value="">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </Grid>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>

                    <GridViewColumn Header="Hành động" Width="100">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <Button Content="Lưu" 
                                        Style="{StaticResource SaveButton}"
                                        Click="BtnSaveRow_Click"
                                        Tag="{Binding}"/>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                    <GridViewColumn Header="Tên Cài Đặt (Ẩn)" Width="0" DisplayMemberBinding="{Binding TenCaiDat}"/>
                </GridView>
            </ListView.View>
        </ListView>

        <Border x:Name="LoadingOverlay" Grid.Row="1" Background="#80FFFFFF" Visibility="Collapsed">
            <TextBlock Text="Đang tải dữ liệu..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="16" FontWeight="SemiBold" Foreground="#4E342E"/>
        </Border>

        <StackPanel Grid.Row="2" Margin="0,15,0,0">
            <Border x:Name="NotificationBorder" Background="{StaticResource SuccessBrush}" 
                    CornerRadius="4" Padding="15,10" Margin="0,0,0,10"
                    Visibility="Collapsed">
                <Border.Effect>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.1" BlurRadius="10"/>
                </Border.Effect>
                <TextBlock x:Name="NotificationText" Text="Lưu thành công!" 
                           Foreground="White" FontWeight="SemiBold"
                           HorizontalAlignment="Center" VerticalAlignment="Center"/>
            </Border>
            <Button x:Name="btnBack" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" 
                    Click="BtnBack_Click">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="&lt; Quay lại" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </StackPanel>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\CaiDatWindow.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Data;
using System.Windows.Controls;
using CafebookModel.Model.ModelApp;
using System.Windows.Threading;
using System.Windows.Media;

namespace AppCafebookApi.View.common
{
    // Lớp nội bộ để hỗ trợ grouping
    public class CaiDatViewItem : CaiDatDto
    {
        public string Nhom { get; set; } = "Cài Đặt Khác";
    }

    public partial class CaiDatWindow : Page
    {
        private static readonly HttpClient httpClient;
        private ObservableCollection<CaiDatViewItem> settingsList = new ObservableCollection<CaiDatViewItem>();
        private DispatcherTimer notificationTimer;

        static CaiDatWindow()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public CaiDatWindow()
        {
            InitializeComponent();
            notificationTimer = new DispatcherTimer
            {
                Interval = TimeSpan.FromSeconds(3)
            };
            notificationTimer.Tick += NotificationTimer_Tick;
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.GetFromJsonAsync<List<CaiDatDto>>("api/app/caidat/all");

                if (response != null)
                {
                    // 1. CHUYỂN DTO THÀNH VIEWITEM VÀ PHÂN NHÓM
                    var viewItems = response
                        .OrderBy(s => GetNhomOrder(s.TenCaiDat)) // Sắp xếp theo thứ tự logic
                        .ThenBy(s => s.TenCaiDat) // Sắp xếp theo tên
                        .Select(dto => new CaiDatViewItem
                        {
                            TenCaiDat = dto.TenCaiDat,
                            GiaTri = dto.GiaTri,
                            MoTa = dto.MoTa,
                            Nhom = GetNhom(dto.TenCaiDat) // Hàm phân nhóm
                        });

                    settingsList = new ObservableCollection<CaiDatViewItem>(viewItems);

                    // 2. TẠO COLLECTIONVIEW ĐỂ GROUPING
                    var cvs = new CollectionViewSource();
                    cvs.Source = settingsList;
                    cvs.GroupDescriptions.Add(new PropertyGroupDescription("Nhom"));

                    lvSettings.ItemsSource = cvs.View;
                }
            }
            catch (Exception ex)
            {
                ShowNotification($"Không thể tải cài đặt: {ex.Message}", isError: true);
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        /// <summary>
        /// CẬP NHẬT: Hàm helper để phân loại cài đặt theo nhóm
        /// </summary>
        private string GetNhom(string tenCaiDat)
        {
            if (tenCaiDat == "TenQuan" || tenCaiDat == "DiaChi" || tenCaiDat == "SoDienThoai" || tenCaiDat == "Wifi_MatKhau")
            {
                return "1. Thông tin Chung (In Hóa đơn)";
            }
            if (tenCaiDat == "GioiThieu" || tenCaiDat == "LienHe_GioMoCua")
            {
                return "2. Cài đặt Thông Tin Quán (Web)";
            }
            if (tenCaiDat.StartsWith("LienHe_") && tenCaiDat != "LienHe_GioMoCua")
            {
                return "3. Cài Đặt Mạng Xã Hội (Web)";
            }
            if (tenCaiDat.StartsWith("Sach_"))
            {
                return "4. Cài đặt Thuê Sách";
            }
            if (tenCaiDat.StartsWith("DiemTichLuy_"))
            {
                return "5. Cài đặt Điểm Tích Lũy";
            }
            if (tenCaiDat.StartsWith("AI_Chat_"))
            {
                return "6. Cài đặt AI (Nâng cao)";
            }
            return "7. Cài Đặt Khác";
        }

        // CẬP NHẬT: Hàm helper để sắp xếp nhóm theo thứ tự
        private int GetNhomOrder(string tenCaiDat)
        {
            if (tenCaiDat == "TenQuan" || tenCaiDat == "DiaChi" || tenCaiDat == "SoDienThoai" || tenCaiDat == "Wifi_MatKhau") return 1;
            if (tenCaiDat == "GioiThieu" || tenCaiDat == "LienHe_GioMoCua") return 2;
            if (tenCaiDat.StartsWith("LienHe_") && tenCaiDat != "LienHe_GioMoCua") return 3;
            if (tenCaiDat.StartsWith("Sach_")) return 4;
            if (tenCaiDat.StartsWith("DiemTichLuy_")) return 5;
            if (tenCaiDat.StartsWith("AI_Chat_")) return 6;
            return 7;
        }

        // (Các hàm BtnSaveRow_Click, ShowNotification, NotificationTimer_Tick, BtnBack_Click giữ nguyên)

        private async void BtnSaveRow_Click(object sender, RoutedEventArgs e)
        {
            var button = sender as Button;
            if (button == null) return;

            var itemToSave = button.Tag as CaiDatViewItem;
            if (itemToSave == null) return;

            button.IsEnabled = false;
            button.Content = "Đang lưu...";

            try
            {
                var dto = new CaiDatDto
                {
                    TenCaiDat = itemToSave.TenCaiDat,
                    GiaTri = itemToSave.GiaTri,
                    MoTa = itemToSave.MoTa
                };

                var response = await httpClient.PutAsJsonAsync("api/app/caidat/update-single", dto);

                if (response.IsSuccessStatusCode)
                {
                    ShowNotification($"Đã lưu '{itemToSave.MoTa}' thành công!");
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    ShowNotification($"Lỗi khi lưu: {error}", isError: true);
                }
            }
            catch (Exception ex)
            {
                ShowNotification($"Không thể lưu: {ex.Message}", isError: true);
            }
            finally
            {
                button.IsEnabled = true;
                button.Content = "Lưu";
            }
        }

        private void ShowNotification(string message, bool isError = false)
        {
            notificationTimer.Stop();
            NotificationText.Text = message;
            if (isError)
            {
                NotificationBorder.Background = (SolidColorBrush)FindResource("ErrorBrush");
            }
            else
            {
                NotificationBorder.Background = (SolidColorBrush)FindResource("SuccessBrush");
            }
            NotificationBorder.Visibility = Visibility.Visible;
            notificationTimer.Start();
        }

        private void NotificationTimer_Tick(object? sender, EventArgs e)
        {
            notificationTimer.Stop();
            NotificationBorder.Visibility = Visibility.Collapsed;
        }

        private void BtnBack_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\ChonKhuyenMaiWindow.xaml
================================================================================
﻿<Window x:Class="AppCafebookApi.View.common.ChonKhuyenMaiWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AppCafebookApi.View.common"
        mc:Ignorable="d"
        Title="Chọn Khuyến Mãi Áp Dụng" 
        Height="600" Width="450"
        WindowStartupLocation="CenterScreen"
        WindowStyle="ToolWindow"
        FontFamily="Segoe UI"
        Loaded="Window_Loaded"
        Background="#FFF8E1">

    <Window.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="StatusRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="StatusGreenBrush" Color="#66BB6A"/>

        <Style x:Key="KhuyenMaiItemStyle" TargetType="ListBoxItem">
            <Setter Property="Padding" Value="15,10"/>
            <Setter Property="Margin" Value="0,0,0,5"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderThickness" Value="3,0,0,0"/>
            <Setter Property="BorderBrush" Value="{StaticResource AccentOrangeBrush}"/>

            <Style.Triggers>
                <DataTrigger Binding="{Binding IsEligible}" Value="False">
                    <Setter Property="IsEnabled" Value="False"/>
                    <Setter Property="BorderBrush" Value="#BDBDBD"/>
                    <Setter Property="Opacity" Value="0.6"/>
                </DataTrigger>
                <Trigger Property="IsSelected" Value="true">
                    <Setter Property="Background" Value="#FFF1DE"/>
                    <Setter Property="BorderBrush" Value="#D27D2D"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="ActionButton" TargetType="Button">
            <Setter Property="Padding" Value="15"/>
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBox x:Name="txtSearch" 
                 FontSize="14" 
                 Padding="10" Margin="10" 
                 TextChanged="TxtSearch_TextChanged"
                 Text="Nhập mã hoặc tên KM..."/>

        <ListBox Grid.Row="1" x:Name="lvKhuyenMai" 
                 HorizontalContentAlignment="Stretch"
                 SelectionMode="Single"
                 SelectedValuePath="IdKhuyenMai"
                 ItemContainerStyle="{StaticResource KhuyenMaiItemStyle}"
                 Background="Transparent" BorderThickness="0">
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="{Binding TenChuongTrinh}" 
                                       FontSize="16" FontWeight="Bold" 
                                       Foreground="{StaticResource DarkBrownBrush}"/>
                            <TextBlock Text="{Binding MaKhuyenMai, StringFormat=' ({0})'}" 
                                       FontSize="14" FontStyle="Italic" VerticalAlignment="Bottom"
                                       Margin="5,0,0,0"
                                       Foreground="{StaticResource AccentOrangeBrush}"/>
                        </StackPanel>

                        <TextBlock Grid.Row="1" Text="{Binding DieuKienApDung}" 
                                   TextWrapping="Wrap" 
                                   FontSize="13"
                                   Foreground="{StaticResource TextGrayBrush}"/>

                        <TextBlock Grid.Row="2" Text="{Binding IneligibilityReason}" 
                                   TextWrapping="Wrap" 
                                   FontSize="13" FontWeight="SemiBold"
                                   Margin="0,5,0,0"
                                   Foreground="{StaticResource StatusRedBrush}">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsEligible}" Value="False">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>

                        <Border CornerRadius="0,5,0,5" 
                                Background="{StaticResource StatusGreenBrush}" 
                                HorizontalAlignment="Right" 
                                VerticalAlignment="Top"
                                Margin="0,-10,-15,0"
                                Padding="8,3">
                            <TextBlock Text="Có thể áp dụng" Foreground="White" FontSize="10" FontWeight="Bold"/>
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsEligible}" Value="True">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                        </Border>

                    </Grid>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <Border Grid.Row="2" Background="White" Padding="10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Button x:Name="btnHuy" Content="Hủy" 
                        Click="BtnHuy_Click" 
                        Style="{StaticResource ActionButton}" 
                        Background="{StaticResource TextGrayBrush}" 
                        Margin="0,0,5,0"/>
                <Button x:Name="btnApDung" Grid.Column="1" Content="Áp Dụng" 
                        Click="BtnApDung_Click" 
                        Style="{StaticResource ActionButton}" 
                        Background="{StaticResource PrimaryBrownBrush}" 
                        Margin="5,0,0,0"/>
            </Grid>
        </Border>
    </Grid>
</Window>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\ChonKhuyenMaiWindow.xaml.cs
================================================================================
﻿using CafebookModel.Model.ModelApp.NhanVien;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;

namespace AppCafebookApi.View.common
{
    public partial class ChonKhuyenMaiWindow : Window
    {
        private readonly int _idHoaDon;
        private readonly int? _currentSelectedId;
        private static readonly HttpClient _httpClient;
        private List<KhuyenMaiHienThiDto> _allKms = new List<KhuyenMaiHienThiDto>();

        public int? SelectedId { get; private set; }

        static ChonKhuyenMaiWindow()
        {
            _httpClient = new HttpClient { BaseAddress = new Uri("http://localhost:5166") };
        }

        public ChonKhuyenMaiWindow(int idHoaDon, int? currentSelectedId)
        {
            InitializeComponent();
            _idHoaDon = idHoaDon;
            _currentSelectedId = currentSelectedId;
        }

        private async void Window_Loaded(object sender, RoutedEventArgs e)
        {
            this.IsEnabled = false;
            try
            {
                var response = await _httpClient.GetAsync($"api/app/nhanvien/khuyenmai/available/{_idHoaDon}");

                if (response.IsSuccessStatusCode)
                {
                    _allKms = await response.Content.ReadFromJsonAsync<List<KhuyenMaiHienThiDto>>() ?? new List<KhuyenMaiHienThiDto>();

                    // SỬA LỖI: Gán giá trị MaKhuyenMai để tránh NullReference
                    _allKms.Insert(0, new KhuyenMaiHienThiDto
                    {
                        IdKhuyenMai = 0,
                        TenChuongTrinh = "-- Không áp dụng --",
                        MaKhuyenMai = "", // <-- THÊM DÒNG NÀY
                        DieuKienApDung = "Chọn mục này để gỡ bỏ khuyến mãi hiện tại.",
                        IsEligible = true
                    });

                    lvKhuyenMai.ItemsSource = _allKms;

                    if (_currentSelectedId.HasValue)
                    {
                        lvKhuyenMai.SelectedValue = _currentSelectedId.Value;
                    }
                    else
                    {
                        lvKhuyenMai.SelectedValue = 0;
                    }
                }
                else
                {
                    MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lỗi tải Khuyến mãi");
                    this.Close();
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message, "Lỗi API");
                this.Close();
            }
            this.IsEnabled = true;
        }

        private void TxtSearch_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (lvKhuyenMai == null || _allKms == null)
            {
                return;
            }

            string filter = txtSearch.Text.ToLower().Trim();
            if (string.IsNullOrEmpty(filter) || filter == "nhập mã hoặc tên km...")
            {
                lvKhuyenMai.ItemsSource = _allKms;
                return;
            }

            // SỬA LỖI: Thêm kiểm tra null cho MaKhuyenMai (mặc dù đã fix ở trên)
            var filteredList = _allKms.Where(k =>
                k.TenChuongTrinh.ToLower().Contains(filter) ||
                (k.MaKhuyenMai ?? "").ToLower().Contains(filter) || // <-- SỬA DÒNG NÀY
                k.IdKhuyenMai == 0
            ).ToList();

            lvKhuyenMai.ItemsSource = filteredList;
        }

        private void BtnApDung_Click(object sender, RoutedEventArgs e)
        {
            if (lvKhuyenMai.SelectedItem == null)
            {
                MessageBox.Show("Vui lòng chọn một khuyến mãi.", "Chưa chọn");
                return;
            }

            var selectedKm = (KhuyenMaiHienThiDto)lvKhuyenMai.SelectedItem;

            // Kiểm tra IsEligible đã được style loạibỏ, nhưng đây là check logic cuối
            if (!selectedKm.IsEligible)
            {
                MessageBox.Show($"Không thể áp dụng khuyến mãi này.\nLý do: {selectedKm.IneligibilityReason}", "Không đủ điều kiện", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            this.SelectedId = selectedKm.IdKhuyenMai;
            this.DialogResult = true;
            this.Close();
        }

        private void BtnHuy_Click(object sender, RoutedEventArgs e)
        {
            this.DialogResult = false;
            this.Close();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\HoaDonPreviewWindow.xaml
================================================================================
﻿<Window x:Class="AppCafebookApi.View.common.HoaDonPreviewWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AppCafebookApi.View.common"
        mc:Ignorable="d"
        Title="Xem trước Hóa đơn" Height="700" Width="450"
        WindowStartupLocation="CenterScreen" WindowStyle="ToolWindow"
        FontFamily="Segoe UI" Loaded="Window_Loaded"
        Background="#F5F5F5">

    <Window.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#795548"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionOrangeBrush" Color="#FFA726"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="PrimaryBrown" Color="#6F4E37"/>
        <SolidColorBrush x:Key="AccentOrange" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteText" Color="#FFFFFF"/>

        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrown}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteText}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Height" Value="42"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                CornerRadius="21"
                                Background="{TemplateBinding Background}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="2" Color="#6F4E37" Opacity="0.3" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource AccentOrange}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                                <Setter TargetName="border" Property="Opacity" Value="0.7"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="SecondaryButton" TargetType="Button" BasedOn="{StaticResource PrimaryButton}">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="BorderThickness" Value="2"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                CornerRadius="21"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource SubtleGrayBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

    </Window.Resources>



    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto">
            <Border x:Name="printArea" Background="White" Margin="10" Padding="20" Width="380" HorizontalAlignment="Center">
                <StackPanel>
                    <TextBlock x:Name="lblTenQuan" Text="CAFEBOOK" FontSize="20" FontWeight="Bold" HorizontalAlignment="Center"/>
                    <TextBlock x:Name="lblDiaChi" Text="123 Đường ABC, Q.1, TP.HCM" HorizontalAlignment="Center" Margin="0,5,0,0"/>
                    <TextBlock x:Name="lblSoDienThoai" Text="SĐT: 0909123456" HorizontalAlignment="Center"/>
                    <TextBlock x:Name="lblWifi" 
 Text="Wifi: cafebook123" HorizontalAlignment="Center" Margin="0,0,0,10"/>

                    <Separator Margin="0,5"/>

                    <TextBlock x:Name="lblTieuDe" Text="PHIẾU TẠM TÍNH" FontSize="18" FontWeight="Bold" HorizontalAlignment="Center" Margin="0,10,0,0"/>
                    <TextBlock x:Name="lblSoHoaDon" Text="Số HĐ: #123" HorizontalAlignment="Center" FontSize="12" Foreground="Gray"/>

                    <Grid 
 Margin="0,10,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>

                        </Grid.ColumnDefinitions>
                        <StackPanel Grid.Column="0">
                            <TextBlock x:Name="lblBan" Text="Bàn: Bàn 101"/>
                            <TextBlock x:Name="lblNhanVien" Text="Nhân viên: Nguyễn Văn A"/>

                        </StackPanel>
                        <StackPanel Grid.Column="1" HorizontalAlignment="Right">
                            <TextBlock x:Name="lblNgay" Text="Giờ vào: 05/11/2025 18:00" HorizontalAlignment="Right"/>

                            <TextBlock x:Name="lblKhachHang" Text="Khách: Khách vãng lai" HorizontalAlignment="Right"/>
                        </StackPanel>
                    </Grid>

                    <DataGrid x:Name="dgItems" AutoGenerateColumns="False" IsReadOnly="True" CanUserAddRows="False"
                 
                             GridLinesVisibility="Horizontal" HorizontalGridLinesBrush="#EEE"
                              Background="Transparent" BorderThickness="0"
                              HeadersVisibility="Column">
                        <DataGrid.Columns>

                            <DataGridTextColumn Header="Tên món" Binding="{Binding TenSanPham}" Width="*"/>
                            <DataGridTextColumn Header="SL" Binding="{Binding SoLuong}" Width="40"/>
                            <DataGridTextColumn Header="Đơn giá" Binding="{Binding DonGia, StringFormat=N0}" Width="Auto"/>

                            <DataGridTextColumn Header="Thành tiền" Binding="{Binding ThanhTien, StringFormat=N0}" Width="Auto" FontWeight="SemiBold"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <ItemsControl x:Name="icPhuThu" Margin="0,10,0,0">

                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid>

                                    <TextBlock Text="{Binding TenPhuThu}" HorizontalAlignment="Left" Foreground="Gray"/>
                                    <TextBlock Text="{Binding SoTien, StringFormat=+ {0:N0}}" HorizontalAlignment="Right" Foreground="Gray"/>
                                </Grid>

                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <Separator Margin="0,10"/>


                    <Grid Margin="0,5,0,5">
                        <TextBlock Text="Tổng tiền hàng (Tạm tính)" HorizontalAlignment="Left" FontSize="14"/>
                        <TextBlock x:Name="lblTongTienGoc" Text="0" HorizontalAlignment="Right" FontWeight="SemiBold" FontSize="14"/>
                    </Grid>


                    <Grid Margin="0,0,0,5">
                        <TextBlock Text="Giảm giá (Khuyến mãi)" HorizontalAlignment="Left" FontSize="14"/>
                        <TextBlock x:Name="lblGiamGiaKM" Text="- 0" HorizontalAlignment="Right" FontWeight="SemiBold" Foreground="Green" FontSize="14"/>
                    </Grid>


                    <Grid Margin="0,0,0,5" x:Name="gridGiamGiaDiem">
                        <TextBlock Text="Giảm giá (Điểm)" HorizontalAlignment="Left" FontSize="14"/>
                        <TextBlock x:Name="lblGiamGiaDiem" Text="- 0" HorizontalAlignment="Right" FontWeight="SemiBold" Foreground="Green" FontSize="14"/>
                    </Grid>


                    <Grid Margin="0,0,0,5">
                        <TextBlock Text="Phụ thu" HorizontalAlignment="Left" FontSize="14"/>
                        <TextBlock x:Name="lblTongPhuThu" Text="+ 0" HorizontalAlignment="Right" FontWeight="SemiBold" FontSize="14"/>
                    </Grid>



                    <Separator Margin="0,10"/>

                    <Grid Margin="0,5,0,20">
                        <TextBlock Text="THÀNH TIỀN" FontSize="18" FontWeight="Bold" HorizontalAlignment="Left"/>
                        <TextBlock x:Name="lblThanhTien" Text="0" FontSize="20" FontWeight="Bold" HorizontalAlignment="Right"/>

                    </Grid>

                    <Grid Margin="0,0,0,5" x:Name="gridTienMat">
                        <TextBlock Text="Khách đưa (Tiền mặt)" HorizontalAlignment="Left" FontSize="14" Foreground="Gray"/>
                        <TextBlock x:Name="lblKhachDua" Text="0" HorizontalAlignment="Right" FontWeight="SemiBold" FontSize="14" Foreground="Gray"/>
                    </Grid>
                    <Grid Margin="0,0,0,20" x:Name="gridTienThoi">
                        <TextBlock Text="Tiền thối" HorizontalAlignment="Left" FontSize="14" Foreground="Gray"/>
                        <TextBlock x:Name="lblTienThoi" Text="0" HorizontalAlignment="Right" FontWeight="SemiBold" FontSize="14" Foreground="Gray"/>
                    </Grid>
                    <TextBlock Text="Cảm ơn quý khách!"
 HorizontalAlignment="Center" FontStyle="Italic"/>
                </StackPanel>
            </Border>
        </ScrollViewer>

        <Grid Grid.Row="1" x:Name="panelButtons">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Button x:Name="btnIn" Grid.Column="1" Style="{StaticResource SecondaryButton}" 
                    Content="In Phiếu" Width="100" Margin="5" Click="BtnIn_Click"/>

            <Button x:Name="btnClose" Grid.Column="2" Style="{StaticResource SecondaryButton}" 
                    Background="{StaticResource TextGrayBrush}" Foreground="White" BorderThickness="0"
                    Content="Đóng" Width="100" Margin="5" Click="BtnClose_Click" IsCancel="True"/>
        </Grid>
    </Grid>
</Window>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\HoaDonPreviewWindow.xaml.cs
================================================================================
﻿using CafebookModel.Model.ModelApp.NhanVien;
using System;
using System.Windows;
using System.Windows.Controls;

namespace AppCafebookApi.View.common
{
    public partial class HoaDonPreviewWindow : Window
    {
        private readonly HoaDonPreviewDto _data;

        public HoaDonPreviewWindow(HoaDonPreviewDto data)
        {
            InitializeComponent();
            _data = data;
        }

        private void Window_Loaded(object sender, RoutedEventArgs e)
        {
            // 1. Bind Thông tin quán
            lblTenQuan.Text = _data.TenQuan;
            lblDiaChi.Text = _data.DiaChi;
            lblSoDienThoai.Text = $"SĐT: {_data.SoDienThoai}";
            lblWifi.Text = $"Wifi: {_data.WifiMatKhau}";

            // 2. Bind Thông tin Hóa đơn
            lblTieuDe.Text = _data.IsProvisional ? "PHIẾU TẠM TÍNH" : "HÓA ĐƠN THANH TOÁN";
            lblSoHoaDon.Text = $"Số HĐ: #{_data.IdHoaDon}";
            lblBan.Text = $"Bàn: {_data.SoBan}";
            lblNhanVien.Text = $"Nhân viên: {_data.TenNhanVien}";
            lblNgay.Text = $"Giờ vào: {_data.ThoiGianTao:dd/MM/yyyy HH:mm}";
            lblKhachHang.Text = $"Khách: {_data.TenKhachHang}";

            // 3. Bind Danh sách
            dgItems.ItemsSource = _data.Items;
            icPhuThu.ItemsSource = _data.Surcharges;

            // 4. Bind Tiền
            lblTongTienGoc.Text = _data.TongTienGoc.ToString("N0");
            lblGiamGiaKM.Text = $"- {_data.GiamGiaKM:N0}";
            lblGiamGiaDiem.Text = $"- {_data.GiamGiaDiem:N0}";
            lblTongPhuThu.Text = $"+ {_data.TongPhuThu:N0}";
            lblThanhTien.Text = _data.ThanhTien.ToString("N0") + " đ";

            // Sửa 1: Ẩn/hiện panel tiền mặt
            if (_data.PhuongThucThanhToan == "Tiền mặt")
            {
                lblKhachDua.Text = _data.KhachDua.ToString("N0");
                lblTienThoi.Text = _data.TienThoi.ToString("N0");
            }
            else
            {
                gridTienMat.Visibility = Visibility.Collapsed;
                gridTienThoi.Visibility = Visibility.Collapsed;
            }
        }

        // ### SỬA LỖI IN BỊ CẮT (YÊU CẦU 3) ###
        private void BtnIn_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                PrintDialog printDialog = new PrintDialog();
                if (printDialog.ShowDialog() == true)
                {
                    // 1. Ẩn các nút
                    panelButtons.Visibility = Visibility.Collapsed;

                    // 2. Lấy ScrollViewer và Border (printArea)
                    var scrollViewer = printArea.Parent as ScrollViewer;
                    if (scrollViewer == null)
                    {
                        panelButtons.Visibility = Visibility.Visible;
                        return;
                    }

                    // 3. TẠM THỜI gỡ Border (printArea) ra khỏi ScrollViewer
                    //    và cho nó tự động co giãn theo nội dung
                    var originalContent = scrollViewer.Content;
                    scrollViewer.Content = null;

                    // 4. Đặt lại kích thước để nó tự co giãn theo nội dung
                    printArea.Width = printDialog.PrintableAreaWidth; // Vừa khổ giấy
                    printArea.Height = double.NaN; // Tự động co giãn chiều cao

                    // 5. Cập nhật layout để tính toán lại kích thước thật
                    printArea.Measure(new Size(printDialog.PrintableAreaWidth, double.PositiveInfinity));
                    printArea.Arrange(new Rect(new Point(0, 0), printArea.DesiredSize));

                    // 6. In
                    printDialog.PrintVisual(printArea, "Hóa đơn CafeBook");

                    // 7. Trả lại
                    printArea.Width = 380; // Trả lại width 380 (từ XAML)
                    printArea.Height = double.NaN; // Reset
                    scrollViewer.Content = originalContent;
                    panelButtons.Visibility = Visibility.Visible;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi in: {ex.Message}");
                // Đảm bảo các nút hiện lại nếu có lỗi
                if (panelButtons != null) panelButtons.Visibility = Visibility.Visible;
            }
        }

        // ### THÊM NÚT ĐÓNG (YÊU CẦU 1 & 2) ###
        private void BtnClose_Click(object sender, RoutedEventArgs e)
        {
            this.Close();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\InputBoxWindow.xaml
================================================================================
﻿<Window x:Class="AppCafebookApi.View.Common.InputBoxWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AppCafebookApi.View.Common"
        mc:Ignorable="d"
        Title="Input Box" Height="220" Width="400"
        WindowStyle="ToolWindow"
        WindowStartupLocation="CenterScreen"
        Background="#F5F5F5"
        Loaded="Window_Loaded">
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" x:Name="lblPrompt" Text="Vui lòng nhập:" TextWrapping="Wrap" FontSize="14" Margin="0,0,0,10"/>

        <TextBox Grid.Row="1" x:Name="txtInput" 
                 TextWrapping="Wrap"
                 AcceptsReturn="False"
                 FontSize="14"
                 Padding="5"
                 VerticalAlignment="Top"
                 BorderBrush="#BDBDBD"
                 BorderThickness="1"/>

        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,15,0,0">
            <Button x:Name="btnOk" Content="OK" Width="80" Height="30" Margin="0,0,10,0" IsDefault="True" Click="BtnOk_Click"/>
            <Button x:Name="btnCancel" Content="Hủy" Width="80" Height="30" IsCancel="True" Click="BtnCancel_Click"/>
        </StackPanel>
    </Grid>
</Window>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\InputBoxWindow.xaml.cs
================================================================================
﻿// Tập tin: AppCafebookApi/View/Common/InputBoxWindow.xaml.cs (ĐÃ SỬA)
using System.Windows;

namespace AppCafebookApi.View.Common // (Hoặc .common tùy theo thư mục của bạn)
{
    public partial class InputBoxWindow : Window
    {
        public string InputText { get; private set; }

        public InputBoxWindow(string title, string prompt, string defaultValue = "")
        {
            InitializeComponent();
            this.Title = title;
            lblPrompt.Text = prompt;
            txtInput.Text = defaultValue;
            InputText = defaultValue;
        }

        // SỬA: Đã xóa chữ 'D' bị thừa
        private void Window_Loaded(object sender, RoutedEventArgs e)
        {
            txtInput.Focus();
            txtInput.SelectAll();
        }

        private void BtnOk_Click(object sender, RoutedEventArgs e)
        {
            InputText = txtInput.Text;
            this.DialogResult = true;
            this.Close();
        }

        private void BtnCancel_Click(object sender, RoutedEventArgs e)
        {
            this.DialogResult = false;
            this.Close();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\InputDialogWindow.xaml
================================================================================
﻿<Window x:Class="AppCafebookApi.View.common.InputDialogWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Nhập thông tin" Height="200" Width="400"
        WindowStartupLocation="CenterOwner" WindowStyle="ToolWindow"
        Background="#FFF8E1" FontFamily="Segoe UI">
    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock x:Name="lblPrompt" Grid.Row="0" Text="Vui lòng nhập:" TextWrapping="Wrap" Margin="0,0,0,10"/>

        <TextBox x:Name="txtInput" Grid.Row="1" VerticalAlignment="Top"
                 BorderBrush="#6F4E37" Padding="5" AcceptsReturn="True" TextWrapping="Wrap"/>

        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0">
            <Button x:Name="btnOk" Content="Đồng ý" Width="80" Click="BtnOk_Click" IsDefault="True"/>
            <Button x:Name="btnCancel" Content="Hủy" Width="80" Margin="10,0,0,0" IsCancel="True" Background="#757575"/>
        </StackPanel>
    </Grid>
</Window>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\InputDialogWindow.xaml.cs
================================================================================
﻿using System.Windows;

namespace AppCafebookApi.View.common
{
    public partial class InputDialogWindow : Window
    {
        public string InputText { get; private set; } = string.Empty;

        public InputDialogWindow(string title, string prompt)
        {
            InitializeComponent();
            this.Title = title;
            lblPrompt.Text = prompt;
        }

        private void BtnOk_Click(object sender, RoutedEventArgs e)
        {
            this.InputText = txtInput.Text;
            this.DialogResult = true;
            this.Close();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\PhieuGiaoHangPreviewWindow.xaml
================================================================================
﻿<Window x:Class="AppCafebookApi.View.Common.PhieuGiaoHangPreviewWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AppCafebookApi.View.common"
        mc:Ignorable="d"
        Title="Phiếu Giao Hàng" Height="700" Width="450"
        WindowStartupLocation="CenterScreen" WindowStyle="ToolWindow"
        FontFamily="Segoe UI" Loaded="Window_Loaded"
        Background="#F5F5F5">

    <Window.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#795548"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="PrimaryBrown" Color="#6F4E37"/>
        <SolidColorBrush x:Key="AccentOrange" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteText" Color="#FFFFFF"/>
        <Style x:Key="PrimaryButton" TargetType="Button">
        </Style>
        <Style x:Key="SecondaryButton" TargetType="Button" BasedOn="{StaticResource PrimaryButton}">
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto">
            <Border x:Name="printArea" Background="White" Margin="10" Padding="20" Width="380" HorizontalAlignment="Center">
                <StackPanel>
                    <TextBlock x:Name="lblTenQuan" Text="CAFEBOOK" FontSize="20" FontWeight="Bold" HorizontalAlignment="Center"/>
                    <TextBlock x:Name="lblDiaChi" Text="123 Đường ABC, Q.1, TP.HCM" HorizontalAlignment="Center" Margin="0,5,0,0"/>
                    <TextBlock x:Name="lblSoDienThoai" Text="SĐT: 0909123456" HorizontalAlignment="Center"/>

                    <Separator Margin="0,5"/>

                    <TextBlock x:Name="lblTieuDe" Text="PHIẾU GIAO HÀNG" FontSize="18" FontWeight="Bold" HorizontalAlignment="Center" Margin="0,10,0,0"/>
                    <TextBlock x:Name="lblSoHoaDon" Text="Số HĐ: #123" HorizontalAlignment="Center" FontSize="12" Foreground="Gray"/>

                    <Grid Margin="0,10,0,10">
                        <StackPanel>
                            <TextBlock x:Name="lblBan" Text="Loại: Giao hàng"/>
                            <TextBlock x:Name="lblNhanVien" Text="Nhân viên: Nguyễn Văn A"/>
                            <TextBlock x:Name="lblNgay" Text="Giờ vào: 05/11/2025 18:00" HorizontalAlignment="Left"/>
                        </StackPanel>
                    </Grid>

                    <Border Background="#F5F5F5" CornerRadius="4" Padding="10" Margin="0,0,0,10">
                        <TextBlock x:Name="lblThongTinGiaoHang" Text="Giao hàng..." TextWrapping="Wrap" Foreground="{StaticResource DarkBrownBrush}"/>
                    </Border>

                    <DataGrid x:Name="dgItems" AutoGenerateColumns="False" IsReadOnly="True" CanUserAddRows="False"
                              GridLinesVisibility="Horizontal" HorizontalGridLinesBrush="#EEE"
                              Background="Transparent" BorderThickness="0"
                              HeadersVisibility="Column">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Tên món" Binding="{Binding TenSanPham}" Width="*"/>
                            <DataGridTextColumn Header="SL" Binding="{Binding SoLuong}" Width="40"/>
                            <DataGridTextColumn Header="Đơn giá" Binding="{Binding DonGia, StringFormat=N0}" Width="Auto"/>
                            <DataGridTextColumn Header="Thành tiền" Binding="{Binding ThanhTien, StringFormat=N0}" Width="Auto" FontWeight="SemiBold"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <Separator Margin="0,10"/>

                    <Grid Margin="0,5,0,5">
                        <TextBlock Text="Tổng tiền hàng" HorizontalAlignment="Left" FontSize="14"/>
                        <TextBlock x:Name="lblTongTienGoc" Text="0" HorizontalAlignment="Right" FontWeight="SemiBold" FontSize="14"/>
                    </Grid>

                    <Grid Margin="0,0,0,5">
                        <TextBlock Text="Giảm giá" HorizontalAlignment="Left" FontSize="14"/>
                        <TextBlock x:Name="lblGiamGia" Text="- 0" HorizontalAlignment="Right" FontWeight="SemiBold" Foreground="Green" FontSize="14"/>
                    </Grid>

                    <Separator Margin="0,10"/>

                    <Grid Margin="0,5,0,20">
                        <TextBlock Text="THÀNH TIỀN" FontSize="18" FontWeight="Bold" HorizontalAlignment="Left"/>
                        <TextBlock x:Name="lblThanhTien" Text="0" FontSize="20" FontWeight="Bold" HorizontalAlignment="Right"/>
                    </Grid>

                    <TextBlock Text="Cảm ơn quý khách!" HorizontalAlignment="Center" FontStyle="Italic"/>
                </StackPanel>
            </Border>
        </ScrollViewer>

        <Grid Grid.Row="1" x:Name="panelButtons">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Button x:Name="btnIn" Grid.Column="1" Style="{StaticResource SecondaryButton}" 
                    Content="In Phiếu" Width="100" Margin="5" Click="BtnIn_Click"/>

            <Button x:Name="btnClose" Grid.Column="2" Style="{StaticResource SecondaryButton}" 
                    Background="{StaticResource TextGrayBrush}" Foreground="White" BorderThickness="0"
                    Content="Đóng" Width="100" Margin="5" Click="BtnClose_Click" IsCancel="True"/>
        </Grid>
    </Grid>
</Window>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\PhieuGiaoHangPreviewWindow.xaml.cs
================================================================================
﻿// Tệp: AppCafebookApi/View/common/PhieuGiaoHangPreviewWindow.xaml.cs
using CafebookModel.Model.ModelApp.NhanVien;
using System;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media; // Cần cho VisualTreeHelper

// === SỬA LỖI CS0246: Đổi 'common' (thường) thành 'Common' (hoa) ===
namespace AppCafebookApi.View.Common
{
    public partial class PhieuGiaoHangPreviewWindow : Window
    {
        // SỬA: Dùng DTO của Phiếu Giao Hàng (từ GoiMonDto)
        private readonly PhieuGoiMonPrintDto _data;

        public PhieuGiaoHangPreviewWindow(PhieuGoiMonPrintDto data)
        {
            InitializeComponent(); // Lỗi CS0103 đã được fix
            _data = data;
        }

        private void Window_Loaded(object sender, RoutedEventArgs e)
        {
            // 1. Bind Thông tin quán
            lblTenQuan.Text = _data.TenQuan;
            lblDiaChi.Text = _data.DiaChiQuan;
            lblSoDienThoai.Text = $"SĐT: {_data.SdtQuan}";

            // 2. Bind Thông tin Hóa đơn
            lblTieuDe.Text = "PHIẾU GIAO HÀNG";
            lblSoHoaDon.Text = $"Số HĐ: {_data.IdPhieu}";
            lblBan.Text = $"Loại: {_data.SoBan}"; // "Giao hàng"
            lblNhanVien.Text = $"Nhân viên: {_data.TenNhanVien}";
            lblNgay.Text = $"Giờ tạo: {_data.NgayTao:dd/MM/yyyy HH:mm}";

            // 3. Bind Thông tin giao hàng
            lblThongTinGiaoHang.Text = _data.GhiChu; // Lỗi CS1061 đã được fix (ở file Dto)

            // 4. Bind Danh sách
            dgItems.ItemsSource = _data.ChiTiet;

            // 5. Bind Tiền (Phiếu này không có điểm/tiền khách đưa)
            lblTongTienGoc.Text = _data.TongTienGoc.ToString("N0"); // Lỗi CS0103 đã được fix
            lblGiamGia.Text = $"- {_data.GiamGia:N0}";
            lblThanhTien.Text = _data.ThanhTien.ToString("N0") + " đ";
        }

        // ... (Hàm BtnIn_Click và BtnClose_Click giữ nguyên) ...
        private void BtnIn_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                PrintDialog printDialog = new PrintDialog();
                if (printDialog.ShowDialog() == true)
                {
                    panelButtons.Visibility = Visibility.Collapsed;
                    var scrollViewer = printArea.Parent as ScrollViewer;
                    if (scrollViewer == null)
                    {
                        panelButtons.Visibility = Visibility.Visible;
                        return;
                    }
                    var originalContent = scrollViewer.Content;
                    scrollViewer.Content = null;
                    printArea.Width = printDialog.PrintableAreaWidth;
                    printArea.Height = double.NaN;
                    printArea.Measure(new Size(printDialog.PrintableAreaWidth, double.PositiveInfinity));
                    printArea.Arrange(new Rect(new Point(0, 0), printArea.DesiredSize));
                    printDialog.PrintVisual(printArea, "Phiếu Giao Hàng CafeBook");
                    printArea.Width = 380;
                    printArea.Height = double.NaN;
                    scrollViewer.Content = originalContent;
                    panelButtons.Visibility = Visibility.Visible;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi in: {ex.Message}");
                if (panelButtons != null) panelButtons.Visibility = Visibility.Visible;
            }
        }

        private void BtnClose_Click(object sender, RoutedEventArgs e)
        {
            this.Close();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\PhieuGoiMonPreviewWindow.xaml
================================================================================
﻿<Window x:Class="AppCafebookApi.View.Common.PhieuGoiMonPreviewWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d"
        Title="Phiếu Gọi Món (Tạm Tính)" Height="600" Width="400"
        WindowStartupLocation="CenterScreen"
        FontFamily="Segoe UI"
        Background="White"
        Loaded="Window_Loaded">

    <!-- ========== COLOR + STYLE RESOURCE ========== -->
    <Window.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#795548"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionOrangeBrush" Color="#FFA726"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="PrimaryBrown" Color="#6F4E37"/>
        <SolidColorBrush x:Key="AccentOrange" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteText" Color="#FFFFFF"/>

        <!-- Nút chính -->
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrown}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteText}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Height" Value="42"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                    CornerRadius="21"
                                    Background="{TemplateBinding Background}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="2" Color="#6F4E37" Opacity="0.3" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource AccentOrange}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                                <Setter TargetName="border" Property="Opacity" Value="0.7"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Nút phụ -->
        <Style x:Key="SecondaryButton" TargetType="Button" BasedOn="{StaticResource PrimaryButton}">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="BorderThickness" Value="2"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                    CornerRadius="21"
                                    Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource SubtleGrayBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>



        <!-- ========== PHẦN HIỂN THỊ PHIẾU ========== -->
        <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto">
            <Border x:Name="PrintArea" Padding="20" Background="White">
                <StackPanel>
                    <!-- Header -->
                    <TextBlock x:Name="lblTenQuan" Text="Cafe Sách Bookshuheheee" FontSize="20" FontWeight="Bold" HorizontalAlignment="Center" TextAlignment="Center"/>
                    <TextBlock x:Name="lblDiaChiQuan" Text="08 Hà Văn Tín, Liên Chiểu, Đà Nẵng" HorizontalAlignment="Center" TextAlignment="Center" TextWrapping="Wrap" Margin="0,2,0,0"/>
                    <TextBlock x:Name="lblSdtQuan" Text="SĐT: 0376512695" HorizontalAlignment="Center" Margin="0,2,0,0"/>

                    <Separator Margin="0,10"/>

                    <!-- Tiêu đề -->
                    <TextBlock Text="PHIẾU GỌI MÓN" FontSize="18" FontWeight="Bold" HorizontalAlignment="Center" Margin="0,5,0,5"/>
                    <TextBlock x:Name="lblIdPhieu" Text="Mã: HD000001" HorizontalAlignment="Center" FontSize="12" Foreground="Gray"/>

                    <!-- Thông tin đơn -->
                    <Grid Margin="0,10,0,0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Ngày:" FontWeight="SemiBold"/>
                        <TextBlock Grid.Row="0" Grid.Column="1" x:Name="lblNgayTao" Text="08/11/2025 18:00" HorizontalAlignment="Right"/>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Bàn:" FontWeight="SemiBold" Margin="0,4,0,0"/>
                        <TextBlock Grid.Row="1" Grid.Column="1" x:Name="lblSoBan" Text="Bàn 01" HorizontalAlignment="Right" FontWeight="Bold" Margin="0,4,0,0"/>

                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Nhân viên:" FontWeight="SemiBold" Margin="0,4,0,0"/>
                        <TextBlock Grid.Row="2" Grid.Column="1" x:Name="lblTenNhanVien" Text="Nguyễn Văn A" HorizontalAlignment="Right" Margin="0,4,0,0"/>
                    </Grid>


                    <Separator Margin="0,10"/>

                    <!-- Danh sách món -->
                    <DataGrid x:Name="dgChiTiet" AutoGenerateColumns="False" IsReadOnly="True" CanUserAddRows="False"
                              GridLinesVisibility="Horizontal" HeadersVisibility="Column" Background="White"
                              BorderThickness="0" HorizontalGridLinesBrush="#EEE">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Tên Món" Binding="{Binding TenSanPham}" Width="*"/>
                            <DataGridTextColumn Header="SL" Binding="{Binding SoLuong}" Width="Auto"/>
                            <DataGridTextColumn Header="Đ.Giá" Binding="{Binding DonGia, StringFormat=N0}" Width="Auto"/>
                            <DataGridTextColumn Header="T.Tiền" Binding="{Binding ThanhTien, StringFormat=N0}" Width="Auto" FontWeight="SemiBold"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <Separator Margin="0,10"/>

                    <!-- Tổng tiền -->
                    <Grid Margin="0,5,0,0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Tổng tiền hàng -->
                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Tổng tiền hàng:" FontSize="14" Margin="0,3,0,0"/>
                        <TextBlock Grid.Row="0" Grid.Column="1" x:Name="lblTongTienGoc" Text="0 đ" FontSize="14" 
               HorizontalAlignment="Right" FontWeight="SemiBold" Margin="0,3,0,0"/>

                        <!-- Giảm giá -->
                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Giảm giá:" FontSize="14" Foreground="#008000" Margin="0,3,0,0"/>
                        <TextBlock Grid.Row="1" Grid.Column="1" x:Name="lblGiamGia" Text="0 đ" FontSize="14" 
               HorizontalAlignment="Right" FontWeight="SemiBold" Foreground="#008000" Margin="0,3,0,0"/>

                        <!-- Thành tiền -->
                        <TextBlock Grid.Row="2" Grid.Column="0" Text="THÀNH TIỀN:" FontSize="16" FontWeight="Bold" Margin="0,10,0,0"/>
                        <TextBlock Grid.Row="2" Grid.Column="1" x:Name="lblThanhTien" Text="0 đ" FontSize="18" 
               HorizontalAlignment="Right" FontWeight="Bold" Foreground="#6F4E37" Margin="0,10,0,0"/>
                    </Grid>

                </StackPanel>
            </Border>
        </ScrollViewer>

        <!-- ========== NÚT CHỨC NĂNG ========== -->
        <Border Grid.Row="1" Padding="10" Background="#F5F5F5" BorderBrush="#E0E0E0" BorderThickness="0,1,0,0">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                <Button x:Name="btnPrint" Style="{StaticResource PrimaryButton}" 
                        Content="In Phiếu" Width="120" Margin="5" Click="BtnPrint_Click"/>
                <Button x:Name="btnClose" Style="{StaticResource SecondaryButton}" 
                        Background="{StaticResource TextGrayBrush}" Foreground="White" BorderThickness="0"
                        Content="Đóng" Width="120" Margin="5" Click="BtnClose_Click" IsCancel="True"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>

================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\PhieuGoiMonPreviewWindow.xaml.cs
================================================================================
﻿using CafebookModel.Model.ModelApp.NhanVien;
using System;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;

// SỬA: Đổi "common" thành "Common" để khớp với x:Class trong file .xaml
namespace AppCafebookApi.View.Common
{
    public partial class PhieuGoiMonPreviewWindow : Window
    {
        private readonly int _idHoaDon;
        private static readonly HttpClient _httpClient;

        static PhieuGoiMonPreviewWindow()
        {
            _httpClient = new HttpClient { BaseAddress = new Uri("http://localhost:5166") };
        }

        public PhieuGoiMonPreviewWindow(int idHoaDon)
        {
            InitializeComponent(); // Lỗi CS0103 sẽ biến mất
            _idHoaDon = idHoaDon;
        }

        private async void Window_Loaded(object sender, RoutedEventArgs e)
        {
            try
            {
                var data = await _httpClient.GetFromJsonAsync<PhieuGoiMonPrintDto>($"api/app/nhanvien/goimon/print-data/{_idHoaDon}");
                if (data != null)
                {
                    // Các lỗi CS0103 ở đây sẽ biến mất
                    lblTenQuan.Text = data.TenQuan;
                    lblDiaChiQuan.Text = data.DiaChiQuan;
                    lblSdtQuan.Text = $"SĐT: {data.SdtQuan}";
                    lblIdPhieu.Text = $"Mã: {data.IdPhieu}";
                    lblNgayTao.Text = data.NgayTao.ToString("dd/MM/yyyy HH:mm");
                    lblSoBan.Text = data.SoBan;
                    lblTenNhanVien.Text = data.TenNhanVien;

                    dgChiTiet.ItemsSource = data.ChiTiet;

                    lblTongTienGoc.Text = data.TongTienGoc.ToString("N0") + " đ";
                    lblGiamGia.Text = data.GiamGia.ToString("N0") + " đ";
                    lblThanhTien.Text = data.ThanhTien.ToString("N0") + " đ";
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải dữ liệu in: {ex.Message}", "Lỗi API");
                this.Close();
            }
        }

        private void BtnPrint_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                PrintDialog printDialog = new PrintDialog();
                if (printDialog.ShowDialog() == true)
                {
                    // Tạm ẩn nút In trước khi in
                    btnPrint.Visibility = Visibility.Collapsed;

                    // In khu vực PrintArea
                    printDialog.PrintVisual(PrintArea, "Phiếu Gọi Món Cafebook");

                    // Hiện lại nút In
                    btnPrint.Visibility = Visibility.Visible;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi khi in: {ex.Message}", "Lỗi In");
            }
            finally
            {
                // Hiện lại nút In nếu có lỗi
                btnPrint.Visibility = Visibility.Visible;
            }
        }

        private void BtnClose_Click(object sender, RoutedEventArgs e)
        {
            this.Close();
        }

    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\PhieuLuongPreviewWindow.xaml
================================================================================
﻿<Window x:Class="AppCafebookApi.View.Common.PhieuLuongPreviewWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Chi tiết Phiếu Lương" Height="700" Width="500"
        WindowStartupLocation="CenterOwner" ShowInTaskbar="False"
        WindowStyle="ToolWindow" FontFamily="Segoe UI" FontSize="14"
        Background="White"
        Loaded="Window_Loaded">

    <Window.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionOrangeBrush" Color="#FFA726"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="PrimaryBrown" Color="#6F4E37"/>
        <SolidColorBrush x:Key="AccentOrange" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteText" Color="#FFFFFF"/>

        <Geometry x:Key="IconConfirm">M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z</Geometry>
        <Geometry x:Key="IconPrint">M19,8H5C3.34,8 2,9.34 2,11V17H6V21H18V17H22V11C22,9.34 20.66,8 19,8M16,19H8V14H16V19M19,12C18.45,12 18,11.55 18,11C18,10.45 18.45,10 19,10C19.55,10 20,10.45 20,11C20,11.55 19.55,12 19,12M18,3H6V7H18V3Z</Geometry>
        <Geometry x:Key="IconClose">M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z</Geometry>

        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrown}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteText}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Height" Value="42"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                CornerRadius="21"
                                Background="{TemplateBinding Background}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="2" Color="#6F4E37" Opacity="0.3" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource AccentOrange}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                                <Setter TargetName="border" Property="Opacity" Value="0.7"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="SecondaryButton" TargetType="Button" BasedOn="{StaticResource PrimaryButton}">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="BorderThickness" Value="2"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                CornerRadius="21"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource SubtleGrayBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto">

            <Border x:Name="printArea" Background="White" Margin="20" Padding="25" BorderBrush="LightGray" BorderThickness="1">

                <StackPanel>

                    <StackPanel x:Name="headerPanel">
                        <TextBlock Text="{Binding TenQuan}" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center" Foreground="{StaticResource DarkBrownBrush}"/>
                        <TextBlock Text="{Binding DiaChi}" FontSize="11" Foreground="{StaticResource TextGrayBrush}" HorizontalAlignment="Center" Margin="0,0,0,2"/>
                        <TextBlock Text="{Binding SoDienThoai, StringFormat='SĐT: {0}'}" FontSize="11" Foreground="{StaticResource TextGrayBrush}" HorizontalAlignment="Center"/>
                    </StackPanel>

                    <TextBlock Text="PHIẾU THANH TOÁN LƯƠNG" FontSize="18" FontWeight="SemiBold" HorizontalAlignment="Center" Margin="0,20,0,15" Foreground="{StaticResource PrimaryBrownBrush}"/>

                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition/>
                            <RowDefinition/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Nhân viên:" FontWeight="SemiBold" Margin="0,2,10,2"/>
                        <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding HoTenNhanVien}" TextAlignment="Right" FontWeight="SemiBold" FontSize="16"/>
                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Kỳ lương:" FontWeight="SemiBold" Margin="0,2,10,2"/>
                        <StackPanel Grid.Row="1" Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                            <TextBlock Text="{Binding Thang}"/>
                            <TextBlock Text="/"/>
                            <TextBlock Text="{Binding Nam}"/>
                        </StackPanel>
                    </Grid>

                    <Border BorderBrush="LightGray" BorderThickness="1" CornerRadius="3" Padding="10">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition/>
                                <RowDefinition/>
                                <RowDefinition/>
                                <RowDefinition/>
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Lương cơ bản (giờ)" Margin="0,3"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding LuongCoBan, StringFormat='{}{0:N0} đ/giờ'}" TextAlignment="Right" Margin="0,3" FontWeight="SemiBold"/>
                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Tổng giờ làm" Margin="0,3"/>
                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding TongGioLam, StringFormat='{}{0:F2} giờ'}" TextAlignment="Right" Margin="0,3" FontWeight="SemiBold"/>
                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Các khoản thưởng" Margin="0,3"/>
                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding TienThuong, StringFormat='+ {0:N0} đ'}" Foreground="{StaticResource SuccessBrush}" TextAlignment="Right" Margin="0,3" FontWeight="SemiBold"/>
                            <TextBlock Grid.Row="3" Grid.Column="0" Text="Các khoản phạt" Margin="0,3"/>
                            <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding KhauTru, StringFormat='- {0:N0} đ'}" Foreground="{StaticResource ErrorBrush}" TextAlignment="Right" Margin="0,3" FontWeight="SemiBold"/>
                        </Grid>
                    </Border>

                    <Grid Margin="0,15,0,20">
                        <TextBlock Text="THỰC LÃNH" FontSize="18" FontWeight="Bold" VerticalAlignment="Center" HorizontalAlignment="Left" Foreground="{StaticResource DarkBrownBrush}"/>
                        <TextBlock Text="{Binding ThucLanh, StringFormat='{}{0:N0} đ'}" FontSize="20" FontWeight="Bold" Foreground="{StaticResource AccentOrange}" HorizontalAlignment="Right"/>
                    </Grid>
                    <Border BorderBrush="LightGray" BorderThickness="0,1,0,0" Padding="0,10,0,0" Margin="0,0,0,20">
                        <Grid TextElement.FontSize="12" TextElement.Foreground="{StaticResource TextGrayBrush}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition/>
                                <RowDefinition/>
                                <RowDefinition/>
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Trạng thái:" Margin="0,2,10,2"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding TrangThai}" FontWeight="Bold" TextAlignment="Right">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding TrangThai}" Value="Đã phát">
                                                <Setter Property="Foreground" Value="{StaticResource SuccessBrush}"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding TrangThai}" Value="Đã chốt">
                                                <Setter Property="Foreground" Value="{StaticResource ActionOrangeBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Ngày phát:" Margin="0,2,10,2"/>
                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding NgayPhat, StringFormat='dd/MM/yyyy HH:mm'}" TextAlignment="Right"/>
                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Người phát:" Margin="0,2,10,2"/>
                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding TenNguoiPhat}" TextAlignment="Right"/>
                        </Grid>
                    </Border>
                    <Grid Margin="0,20,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                            <TextBlock Text="Người phát" HorizontalAlignment="Center" FontWeight="SemiBold"/>
                            <TextBlock Text="(Ký, ghi rõ họ tên)" HorizontalAlignment="Center" FontSize="11" FontStyle="Italic" Foreground="{StaticResource TextGrayBrush}"/>
                        </StackPanel>
                        <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                            <TextBlock Text="Người nhận" HorizontalAlignment="Center" FontWeight="SemiBold"/>
                            <TextBlock Text="(Ký, ghi rõ họ tên)" HorizontalAlignment="Center" FontSize="11" FontStyle="Italic" Foreground="{StaticResource TextGrayBrush}"/>
                        </StackPanel>
                    </Grid>

                </StackPanel>
            </Border>
        </ScrollViewer>

        <Border Grid.Row="1" Background="{StaticResource SubtleGrayBrush}" BorderBrush="LightGray" BorderThickness="0,1,0,0" Padding="15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <Button x:Name="btnXacNhanPhat" Grid.Column="0" Style="{StaticResource PrimaryButton}" 
                        Background="{StaticResource SuccessBrush}" Click="BtnXacNhanPhat_Click" 
                        Width="Auto" Padding="15,0" Grid.ColumnSpan="2" Margin="0,5,72,5">
                    <StackPanel Orientation="Horizontal">
                        <Path Data="{StaticResource IconConfirm}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                        <TextBlock Text="Xác nhận Phát Lương" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <Button x:Name="btnPrint" Grid.Column="2" Style="{StaticResource SecondaryButton}" 
                        Content="In Phiếu" Width="100" Margin="5" Click="BtnPrint_Click"/>

                <Button x:Name="btnClose" Grid.Column="3" Style="{StaticResource SecondaryButton}" 
                        Background="{StaticResource TextGrayBrush}" Foreground="White" BorderThickness="0"
                        Content="Đóng" Width="100" Margin="5" Click="BtnClose_Click" IsCancel="True"/>
            </Grid>
        </Border>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="2" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Đang xử lý..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" 
Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Window>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\PhieuLuongPreviewWindow.xaml.cs
================================================================================
﻿using System;
using System.Linq; // Cần thêm
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using AppCafebookApi.Services;
using CafebookModel.Model.ModelApp;

namespace AppCafebookApi.View.Common
{
    public partial class PhieuLuongPreviewWindow : Window
    {
        private static readonly HttpClient httpClient;
        private int _idPhieuLuong;
        private PhieuLuongChiTietDto? _phieuLuong;
        private CaiDatThongTinCuaHangDto? _thongTinCuaHang; // Thêm đối tượng mới

        static PhieuLuongPreviewWindow()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public PhieuLuongPreviewWindow(int idPhieuLuong)
        {
            InitializeComponent();
            _idPhieuLuong = idPhieuLuong;
        }

        private async void Window_Loaded(object sender, RoutedEventArgs e)
        {
            LoadingOverlay.Visibility = Visibility.Visible;

            // Thực hiện song song 2 tác vụ tải dữ liệu
            var loadPhieuTask = LoadChiTietPhieuLuongAsync();
            var loadInfoTask = LoadThongTinCuaHangAsync();

            await Task.WhenAll(loadPhieuTask, loadInfoTask);

            // Gán DataContext sau khi cả hai đã tải xong
            if (_phieuLuong != null && _thongTinCuaHang != null)
            {
                // Gán chi tiết phiếu lương cho khu vực chính (printArea)
                printArea.DataContext = _phieuLuong;

                // Gán thông tin cửa hàng cho khu vực header (headerPanel)
                headerPanel.DataContext = _thongTinCuaHang;

                // Xử lý logic nút bấm (nếu cần)
                if (_phieuLuong.TrangThai == "Đã phát")
                {
                    btnXacNhanPhat.IsEnabled = false;
                    if (btnXacNhanPhat.Content is StackPanel sp)
                    {
                        var tb = sp.Children.OfType<TextBlock>().FirstOrDefault();
                        if (tb != null)
                        {
                            tb.Text = "Đã Phát";
                        }
                    }
                }
            }
            else
            {
                MessageBox.Show("Không thể tải đầy đủ thông tin phiếu lương hoặc thông tin cửa hàng.", "Lỗi API");
                this.Close();
            }

            LoadingOverlay.Visibility = Visibility.Collapsed;
        }

        /// <summary>
        /// Tải chi tiết phiếu lương (API 1)
        /// </summary>
        private async Task LoadChiTietPhieuLuongAsync()
        {
            try
            {
                var response = await httpClient.GetAsync($"api/app/phatluong/chitiet/{_idPhieuLuong}");
                if (response.IsSuccessStatusCode)
                {
                    _phieuLuong = await response.Content.ReadFromJsonAsync<PhieuLuongChiTietDto>();
                }
                else
                {
                    // Xử lý lỗi ở hàm Window_Loaded
                }
            }
            catch (Exception)
            {
                // Xử lý lỗi ở hàm Window_Loaded
            }
        }

        /// <summary>
        /// Tải thông tin cửa hàng (API 2)
        /// </summary>
        private async Task LoadThongTinCuaHangAsync()
        {
            try
            {
                var response = await httpClient.GetAsync("api/app/caidat/thong-tin-cua-hang");
                if (response.IsSuccessStatusCode)
                {
                    _thongTinCuaHang = await response.Content.ReadFromJsonAsync<CaiDatThongTinCuaHangDto>();
                }
                else
                {
                    // Nếu thất bại, tạo đối tượng rỗng để tránh lỗi
                    _thongTinCuaHang = new CaiDatThongTinCuaHangDto { TenQuan = "N/A", DiaChi = "N/A", SoDienThoai = "N/A" };
                }
            }
            catch (Exception)
            {
                _thongTinCuaHang = new CaiDatThongTinCuaHangDto { TenQuan = "Lỗi", DiaChi = "Lỗi", SoDienThoai = "Lỗi" };
            }
        }

        // ... (Các hàm BtnXacNhanPhat_Click, BtnPrint_Click, BtnClose_Click giữ nguyên y hệt) ...

        private async void BtnXacNhanPhat_Click(object sender, RoutedEventArgs e)
        {
            if (_phieuLuong == null || AuthService.CurrentUser == null)
            {
                MessageBox.Show("Lỗi: Không có thông tin phiếu lương hoặc người dùng.", "Lỗi");
                return;
            }

            var confirm = MessageBox.Show($"Xác nhận phát lương cho:\n\nNhân viên: {_phieuLuong.HoTenNhanVien}\nSố tiền: {_phieuLuong.ThucLanh:N0} đ",
                                        "Xác nhận Phát Lương", MessageBoxButton.YesNo, MessageBoxImage.Warning);

            if (confirm == MessageBoxResult.No) return;

            LoadingOverlay.Visibility = Visibility.Visible;

            var dto = new PhatLuongXacNhanDto
            {
                IdNguoiPhat = AuthService.CurrentUser.IdNhanVien
            };

            try
            {
                var response = await httpClient.PutAsJsonAsync($"api/app/phatluong/xacnhan/{_idPhieuLuong}", dto);

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Xác nhận phát lương thành công!", "Thành công", MessageBoxButton.OK, MessageBoxImage.Information);
                    this.DialogResult = true;
                    this.Close();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnPrint_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                PrintDialog printDialog = new PrintDialog();
                if (printDialog.ShowDialog() == true)
                {
                    var scrollViewer = printArea.Parent as ScrollViewer;
                    if (scrollViewer != null)
                    {
                        scrollViewer.VerticalScrollBarVisibility = ScrollBarVisibility.Hidden;
                    }

                    printDialog.PrintVisual(printArea, "In Phiếu Lương");

                    if (scrollViewer != null)
                    {
                        scrollViewer.VerticalScrollBarVisibility = ScrollBarVisibility.Auto;
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi khi in: {ex.Message}", "Lỗi In ấn");
            }
        }

        private void BtnClose_Click(object sender, RoutedEventArgs e)
        {
            this.DialogResult = false;
            this.Close();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\PhieuThuePreviewWindow.xaml
================================================================================
﻿<Window x:Class="AppCafebookApi.View.common.PhieuThuePreviewWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AppCafebookApi.View.common"
        mc:Ignorable="d"
        Title="Xem Trước Phiếu Thuê Sách" Height="800" Width="500"
        WindowStartupLocation="CenterScreen"
        WindowStyle="ToolWindow"
        Loaded="Window_Loaded">

    <Window.Resources>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#795548"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionOrangeBrush" Color="#FFA726"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="PrimaryBrown" Color="#6F4E37"/>
        <SolidColorBrush x:Key="AccentOrange" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteText" Color="#FFFFFF"/>
        <Style x:Key="RightAligned" TargetType="TextBlock">
            <Setter Property="TextAlignment" Value="Right"/>
        </Style>
        <Style TargetType="TextBlock" x:Key="Header">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
        </Style>
        <Style TargetType="TextBlock" x:Key="SubHeader">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
        </Style>
        <Style TargetType="TextBlock" x:Key="SectionTitle">
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Margin" Value="0,10,0,5"/>
        </Style>
        <Style TargetType="DataGridColumnHeader">
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrown}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteText}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Height" Value="42"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                CornerRadius="21"
                                Background="{TemplateBinding Background}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="2" Color="#6F4E37" Opacity="0.3" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource AccentOrange}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                                <Setter TargetName="border" Property="Opacity" Value="0.7"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="SecondaryButton" TargetType="Button" BasedOn="{StaticResource PrimaryButton}">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="BorderThickness" Value="2"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                CornerRadius="21"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource SubtleGrayBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <ScrollViewer Grid.Row="0" x:Name="scrollViewer" VerticalScrollBarVisibility="Auto">
            <Border x:Name="printArea" Background="White" Padding="20" Margin="10" MinHeight="700">
                <StackPanel>
                    <TextBlock x:Name="lblTenQuan" Style="{StaticResource Header}" Text="Cafebook"/>
                    <TextBlock x:Name="lblDiaChiQuan" Style="{StaticResource SubHeader}" Text="123 Đường ABC, Q.1, TP.HCM"/>
                    <TextBlock x:Name="lblSdtQuan" Style="{StaticResource SubHeader}" Text="SĐT: 0987654321"/>

                    <Separator Margin="0,10"/>

                    <TextBlock Style="{StaticResource Header}" Text="PHIẾU THUÊ SÁCH" FontSize="18" Margin="0,5"/>
                    <TextBlock x:Name="lblMaPhieu" Style="{StaticResource SubHeader}" Text="Mã: PT000001" FontWeight="SemiBold"/>
                    <TextBlock x:Name="lblNgayTao" Style="{StaticResource SubHeader}" Text="Ngày: 01/01/2025 10:30"/>

                    <StackPanel Margin="0,15,0,0">
                        <TextBlock Text="Khách hàng:" FontWeight="SemiBold"/>
                        <TextBlock x:Name="lblTenKhach" Text="Nguyễn Văn A" Margin="10,0,0,0"/>
                        <TextBlock x:Name="lblSdtKhach" Text="SĐT: 0909123456" Margin="10,0,0,0"/>
                    </StackPanel>

                    <StackPanel Margin="0,5,0,0">
                        <TextBlock Text="Nhân viên:" FontWeight="SemiBold"/>
                        <TextBlock x:Name="lblTenNhanVien" Text="Trần Thị B" Margin="10,0,0,0"/>
                    </StackPanel>

                    <StackPanel Margin="0,5,0,0">
                        <TextBlock Text="Ngày hẹn trả:" FontWeight="SemiBold"/>
                        <TextBlock x:Name="lblNgayHenTra" Text="10/01/2025" Margin="10,0,0,0" FontWeight="Bold" Foreground="Red"/>
                    </StackPanel>

                    <TextBlock Style="{StaticResource SectionTitle}" Text="SÁCH THUÊ"/>
                    <DataGrid x:Name="dgChiTiet" AutoGenerateColumns="False" IsReadOnly="True" GridLinesVisibility="None" HeadersVisibility="Column"
                              BorderThickness="0" Background="White">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Tên Sách" Binding="{Binding TenSach}" Width="*"/>
                            <DataGridTextColumn Header="Tiền Cọc" Binding="{Binding TienCoc, StringFormat=N0}" Width="Auto" ElementStyle="{StaticResource RightAligned}"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <Grid Margin="0,20,0,0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Phí thuê (tạm tính)" 
                                    HorizontalAlignment="Right" FontWeight="SemiBold"/>
                        <TextBlock Grid.Row="0" Grid.Column="1" x:Name="lblPhiThue" Text="10,000" 
                                    HorizontalAlignment="Right" Margin="20,0,0,0"/>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="TỔNG TIỀN CỌC" 
                                    HorizontalAlignment="Right" FontWeight="Bold" FontSize="16" Margin="0,5,0,0"/>
                        <TextBlock Grid.Row="1" Grid.Column="1" x:Name="lblTongCoc" Text="200,000" 
                                    HorizontalAlignment="Right" Margin="20,5,0,0" FontWeight="Bold" FontSize="16"/>
                    </Grid>


                    <TextBlock Text="Cảm ơn quý khách!" FontStyle="Italic" HorizontalAlignment="Center" Margin="0,30,0,0"/>
                    <TextBlock Text="(Vui lòng trả sách đúng hạn để tránh phát sinh phí)" FontSize="10" HorizontalAlignment="Center" Margin="0,5,0,0"/>
                </StackPanel>
            </Border>
        </ScrollViewer>

        <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Background="{StaticResource SubtleGrayBrush}" Width="{Binding Path=ActualWidth, ElementName=scrollViewer}">
            <Button x:Name="BtnPrint" Grid.Column="1" Style="{StaticResource SecondaryButton}" 
                    Content="In Phiếu" Width="100" Margin="5" Click="BtnPrint_Click"/>

            <Button x:Name="BtnClose" Grid.Column="2" Style="{StaticResource SecondaryButton}" 
                    Background="{StaticResource TextGrayBrush}" Foreground="White" BorderThickness="0"
                    Content="Đóng" Width="100" Margin="5" Click="BtnClose_Click" IsCancel="True"/>
        </StackPanel>
    </Grid>
</Window>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\PhieuThuePreviewWindow.xaml.cs
================================================================================
﻿using System;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using CafebookModel.Model.ModelApp.NhanVien;

namespace AppCafebookApi.View.common
{
    public partial class PhieuThuePreviewWindow : Window
    {
        private static readonly HttpClient httpClient;
        private readonly int _idPhieuThue;

        static PhieuThuePreviewWindow()
        {
            httpClient = new HttpClient { BaseAddress = new Uri("http://127.0.0.1:5166") };
        }

        public PhieuThuePreviewWindow(int idPhieuThue)
        {
            InitializeComponent();
            _idPhieuThue = idPhieuThue;
        }

        private async void Window_Loaded(object sender, RoutedEventArgs e)
        {
            try
            {
                var data = await httpClient.GetFromJsonAsync<PhieuThuePrintDto>($"api/app/nhanvien/thuesach/print-data/{_idPhieuThue}");
                if (data == null)
                {
                    MessageBox.Show("Không tìm thấy dữ liệu phiếu thuê.");
                    this.Close();
                    return;
                }

                // Đổ dữ liệu vào UI
                lblTenQuan.Text = data.TenQuan;
                lblDiaChiQuan.Text = data.DiaChiQuan;
                lblSdtQuan.Text = $"SĐT: {data.SdtQuan}";
                lblMaPhieu.Text = $"Mã: {data.IdPhieu}";
                lblNgayTao.Text = $"Ngày: {data.NgayTao:dd/MM/yyyy HH:mm}";

                lblTenKhach.Text = data.TenKhachHang;
                lblSdtKhach.Text = $"SĐT: {data.SdtKhachHang}";
                lblTenNhanVien.Text = data.TenNhanVien;
                lblNgayHenTra.Text = $"{data.NgayHenTra:dd/MM/yyyy}";

                dgChiTiet.ItemsSource = data.ChiTiet;

                lblPhiThue.Text = $"{data.TongPhiThue:N0} đ";
                lblTongCoc.Text = $"{data.TongTienCoc:N0} đ";
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi khi tải dữ liệu in: {ex.Message}", "Lỗi API");
                this.Close();
            }
        }

        private void BtnPrint_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                var printDialog = new PrintDialog();
                if (printDialog.ShowDialog() == true)
                {
                    // Tạm ẩn 2 nút để khi in không bị thấy
                    (sender as Button)!.Visibility = Visibility.Collapsed;
                    (FindName("BtnClose") as Button)!.Visibility = Visibility.Collapsed;

                    printDialog.PrintVisual(printArea, "In Phiếu Thuê Sách");

                    // Hiện lại 2 nút
                    (sender as Button)!.Visibility = Visibility.Visible;
                    (FindName("BtnClose") as Button)!.Visibility = Visibility.Visible;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi khi in: {ex.Message}", "Lỗi");
            }
        }

        private void BtnClose_Click(object sender, RoutedEventArgs e)
        {
            this.Close();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\PhieuTraPreviewWindow.xaml
================================================================================
﻿<Window x:Class="AppCafebookApi.View.common.PhieuTraPreviewWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AppCafebookApi.View.common"
        mc:Ignorable="d"
        Title="Xem Trước Phiếu Trả Sách" Height="800" Width="500"
        WindowStartupLocation="CenterScreen"
        WindowStyle="ToolWindow"
        Loaded="Window_Loaded">


    <Window.Resources>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#795548"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionOrangeBrush" Color="#FFA726"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="PrimaryBrown" Color="#6F4E37"/>
        <SolidColorBrush x:Key="AccentOrange" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteText" Color="#FFFFFF"/>
        <Style x:Key="RightAligned" TargetType="TextBlock">
            <Setter Property="TextAlignment" Value="Right"/>
        </Style>
        <Style TargetType="TextBlock" x:Key="Header">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
        </Style>
        <Style TargetType="TextBlock" x:Key="SubHeader">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
        </Style>
        <Style TargetType="TextBlock" x:Key="SectionTitle">
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Margin" Value="0,10,0,5"/>
        </Style>
        <Style TargetType="DataGridColumnHeader">
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrown}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteText}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Height" Value="42"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                CornerRadius="21"
                                Background="{TemplateBinding Background}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="2" Color="#6F4E37" Opacity="0.3" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource AccentOrange}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                                <Setter TargetName="border" Property="Opacity" Value="0.7"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="SecondaryButton" TargetType="Button" BasedOn="{StaticResource PrimaryButton}">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="BorderThickness" Value="2"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                CornerRadius="21"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource SubtleGrayBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <ScrollViewer Grid.Row="0" x:Name="scrollViewer" VerticalScrollBarVisibility="Auto">
            <Border x:Name="printArea" Background="White" Padding="20" Margin="10" MinHeight="700">
                <StackPanel>
                    <TextBlock x:Name="lblTenQuan" Style="{StaticResource Header}" Text="Cafebook"/>
                    <TextBlock x:Name="lblDiaChiQuan" Style="{StaticResource SubHeader}" Text="123 Đường ABC, Q.1, TP.HCM"/>
                    <TextBlock x:Name="lblSdtQuan" Style="{StaticResource SubHeader}" Text="SĐT: 0987654321"/>

                    <Separator Margin="0,10"/>

                    <TextBlock Style="{StaticResource Header}" Text="PHIẾU TRẢ SÁCH" FontSize="18" Margin="0,5"/>
                    <TextBlock x:Name="lblMaPhieu" Style="{StaticResource SubHeader}" Text="Mã: PTR000001" FontWeight="SemiBold"/>
                    <TextBlock x:Name="lblNgayTao" Style="{StaticResource SubHeader}" Text="Ngày: 01/01/2025 10:30"/>

                    <StackPanel Margin="0,15,0,0">
                        <TextBlock Text="Khách hàng:" FontWeight="SemiBold"/>
                        <TextBlock x:Name="lblTenKhach" Text="Nguyễn Văn A" Margin="10,0,0,0"/>
                        <TextBlock x:Name="lblSdtKhach" Text="SĐT: 0909123456" Margin="10,0,0,0"/>
                    </StackPanel>

                    <StackPanel Margin="0,5,0,0">
                        <TextBlock Text="Nhân viên:" FontWeight="SemiBold"/>
                        <TextBlock x:Name="lblTenNhanVien" Text="Trần Thị B" Margin="10,0,0,0"/>
                    </StackPanel>

                    <StackPanel Margin="0,5,0,0">
                        <TextBlock Text="Phiếu thuê gốc:" FontWeight="SemiBold"/>
                        <TextBlock x:Name="lblPhieuThueGoc" Text="PT000001" Margin="10,0,0,0"/>
                    </StackPanel>

                    <TextBlock Style="{StaticResource SectionTitle}" Text="SÁCH TRẢ"/>
                    <DataGrid x:Name="dgChiTiet" AutoGenerateColumns="False" IsReadOnly="True" GridLinesVisibility="None" HeadersVisibility="Column"
                              BorderThickness="0" Background="White">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Tên Sách" Binding="{Binding TenSach}" Width="*"/>
                            <DataGridTextColumn Header="Tiền Cọc" Binding="{Binding TienCoc, StringFormat=N0}" Width="Auto" ElementStyle="{StaticResource RightAligned}"/>
                            <DataGridTextColumn Header="Tiền Phạt" Binding="{Binding TienPhat, StringFormat=N0}" Width="Auto" ElementStyle="{StaticResource RightAligned}"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <Grid Margin="0,20,0,0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Tổng tiền cọc -->
                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Tổng tiền cọc"
               HorizontalAlignment="Right" FontWeight="SemiBold"
               Margin="0,2,0,2"/>
                        <TextBlock Grid.Row="0" Grid.Column="1" x:Name="lblTongCoc"
               Text="200,000" HorizontalAlignment="Right"
               Margin="20,2,0,2" FontWeight="SemiBold"/>

                        <!-- Tổng phí thuê -->
                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Tổng phí thuê"
               HorizontalAlignment="Right" FontWeight="SemiBold"
               Margin="0,5,0,2"/>
                        <TextBlock Grid.Row="1" Grid.Column="1" x:Name="lblPhiThue"
               Text="- 10,000" HorizontalAlignment="Right"
               Margin="20,5,0,2" FontWeight="SemiBold"
               Foreground="Red"/>

                        <!-- Tổng tiền phạt -->
                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Tổng tiền phạt"
               HorizontalAlignment="Right" FontWeight="SemiBold"
               Margin="0,5,0,2"/>
                        <TextBlock Grid.Row="2" Grid.Column="1" x:Name="lblTongPhat"
               Text="- 5,000" HorizontalAlignment="Right"
               Margin="20,5,0,2" FontWeight="SemiBold"
               Foreground="Red"/>

                        <!-- Tổng tiền hoàn trả -->
                        <TextBlock Grid.Row="3" Grid.Column="0" Text="TỔNG TIỀN HOÀN TRẢ"
               HorizontalAlignment="Right" FontWeight="Bold"
               FontSize="16" Margin="0,10,0,2"/>
                        <TextBlock Grid.Row="3" Grid.Column="1" x:Name="lblTongHoanTra"
               Text="185,000" HorizontalAlignment="Right"
               Margin="20,10,0,2" FontWeight="Bold" FontSize="16"/>

                        <!-- Điểm tích lũy -->
                        <TextBlock Grid.Row="4" Grid.Column="0" Text="Điểm tích lũy"
               HorizontalAlignment="Right" FontWeight="SemiBold"
               Margin="0,10,0,0"/>
                        <TextBlock Grid.Row="4" Grid.Column="1" x:Name="lblDiemTichLuy"
               Text="+ 1" HorizontalAlignment="Right"
               Margin="20,10,0,0" FontWeight="Bold"
               Foreground="{StaticResource SuccessBrush}"/>
                    </Grid>


                    <TextBlock Text="Cảm ơn quý khách!" FontStyle="Italic" HorizontalAlignment="Center" Margin="0,30,0,0"/>
                </StackPanel>
            </Border>
        </ScrollViewer>

        <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Background="{StaticResource SubtleGrayBrush}" Width="{Binding Path=ActualWidth, ElementName=scrollViewer}">
            <Button x:Name="BtnPrint" Grid.Column="1" Style="{StaticResource SecondaryButton}" 
                    Content="In Phiếu" Width="100" Margin="5" Click="BtnPrint_Click"/>

            <Button x:Name="btnClose" Grid.Column="2" Style="{StaticResource SecondaryButton}" 
                    Background="{StaticResource TextGrayBrush}" Foreground="White" BorderThickness="0"
                    Content="Đóng" Width="100" Margin="5" Click="BtnClose_Click" IsCancel="True"/>
        </StackPanel>
    </Grid>
</Window>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\PhieuTraPreviewWindow.xaml.cs
================================================================================
﻿using System;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using CafebookModel.Model.ModelApp.NhanVien;

namespace AppCafebookApi.View.common
{
    public partial class PhieuTraPreviewWindow : Window
    {
        private static readonly HttpClient httpClient;
        private readonly int _idPhieuTra;

        static PhieuTraPreviewWindow()
        {
            httpClient = new HttpClient { BaseAddress = new Uri("http://127.0.0.1:5166") };
        }

        public PhieuTraPreviewWindow(int idPhieuTra)
        {
            InitializeComponent();
            _idPhieuTra = idPhieuTra;
        }

        private async void Window_Loaded(object sender, RoutedEventArgs e)
        {
            try
            {
                var data = await httpClient.GetFromJsonAsync<PhieuTraPrintDto>($"api/app/nhanvien/thuesach/print-data/tra/{_idPhieuTra}");
                if (data == null)
                {
                    MessageBox.Show("Không tìm thấy dữ liệu phiếu trả.");
                    this.Close();
                    return;
                }

                // Đổ dữ liệu vào UI
                lblTenQuan.Text = data.TenQuan;
                lblDiaChiQuan.Text = data.DiaChiQuan;
                lblSdtQuan.Text = $"SĐT: {data.SdtQuan}";
                lblMaPhieu.Text = $"Mã: {data.IdPhieuTra}";
                lblNgayTao.Text = $"Ngày: {data.NgayTra:dd/MM/yyyy HH:mm}";

                lblTenKhach.Text = data.TenKhachHang;
                lblSdtKhach.Text = $"SĐT: {data.SdtKhachHang}";
                lblTenNhanVien.Text = data.TenNhanVien;
                lblPhieuThueGoc.Text = data.IdPhieuThue;

                dgChiTiet.ItemsSource = data.ChiTiet;

                lblTongCoc.Text = $"{data.TongTienCoc:N0} đ";
                lblPhiThue.Text = $"- {data.TongPhiThue:N0} đ";
                lblTongPhat.Text = $"- {data.TongTienPhat:N0} đ";
                lblTongHoanTra.Text = $"{data.TongHoanTra:N0} đ";
                lblDiemTichLuy.Text = $"+ {data.DiemTichLuy}";
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi khi tải dữ liệu in: {ex.Message}", "Lỗi API");
                this.Close();
            }
        }

        private void BtnPrint_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                var printDialog = new PrintDialog();
                if (printDialog.ShowDialog() == true)
                {
                    (sender as Button)!.Visibility = Visibility.Collapsed;
                    (FindName("BtnClose") as Button)!.Visibility = Visibility.Collapsed;

                    printDialog.PrintVisual(printArea, "In Phiếu Trả Sách");

                    (sender as Button)!.Visibility = Visibility.Visible;
                    (FindName("BtnClose") as Button)!.Visibility = Visibility.Visible;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi khi in: {ex.Message}", "Lỗi");
            }
        }

        private void BtnClose_Click(object sender, RoutedEventArgs e)
        {
            this.Close();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\WelcomeWindow.xaml
================================================================================
﻿<Window x:Class="AppCafebookApi.View.Common.WelcomeWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AppCafebookApi.View.Common"
        Title="Chào mừng" Height="280" Width="540"
        WindowStartupLocation="CenterScreen"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent"
        ShowInTaskbar="False" Topmost="True" ResizeMode="NoResize"
        Loaded="Window_Loaded">

    <Window.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="DarkTextBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <Style TargetType="ProgressBar">
            <Setter Property="Background" Value="#E0D8C6"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Height" Value="6"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ProgressBar">
                        <Grid>
                            <Border x:Name="PART_Track" CornerRadius="3" Background="{TemplateBinding Background}"/>
                            <Border x:Name="PART_Indicator" CornerRadius="3" Background="{TemplateBinding Foreground}" HorizontalAlignment="Left"/>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid>
        <Border Background="#CC4E342E" CornerRadius="12"/>

        <Border x:Name="WelcomeCard" Width="460" Height="200" CornerRadius="12" 
                Background="{StaticResource LightCreamBrush}"
                HorizontalAlignment="Center" VerticalAlignment="Center"
                RenderTransformOrigin="0.5, 0.5">
            <Border.RenderTransform>
                <ScaleTransform ScaleX="0.9" ScaleY="0.9"/>
            </Border.RenderTransform>
            <Border.Effect>
                <DropShadowEffect Color="#000" BlurRadius="25" Opacity="0.2" ShadowDepth="5"/>
            </Border.Effect>
            <Border.Triggers>
                <EventTrigger RoutedEvent="Loaded">
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.4"/>
                            <DoubleAnimation Storyboard.TargetName="WelcomeCard" Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)" To="1" Duration="0:0:0.4">
                                <DoubleAnimation.EasingFunction>
                                    <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                                </DoubleAnimation.EasingFunction>
                            </DoubleAnimation>
                            <DoubleAnimation Storyboard.TargetName="WelcomeCard" Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)" To="1" Duration="0:0:0.4">
                                <DoubleAnimation.EasingFunction>
                                    <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                                </DoubleAnimation.EasingFunction>
                            </DoubleAnimation>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
            </Border.Triggers>

            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <Ellipse x:Name="imgAvatar" 
                         Width="90" Height="90" 
                         Margin="30,0,20,0"
                         VerticalAlignment="Center"
                         Stroke="{StaticResource PrimaryBrownBrush}"
                         StrokeThickness="1.5">
                    <Ellipse.Fill>
                        <SolidColorBrush Color="#EFEBE9"/>
                    </Ellipse.Fill>
                </Ellipse>

                <StackPanel Grid.Column="1" VerticalAlignment="Center" HorizontalAlignment="Left">
                    <TextBlock x:Name="txtWelcome" Text="CHÀO MỪNG" 
                               FontWeight="Bold" 
                               FontSize="28" 
                               Margin="0,0,0,15"/>

                    <StackPanel VerticalAlignment="Center">
                        <TextBlock x:Name="txtUserGreeting" 
                                   Text="Xin chào, [Tên]" 
                                   FontSize="18" 
                                   FontWeight="SemiBold" 
                                   Foreground="{StaticResource DarkTextBrush}"/>
                        <TextBlock x:Name="txtSub" 
                                   Text="Đang chuẩn bị không gian làm việc cho bạn..." 
                                   FontSize="13" 
                                   Foreground="{StaticResource DarkTextBrush}" Opacity="0.7"
                                   Margin="0,6,0,12"/>
                        <ProgressBar Width="280" IsIndeterminate="True" HorizontalAlignment="Left"/>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\WelcomeWindow.xaml.cs
================================================================================
﻿using AppCafebookApi.Services;
using CafebookModel.Model.Data;
using CafebookModel.Utils;
using System;
using System.Windows;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Threading;
using System.Windows.Controls;
using System.Linq;

namespace AppCafebookApi.View.Common
{
    public partial class WelcomeWindow : Window
    {
        private readonly NhanVienDto? _user;
        private DispatcherTimer? _timer;

        public WelcomeWindow()
        {
            InitializeComponent();
        }

        public WelcomeWindow(NhanVienDto user)
        {
            InitializeComponent();
            _user = user;
        }

        private void Window_Loaded(object sender, RoutedEventArgs e)
        {
            if (_user != null)
            {
                txtUserGreeting.Text = $"Xin chào, {_user.HoTen}";

                // 1. Tải ảnh bằng HinhAnhHelper
                BitmapImage avatar = HinhAnhHelper.LoadImage(
                    _user.AnhDaiDien ?? string.Empty,
                    HinhAnhPaths.DefaultAvatar
                );

                // 2. GÁN ẢNH VÀO UI (ĐÃ SỬA)
                // Gán trực tiếp vào Ellipse 'imgAvatar' đã thêm trong XAML
                if (avatar != null)
                {
                    imgAvatar.Fill = new ImageBrush(avatar)
                    {
                        Stretch = Stretch.UniformToFill
                    };
                }
            }

            // Cấu hình timer
            _timer = new DispatcherTimer
            {
                Interval = TimeSpan.FromMilliseconds(2500)
            };
            _timer.Tick += Timer_Tick;
            _timer.Start();
        }

        private void Timer_Tick(object? sender, EventArgs e)
        {
            _timer?.Stop();
            this.Close();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\ManHinhNhanVien.xaml
================================================================================
﻿<Window x:Class="AppCafebookApi.View.nhanvien.ManHinhNhanVien"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        xmlns:local="clr-namespace:AppCafebookApi.View.nhanvien"
        mc:Ignorable="d"
        Title="Cafebook - Copyright by © Lâm Chu Bảo Toàn | Contact:[lamchubaotoan@gmail.com]" Height="800" Width="1440"
        Icon="/Assets/logo.ico"        
        WindowStartupLocation="CenterScreen"
        FontFamily="Segoe UI"
        WindowState="Maximized">


    <Window.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="SubtleWhiteTextBrush" Color="#BCAAA4"/>
        <SolidColorBrush x:Key="HoverBrownBrush" Color="#8D6E63"/>
        <Geometry x:Key="IconNotification">M12,22C13.1,22 14,21.1 14,20H10C10,21.1 10.9,22 12,22M18,16V11C18,7.93 16.36,5.36 13.5,4.68V4C13.5,3.17 12.83,2.5 12,2.5C11.17,2.5 10.5,3.17 10.5,4V4.68C7.63,5.36 6,7.93 6,11V16L4,18V19H20V18L18,16Z</Geometry>

        <Geometry x:Key="IconDashboard">M13,3V9H21V3M13,21H21V11H13M3,21H11V15H3M3,13H11V3H3V13Z</Geometry>
        <Geometry x:Key="IconBooking">M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1M17,12H12V17H17V12Z</Geometry>
        <Geometry x:Key="IconProfile">M12,12A5,5 0 0,1 7,7A5,5 0 0,1 12,2A5,5 0 0,1 17,7A5,5 0 0,1 12,12M12,14C14.67,14 20,15.33 20,18V20H4V18C4,15.33 9.33,14 12,14Z</Geometry>
        <Geometry x:Key="IconClock">M12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z</Geometry>
        <Geometry x:Key="IconLogout">M16,17V14H9V12H16V9L20,13L16,17M14,2A2,2 0 0,1 16,4V6H14V4H5V20H14V18H16V20A2,2 0 0,1 14,22H5A2,2 0 0,1 3,20V4A2,2 0 0,1 5,2H14Z</Geometry>

        <Geometry x:Key="IconDelivery">M16,11H12.5V8H8V14H10V11H10.5L12.5,13L14.5,11H16M20,8H17V6H10V8H7L3,12V18H5V20H7V18H17V20H19V18H21V12L20,8Z</Geometry>
        <Geometry x:Key="IconBook">M18,2H6C4.9,2 4,2.9 4,4V20C4,21.1 4.9,22 6,22H18C19.1,22 20,21.1 20,20V4C20,2.9 19.1,2 18,2M11,4H13V12L11,10.8L9,12V4H11Z</Geometry>
        <Geometry x:Key="IconCalendarView">M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1M17,12H12V17H17V12Z</Geometry>
        <Geometry x:Key="IconPayroll">M20,6H4V4H20V6M20,10H4V8H20V10M18,14H6V12H18V14M18,18H6V16H18V18M19,20H5C3.89,20 3,19.1 3,18V3C3,1.89 3.89,1 5,1H19C20.1,1 21,1.89 21,3V18C21,19.1 20.1,20 19,20Z</Geometry>
        <Geometry x:Key="IconKitchen">M18.6,16.5H5.4V11.2H18.6M18.8,9.2H5.2C4.1,9.2 3.2,10.1 3.2,11.2V16.5C3.2,17.6 4.1,18.5 5.2,18.5H18.8C19.9,18.5 20.8,17.6 20.8,16.5V11.2C20.8,10.1 19.9,9.2 18.8,9.2M17,5.5H7C6.4,5.5 6,5.1 6,4.5V2.5H18V4.5C18,5.1 17.6,5.5 17,5.5Z</Geometry>
        
        <!-- Style cho các nút điều hướng chính, giống hệt ManHinhAdmin -->
        <Style x:Key="NavToggleButton" TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource SubtleWhiteTextBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Padding" Value="20,12"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="border" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" CornerRadius="5" Margin="8,2">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Border x:Name="indicator" Width="4" Height="20" Background="Transparent" CornerRadius="2" VerticalAlignment="Center" Margin="-20,0,10,0"/>
                                <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,15,0">
                                    <Path Data="{Binding Path=Tag, RelativeSource={RelativeSource TemplatedParent}}" Fill="{TemplateBinding Foreground}" Stretch="Uniform" VerticalAlignment="Center"/>
                                </Viewbox>
                                <ContentPresenter Grid.Column="1" HorizontalAlignment="Left" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource HoverBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                                <Setter TargetName="indicator" Property="Background" Value="{StaticResource AccentOrangeBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Style cho các nút ở footer, giống hệt ManHinhAdmin -->
        <Style x:Key="FooterButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource SubtleWhiteTextBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Padding" Value="20,12"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" CornerRadius="5" Margin="8,2">
                            <ContentPresenter/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource HoverBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>


    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="250"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Background="{StaticResource PrimaryBrownBrush}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <StackPanel Grid.Row="0" Margin="20">
                    <Border x:Name="AvatarBorder" Height="70" Width="70" Background="{StaticResource LightCreamBrush}" CornerRadius="35" Margin="0,0,0,10">
                    </Border>
                    <TextBlock x:Name="txtUserName" Text="Tên Nhân Viên" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource WhiteTextBrush}" HorizontalAlignment="Center" TextWrapping="Wrap" TextAlignment="Center"/>
                    <TextBlock x:Name="txtUserRole" Text="Nhân viên" FontSize="13" Foreground="{StaticResource SubtleWhiteTextBrush}" HorizontalAlignment="Center"/>
                    <TextBlock x:Name="lblSidebarStatus" 
                               Text="(Đang tải...)" 
                               FontSize="12" 
                               FontWeight="SemiBold"
                               Foreground="#FFD180" 
                               HorizontalAlignment="Center" 
                               Margin="0,5,0,0"/>
                </StackPanel>

                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <ToggleButton x:Name="btnSoDoBan" Content="Sơ đồ bàn" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconDashboard}" Click="BtnSoDoBan_Click" IsChecked="True"/>
                        <ToggleButton x:Name="btnDatBan" Content="Quản lý Đặt bàn" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconBooking}" Click="BtnDatBan_Click"/>
                        <ToggleButton x:Name="btnCheBien" Content="Màn hình Chế Biến" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconKitchen}" Click="BtnCheBien_Click"/>
                        <ToggleButton x:Name="btnThueSach" Content="Quản lý Thuê Sách" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconBook}" Click="BtnThueSach_Click"/>
                        <ToggleButton x:Name="btnGiaoHang" Content="Đơn Giao Hàng" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconDelivery}" Click="BtnGiaoHang_Click"/>

                        <Separator Margin="15,20" Background="{StaticResource HoverBrownBrush}"/>

                        <ToggleButton x:Name="btnThongTinCaNhan" Content="Thông tin cá nhân" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconProfile}" Click="BtnThongTinCaNhan_Click"/>
                        <ToggleButton x:Name="btnChamCong" Content="Chấm công" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconClock}" Click="BtnChamCong_Click"/>
                        <ToggleButton x:Name="btnLichLamViecCuaToi" Content="Xem Lịch Làm Việc" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconCalendarView}" Click="BtnLichLamViecCuaToi_Click"/>
                        <ToggleButton x:Name="btnPhieuLuongCuaToi" Content="Xem Phiếu Lương" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconPayroll}" Click="BtnPhieuLuongCuaToi_Click"/>
                    </StackPanel>
                </ScrollViewer>
                <StackPanel Grid.Row="2" VerticalAlignment="Bottom" Margin="0,0,0,5">
                    <Separator Margin="15" Background="{StaticResource HoverBrownBrush}"/>
                    <Button x:Name="btnThongBao" Style="{StaticResource FooterButton}" Click="BtnThongBao_Click" ToolTip="Xem thông báo mới">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,15,0">
                                <Path Data="{StaticResource IconNotification}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" />
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Thông báo" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            <Border Grid.Column="2" x:Name="BadgeThongBao" Background="Red" CornerRadius="10" Padding="5,1" MinWidth="20" Visibility="Collapsed" VerticalAlignment="Center">
                                <TextBlock x:Name="lblSoThongBao" Text="0" Foreground="White" FontSize="10" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                        </Grid>
                    </Button>
                    <Button x:Name="btnDangXuat" Style="{StaticResource FooterButton}" Click="BtnDangXuat_Click"
                            Background="{StaticResource AccentOrangeBrush}"
                            Foreground="{StaticResource WhiteTextBrush}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,15,0">
                                <Path Data="{StaticResource IconLogout}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Đăng xuất" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                </StackPanel>
                <StackPanel Grid.Row="2" VerticalAlignment="Bottom" Margin="0,0,0,5">
                </StackPanel>
            </Grid>
        </Border>

        <Border Grid.Column="1" Background="{StaticResource LightCreamBrush}">
            <Frame x:Name="MainFrame" NavigationUIVisibility="Hidden"/>
        </Border>
    </Grid>
</Window>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\ManHinhNhanVien.xaml.cs
================================================================================
﻿// Tệp: AppCafebookApi/View/nhanvien/ManHinhNhanVien.xaml.cs

using AppCafebookApi.Services;
using AppCafebookApi.View.nhanvien.pages;
using CafebookModel.Utils;
using System;
using System.Collections.Generic;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Controls.Primitives;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Threading;
using CafebookModel.Model.ModelApp.NhanVien;
using System.Net.Http.Json;
using System.Threading.Tasks;

namespace AppCafebookApi.View.nhanvien
{
    public partial class ManHinhNhanVien : Window
    {
        private DispatcherTimer _sidebarTimer;
        public static string CurrentTrangThai { get; set; } = "KhongCoCa";

        public ManHinhNhanVien()
        {
            InitializeComponent();
            this.Loaded += ManHinhNhanVien_Loaded;

            _sidebarTimer = new DispatcherTimer { Interval = TimeSpan.FromSeconds(30) };
            _sidebarTimer.Tick += SidebarTimer_Tick;
        }

        // Hàm Load màn hình chính của nhân viên (đã mở rộng: hỗ trợ vai trò "Cửa Hàng Trưởng" = full quyền)
        private async void ManHinhNhanVien_Loaded(object sender, RoutedEventArgs e)
        {
            var currentUser = AuthService.CurrentUser;
            if (currentUser == null) return;

            // 1. Cập nhật tên và vai trò
            txtUserName.Text = currentUser.HoTen ?? string.Empty;
            txtUserRole.Text = currentUser.TenVaiTro ?? string.Empty;

            // 2. Cập nhật Avatar
            try
            {
                AvatarBorder.Child = null;
                BitmapImage avatarImage = HinhAnhHelper.LoadImage(
                    currentUser.AnhDaiDien,
                    HinhAnhPaths.DefaultAvatar
                );
                AvatarBorder.Background = new ImageBrush(avatarImage)
                {
                    Stretch = Stretch.UniformToFill
                };
            }
            catch
            {
                // Nếu lỗi load ảnh, bỏ qua để tránh crash
            }

            // --- 3. PHÂN QUYỀN CHỨC NĂNG (Cập nhật) ---
            // Nếu là "Cửa Hàng Trưởng" => full quyền (hiển thị tất cả chức năng)
            bool isFullRole = string.Equals(currentUser.TenVaiTro?.Trim(),
                                            "Cửa Hàng Trưởng",
                                            StringComparison.OrdinalIgnoreCase);

            // Nút chung (luôn hiển thị)
            btnThongTinCaNhan.Visibility = Visibility.Visible;
            btnChamCong.Visibility = Visibility.Visible;
            btnLichLamViecCuaToi.Visibility = Visibility.Visible;
            btnPhieuLuongCuaToi.Visibility = Visibility.Visible;

            // Danh sách các nút điều hướng có trong sidebar (để dễ quản lý)
            var navButtons = new List<ToggleButton>
            {
                btnSoDoBan, btnCheBien, btnDatBan, btnGiaoHang, btnThueSach,
                btnThongTinCaNhan, btnChamCong, btnLichLamViecCuaToi, btnPhieuLuongCuaToi
            };

            // Nếu full role thì bật tất cả
            if (isFullRole)
            {
                foreach (var btn in navButtons)
                {
                    if (btn != null)
                        btn.Visibility = Visibility.Visible;
                }
            }
            else
            {
                // Giữ lại logic phân quyền hiện có cho các vai trò khác

                // Các chức năng đặc thù (Phục vụ/Thu ngân)
                bool coQuyenOrder = AuthService.CoQuyen("BanHang.XemSoDo", "BanHang.ThanhToan");
                if (btnSoDoBan != null) btnSoDoBan.Visibility = coQuyenOrder ? Visibility.Visible : Visibility.Collapsed;
                if (btnDatBan != null) btnDatBan.Visibility = coQuyenOrder ? Visibility.Visible : Visibility.Collapsed;

                // Giao hàng (ví dụ: Thu ngân/Quản lý)
                bool coQuyenGiaoHang = AuthService.CoQuyen("BanHang.ThanhToan", "GiaoHang.Xem");
                if (btnGiaoHang != null) btnGiaoHang.Visibility = coQuyenGiaoHang ? Visibility.Visible : Visibility.Collapsed;

                // Thuê sách (Thu ngân/Quản lý)
                bool coQuyenSach = AuthService.CoQuyen("Sach.QuanLy");
                if (btnThueSach != null) btnThueSach.Visibility = coQuyenSach ? Visibility.Visible : Visibility.Collapsed;

                // Chế biến (ví dụ quyền: "CheBien.Xem")
                bool coQuyenCheBien = AuthService.CoQuyen("CheBien.Xem");
                if (btnCheBien != null) btnCheBien.Visibility = coQuyenCheBien ? Visibility.Visible : Visibility.Collapsed;

                // Các nút chung đã set visible phía trên; nếu cần ẩn khi không có quyền thì thêm logic ở đây
            }

            // --- Chọn trang mặc định ---
            // Nếu có quyền xem sơ đồ bàn => ưu tiên mở SoDoBan
            if (btnSoDoBan != null && btnSoDoBan.Visibility == Visibility.Visible)
            {
                btnSoDoBan.IsChecked = true;
                NavigateToPage(btnSoDoBan, new SoDoBanView());
            }
            else
            {
                if (btnThongTinCaNhan != null)
                {
                    btnThongTinCaNhan.IsChecked = true;
                    NavigateToPage(btnThongTinCaNhan, new ThongTinCaNhanView());
                }
            }

            // Khởi động cập nhật sidebar status
            await UpdateSidebarStatusSafeAsync();
            _sidebarTimer.Start();
        }

        private void UncheckOtherButtons(ToggleButton? exception)
        {
            var navButtons = new List<ToggleButton>
            {
                btnSoDoBan, btnCheBien, btnDatBan, btnGiaoHang, btnThueSach,
                btnThongTinCaNhan, btnChamCong, btnLichLamViecCuaToi, btnPhieuLuongCuaToi
            };

            foreach (var button in navButtons)
            {
                if (button != null && button != exception)
                {
                    button.IsChecked = false;
                }
            }
        }

        private void NavigateToPage(ToggleButton? clickedButton, Page pageInstance)
        {
            if (clickedButton == null) return;
            UncheckOtherButtons(clickedButton);
            clickedButton.IsChecked = true;
            MainFrame.Navigate(pageInstance);
        }

        // --- CÁC HÀM CLICK ĐIỀU HƯỚNG ---

        private void BtnSoDoBan_Click(object sender, RoutedEventArgs e)
        {
            NavigateToPage(sender as ToggleButton, new SoDoBanView());
        }

        private void BtnDatBan_Click(object sender, RoutedEventArgs e)
        {
            NavigateToPage(sender as ToggleButton, new DatBanView());
        }

        private void BtnGiaoHang_Click(object sender, RoutedEventArgs e)
        {
            NavigateToPage(sender as ToggleButton, new GiaoHangView());
        }

        private void BtnCheBien_Click(object sender, RoutedEventArgs e)
        {
            NavigateToPage(sender as ToggleButton, new CheBienView());
        }

        private void BtnThueSach_Click(object sender, RoutedEventArgs e)
        {
            NavigateToPage(sender as ToggleButton, new ThueSachView());
        }

        private void BtnThongTinCaNhan_Click(object sender, RoutedEventArgs e)
        {
            NavigateToPage(sender as ToggleButton, new ThongTinCaNhanView());
        }

        private void BtnChamCong_Click(object sender, RoutedEventArgs e)
        {
            NavigateToPage(sender as ToggleButton, new ChamCongView());
        }

        private void BtnLichLamViecCuaToi_Click(object sender, RoutedEventArgs e)
        {
            NavigateToPage(sender as ToggleButton, new LichLamViecView());
        }

        private void BtnPhieuLuongCuaToi_Click(object sender, RoutedEventArgs e)
        {
            NavigateToPage(sender as ToggleButton, new PhieuLuongView());
        }

        // --- HÀM HELPER VÀ ĐĂNG XUẤT ---

        private void ResetToDefaultPage(object sender)
        {
            if (sender is ToggleButton btn)
            {
                btn.IsChecked = false;
                if (btnSoDoBan != null)
                    btnSoDoBan.IsChecked = true;
            }
        }

        private void BtnThongBao_Click(object sender, RoutedEventArgs e)
        {
            MessageBox.Show("Chức năng Thông báo đang được phát triển.");
        }

        private async void SidebarTimer_Tick(object? sender, EventArgs e)
        {
            await UpdateSidebarStatusSafeAsync();
        }

        private async Task UpdateSidebarStatusSafeAsync()
        {
            try
            {
                await UpdateSidebarStatusAsync();
            }
            catch
            {
                // Không cho phép lỗi crash UI nếu sync status thất bại
                if (lblSidebarStatus != null)
                {
                    lblSidebarStatus.Text = "Lỗi đồng bộ";
                    lblSidebarStatus.Foreground = Brushes.OrangeRed;
                }
            }
        }

        private async Task UpdateSidebarStatusAsync()
        {
            if (AuthService.CurrentUser == null || lblSidebarStatus == null) return;
            try
            {
                var status = await ApiClient.Instance.GetFromJsonAsync<ChamCongDashboardDto>("api/app/chamcong/status");
                if (status != null)
                {
                    CurrentTrangThai = status.TrangThai;

                    switch (status.TrangThai)
                    {
                        case "DaChamCong":
                            var duration = DateTime.Now - status.GioVao.Value;
                            lblSidebarStatus.Text = $"Đang làm ({duration:hh\\:mm})";
                            lblSidebarStatus.Foreground = Brushes.LightGreen;
                            break;
                        case "ChuaChamCong":
                            lblSidebarStatus.Text = "Chưa chấm công";
                            lblSidebarStatus.Foreground = Brushes.LightGray;
                            break;
                        case "NghiPhep":
                            lblSidebarStatus.Text = "Đang nghỉ phép";
                            lblSidebarStatus.Foreground = Brushes.LightBlue;
                            break;
                        case "KhongCoCa":
                            lblSidebarStatus.Text = "Không có ca";
                            lblSidebarStatus.Foreground = Brushes.Gray;
                            break;
                        default: // DaTraCa
                            lblSidebarStatus.Text = "Đã trả ca";
                            lblSidebarStatus.Foreground = Brushes.Gray;
                            break;
                    }
                }
            }
            catch (Exception)
            {
                lblSidebarStatus.Text = "Lỗi đồng bộ";
                lblSidebarStatus.Foreground = Brushes.OrangeRed;
            }
        }

        public static string GetCurrentCheckInStatus()
        {
            return CurrentTrangThai;
        }

        private void BtnDangXuat_Click(object sender, RoutedEventArgs e)
        {
            if (GetCurrentCheckInStatus() == "DaChamCong")
            {
                MessageBox.Show("Bạn chưa trả ca. Vui lòng nhấn \"TRẢ CA\" trước khi đăng xuất.",
                                "Cảnh báo chưa trả ca",
                                MessageBoxButton.OK,
                                MessageBoxImage.Warning);
                return;
            }

            var result = MessageBox.Show("Bạn có chắc chắn muốn đăng xuất?",
                                         "Xác nhận đăng xuất",
                                         MessageBoxButton.YesNo,
                                         MessageBoxImage.Question);

            if (result == MessageBoxResult.Yes)
            {
                AuthService.Logout();
                ManHinhDangNhap loginWindow = new ManHinhDangNhap();
                loginWindow.Show();
                this.Close();
            }
        }
    }
}

================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\ChamCongView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.nhanvien.pages.ChamCongView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:sys="clr-namespace:System;assembly=mscorlib"
      mc:Ignorable="d" 
      FontFamily="Segoe UI"
      d:DesignHeight="720" d:DesignWidth="1150"
      Title="ChamCongView" Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="ButtonGreen" Color="#28a745"/>
        <SolidColorBrush x:Key="ButtonRed" Color="#dc3545"/>
        <SolidColorBrush x:Key="ButtonGray" Color="#6c757d"/>

        <SolidColorBrush x:Key="ButtonOrange" Color="#fd7e14"/>
        <SolidColorBrush x:Key="ButtonBlue" Color="#007bff"/>
        <SolidColorBrush x:Key="TextLight" Color="#6c757d"/>
        <SolidColorBrush x:Key="TextDark" Color="#343a40"/>
        <SolidColorBrush x:Key="PrimaryBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="LightBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="GreenBrush" Color="#388E3C"/>
        <SolidColorBrush x:Key="BlueBrush" Color="#1976D2"/>
        <SolidColorBrush x:Key="RedBrush" Color="#D32F2F"/>


        <Geometry x:Key="IconUser">M12,12A5,5 0 0,1 7,7A5,5 0 0,1 12,2A5,5 0 0,1 17,7A5,5 0 0,1 12,12M12,14C14.67,14 20,15.33 20,18V20H4V18C4,15.33 9.33,14 12,14Z</Geometry>
        <Geometry x:Key="IconLate">M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M16.2,16.2L11,13V7H12.5V12.2L17,14.9L16.2,16.2Z</Geometry>
        <Geometry x:Key="IconLeave">M17,7V11H15V7H9V11H7V7H5V17H7V13H9V17H15V13H17V17H19V7H17Z</Geometry>

        <Style x:Key="ChamCongButton" TargetType="Button">
        </Style>
    </Page.Resources>

    <Grid Background="{StaticResource LightBrush}">

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="350"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>


        <Border Grid.Column="0" Background="White" BorderBrush="#EEE" BorderThickness="0,0,1,0">
            <StackPanel Margin="20">
                <TextBlock x:Name="lblThoiGianThucTe"
                           Text="00:00:00"
                           FontSize="42"
                           FontWeight="Bold"
                           Foreground="{StaticResource TextDark}"
                           HorizontalAlignment="Center"
                           Margin="0,10,0,5"/>
                <TextBlock Text="{Binding Source={x:Static sys:DateTime.Now}, StringFormat='dd/MM/yyyy'}"
                           FontSize="15"
                           Foreground="{StaticResource TextLight}"
                           HorizontalAlignment="Center"
                           Margin="0,0,0,20"/>

                <Border Background="{StaticResource LightBrush}" CornerRadius="8" Padding="15">
                    <StackPanel>
                        <TextBlock x:Name="lblTrangThaiChinh" 
                                   Text="Đang tải..." 
                                   Foreground="{StaticResource TextDark}" 
                                   FontSize="16"
                                   FontWeight="SemiBold"
                                   TextWrapping="Wrap"
                                   TextAlignment="Center"
                                   MinHeight="30"
                                   Margin="0,0,0,10"/>

                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,0,0,15" MinHeight="20">
                            <Border x:Name="borderDonNghi" Background="#FFF8E1" CornerRadius="10" Padding="8,3" Margin="0,0,5,0" Visibility="Collapsed">
                                <StackPanel Orientation="Horizontal">
                                    <Path Data="{StaticResource IconLeave}" Fill="#FFA000" Width="23" Height="23" Margin="0,0,5,0" VerticalAlignment="Center"/>
                                    <TextBlock x:Name="lblTrangThaiDonNghi" Text="Chờ duyệt nghỉ" FontSize="11" FontWeight="SemiBold" Foreground="#FFA000" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Border>
                            <Border x:Name="borderDiTre" Background="#FBE9E7" CornerRadius="10" Padding="8,3" Visibility="Collapsed">
                                <StackPanel Orientation="Horizontal">
                                    <Path Data="{StaticResource IconLate}" Fill="#D32F2F" Width="23" Height="23" Margin="0,0,5,0" VerticalAlignment="Center"/>
                                    <TextBlock x:Name="lblDiTre" Text="Trễ: 0 lần" FontSize="11" FontWeight="SemiBold" Foreground="#D32F2F" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <Button x:Name="btnChamCong" 
                                Content="CHẤM CÔNG" 
                                Style="{StaticResource ChamCongButton}"
                                Background="{StaticResource ButtonGreen}"
                                Click="BtnChamCong_Click"
                                Visibility="Collapsed"
                                Padding="15,10"
                                FontSize="16"/>
                    </StackPanel>
                </Border>
            </StackPanel>
        </Border>

        <Grid Grid.Column="1" Margin="20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>


            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,20">
                <TextBlock Text="Tổng quan" FontSize="24" FontWeight="SemiBold" Foreground="{StaticResource PrimaryBrush}" VerticalAlignment="Center"/>
                <DatePicker x:Name="dpChonThang" VerticalAlignment="Center" Margin="30,0,0,0" Width="150"
                            SelectedDateChanged="DpChonThang_SelectedDateChanged"/>
            </StackPanel>

            <Border Grid.Row="1" Background="White" BorderBrush="#EEE" BorderThickness="1" CornerRadius="8" Margin="0,0,0,20" Padding="20">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                        <TextBlock Text="TỔNG GIỜ LÀM" FontSize="12" FontWeight="SemiBold" Foreground="{StaticResource TextLight}"/>
                        <TextBlock x:Name="lblTongGioLam" Text="0.00" FontSize="28" FontWeight="Bold" Foreground="{StaticResource BlueBrush}"/>
                    </StackPanel>
                    <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                        <TextBlock Text="SỐ LẦN ĐI TRỄ" FontSize="12" FontWeight="SemiBold" Foreground="{StaticResource TextLight}"/>
                        <TextBlock x:Name="lblSoLanDiTre" Text="0" FontSize="28" FontWeight="Bold" Foreground="{StaticResource RedBrush}"/>
                    </StackPanel>
                    <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                        <TextBlock Text="SỐ NGÀY NGHỈ PHÉP" FontSize="12" FontWeight="SemiBold" Foreground="{StaticResource TextLight}"/>
                        <TextBlock x:Name="lblSoNgayNghiPhep" Text="0" FontSize="28" FontWeight="Bold" Foreground="{StaticResource TextDark}"/>
                    </StackPanel>
                </Grid>
            </Border>


            <TabControl Grid.Row="2" Background="Transparent" BorderThickness="0">
                <TabItem Header="Lịch sử Chấm công" FontWeight="SemiBold">
                    <DataGrid x:Name="dgLichSuChamCong"
                              AutoGenerateColumns="False" IsReadOnly="True" CanUserAddRows="False">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Ngày" Binding="{Binding Ngay}" Width="110"/>
                            <DataGridTextColumn Header="Ca Làm Việc" Binding="{Binding CaLamViec}" Width="*"/>
                            <DataGridTextColumn Header="Giờ Vào" Binding="{Binding GioVao}" Width="80"/>
                            <DataGridTextColumn Header="Giờ Ra" Binding="{Binding GioRa}" Width="80"/>
                            <DataGridTextColumn Header="Đi Trễ" Binding="{Binding DiTre}" Width="100"/>
                            <DataGridTextColumn Header="Giờ Công" Binding="{Binding SoGioLam, StringFormat=N2}" Width="80"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </TabItem>
                <TabItem Header="Danh sách Đơn xin nghỉ" FontWeight="SemiBold">
                    <DataGrid x:Name="dgDonXinNghi"
                              AutoGenerateColumns="False" IsReadOnly="True" CanUserAddRows="False">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Thời gian nghỉ" Binding="{Binding ThoiGian}" Width="110"/>
                            <DataGridTextColumn Header="Lý do" Binding="{Binding LyDo}" Width="*"/>
                            <DataGridTextColumn Header="Trạng thái" Binding="{Binding TrangThai}" Width="100"/>
                            <DataGridTextColumn Header="Phê duyệt" Binding="{Binding PheDuyet}" Width="*"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </TabItem>

                <TabItem x:Name="tabVietDon" Header="Viết Đơn Xin Nghỉ" FontWeight="SemiBold">
                    <Border Background="White" CornerRadius="8" Padding="25" Margin="0,10,0,0"
                            BorderBrush="#EEE" BorderThickness="1">
                        <StackPanel MaxWidth="600" HorizontalAlignment="Left">
                            <TextBlock Text="Viết đơn xin nghỉ" FontSize="18" FontWeight="SemiBold" Margin="0,0,0,20"/>

                            <Grid Margin="0,0,0,15">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0" Margin="0,0,5,0">
                                    <TextBlock Text="Từ ngày:" FontWeight="SemiBold"/>
                                    <DatePicker x:Name="dpNgayBatDau" Margin="0,5,0,0"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1" Margin="5,0,0,0">
                                    <TextBlock Text="Đến ngày:" FontWeight="SemiBold"/>
                                    <DatePicker x:Name="dpNgayKetThuc" Margin="0,5,0,0"/>
                                </StackPanel>
                            </Grid>

                            <TextBlock Text="Loại đơn:" FontWeight="SemiBold"/>
                            <ComboBox x:Name="cmbLoaiDon" Margin="0,5,0,15">
                                <ComboBoxItem Content="Nghỉ phép (Có lương)"/>
                                <ComboBoxItem Content="Nghỉ bệnh"/>
                                <ComboBoxItem Content="Nghỉ không phép"/>
                                <ComboBoxItem Content="Nghỉ việc riêng"/>
                            </ComboBox>

                            <TextBlock Text="Lý do:" FontWeight="SemiBold"/>
                            <TextBox x:Name="txtLyDo" Margin="0,5,0,20" Height="100" TextWrapping="Wrap" AcceptsReturn="True" 
                                     VerticalScrollBarVisibility="Auto" Padding="5"
                                     BorderBrush="#CCC" BorderThickness="1"/>

                            <StackPanel Orientation="Horizontal">
                                <Button x:Name="btnGuiDon" Content="Gửi đơn" Background="{StaticResource GreenBrush}" Foreground="White"
                                        Padding="15,8" FontWeight="Bold" Click="BtnGuiDon_Click"/>
                                <Button x:Name="btnHuyGuiDon" Content="Hủy" Margin="10,0,0,0" 
                                        Padding="15,8" Click="BtnHuyGuiDon_Click"
                                        Background="White" Foreground="#333" BorderBrush="#CCC" BorderThickness="1"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </TabItem>
            </TabControl>
        </Grid>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\ChamCongView.xaml.cs
================================================================================
﻿// Tệp: AppCafebookApi/View/nhanvien/pages/ChamCongView.xaml.cs
using AppCafebookApi.Services;
using CafebookModel.Model.ModelApp.NhanVien;
using System;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media;
using System.Windows.Threading;
using AppCafebookApi.View.common;
using System.Net.Http;

namespace AppCafebookApi.View.nhanvien.pages
{
    public partial class ChamCongView : Page
    {
        private DispatcherTimer _timerClock;
        private DispatcherTimer _timerWork;
        private DateTime? _gioVaoCache;

        private readonly Brush _mauXanh = new SolidColorBrush((Color)ColorConverter.ConvertFromString("#28a745"));
        private readonly Brush _mauDo = new SolidColorBrush((Color)ColorConverter.ConvertFromString("#dc3545"));
        private readonly Brush _mauXam = new SolidColorBrush((Color)ColorConverter.ConvertFromString("#6c757d"));
        private readonly Brush _mauCam = new SolidColorBrush((Color)ColorConverter.ConvertFromString("#fd7e14"));
        private readonly Brush _mauLam = new SolidColorBrush((Color)ColorConverter.ConvertFromString("#007bff"));

        public ChamCongView()
        {
            InitializeComponent();

            _timerClock = new DispatcherTimer { Interval = TimeSpan.FromSeconds(1) };
            _timerClock.Tick += TimerClock_Tick;
            _timerClock.Start();

            _timerWork = new DispatcherTimer { Interval = TimeSpan.FromSeconds(1) };
            _timerWork.Tick += TimerWork_Tick;
        }

        private void TimerClock_Tick(object? sender, EventArgs e)
        {
            lblThoiGianThucTe.Text = DateTime.Now.ToString("HH:mm:ss");
        }

        private void TimerWork_Tick(object? sender, EventArgs e)
        {
            if (_gioVaoCache.HasValue)
            {
                var duration = DateTime.Now - _gioVaoCache.Value;
                lblTrangThaiChinh.Text = $"Đang làm: {duration:hh\\:mm\\:ss}";
            }
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            if (System.ComponentModel.DesignerProperties.GetIsInDesignMode(this))
                return;

            if (AuthService.CurrentUser == null)
            {
                lblTrangThaiChinh.Text = "Vui lòng đăng nhập";
                btnChamCong.Visibility = Visibility.Collapsed;
                return;
            }

            await LoadStatusAsync();

            dpChonThang.SelectedDate = DateTime.Now;
            await LoadLichSuAsync(DateTime.Now.Month, DateTime.Now.Year);

            dpNgayBatDau.SelectedDate = DateTime.Today;
            dpNgayKetThuc.SelectedDate = DateTime.Today;
            cmbLoaiDon.SelectedIndex = 0;
        }

        private async Task LoadStatusAsync()
        {
            try
            {
                btnChamCong.IsEnabled = false;

                var response = await ApiClient.Instance.GetAsync("api/app/chamcong/status");

                if (response.IsSuccessStatusCode)
                {
                    var status = await response.Content.ReadFromJsonAsync<ChamCongDashboardDto>();
                    if (status != null)
                    {
                        UpdateUI(status);
                    }
                }
                else
                {
                    lblTrangThaiChinh.Text = "Lỗi tải trạng thái.";
                }
            }
            catch (Exception ex)
            {
                // Hiển thị lỗi chi tiết hơn (nếu có)
                lblTrangThaiChinh.Text = $"Lỗi kết nối API: {ex.Message}";
            }
        }

        private void UpdateUI(ChamCongDashboardDto status)
        {
            ManHinhNhanVien.CurrentTrangThai = status.TrangThai;

            btnChamCong.Visibility = Visibility.Visible;
            btnChamCong.IsEnabled = true;
            _timerWork.Stop();
            _gioVaoCache = null;

            UpdateUI_Phu(status); // Gọi hàm đã sửa lỗi

            switch (status.TrangThai)
            {
                case "NghiPhep":
                    lblTrangThaiChinh.Text = status.TenCa; // "Nghỉ phép"
                    btnChamCong.Content = "ĐANG NGHỈ PHÉP";
                    btnChamCong.Background = _mauLam;
                    btnChamCong.IsEnabled = false;
                    btnChamCong.Tag = null;
                    break;
                case "KhongCoCa":
                    lblTrangThaiChinh.Text = status.TenCa; // "Không có lịch làm"
                    btnChamCong.Visibility = Visibility.Collapsed;
                    break;
                case "ChuaChamCong":
                    lblTrangThaiChinh.Text = $"{status.TenCa} ({status.GioBatDauCa:hh\\:mm} - {status.GioKetThucCa:hh\\:mm})";
                    btnChamCong.Content = "CHẤM CÔNG";
                    btnChamCong.Background = _mauXanh;
                    btnChamCong.Tag = "clock-in";
                    break;
                case "DaChamCong":
                    _gioVaoCache = status.GioVao;
                    _timerWork.Start();
                    TimerWork_Tick(null, EventArgs.Empty);
                    btnChamCong.Content = "TRẢ CA";
                    btnChamCong.Background = _mauDo;
                    btnChamCong.Tag = "clock-out";
                    break;
                case "DaTraCa":
                    lblTrangThaiChinh.Text = $"Đã trả ca lúc {status.GioRa:HH:mm} (Làm: {status.SoGioLam:N2} giờ)";
                    btnChamCong.Content = "ĐÃ TRẢ CA";
                    btnChamCong.Background = _mauXam;
                    btnChamCong.IsEnabled = false;
                    btnChamCong.Tag = null;
                    break;
            }
        }

        // *** HÀM ĐÃ SỬA LỖI ***
        private void UpdateUI_Phu(ChamCongDashboardDto status)
        {
            if (!string.IsNullOrEmpty(status.TrangThaiDonNghi))
            {
                lblTrangThaiDonNghi.Text = status.TrangThaiDonNghi;
                if (status.TrangThaiDonNghi == "Đã duyệt")
                {
                    // SỬA: Tham chiếu trực tiếp đến borderDonNghi
                    borderDonNghi.Background = new SolidColorBrush((Color)ColorConverter.ConvertFromString("#E8F5E9"));
                    lblTrangThaiDonNghi.Foreground = new SolidColorBrush((Color)ColorConverter.ConvertFromString("#2E7D32"));
                }
                else
                {
                    // SỬA: Tham chiếu trực tiếp đến borderDonNghi
                    borderDonNghi.Background = new SolidColorBrush((Color)ColorConverter.ConvertFromString("#FFF8E1"));
                    lblTrangThaiDonNghi.Foreground = new SolidColorBrush((Color)ColorConverter.ConvertFromString("#FFA000"));
                }
                borderDonNghi.Visibility = Visibility.Visible;
            }
            else
            {
                borderDonNghi.Visibility = Visibility.Collapsed;
            }

            if (status.SoLanDiTreThangNay > 0)
            {
                lblDiTre.Text = $"Trễ: {status.SoLanDiTreThangNay} lần";
                borderDiTre.Visibility = Visibility.Visible;
            }
            else
            {
                borderDiTre.Visibility = Visibility.Collapsed;
            }
        }
        // *** KẾT THÚC SỬA LỖI ***

        private async void BtnChamCong_Click(object sender, RoutedEventArgs e)
        {
            string? action = btnChamCong.Tag as string;
            if (string.IsNullOrEmpty(action)) return;

            btnChamCong.IsEnabled = false;
            string apiUrl = (action == "clock-in") ? "api/app/chamcong/clock-in" : "api/app/chamcong/clock-out";

            try
            {
                var response = await ApiClient.Instance.PostAsync(apiUrl, null);
                if (response.IsSuccessStatusCode)
                {
                    var newStatus = await response.Content.ReadFromJsonAsync<ChamCongDashboardDto>();
                    if (newStatus != null)
                    {
                        UpdateUI(newStatus);
                    }
                }
                else
                {
                    string errorMessage = await response.Content.ReadAsStringAsync();
                    MessageBox.Show(errorMessage, "Lỗi Chấm Công", MessageBoxButton.OK, MessageBoxImage.Warning);
                    btnChamCong.IsEnabled = true;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối API: {ex.Message}", "Lỗi nghiêm trọng", MessageBoxButton.OK, MessageBoxImage.Error);
                btnChamCong.IsEnabled = true;
            }
        }

        private async Task LoadLichSuAsync(int thang, int nam)
        {
            try
            {
                var response = await ApiClient.Instance.GetFromJsonAsync<LichSuChamCongPageDto>($"api/app/chamcong/lich-su?thang={thang}&nam={nam}");
                if (response != null)
                {
                    dgLichSuChamCong.ItemsSource = response.LichSuChamCong;
                    dgDonXinNghi.ItemsSource = response.DanhSachDonNghi;

                    lblTongGioLam.Text = response.ThongKe.TongGioLam.ToString("N2");
                    lblSoLanDiTre.Text = response.ThongKe.SoLanDiTre.ToString();
                    lblSoNgayNghiPhep.Text = response.ThongKe.SoNgayNghiPhep.ToString();
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải lịch sử chấm công: {ex.Message}", "Lỗi API", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private async void DpChonThang_SelectedDateChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dpChonThang.SelectedDate.HasValue && !IsLoaded)
                return;

            var date = dpChonThang.SelectedDate ?? DateTime.Now;
            await LoadLichSuAsync(date.Month, date.Year);
        }

        private async void BtnGuiDon_Click(object sender, RoutedEventArgs e)
        {
            if (dpNgayBatDau.SelectedDate == null || dpNgayKetThuc.SelectedDate == null)
            {
                MessageBox.Show("Vui lòng chọn ngày bắt đầu và ngày kết thúc.", "Thiếu thông tin");
                return;
            }
            if (string.IsNullOrWhiteSpace(txtLyDo.Text))
            {
                MessageBox.Show("Vui lòng nhập lý do xin nghỉ.", "Thiếu thông tin");
                return;
            }
            if (dpNgayKetThuc.SelectedDate < dpNgayBatDau.SelectedDate)
            {
                MessageBox.Show("Ngày kết thúc không thể trước ngày bắt đầu.", "Lỗi logic");
                return;
            }

            var request = new DonXinNghiRequestDto
            {
                LoaiDon = (cmbLoaiDon.SelectedItem as ComboBoxItem)?.Content.ToString() ?? "Đơn xin nghỉ",
                LyDo = txtLyDo.Text,
                NgayBatDau = dpNgayBatDau.SelectedDate.Value,
                NgayKetThuc = dpNgayKetThuc.SelectedDate.Value
            };

            btnGuiDon.IsEnabled = false;
            try
            {
                var response = await ApiClient.Instance.PostAsJsonAsync("api/app/chamcong/submit-leave", request);

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Gửi đơn xin nghỉ thành công!", "Thành công");
                    BtnHuyGuiDon_Click(null, null); // Xóa form

                    var date = dpChonThang.SelectedDate ?? DateTime.Now;
                    await LoadLichSuAsync(date.Month, date.Year);
                }
                else
                {
                    string error = await response.Content.ReadAsStringAsync();
                    MessageBox.Show($"Lỗi gửi đơn: {error}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi nghiêm trọng");
            }
            btnGuiDon.IsEnabled = true;
        }

        private void BtnHuyGuiDon_Click(object? sender, RoutedEventArgs? e)
        {
            txtLyDo.Text = "";
            dpNgayBatDau.SelectedDate = DateTime.Today;
            dpNgayKetThuc.SelectedDate = DateTime.Today;
            cmbLoaiDon.SelectedIndex = 0;
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\CheBienView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.nhanvien.pages.CheBienView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:converters="clr-namespace:AppCafebookApi.Converters"
      mc:Ignorable="d" 
      d:DesignHeight="750" d:DesignWidth="1200"
      Title="CheBienView"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded" Unloaded="Page_Unloaded">

    <!-- 🌿 RESOURCE -->
    <Page.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>

        <!-- Theme màu -->
        <SolidColorBrush x:Key="CafeBrown" Color="#6F4E37"/>
        <SolidColorBrush x:Key="CafeOrange" Color="#D27D2D"/>
        <SolidColorBrush x:Key="CafeCream" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="TextGray" Color="#757575"/>

        <!-- Thẻ món ăn -->
        <Style x:Key="KitchenCard" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="10"/>
            <Setter Property="Margin" Value="10"/>
            <Setter Property="Padding" Value="10"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="2" BlurRadius="10" Opacity="0.25"/>
                </Setter.Value>
            </Setter>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="RenderTransformOrigin" Value="0.5,0.5"/>
            <Setter Property="RenderTransform">
                <Setter.Value>
                    <ScaleTransform ScaleX="1" ScaleY="1"/>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Effect">
                        <Setter.Value>
                            <DropShadowEffect ShadowDepth="4" BlurRadius="15" Color="#6F4E37" Opacity="0.4"/>
                        </Setter.Value>
                    </Setter>
                    <Setter Property="RenderTransform">
                        <Setter.Value>
                            <ScaleTransform ScaleX="1.03" ScaleY="1.03"/>
                        </Setter.Value>
                    </Setter>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Nút hành động -->
        <Style x:Key="ActionButton" TargetType="Button">
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="10,8"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="20"
                                Background="{TemplateBinding Background}"
                                SnapsToDevicePixels="True">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.7"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <!-- 🌿 MAIN LAYOUT -->
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Tiêu đề -->
        <Border Grid.Row="0" Background="White" Padding="15" BorderBrush="#E0E0E0" BorderThickness="0,0,0,1">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="👨‍🍳 Màn Hình Chế Biến" FontSize="22" FontWeight="Bold" Foreground="{StaticResource CafeBrown}"/>
                <TextBlock x:Name="lblLastUpdated" Text="(Đang tải...)" VerticalAlignment="Center" Margin="15,0,0,0" Foreground="{StaticResource TextGray}" FontStyle="Italic"/>
            </StackPanel>
        </Border>

        <!-- Tabs chính -->
        <TabControl x:Name="MainTabs" Grid.Row="1" Margin="10" Background="Transparent" BorderThickness="0" SelectedIndex="1">
            <!-- 🍳 Bếp -->
            <TabItem Header="🍳 Bếp (Món Ăn)">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <ItemsControl x:Name="icBep">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Style="{StaticResource KitchenCard}" Width="280"
                                        MouseLeftButtonDown="Border_CongThuc_Click"
                                        ToolTip="Click để xem công thức">
                                    <StackPanel Margin="10">
                                        <TextBlock Text="{Binding SoBan}" FontSize="20" FontWeight="Bold" Foreground="{StaticResource CafeOrange}"/>
                                        <TextBlock Margin="0,5,0,0">
                                            <Run Text="{Binding TenMon}" FontSize="18" FontWeight="SemiBold"/>
                                            <Run Text=" (x" FontSize="18" FontWeight="Bold"/>
                                            <Run Text="{Binding SoLuong}" FontSize="18" FontWeight="Bold"/>
                                            <Run Text=")" FontSize="18" FontWeight="Bold"/>
                                        </TextBlock>
                                        <TextBlock Text="{Binding GhiChu}" FontStyle="Italic" Foreground="Red" Margin="0,5,0,0" TextWrapping="Wrap"
                                                   Visibility="{Binding GhiChu, Converter={StaticResource NullToVisibilityConverter}}"/>
                                        <TextBlock Margin="0,10,0,0" Foreground="{StaticResource TextGray}">
                                            <Run Text="{Binding ThoiGianGoiDisplay, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}"/>
                                            <Run Text="{Binding ThoiGianCho, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" FontWeight="Bold"/>
                                        </TextBlock>
                                        <Button Content="Bắt đầu làm" Style="{StaticResource ActionButton}" Background="#42A5F5" Margin="0,10,0,0"
                                                Click="BtnStartItem_Click"
                                                Visibility="{Binding IsChoLam, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                        <Button Content="Hoàn thành" Style="{StaticResource ActionButton}" Background="#66BB6A" Margin="0,10,0,0"
                                                Click="BtnCompleteItem_Click"
                                                Visibility="{Binding IsDangLam, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </TabItem>

            <!-- 🍹 Pha Chế -->
            <TabItem Header="🍹 Pha Chế (Đồ Uống)">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <ItemsControl x:Name="icPhaChe">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Style="{StaticResource KitchenCard}" Width="280"
                                        MouseLeftButtonDown="Border_CongThuc_Click"
                                        ToolTip="Click để xem công thức">
                                    <StackPanel Margin="10">
                                        <TextBlock Text="{Binding SoBan}" FontSize="20" FontWeight="Bold" Foreground="{StaticResource CafeOrange}"/>
                                        <TextBlock Margin="0,5,0,0">
                                            <Run Text="{Binding TenMon}" FontSize="18" FontWeight="SemiBold"/>
                                            <Run Text=" (x" FontSize="18" FontWeight="Bold"/>
                                            <Run Text="{Binding SoLuong}" FontSize="18" FontWeight="Bold"/>
                                            <Run Text=")" FontSize="18" FontWeight="Bold"/>
                                        </TextBlock>
                                        <TextBlock Text="{Binding GhiChu}" FontStyle="Italic" Foreground="Red" Margin="0,5,0,0" TextWrapping="Wrap"
                                                   Visibility="{Binding GhiChu, Converter={StaticResource NullToVisibilityConverter}}"/>
                                        <TextBlock Margin="0,10,0,0" Foreground="{StaticResource TextGray}">
                                            <Run Text="{Binding ThoiGianGoiDisplay, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}"/>
                                            <Run Text="{Binding ThoiGianCho, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" FontWeight="Bold"/>
                                        </TextBlock>
                                        <Button Content="Bắt đầu làm" Style="{StaticResource ActionButton}" Background="#42A5F5" Margin="0,10,0,0"
                                                Click="BtnStartItem_Click"
                                                Visibility="{Binding IsChoLam, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                        <Button Content="Hoàn thành" Style="{StaticResource ActionButton}" Background="#66BB6A" Margin="0,10,0,0"
                                                Click="BtnCompleteItem_Click"
                                                Visibility="{Binding IsDangLam, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </TabItem>
        </TabControl>

        <!-- Overlay tải dữ liệu -->
        <Border x:Name="LoadingOverlay" Grid.RowSpan="2" Background="#66000000" Visibility="Collapsed">
            <TextBlock Text="Đang tải..." HorizontalAlignment="Center" VerticalAlignment="Center"
                       FontSize="18" FontWeight="SemiBold" Foreground="White"/>
        </Border>

        <!-- Overlay hiển thị công thức -->
        <Grid x:Name="CongThucOverlay" Grid.RowSpan="2" Background="#80000000" Visibility="Collapsed">
            <Border VerticalAlignment="Center" HorizontalAlignment="Center"
                    Background="White" CornerRadius="10" Width="420" MaxHeight="500"
                    Padding="10">
                <Border.Effect>
                    <DropShadowEffect ShadowDepth="3" BlurRadius="15" Opacity="0.3"/>
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <Border Grid.Row="0" BorderBrush="#EEE" BorderThickness="0,0,0,1">
                        <TextBlock x:Name="lblCongThucTenMon" Text="Công thức: Món ABC"
                                   FontSize="18" FontWeight="Bold" Foreground="{StaticResource CafeBrown}"
                                   Padding="10,8"/>
                    </Border>

                    <ListView x:Name="lvCongThuc" Grid.Row="1" Margin="5" BorderThickness="0">
                        <ListView.View>
                            <GridView>
                                <GridViewColumn Header="Nguyên Liệu" DisplayMemberBinding="{Binding TenNguyenLieu}" Width="180"/>
                                <GridViewColumn Header="Số Lượng" DisplayMemberBinding="{Binding SoLuongSuDung}" Width="80"/>
                                <GridViewColumn Header="Đơn Vị" DisplayMemberBinding="{Binding TenDonVi}" Width="100"/>
                            </GridView>
                        </ListView.View>
                    </ListView>

                    <Button x:Name="BtnCloseCongThuc" Grid.Row="2" Content="Đóng"
                            Style="{StaticResource ActionButton}" Background="#757575"
                            Margin="10" Width="80" HorizontalAlignment="Right"
                            Click="BtnCloseCongThuc_Click"/>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Page>

================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\CheBienView.xaml.cs
================================================================================
﻿using CafebookModel.Model.ModelApp.NhanVien;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input; // Thêm
using System.Windows.Threading;

namespace AppCafebookApi.View.nhanvien.pages
{
    public partial class CheBienView : Page
    {
        private static readonly HttpClient _httpClient;
        private DispatcherTimer _refreshTimer;

        static CheBienView()
        {
            _httpClient = new HttpClient { BaseAddress = new Uri("http://localhost:5166") };
        }

        public CheBienView()
        {
            InitializeComponent();

            // Cài đặt Timer tự động làm mới
            _refreshTimer = new DispatcherTimer
            {
                Interval = TimeSpan.FromSeconds(15)
            };
            _refreshTimer.Tick += async (s, e) => await LoadDataAsync();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadDataAsync();
            _refreshTimer.Start();
        }

        private void Page_Unloaded(object sender, RoutedEventArgs e)
        {
            _refreshTimer.Stop(); // Dừng timer khi rời trang
        }

        private async Task LoadDataAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var allItems = await _httpClient.GetFromJsonAsync<List<CheBienItemDto>>("api/app/nhanvien/chebien/load");

                if (allItems != null)
                {
                    // Lọc theo NhomIn (Bếp hoặc PhaChế)
                    icBep.ItemsSource = allItems
                        .Where(i => string.Equals(i.NhomIn, "Bếp", StringComparison.OrdinalIgnoreCase))
                        .ToList();

                    icPhaChe.ItemsSource = allItems
                        .Where(i => !string.Equals(i.NhomIn, "Bếp", StringComparison.OrdinalIgnoreCase)) // Mặc định còn lại là Pha Chế
                        .ToList();
                }

                lblLastUpdated.Text = $"(Cập nhật lúc: {DateTime.Now:HH:mm:ss})";
            }
            catch (Exception ex)
            {
                lblLastUpdated.Text = $"(Lỗi: {ex.Message})";
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnStartItem_Click(object sender, RoutedEventArgs e)
        {
            var item = (sender as Button)?.DataContext as CheBienItemDto;
            if (item == null) return;

            // Ngăn sự kiện click của Border cha
            e.Handled = true;

            _refreshTimer.Stop();
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await _httpClient.PostAsync($"api/app/nhanvien/chebien/start/{item.IdTrangThaiCheBien}", null);
                if (!response.IsSuccessStatusCode)
                {
                    MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lỗi");
                }
            }
            catch (Exception ex) { MessageBox.Show(ex.Message, "Lỗi API"); }

            await LoadDataAsync();
            _refreshTimer.Start();
        }

        private async void BtnCompleteItem_Click(object sender, RoutedEventArgs e)
        {
            var item = (sender as Button)?.DataContext as CheBienItemDto;
            if (item == null) return;

            // Ngăn sự kiện click của Border cha
            e.Handled = true;

            _refreshTimer.Stop();
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await _httpClient.PostAsync($"api/app/nhanvien/chebien/complete/{item.IdTrangThaiCheBien}", null);
                if (!response.IsSuccessStatusCode)
                {
                    MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lỗi");
                }
            }
            catch (Exception ex) { MessageBox.Show(ex.Message, "Lỗi API"); }

            await LoadDataAsync();
            _refreshTimer.Start();
        }

        // === THÊM MỚI: HÀM HIỂN THỊ CÔNG THỨC ===

        private async void Border_CongThuc_Click(object sender, MouseButtonEventArgs e)
        {
            var item = (sender as Border)?.DataContext as CheBienItemDto;
            if (item == null) return;

            // Dừng timer khi xem công thức
            _refreshTimer.Stop();
            LoadingOverlay.Visibility = Visibility.Visible;

            try
            {
                // Gọi API lấy công thức
                var congThucItems = await _httpClient.GetFromJsonAsync<List<CongThucItemDto>>($"api/app/nhanvien/chebien/congthuc/{item.IdSanPham}");

                // Cập nhật UI
                lblCongThucTenMon.Text = $"Công thức: {item.TenMon}";
                lvCongThuc.ItemsSource = congThucItems;

                // Hiển thị Overlay
                CongThucOverlay.Visibility = Visibility.Visible;
                // Kích hoạt animation (bằng cách cập nhật binding Target)
                CongThucOverlay.SetBinding(Border.OpacityProperty, new System.Windows.Data.Binding());
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải công thức: {ex.Message}", "Lỗi API");
                _refreshTimer.Start(); // Bật lại timer nếu có lỗi
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnCloseCongThuc_Click(object sender, RoutedEventArgs e)
        {
            // Ẩn Overlay
            CongThucOverlay.Visibility = Visibility.Collapsed;
            lvCongThuc.ItemsSource = null; // Xóa dữ liệu cũ

            // Bật lại timer
            _refreshTimer.Start();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\DatBanView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.nhanvien.pages.DatBanView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.nhanvien.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="DatBanView" FontFamily="Segoe UI" Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#EEEEEE"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="StatusGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="StatusRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="StatusYellowBrush" Color="#FFA726"/>
        <SolidColorBrush x:Key="StatusBlueBrush" Color="#42A5F5"/>
        <FontFamily x:Key="FontAwesomeSolid">/Fonts/Font Awesome 6 Free-Solid-900.otf#Font Awesome 6 Free Solid</FontFamily>

        <Style TargetType="TextBlock" x:Key="FormLabel">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,10,0,5"/>
        </Style>
        <Style TargetType="TextBox" x:Key="FormTextBox">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>
        <Style TargetType="ComboBox" x:Key="FormComboBox">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>
        <Style TargetType="DatePicker" x:Key="FormDatePicker">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>

        <Style x:Key="ActionButton" TargetType="Button">
            <Setter Property="Padding" Value="10,8"/>
            <Setter Property="Margin" Value="5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" Margin="{TemplateBinding Padding}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="border" Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="ActionToggleStyle" TargetType="ToggleButton">
            <Setter Property="Padding" Value="10,8"/>
            <Setter Property="Margin" Value="5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" Margin="{TemplateBinding Padding}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="border" Property="Opacity" Value="0.5"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource AccentOrangeBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <local:TrangThaiDatBanToBrushConverter x:Key="TrangThaiBrushConverter"/>

    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="350"/>
        </Grid.ColumnDefinitions>

        <Grid Grid.Column="0" Margin="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            <TextBlock Grid.Row="0" Text="Quản lý Phiếu Đặt Bàn" FontSize="24" FontWeight="Bold" 
                       Foreground="{StaticResource DarkBrownBrush}" Margin="10,5"/>
            <Border Grid.Row="1" Background="White" CornerRadius="4" Padding="15" Margin="10,5">
                <WrapPanel>
                    <TextBlock Text="Tìm SĐT/Tên:" VerticalAlignment="Center" Margin="0,0,5,0" FontWeight="SemiBold"/>
                    <TextBox x:Name="txtSearch" Width="180" Style="{StaticResource FormTextBox}" KeyUp="TxtSearch_KeyUp"/>
                    <TextBlock Text="Ngày đặt:" VerticalAlignment="Center" Margin="15,0,5,0" FontWeight="SemiBold"/>
                    <DatePicker x:Name="dpSearchDate" Width="130" Style="{StaticResource FormDatePicker}"/>
                    <TextBlock Text="Trạng thái:" VerticalAlignment="Center" Margin="15,0,5,0" FontWeight="SemiBold"/>
                    <ComboBox x:Name="cmbSearchTrangThai" Width="120" Style="{StaticResource FormComboBox}" SelectionChanged="BtnSearch_Click">
                        <ComboBoxItem Content="Tất cả"/>
                        <ComboBoxItem Content="Chờ xác nhận"/>
                        <ComboBoxItem Content="Đã xác nhận"/>
                    </ComboBox>
                    <Button x:Name="btnSearch" Content="Lọc" Style="{StaticResource ActionButton}" 
                            Background="{StaticResource PrimaryBrownBrush}" Click="BtnSearch_Click" Padding="15,8"/>
                    <ToggleButton x:Name="btnShowHistory" Content="Hiện Lịch Sử Hủy" Style="{StaticResource ActionToggleStyle}" 
                                  Background="{StaticResource TextGrayBrush}" Click="BtnShowHistory_Click" Margin="10,5,5,5" Padding="15,8"/>
                </WrapPanel>
            </Border>
            <DataGrid Grid.Row="2" x:Name="dgPhieuDatBan" Margin="10,5" AutoGenerateColumns="False" 
                      IsReadOnly="True" SelectionMode="Single" SelectionChanged="DgPhieuDatBan_SelectionChanged"
                      ItemsSource="{Binding PhieuDatBans}" CanUserAddRows="False">
                <DataGrid.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="✅ Xác nhận khách đến" Click="BtnXacNhanDen_Click" x:Name="menuXacNhanDen"/>
                        <MenuItem Header="🚫 Hủy phiếu" Click="BtnHuyPhieu_Click" x:Name="menuHuyPhieu"/>
                        <Separator />
                        <MenuItem Header="✏️ Sửa phiếu" Click="MenuSuaPhieu_Click"/>
                        <MenuItem Header="❌ Xóa phiếu" Click="MenuXoaPhieu_Click"/>
                    </ContextMenu>
                </DataGrid.ContextMenu>
                <DataGrid.Columns>
                    <DataGridTemplateColumn Header="Trạng thái" Width="Auto">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border CornerRadius="10" Padding="8,3" Margin="5"
                                        Background="{Binding TrangThai, Converter={StaticResource TrangThaiBrushConverter}}">
                                    <TextBlock Text="{Binding TrangThai}" FontWeight="SemiBold" 
                                               Foreground="White" HorizontalAlignment="Center"/>
                                </Border>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    <DataGridTextColumn Header="Thời Gian Đặt" Binding="{Binding ThoiGianDat, StringFormat='HH:mm dd/MM/yy'}" Width="*"/>
                    <DataGridTextColumn Header="Tên Khách Hàng" Binding="{Binding TenKhachHang}" Width="*"/>
                    <DataGridTextColumn Header="Số ĐT" Binding="{Binding SoDienThoai}" Width="*"/>
                    <DataGridTextColumn Header="Bàn" Binding="{Binding SoBan}" Width="Auto"/>
                    <DataGridTextColumn Header="Khu Vực" Binding="{Binding TenKhuVuc}" Width="*"/>
                    <DataGridTextColumn Header="SL Khách" Binding="{Binding SoLuongKhach}" Width="Auto"/>
                    <DataGridTextColumn Header="Ghi Chú" Binding="{Binding GhiChu}" Width="2*"/>
                </DataGrid.Columns>
            </DataGrid>
        </Grid>

        <Border Grid.Column="1" Background="White" Margin="0,10,10,10" CornerRadius="4">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel Margin="20">
                    <TextBlock Text="Thông Tin Phiếu" FontSize="20" 
                               FontWeight="Bold" 
                               Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,10"/>

                    <TextBlock Style="{StaticResource FormLabel}" Text="Tên Khách Hàng *"/>
                    <TextBox x:Name="txtTenKhach" Style="{StaticResource FormTextBox}" 
                             TextChanged="TxtKhachInfo_TextChanged"/>

                    <TextBlock Style="{StaticResource FormLabel}" Text="Số Điện Thoại * (Gõ để tìm KH)"/>
                    <TextBox x:Name="txtSdtKH" Style="{StaticResource FormTextBox}" 
                             TextChanged="TxtKhachInfo_TextChanged"
                             ToolTip="Nếu SĐT đã tồn tại, phiếu sẽ tự động gán cho khách cũ."/>

                    <TextBlock Style="{StaticResource FormLabel}" Text="Email (Gõ để tìm KH)"/>
                    <TextBox x:Name="txtEmailKH" Style="{StaticResource FormTextBox}"
                             TextChanged="TxtKhachInfo_TextChanged"/>

                    <ListBox x:Name="lbKhachHangResults" MaxHeight="100" 
                             Visibility="Collapsed" Margin="0,5,0,0"
                             SelectionChanged="LbKhachHangResults_SelectionChanged">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Margin="5">
                                    <TextBlock Text="{Binding HoTen}" FontWeight="SemiBold"/>
                                    <TextBlock Text="{Binding SoDienThoai}" Foreground="Gray" FontSize="11"/>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                    <TextBlock Style="{StaticResource FormLabel}" Text="Lọc Khu Vực (Form)"/>
                    <ComboBox x:Name="cmbFilterKhuVuc_Form" Style="{StaticResource FormComboBox}"
                              DisplayMemberPath="TenKhuVuc" SelectedValuePath="IdKhuVuc"
                              SelectionChanged="CmbFilterKhuVuc_Form_SelectionChanged"/>


                    <TextBlock Style="{StaticResource FormLabel}" Text="Bàn * (Gõ để tìm bàn)"/>
                    <ComboBox x:Name="cmbBan" Style="{StaticResource FormComboBox}"
                              ItemsSource="{Binding AvailableBans}" DisplayMemberPath="HienThi" 
                              SelectedValuePath="IdBan"
                              IsEditable="True" IsTextSearchEnabled="False"
                              KeyUp="CmbBan_KeyUp"/>

                    <TextBlock Style="{StaticResource FormLabel}" Text="Thời Gian Đặt *"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <DatePicker Grid.Column="0" x:Name="dpThoiGianDat" Style="{StaticResource FormDatePicker}"/>

                        <ComboBox Grid.Column="1" x:Name="cmbHour" Style="{StaticResource FormComboBox}" Width="60" Margin="5,0,0,0"
                                  IsEditable="True" KeyUp="CmbTime_KeyUp"/>
                        <ComboBox Grid.Column="2" x:Name="cmbMinute" Style="{StaticResource FormComboBox}" Width="60" Margin="5,0,0,0"
                                  IsEditable="True" KeyUp="CmbTime_KeyUp"/>
                    </Grid>

                    <TextBlock Style="{StaticResource FormLabel}" Text="Số Lượng Khách *"/>
                    <TextBox x:Name="txtSoLuongKhach" Style="{StaticResource FormTextBox}" PreviewTextInput="NumberValidationTextBox"/>

                    <TextBlock Style="{StaticResource FormLabel}" Text="Trạng Thái *"/>
                    <ComboBox x:Name="cmbTrangThai" Style="{StaticResource FormComboBox}">
                        <ComboBoxItem Content="Đã xác nhận"/>
                        <ComboBoxItem Content="Chờ xác nhận"/>
                        <ComboBoxItem Content="Đã hủy"/>
                        <ComboBoxItem Content="Khách đã đến"/>
                    </ComboBox>

                    <TextBlock Style="{StaticResource FormLabel}" Text="Ghi Chú"/>
                    <TextBox x:Name="txtGhiChu" Style="{StaticResource FormTextBox}" Height="60" 
                             TextWrapping="Wrap" AcceptsReturn="True"/>

                    <Button x:Name="btnXacNhanDen_Form" Content="✅ Xác Nhận Khách Đến" Style="{StaticResource ActionButton}" 
                            Background="{StaticResource StatusGreenBrush}" Margin="5,15,5,5"
                            Click="BtnXacNhanDen_Click" Visibility="Collapsed"/>

                    <Grid Margin="0,10,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Button x:Name="btnThem" Content="Thêm" Grid.Column="0" 
                                Style="{StaticResource ActionButton}" Background="{StaticResource StatusGreenBrush}"
                                Click="BtnThem_Click"/>
                        <Button x:Name="btnSua" Content="Sửa" Grid.Column="1" 
                                Style="{StaticResource ActionButton}" Background="{StaticResource StatusBlueBrush}"
                                Click="BtnSua_Click"/>
                        <Button x:Name="btnXoa" Content="Xóa" Grid.Column="2" 
                                Style="{StaticResource ActionButton}" Background="{StaticResource StatusRedBrush}"
                                Click="BtnXoa_Click"/>
                    </Grid>
                    <Button x:Name="btnLamMoiForm" Content="Làm Mới Form" Style="{StaticResource ActionButton}" 
                            Background="{StaticResource TextGrayBrush}" Margin="5,10,5,5"
                            Click="BtnLamMoiForm_Click"/>
                </StackPanel>
            </ScrollViewer>
        </Border>

        <Border x:Name="LoadingOverlay" Grid.ColumnSpan="2" Background="#80FFFFFF" Visibility="Collapsed">
            <TextBlock Text="Đang tải..." HorizontalAlignment="Center" VerticalAlignment="Center" 
                       FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\DatBanView.xaml.cs
================================================================================
﻿// [DatBanView.xaml.cs]
using AppCafebookApi.Services;
using CafebookModel.Model.ModelApp.NhanVien.DatBan;
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Globalization;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Text.Json;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using System.Windows.Media;
using AppCafebookApi.View.nhanvien;
using CafebookModel.Model.ModelApp;
using System.Windows.Threading; // THÊM MỚI
using System.Diagnostics; // THÊM MỚI

namespace AppCafebookApi.View.nhanvien.pages
{
    public partial class DatBanView : Page
    {
        private static readonly HttpClient httpClient;

        private ObservableCollection<PhieuDatBanDto> PhieuDatBans { get; set; }
        private ObservableCollection<BanDatBanDto> AvailableBans { get; set; }

        private List<PhieuDatBanDto> _allPhieuDatBansCache = new List<PhieuDatBanDto>();
        private List<BanDatBanDto> _allBansCache = new List<BanDatBanDto>();
        private List<KhuVucDto> _allKhuVucCache = new List<KhuVucDto>();
        // XÓA: private List<KhachHangLookupDto> _globalCustomerCache = new List<KhachHangLookupDto>();

        private PhieuDatBanDto? _selectedPhieu;
        private JsonSerializerOptions _jsonOptions;

        // SỬA: Thay thế _isCustomerSearchLoading
        private DispatcherTimer _searchKhachTimer;
        private bool _isUpdatingKhachText = false;


        private (TimeSpan Open, TimeSpan Close) _openingHours = (new TimeSpan(6, 0, 0), new TimeSpan(23, 0, 0));
        private List<string> _validHours = new List<string>();
        private List<string> _validMinutes = Enumerable.Range(0, 60).Select(m => m.ToString("00")).ToList();

        static DatBanView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166") // Đảm bảo địa chỉ này là đúng
            };
        }

        public DatBanView()
        {
            InitializeComponent();
            PhieuDatBans = new ObservableCollection<PhieuDatBanDto>();
            AvailableBans = new ObservableCollection<BanDatBanDto>();
            this.DataContext = this;

            dgPhieuDatBan.ItemsSource = PhieuDatBans;
            cmbBan.ItemsSource = AvailableBans;

            _jsonOptions = new JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true
            };

            // THÊM MỚI: Khởi tạo Timer
            _searchKhachTimer = new DispatcherTimer { Interval = TimeSpan.FromMilliseconds(500) };
            _searchKhachTimer.Tick += async (s, e) => { _searchKhachTimer.Stop(); await SearchKhachHangAsync(); };

            cmbSearchTrangThai.SelectedIndex = 0; // Mặc định là "Tất cả"
            cmbTrangThai.SelectedIndex = 0;
            dpThoiGianDat.SelectedDate = DateTime.Now;

            InitializeTimePickers(false);
        }

        private void InitializeTimePickers(bool useCache)
        {
            if (useCache) // useCache = true khi đã tải _openingHours từ API
            {
                _validHours.Clear();

                // SỬA: Logic vòng lặp giờ
                // Giờ đóng cửa là 23:00. Dừng trước 1 tiếng nghĩa là giờ cuối cùng là 21:xx (chọn "21").
                // Vì vậy, vòng lặp phải DƯỚI 22 (tức là < GiờĐóngCửa - 1).
                int gioBatDau = _openingHours.Open.Hours; // vd: 6
                int gioCuoiCung = _openingHours.Close.Hours - 1; // vd: 23 - 1 = 22

                for (int h = gioBatDau; h < gioCuoiCung; h++)
                {
                    _validHours.Add(h.ToString("00"));
                }
            }
            else
            {
                _validHours = Enumerable.Range(0, 24).Select(h => h.ToString("00")).ToList();
            }

            cmbHour.ItemsSource = _validHours;
            cmbMinute.ItemsSource = _validMinutes;

            var now = DateTime.Now;
            DateTime roundedNow = now;
            //int minute = (now.Minute / 15 + 1) * 15;
            //DateTime roundedNow = now.Date.AddHours(now.Hour).AddMinutes(minute);

            string currentHour = roundedNow.ToString("HH");
            if (_validHours.Contains(currentHour))
            {
                cmbHour.Text = currentHour;
            }
            else if (roundedNow.TimeOfDay < _openingHours.Open)
            {
                cmbHour.Text = _openingHours.Open.ToString("hh");
            }
            else
            {
                cmbHour.Text = _validHours.LastOrDefault();
            }

            cmbMinute.Text = roundedNow.ToString("mm");
            dpThoiGianDat.SelectedDate = roundedNow.Date;
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadAllDataAsync();
        }

        #region Tải và Lọc Dữ Liệu

        private async Task LoadAllDataAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            await Task.WhenAll(
                LoadPhieuDatBansAsync(),
                LoadAvailableBansAsync(),
                LoadKhuVucAsync(),
                LoadOpeningHoursAsync()
            );

            InitializeTimePickers(true);

            ApplyFilter();
            ClearForm();
            LoadingOverlay.Visibility = Visibility.Collapsed;
        }

        private async Task LoadPhieuDatBansAsync()
        {
            try
            {
                var data = await httpClient.GetFromJsonAsync<List<PhieuDatBanDto>>("api/app/datban/list", _jsonOptions);
                _allPhieuDatBansCache.Clear();
                if (data != null) _allPhieuDatBansCache = data;
            }
            catch (Exception ex) { MessageBox.Show("Lỗi tải danh sách phiếu đặt bàn: " + ex.Message); }
        }
        private async Task LoadAvailableBansAsync()
        {
            try
            {
                var data = await httpClient.GetFromJsonAsync<List<BanDatBanDto>>("api/app/datban/available-bans", _jsonOptions);
                _allBansCache.Clear(); AvailableBans.Clear();
                if (data != null)
                {
                    _allBansCache = data;
                    foreach (var item in data.OrderBy(b => b.SoBan)) AvailableBans.Add(item);
                }
            }
            catch (Exception ex) { MessageBox.Show("Lỗi tải danh sách bàn: " + ex.Message); }
        }
        private async Task LoadKhuVucAsync()
        {
            try
            {
                // Giả định API này tồn tại
                _allKhuVucCache = (await httpClient.GetFromJsonAsync<List<KhuVucDto>>("api/app/banquanly/tree")) ?? new List<KhuVucDto>();
                var filterList = new List<KhuVucDto>(_allKhuVucCache);
                filterList.Insert(0, new KhuVucDto { IdKhuVuc = 0, TenKhuVuc = "Tất cả Khu vực" });
                cmbFilterKhuVuc_Form.ItemsSource = filterList;
                cmbFilterKhuVuc_Form.SelectedIndex = 0;
            }
            catch (Exception ex) { MessageBox.Show($"Không thể tải danh sách Khu Vực: {ex.Message}"); }
        }

        private async Task LoadOpeningHoursAsync()
        {
            try
            {
                string settingValue = await httpClient.GetStringAsync("api/app/datban/opening-hours");
                ParseOpeningHoursClient(settingValue);
            }
            catch (Exception ex)
            {
                MessageBox.Show("Không thể tải giờ mở cửa: " + ex.Message);
                ParseOpeningHoursClient("06:00 - 23:00");
            }
        }

        private void ParseOpeningHoursClient(string settingValue)
        {
            try
            {
                var match = Regex.Match(settingValue, @"(\d{2}:\d{2})\s*-\s*(\d{2}:\d{2})");
                if (match.Success)
                {
                    TimeSpan.TryParse(match.Groups[1].Value, out TimeSpan open);
                    TimeSpan.TryParse(match.Groups[2].Value, out TimeSpan close);
                    _openingHours = (open, close);
                }
            }
            catch
            {
                _openingHours = (new TimeSpan(6, 0, 0), new TimeSpan(23, 0, 0));
            }
        }

        private void BtnSearch_Click(object sender, RoutedEventArgs e)
        {
            ApplyFilter();
        }

        private void TxtSearch_KeyUp(object sender, KeyEventArgs e)
        {
            if (e.Key == Key.Enter)
            {
                ApplyFilter();
            }
        }

        private void BtnShowHistory_Click(object sender, RoutedEventArgs e)
        {
            bool showHistory = btnShowHistory.IsChecked == true;
            if (showHistory)
            {
                btnShowHistory.Content = "Hiện Đơn Đang Chờ";
                cmbSearchTrangThai.Visibility = Visibility.Collapsed;
            }
            else
            {
                btnShowHistory.Content = "Hiện Lịch Sử Hủy";
                cmbSearchTrangThai.Visibility = Visibility.Visible;
                cmbSearchTrangThai.SelectedIndex = 0; // Reset về "Tất cả"
            }
            ApplyFilter();
        }

        private void ApplyFilter()
        {
            if (_allPhieuDatBansCache == null) return;
            IEnumerable<PhieuDatBanDto> filteredList;
            bool showHistory = btnShowHistory.IsChecked == true;

            if (showHistory)
            {
                filteredList = _allPhieuDatBansCache.Where(p =>
                    p.TrangThai == "Đã hủy" ||
                    p.TrangThai == "Khách đã đến");
            }
            else
            {
                var trangThaiFilter = (cmbSearchTrangThai.SelectedItem as ComboBoxItem)?.Content.ToString() ?? "Tất cả";

                if (trangThaiFilter == "Tất cả")
                {
                    filteredList = _allPhieuDatBansCache.Where(p =>
                        p.TrangThai == "Chờ xác nhận" ||
                        p.TrangThai == "Đã xác nhận");
                }
                else
                {
                    filteredList = _allPhieuDatBansCache.Where(p => p.TrangThai == trangThaiFilter);
                }
            }

            var filterText = txtSearch.Text.ToLower().Trim();
            if (!string.IsNullOrEmpty(filterText))
            {
                filteredList = filteredList
                    .Where(p => (p.TenKhachHang != null && p.TenKhachHang.ToLower().Contains(filterText)) ||
                                (p.SoDienThoai != null && p.SoDienThoai.Contains(filterText)));
            }
            var filterDate = dpSearchDate.SelectedDate;
            if (filterDate.HasValue)
            {
                filteredList = filteredList.Where(p => p.ThoiGianDat.Date == filterDate.Value.Date);
            }
            if (showHistory)
            {
                filteredList = filteredList.OrderByDescending(p => p.ThoiGianDat);
            }
            else
            {
                filteredList = filteredList.OrderBy(p => p.ThoiGianDat);
            }
            PhieuDatBans.Clear();
            foreach (var item in filteredList)
            {
                PhieuDatBans.Add(item);
            }
        }


        private async void BtnRefresh_Click(object sender, RoutedEventArgs e)
        {
            txtSearch.Text = string.Empty;
            dpSearchDate.SelectedDate = null;
            cmbSearchTrangThai.SelectedIndex = 0;
            btnShowHistory.IsChecked = false;
            await LoadAllDataAsync();
            ApplyFilter();
        }

        #endregion

        #region Xử lý Form (Thêm/Sửa/Xóa)

        private void DgPhieuDatBan_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            _selectedPhieu = dgPhieuDatBan.SelectedItem as PhieuDatBanDto;
            if (_selectedPhieu == null)
            {
                ClearForm();
                return;
            }

            // SỬA: Dùng _isUpdatingKhachText
            _isUpdatingKhachText = true;
            txtTenKhach.Text = _selectedPhieu.TenKhachHang;
            txtSdtKH.Text = _selectedPhieu.SoDienThoai;
            txtEmailKH.Text = _selectedPhieu.Email;
            _isUpdatingKhachText = false;

            lbKhachHangResults.Visibility = Visibility.Collapsed;
            lbKhachHangResults.ItemsSource = null;

            dpThoiGianDat.SelectedDate = _selectedPhieu.ThoiGianDat;
            cmbHour.Text = _selectedPhieu.ThoiGianDat.ToString("HH");
            cmbMinute.Text = _selectedPhieu.ThoiGianDat.ToString("mm");
            txtSoLuongKhach.Text = _selectedPhieu.SoLuongKhach.ToString();
            txtGhiChu.Text = _selectedPhieu.GhiChu;
            foreach (ComboBoxItem item in cmbTrangThai.Items)
            {
                if (item.Content.ToString() == _selectedPhieu.TrangThai)
                {
                    cmbTrangThai.SelectedItem = item;
                    break;
                }
            }
            var ban = _allBansCache.FirstOrDefault(b => b.IdBan == _selectedPhieu.IdBan);
            if (ban == null)
            {
                if (!AvailableBans.Any(b => b.IdBan == _selectedPhieu.IdBan))
                {
                    AvailableBans.Add(new BanDatBanDto { IdBan = _selectedPhieu.IdBan, SoBan = _selectedPhieu.SoBan, TenKhuVuc = _selectedPhieu.TenKhuVuc, IdKhuVuc = 0, SoGhe = 0 });
                }
            }
            cmbBan.SelectedValue = _selectedPhieu.IdBan;
            if (_selectedPhieu.TrangThai == "Đã xác nhận")
            {
                btnXacNhanDen_Form.Visibility = Visibility.Visible;
                menuXacNhanDen.IsEnabled = true;
                menuHuyPhieu.IsEnabled = true;
            }
            else if (_selectedPhieu.TrangThai == "Chờ xác nhận")
            {
                btnXacNhanDen_Form.Visibility = Visibility.Collapsed;
                menuXacNhanDen.IsEnabled = true;
                menuHuyPhieu.IsEnabled = true;
            }
            else
            {
                btnXacNhanDen_Form.Visibility = Visibility.Collapsed;
                menuXacNhanDen.IsEnabled = false;
                menuHuyPhieu.IsEnabled = false;
            }
            btnSua.IsEnabled = true;
            btnXoa.IsEnabled = true;

            // XÓA: Toàn bộ logic chkKhachVangLai
        }

        private void ClearForm()
        {
            _selectedPhieu = null;

            _isUpdatingKhachText = true; // SỬA
            txtTenKhach.Text = string.Empty;
            txtSdtKH.Text = string.Empty;
            txtEmailKH.Text = string.Empty;
            _isUpdatingKhachText = false;

            lbKhachHangResults.ItemsSource = null; // SỬA
            lbKhachHangResults.Visibility = Visibility.Collapsed; // SỬA

            cmbBan.SelectedIndex = -1;

            var now = DateTime.Now;
            DateTime roundedNow = now;
            //int minute = (now.Minute / 15 + 1) * 15;
            //DateTime roundedNow = now.Date.AddHours(now.Hour).AddMinutes(minute);

            dpThoiGianDat.SelectedDate = roundedNow.Date;
            cmbHour.Text = roundedNow.ToString("HH");
            cmbMinute.Text = roundedNow.ToString("mm");

            txtSoLuongKhach.Text = "1";
            cmbTrangThai.SelectedIndex = 0;
            txtGhiChu.Text = string.Empty;
            dgPhieuDatBan.SelectedIndex = -1;
            btnSua.IsEnabled = false;
            btnXoa.IsEnabled = false;
            btnXacNhanDen_Form.Visibility = Visibility.Collapsed;
            menuXacNhanDen.IsEnabled = false;
            menuHuyPhieu.IsEnabled = false;

            // XÓA: Toàn bộ logic chkKhachVangLai
        }

        private void BtnLamMoiForm_Click(object sender, RoutedEventArgs e)
        {
            ClearForm();
        }

        private bool ValidateForm(out PhieuDatBanCreateUpdateDto? dto)
        {
            dto = null;
            if (AuthService.CurrentUser == null)
            {
                MessageBox.Show("Phiên đăng nhập hết hạn. Vui lòng đăng nhập lại.");
                return false;
            }

            // SỬA: Đọc từ TextBox
            if (string.IsNullOrWhiteSpace(txtTenKhach.Text) ||
                string.IsNullOrWhiteSpace(txtSdtKH.Text) ||
                cmbBan.SelectedValue == null ||
                dpThoiGianDat.SelectedDate == null ||
                string.IsNullOrWhiteSpace(cmbHour.Text) || string.IsNullOrWhiteSpace(cmbMinute.Text) ||
                string.IsNullOrWhiteSpace(txtSoLuongKhach.Text))
            {
                MessageBox.Show("Vui lòng nhập đầy đủ các trường bắt buộc (*).");
                return false;
            }
            if (!int.TryParse(cmbHour.Text, out int hour) || hour < 0 || hour > 23)
            {
                MessageBox.Show("Giờ nhập không hợp lệ (phải là số 0-23).");
                return false;
            }
            if (!int.TryParse(cmbMinute.Text, out int minute) || minute < 0 || minute > 59)
            {
                MessageBox.Show("Phút nhập không hợp lệ (phải là số 0-59).");
                return false;
            }

            DateTime selectedDate = dpThoiGianDat.SelectedDate.Value;
            DateTime thoiGianDat = new DateTime(selectedDate.Year, selectedDate.Month, selectedDate.Day, hour, minute, 0);

            if (thoiGianDat < DateTime.Now.AddMinutes(10))
            {
                MessageBox.Show("Thời gian đặt phải cách ít nhất 10 phút so với hiện tại.", "Lỗi Thời Gian");
                return false;
            }

            var timeOfDay = thoiGianDat.TimeOfDay;
            if (timeOfDay < _openingHours.Open || timeOfDay > _openingHours.Close)
            {
                MessageBox.Show($"Giờ đặt ({thoiGianDat:HH:mm}) nằm ngoài giờ mở cửa ({_openingHours.Open:hh\\:mm} - {_openingHours.Close:hh\\:mm}).");
                return false;
            }
            var selectedBan = cmbBan.SelectedItem as BanDatBanDto;
            int soKhach = int.Parse(txtSoLuongKhach.Text);
            if (selectedBan != null && soKhach > selectedBan.SoGhe)
            {
                MessageBox.Show($"Số lượng khách ({soKhach}) vượt quá số ghế của bàn ({selectedBan.SoGhe}).", "Lỗi Sức Chứa");
                return false;
            }

            // SỬA: Lấy thông tin trực tiếp từ TextBox
            dto = new PhieuDatBanCreateUpdateDto
            {
                TenKhachHang = txtTenKhach.Text.Trim(),
                SoDienThoai = txtSdtKH.Text.Trim(),
                Email = string.IsNullOrWhiteSpace(txtEmailKH.Text) ? null : txtEmailKH.Text.Trim(),
                IdBan = (int)cmbBan.SelectedValue,
                ThoiGianDat = thoiGianDat,
                SoLuongKhach = soKhach,
                GhiChu = txtGhiChu.Text.Trim(),
                TrangThai = (cmbTrangThai.SelectedItem as ComboBoxItem)?.Content.ToString() ?? "Đã xác nhận",
                IdNhanVienTao = AuthService.CurrentUser.IdNhanVien,
                // IsKhachVangLai đã được XÓA
            };
            return true;
        }


        private async void BtnThem_Click(object sender, RoutedEventArgs e)
        {
            if (!ValidateForm(out var dto)) return;
            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/datban/create-staff", dto);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Thêm phiếu đặt bàn thành công.");
                    await LoadAllDataAsync();
                    ApplyFilter();
                }
                else
                {
                    MessageBox.Show("Lỗi tạo phiếu: " + await response.Content.ReadAsStringAsync());
                }
            }
            catch (Exception ex) { MessageBox.Show("Lỗi API: " + ex.Message); }
        }

        private async void BtnSua_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedPhieu == null) return;
            if (!ValidateForm(out var dto)) return;
            if (dto == null) return;
            dto.IdPhieuDatBan = _selectedPhieu.IdPhieuDatBan;
            try
            {
                var response = await httpClient.PutAsJsonAsync($"api/app/datban/update/{dto.IdPhieuDatBan}", dto);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Cập nhật phiếu thành công.");
                    await LoadAllDataAsync();
                    ApplyFilter();
                }
                else
                {
                    MessageBox.Show("Lỗi cập nhật: " + await response.Content.ReadAsStringAsync());
                }
            }
            catch (Exception ex) { MessageBox.Show("Lỗi API: " + ex.Message); }
        }

        private async void BtnXoa_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedPhieu == null)
            {
                MessageBox.Show("Vui lòng chọn phiếu để xóa."); return;
            }
            if (MessageBox.Show($"Bạn có chắc muốn xóa phiếu của khách '{_selectedPhieu.TenKhachHang}'?",
                "Xác nhận xóa", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.No)
            {
                return;
            }
            await HuyPhieu(_selectedPhieu.IdPhieuDatBan, true);
        }

        private void MenuSuaPhieu_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedPhieu == null)
            {
                MessageBox.Show("Vui lòng chọn phiếu để sửa.");
            }
        }

        private void MenuXoaPhieu_Click(object sender, RoutedEventArgs e)
        {
            BtnXoa_Click(sender, e);
        }

        #endregion

        #region Xử lý Context Menu và Nút Form

        // === HÀM ĐÃ SỬA ===
        private async void BtnXacNhanDen_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedPhieu == null) return;
            if (AuthService.CurrentUser == null)
            {
                MessageBox.Show("Phiên đăng nhập hết hạn."); return;
            }
            if (_selectedPhieu.TrangThai != "Đã xác nhận")
            {
                MessageBox.Show("Chỉ có thể xác nhận khách đến cho phiếu 'Đã xác nhận'.");
                return;
            }
            var request = new XacNhanKhachDenRequestDto
            {
                IdPhieuDatBan = _selectedPhieu.IdPhieuDatBan,
                IdNhanVien = AuthService.CurrentUser.IdNhanVien
            };
            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/datban/xacnhan-den", request);
                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<XacNhanKhachDenResponseDto>(_jsonOptions);

                    // 1. Thông báo cho người dùng
                    MessageBox.Show("Đã xác nhận khách đến. Chuyển đến Sơ đồ bàn...");

                    // 2. === SỬA LỖI ĐIỀU HƯỚNG ===
                    if (this.NavigationService != null && result != null)
                    {
                        this.NavigationService.Navigate(new SoDoBanView(_selectedPhieu.IdBan));
                    }
                    else
                    {
                        var mainWindow = Application.Current.MainWindow as ManHinhNhanVien;
                        if (mainWindow != null && result != null)
                        {
                            mainWindow.MainFrame.Navigate(new SoDoBanView(_selectedPhieu.IdBan));
                        }
                        else
                        {
                            MessageBox.Show("Lỗi: Không tìm thấy Frame chính để điều hướng.");
                        }
                    }

                    // 3. === SỬA LỖI "ĐỨNG YÊN" ===
                    // Xóa 2 dòng này.
                    // await LoadAllDataAsync();
                    // ApplyFilter();
                }
                else
                {
                    MessageBox.Show("Lỗi xác nhận: " + await response.Content.ReadAsStringAsync());
                }
            }
            catch (Exception ex) { MessageBox.Show("Lỗi API: " + ex.Message); }
        }

        private async void BtnHuyPhieu_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedPhieu == null) return;
            if (MessageBox.Show($"Bạn có chắc muốn HỦY phiếu của khách '{_selectedPhieu.TenKhachHang}'?",
               "Xác nhận hủy", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.No)
            {
                return;
            }
            await HuyPhieu(_selectedPhieu.IdPhieuDatBan, false);
        }

        private async Task HuyPhieu(int idPhieu, bool isDelete)
        {
            try
            {
                var response = await httpClient.PostAsync($"api/app/datban/huy/{idPhieu}", null);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show(isDelete ? "Xóa (hủy) phiếu thành công." : "Hủy phiếu thành công.");
                    await LoadAllDataAsync();
                    ApplyFilter();
                }
                else
                {
                    MessageBox.Show("Lỗi hủy phiếu: " + await response.Content.ReadAsStringAsync());
                }
            }
            catch (Exception ex) { MessageBox.Show("Lỗi API: " + ex.Message); }
        }

        #endregion

        #region Helpers (Tìm kiếm Form, Lọc ComboBox)

        private void NumberValidationTextBox(object sender, TextCompositionEventArgs e)
        {
            Regex regex = new Regex("[^0-9]+");
            e.Handled = regex.IsMatch(e.Text);
        }

        private void CmbFilterKhuVuc_Form_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (cmbFilterKhuVuc_Form.SelectedItem is KhuVucDto selectedKhuVuc)
            {
                AvailableBans.Clear();
                IEnumerable<BanDatBanDto> filteredBans = _allBansCache;
                if (selectedKhuVuc.IdKhuVuc > 0)
                {
                    filteredBans = _allBansCache.Where(b => b.IdKhuVuc == selectedKhuVuc.IdKhuVuc);
                }
                foreach (var ban in filteredBans.OrderBy(b => b.SoBan))
                {
                    AvailableBans.Add(ban);
                }
            }
        }

        private void CmbBan_KeyUp(object sender, KeyEventArgs e)
        {
            if (cmbBan.ItemsSource == null) cmbBan.ItemsSource = AvailableBans;
            if (e.Key == Key.Enter || e.Key == Key.Tab || e.Key == Key.Up || e.Key == Key.Down || e.Key == Key.Escape)
            {
                return;
            }
            string searchText = cmbBan.Text.ToLower();
            var selectedKhuVucId = (int?)cmbFilterKhuVuc_Form.SelectedValue;
            if (selectedKhuVucId == null) selectedKhuVucId = 0;
            var filteredBans = _allBansCache
                .Where(b => (selectedKhuVucId == 0 || b.IdKhuVuc == selectedKhuVucId))
                .Where(b => b.SoBan != null && b.SoBan.ToLower().Contains(searchText));
            AvailableBans.Clear();
            foreach (var ban in filteredBans.OrderBy(b => b.SoBan))
            {
                AvailableBans.Add(ban);
            }
            cmbBan.IsDropDownOpen = true;
        }

        // XÓA: CmbKhachHang_KeyUp, CmbKhachHang_DropDownOpened, SearchCustomerAsync, CmbKhachHang_SelectionChanged
        // XÓA: ChkKhachVangLai_Changed, ToggleCustomerSearch

        // THÊM MỚI: Logic tìm kiếm khách hàng (giống ThueSachView)
        private void TxtKhachInfo_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (_isUpdatingKhachText) return;
            _searchKhachTimer.Stop();
            _searchKhachTimer.Start();
        }

        private async Task SearchKhachHangAsync()
        {
            string query = !string.IsNullOrWhiteSpace(txtSdtKH.Text) ? txtSdtKH.Text : txtTenKhach.Text;

            if (string.IsNullOrWhiteSpace(query))
            {
                lbKhachHangResults.ItemsSource = null;
                lbKhachHangResults.Visibility = Visibility.Collapsed;
                return;
            }
            try
            {
                // API endpoint này đã được kiểm tra (từ file DatBanController) là tìm theo SĐT, Email, Tên.
                var results = await httpClient.GetFromJsonAsync<List<KhachHangLookupDto>>($"api/app/datban/search-customer?query={query}", _jsonOptions);
                if (results != null && results.Any())
                {
                    lbKhachHangResults.ItemsSource = results;
                    lbKhachHangResults.Visibility = Visibility.Visible;
                }
                else
                {
                    lbKhachHangResults.Visibility = Visibility.Collapsed;
                }
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"Lỗi tìm khách: {ex.Message}");
            }
        }

        private void LbKhachHangResults_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (lbKhachHangResults.SelectedItem is KhachHangLookupDto selected)
            {
                _isUpdatingKhachText = true;

                txtTenKhach.Text = selected.HoTen;
                txtSdtKH.Text = selected.SoDienThoai;
                txtEmailKH.Text = selected.Email;

                _isUpdatingKhachText = false;

                lbKhachHangResults.Visibility = Visibility.Collapsed;
                lbKhachHangResults.ItemsSource = null;
            }
        }

        private void CmbTime_KeyUp(object sender, KeyEventArgs e)
        {
            if (e.Key == Key.Enter || e.Key == Key.Tab || e.Key == Key.Up || e.Key == Key.Down || e.Key == Key.Escape)
            {
                return;
            }
            var cmb = sender as ComboBox;
            if (cmb == null) return;
            var source = (cmb.Name == "cmbHour") ? _validHours : _validMinutes;
            string searchText = cmb.Text;
            var filteredList = source.Where(t => t.StartsWith(searchText)).ToList();
            cmb.ItemsSource = filteredList;
            cmb.IsDropDownOpen = true;
        }

        #endregion
    }

    public class TrangThaiDatBanToBrushConverter : System.Windows.Data.IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            string? trangThai = value as string;
            if (trangThai == null) return Brushes.Gray;
            switch (trangThai)
            {
                case "Chờ xác nhận":
                    return new SolidColorBrush((Color)ColorConverter.ConvertFromString("#FFA726"));
                case "Đã xác nhận":
                    return new SolidColorBrush((Color)ColorConverter.ConvertFromString("#42A5F5"));
                case "Khách đã đến":
                    return new SolidColorBrush((Color)ColorConverter.ConvertFromString("#66BB6A"));
                case "Đã hủy":
                    return new SolidColorBrush((Color)ColorConverter.ConvertFromString("#EF5350"));
                default:
                    return Brushes.LightGray;
            }
        }
        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\GiaoHangView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.nhanvien.pages.GiaoHangView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.nhanvien.pages"
      mc:Ignorable="d" 
      d:DesignHeight="720" d:DesignWidth="1150"
      Title="GiaoHangView"
      FontFamily="Segoe UI" Background="#FFF8E1" Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="GreenBrush" Color="#388E3C"/>
        <SolidColorBrush x:Key="RedBrush" Color="#D32F2F"/>
        <SolidColorBrush x:Key="BlueBrush" Color="#1976D2"/>
        <SolidColorBrush x:Key="OrangeBrush" Color="#F57C00"/>
        <CollectionViewSource x:Key="ShippersSource" />
        <Style TargetType="ComboBox" x:Key="DataGridComboBoxStyle">
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style TargetType="TextBlock" x:Key="DataGridTextBlockStyle">
            <Setter Property="Padding" Value="5,2"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="DataGridButton" TargetType="Button" BasedOn="{StaticResource {x:Static ToolBar.ButtonStyleKey}}">
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Margin" Value="2"/>
            <Setter Property="Padding" Value="8,4"/>
        </Style>
        <Style x:Key="ActionButton_ChoXacNhan" TargetType="Button" BasedOn="{StaticResource DataGridButton}">
            <Setter Property="Visibility" Value="Collapsed"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding TrangThaiGiaoHang}" Value="Chờ xác nhận">
                    <Setter Property="Visibility" Value="Visible"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TrangThaiGiaoHang}" Value="{x:Null}">
                    <Setter Property="Visibility" Value="Visible"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </Page.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Grid Grid.Row="0" Margin="0,0,0,15">
            <TextBlock Text="Quản lý Đơn Giao Hàng" FontSize="24" FontWeight="Bold" Foreground="{StaticResource PrimaryBrownBrush}" VerticalAlignment="Center"/>
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                <Button x:Name="btnConfirmAll" Content="Xác nhận tất cả đơn chờ" Padding="15,8" FontWeight="SemiBold" Click="BtnConfirmAll_Click" Background="{StaticResource GreenBrush}" Foreground="White" Margin="0,0,10,0"/>
                <Button x:Name="btnRefresh" Content="Tải lại" Padding="15,8" FontWeight="SemiBold" Click="BtnRefresh_Click"/>
            </StackPanel>
        </Grid>

        <Grid Grid.Row="1" Margin="0,0,0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="200"/>
            </Grid.ColumnDefinitions>

            <TextBox x:Name="txtSearch" Grid.Column="0" Padding="8" VerticalContentAlignment="Center"
                     Text="" ToolTip="Tìm theo Tên, SĐT khách hoặc Mã HĐ..."
                     TextChanged="TxtSearch_TextChanged"/>

            <ComboBox x:Name="cmbStatusFilter" Grid.Column="1" Margin="10,0,0,0" Padding="8,7" VerticalContentAlignment="Center"
                      SelectedIndex="1"
                      SelectionChanged="CmbStatusFilter_SelectionChanged">
                <ComboBoxItem Content="Tất cả"/>
                <ComboBoxItem Content="Chờ xác nhận"/>
                <ComboBoxItem Content="Đang chuẩn bị"/>
                <ComboBoxItem Content="Chờ lấy hàng"/>
                <ComboBoxItem Content="Đang giao"/>
                <ComboBoxItem Content="Hoàn thành"/>
                <ComboBoxItem Content="Đã Hủy"/>
            </ComboBox>

        </Grid>

        <DataGrid Grid.Row="2" x:Name="dgGiaoHang" AutoGenerateColumns="False" CanUserAddRows="False"
                  BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="1">
            <DataGrid.Columns>
                <DataGridTextColumn Header="HĐ #" Binding="{Binding IdHoaDon}" IsReadOnly="True" FontWeight="SemiBold"/>
                <DataGridTextColumn Header="Thời gian" Binding="{Binding ThoiGianTao, StringFormat=dd/MM HH:mm}" IsReadOnly="True"/>
                <DataGridTemplateColumn Header="Khách hàng" MinWidth="180" IsReadOnly="True">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Margin="5">
                                <TextBlock Text="{Binding TenKhachHang}" FontWeight="SemiBold"/>
                                <TextBlock Text="{Binding SoDienThoaiGiaoHang}" Foreground="{StaticResource TextGrayBrush}" FontSize="11"/>
                                <TextBlock Text="{Binding DiaChiGiaoHang}" TextWrapping="Wrap" FontSize="11"/>
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTextColumn Header="Tổng tiền" Binding="{Binding ThanhTien, StringFormat=N0}" IsReadOnly="True" FontWeight="SemiBold"/>
                <DataGridTextColumn Header="Thanh toán" Binding="{Binding TrangThaiThanhToan}" IsReadOnly="True"/>

                <DataGridTextColumn Header="Trạng thái Giao hàng" Binding="{Binding TrangThaiGiaoHang, FallbackValue='Chờ xác nhận'}" IsReadOnly="True"/>

                <DataGridTemplateColumn Header="Người giao hàng" MinWidth="130">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <ComboBox Style="{StaticResource DataGridComboBoxStyle}"
                                      ItemsSource="{Binding Source={StaticResource ShippersSource}}"
                                      SelectedValue="{Binding IdNguoiGiaoHang, UpdateSourceTrigger=PropertyChanged}"
                                      DisplayMemberPath="TenNguoiGiaoHang"
                                      SelectedValuePath="IdNguoiGiaoHang"
                                      SelectionChanged="CmbNguoiGiaoHang_SelectionChanged"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <DataGridTemplateColumn Header="Hành động" Width="Auto">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <Button x:Name="btnChuyenCheBien" 
                                        Content="Chuyển Bếp"
                                        Style="{StaticResource ActionButton_ChoXacNhan}"
                                        Background="{StaticResource GreenBrush}"
                                        Foreground="White"
                                        Click="BtnChuyenCheBien_Click"
                                        Tag="{Binding IdHoaDon}"/>

                                <Button x:Name="btnHuyDon" 
                                        Content="Hủy"
                                        Style="{StaticResource ActionButton_ChoXacNhan}"
                                        Background="{StaticResource RedBrush}"
                                        Foreground="White"
                                        Click="BtnHuyDon_Click"
                                        Tag="{Binding IdHoaDon}"/>
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <DataGridTemplateColumn Width="Auto">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Button x:Name="btnInPhieu" Content="In Phiếu" Padding="8,4" Margin="5"
                                    Style="{StaticResource DataGridButton}"
                                    Background="{StaticResource BlueBrush}"
                                    Click="BtnInPhieu_Click"
                                    Tag="{Binding IdHoaDon}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

            </DataGrid.Columns>
        </DataGrid>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\GiaoHangView.xaml.cs
================================================================================
﻿// Tệp: AppCafebookApi/View/nhanvien/pages/GiaoHangView.xaml.cs
using AppCafebookApi.Services;
using AppCafebookApi.View.common;
using AppCafebookApi.View.Common;
using CafebookModel.Model.ModelApp.NhanVien;
using System;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Collections.Generic; // THÊM
using System.Net.Http; // THÊM
using System.Windows.Threading; // THÊM cho Timer

namespace AppCafebookApi.View.nhanvien.pages
{
    public partial class GiaoHangView : Page
    {
        private bool _isLoading = false;

        // =======================================
        // === THÊM TIMER CHO LIVE SEARCH (YÊU CẦU 2) ===
        // =======================================
        private DispatcherTimer _searchTimer;

        public GiaoHangView()
        {
            InitializeComponent();

            // Khởi tạo timer
            _searchTimer = new DispatcherTimer();
            _searchTimer.Interval = TimeSpan.FromMilliseconds(500); // Chờ 500ms sau khi gõ
            _searchTimer.Tick += async (s, e) =>
            {
                _searchTimer.Stop(); // Dừng timer
                await LoadDataAsync(); // Gọi API
            };
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadDataAsync();
        }

        private async Task LoadDataAsync()
        {
            if (_isLoading) return; // Chặn gọi API chồng chéo
            _isLoading = true;

            try
            {
                // LẤY DỮ LIỆU TỪ BỘ LỌC
                string searchQuery = txtSearch.Text;
                string statusQuery = (cmbStatusFilter.SelectedItem as ComboBoxItem)?.Content?.ToString() ?? "Chờ xác nhận";

                // Xử lý nếu lỡ tay gõ vào ô tìm kiếm
                if (searchQuery == "Tìm theo Tên, SĐT khách hoặc Mã HĐ...")
                {
                    searchQuery = "";
                }

                // Xây dựng query string
                var queryParams = new List<string>();
                if (!string.IsNullOrWhiteSpace(searchQuery))
                {
                    queryParams.Add($"search={Uri.EscapeDataString(searchQuery)}");
                }
                if (statusQuery != "Tất cả")
                {
                    queryParams.Add($"status={Uri.EscapeDataString(statusQuery)}");
                }
                string queryString = string.Join("&", queryParams);

                var response = await ApiClient.Instance.GetFromJsonAsync<GiaoHangViewDto>($"api/app/nhanvien/giaohang/load?{queryString}");

                if (response != null)
                {
                    dgGiaoHang.ItemsSource = response.DonGiaoHang;
                    var shippersSource = (CollectionViewSource)this.FindResource("ShippersSource");
                    shippersSource.Source = response.NguoiGiaoHangSanSang;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải dữ liệu giao hàng: {ex.Message}", "Lỗi API");
            }
            _isLoading = false;
        }

        private async void BtnRefresh_Click(object sender, RoutedEventArgs e)
        {
            // SỬA: Reset về "Chờ xác nhận"
            txtSearch.Text = "";
            cmbStatusFilter.SelectedIndex = 1; // 0 = Tất cả, 1 = Chờ xác nhận
            await LoadDataAsync();
        }

        // =======================================
        // === SỬA/THÊM CÁC HÀM SỰ KIỆN (YÊU CẦU 2) ===
        // =======================================

        // XÓA: BtnFilter_Click(object sender, RoutedEventArgs e)

        // THÊM: TxtSearch_TextChanged
        private void TxtSearch_TextChanged(object sender, TextChangedEventArgs e)
        {
            // Không gọi API ngay, chỉ reset timer
            if (_isLoading) return;
            _searchTimer.Stop();
            _searchTimer.Start();
        }

        // THÊM: CmbStatusFilter_SelectionChanged
        private async void CmbStatusFilter_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            // Gọi API ngay khi đổi filter
            if (_isLoading || !this.IsLoaded) return;
            _searchTimer.Stop(); // Hủy tìm kiếm nếu đang gõ
            await LoadDataAsync();
        }

        // =======================================
        // === CÁC HÀM CÒN LẠI (GIỮ NGUYÊN) ===
        // =======================================

        private async void BtnConfirmAll_Click(object sender, RoutedEventArgs e)
        {
            var confirm = MessageBox.Show("Bạn có chắc chắn muốn chuyển TẤT CẢ đơn 'Chờ xác nhận' sang Bếp không?",
                                          "Xác nhận hàng loạt", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (confirm == MessageBoxResult.No) return;

            try
            {
                var response = await ApiClient.Instance.PostAsync("api/app/nhanvien/giaohang/confirm-all-pending", null);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Đã chuyển tất cả đơn sang Bếp thành công.", "Hoàn tất", MessageBoxButton.OK, MessageBoxImage.Information);
                    await LoadDataAsync();
                }
                else
                {
                    MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
        }

        private async void BtnChuyenCheBien_Click(object sender, RoutedEventArgs e)
        {
            if (sender is Button btn && btn.Tag is int idHoaDon)
            {
                var confirm = MessageBox.Show($"Bạn có muốn đẩy đơn hàng #{idHoaDon} sang Bếp/Bar để chuẩn bị không?",
                                             "Xác nhận gửi bếp", MessageBoxButton.YesNo, MessageBoxImage.Question);
                if (confirm == MessageBoxResult.No) return;

                var requestDto = new GiaoHangUpdateRequestDto
                {
                    TrangThaiGiaoHang = "Đang chuẩn bị",
                    IdNguoiGiaoHang = (btn.DataContext as GiaoHangItemDto)?.IdNguoiGiaoHang
                };
                await UpdateGiaoHangAsync(idHoaDon, requestDto);
            }
        }

        private async void BtnHuyDon_Click(object sender, RoutedEventArgs e)
        {
            if (sender is Button btn && btn.Tag is int idHoaDon)
            {
                var confirm = MessageBox.Show($"Bạn có chắc chắn muốn HỦY đơn hàng #{idHoaDon} không? Hành động này không thể hoàn tác.",
                                             "Xác nhận Hủy đơn", MessageBoxButton.YesNo, MessageBoxImage.Warning);
                if (confirm == MessageBoxResult.No) return;

                var requestDto = new GiaoHangUpdateRequestDto
                {
                    TrangThaiGiaoHang = "Hủy",
                    IdNguoiGiaoHang = (btn.DataContext as GiaoHangItemDto)?.IdNguoiGiaoHang
                };
                await UpdateGiaoHangAsync(idHoaDon, requestDto);
            }
        }

        private async void CmbNguoiGiaoHang_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (_isLoading) return;

            var comboBox = sender as ComboBox;
            var selectedItem = (comboBox?.DataContext) as GiaoHangItemDto;
            var newShipperId = (int?)comboBox?.SelectedValue;

            if (selectedItem == null) return;

            var requestDto = new GiaoHangUpdateRequestDto
            {
                TrangThaiGiaoHang = selectedItem.TrangThaiGiaoHang,
                IdNguoiGiaoHang = newShipperId
            };

            await UpdateGiaoHangAsync(selectedItem.IdHoaDon, requestDto);

            if (newShipperId.HasValue && string.IsNullOrEmpty(selectedItem.TrangThaiGiaoHang))
            {
                await LoadDataAsync();
            }
        }

        private async Task UpdateGiaoHangAsync(int idHoaDon, GiaoHangUpdateRequestDto dto)
        {
            try
            {
                var response = await ApiClient.Instance.PostAsJsonAsync($"api/app/nhanvien/giaohang/update/{idHoaDon}", dto);

                if (!response.IsSuccessStatusCode)
                {
                    string error = await response.Content.ReadAsStringAsync();
                    MessageBox.Show($"Lỗi cập nhật: {error}", "Lỗi API");
                    await LoadDataAsync();
                }

                if (dto.TrangThaiGiaoHang == "Hoàn thành" ||
                    dto.TrangThaiGiaoHang == "Đang chuẩn bị" ||
                    dto.TrangThaiGiaoHang == "Hủy")
                {
                    await LoadDataAsync();
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
                await LoadDataAsync();
            }
        }

        private async void BtnInPhieu_Click(object sender, RoutedEventArgs e)
        {
            if (sender is Button btn && btn.Tag is int idHoaDon)
            {
                try
                {
                    var printData = await ApiClient.Instance.GetFromJsonAsync<PhieuGoiMonPrintDto>($"api/app/nhanvien/giaohang/print-data/{idHoaDon}");

                    if (printData != null)
                    {
                        var printWindow = new AppCafebookApi.View.Common.PhieuGiaoHangPreviewWindow(printData);
                        printWindow.ShowDialog();
                    }
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Lỗi lấy dữ liệu in: {ex.Message}");
                }
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\GoiMonView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.nhanvien.pages.GoiMonView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.nhanvien.pages"
      mc:Ignorable="d" 
      d:DesignHeight="720" d:DesignWidth="1280"
      Title="GoiMonView" FontFamily="Segoe UI" Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>

        <Color x:Key="AccentOrangeColor">#D27D2D</Color>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="{StaticResource AccentOrangeColor}"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#EEEEEE"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="StatusGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="StatusRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="StatusYellowBrush" Color="#FFA726"/>

        <Geometry x:Key="IconSave">M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z</Geometry>
        <Geometry x:Key="IconPrint">M19,8H5C3.34,8 2,9.34 2,11V17H6V21H18V17H22V11C22,9.34 20.66,8 19,8M16,19H8V14H16V19M19,12C18.45,12 18,11.55 18,11C18,10.45 18.45,10 19,10C19.55,10 20,10.45 20,11C20,11.55 19.55,12 19,12M18,3H6V7H18V3Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>
        <Geometry x:Key="IconPay">M11,16H13V15H11V16M15,11H9V10C9,8.67 10.17,7.54 11.5,7.5C12.84,7.54 14,8.67 14,10V11H15M17,10C17,7.24 14.76,5 12,5C9.24,5 7,7.24 7,10V11H5V20H19V11H17V10Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z</Geometry>

        <Style x:Key="DataGridButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource SubtleGrayBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Width" Value="24"/>
            <Setter Property="Height" Value="24"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="DeleteDataGridButtonStyle" TargetType="Button" BasedOn="{StaticResource DataGridButtonStyle}">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#FFE8E8"/>
                    <Setter Property="Foreground" Value="{StaticResource StatusRedBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="InvoiceDataGridStyle" TargetType="DataGrid">
            <Setter Property="AutoGenerateColumns" Value="False"/>
            <Setter Property="CanUserAddRows" Value="False"/>
            <Setter Property="GridLinesVisibility" Value="Horizontal"/>
            <Setter Property="HorizontalGridLinesBrush" Value="{StaticResource SubtleGrayBrush}"/>
            <Setter Property="HeadersVisibility" Value="Column"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
        <Style TargetType="DataGridColumnHeader">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0,0,0,2"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
        </Style>
        <Style TargetType="DataGridCell">
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="10,8"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Style.Triggers>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="{StaticResource LightCreamBrush}"/>
                    <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="CategoryRadioButton" TargetType="RadioButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="Padding" Value="15,12"/>
            <Setter Property="BorderThickness" Value="3,0,0,0"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RadioButton">
                        <Border x:Name="border" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Left" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource SubtleGrayBrush}"/>
                </Trigger>
                <Trigger Property="IsChecked" Value="True">
                    <Setter Property="FontWeight" Value="SemiBold"/>
                    <Setter Property="Background" Value="{StaticResource LightCreamBrush}"/>
                    <Setter Property="BorderBrush" Value="{StaticResource AccentOrangeBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="ProductCard" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource LightCreamBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Margin" Value="10"/>
            <Setter Property="Width" Value="140"/>
            <Setter Property="Height" Value="150"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" CornerRadius="8">
                            <Border.Effect>
                                <DropShadowEffect x:Name="shadow" ShadowDepth="1" Color="#000" Opacity="0.05" BlurRadius="8"/>
                            </Border.Effect>
                            <ContentPresenter/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Trigger.EnterActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <ColorAnimation Storyboard.TargetName="Bd" Storyboard.TargetProperty="(Border.BorderBrush).(SolidColorBrush.Color)" To="#D27D2D" Duration="0:0:0.2"/>
                                            <DoubleAnimation Storyboard.TargetName="shadow" Storyboard.TargetProperty="Opacity" To="0.15" Duration="0:0:0.2" />
                                        </Storyboard>
                                    </BeginStoryboard>
                                </Trigger.EnterActions>
                                <Trigger.ExitActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <ColorAnimation Storyboard.TargetName="Bd" Storyboard.TargetProperty="(Border.BorderBrush).(SolidColorBrush.Color)" To="#E0E0E0" Duration="0:0:0.2"/>
                                            <DoubleAnimation Storyboard.TargetName="shadow" Storyboard.TargetProperty="Opacity" To="0.05" Duration="0:0:0.2" />
                                        </Storyboard>
                                    </BeginStoryboard>
                                </Trigger.ExitActions>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="ActionButton" TargetType="Button">
            <Setter Property="Padding" Value="15"/>
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>

        <Style x:Key="SearchTextBoxStyle" TargetType="TextBox">
            <Setter Property="Padding" Value="10,12"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="Validation.ErrorTemplate" Value="{x:Null}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TextBox">
                        <Border x:Name="border"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="8">
                            <ScrollViewer x:Name="PART_ContentHost" Focusable="false" HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Hidden"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource AccentOrangeBrush}"/>
                            </Trigger>
                            <Trigger Property="IsKeyboardFocused" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource AccentOrangeBrush}"/>
                                <Setter TargetName="border" Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect ShadowDepth="0" Color="{StaticResource AccentOrangeColor}" Opacity="0.3" BlurRadius="8"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="220"/>
            <ColumnDefinition Width="3*"/>
            <ColumnDefinition Width="2*"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Background="{StaticResource WhiteTextBrush}">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <ItemsControl x:Name="lbLoaiSP">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <RadioButton GroupName="Categories" 
                                         Content="{Binding TenLoaiSP}" 
                                         Style="{StaticResource CategoryRadioButton}"
                                         Checked="Category_Checked"
                                         DataContext="{Binding}"/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Border>

        <Grid Grid.Column="1" Background="{StaticResource SubtleGrayBrush}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <Border Grid.Row="0" Padding="15" Background="{StaticResource SubtleGrayBrush}">
                <TextBox x:Name="txtTimKiem" 
                         Style="{StaticResource SearchTextBoxStyle}"
                         TextChanged="TxtTimKiem_TextChanged"
                         Tag="Tìm kiếm món..."/>
            </Border>

            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                <ItemsControl x:Name="icSanPham">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Margin="5"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Button Style="{StaticResource ProductCard}" Click="ProductButton_Click" DataContext="{Binding}">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <Border Grid.Row="0" 
                                            Background="{StaticResource BorderGrayBrush}" 
                                            CornerRadius="6,6,0,0"
                                            ClipToBounds="True">
                                        <Image Source="{Binding HinhAnh}" 
                                               Stretch="UniformToFill" />
                                    </Border>
                                    <StackPanel Grid.Row="1" Margin="8">
                                        <TextBlock Text="{Binding TenSanPham}" FontWeight="SemiBold" TextWrapping="Wrap" TextAlignment="Center" Height="38" FontSize="14" Foreground="{StaticResource DarkBrownBrush}"/>
                                        <TextBlock Text="{Binding DonGia, StringFormat={}{0:N0} đ}" Foreground="{StaticResource PrimaryBrownBrush}" HorizontalAlignment="Center" Margin="0,5,0,0" FontWeight="Bold"/>
                                    </StackPanel>
                                </Grid>
                            </Button>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Grid>

        <Grid Grid.Column="2" Background="{StaticResource LightCreamBrush}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <Border Grid.Row="0" Padding="20,15" BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="0,0,0,1">
                <TextBlock x:Name="lblTieuDeHoaDon" Text="Hóa đơn - Bàn ..." FontSize="20" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}"/>
            </Border>

            <DataGrid Grid.Row="1" x:Name="dgChiTietHoaDon" Style="{StaticResource InvoiceDataGridStyle}">
                <DataGrid.Columns>
                    <DataGridTemplateColumn Header="Tên Món" Width="*" IsReadOnly="True">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel VerticalAlignment="Center">
                                    <TextBlock Text="{Binding TenSanPham}" FontWeight="SemiBold" />
                                    <TextBlock Text="{Binding GhiChu, StringFormat='Ghi chú: {0}'}" 
                                                 Foreground="{StaticResource TextGrayBrush}"
                                                 FontStyle="Italic"
                                                 FontSize="11"
                                                 TextWrapping="Wrap">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Visibility" Value="Visible"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding GhiChu}" Value="{x:Null}">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding GhiChu}" Value="">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTemplateColumn Header="Số Lượng" Width="100">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <Button x:Name="btnGiamSL" Content="-" Style="{StaticResource DataGridButtonStyle}" Click="BtnGiamSL_Click" Padding="0" Width="20" Height="20"/>
                                    <TextBlock Text="{Binding SoLuong}" Margin="8,0" VerticalAlignment="Center" FontWeight="SemiBold"/>
                                    <Button x:Name="btnTangSL" Content="+" Style="{StaticResource DataGridButtonStyle}" Click="BtnTangSL_Click" Padding="0" Width="20" Height="20"/>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTextColumn Header="Thành Tiền" Binding="{Binding ThanhTien, StringFormat=N0}" Width="*" IsReadOnly="True" FontWeight="SemiBold"/>

                    <DataGridTemplateColumn Header="Xóa" Width="40">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Button x:Name="btnXoaMon" Style="{StaticResource DeleteDataGridButtonStyle}" ToolTip="Xóa món"
                                        Click="BtnXoaMon_Click">
                                    <Viewbox Width="12" Height="12">
                                        <Path Data="{StaticResource IconDelete}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                                    </Viewbox>
                                </Button>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>

            <Border Grid.Row="2" Background="{StaticResource WhiteTextBrush}" Padding="15">
                <Border.Effect>
                    <DropShadowEffect ShadowDepth="0" BlurRadius="15" Opacity="0.1" Color="Black"/>
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid Grid.Row="0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Tổng tiền:" Margin="5" FontSize="14" Foreground="{StaticResource TextGrayBrush}"/>
                        <TextBlock Grid.Row="0" Grid.Column="1" Grid.ColumnSpan="2" x:Name="lblTongTien" Text="0" Margin="5" FontSize="14" HorizontalAlignment="Right" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Khuyến mãi:" Margin="5" VerticalAlignment="Center"/>
                        <Button Grid.Row="1" Grid.Column="1" x:Name="btnChonKhuyenMai" 
                                Content="-- Chọn Khuyến mãi --" 
                                Margin="5,5,0,5" 
                                Click="BtnChonKhuyenMai_Click"
                                FontWeight="SemiBold"/>
                        <Button Grid.Row="1" Grid.Column="2" x:Name="btnHuyKhuyenMai" 
                                Content="X" 
                                ToolTip="Gỡ bỏ khuyến mãi"
                                Margin="5,5,5,5" 
                                Click="BtnHuyKhuyenMai_Click"
                                Background="{StaticResource StatusRedBrush}" 
                                Foreground="White"
                                FontWeight="Bold" Width="25"
                                Visibility="Collapsed"/>
                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Tiền giảm:" Margin="5" FontSize="14" Foreground="{StaticResource TextGrayBrush}"/>
                        <TextBlock Grid.Row="2" Grid.Column="1" Grid.ColumnSpan="2" x:Name="lblTienGiam" Text="0" Margin="5" FontSize="14" HorizontalAlignment="Right" Foreground="{StaticResource StatusGreenBrush}" FontWeight="SemiBold"/>
                        <Separator Grid.Row="3" Grid.ColumnSpan="3" Margin="0,10"/>
                    </Grid>
                    <Grid Grid.Row="1" Margin="0,0,0,15">
                        <TextBlock Text="THÀNH TIỀN" FontSize="18" FontWeight="Bold" VerticalAlignment="Center" Foreground="{StaticResource DarkBrownBrush}"/>
                        <TextBlock x:Name="lblThanhTien" Text="0 VND" FontSize="22" FontWeight="Bold" HorizontalAlignment="Right" Foreground="{StaticResource PrimaryBrownBrush}"/>
                    </Grid>
                    <Grid Grid.Row="2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <Button x:Name="btnThanhToan" Grid.Column="0" Style="{StaticResource ActionButton}" Background="{StaticResource StatusGreenBrush}" Click="BtnThanhToan_Click">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,10,0" VerticalAlignment="Center">
                                    <Path Data="{StaticResource IconPay}" Fill="White"/>
                                </Viewbox>
                                <TextBlock Grid.Column="1" Text="Thanh Toán" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            </Grid>
                        </Button>
                        <Button x:Name="btnHuyDon" Grid.Column="1" ToolTip="Hủy Hóa đơn" Style="{StaticResource ActionButton}" 
                                Background="{StaticResource StatusRedBrush}" Click="BtnHuyDon_Click" Margin="5,0,0,0">
                            <Viewbox Width="18" Height="18">
                                <Path Data="{StaticResource IconDelete}" Fill="White"/>
                            </Viewbox>
                        </Button>
                        <Button x:Name="btnLuu" Grid.Column="2" ToolTip="Lưu Hóa đơn" Style="{StaticResource ActionButton}" Background="{StaticResource ActionBlueBrush}" Click="BtnLuu_Click" Margin="5,0,0,0">
                            <Viewbox Width="18" Height="18">
                                <Path Data="{StaticResource IconSave}" Fill="White"/>
                            </Viewbox>
                        </Button>
                        <Button x:Name="btnInPhieuGoiMon" Grid.Column="3" ToolTip="In Phiếu Gọi Món" Style="{StaticResource ActionButton}" Background="{StaticResource ActionGrayBrush}" Click="BtnInPhieuGoiMon_Click" Margin="5,0,0,0">
                            <Viewbox Width="18" Height="18">
                                <Path Data="{StaticResource IconPrint}" Fill="White"/>
                            </Viewbox>
                        </Button>
                        <Button x:Name="btnQuayLai" Grid.Column="4" ToolTip="Quay lại Sơ đồ bàn" Style="{StaticResource ActionButton}" Background="{StaticResource SubtleGrayBrush}" Foreground="{StaticResource DarkBrownBrush}" Click="BtnQuayLai_Click" Margin="5,0,0,0">
                            <Viewbox Width="18" Height="18">
                                <Path Data="{StaticResource IconBack}" Fill="{StaticResource DarkBrownBrush}"/>
                            </Viewbox>
                        </Button>
                    </Grid>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\GoiMonView.xaml.cs
================================================================================
﻿// Tập tin: AppCafebookApi/View/nhanvien/pages/GoiMonView.xaml.cs (ĐÃ SỬA)
using AppCafebookApi.Services;
using AppCafebookApi.View.common;
using AppCafebookApi.View.Common;
using CafebookModel.Model.ModelApp.NhanVien;
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media;

namespace AppCafebookApi.View.nhanvien.pages
{
    public partial class GoiMonView : Page
    {
        // Lớp helper hứng kết quả AddItem
        private class AddItemResponseDto
        {
            [JsonPropertyName("updatedHoaDonInfo")]
            public HoaDonInfoDto? updatedHoaDonInfo { get; set; }
            [JsonPropertyName("newItem")]
            public ChiTietDto? newItem { get; set; }
        }

        private readonly int _idHoaDon;
        private static readonly HttpClient _httpClient;

        // Biến cục bộ để lưu trạng thái
        private List<SanPhamDto> _allSanPhams = new List<SanPhamDto>();
        private ObservableCollection<ChiTietDto> _chiTietItems = new ObservableCollection<ChiTietDto>();
        private List<KhuyenMaiDto> _availableKms = new List<KhuyenMaiDto>();
        private int? _currentKhuyenMaiId = null;
        private bool _isDataLoading = true;

        // NÂNG CẤP: Lưu trữ danh mục đang chọn
        private DanhMucDto _currentDanhMuc = new DanhMucDto { IdDanhMuc = 0, TenLoaiSP = "Tất cả" };

        static GoiMonView()
        {
            _httpClient = new HttpClient { BaseAddress = new Uri("http://localhost:5166") };
        }

        public GoiMonView(int idHoaDon)
        {
            InitializeComponent();
            _idHoaDon = idHoaDon;
            dgChiTietHoaDon.ItemsSource = _chiTietItems;
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadDataAsync();
        }

        private async Task LoadDataAsync()
        {
            _isDataLoading = true;
            try
            {
                var response = await _httpClient.GetFromJsonAsync<GoiMonViewDto>($"api/app/nhanvien/goimon/load/{_idHoaDon}");
                if (response == null)
                {
                    MessageBox.Show("Không thể tải dữ liệu hóa đơn.", "Lỗi API");
                    return;
                }

                _allSanPhams = response.SanPhams ?? new List<SanPhamDto>();

                var danhMucs = response.DanhMucs ?? new List<DanhMucDto>();
                danhMucs.Insert(0, new DanhMucDto { IdDanhMuc = 0, TenLoaiSP = "Tất cả" });
                lbLoaiSP.ItemsSource = danhMucs;

                _chiTietItems.Clear();
                response.ChiTietItems?.ForEach(item => _chiTietItems.Add(item));

                _availableKms = response.KhuyenMais ?? new List<KhuyenMaiDto>();

                UpdateBillUI(response.HoaDonInfo);

                // Kích hoạt bộ lọc "Tất cả"
                if (lbLoaiSP.Items.Count > 0)
                {
                    lbLoaiSP.UpdateLayout();
                    var container = lbLoaiSP.ItemContainerGenerator.ContainerFromIndex(0) as FrameworkElement;
                    var rb = FindVisualChild<RadioButton>(container);
                    if (rb != null)
                    {
                        rb.IsChecked = true;
                    }
                    UpdateProductFilter(); // Gọi hàm lọc chung
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải dữ liệu: {ex.Message}", "Lỗi nghiêm trọng");
            }
            _isDataLoading = false;
        }

        private T? FindVisualChild<T>(DependencyObject? obj) where T : DependencyObject
        {
            // ... (Hàm này giữ nguyên) ...
            if (obj == null) return null;
            for (int i = 0; i < VisualTreeHelper.GetChildrenCount(obj); i++)
            {
                DependencyObject child = VisualTreeHelper.GetChild(obj, i);
                if (child != null && child is T)
                    return (T)child;
                else
                {
                    T? childOfChild = FindVisualChild<T>(child);
                    if (childOfChild != null)
                        return childOfChild;
                }
            }
            return null;
        }

        private void UpdateBillUI(HoaDonInfoDto info)
        {
            // ... (Hàm này giữ nguyên) ...
            if (info == null) return;
            lblTieuDeHoaDon.Text = $"Hóa đơn - {info.SoBan}";
            lblTongTien.Text = info.TongTienGoc.ToString("N0");
            lblTienGiam.Text = info.GiamGia.ToString("N0");
            lblThanhTien.Text = info.ThanhTien.ToString("N0") + " VND";
            _currentKhuyenMaiId = info.IdKhuyenMai;
            if (_currentKhuyenMaiId.HasValue && _currentKhuyenMaiId != 0)
            {
                var km = _availableKms.FirstOrDefault(k => k.IdKhuyenMai == _currentKhuyenMaiId);
                btnChonKhuyenMai.Content = km?.TenKhuyenMai ?? "Đã chọn KM";
                btnHuyKhuyenMai.Visibility = Visibility.Visible;
            }
            else
            {
                btnChonKhuyenMai.Content = "-- Chọn Khuyến mãi --";
                btnHuyKhuyenMai.Visibility = Visibility.Collapsed;
            }
        }

        // --- NÂNG CẤP: Logic Lọc ---

        private void Category_Checked(object sender, RoutedEventArgs e)
        {
            var radioButton = sender as RadioButton;
            var danhMuc = radioButton?.DataContext as DanhMucDto;

            if (danhMuc != null)
            {
                _currentDanhMuc = danhMuc;
            }
            else if (radioButton != null && radioButton.Content.ToString() == "Tất cả")
            {
                _currentDanhMuc = (lbLoaiSP.Items[0] as DanhMucDto) ?? new DanhMucDto { IdDanhMuc = 0 };
            }

            UpdateProductFilter();
        }

        private void TxtTimKiem_TextChanged(object sender, TextChangedEventArgs e)
        {
            // Gọi hàm lọc chung mỗi khi gõ
            UpdateProductFilter();
        }

        /// <summary>
        /// Hàm lọc sản phẩm dựa trên Category và Ô tìm kiếm
        /// </summary>
        private void UpdateProductFilter()
        {
            if (_allSanPhams == null) return;

            IEnumerable<SanPhamDto> filteredList = _allSanPhams;

            // 1. Lọc theo Category
            if (_currentDanhMuc != null && _currentDanhMuc.IdDanhMuc != 0)
            {
                filteredList = filteredList.Where(s => s.IdDanhMuc == _currentDanhMuc.IdDanhMuc);
            }

            // 2. Lọc theo Từ khóa tìm kiếm
            string keyword = txtTimKiem.Text.Trim().ToLowerInvariant();
            if (!string.IsNullOrEmpty(keyword))
            {
                filteredList = filteredList.Where(s =>
                    s.TenSanPham.ToLowerInvariant().Contains(keyword)
                );
            }

            icSanPham.ItemsSource = filteredList.ToList();
        }

        // --- KẾT THÚC NÂNG CẤP LỌC ---


        private async void ProductButton_Click(object sender, RoutedEventArgs e)
        {
            // ... (Hàm này giữ nguyên như lần trước, đã có InputBoxWindow) ...
            var sanPham = (sender as Button)?.DataContext as SanPhamDto;
            if (sanPham == null) return;

            var inputBox = new InputBoxWindow(
                "Thêm ghi chú",
                $"Nhập ghi chú cho món [{sanPham.TenSanPham}]:",
                ""
            );

            string? ghiChu = null;
            if (inputBox.ShowDialog() == true)
            {
                ghiChu = inputBox.InputText;
            }

            if (string.IsNullOrWhiteSpace(ghiChu))
            {
                ghiChu = null;
            }

            var request = new AddItemRequest
            {
                IdHoaDon = _idHoaDon,
                IdSanPham = sanPham.IdSanPham,
                SoLuong = 1,
                GhiChu = ghiChu
            };

            try
            {
                var response = await _httpClient.PostAsJsonAsync("api/app/nhanvien/goimon/add-item", request);
                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<AddItemResponseDto>();
                    if (result?.updatedHoaDonInfo == null || result.newItem == null) return;

                    UpdateBillUI(result.updatedHoaDonInfo);

                    ChiTietDto newItem = result.newItem;

                    var existingItem = _chiTietItems.FirstOrDefault(c => c.IdChiTietHoaDon == newItem.IdChiTietHoaDon);
                    if (existingItem != null)
                    {
                        existingItem.SoLuong = newItem.SoLuong;
                        existingItem.ThanhTien = newItem.ThanhTien;
                    }
                    else
                    {
                        _chiTietItems.Add(newItem);
                    }
                    dgChiTietHoaDon.Items.Refresh();
                }
                else
                {
                    MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lỗi thêm món");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message, "Lỗi API");
            }
        }

        private async void BtnGiamSL_Click(object sender, RoutedEventArgs e)
        {
            // ... (Hàm này giữ nguyên) ...
            var item = (sender as Button)?.DataContext as ChiTietDto;
            if (item == null) return;
            await UpdateQuantityAsync(item, item.SoLuong - 1);
        }

        private async void BtnTangSL_Click(object sender, RoutedEventArgs e)
        {
            // ... (Hàm này giữ nguyên) ...
            var item = (sender as Button)?.DataContext as ChiTietDto;
            if (item == null) return;
            await UpdateQuantityAsync(item, item.SoLuong + 1);
        }

        private async void BtnXoaMon_Click(object sender, RoutedEventArgs e)
        {
            // ... (Hàm này giữ nguyên) ...
            var item = (sender as Button)?.DataContext as ChiTietDto;
            if (item == null) return;
            var result = MessageBox.Show($"Bạn có chắc muốn xóa [{item.TenSanPham}]?", "Xác nhận xóa", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.Yes)
            {
                await UpdateQuantityAsync(item, 0);
            }
        }

        private async Task UpdateQuantityAsync(ChiTietDto item, int soLuongMoi)
        {
            // ... (Hàm này giữ nguyên) ...
            var request = new UpdateSoLuongRequest
            {
                IdChiTietHoaDon = item.IdChiTietHoaDon,
                SoLuongMoi = soLuongMoi
            };
            try
            {
                var response = await _httpClient.PutAsJsonAsync("api/app/nhanvien/goimon/update-quantity", request);
                if (response.IsSuccessStatusCode)
                {
                    var hoaDonInfo = await response.Content.ReadFromJsonAsync<HoaDonInfoDto>();
                    if (hoaDonInfo != null) UpdateBillUI(hoaDonInfo);
                    if (soLuongMoi <= 0)
                    {
                        _chiTietItems.Remove(item);
                    }
                    else
                    {
                        item.SoLuong = soLuongMoi;
                        item.ThanhTien = item.SoLuong * item.DonGia;
                    }
                    dgChiTietHoaDon.Items.Refresh();
                }
                else
                {
                    MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lỗi cập nhật");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message, "Lỗi API");
            }
        }

        // ... (Tất cả các hàm còn lại: BtnChonKhuyenMai_Click, BtnHuyKhuyenMai_Click, ApplyKhuyenMaiApiCallAsync, 
        // ...  BtnThanhToan_Click, BtnHuyDon_Click, BtnQuayLai_Click, BtnLuu_Click, BtnInPhieuGoiMon_Click 
        // ...  GIỮ NGUYÊN) ...

        private async void BtnChonKhuyenMai_Click(object sender, RoutedEventArgs e)
        {
            if (_isDataLoading) return;
            _isDataLoading = true;
            var dialog = new ChonKhuyenMaiWindow(_idHoaDon, _currentKhuyenMaiId);
            if (dialog.ShowDialog() == true)
            {
                int? selectedKmId = dialog.SelectedId;
                if (selectedKmId == 0) selectedKmId = null;
                await ApplyKhuyenMaiApiCallAsync(selectedKmId);
            }
            _isDataLoading = false;
        }
        private async void BtnHuyKhuyenMai_Click(object sender, RoutedEventArgs e)
        {
            if (_isDataLoading) return;
            _isDataLoading = true;
            await ApplyKhuyenMaiApiCallAsync(null);
            _isDataLoading = false;
        }
        private async Task ApplyKhuyenMaiApiCallAsync(int? idKhuyenMai)
        {
            var request = new ApplyPromotionRequest
            {
                IdHoaDon = _idHoaDon,
                IdKhuyenMai = idKhuyenMai
            };
            try
            {
                var response = await _httpClient.PutAsJsonAsync("api/app/nhanvien/goimon/apply-promotion", request);
                if (response.IsSuccessStatusCode)
                {
                    var hoaDonInfo = await response.Content.ReadFromJsonAsync<HoaDonInfoDto>();
                    if (hoaDonInfo != null)
                    {
                        await LoadDataAsync();
                        UpdateBillUI(hoaDonInfo);
                    }
                }
                else
                {
                    MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lỗi áp dụng KM");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message, "Lỗi API");
            }
        }
        private async void BtnThanhToan_Click(object sender, RoutedEventArgs e)
        {
            if (_isDataLoading) return;
            _isDataLoading = true;
            var request = new ApplyPromotionRequest
            {
                IdHoaDon = _idHoaDon,
                IdKhuyenMai = _currentKhuyenMaiId
            };
            try
            {
                var response = await _httpClient.PutAsJsonAsync("api/app/nhanvien/goimon/apply-promotion", request);
                if (!response.IsSuccessStatusCode)
                {
                    MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lỗi áp dụng KM");
                    _isDataLoading = false;
                    return;
                }
                this.NavigationService?.Navigate(new ThanhToanView(_idHoaDon));
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message, "Lỗi API");
            }
            _isDataLoading = false;
        }
        private async void BtnHuyDon_Click(object sender, RoutedEventArgs e)
        {
            var result = MessageBox.Show($"Bạn có chắc chắn muốn HỦY hóa đơn này không?\n(Các món đã thêm sẽ bị xóa)",
                            "Xác nhận Hủy", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result != MessageBoxResult.Yes) return;
            try
            {
                var response = await _httpClient.PutAsync($"api/app/nhanvien/goimon/cancel-order/{_idHoaDon}", null);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Đã hủy hóa đơn thành công!", "Thành công", MessageBoxButton.OK, MessageBoxImage.Information);
                    if (this.NavigationService.CanGoBack)
                    {
                        this.NavigationService.GoBack();
                    }
                }
                else
                {
                    MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lỗi Hủy Đơn");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message, "Lỗi API");
            }
        }
        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
        private async void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            if (AuthService.CurrentUser == null)
            {
                MessageBox.Show("Lỗi phiên đăng nhập.", "Lỗi");
                return;
            }
            try
            {
                var response = await _httpClient.PostAsync($"api/app/nhanvien/goimon/send-to-kitchen/{_idHoaDon}", null);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Đã lưu và gửi các món mới đến bếp/pha chế.", "Đã lưu");
                }
                else
                {
                    MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lỗi Lưu Hóa Đơn");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message, "Lỗi API");
            }
        }
        private async void BtnInPhieuGoiMon_Click(object sender, RoutedEventArgs e)
        {
            if (AuthService.CurrentUser == null)
            {
                MessageBox.Show("Lỗi phiên đăng nhập.", "Lỗi");
                return;
            }
            int idNhanVien = AuthService.CurrentUser.IdNhanVien;
            try
            {
                var response = await _httpClient.PostAsync($"api/app/nhanvien/goimon/print-and-notify-kitchen/{_idHoaDon}/{idNhanVien}", null);
                if (response.IsSuccessStatusCode)
                {
                    var printWindow = new PhieuGoiMonPreviewWindow(_idHoaDon);
                    printWindow.ShowDialog();
                    if (this.NavigationService.CanGoBack)
                    {
                        this.NavigationService.GoBack();
                    }
                }
                else
                {
                    MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lỗi In Phiếu");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message, "Lỗi API");
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\LichLamViecView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.nhanvien.pages.LichLamViecView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      mc:Ignorable="d" 
      d:DesignHeight="720" d:DesignWidth="1150"
      Title="LichLamViecView"
      FontFamily="Segoe UI" Background="#FFF8E1" Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="HeaderBackgroundBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="TodayBackgroundBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="OtherMonthTextBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="ShiftColor1" Color="#E8F5E9"/>
        <SolidColorBrush x:Key="ShiftBorderColor1" Color="#388E3C"/>
        <SolidColorBrush x:Key="LeaveColor" Color="#E3F2FD"/>
        <SolidColorBrush x:Key="LeaveBorderColor" Color="#1976D2"/>

        <Style TargetType="Button" x:Key="NavButton">
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>

        <Style TargetType="Button" x:Key="ViewToggleButton" BasedOn="{StaticResource NavButton}">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#E0E0E0"/>
                </Trigger>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Background" Value="#D0D0D0"/>
                    <Setter Property="Foreground" Value="#555"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style TargetType="TextBlock" x:Key="HeaderDayStyle">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Padding" Value="5"/>
        </Style>

        <Style TargetType="TextBlock" x:Key="HeaderTimeStyle">
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Foreground" Value="#757575"/>
            <Setter Property="HorizontalAlignment" Value="Right"/>
            <Setter Property="VerticalAlignment" Value="Top"/>
            <Setter Property="Margin" Value="0,-5,5,0"/>
        </Style>
    </Page.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="White" BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="0,0,0,1" Padding="10">
            <Grid>
                <StackPanel Orientation="Horizontal">
                    <Button x:Name="btnToday" Content="Hôm nay" Style="{StaticResource NavButton}" Margin="0,0,10,0" Click="BtnToday_Click"/>
                    <Button x:Name="btnPrev" Content="&lt;" Style="{StaticResource NavButton}" Click="BtnPrev_Click"/>
                    <Button x:Name="btnNext" Content="&gt;" Style="{StaticResource NavButton}" Margin="2,0,10,0" Click="BtnNext_Click"/>
                    <TextBlock x:Name="lblDateRange" Text="Đang tải..." FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource PrimaryBrownBrush}" VerticalAlignment="Center"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                    <Button x:Name="btnViewDay" Content="Ngày" Style="{StaticResource ViewToggleButton}" Click="BtnViewDay_Click"/>
                    <Button x:Name="btnViewWeek" Content="Tuần" Style="{StaticResource ViewToggleButton}" Margin="-1,0,0,0" Click="BtnViewWeek_Click"/>
                    <Button x:Name="btnViewMonth" Content="Tháng" Style="{StaticResource ViewToggleButton}" Margin="-1,0,0,0" Click="BtnViewMonth_Click"/>
                </StackPanel>
            </Grid>
        </Border>

        <Grid Grid.Row="1">

            <ScrollViewer x:Name="WeekViewScroll" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                <Grid x:Name="WeekViewGrid" ShowGridLines="True" Background="White" MinWidth="1100">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="60"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="40"/>
                        <RowDefinition Height="30"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                    </Grid.RowDefinitions>

                    <Border Grid.Row="0" Grid.Column="1" Background="{StaticResource HeaderBackgroundBrush}">
                        <TextBlock x:Name="lblHeaderMon" Text="Thứ 2" Style="{StaticResource HeaderDayStyle}"/>
                    </Border>
                    <Border Grid.Row="0" Grid.Column="2" Background="{StaticResource HeaderBackgroundBrush}">
                        <TextBlock x:Name="lblHeaderTue" Text="Thứ 3" Style="{StaticResource HeaderDayStyle}"/>
                    </Border>
                    <Border Grid.Row="0" Grid.Column="3" Background="{StaticResource HeaderBackgroundBrush}">
                        <TextBlock x:Name="lblHeaderWed" Text="Thứ 4" Style="{StaticResource HeaderDayStyle}"/>
                    </Border>
                    <Border Grid.Row="0" Grid.Column="4" Background="{StaticResource HeaderBackgroundBrush}">
                        <TextBlock x:Name="lblHeaderThu" Text="Thứ 5" Style="{StaticResource HeaderDayStyle}"/>
                    </Border>
                    <Border Grid.Row="0" Grid.Column="5" Background="{StaticResource HeaderBackgroundBrush}">
                        <TextBlock x:Name="lblHeaderFri" Text="Thứ 6" Style="{StaticResource HeaderDayStyle}"/>
                    </Border>
                    <Border Grid.Row="0" Grid.Column="6" Background="{StaticResource HeaderBackgroundBrush}">
                        <TextBlock x:Name="lblHeaderSat" Text="Thứ 7" Style="{StaticResource HeaderDayStyle}"/>
                    </Border>
                    <Border Grid.Row="0" Grid.Column="7" Background="{StaticResource HeaderBackgroundBrush}">
                        <TextBlock x:Name="lblHeaderSun" Text="Chủ Nhật" Style="{StaticResource HeaderDayStyle}"/>
                    </Border>

                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Cả ngày" Style="{StaticResource HeaderTimeStyle}" VerticalAlignment="Center" Margin="0,0,5,0"/>

                    <TextBlock Grid.Row="2" Grid.Column="0" Text="6sa" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="3" Grid.Column="0" Text="7sa" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="4" Grid.Column="0" Text="8sa" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="5" Grid.Column="0" Text="9sa" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="6" Grid.Column="0" Text="10sa" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="7" Grid.Column="0" Text="11sa" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="8" Grid.Column="0" Text="12ch" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="9" Grid.Column="0" Text="1ch" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="10" Grid.Column="0" Text="2ch" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="11" Grid.Column="0" Text="3ch" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="12" Grid.Column="0" Text="4ch" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="13" Grid.Column="0" Text="5ch" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="14" Grid.Column="0" Text="6ch" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="15" Grid.Column="0" Text="7ch" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="16" Grid.Column="0" Text="8ch" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="17" Grid.Column="0" Text="9ch" Style="{StaticResource HeaderTimeStyle}"/>
                </Grid>
            </ScrollViewer>

            <ScrollViewer x:Name="DayViewScroll" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                <Grid x:Name="DayViewGrid" ShowGridLines="True" Background="White">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="60"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="40"/>
                        <RowDefinition Height="30"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="60"/>
                    </Grid.RowDefinitions>

                    <Border Grid.Row="0" Grid.Column="1" Background="{StaticResource HeaderBackgroundBrush}">
                        <TextBlock x:Name="lblHeaderDay" Text="Ngày" Style="{StaticResource HeaderDayStyle}" FontSize="16"/>
                    </Border>

                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Cả ngày" Style="{StaticResource HeaderTimeStyle}" VerticalAlignment="Center" Margin="0,0,5,0"/>
                    <TextBlock Grid.Row="2" Grid.Column="0" Text="6sa" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="3" Grid.Column="0" Text="7sa" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="4" Grid.Column="0" Text="8sa" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="5" Grid.Column="0" Text="9sa" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="6" Grid.Column="0" Text="10sa" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="7" Grid.Column="0" Text="11sa" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="8" Grid.Column="0" Text="12ch" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="9" Grid.Column="0" Text="1ch" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="10" Grid.Column="0" Text="2ch" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="11" Grid.Column="0" Text="3ch" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="12" Grid.Column="0" Text="4ch" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="13" Grid.Column="0" Text="5ch" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="14" Grid.Column="0" Text="6ch" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="15" Grid.Column="0" Text="7ch" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="16" Grid.Column="0" Text="8ch" Style="{StaticResource HeaderTimeStyle}"/>
                    <TextBlock Grid.Row="17" Grid.Column="0" Text="9ch" Style="{StaticResource HeaderTimeStyle}"/>
                </Grid>
            </ScrollViewer>

            <ScrollViewer x:Name="MonthViewScroll" HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                <Grid x:Name="MonthViewGrid" ShowGridLines="True" Background="White">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="30"/>
                        <RowDefinition Height="100*"/>
                        <RowDefinition Height="100*"/>
                        <RowDefinition Height="100*"/>
                        <RowDefinition Height="100*"/>
                        <RowDefinition Height="100*"/>
                        <RowDefinition Height="100*"/>
                    </Grid.RowDefinitions>

                    <Border Grid.Row="0" Grid.Column="0" Background="{StaticResource HeaderBackgroundBrush}">
                        <TextBlock Text="Thứ 2" Style="{StaticResource HeaderDayStyle}"/>
                    </Border>
                    <Border Grid.Row="0" Grid.Column="1" Background="{StaticResource HeaderBackgroundBrush}">
                        <TextBlock Text="Thứ 3" Style="{StaticResource HeaderDayStyle}"/>
                    </Border>
                    <Border Grid.Row="0" Grid.Column="2" Background="{StaticResource HeaderBackgroundBrush}">
                        <TextBlock Text="Thứ 4" Style="{StaticResource HeaderDayStyle}"/>
                    </Border>
                    <Border Grid.Row="0" Grid.Column="3" Background="{StaticResource HeaderBackgroundBrush}">
                        <TextBlock Text="Thứ 5" Style="{StaticResource HeaderDayStyle}"/>
                    </Border>
                    <Border Grid.Row="0" Grid.Column="4" Background="{StaticResource HeaderBackgroundBrush}">
                        <TextBlock Text="Thứ 6" Style="{StaticResource HeaderDayStyle}"/>
                    </Border>
                    <Border Grid.Row="0" Grid.Column="5" Background="{StaticResource HeaderBackgroundBrush}">
                        <TextBlock Text="Thứ 7" Style="{StaticResource HeaderDayStyle}"/>
                    </Border>
                    <Border Grid.Row="0" Grid.Column="6" Background="{StaticResource HeaderBackgroundBrush}">
                        <TextBlock Text="Chủ Nhật" Style="{StaticResource HeaderDayStyle}"/>
                    </Border>

                </Grid>
            </ScrollViewer>
        </Grid>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\LichLamViecView.xaml.cs
================================================================================
﻿// Tệp: AppCafebookApi/View/nhanvien/pages/LichLamViecView.xaml.cs
using AppCafebookApi.Services;
using CafebookModel.Model.ModelApp.NhanVien;
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media;

namespace AppCafebookApi.View.nhanvien.pages
{
    public partial class LichLamViecView : Page
    {
        // Enum để quản lý trạng thái xem
        private enum ViewMode { Day, Week, Month }
        private ViewMode _currentView = ViewMode.Week;

        // Giờ bắt đầu cho chế độ xem Ngày/Tuần
        private const int START_HOUR = 6;
        private const int TOTAL_GRID_ROWS = 18; // 1 Header + 1 AllDay + 16 (6h-21h)

        private DateTime _currentDate; // Ngày neo (anchor date)
        private TextBlock[] _weekDayHeaders;

        // Màu cho các nút view
        private readonly SolidColorBrush _activeViewBrush = new SolidColorBrush(Color.FromRgb(222, 222, 222)); // #EEE
        private readonly SolidColorBrush _inactiveViewBrush = new SolidColorBrush(Colors.Transparent);

        public LichLamViecView()
        {
            InitializeComponent();
            _weekDayHeaders = new TextBlock[] { lblHeaderMon, lblHeaderTue, lblHeaderWed, lblHeaderThu, lblHeaderFri, lblHeaderSat, lblHeaderSun };
            _currentDate = DateTime.Today;
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            UpdateViewControls();
            await LoadScheduleAsync();
        }

        private async Task LoadScheduleAsync()
        {
            try
            {
                if (_currentView == ViewMode.Month)
                {
                    // Tải dữ liệu tháng
                    var data = await ApiClient.Instance.GetFromJsonAsync<LichLamViecThangDto>($"api/app/nhanvien/lichlamviec/thang?ngayTrongThang={_currentDate:yyyy-MM-dd}");
                    if (data == null) return;
                    lblDateRange.Text = _currentDate.ToString("MMMM yyyy", new CultureInfo("vi-VN"));
                    RenderMonthView(data.NgayCoSuKien);
                }
                else
                {
                    // Tải dữ liệu tuần (dùng cho cả Ngày và Tuần)
                    var data = await ApiClient.Instance.GetFromJsonAsync<LichLamViecViewDto>($"api/app/nhanvien/lichlamviec/tuan?ngayTrongTuan={_currentDate:yyyy-MM-dd}");
                    if (data == null) return;

                    if (_currentView == ViewMode.Week)
                    {
                        lblDateRange.Text = $"{data.NgayBatDauTuan:dd/MM} - {data.NgayKetThucTuan:dd/MM/yyyy}";
                        RenderWeekView(data);
                    }
                    else // _currentView == ViewMode.Day
                    {
                        lblDateRange.Text = _currentDate.ToString("dddd, dd MMMM, yyyy", new CultureInfo("vi-VN"));
                        RenderDayView(data);
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải lịch: {ex.Message}", "Lỗi API");
            }
        }

        #region Render Chế Độ Xem Tuần (Week View)

        private void RenderWeekView(LichLamViecViewDto data)
        {
            ClearScheduleGrid(WeekViewGrid);

            // Cập nhật header các cột ngày
            for (int i = 0; i < 7; i++)
            {
                _weekDayHeaders[i].Text = $"{_weekDayHeaders[i].Name.Substring(9)} ({data.NgayBatDauTuan.AddDays(i):dd/MM})";
            }

            // Vẽ Ca Làm
            foreach (var shift in data.LichLamViecTrongTuan)
            {
                int dayOfWeek = (int)shift.NgayLam.DayOfWeek;
                int gridColumn = (dayOfWeek == 0) ? 7 : dayOfWeek; // Col 7 = CN

                var (gridRow, rowSpan) = CalculateTimeSlot(shift.GioBatDau, shift.GioKetThuc);
                var shiftBorder = CreateEventBorder(
                    $"{shift.TenCa}\n{shift.GioBatDau:hh\\:mm} - {shift.GioKetThuc:hh\\:mm}",
                    "Shift");

                Grid.SetRow(shiftBorder, gridRow);
                Grid.SetColumn(shiftBorder, gridColumn);
                Grid.SetRowSpan(shiftBorder, rowSpan);
                WeekViewGrid.Children.Add(shiftBorder);
            }

            // Vẽ Đơn Nghỉ (Cả ngày)
            foreach (var leave in data.DonNghiTrongTuan)
            {
                for (DateTime day = leave.NgayBatDau.Date; day <= leave.NgayKetThuc.Date; day = day.AddDays(1))
                {
                    if (day >= data.NgayBatDauTuan && day <= data.NgayKetThucTuan)
                    {
                        int dayOfWeek = (int)day.DayOfWeek;
                        int gridColumn = (dayOfWeek == 0) ? 7 : dayOfWeek;

                        var leaveBorder = CreateAllDayEventBorder(leave.LoaiDon, "Leave");
                        Grid.SetRow(leaveBorder, 1); // Hàng "Cả ngày"
                        Grid.SetColumn(leaveBorder, gridColumn);
                        WeekViewGrid.Children.Add(leaveBorder);
                    }
                }
            }
        }

        #endregion

        #region Render Chế Độ Xem Ngày (Day View)

        private void RenderDayView(LichLamViecViewDto data)
        {
            ClearScheduleGrid(DayViewGrid);

            // Lọc sự kiện chỉ cho ngày hiện tại
            var shiftsToday = data.LichLamViecTrongTuan.Where(s => s.NgayLam.Date == _currentDate.Date).ToList();
            var leaveToday = data.DonNghiTrongTuan.Where(l => _currentDate.Date >= l.NgayBatDau.Date && _currentDate.Date <= l.NgayKetThuc.Date).ToList();

            // Cập nhật header
            lblHeaderDay.Text = _currentDate.ToString("dddd (dd/MM)", new CultureInfo("vi-VN"));

            // Vẽ Ca Làm
            foreach (var shift in shiftsToday)
            {
                var (gridRow, rowSpan) = CalculateTimeSlot(shift.GioBatDau, shift.GioKetThuc);
                var shiftBorder = CreateEventBorder(
                    $"{shift.TenCa}\n{shift.GioBatDau:hh\\:mm} - {shift.GioKetThuc:hh\\:mm}",
                    "Shift");

                Grid.SetRow(shiftBorder, gridRow);
                Grid.SetColumn(shiftBorder, 1); // Luôn là cột 1
                Grid.SetRowSpan(shiftBorder, rowSpan);
                DayViewGrid.Children.Add(shiftBorder);
            }

            // Vẽ Đơn Nghỉ (Cả ngày)
            foreach (var leave in leaveToday)
            {
                var leaveBorder = CreateAllDayEventBorder(leave.LoaiDon, "Leave");
                Grid.SetRow(leaveBorder, 1); // Hàng "Cả ngày"
                Grid.SetColumn(leaveBorder, 1);
                DayViewGrid.Children.Add(leaveBorder);
            }
        }

        #endregion

        #region Render Chế Độ Xem Tháng (Month View)

        private void RenderMonthView(List<LichLamViecNgayDto> events)
        {
            ClearScheduleGrid(MonthViewGrid);

            DateTime firstDayOfMonth = new DateTime(_currentDate.Year, _currentDate.Month, 1);
            int diff = (7 + (int)firstDayOfMonth.DayOfWeek - (int)DayOfWeek.Monday) % 7;
            DateTime startOfGrid = firstDayOfMonth.AddDays(-1 * diff);

            var eventLookup = events.ToDictionary(e => e.Ngay.Date, e => e.SuKien);

            for (int i = 0; i < 42; i++) // 6 tuần * 7 ngày
            {
                int row = i / 7 + 1; // +1 vì hàng 0 là header
                int col = i % 7;
                DateTime day = startOfGrid.AddDays(i);

                Border dayCell = new Border
                {
                    BorderThickness = new Thickness(0),
                    VerticalAlignment = VerticalAlignment.Stretch,
                    Background = (day.Month == _currentDate.Month) ? Brushes.White : (SolidColorBrush)FindResource("HeaderBackgroundBrush")
                };
                if (day == DateTime.Today)
                    dayCell.Background = (SolidColorBrush)FindResource("TodayBackgroundBrush");

                StackPanel dayPanel = new StackPanel { Orientation = Orientation.Vertical };

                TextBlock dayNumber = new TextBlock
                {
                    Text = day.Day.ToString(),
                    FontWeight = FontWeights.SemiBold,
                    Margin = new Thickness(5, 2, 0, 0),
                    Foreground = (day.Month == _currentDate.Month) ? Brushes.Black : (SolidColorBrush)FindResource("OtherMonthTextBrush")
                };

                dayPanel.Children.Add(dayNumber);

                if (eventLookup.TryGetValue(day, out var suKienTrongNgay))
                {
                    foreach (var tenSuKien in suKienTrongNgay.Take(3)) // Hiển thị tối đa 3 sự kiện
                    {
                        TextBlock eventText = new TextBlock
                        {
                            Text = tenSuKien,
                            FontSize = 9,
                            Background = tenSuKien.Contains("Nghỉ") ? (SolidColorBrush)FindResource("LeaveColor") : (SolidColorBrush)FindResource("ShiftColor1"),
                            Foreground = tenSuKien.Contains("Nghỉ") ? (SolidColorBrush)FindResource("LeaveBorderColor") : (SolidColorBrush)FindResource("ShiftBorderColor1"),
                            Margin = new Thickness(2, 1, 2, 0),
                            Padding = new Thickness(3, 1, 3, 1),
                            TextTrimming = TextTrimming.CharacterEllipsis
                        };
                        dayPanel.Children.Add(eventText);
                    }
                }

                dayCell.Child = dayPanel;
                Grid.SetRow(dayCell, row);
                Grid.SetColumn(dayCell, col);
                MonthViewGrid.Children.Add(dayCell);
            }
        }

        #endregion

        #region Hàm Helper (Chung)

        private void ClearScheduleGrid(Grid grid)
        {
            var elementsToRemove = grid.Children.OfType<UIElement>()
                .Where(e => Grid.GetRow(e) > 0 && Grid.GetColumn(e) >= 0)
                .ToList();

            if (grid == MonthViewGrid)
            {
                elementsToRemove = grid.Children.OfType<UIElement>()
                   .Where(e => Grid.GetRow(e) > 0)
                   .ToList();
            }

            foreach (var el in elementsToRemove)
            {
                grid.Children.Remove(el);
            }
        }

        private (int gridRow, int rowSpan) CalculateTimeSlot(TimeSpan startTime, TimeSpan endTime)
        {
            int gridRow = startTime.Hours - START_HOUR + 2; // +2 vì (Header + AllDay)
            double durationHours = (endTime - startTime).TotalHours;
            int rowSpan = (int)Math.Ceiling(durationHours);

            if (gridRow < 2) gridRow = 2;
            if (gridRow + rowSpan > TOTAL_GRID_ROWS) rowSpan = TOTAL_GRID_ROWS - gridRow;
            if (rowSpan < 1) rowSpan = 1;

            return (gridRow, rowSpan);
        }

        private Border CreateEventBorder(string text, string tag)
        {
            Border border = new Border
            {
                Background = (SolidColorBrush)FindResource("ShiftColor1"),
                BorderBrush = (SolidColorBrush)FindResource("ShiftBorderColor1"),
                BorderThickness = new Thickness(2, 2, 2, 2),
                CornerRadius = new CornerRadius(4),
                Margin = new Thickness(2, 2, 2, 2),
                Tag = tag
            };

            border.Child = new TextBlock
            {
                Text = text,
                TextWrapping = TextWrapping.Wrap,
                Margin = new Thickness(5),
                FontSize = 11,
                FontWeight = FontWeights.SemiBold
            };
            return border;
        }

        private Border CreateAllDayEventBorder(string text, string tag)
        {
            Border border = new Border
            {
                Background = (SolidColorBrush)FindResource("LeaveColor"),
                BorderBrush = (SolidColorBrush)FindResource("LeaveBorderColor"),
                BorderThickness = new Thickness(0, 0, 0, 2),
                Margin = new Thickness(1, 1, 1, 1),
                Tag = tag
            };

            border.Child = new TextBlock
            {
                Text = text,
                Padding = new Thickness(5, 2, 5, 2),
                FontSize = 10,
                FontWeight = FontWeights.SemiBold,
                Foreground = (SolidColorBrush)FindResource("LeaveBorderColor"),
                TextTrimming = TextTrimming.CharacterEllipsis
            };
            return border;
        }

        #endregion

        #region Điều Hướng (Navigation)

        private async void BtnPrev_Click(object sender, RoutedEventArgs e)
        {
            if (_currentView == ViewMode.Day) _currentDate = _currentDate.AddDays(-1);
            else if (_currentView == ViewMode.Week) _currentDate = _currentDate.AddDays(-7);
            else _currentDate = _currentDate.AddMonths(-1);
            await LoadScheduleAsync();
        }

        private async void BtnNext_Click(object sender, RoutedEventArgs e)
        {
            if (_currentView == ViewMode.Day) _currentDate = _currentDate.AddDays(1);
            else if (_currentView == ViewMode.Week) _currentDate = _currentDate.AddDays(7);
            else _currentDate = _currentDate.AddMonths(1);
            await LoadScheduleAsync();
        }

        private async void BtnToday_Click(object sender, RoutedEventArgs e)
        {
            _currentDate = DateTime.Today;
            await LoadScheduleAsync();
        }

        #endregion

        #region Chuyển Đổi Chế Độ Xem (View Switching)

        private void UpdateViewControls()
        {
            DayViewScroll.Visibility = (_currentView == ViewMode.Day) ? Visibility.Visible : Visibility.Collapsed;
            WeekViewScroll.Visibility = (_currentView == ViewMode.Week) ? Visibility.Visible : Visibility.Collapsed;
            MonthViewScroll.Visibility = (_currentView == ViewMode.Month) ? Visibility.Visible : Visibility.Collapsed;

            btnViewDay.Background = (_currentView == ViewMode.Day) ? _activeViewBrush : _inactiveViewBrush;
            btnViewWeek.Background = (_currentView == ViewMode.Week) ? _activeViewBrush : _inactiveViewBrush;
            btnViewMonth.Background = (_currentView == ViewMode.Month) ? _activeViewBrush : _inactiveViewBrush;
        }

        private async void BtnViewDay_Click(object sender, RoutedEventArgs e)
        {
            if (_currentView == ViewMode.Day) return;
            _currentView = ViewMode.Day;
            UpdateViewControls();
            await LoadScheduleAsync();
        }

        private async void BtnViewWeek_Click(object sender, RoutedEventArgs e)
        {
            if (_currentView == ViewMode.Week) return;
            _currentView = ViewMode.Week;
            UpdateViewControls();
            await LoadScheduleAsync();
        }

        private async void BtnViewMonth_Click(object sender, RoutedEventArgs e)
        {
            if (_currentView == ViewMode.Month) return;
            _currentView = ViewMode.Month;
            UpdateViewControls();
            await LoadScheduleAsync();
        }

        #endregion
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\PhieuLuongView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.nhanvien.pages.PhieuLuongView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      mc:Ignorable="d" 
      d:DesignHeight="720" d:DesignWidth="1150"
      Title="PhieuLuongView"
      FontFamily="Segoe UI" Background="#FFF8E1" Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="GreenBrush" Color="#388E3C"/>
        <SolidColorBrush x:Key="RedBrush" Color="#D32F2F"/>
        <SolidColorBrush x:Key="BlueBrush" Color="#1976D2"/>

        <Style TargetType="ListBoxItem" x:Key="PayslipItemStyle">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListBoxItem">
                        <Border x:Name="border" Padding="15" Margin="0,0,0,10"
                                BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="1"
                                Background="White" CornerRadius="8">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <TextBlock Grid.Row="0" Text="{Binding TieuDe}" FontWeight="Bold" FontSize="16"/>
                                <TextBlock Grid.Row="1" Text="{Binding ThucLanh, StringFormat=N0}" FontSize="20" Foreground="{StaticResource PrimaryBrownBrush}" FontWeight="Bold" Margin="0,5,0,0"/>
                                <TextBlock Grid.Row="2" x:Name="txtTrangThai" Text="{Binding TrangThai}" FontSize="12" Foreground="{StaticResource TextGrayBrush}" FontWeight="SemiBold" Margin="0,5,0,0"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="BorderThickness" Value="2"/>
                            </Trigger>
                            <DataTrigger Binding="{Binding TrangThai}" Value="Đã phát">
                                <Setter TargetName="txtTrangThai" Property="Foreground" Value="{StaticResource GreenBrush}"/>
                            </DataTrigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="350"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Background="White" BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="0,0,1,0" Padding="15">
            <StackPanel>
                <TextBlock Text="Phiếu lương của bạn" FontSize="22" FontWeight="Bold" Foreground="{StaticResource PrimaryBrownBrush}" Margin="0,0,0,15"/>
                <ListBox x:Name="lbPhieuLuong" 
                         Background="Transparent" BorderThickness="0"
                         ItemContainerStyle="{StaticResource PayslipItemStyle}"
                         SelectionChanged="LbPhieuLuong_SelectionChanged"/>
            </StackPanel>
        </Border>

        <Grid Grid.Column="1">
            <StackPanel x:Name="panelChonPhieu" VerticalAlignment="Center" HorizontalAlignment="Center">
                <TextBlock Text="Chọn một phiếu lương để xem chi tiết" FontSize="16" Foreground="{StaticResource TextGrayBrush}"/>
            </StackPanel>

            <ScrollViewer x:Name="panelChiTiet" Visibility="Collapsed" VerticalScrollBarVisibility="Auto">
                <StackPanel Margin="25">
                    <TextBlock x:Name="lblTieuDeChiTiet" Text="Chi tiết phiếu lương tháng 10/2025" FontSize="24" FontWeight="Bold" Foreground="{StaticResource PrimaryBrownBrush}"/>
                    <TextBlock x:Name="lblThucLanh" Text="0 đ" FontSize="48" FontWeight="ExtraBold" Foreground="{StaticResource PrimaryBrownBrush}" Margin="0,10,0,0"/>
                    <TextBlock x:Name="lblTrangThai" Text="Đã phát ngày 01/11/2025" FontSize="14" Foreground="{StaticResource GreenBrush}" FontWeight="SemiBold" Margin="0,0,0,20"/>

                    <Border Background="White" CornerRadius="8" Padding="20" BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="1">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Lương cơ bản (theo giờ):" FontWeight="SemiBold" Margin="0,0,20,10"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" x:Name="lblLuongCoBan" Text="30.000 đ" HorizontalAlignment="Right" Margin="0,0,0,10"/>

                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Tổng giờ làm:" FontWeight="SemiBold" Margin="0,0,20,10"/>
                            <TextBlock Grid.Row="1" Grid.Column="1" x:Name="lblTongGioLam" Text="160.00 giờ" HorizontalAlignment="Right" Margin="0,0,0,10"/>

                            <Separator Grid.Row="2" Grid.ColumnSpan="2" Margin="0,0,0,10"/>

                            <TextBlock Grid.Row="3" Grid.Column="0" Text="Thành tiền (Lương):" FontSize="16" FontWeight="Bold" VerticalAlignment="Center"/>
                            <TextBlock Grid.Row="3" Grid.Column="1" x:Name="lblTienLuongTheoGio" Text="4.800.000 đ" FontSize="16" FontWeight="Bold" HorizontalAlignment="Right" Foreground="{StaticResource BlueBrush}"/>
                        </Grid>
                    </Border>

                    <TextBlock Text="Các khoản thưởng" FontSize="18" FontWeight="Bold" Margin="0,20,0,10"/>
                    <DataGrid x:Name="dgThuong" AutoGenerateColumns="False" IsReadOnly="True" CanUserAddRows="False" HeadersVisibility="Column">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Ngày" Binding="{Binding NgayTao, StringFormat=dd/MM}" Width="80"/>
                            <DataGridTextColumn Header="Lý do" Binding="{Binding LyDo}" Width="*"/>
                            <DataGridTextColumn Header="Người tạo" Binding="{Binding TenNguoiTao}" Width="120"/>
                            <DataGridTextColumn Header="Số tiền" Binding="{Binding SoTien, StringFormat=N0}" Width="100"/>
                        </DataGrid.Columns>
                    </DataGrid>
                    <TextBlock x:Name="lblTongThuong" Text="Tổng thưởng: 0 đ" FontWeight="Bold" HorizontalAlignment="Right" Margin="0,5,0,0" Foreground="{StaticResource GreenBrush}"/>

                    <TextBlock Text="Các khoản khấu trừ" FontSize="18" FontWeight="Bold" Margin="0,20,0,10"/>
                    <DataGrid x:Name="dgKhauTru" AutoGenerateColumns="False" IsReadOnly="True" CanUserAddRows="False" HeadersVisibility="Column">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Ngày" Binding="{Binding NgayTao, StringFormat=dd/MM}" Width="80"/>
                            <DataGridTextColumn Header="Lý do" Binding="{Binding LyDo}" Width="*"/>
                            <DataGridTextColumn Header="Người tạo" Binding="{Binding TenNguoiTao}" Width="120"/>
                            <DataGridTextColumn Header="Số tiền" Binding="{Binding SoTien, StringFormat=N0}" Width="100"/>
                        </DataGrid.Columns>
                    </DataGrid>
                    <TextBlock x:Name="lblTongKhauTru" Text="Tổng khấu trừ: 0 đ" FontWeight="Bold" HorizontalAlignment="Right" Margin="0,5,0,0" Foreground="{StaticResource RedBrush}"/>

                    <Separator Margin="0,20,0,15"/>
                    <Grid>
                        <TextBlock Text="THỰC LÃNH" FontSize="20" FontWeight="Bold" VerticalAlignment="Center"/>
                        <TextBlock x:Name="lblThucLanhFinal" Text="0 đ" FontSize="22" FontWeight="Bold" HorizontalAlignment="Right" Foreground="{StaticResource PrimaryBrownBrush}"/>
                    </Grid>
                    <TextBlock Text="(Lương + Tổng thưởng + Tổng khấu trừ)" HorizontalAlignment="Right" Foreground="{StaticResource TextGrayBrush}" FontSize="11"/>

                </StackPanel>
            </ScrollViewer>
        </Grid>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\PhieuLuongView.xaml.cs
================================================================================
﻿// Tệp: AppCafebookApi/View/nhanvien/pages/PhieuLuongView.xaml.cs
using AppCafebookApi.Services;
using CafebookModel.Model.ModelApp.NhanVien;
using System;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media;

namespace AppCafebookApi.View.nhanvien.pages
{
    public partial class PhieuLuongView : Page
    {
        public PhieuLuongView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadDanhSachPhieuLuongAsync();
        }

        /// <summary>
        /// Tải danh sách các phiếu lương (cột bên trái)
        /// </summary>
        private async Task LoadDanhSachPhieuLuongAsync()
        {
            try
            {
                var response = await ApiClient.Instance.GetFromJsonAsync<PhieuLuongViewDto>("api/app/nhanvien/phieuluong/list");
                if (response != null && response.DanhSachPhieuLuong.Any())
                {
                    lbPhieuLuong.ItemsSource = response.DanhSachPhieuLuong;
                    lbPhieuLuong.SelectedIndex = 0; // Tự động chọn phiếu mới nhất
                }
                else
                {
                    panelChonPhieu.Visibility = Visibility.Visible;
                    panelChiTiet.Visibility = Visibility.Collapsed;
                    (panelChonPhieu.Children[0] as TextBlock).Text = "Không tìm thấy phiếu lương nào.";
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải danh sách phiếu lương: {ex.Message}", "Lỗi API");
            }
        }

        /// <summary>
        /// Tải chi tiết của phiếu lương được chọn (cột bên phải)
        /// </summary>
        private async Task LoadChiTietPhieuLuongAsync(int idPhieuLuong)
        {
            try
            {
                var data = await ApiClient.Instance.GetFromJsonAsync<PhieuLuongChiTietDto>($"api/app/nhanvien/phieuluong/detail/{idPhieuLuong}");
                if (data == null)
                {
                    MessageBox.Show("Không thể tải chi tiết phiếu lương.", "Lỗi");
                    return;
                }

                // Điền thông tin
                lblTieuDeChiTiet.Text = $"Chi tiết phiếu lương tháng {data.Thang}/{data.Nam}";
                lblThucLanh.Text = data.ThucLanh.ToString("N0") + " đ";

                // Xử lý trạng thái
                if (data.TrangThai == "Đã phát")
                {
                    lblTrangThai.Text = $"Đã phát ngày {data.NgayPhatLuong:dd/MM/yyyy} bởi {data.TenNguoiPhat ?? "Quản lý"}";
                    lblTrangThai.Foreground = (SolidColorBrush)FindResource("GreenBrush");
                }
                else // Đã chốt
                {
                    lblTrangThai.Text = "Đã chốt (Chưa phát lương)";
                    lblTrangThai.Foreground = (SolidColorBrush)FindResource("TextGrayBrush");
                }

                // Lương cơ bản
                lblLuongCoBan.Text = data.LuongCoBan.ToString("N0") + " đ / giờ";
                lblTongGioLam.Text = data.TongGioLam.ToString("N2") + " giờ";
                lblTienLuongTheoGio.Text = data.TienLuongTheoGio.ToString("N0") + " đ";

                // Thưởng
                dgThuong.ItemsSource = data.DanhSachThuong;
                lblTongThuong.Text = $"Tổng thưởng: {data.TongTienThuong:N0} đ";

                // Phạt
                dgKhauTru.ItemsSource = data.DanhSachPhat;
                lblTongKhauTru.Text = $"Tổng khấu trừ: {data.TongKhauTru:N0} đ"; // Hiển thị số âm

                // Tổng kết
                lblThucLanhFinal.Text = data.ThucLanh.ToString("N0") + " đ";

                // Hiển thị panel
                panelChonPhieu.Visibility = Visibility.Collapsed;
                panelChiTiet.Visibility = Visibility.Visible;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải chi tiết phiếu lương: {ex.Message}", "Lỗi API");
                panelChonPhieu.Visibility = Visibility.Visible;
                panelChiTiet.Visibility = Visibility.Collapsed;
            }
        }

        private async void LbPhieuLuong_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (lbPhieuLuong.SelectedItem is PhieuLuongItemDto selectedItem)
            {
                await LoadChiTietPhieuLuongAsync(selectedItem.IdPhieuLuong);
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\SoDoBanView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.nhanvien.pages.SoDoBanView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.nhanvien.pages"
      xmlns:sys="clr-namespace:System;assembly=mscorlib"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="SoDoBanView" FontFamily="Segoe UI" Loaded="Page_Loaded">

    <Page.Resources>
        <Geometry x:Key="IconSelectTable">M12,2C8.13,2 5,5.13 5,9C5,14.25 12,22 12,22C12,22 19,14.25 19,9C19,5.13 15.87,2 12,2M12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5Z</Geometry>
        <Geometry x:Key="IconRefresh">M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z</Geometry>
        <Geometry x:Key="IconMenu">M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z</Geometry>
        <FontFamily x:Key="FontAwesomeSolid">/Fonts/Font Awesome 6 Free-Solid-900.otf#Font Awesome 6 Free Solid</FontFamily>
        
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#EEEEEE"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="StatusGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="StatusRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="StatusYellowBrush" Color="#FFA726"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="StatusBlueBrush" Color="#42A5F5"/>
        <ExponentialEase x:Key="ExpoEaseOut" EasingMode="EaseOut"/>

        <Style x:Key="KhuVucToggleStyle" TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Padding" Value="20,14"/>
            <Setter Property="Margin" Value="15,0,15,5"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="border" 
                                Background="{TemplateBinding Background}" 
                                CornerRadius="8">
                            <ContentPresenter HorizontalAlignment="Left" VerticalAlignment="Center" Margin="{TemplateBinding Padding}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource SubtleGrayBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="TableCardStyle" TargetType="Button">
            <Setter Property="Width" Value="150"/>
            <Setter Property="Height" Value="130"/>
            <Setter Property="Margin" Value="15"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderThickness" Value="0,5,0,0"/>
            <Setter Property="BorderBrush" Value="{StaticResource StatusGreenBrush}"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="cardBorder" 
                                Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}" 
                                BorderThickness="{TemplateBinding BorderThickness}" 
                                CornerRadius="8"
                                RenderTransformOrigin="0.5,0.5">
                            <Border.RenderTransform>
                                <ScaleTransform ScaleX="1" ScaleY="1"/>
                            </Border.RenderTransform>
                            <Border.Effect>
                                <DropShadowEffect x:Name="shadow" ShadowDepth="1" Color="#000" Opacity="0.1" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" Margin="5"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <DataTrigger Binding="{Binding TrangThai}" Value="Có khách">
                    <Setter Property="BorderBrush" Value="{StaticResource StatusRedBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TrangThai}" Value="Đã đặt">
                    <Setter Property="BorderBrush" Value="{StaticResource StatusYellowBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TrangThai}" Value="Bảo trì">
                    <Setter Property="BorderBrush" Value="{StaticResource TextGrayBrush}"/>
                    <Setter Property="Opacity" Value="0.7"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="ActionButtonStyle" TargetType="Button">
            <Setter Property="Padding" Value="12,20"/>
            <Setter Property="Margin" Value="0,5"/>
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" 
                                CornerRadius="4" 
                                Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid x:Name="MainPanel" Background="{StaticResource LightCreamBrush}">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="220"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="320"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Background="{StaticResource WhiteTextBrush}">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel Margin="0,10">
                    <TextBlock Text="Lọc Khu Vực" FontWeight="Bold" FontSize="16" Foreground="{StaticResource DarkBrownBrush}" Margin="20,10,0,10"/>
                    <ToggleButton x:Name="btnKhuVucAll" Content="TẤT CẢ KHU VỰC" Style="{StaticResource KhuVucToggleStyle}" IsChecked="True" Click="BtnKhuVuc_Click"/>
                    <Separator Margin="15,5,15,10"/>
                    <ItemsControl x:Name="icKhuVuc">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <ToggleButton Content="{Binding TenKhuVuc}" Style="{StaticResource KhuVucToggleStyle}" Click="BtnKhuVuc_Click" DataContext="{Binding}"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </ScrollViewer>
        </Border>

        <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
            <StackPanel>
                <WrapPanel Margin="15,15,15,0">
                    <Button Style="{StaticResource TableCardStyle}" 
                            BorderBrush="{StaticResource AccentOrangeBrush}"
                            ToolTip="Tạo hóa đơn Tại Quầy / Mang Về"
                            Click="BtnDonMoi_Click">
                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                            <TextBlock Text="&#xf54e;" FontFamily="{StaticResource FontAwesomeSolid}" FontSize="28" Margin="0,0,0,8" HorizontalAlignment="Center" Foreground="{StaticResource AccentOrangeBrush}"/>
                            <TextBlock Text="Đơn Mới" FontSize="24" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" HorizontalAlignment="Center"/>
                            <TextBlock Text="Tại Quầy / Mang Về" FontSize="13" Foreground="{StaticResource TextGrayBrush}" HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </WrapPanel>

                <ItemsControl x:Name="icBan" Margin="15,0,15,15">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Button Style="{StaticResource TableCardStyle}" Click="BtnBan_Click">
                                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                                    <TextBlock FontSize="28" Margin="0,0,0,8" HorizontalAlignment="Center">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Text" Value="&#xf00c;"/>
                                                <Setter Property="FontFamily" Value="{StaticResource FontAwesomeSolid}"/>
                                                <Setter Property="Foreground" Value="{StaticResource StatusGreenBrush}"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding TrangThai}" Value="Có khách">
                                                        <Setter Property="Text" Value="&#xf0c0;"/>
                                                        <Setter Property="Foreground" Value="{StaticResource StatusRedBrush}"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding TrangThai}" Value="Đã đặt">
                                                        <Setter Property="Text" Value="&#xf017;"/>
                                                        <Setter Property="Foreground" Value="{StaticResource StatusYellowBrush}"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding TrangThai}" Value="Bảo trì">
                                                        <Setter Property="Text" Value="&#xf0ad;"/>
                                                        <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                    <TextBlock Text="{Binding SoBan}" FontSize="24" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" HorizontalAlignment="Center"/>
                                    <TextBlock Text="{Binding TrangThai}" FontSize="13" Foreground="{StaticResource TextGrayBrush}" HorizontalAlignment="Center"/>
                                    <TextBlock Text="{Binding ThongTinDatBan}" 
                                               FontSize="13" 
                                               Foreground="{StaticResource StatusYellowBrush}" 
                                               FontWeight="SemiBold" 
                                               HorizontalAlignment="Center">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Visibility" Value="Visible"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding TrangThai}" Value="Có khách">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding TrangThai}" Value="Đã đặt">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding TrangThai}" Value="Bảo trì">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                    <TextBlock Text="{Binding TongTienHienTai, StringFormat={}{0:N0} đ}" FontSize="13" Foreground="{StaticResource StatusRedBrush}" FontWeight="SemiBold" HorizontalAlignment="Center" Margin="0,4,0,0">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding TrangThai}" Value="Có khách">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </StackPanel>
                            </Button>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </ScrollViewer>

        <Border Grid.Column="2" Background="{StaticResource WhiteTextBrush}">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="2" Direction="270" Color="Black" Opacity="0.05" BlurRadius="20"/>
            </Border.Effect>

            <Grid x:Name="panelThaoTac" Margin="25">

                <StackPanel x:Name="panelChuaChon" VerticalAlignment="Center" HorizontalAlignment="Center" Opacity="0.5">
                    <Path Data="{StaticResource IconSelectTable}" Fill="{StaticResource BorderGrayBrush}" Width="60" Height="60" Stretch="Uniform"/>
                    <TextBlock Text="Chọn một bàn để bắt đầu thao tác" FontSize="16" Foreground="{StaticResource TextGrayBrush}" TextWrapping="Wrap" TextAlignment="Center" Margin="0,20,0,0"/>
                </StackPanel>

                <StackPanel x:Name="panelDaChon" Visibility="Collapsed">
                    <TextBlock Text="Thông Tin Bàn" FontSize="22" FontWeight="Bold" Margin="0,0,0,15" Foreground="{StaticResource DarkBrownBrush}"/>
                    <Separator Background="#EEEEEE"/>
                    <TextBlock FontSize="40" FontWeight="Bold" Margin="0,20,0,0" Foreground="{StaticResource PrimaryBrownBrush}">Bàn <Run x:Name="runSoBan"/></TextBlock>
                    <TextBlock FontSize="16" Margin="0,5,0,0" Foreground="{StaticResource TextGrayBrush}">Trạng thái: <Run x:Name="runTrangThai" FontWeight="SemiBold"/></TextBlock>
                    <TextBlock x:Name="tbThongTinDatBan" 
                               Foreground="{StaticResource StatusYellowBrush}" 
                               FontWeight="SemiBold" 
                               Margin="0,5,0,0" 
                               TextWrapping="Wrap" 
                               Visibility="Collapsed"/>
                    <TextBlock x:Name="tbGhiChu" FontStyle="Italic" Foreground="{StaticResource TextGrayBrush}" Margin="0,5,0,0" TextWrapping="Wrap" Visibility="Collapsed"/>
                    <TextBlock x:Name="tbTongTienWrapper" FontSize="16" Margin="0,10,0,0" Foreground="{StaticResource DarkBrownBrush}">Tổng tiền tạm tính: <Run x:Name="runTongTien" FontWeight="Bold" Foreground="{StaticResource StatusRedBrush}"/></TextBlock>
                    <StackPanel Margin="0,30,0,0">
                        <Button x:Name="btnGoiMon" Padding="20,18" FontSize="16" FontWeight="Bold" Background="{StaticResource PrimaryBrownBrush}" Foreground="White" Click="BtnGoiMon_Click" Cursor="Hand">
                            <Button.Resources>
                                <Style TargetType="Border">
                                    <Setter Property="CornerRadius" Value="4"/>
                                </Style>
                            </Button.Resources>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Viewbox Grid.Column="0" Width="18" Height="18" Margin="0,0,12,0" VerticalAlignment="Center">
                                    <Path Data="{StaticResource IconMenu}" Fill="White"/>
                                </Viewbox>
                                <TextBlock Grid.Column="1" Text="Gọi Món / Thanh Toán" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            </Grid>
                        </Button>
                        <Button x:Name="btnChuyenBan" Content="Chuyển Bàn" Style="{StaticResource ActionButtonStyle}" Click="BtnChuyenBan_Click" Background="#F5F5F5" BorderBrush="#E0E0E0" Foreground="{StaticResource DarkBrownBrush}"/>
                        <Button x:Name="btnGopBan" Content="Gộp Bàn" Style="{StaticResource ActionButtonStyle}" Click="BtnGopBan_Click" Background="#F5F5F5" BorderBrush="#E0E0E0" Foreground="{StaticResource DarkBrownBrush}"/>
                        <Button x:Name="btnBaoCaoSuCo" Content="Báo cáo Sự cố" Style="{StaticResource ActionButtonStyle}" Background="{StaticResource StatusYellowBrush}" BorderBrush="{StaticResource StatusYellowBrush}" Foreground="{StaticResource DarkBrownBrush}" Margin="0,20,0,0" Click="BtnBaoCaoSuCo_Click"/>
                    </StackPanel>
                    <Button x:Name="btnLamMoi" VerticalAlignment="Bottom" HorizontalAlignment="Stretch" Margin="0,50,0,0" Click="BtnLamMoi_Click" Style="{StaticResource ActionButtonStyle}" Background="Transparent" BorderBrush="#E0E0E0" Foreground="{StaticResource TextGrayBrush}" FontWeight="Normal">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="15" Height="15" Margin="0,0,10,0" VerticalAlignment="Center">
                                <Path Data="{StaticResource IconRefresh}" Fill="{StaticResource TextGrayBrush}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Làm mới Sơ đồ" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                </StackPanel>

                <StackPanel x:Name="panelChonBan" Visibility="Collapsed" VerticalAlignment="Center">
                    <TextBlock x:Name="selectionText" 
                               Text="Vui lòng chọn bàn..." 
                               Foreground="{StaticResource DarkBrownBrush}" 
                               FontSize="18" 
                               FontWeight="Bold"
                               TextWrapping="Wrap" TextAlignment="Center"/>
                    <TextBlock Text="Click vào bàn hợp lệ trên sơ đồ" 
                               Foreground="{StaticResource TextGrayBrush}" 
                               FontSize="14" 
                               TextAlignment="Center" Margin="0,5,0,0"/>

                    <Button Content="Hủy Thao Tác" 
                            x:Name="btnCancelSelect" 
                            Click="BtnCancelSelect_Click"
                            Style="{StaticResource ActionButtonStyle}"
                            Background="{StaticResource StatusRedBrush}"
                            BorderBrush="{StaticResource StatusRedBrush}"
                            Foreground="White"
                            Margin="0,20,0,0"/>

                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\SoDoBanView.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media;
using AppCafebookApi.Services;
using AppCafebookApi.View.common;
using System.Linq;
using System.Windows.Controls.Primitives;
using CafebookModel.Model.ModelApp.NhanVien;
using CafebookModel.Model.ModelApp;
using System.Text.Json;

namespace AppCafebookApi.View.nhanvien.pages
{
    public partial class SoDoBanView : Page
    {
        private int? _idBanToHighlight = null; // <-- THÊM DÒNG NÀY
        // THÊM LỚP HELPER NÀY VÀO BÊN TRONG CLASS SoDoBanView
        private class CreateOrderResponseDto
        {
            [System.Text.Json.Serialization.JsonPropertyName("idHoaDon")]
            public int idHoaDon { get; set; }
        }
        private enum SelectionMode { None, ChuyenBan, GopBan }

        private static readonly HttpClient httpClient;
        private BanSoDoDto? _selectedBan = null;
        private List<BanSoDoDto> _allTablesCache = new List<BanSoDoDto>();
        private List<KhuVucDto> _khuVucCache = new List<KhuVucDto>();
        private SelectionMode _currentMode = SelectionMode.None;

        static SoDoBanView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public SoDoBanView()
        {
            InitializeComponent();
            this.DataContext = this;
        }

        // THÊM HÀM KHỞI TẠO MỚI NÀY:
        public SoDoBanView(int idBan)
        {
            InitializeComponent();
            _idBanToHighlight = idBan; // Lưu ID bàn lại
        }

        #region Tải Dữ Liệu và Lọc Khu Vực

        // [SoDoBanView.xaml.cs]
        // THAY THẾ TOÀN BỘ HÀM PAGE_LOADED

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            MainPanel.Opacity = 0.5;
            // Tải lại toàn bộ dữ liệu khi trang được tải
            await ReloadDataAsync(); // [cite: 2, 66]
            MainPanel.Opacity = 1.0;

            // === SỬA LỖI LOGIC HIGHLIGHT ===
             if (_idBanToHighlight.HasValue) // 
            {
                var banToSelect = _allTablesCache.FirstOrDefault(b => b.IdBan == _idBanToHighlight.Value); // 
                if (banToSelect != null)
                {
                    // Kiểm tra xem bàn có trong filter hiện tại không
                    var currentItemsSource = icBan.ItemsSource as IEnumerable<BanSoDoDto>;
                    if (currentItemsSource == null || !currentItemsSource.Any(b => b.IdBan == banToSelect.IdBan))
                    {
                        // Nếu KHÔNG, BỎ QUA BỘ LỌC:
                        // 1. Reset về "Tất cả"
                        btnKhuVucAll.IsChecked = true;
                        UncheckOtherKhuVucButtons(btnKhuVucAll); // 
                                                                 // 2. Áp dụng filter "Tất cả" (null)
                        ApplyTableFilter(null); // 

                        // 3. Cập nhật UI ngay lập tức để tạo container
                        icBan.UpdateLayout();
                    }

                    // Tìm container (Button) của bàn
                    var banContainer = icBan.ItemContainerGenerator.ContainerFromItem(banToSelect) as FrameworkElement;
                    if (banContainer != null)
                    {
                        // YÊU CẦU MỚI: "Trỏ vào" (Cuộn đến)
                        banContainer.BringIntoView();
                    }

                    // Mở Bảng điều khiển cho bàn đó
                    ShowPanelForBan(banToSelect); // 
                }
                _idBanToHighlight = null; // [cite: 2, 80]
            }
            // === KẾT THÚC ===
        }

        // Đổi tên hàm Page_Loaded thành ReloadDataAsync
        private async Task ReloadDataAsync()
        {
            // Lưu lại khu vực đang chọn
            var selectedKhuVucBtn = FindCheckedKhuVucButton();
            int? selectedKhuVucId = null;
            if (selectedKhuVucBtn != null && selectedKhuVucBtn != btnKhuVucAll && selectedKhuVucBtn.DataContext is KhuVucDto dto)
            {
                selectedKhuVucId = dto.IdKhuVuc;
            }

            panelChuaChon.Visibility = Visibility.Visible;
            panelDaChon.Visibility = Visibility.Collapsed;

            // === XÓA DÒNG NÀY ===
            // _selectedBan = null; // <-- DÒNG NÀY GÂY LỖI
            // === KẾT THÚC ===

            // Tải lại cả hai danh sách
            await Task.WhenAll(LoadKhuVucSidebarAsync(), LoadTablesAsync());

            // Áp dụng lại bộ lọc
            ApplyTableFilter(selectedKhuVucId);

            // Chọn lại nút khu vực
            if (selectedKhuVucBtn != null)
                selectedKhuVucBtn.IsChecked = true;
            else if (btnKhuVucAll != null) // Thêm kiểm tra null
                btnKhuVucAll.IsChecked = true;
        }


        private async Task LoadKhuVucSidebarAsync()
        {
            try
            {
                _khuVucCache = (await httpClient.GetFromJsonAsync<List<KhuVucDto>>("api/app/banquanly/tree"))
                                 ?? new List<KhuVucDto>();
                icKhuVuc.ItemsSource = _khuVucCache;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Không thể tải danh sách Khu Vực: {ex.Message}", "Lỗi API");
            }
        }

        private async Task LoadTablesAsync()
        {
            try
            {
                _allTablesCache = (await httpClient.GetFromJsonAsync<List<BanSoDoDto>>("api/app/sodoban/tables"))
                                      ?? new List<BanSoDoDto>();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Không thể tải sơ đồ bàn: {ex.Message}", "Lỗi API");
            }
        }

        private void BtnKhuVuc_Click(object sender, RoutedEventArgs e)
        {
            var clickedButton = sender as ToggleButton;
            if (clickedButton == null) return;
            UncheckOtherKhuVucButtons(clickedButton);
            int? khuVucId = null;
            if (clickedButton != btnKhuVucAll && clickedButton.DataContext is KhuVucDto selectedKhuVuc)
            {
                khuVucId = selectedKhuVuc.IdKhuVuc;
            }
            ApplyTableFilter(khuVucId);
        }

        private void ApplyTableFilter(int? khuVucId)
        {
            if (khuVucId == null)
            {
                icBan.ItemsSource = _allTablesCache;
            }
            else
            {
                icBan.ItemsSource = _allTablesCache.Where(ban => ban.IdKhuVuc == khuVucId).ToList();
            }
        }

        private void UncheckOtherKhuVucButtons(ToggleButton? exception)
        {
            if (btnKhuVucAll != null && btnKhuVucAll != exception)
            {
                btnKhuVucAll.IsChecked = false;
            }
            foreach (var item in icKhuVuc.Items)
            {
                var container = icKhuVuc.ItemContainerGenerator.ContainerFromItem(item) as FrameworkElement;
                if (container == null) continue;
                var toggleButton = FindVisualChild<ToggleButton>(container);
                if (toggleButton != null && toggleButton != exception)
                {
                    toggleButton.IsChecked = false;
                }
            }
        }

        private T? FindVisualChild<T>(DependencyObject? obj) where T : DependencyObject
        {
            if (obj == null) return null;
            for (int i = 0; i < VisualTreeHelper.GetChildrenCount(obj); i++)
            {
                DependencyObject child = VisualTreeHelper.GetChild(obj, i);
                if (child != null)
                {
                    if (child is T)
                        return (T)child;
                    else
                    {
                        T? childOfChild = FindVisualChild<T>(child);
                        if (childOfChild != null)
                            return childOfChild;
                    }
                }
            }
            return null;
        }

        private ToggleButton? FindCheckedKhuVucButton()
        {
            if (btnKhuVucAll != null && btnKhuVucAll.IsChecked == true) return btnKhuVucAll;
            foreach (var item in icKhuVuc.Items)
            {
                var container = icKhuVuc.ItemContainerGenerator.ContainerFromItem(item) as FrameworkElement;
                if (container == null) continue;
                var toggleButton = FindVisualChild<ToggleButton>(container);
                if (toggleButton != null && toggleButton.IsChecked == true)
                {
                    return toggleButton;
                }
            }
            return btnKhuVucAll; // Mặc định
        }

        #endregion

        // === LOGIC XỬ LÝ CHÍNH ===

        private void BtnDonMoi_Click(object sender, RoutedEventArgs e)
        {
            var virtualBan = new BanSoDoDto
            {
                IdBan = -1, // Dấu hiệu "Tại Quầy"
                SoBan = "Tại Quầy",
                TrangThai = "Trống",
                IdKhuVuc = null,
                IdHoaDonHienTai = null,
                TongTienHienTai = 0
            };
            UncheckOtherKhuVucButtons(null);
            _selectedBan = null;
            ShowPanelForBan(virtualBan);
        }

        private async void BtnBan_Click(object sender, RoutedEventArgs e)
        {
            var button = sender as Button;
            var clickedBan = button?.DataContext as BanSoDoDto;
            if (clickedBan == null) return;

            if (_currentMode != SelectionMode.None)
            {
                await HandleTableSelectionAsync(clickedBan);
            }
            else
            {
                UncheckOtherKhuVucButtons(null);
                ShowPanelForBan(clickedBan);
            }
        }

        private void ShowPanelForBan(BanSoDoDto ban)
        {
            _selectedBan = ban;

            panelChuaChon.Visibility = Visibility.Collapsed;
            panelChonBan.Visibility = Visibility.Collapsed;
            panelDaChon.Visibility = Visibility.Visible;

            runSoBan.Text = _selectedBan.SoBan;
            runTrangThai.Text = _selectedBan.TrangThai;

            // === LOGIC MỚI (YÊU CẦU 1) ===
            // Hiển thị thông tin đặt bàn trên panel nếu bàn "Trống"
            if (!string.IsNullOrEmpty(_selectedBan.ThongTinDatBan) && _selectedBan.TrangThai == "Trống")
            {
                tbThongTinDatBan.Text = _selectedBan.ThongTinDatBan;
                tbThongTinDatBan.Visibility = Visibility.Visible;
            }
            else
            {
                tbThongTinDatBan.Visibility = Visibility.Collapsed;
            }
            // === KẾT THÚC ===

            if (!string.IsNullOrEmpty(_selectedBan.GhiChu))
            {
                tbGhiChu.Text = $"Ghi chú: {_selectedBan.GhiChu}";
                tbGhiChu.Visibility = Visibility.Visible;
            }
            else
            {
                tbGhiChu.Visibility = Visibility.Collapsed;
            }

            switch (_selectedBan.TrangThai)
            {
                case "Trống":
                    btnGoiMon.Content = "Tạo Hóa Đơn Mới";
                    btnGoiMon.IsEnabled = true;
                    btnChuyenBan.IsEnabled = false;
                    btnGopBan.IsEnabled = false;
                    btnBaoCaoSuCo.IsEnabled = (_selectedBan.IdBan > 0);
                    tbTongTienWrapper.Visibility = Visibility.Collapsed;
                    break;
                case "Có khách":
                    btnGoiMon.Content = "Gọi Món / Thanh Toán";
                    btnGoiMon.IsEnabled = true;
                    btnChuyenBan.IsEnabled = true;
                    btnGopBan.IsEnabled = true;
                    btnBaoCaoSuCo.IsEnabled = false;
                    tbTongTienWrapper.Visibility = Visibility.Visible;
                    runTongTien.Text = _selectedBan.TongTienHienTai.ToString("N0") + " đ";
                    break;
                case "Đã đặt":
                    btnGoiMon.Content = "Khách đặt (Mở Hóa Đơn)";
                    btnGoiMon.IsEnabled = true;
                    btnChuyenBan.IsEnabled = false;
                    btnGopBan.IsEnabled = false;
                    btnBaoCaoSuCo.IsEnabled = true;
                    tbTongTienWrapper.Visibility = Visibility.Collapsed;
                    break;
                case "Bảo trì":
                case "Tạm ngưng":
                    btnGoiMon.Content = "BÀN ĐANG BẢO TRÌ";
                    btnGoiMon.IsEnabled = false;
                    btnChuyenBan.IsEnabled = false;
                    btnGopBan.IsEnabled = false;
                    btnBaoCaoSuCo.IsEnabled = false;
                    tbTongTienWrapper.Visibility = Visibility.Collapsed;
                    break;
            }
        }

        // === HÀM BỊ LỖI ===
        private async void BtnGoiMon_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedBan == null) return;

            if (_selectedBan.TrangThai == "Có khách")
            {
                int? idHoaDon = _selectedBan.IdHoaDonHienTai;
                if (idHoaDon.HasValue)
                {
                    this.NavigationService?.Navigate(new GoiMonView(idHoaDon.Value));
                }
                return;
            }

            // === SỬA LỖI NULL REFERENCE ===
            // Di chuyển kiểm tra Auth lên đầu
            if (AuthService.CurrentUser == null)
            {
                MessageBox.Show("Lỗi: Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.", "Lỗi Phiên");
                return;
            }

            // Gán idNhanVien SAU KHI đã kiểm tra
            int idNhanVien = AuthService.CurrentUser.IdNhanVien;
            // === KẾT THÚC SỬA LỖI ===

            int? idHoaDonMoi = null;

            try
            {
                HttpResponseMessage response;
                if (_selectedBan.IdBan > 0)
                {
                    response = await httpClient.PostAsJsonAsync($"api/app/sodoban/createorder/{_selectedBan.IdBan}/{idNhanVien}", new { });
                }
                else
                {
                    // Sửa "Tại quầy" thành "Tại quán" (Sửa lỗi CHECK constraint)
                    string loaiHoaDon = (_selectedBan.IdBan == -1) ? "Tại quán" : "Mang về";
                    response = await httpClient.PostAsJsonAsync($"api/app/sodoban/createorder-no-table/{idNhanVien}", loaiHoaDon);
                }

                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<CreateOrderResponseDto>();
                    if (result != null && result.idHoaDon > 0)
                    {
                        idHoaDonMoi = result.idHoaDon;
                    }
                    if (_selectedBan.IdBan > 0)
                    {
                        // Sửa: Gọi hàm ReloadDataAsync() mới
                        await ReloadDataAsync();
                    }
                }
                else
                {
                    MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lỗi tạo hóa đơn");
                    return;
                }
            }
            catch (Exception ex) { MessageBox.Show($"Lỗi API: {ex.Message}", "Lỗi"); return; }

            if (idHoaDonMoi.HasValue)
            {
                this.NavigationService?.Navigate(new GoiMonView(idHoaDonMoi.Value));

                if (_selectedBan.IdBan <= 0)
                {
                    ResetForm();
                }
            }
        }

        private async void BtnLamMoi_Click(object sender, RoutedEventArgs e)
        {
            MainPanel.Opacity = 0.5;
            await ReloadDataAsync();
            MainPanel.Opacity = 1.0;
        }


        private async void BtnBaoCaoSuCo_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedBan == null) return;
            // Thêm kiểm tra Auth
            if (AuthService.CurrentUser == null)
            {
                MessageBox.Show("Lỗi: Phiên đăng nhập đã hết hạn.", "Lỗi Phiên");
                return;
            }
            int idNhanVien = AuthService.CurrentUser.IdNhanVien;
            var inputDialog = new InputDialogWindow("Báo cáo sự cố", $"Vui lòng mô tả sự cố cho bàn {_selectedBan.SoBan}:");
            if (inputDialog.ShowDialog() == true)
            {
                string ghiChu = inputDialog.InputText;
                if (string.IsNullOrWhiteSpace(ghiChu)) return;
                try
                {
                    var request = new BaoCaoSuCoRequestDto { GhiChuSuCo = ghiChu };
                    var response = await httpClient.PostAsJsonAsync($"api/app/sodoban/reportproblem/{_selectedBan.IdBan}/{idNhanVien}", request);
                    if (response.IsSuccessStatusCode)
                    {
                        await ReloadDataAsync();
                    }
                    else
                    {
                        MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lỗi báo cáo");
                    }
                }
                catch (Exception ex) { MessageBox.Show($"Lỗi API: {ex.Message}", "Lỗi"); }
            }
        }

        private void StartSelectionMode(SelectionMode mode, string instructionText)
        {
            _currentMode = mode;
            selectionText.Text = instructionText;

            panelChuaChon.Visibility = Visibility.Collapsed;
            panelDaChon.Visibility = Visibility.Collapsed;
            panelChonBan.Visibility = Visibility.Visible;
        }

        private void BtnCancelSelect_Click(object sender, RoutedEventArgs e)
        {
            ResetForm();
        }

        private void BtnChuyenBan_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedBan == null) return;
            StartSelectionMode(SelectionMode.ChuyenBan,
                $"Đang Chuyển [Bàn {_selectedBan.SoBan}]\n" +
                $"Vui lòng chọn một [Bàn Trống] làm Bàn Đích.");
        }

        private void BtnGopBan_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedBan == null) return;
            StartSelectionMode(SelectionMode.GopBan,
                $"Đang Gộp [Bàn {_selectedBan.SoBan}]\n" +
                $"Vui lòng chọn một [Bàn Có Khách] khác làm Bàn Đích.");
        }

        private async Task HandleTableSelectionAsync(BanSoDoDto targetBan)
        {
            if (_selectedBan == null)
            {
                ResetForm();
                return;
            }
            int? idHoaDonNguon = _selectedBan.IdHoaDonHienTai;
            if (!idHoaDonNguon.HasValue)
            {
                MessageBox.Show("Bàn nguồn không có hóa đơn để thao tác.", "Lỗi", MessageBoxButton.OK, MessageBoxImage.Error);
                ResetForm();
                return;
            }

            try
            {
                HttpResponseMessage response;
                BanActionRequestDto request = new BanActionRequestDto
                {
                    IdHoaDonNguon = idHoaDonNguon.Value
                };

                if (_currentMode == SelectionMode.ChuyenBan)
                {
                    if (targetBan.TrangThai != "Trống")
                    {
                        MessageBox.Show($"Bàn đích [{targetBan.SoBan}] phải là [Bàn Trống].", "Chọn sai bàn", MessageBoxButton.OK, MessageBoxImage.Warning);
                        return;
                    }
                    request.IdBanDich = targetBan.IdBan;
                    response = await httpClient.PostAsJsonAsync("api/app/sodoban/move-table", request);
                }
                else // (mode == SelectionMode.GopBan)
                {
                    if (targetBan.TrangThai != "Có khách")
                    {
                        MessageBox.Show($"Bàn đích [{targetBan.SoBan}] phải là [Bàn Có Khách].", "Chọn sai bàn", MessageBoxButton.OK, MessageBoxImage.Warning);
                        return;
                    }
                    if (targetBan.IdBan == _selectedBan.IdBan)
                    {
                        MessageBox.Show("Không thể gộp bàn vào chính nó.", "Chọn sai bàn", MessageBoxButton.OK, MessageBoxImage.Warning);
                        return;
                    }
                    request.IdHoaDonDich = targetBan.IdHoaDonHienTai;
                    response = await httpClient.PostAsJsonAsync("api/app/sodoban/merge-table", request);
                }

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show(
                        _currentMode == SelectionMode.ChuyenBan ? "Chuyển bàn thành công!" : "Gộp bàn thành công!",
                        "Thành công", MessageBoxButton.OK, MessageBoxImage.Information);

                    await ReloadDataAsync();
                }
                else
                {
                    string error = await response.Content.ReadAsStringAsync();
                    MessageBox.Show($"Thao tác thất bại: {error}", "Lỗi API", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi hệ thống: {ex.Message}", "Lỗi", MessageBoxButton.OK, MessageBoxImage.Error);
            }
            finally
            {
                ResetForm();
            }
        }

        private void ResetForm()
        {
            _selectedBan = null;

            panelDaChon.Visibility = Visibility.Collapsed;
            panelChonBan.Visibility = Visibility.Collapsed;
            panelChuaChon.Visibility = Visibility.Visible;

            _currentMode = SelectionMode.None;

            if (btnKhuVucAll != null) // Thêm kiểm tra null an toàn
            {
                btnKhuVucAll.IsChecked = true;
                UncheckOtherKhuVucButtons(btnKhuVucAll);
            }
            ApplyTableFilter(null);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\ThanhToanView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.nhanvien.pages.ThanhToanView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.nhanvien.pages"
      mc:Ignorable="d" 
      d:DesignHeight="720" d:DesignWidth="1150"
      Title="ThanhToanView" FontFamily="Segoe UI" Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="StatusRedBrush" Color="#EF5350"/>
        <Geometry x:Key="IconArrowRight">M10,6L8.59,7.41L13.17,12L8.59,16.59L10,18L16,12Z</Geometry>
        <Geometry x:Key="IconArrowRightAll">M5.59,7.41L10.18,12L5.59,16.59L7,18L13,12L7,6L5.59,7.41M16,6H18V18H16V6Z</Geometry>
        <Geometry x:Key="IconArrowLeft">M15.41,16.59L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.59Z</Geometry>
        <Geometry x:Key="IconArrowLeftAll">M18.41,16.59L13.82,12L18.41,7.41L17,6L11,12L17,18L18.41,16.59M6,6H8V18H6V6Z</Geometry>
        <Geometry x:Key="IconPrint">M19,8H5C3.34,8 2,9.34 2,11V17H6V21H18V17H22V11C22,9.34 20.66,8 19,8M16,19H8V14H16V19M19,12C18.45,12 18,11.55 18,11C18,10.45 18.45,10 19,10C19.55,10 20,10.45 20,11C20,11.55 19.55,12 19,12M18,3H6V7H18V3Z</Geometry>
        <Geometry x:Key="IconCheck">M9,20.42L2.79,14.21L4.21,12.79L9,17.58L19.79,6.79L21.21,8.21L9,20.42Z</Geometry>

        <Geometry x:Key="IconSearch">M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z</Geometry>

        <Style x:Key="TransferButton" TargetType="Button">
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="Margin" Value="0,5"/>
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" CornerRadius="20">
                            <Path Data="{TemplateBinding Content}" Fill="{StaticResource DarkBrownBrush}" Width="20" Height="20" Stretch="Uniform"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#F5F5F5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="InvoiceExpander" TargetType="Expander">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Expander">
                        <Border BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" Background="{TemplateBinding Background}" CornerRadius="8">
                            <DockPanel>
                                <ToggleButton x:Name="HeaderSite" DockPanel.Dock="Top" IsChecked="{Binding IsExpanded, RelativeSource={RelativeSource TemplatedParent}}" Style="{DynamicResource ExpanderHeaderToggleButton}"/>
                                <ContentPresenter x:Name="ExpandSite" DockPanel.Dock="Bottom" Visibility="Collapsed"/>
                            </DockPanel>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsExpanded" Value="True">
                                <Setter TargetName="ExpandSite" Property="Visibility" Value="Visible"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="ExpanderHeaderToggleButton" TargetType="ToggleButton">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border Padding="12">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <ContentPresenter Grid.Column="0" Content="{Binding Header, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type Expander}}}" TextBlock.FontWeight="SemiBold" TextBlock.FontSize="15"/>
                                <Path x:Name="arrow" Grid.Column="1" Data="M7,10L12,15L17,10H7Z" Fill="{StaticResource TextGrayBrush}" VerticalAlignment="Center"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="arrow" Property="Data" Value="M7,15L12,10L17,15H7Z"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="380"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Padding="20">
            <StackPanel>
                <TextBlock x:Name="lblTieuDeThanhToan" Text="Thanh toán cho Bàn..." FontSize="22" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,20"/>

                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0">
                        <Expander Header="Hóa đơn gốc (Món ăn)" Style="{StaticResource InvoiceExpander}" IsExpanded="True">
                            <DataGrid x:Name="dgGoc" AutoGenerateColumns="False" IsReadOnly="True" SelectionMode="Extended" CanUserAddRows="False" Background="Transparent" BorderThickness="0,1,0,0">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Tên món" Binding="{Binding TenSanPham}" Width="*" FontWeight="SemiBold"/>
                                    <DataGridTextColumn Header="SL" Binding="{Binding SoLuong}" Width="40"/>
                                    <DataGridTextColumn Header="Thành tiền" Binding="{Binding ThanhTien, StringFormat=N0}" Width="80"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Expander>

                        <Expander Header="Phụ thu khả dụng (Tách cùng món)" Style="{StaticResource InvoiceExpander}" IsExpanded="True">
                            <ListBox x:Name="lbPhuThuKhaDung" SelectionMode="Multiple" Background="Transparent" 
                                     BorderThickness="0,1,0,0" BorderBrush="{StaticResource BorderGrayBrush}"
                                     HorizontalContentAlignment="Stretch">
                                <ListBox.ItemContainerStyle>
                                    <Style TargetType="ListBoxItem">
                                        <Setter Property="Padding" Value="0"/>
                                    </Style>
                                </ListBox.ItemContainerStyle>

                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Background="Transparent">
                                            <CheckBox Content="{Binding TenPhuThu}" Tag="{Binding IdPhuThu}" Margin="5"
                                                      VerticalAlignment="Center"
                                                      IsHitTestVisible="False" IsChecked="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=ListBoxItem}}"/>
                                        </Grid>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Expander>
                    </StackPanel>

                    <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="15,0">
                        <Button x:Name="btnChuyenQua" Content="{StaticResource IconArrowRight}" ToolTip="Tách món/phụ thu đã chọn" Style="{StaticResource TransferButton}" Click="BtnChuyenQua_Click"/>
                        <Button x:Name="btnChuyenQuaTatCa" Content="{StaticResource IconArrowRightAll}" ToolTip="Tách tất cả món &amp; phụ thu đã chọn" Style="{StaticResource TransferButton}" Click="BtnChuyenQuaTatCa_Click"/>
                        <Button x:Name="btnChuyenLai" Content="{StaticResource IconArrowLeft}" ToolTip="Trả lại món đã chọn" Style="{StaticResource TransferButton}" Click="BtnChuyenLai_Click"/>
                        <Button x:Name="btnChuyenLaiTatCa" Content="{StaticResource IconArrowLeftAll}" ToolTip="Trả lại tất cả" Style="{StaticResource TransferButton}" Click="BtnChuyenLaiTatCa_Click"/>
                    </StackPanel>

                    <StackPanel Grid.Column="2">
                        <Expander Header="Hóa đơn thanh toán (Món ăn)" Style="{StaticResource InvoiceExpander}" IsExpanded="True">
                            <DataGrid x:Name="dgTach" AutoGenerateColumns="False" IsReadOnly="True" SelectionMode="Extended" CanUserAddRows="False" Background="Transparent" BorderThickness="0,1,0,0">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Tên món" Binding="{Binding TenSanPham}" Width="*" FontWeight="SemiBold"/>
                                    <DataGridTextColumn Header="SL" Binding="{Binding SoLuong}" Width="40"/>
                                    <DataGridTextColumn Header="Thành tiền" Binding="{Binding ThanhTien, StringFormat=N0}" Width="80"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Expander>

                        <Expander Header="Phụ thu (Áp dụng)" Style="{StaticResource InvoiceExpander}" IsExpanded="True">
                            <DataGrid x:Name="dgPhuThuTach" AutoGenerateColumns="False" IsReadOnly="True" SelectionMode="Extended" CanUserAddRows="False" Background="Transparent" BorderThickness="0,1,0,0">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Tên Phụ Thu" Binding="{Binding TenPhuThu}" Width="*" FontWeight="SemiBold"/>
                                    <DataGridTextColumn Header="Số Tiền" Binding="{Binding SoTien, StringFormat=N0}" Width="80"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Expander>
                    </StackPanel>
                </Grid>
            </StackPanel>
        </Border>

        <Border Grid.Column="1" Background="{StaticResource PrimaryBrownBrush}" Padding="25">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto" Margin="0,0,0,10">
                    <StackPanel>
                        <TextBlock Text="Cần thanh toán:" FontSize="18" Foreground="{StaticResource WhiteTextBrush}" Opacity="0.8"/>
                        <TextBlock x:Name="lblTienCanThanhToan" Text="0 đ" FontSize="42" FontWeight="Bold" Foreground="{StaticResource WhiteTextBrush}" Margin="0,0,0,15"/>

                        <TextBlock Text="Tìm khách hàng (SĐT/Email/Tên):" Foreground="{StaticResource WhiteTextBrush}" Opacity="0.8"/>
                        <TextBox x:Name="txtTimKhachHang" 
                                 Margin="0,5,0,5" Padding="8" FontSize="14"
                                 TextChanged="TxtTimKhachHang_TextChanged"/>

                        <ListBox x:Name="lbKhachHangResults" MaxHeight="100" 
                                 Visibility="Collapsed" Margin="0,0,0,5"
                                 SelectionChanged="LbKhachHangResults_SelectionChanged">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Margin="5">
                                        <TextBlock Text="{Binding HoTen}" FontWeight="SemiBold"/>
                                        <TextBlock Text="{Binding SoDienThoai}" Foreground="Gray" FontSize="11"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                        <Border x:Name="borderKhachHang" 
                                Background="#1AFFFFFF" 
                                CornerRadius="8" 
                                Padding="10" 
                                Margin="0,5,0,10" 
                                Visibility="Collapsed">
                            <Grid>
                                <!-- Thông tin khách hàng -->
                                <StackPanel>
                                    <TextBlock x:Name="lblTenKhachHang" 
                                               Text="Khách vãng lai" 
                                               FontWeight="Bold" 
                                               Foreground="White"/>
                                    <TextBlock x:Name="lblDiemHienCo" 
                                               Text="0 điểm" 
                                               Foreground="White" 
                                               Opacity="0.8"/>
                                </StackPanel>

                                <!-- Nút X hủy chọn khách -->
                                <Button x:Name="btnHuyKhachHang" 
                                        Content="X" 
                                        HorizontalAlignment="Right" 
                                        VerticalAlignment="Top" 
                                        Width="20" 
                                        Height="20" 
                                        FontSize="10" 
                                        FontWeight="Bold"
                                        Style="{StaticResource {x:Static ToolBar.ButtonStyleKey}}"
                                        Background="#33FFFFFF" 
                                        Foreground="White"
                                        ToolTip="Bỏ chọn khách hàng (Khách vãng lai)"
                                        Click="BtnHuyKhachHang_Click"
                                        Visibility="Collapsed"/>
                            </Grid>
                        </Border>

                        <TextBlock Text="Áp dụng khuyến mãi:" Foreground="{StaticResource WhiteTextBrush}" Opacity="0.8"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Button Grid.Column="0" x:Name="btnChonKhuyenMai" Content="-- Chọn Khuyến mãi --" Margin="0,5,5,10" Padding="8" FontSize="14" Click="BtnChonKhuyenMai_Click"/>
                            <Button Grid.Column="1" x:Name="btnHuyKhuyenMai" Content="X" ToolTip="Gỡ bỏ" Margin="0,5,0,10" 
                                    Width="30" Background="{StaticResource StatusRedBrush}" Foreground="White" Click="BtnHuyKhuyenMai_Click" Visibility="Collapsed"/>
                        </Grid>

                        <TextBlock Text="Sử dụng điểm tích lũy:" Foreground="{StaticResource WhiteTextBrush}" Opacity="0.8"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox x:Name="txtDiemSuDung" Grid.Column="0" Margin="0,5,5,15" Padding="8" FontSize="14" TextChanged="TxtDiemSuDung_TextChanged" IsEnabled="False"/>
                            <Button x:Name="btnApDungDiem" Grid.Column="1" Content="Dùng" Margin="0,5,0,15" Width="50" Click="BtnApDungDiem_Click" IsEnabled="False"/>
                        </Grid>

                        <Grid Margin="0,0,0,5">
                            <TextBlock Text="Giảm giá (KM):" FontSize="15" VerticalAlignment="Center" Foreground="{StaticResource WhiteTextBrush}" Opacity="0.8"/>
                            <TextBlock x:Name="lblTienGiamKM" Text="- 0 đ" FontSize="15" Foreground="#A5D6A7" FontWeight="SemiBold" HorizontalAlignment="Right"/>
                        </Grid>
                        <Grid Margin="0,0,0,15">
                            <TextBlock Text="Giảm giá (Điểm):" FontSize="15" VerticalAlignment="Center" Foreground="{StaticResource WhiteTextBrush}" Opacity="0.8"/>
                            <TextBlock x:Name="lblTienGiamDiem" Text="- 0 đ" FontSize="15" Foreground="#A5D6A7" FontWeight="SemiBold" HorizontalAlignment="Right"/>
                        </Grid>

                        <Separator Background="#FFFFFF" Opacity="0.2"/>
                        <Grid Margin="0,10,0,10">
                            <TextBlock Text="Thành tiền:" FontSize="18" FontWeight="Bold" VerticalAlignment="Center" Foreground="{StaticResource WhiteTextBrush}"/>
                            <TextBlock x:Name="lblThanhTien" Text="0 đ" FontSize="20" FontWeight="Bold" Foreground="{StaticResource WhiteTextBrush}" HorizontalAlignment="Right"/>
                        </Grid>
                    </StackPanel>
                </ScrollViewer>

                <Border Grid.Row="1" Background="{StaticResource WhiteTextBrush}" CornerRadius="8" Padding="15" VerticalAlignment="Top" Margin="0,0,0,10">
                    <StackPanel>
                        <TextBlock Text="PHƯƠNG THỨC THANH TOÁN" FontSize="12" FontWeight="Bold" Foreground="{StaticResource TextGrayBrush}" Margin="0,0,0,10"/>
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <RadioButton x:Name="rbTienMat" Grid.Row="0" Grid.Column="0" Content="Tiền mặt" IsChecked="True" GroupName="PaymentMethod" Checked="PaymentMethod_Changed" Margin="0,0,0,5"/>
                            <RadioButton x:Name="rbChuyenKhoan" Grid.Row="0" Grid.Column="1" Content="Chuyển khoản" GroupName="PaymentMethod" Checked="PaymentMethod_Changed" Margin="0,0,0,5"/>
                            <RadioButton x:Name="rbThe" Grid.Row="1" Grid.Column="0" Content="Thẻ" GroupName="PaymentMethod" Checked="PaymentMethod_Changed"/>
                            <RadioButton x:Name="rbViDienTu" Grid.Row="1" Grid.Column="1" Content="Ví điện tử" GroupName="PaymentMethod" Checked="PaymentMethod_Changed"/>
                        </Grid>

                        <StackPanel x:Name="panelTienMat" Margin="0,15,0,0">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <Label Grid.Row="0" Grid.Column="0" Content="Khách đưa:" FontSize="15" VerticalAlignment="Center" Margin="0,0,10,10"/>
                                <TextBox Grid.Row="0" Grid.Column="1" x:Name="txtKhachDua" FontSize="18" FontWeight="SemiBold" TextChanged="TxtKhachDua_TextChanged" TextAlignment="Right" Padding="5"/>
                                <Label Grid.Row="1" Grid.Column="0" Content="Tiền thừa:" FontSize="15" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                <TextBlock Grid.Row="1" Grid.Column="1" x:Name="lblTienThua" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource ActionBlueBrush}" VerticalAlignment="Center" Text="0 đ" HorizontalAlignment="Right"/>
                            </Grid>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <StackPanel Grid.Row="2" VerticalAlignment="Bottom">
                    <Button x:Name="btnInTamTinh" Padding="12" Margin="0,10,0,0" Background="{StaticResource WhiteTextBrush}" Foreground="{StaticResource DarkBrownBrush}" Click="BtnInTamTinh_Click">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,10,0" VerticalAlignment="Center">
                                <Path Data="{StaticResource IconPrint}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="In Tạm tính" VerticalAlignment="Center" FontWeight="SemiBold" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>

                    <Button x:Name="btnXacNhanThanhToan" Padding="15" Margin="0,10,0,0" FontSize="16" FontWeight="Bold" Background="{StaticResource ActionGreenBrush}" Foreground="{StaticResource WhiteTextBrush}" Click="BtnXacNhanThanhToan_Click">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,10,0" VerticalAlignment="Center">
                                <Path Data="{StaticResource IconCheck}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="XÁC NHẬN THANH TOÁN" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>

                    <Button x:Name="btnQuayLai" Padding="10" Margin="0,20,0,0" Background="Transparent" BorderThickness="0" Foreground="{StaticResource WhiteTextBrush}" Opacity="0.7" Cursor="Hand" Click="BtnQuayLai_Click">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="15" Height="15" Margin="0,0,8,0" VerticalAlignment="Center">
                                <Path Data="{StaticResource IconArrowLeft}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Quay lại Gọi món" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\ThanhToanView.xaml.cs
================================================================================
﻿using CafebookModel.Model.ModelApp.NhanVien;
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Text.Json;
using CafebookModel.Model.Entities;
using AppCafebookApi.View.common;
using System.Windows.Media;
using AppCafebookApi.Services;

namespace AppCafebookApi.View.nhanvien.pages
{
    public partial class ThanhToanView : Page
    {
        private readonly int _idHoaDonGoc;
        private static readonly HttpClient _httpClient;
        private bool _isDataLoading = true;
        private bool _isSettingCustomer = false; // Cờ để tránh vòng lặp sự kiện

        // Dùng 4 Collection để quản lý
        private ObservableCollection<ChiTietDto> _itemsGoc = new ObservableCollection<ChiTietDto>();
        private ObservableCollection<ChiTietDto> _itemsTach = new ObservableCollection<ChiTietDto>();
        private ObservableCollection<PhuThuDto> _phuThuTach = new ObservableCollection<PhuThuDto>();

        private List<PhuThu> _phuThusKhaDung = new List<PhuThu>();
        private List<KhachHangTimKiemDto> _allKhachHangs = new List<KhachHangTimKiemDto>();

        // SỬA: Dùng DTO chính từ Model
        private List<KhuyenMaiHienThiDto> _availableKms = new List<KhuyenMaiHienThiDto>();

        // Trạng thái thanh toán
        private HoaDonInfoDto _hoaDonInfo = null!;
        private KhachHang? _currentKhachHang = null;
        private int? _currentKhuyenMaiId = null;
        private decimal _currentTienGocTach = 0;
        private decimal _currentTienPhuThuTach = 0;
        private decimal _currentGiamGiaKM = 0;
        private decimal _currentGiamGiaDiem = 0;
        private int _currentDiemSuDung = 0;
        private decimal _currentThanhTienTach = 0;
        private string _currentPhuongThuc = "Tiền mặt";

        // Quy định điểm
        private decimal _tiLeDoiDiem = 1000m;
        private decimal _tiLeNhanDiem = 10000m;

        // Thông tin quán
        private string _tenQuan = "", _diaChi = "", _sdt = "", _wifi = "";
        private Brush _defaultBorderBrush; // THÊM MỚI: Lưu màu nền mặc định

        static ThanhToanView()
        {
            _httpClient = new HttpClient { BaseAddress = new Uri("http://localhost:5166") };
        }

        public ThanhToanView(int idHoaDon)
        {
            InitializeComponent();
            _idHoaDonGoc = idHoaDon;

            dgGoc.ItemsSource = _itemsGoc;
            dgTach.ItemsSource = _itemsTach;
            dgPhuThuTach.ItemsSource = _phuThuTach;
            lbPhuThuKhaDung.ItemsSource = _phuThusKhaDung;
            _defaultBorderBrush = borderKhachHang.Background; // THÊM MỚI: Lưu màu nền
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadDataAsync();
        }

        private async Task LoadDataAsync()
        {
            _isDataLoading = true;
            try
            {
                var response = await _httpClient.GetFromJsonAsync<ThanhToanViewDto>($"api/app/nhanvien/thanhtoan/load/{_idHoaDonGoc}");
                if (response == null)
                {
                    MessageBox.Show("Không thể tải dữ liệu thanh toán.");
                    return;
                }

                _hoaDonInfo = response.HoaDonInfo;
                lblTieuDeThanhToan.Text = $"Thanh toán cho {response.HoaDonInfo.SoBan} - HĐ #{response.HoaDonInfo.IdHoaDon}";

                _itemsGoc.Clear();
                _itemsTach.Clear();
                response.ChiTietItems.ForEach(item => _itemsGoc.Add(item));

                _phuThuTach.Clear();
                response.PhuThusDaApDung.ForEach(pt => _phuThuTach.Add(pt));

                _phuThusKhaDung = response.PhuThusKhaDung;
                lbPhuThuKhaDung.ItemsSource = _phuThusKhaDung;

                _allKhachHangs = response.KhachHangsList;
                _currentKhachHang = response.KhachHang;

                _tiLeDoiDiem = response.DiemTichLuy_DoiVND;
                _tiLeNhanDiem = response.DiemTichLuy_NhanVND;

                _tenQuan = response.TenQuan;
                _diaChi = response.DiaChi;
                _sdt = response.SoDienThoai;
                _wifi = response.WifiMatKhau;

                // Cập nhật UI khách hàng theo logic mới
                SetKhachHangUI(_currentKhachHang);

                _currentKhuyenMaiId = response.IdKhuyenMaiDaApDung;
                await UpdateKhuyenMaiUI();

                txtDiemSuDung.Text = "0";

                UpdateTachTotals();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải dữ liệu: {ex.Message}", "Lỗi nghiêm trọng");
            }
            _isDataLoading = false;
        }

        #region Logic Tách/Gộp

        private void BtnChuyenQua_Click(object sender, RoutedEventArgs e)
        {
            var selectedItems = dgGoc.SelectedItems.Cast<ChiTietDto>().ToList();
            foreach (var selected in selectedItems)
            {
                _itemsGoc.Remove(selected);
                _itemsTach.Add(selected);
            }

            foreach (var item in lbPhuThuKhaDung.SelectedItems)
            {
                var phuThu = item as PhuThu;
                if (phuThu != null && !_phuThuTach.Any(p => p.IdPhuThu == phuThu.IdPhuThu))
                {
                    _phuThuTach.Add(new PhuThuDto
                    {
                        IdPhuThu = phuThu.IdPhuThu,
                        TenPhuThu = phuThu.TenPhuThu,
                        LoaiGiaTri = phuThu.LoaiGiaTri,
                        GiaTri = phuThu.GiaTri
                    });
                }
            }
            lbPhuThuKhaDung.UnselectAll();
            UpdateTachTotals();
        }

        private void BtnChuyenQuaTatCa_Click(object sender, RoutedEventArgs e)
        {
            foreach (var item in _itemsGoc.ToList()) _itemsTach.Add(item);
            _itemsGoc.Clear();

            foreach (var item in lbPhuThuKhaDung.SelectedItems)
            {
                var phuThu = item as PhuThu;
                if (phuThu != null && !_phuThuTach.Any(p => p.IdPhuThu == phuThu.IdPhuThu))
                {
                    _phuThuTach.Add(new PhuThuDto
                    {
                        IdPhuThu = phuThu.IdPhuThu,
                        TenPhuThu = phuThu.TenPhuThu,
                        LoaiGiaTri = phuThu.LoaiGiaTri,
                        GiaTri = phuThu.GiaTri
                    });
                }
            }
            lbPhuThuKhaDung.UnselectAll();

            UpdateTachTotals();
        }

        private void BtnChuyenLai_Click(object sender, RoutedEventArgs e)
        {
            var selectedItems = dgTach.SelectedItems.Cast<ChiTietDto>().ToList();
            foreach (var selected in selectedItems)
            {
                _itemsTach.Remove(selected);
                _itemsGoc.Add(selected);
            }

            var selectedPhuThus = dgPhuThuTach.SelectedItems.Cast<PhuThuDto>().ToList();
            foreach (var selected in selectedPhuThus)
            {
                _phuThuTach.Remove(selected);
            }
            UpdateTachTotals();
        }

        private void BtnChuyenLaiTatCa_Click(object sender, RoutedEventArgs e)
        {
            foreach (var item in _itemsTach.ToList()) _itemsGoc.Add(item);
            _itemsTach.Clear();
            _phuThuTach.Clear();
            UpdateTachTotals();
        }

        #endregion

        #region Logic Tính Toán Panel Phải

        private void UpdateTachTotals()
        {
            if (_isDataLoading || lblTienCanThanhToan == null) return;

            _currentTienGocTach = _itemsTach.Sum(i => i.ThanhTien);

            _currentTienPhuThuTach = 0;
            foreach (var pt in _phuThuTach)
            {
                if (string.Equals(pt.LoaiGiaTri, "%", StringComparison.OrdinalIgnoreCase) || string.Equals(pt.LoaiGiaTri, "PhanTram", StringComparison.OrdinalIgnoreCase))
                {
                    pt.SoTien = _currentTienGocTach * (pt.GiaTri / 100);
                }
                else
                {
                    pt.SoTien = pt.GiaTri;
                }
                _currentTienPhuThuTach += pt.SoTien;
            }
            dgPhuThuTach.Items.Refresh();

            decimal tongTruocGiam = _currentTienGocTach + _currentTienPhuThuTach;
            lblTienCanThanhToan.Text = tongTruocGiam.ToString("N0") + " đ";

            _currentGiamGiaKM = 0;
            if (_currentKhuyenMaiId.HasValue && _currentKhuyenMaiId > 0)
            {
                try
                {
                    var km = _availableKms.FirstOrDefault(k => k.IdKhuyenMai == _currentKhuyenMaiId);
                    if (km != null)
                    {
                        if (string.Equals(km.LoaiGiamGia, "PhanTram", StringComparison.OrdinalIgnoreCase))
                        {
                            _currentGiamGiaKM = _currentTienGocTach * (km.GiaTriGiam / 100);
                        }
                        else
                        {
                            _currentGiamGiaKM = km.GiaTriGiam;
                        }
                    }
                }
                catch { }
            }
            lblTienGiamKM.Text = $"- {_currentGiamGiaKM:N0} đ";

            int.TryParse(txtDiemSuDung.Text, out _currentDiemSuDung);
            _currentGiamGiaDiem = _currentDiemSuDung * _tiLeDoiDiem;
            lblTienGiamDiem.Text = $"- {_currentGiamGiaDiem:N0} đ";

            _currentThanhTienTach = tongTruocGiam - _currentGiamGiaKM - _currentGiamGiaDiem;
            if (_currentThanhTienTach < 0) _currentThanhTienTach = 0;
            lblThanhTien.Text = _currentThanhTienTach.ToString("N0") + " đ";

            UpdateTienThua();
        }

        private void TxtKhachDua_TextChanged(object sender, TextChangedEventArgs e)
        {
            UpdateTienThua();
        }

        private void UpdateTienThua()
        {
            if (lblTienThua == null) return;

            if (decimal.TryParse(txtKhachDua.Text, out decimal khachDua))
            {
                decimal tienThua = khachDua - _currentThanhTienTach;
                lblTienThua.Text = tienThua.ToString("N0") + " đ";
            }
            else
            {
                lblTienThua.Text = (0 - _currentThanhTienTach).ToString("N0") + " đ";
            }
        }

        private void TxtDiemSuDung_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (_isDataLoading) return;

            if (int.TryParse(txtDiemSuDung.Text, out int diem) && _currentKhachHang != null)
            {
                if (diem > _currentKhachHang.DiemTichLuy)
                {
                    diem = _currentKhachHang.DiemTichLuy;
                    txtDiemSuDung.Text = diem.ToString();
                }

                decimal giamTuDiem = diem * _tiLeDoiDiem;
                decimal tongTruocDiem = _currentTienGocTach + _currentTienPhuThuTach - _currentGiamGiaKM;
                // Giới hạn 50% giống backend
                decimal maxDiscount = tongTruocDiem * 0.5m;
                int diemToiDaTheo50 = (int)Math.Floor(maxDiscount / _tiLeDoiDiem);

                if (diem > diemToiDaTheo50)
                {
                    diem = diemToiDaTheo50;
                    txtDiemSuDung.Text = diem.ToString();
                }
                /*
                if (giamTuDiem > tongTruocDiem)
                {
                    int diemToiDa = (int)Math.Floor(tongTruocDiem / _tiLeDoiDiem);
                    txtDiemSuDung.Text = diemToiDa.ToString();
                }
                */
            }
            UpdateTachTotals();
        }

        private void PaymentMethod_Changed(object sender, RoutedEventArgs e)
        {
            if (panelTienMat == null || rbTienMat == null || rbChuyenKhoan == null || rbThe == null || rbViDienTu == null)
            {
                return;
            }

            if (rbTienMat.IsChecked == true)
            {
                panelTienMat.Visibility = Visibility.Visible;
                _currentPhuongThuc = "Tiền mặt";
            }
            else
            {
                panelTienMat.Visibility = Visibility.Collapsed;
                if (rbChuyenKhoan.IsChecked == true) _currentPhuongThuc = "Chuyển khoản";
                else if (rbThe.IsChecked == true) _currentPhuongThuc = "Thẻ";
                else if (rbViDienTu.IsChecked == true) _currentPhuongThuc = "Ví điện tử";
            }
        }

        #endregion

        #region Logic Khách hàng & Điểm (Đã cải tiến)

        // HÀM MỚI: Xử lý khi gõ text (Search-as-you-type)
        private void TxtTimKhachHang_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (_isSettingCustomer) return; // Nếu đang set text thì không tìm kiếm

            string query = txtTimKhachHang.Text.ToLower();

            if (string.IsNullOrEmpty(query))
            {
                lbKhachHangResults.Visibility = Visibility.Collapsed;
                return;
            }

            // Lọc danh sách DTO, nhưng cung cấp đối tượng KhachHang cho ListBox (để khớp DataTemplate XAML)
            var filteredList = _allKhachHangs
                .Where(khDto => khDto.DisplayText.ToLower().Contains(query))
                .Select(khDto => khDto.KhachHangData)
                .ToList();

            if (filteredList.Any())
            {
                lbKhachHangResults.ItemsSource = filteredList;
                lbKhachHangResults.Visibility = Visibility.Visible;
            }
            else
            {
                lbKhachHangResults.Visibility = Visibility.Collapsed;
            }
        }

        // HÀM MỚI: Xử lý khi chọn một khách hàng từ danh sách
        private void LbKhachHangResults_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (lbKhachHangResults.SelectedItem is KhachHang selectedKh)
            {
                SetKhachHangUI(selectedKh); // Sử dụng helper
            }
        }

        // HÀM MỚI: Xử lý khi bấm phím Enter (chọn hoặc tạo mới)
        private async void TxtTimKhachHang_PreviewKeyDown(object sender, System.Windows.Input.KeyEventArgs e)
        {
            if (e.Key == System.Windows.Input.Key.Enter)
            {
                e.Handled = true; // Ngăn tiếng "bíp"
                await HandleFindOrCreateCustomer();
            }
        }

        // SỬA LẠI HÀM TxtTimKhachHang_LostFocus (dòng 316)
        private async void TxtTimKhachHang_LostFocus(object sender, RoutedEventArgs e)
        {
            // THÊM DÒNG NÀY: Nếu chuột đang trên nút Thanh Toán, không chạy
            // Vì nút thanh toán sẽ tự gọi logic này
            if (btnXacNhanThanhToan.IsMouseOver) return;

            await Task.Delay(150);
            if (lbKhachHangResults.IsKeyboardFocusWithin || lbKhachHangResults.IsFocused)
            {
                return;
            }
            await HandleFindOrCreateCustomer();
        }

        // THÊM HÀM MỚI NÀY (vào khu vực #region Logic Khách hàng & Điểm)
        // Xử lý Req 1: Bấm nút "X" để hủy chọn khách hàng
        private void BtnHuyKhachHang_Click(object sender, RoutedEventArgs e)
        {
            SetKhachHangUI(null);
            txtTimKhachHang.Text = ""; // Xóa luôn text tìm kiếm
        }

        // THAY THẾ HÀM CŨ HandleFindOrCreateCustomer bằng hàm này
        private async Task HandleFindOrCreateCustomer()
        {
            if (_isSettingCustomer) return;
            if (lbKhachHangResults.Visibility == Visibility.Visible)
            {
                lbKhachHangResults.Visibility = Visibility.Collapsed;
            }

            string query = txtTimKhachHang.Text;

            if (_currentKhachHang != null)
            {
                var khDto = _allKhachHangs.FirstOrDefault(kh => kh.IdKhachHang == _currentKhachHang.IdKhachHang);
                if (khDto != null && khDto.DisplayText.Equals(query, StringComparison.OrdinalIgnoreCase))
                {
                    return;
                }
            }

            if (string.IsNullOrWhiteSpace(query))
            {
                SetKhachHangUI(null);
                return;
            }

            btnXacNhanThanhToan.IsEnabled = false;
            try
            {
                var response = await _httpClient.PostAsJsonAsync("api/app/nhanvien/thanhtoan/find-or-create-customer", query);
                if (response.IsSuccessStatusCode)
                {
                    // SỬA: Đọc về DTO mới
                    var resultDto = await response.Content.ReadFromJsonAsync<KhachHangTimKiemDto>();

                    if (resultDto != null)
                    {
                        if (!_allKhachHangs.Any(kh => kh.IdKhachHang == resultDto.IdKhachHang))
                        {
                            _allKhachHangs.Add(resultDto);
                        }
                        SetKhachHangUI(resultDto.KhachHangData); // Cập nhật UI

                        // SỬA: Xử lý Req 2 (Hiển thị là tạo mới)
                        if (resultDto.IsNew)
                        {
                            lblTenKhachHang.Text = $"{resultDto.KhachHangData.HoTen} (Tài khoản mới)";
                            // Đổi màu nền để nhân viên chú ý
                            borderKhachHang.Background = new SolidColorBrush((Color)ColorConverter.ConvertFromString("#FF8F5E00"));
                        }
                    }
                    else
                    {
                        SetKhachHangUI(null); // Là khách vãng lai
                        _isSettingCustomer = true;
                        txtTimKhachHang.Text = query; // Giữ lại tên đã gõ
                        _isSettingCustomer = false;
                    }
                }
                else
                {
                    MessageBox.Show("Không thể tìm hoặc tạo khách hàng. Sử dụng khách vãng lai.", "Lỗi API");
                    SetKhachHangUI(null);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi API khách hàng: {ex.Message}");
                SetKhachHangUI(null);
            }
            btnXacNhanThanhToan.IsEnabled = true;
        }

        // THAY THẾ HÀM CŨ SetKhachHangUI bằng hàm này
        private void SetKhachHangUI(KhachHang? khachHang)
        {
            _currentKhachHang = khachHang;
            _isSettingCustomer = true;
            borderKhachHang.Background = _defaultBorderBrush; // SỬA: Luôn reset màu nền

            if (_currentKhachHang != null)
            {
                var khDto = _allKhachHangs.FirstOrDefault(kh => kh.IdKhachHang == _currentKhachHang.IdKhachHang);

                borderKhachHang.Visibility = Visibility.Visible;
                btnHuyKhachHang.Visibility = Visibility.Visible; // SỬA: Hiển thị nút Hủy
                lblTenKhachHang.Text = _currentKhachHang.HoTen;
                lblDiemHienCo.Text = $"{_currentKhachHang.DiemTichLuy} điểm (Tương đương {_currentKhachHang.DiemTichLuy * _tiLeDoiDiem:N0} đ)";
                txtDiemSuDung.IsEnabled = true;
                btnApDungDiem.IsEnabled = true;

                txtTimKhachHang.Text = khDto?.DisplayText ?? _currentKhachHang.HoTen;
            }
            else // Khách vãng lai
            {
                borderKhachHang.Visibility = Visibility.Collapsed;
                btnHuyKhachHang.Visibility = Visibility.Collapsed; // SỬA: Ẩn nút Hủy
                lblTenKhachHang.Text = "Khách vãng lai";
                txtDiemSuDung.IsEnabled = false;
                btnApDungDiem.IsEnabled = false;
                txtDiemSuDung.Text = "0";

                if (!txtTimKhachHang.IsFocused)
                {
                    txtTimKhachHang.Text = "";
                }
            }

            lbKhachHangResults.Visibility = Visibility.Collapsed;
            _isSettingCustomer = false;
            UpdateTachTotals();
        }

        private void BtnApDungDiem_Click(object sender, RoutedEventArgs e)
        {
            TxtDiemSuDung_TextChanged(sender, null!);
        }

        #endregion

        #region Logic Khuyến Mãi (Cửa sổ mới)

        private async Task LoadAvailableKms()
        {
            if (_availableKms.Any()) return;

            try
            {
                var kms = await _httpClient.GetFromJsonAsync<List<KhuyenMaiHienThiDto>>($"api/app/nhanvien/khuyenmai/available/{_idHoaDonGoc}");
                _availableKms = kms ?? new List<KhuyenMaiHienThiDto>();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Không thể tải danh sách KM: {ex.Message}");
                _availableKms = new List<KhuyenMaiHienThiDto>();
            }
        }

        private async Task UpdateKhuyenMaiUI()
        {
            await LoadAvailableKms();

            if (_currentKhuyenMaiId.HasValue && _currentKhuyenMaiId > 0)
            {
                var km = _availableKms.FirstOrDefault(k => k.IdKhuyenMai == _currentKhuyenMaiId);
                if (km == null)
                {
                    btnChonKhuyenMai.Content = "KM đã lưu (không hợp lệ)";
                }
                else
                {
                    btnChonKhuyenMai.Content = km.TenChuongTrinh;
                }
                btnHuyKhuyenMai.Visibility = Visibility.Visible;
            }
            else
            {
                btnChonKhuyenMai.Content = "-- Chọn Khuyến mãi --";
                btnHuyKhuyenMai.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnChonKhuyenMai_Click(object sender, RoutedEventArgs e)
        {
            await LoadAvailableKms();

            var dialog = new ChonKhuyenMaiWindow(_idHoaDonGoc, _currentKhuyenMaiId);
            if (dialog.ShowDialog() == true)
            {
                _currentKhuyenMaiId = dialog.SelectedId;
                if (_currentKhuyenMaiId == 0) _currentKhuyenMaiId = null;

                await UpdateKhuyenMaiUI();
                UpdateTachTotals();
            }
        }

        private void BtnHuyKhuyenMai_Click(object sender, RoutedEventArgs e)
        {
            _currentKhuyenMaiId = null;
            btnChonKhuyenMai.Content = "-- Chọn Khuyến mãi --";
            btnHuyKhuyenMai.Visibility = Visibility.Collapsed;
            UpdateTachTotals();
        }

        #endregion

        // THAY THẾ TOÀN BỘ HÀM BtnXacNhanThanhToan_Click (dòng 506)
        private async void BtnXacNhanThanhToan_Click(object sender, RoutedEventArgs e)
        {
            // *** BƯỚC 1: FIX RACE CONDITION ***
            // Buộc chạy và đợi logic tìm/tạo khách hàng hoàn tất
            // TRƯỚC KHI xây dựng request thanh toán.
            await HandleFindOrCreateCustomer();
            // *** KẾT THÚC FIX ***

            if (!_itemsTach.Any())
            {
                MessageBox.Show("Vui lòng chuyển ít nhất 1 món qua 'Hóa đơn thanh toán'.", "Chưa chọn món");
                return;
            }

            decimal.TryParse(txtKhachDua.Text, out decimal khachDua);
            if (_currentPhuongThuc == "Tiền mặt" && khachDua < _currentThanhTienTach)
            {
                MessageBox.Show("Tiền khách đưa không đủ.", "Thiếu tiền", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            bool isFullPaymentClient = !_itemsGoc.Any();
            if (isFullPaymentClient)
            {
                var confirmResult = MessageBox.Show(
                    "Xác nhận thanh toán cho toàn bộ hóa đơn này?",
                    "Xác nhận",
                    MessageBoxButton.YesNo,
                    MessageBoxImage.Question);

                if (confirmResult == MessageBoxResult.No)
                {
                    return;
                }
            }

            var request = new ThanhToanRequestDto
            {
                IdHoaDonGoc = _idHoaDonGoc,
                IdChiTietTach = _itemsTach.Select(i => i.IdChiTietHoaDon).ToList(),
                IdPhuThuTach = _phuThuTach.Select(p => p.IdPhuThu).ToList(),
                IdKhuyenMai = _currentKhuyenMaiId,
                PhuongThucThanhToan = _currentPhuongThuc,
                KhachDua = khachDua,
                DiemSuDung = _currentDiemSuDung,
                // _currentKhachHang LÚC NÀY ĐÃ ĐƯỢC CẬP NHẬT
                IdKhachHang = _currentKhachHang?.IdKhachHang
            };

            btnXacNhanThanhToan.IsEnabled = false;
            try
            {
                var response = await _httpClient.PostAsJsonAsync("api/app/nhanvien/thanhtoan/pay", request);
                if (response.IsSuccessStatusCode)
                {
                    var jsonDoc = JsonDocument.Parse(await response.Content.ReadAsStringAsync());
                    bool isFullPaymentServer = jsonDoc.RootElement.GetProperty("isFullPayment").GetBoolean();
                    int idHoaDonDaThanhToan = jsonDoc.RootElement.GetProperty("idHoaDonDaThanhToan").GetInt32();

                    var previewData = new HoaDonPreviewDto
                    {
                        IsProvisional = false,
                        TenQuan = _tenQuan,
                        DiaChi = _diaChi,
                        SoDienThoai = _sdt,
                        WifiMatKhau = _wifi,
                        IdHoaDon = idHoaDonDaThanhToan,
                        SoBan = _hoaDonInfo.SoBan,
                        ThoiGianTao = DateTime.Now,
                        TenNhanVien = AuthService.CurrentUser?.HoTen ?? "Nhân viên",
                        TenKhachHang = _currentKhachHang?.HoTen ?? "Khách vãng lai", // Đã đúng
                        Items = _itemsTach.ToList(),
                        Surcharges = _phuThuTach.ToList(),
                        TongTienGoc = _currentTienGocTach,
                        TongPhuThu = _currentTienPhuThuTach,
                        GiamGiaKM = _currentGiamGiaKM,
                        GiamGiaDiem = _currentGiamGiaDiem,
                        ThanhTien = _currentThanhTienTach,
                        PhuongThucThanhToan = _currentPhuongThuc,
                        KhachDua = decimal.TryParse(txtKhachDua.Text, out var kd) ? kd : 0,
                        TienThoi = decimal.TryParse(lblTienThua.Text.Replace(" đ", "").Replace(",", ""), out var tt) ? tt : 0
                    };

                    var previewWindow = new HoaDonPreviewWindow(previewData);
                    previewWindow.ShowDialog();

                    if (isFullPaymentServer)
                    {
                        var mainFrame = FindParentFrame();
                        if (mainFrame != null)
                        {
                            mainFrame.Navigate(new SoDoBanView());
                            while (mainFrame.CanGoBack)
                            {
                                mainFrame.RemoveBackEntry();
                            }
                        }
                    }
                    else
                    {
                        await LoadDataAsync();
                    }
                }
                else
                {
                    string errorMessage = await response.Content.ReadAsStringAsync();
                    MessageBox.Show(errorMessage, "Lỗi Thanh Toán");

                    if (errorMessage.Contains("Hóa đơn này đã được xử lý"))
                    {
                        var mainFrame = FindParentFrame();
                        if (mainFrame != null)
                        {
                            mainFrame.Navigate(new SoDoBanView());
                            while (mainFrame.CanGoBack)
                            {
                                mainFrame.RemoveBackEntry();
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message, "Lỗi API");
            }
            btnXacNhanThanhToan.IsEnabled = true;
        }

        private Frame? FindParentFrame()
        {
            var currentWindow = Window.GetWindow(this);
            if (currentWindow == null) return null;
            var mainFrame = currentWindow.FindName("MainFrame") as Frame;
            return mainFrame;
        }

        private void BtnInTamTinh_Click(object sender, RoutedEventArgs e)
        {
            var previewData = new HoaDonPreviewDto
            {
                IsProvisional = true,
                TenQuan = _tenQuan,
                DiaChi = _diaChi,
                SoDienThoai = _sdt,
                WifiMatKhau = _wifi,
                IdHoaDon = _idHoaDonGoc,
                SoBan = _hoaDonInfo.SoBan,
                ThoiGianTao = DateTime.Now,
                TenNhanVien = AuthService.CurrentUser?.HoTen ?? "Nhân viên",
                TenKhachHang = _currentKhachHang?.HoTen ?? "Khách vãng lai",
                Items = _itemsTach.ToList(),
                Surcharges = _phuThuTach.ToList(),
                TongTienGoc = _currentTienGocTach,
                TongPhuThu = _currentTienPhuThuTach,
                GiamGiaKM = _currentGiamGiaKM,
                GiamGiaDiem = _currentGiamGiaDiem,
                ThanhTien = _currentThanhTienTach,
                PhuongThucThanhToan = _currentPhuongThuc,
                KhachDua = decimal.TryParse(txtKhachDua.Text, out var kd) ? kd : 0,
                TienThoi = decimal.TryParse(lblTienThua.Text.Replace(" đ", "").Replace(",", ""), out var tt) ? tt : 0
            };

            var previewWindow = new HoaDonPreviewWindow(previewData);
            previewWindow.ShowDialog();
        }

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }

        private T? FindVisualChild<T>(DependencyObject? obj) where T : DependencyObject
        {
            if (obj == null) return null;
            for (int i = 0; i < VisualTreeHelper.GetChildrenCount(obj); i++)
            {
                DependencyObject child = VisualTreeHelper.GetChild(obj, i);
                if (child != null && child is T)
                    return (T)child;
                else
                {
                    T? childOfChild = FindVisualChild<T>(child);
                    if (childOfChild != null)
                        return childOfChild;
                }
            }
            return null;
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\ThongTinCaNhanView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.nhanvien.pages.ThongTinCaNhanView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      mc:Ignorable="d" 
      d:DesignHeight="720" d:DesignWidth="1150"
      Title="ThongTinCaNhanView"
      FontFamily="Segoe UI" Background="#FFF8E1" Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="PrimaryBrownHoverBrush" Color="#8D6E63"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="AccentOrangeHoverBrush" Color="#F57C00"/>
        <SolidColorBrush x:Key="DarkTextBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="LightBackgroundBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="WhiteBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="RedBrush" Color="#D32F2F"/>
        <SolidColorBrush x:Key="GreenBrush" Color="#388E3C"/>
        <Geometry x:Key="IconHistory">M13,3A9,9 0 0,0 4,12H1L4.89,15.89L4.96,16.03L9,12H6A7,7 0 0,1 13,5A7,7 0 0,1 20,12A7,7 0 0,1 13,19C11.07,19 9.32,18.21 8.06,16.94L6.64,18.36C8.27,20 10.5,21 13,21A9,9 0 0,0 22,12A9,9 0 0,0 13,3M12.5,8V13L16.25,15.15L17,13.92L14,12.25V8H12.5Z</Geometry>
        <Geometry x:Key="IconEdit">M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C17.98,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z</Geometry>
        <Geometry x:Key="IconLeave">M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1M17,12H12V17H17V12Z</Geometry>
        <Geometry x:Key="IconPassword">M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8H17V6A5,5 0 0,0 12,1A5,5 0 0,0 7,6V8H6A2,2 0 0,0 4,10V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V10A2,2 0 0,0 18,8Z</Geometry>
        <Geometry x:Key="IconUpload">M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z</Geometry>
        <DropShadowEffect x:Key="ShadowDepth1" ShadowDepth="1" Color="#000" Opacity="0.12" BlurRadius="5"/>
        <DropShadowEffect x:Key="ShadowDepth2" ShadowDepth="3" Color="#000" Opacity="0.15" BlurRadius="10"/>
        <Style TargetType="Button" x:Key="MaterialButton">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteBrush}"/>
            <Setter Property="Padding" Value="16,10"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Height" Value="38"/>
            <Setter Property="Effect" Value="{StaticResource ShadowDepth1}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" 
                                Background="{TemplateBinding Background}" 
                                CornerRadius="19" 
                                SnapsToDevicePixels="True">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource PrimaryBrownHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Effect" Value="{x:Null}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="border" Property="Background" Value="#BDBDBD"/>
                                <Setter TargetName="border" Property="Effect" Value="{x:Null}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="Button" x:Key="AccentButton" BasedOn="{StaticResource MaterialButton}">
            <Setter Property="Background" Value="{StaticResource AccentOrangeBrush}"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource AccentOrangeHoverBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="Button" x:Key="GreenButton" BasedOn="{StaticResource MaterialButton}">
            <Setter Property="Background" Value="{StaticResource GreenBrush}"/>
        </Style>
        <Style TargetType="ToggleButton" x:Key="NavToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource DarkTextBrush}"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Padding" Value="15,12"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="border" 
                                Background="{TemplateBinding Background}" 
                                CornerRadius="8" 
                                Margin="0,3">
                            <StackPanel Orientation="Horizontal" Margin="{TemplateBinding Padding}">
                                <Viewbox Width="18" Height="18" Margin="0,0,12,0">
                                    <Path Data="{Binding Path=Tag, RelativeSource={RelativeSource TemplatedParent}}" 
                                          Fill="{TemplateBinding Foreground}"/>
                                </Viewbox>
                                <ContentPresenter VerticalAlignment="Center"/>
                            </StackPanel>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource SubtleGrayBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="TextBlock" x:Key="LabelStyle">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkTextBrush}"/>
            <Setter Property="Margin" Value="0,15,0,5"/>
        </Style>
        <Style TargetType="TextBlock" x:Key="InfoDisplayLabel" BasedOn="{StaticResource LabelStyle}">
            <Setter Property="Margin" Value="0,15,0,2"/>
        </Style>
        <Style TargetType="TextBlock" x:Key="InfoDisplayText">
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="Foreground" Value="#333"/>
            <Setter Property="TextWrapping" Value="Wrap"/>
        </Style>
        <Style TargetType="TextBlock" x:Key="HeaderStyle">
            <Setter Property="FontSize" Value="22"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style TargetType="Control" x:Key="MaterialInput">
            <Setter Property="Background" Value="{StaticResource LightBackgroundBrush}"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0,0,0,2"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="10"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Control">
                        <Border x:Name="border" 
                                Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}" 
                                BorderThickness="{TemplateBinding BorderThickness}" 
                                CornerRadius="5,5,0,0"
                                SnapsToDevicePixels="True">
                            <ScrollViewer x:Name="PART_ContentHost" Focusable="False" HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Hidden"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsKeyboardFocused" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource AccentOrangeBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="PasswordBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox">
            <Setter Property="Background" Value="{StaticResource LightBackgroundBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource SubtleGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,2"/>
            <Setter Property="Height" Value="42"/>
            <Setter Property="Padding" Value="8,0"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource AccentOrangeBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="DatePicker">
            <Setter Property="Background" Value="{StaticResource LightBackgroundBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource SubtleGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,2"/>
            <Setter Property="Height" Value="42"/>
            <Setter Property="Padding" Value="8,0"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource AccentOrangeBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </Page.Resources>

    <Grid Margin="25">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="350"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Margin="0,0,20,0" 
                Background="{StaticResource WhiteBrush}"
                CornerRadius="12"
                Effect="{StaticResource ShadowDepth2}"
                Padding="20">
            <StackPanel>
                <TextBlock Text="Thông tin cá nhân" Style="{StaticResource HeaderStyle}"/>
                <Border CornerRadius="150" Width="200" Height="200" 
                        BorderBrush="{StaticResource PrimaryBrownBrush}" BorderThickness="2" 
                        Background="#EFEBE9" Margin="0,10,0,20"
                        HorizontalAlignment="Center">
                    <Ellipse x:Name="imgAvatar" Width="200" Height="200">
                        <Ellipse.Fill>
                            <ImageBrush Stretch="UniformToFill"/>
                        </Ellipse.Fill>
                    </Ellipse>
                </Border>
                <TextBlock Text="Họ tên:" Style="{StaticResource InfoDisplayLabel}" Margin="0,10,0,2"/>
                <TextBlock x:Name="lblHoTen" Text="Đang tải..." Style="{StaticResource InfoDisplayText}"/>
                <TextBlock Text="Số điện thoại:" Style="{StaticResource InfoDisplayLabel}"/>
                <TextBlock x:Name="lblSoDienThoai" Text="Đang tải..." Style="{StaticResource InfoDisplayText}"/>
                <TextBlock Text="Email:" Style="{StaticResource InfoDisplayLabel}"/>
                <TextBlock x:Name="lblEmail" Text="Đang tải..." Style="{StaticResource InfoDisplayText}"/>
                <TextBlock Text="Địa chỉ:" Style="{StaticResource InfoDisplayLabel}"/>
                <TextBlock x:Name="lblDiaChi" Text="Đang tải..." Style="{StaticResource InfoDisplayText}"/>
                <Separator Margin="0,25,0,15"/>
                <ToggleButton x:Name="btnLichSu" Content="Lịch sử &amp; Lịch làm" 
                              Style="{StaticResource NavToggleButton}" 
                              Tag="{StaticResource IconHistory}" 
                              Click="BtnLichSu_Click"
                              IsChecked="True"/>
                <ToggleButton x:Name="btnChinhSua" Content="Chỉnh sửa thông tin" 
                              Style="{StaticResource NavToggleButton}" 
                              Tag="{StaticResource IconEdit}" 
                              Click="BtnChinhSua_Click"/>
                <ToggleButton x:Name="btnDoiMatKhau" Content="Đổi mật khẩu" 
                              Style="{StaticResource NavToggleButton}" 
                              Tag="{StaticResource IconPassword}" 
                              Click="BtnDoiMatKhau_Click"/>
            </StackPanel>
        </Border>

        <TabControl x:Name="MainTabControl" Grid.Column="1" Margin="20,0,0,0" 
                    Background="Transparent" BorderThickness="0">
            <TabControl.Template>
                <ControlTemplate TargetType="TabControl">
                    <Grid>
                        <Border BorderBrush="{TemplateBinding BorderBrush}" 
                                BorderThickness="{TemplateBinding BorderThickness}" 
                                Background="{TemplateBinding Background}" 
                                Padding="{TemplateBinding Padding}" 
                                SnapsToDevicePixels="true"/>
                        <ContentPresenter x:Name="PART_SelectedContentHost" 
                                          ContentSource="SelectedContent" 
                                          Margin="0"/>
                    </Grid>
                </ControlTemplate>
            </TabControl.Template>

            <TabItem x:Name="tabLichSu">
                <StackPanel>
                    <Border Background="{StaticResource WhiteBrush}" CornerRadius="8" Padding="20" 
                            Effect="{StaticResource ShadowDepth1}" Margin="0,0,0,20">
                        <StackPanel>
                            <TextBlock Text="Thông báo lịch làm việc" FontWeight="Bold" FontSize="16" Margin="0,0,0,10"/>
                            <TextBlock x:Name="lblThongBaoLich" Text="Đang tải lịch..." FontSize="14" TextWrapping="Wrap"/>
                            <TextBlock x:Name="lblThoiGianCa" Text="" FontSize="14" FontWeight="SemiBold" Foreground="{StaticResource PrimaryBrownBrush}"/>
                        </StackPanel>
                    </Border>
                    <Border Background="{StaticResource WhiteBrush}" CornerRadius="8" Padding="20"
                            Effect="{StaticResource ShadowDepth1}">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                                <TextBlock Text="Tổng số đơn xin nghỉ tháng này:" FontSize="16" FontWeight="Bold" Foreground="{StaticResource PrimaryBrownBrush}"/>
                                <TextBlock x:Name="lblSoLanNghi" Text="0" FontSize="16" FontWeight="Bold" Foreground="{StaticResource RedBrush}" Margin="10,0,0,0"/>
                            </StackPanel>
                            <TextBlock Text="Lịch làm việc tháng này" FontSize="18" FontWeight="Bold" Foreground="{StaticResource PrimaryBrownBrush}" Margin="0,0,0,10"/>
                            <DataGrid x:Name="dgLichLamViec" AutoGenerateColumns="False" IsReadOnly="True"
                                      CanUserAddRows="False" Background="{StaticResource WhiteBrush}" 
                                      BorderBrush="{StaticResource SubtleGrayBrush}" BorderThickness="1">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Ngày làm" Binding="{Binding NgayLam, StringFormat=dd/MM/yyyy}" Width="120" FontWeight="SemiBold"/>
                                    <DataGridTextColumn Header="Tên Ca" Binding="{Binding TenCa}" Width="*"/>
                                    <DataGridTextColumn Header="Giờ vào" Binding="{Binding GioBatDau, StringFormat=hh\\:mm}" Width="100"/>
                                    <DataGridTextColumn Header="Giờ ra" Binding="{Binding GioKetThuc, StringFormat=hh\\:mm}" Width="100"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </TabItem>

            <TabItem x:Name="tabChinhSua">
                <Border Background="{StaticResource WhiteBrush}" CornerRadius="8" Padding="25" 
                        Effect="{StaticResource ShadowDepth1}">
                    <StackPanel>
                        <TextBlock Text="Chỉnh sửa thông tin" Style="{StaticResource HeaderStyle}"/>
                        <TextBlock Text="Họ tên:" Style="{StaticResource LabelStyle}"/>
                        <TextBox x:Name="txtEditHoTen" Style="{StaticResource MaterialInput}"/>
                        <TextBlock Text="Số điện thoại:" Style="{StaticResource LabelStyle}"/>
                        <TextBox x:Name="txtEditSoDienThoai" Style="{StaticResource MaterialInput}"/>
                        <TextBlock Text="Email:" Style="{StaticResource LabelStyle}"/>
                        <TextBox x:Name="txtEditEmail" Style="{StaticResource MaterialInput}"/>
                        <TextBlock Text="Địa chỉ:" Style="{StaticResource LabelStyle}"/>
                        <TextBox x:Name="txtEditDiaChi" Height="80" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Style="{StaticResource MaterialInput}"/>
                        <Button x:Name="btnChonAnh" Style="{StaticResource MaterialButton}" Margin="0,15,0,0" Click="BtnChonAnh_Click"
                                Background="{StaticResource WhiteBrush}" Foreground="{StaticResource DarkTextBrush}" BorderBrush="{StaticResource SubtleGrayBrush}" BorderThickness="1">
                            <StackPanel Orientation="Horizontal">
                                <Viewbox Width="16" Height="16" Margin="0,0,8,0">
                                    <Path Data="{StaticResource IconUpload}" Fill="{StaticResource DarkTextBrush}"/>
                                </Viewbox>
                                <TextBlock Text="Thay đổi ảnh đại diện..."/>
                            </StackPanel>
                        </Button>
                        <StackPanel Orientation="Horizontal" Margin="0,25,0,0">
                            <Button x:Name="btnLuu" Content="Lưu thay đổi" Style="{StaticResource GreenButton}" Click="BtnLuu_Click"/>
                            <Button x:Name="btnHuyChinhSua" Content="Hủy" Style="{StaticResource MaterialButton}" Margin="10,0,0,0" Click="BtnHuyChinhSua_Click"
                                    Background="{StaticResource WhiteBrush}" Foreground="{StaticResource DarkTextBrush}" BorderBrush="{StaticResource SubtleGrayBrush}" BorderThickness="1"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </TabItem>

            <TabItem x:Name="tabDoiMatKhau">
                <Border Background="{StaticResource WhiteBrush}" CornerRadius="8" Padding="25"
                        Effect="{StaticResource ShadowDepth1}">
                    <StackPanel MaxWidth="400">
                        <TextBlock Text="Đổi mật khẩu" Style="{StaticResource HeaderStyle}"/>

                        <TextBlock Text="Mật khẩu cũ:" Style="{StaticResource LabelStyle}"/>
                        <Grid Margin="0,5,0,10">
                            <PasswordBox x:Name="txtMatKhauCu" Style="{StaticResource MaterialInput}" 
                                         PasswordChanged="TxtMatKhauCu_PasswordChanged"/>
                            <TextBox x:Name="txtVisibleMatKhauCu" Style="{StaticResource MaterialInput}" 
                                     Visibility="Collapsed" TextChanged="TxtVisibleMatKhauCu_TextChanged"/>
                        </Grid>

                        <TextBlock Text="Mật khẩu mới:" Style="{StaticResource LabelStyle}"/>
                        <Grid Margin="0,5,0,10">
                            <PasswordBox x:Name="txtMatKhauMoi" Style="{StaticResource MaterialInput}" 
                                         PasswordChanged="TxtMatKhauMoi_PasswordChanged"/>
                            <TextBox x:Name="txtVisibleMatKhauMoi" Style="{StaticResource MaterialInput}" 
                                     Visibility="Collapsed" TextChanged="TxtVisibleMatKhauMoi_TextChanged"/>
                        </Grid>

                        <TextBlock Text="Xác nhận mật khẩu mới:" Style="{StaticResource LabelStyle}"/>
                        <Grid Margin="0,5,0,10">
                            <PasswordBox x:Name="txtXacNhanMatKhau" Style="{StaticResource MaterialInput}" 
                                         PasswordChanged="TxtXacNhanMatKhau_PasswordChanged"/>
                            <TextBox x:Name="txtVisibleXacNhanMatKhau" Style="{StaticResource MaterialInput}" 
                                     Visibility="Collapsed" TextChanged="TxtVisibleXacNhanMatKhau_TextChanged"/>
                        </Grid>

                        <CheckBox x:Name="chkShowPassword" Content="Hiển thị mật khẩu" 
                                  Foreground="{StaticResource DarkTextBrush}" Margin="0,5,0,20"
                                  Checked="ChkShowPassword_Checked" Unchecked="ChkShowPassword_Unchecked"/>

                        <StackPanel Orientation="Horizontal">
                            <Button x:Name="btnXacNhanDoiMatKhau" Content="Xác nhận" Style="{StaticResource GreenButton}" Click="BtnXacNhanDoiMatKhau_Click"/>
                            <Button x:Name="btnHuyDoiMatKhau" Content="Hủy" Style="{StaticResource MaterialButton}" Margin="10,0,0,0" Click="BtnHuyDoiMatKhau_Click"
                                    Background="{StaticResource WhiteBrush}" Foreground="{StaticResource DarkTextBrush}" BorderBrush="{StaticResource SubtleGrayBrush}" BorderThickness="1"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </TabItem>

        </TabControl>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\ThongTinCaNhanView.xaml.cs
================================================================================
﻿// File: ThongTinCaNhanView.xaml.cs
using AppCafebookApi.Services;
using CafebookModel.Model.ModelApp.NhanVien;
using CafebookModel.Utils;
using Microsoft.Win32;
using System;
using System.IO;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Threading.Tasks;
using System.Windows.Controls.Primitives;

namespace AppCafebookApi.View.nhanvien.pages
{
    public partial class ThongTinCaNhanView : Page
    {
        private NhanVienInfoDto? _currentNhanVien;
        private string? _newAvatarFilePath = null;

        public ThongTinCaNhanView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadDataAsync();
            ShowPanel("LichSu");
        }

        private async Task LoadDataAsync()
        {
            // (Hàm này giữ nguyên)
            try
            {
                var response = await ApiClient.Instance.GetFromJsonAsync<ThongTinCaNhanViewDto>("api/app/nhanvien/thongtincanhan/me");
                if (response == null)
                {
                    MessageBox.Show("Không thể tải thông tin cá nhân.");
                    return;
                }
                _currentNhanVien = response.NhanVien;
                lblHoTen.Text = _currentNhanVien.HoTen;
                lblSoDienThoai.Text = _currentNhanVien.SoDienThoai;
                lblEmail.Text = _currentNhanVien.Email ?? "Chưa cập nhật";
                lblDiaChi.Text = _currentNhanVien.DiaChi ?? "Chưa cập nhật";
                txtEditHoTen.Text = _currentNhanVien.HoTen;
                txtEditSoDienThoai.Text = _currentNhanVien.SoDienThoai;
                txtEditEmail.Text = _currentNhanVien.Email;
                txtEditDiaChi.Text = _currentNhanVien.DiaChi;
                SetAvatar(_currentNhanVien.AnhDaiDien);
                if (response.LichLamViecHomNay != null)
                {
                    lblThongBaoLich.Text = $"Hôm nay bạn có lịch làm việc:";
                    lblThoiGianCa.Text = $"{response.LichLamViecHomNay.TenCa} ({response.LichLamViecHomNay.GioBatDau:hh\\:mm} - {response.LichLamViecHomNay.GioKetThuc:hh\\:mm})";
                }
                else
                {
                    lblThongBaoLich.Text = "Hôm nay bạn không có ca làm việc.";
                    lblThoiGianCa.Text = "Hãy tận hưởng ngày nghỉ của mình!";
                }
                lblSoLanNghi.Text = response.SoLanXinNghiThangNay.ToString();
                dgLichLamViec.ItemsSource = response.LichLamViecThangNay;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải dữ liệu: {ex.Message}", "Lỗi API");
            }
        }

        private void SetAvatar(string? imageSource)
        {
            // (Hàm này giữ nguyên)
            var bitmap = HinhAnhHelper.LoadImage(imageSource, HinhAnhPaths.DefaultAvatar);
            imgAvatar.Fill = new ImageBrush(bitmap);
        }

        #region Quản lý Panel (Đã cập nhật để dùng TabControl)
        // (Vùng này giữ nguyên)
        private void UncheckOtherButtons(ToggleButton? exception)
        {
            if (btnLichSu != null && btnLichSu != exception)
                btnLichSu.IsChecked = false;
            if (btnChinhSua != null && btnChinhSua != exception)
                btnChinhSua.IsChecked = false;
            if (btnDoiMatKhau != null && btnDoiMatKhau != exception)
                btnDoiMatKhau.IsChecked = false;
            // *** SỬA: ĐÃ XÓA logic "btnVietDon" ***
        }
        private void ShowPanel(string panelName)
        {
            switch (panelName)
            {
                case "LichSu":
                    MainTabControl.SelectedItem = tabLichSu;
                    btnLichSu.IsChecked = true;
                    UncheckOtherButtons(btnLichSu);
                    break;
                case "ChinhSua":
                    MainTabControl.SelectedItem = tabChinhSua;
                    btnChinhSua.IsChecked = true;
                    UncheckOtherButtons(btnChinhSua);
                    break;
                case "DoiMatKhau":
                    MainTabControl.SelectedItem = tabDoiMatKhau;
                    btnDoiMatKhau.IsChecked = true;
                    UncheckOtherButtons(btnDoiMatKhau);
                    break;
                    // *** SỬA: ĐÃ XÓA case "VietDon" ***
            }
        }
        private void BtnLichSu_Click(object sender, RoutedEventArgs e) { ShowPanel("LichSu"); }
        private void BtnChinhSua_Click(object sender, RoutedEventArgs e) { ShowPanel("ChinhSua"); }
        private void BtnDoiMatKhau_Click(object sender, RoutedEventArgs e) { ShowPanel("DoiMatKhau"); }
        private void BtnVietDon_Click(object sender, RoutedEventArgs e) { ShowPanel("VietDon"); }
        #endregion

        #region Logic Panel Chỉnh Sửa
        // (Vùng này giữ nguyên)
        private async void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            if (_currentNhanVien == null) return;
            btnLuu.IsEnabled = false;
            using var formData = new MultipartFormDataContent();
            formData.Add(new StringContent(txtEditHoTen.Text), nameof(CapNhatThongTinDto.HoTen));
            formData.Add(new StringContent(txtEditSoDienThoai.Text), nameof(CapNhatThongTinDto.SoDienThoai));
            formData.Add(new StringContent(txtEditEmail.Text ?? ""), nameof(CapNhatThongTinDto.Email));
            formData.Add(new StringContent(txtEditDiaChi.Text ?? ""), nameof(CapNhatThongTinDto.DiaChi));
            if (!string.IsNullOrEmpty(_newAvatarFilePath) && File.Exists(_newAvatarFilePath))
            {
                try
                {
                    byte[] fileBytes = File.ReadAllBytes(_newAvatarFilePath);
                    var fileContent = new ByteArrayContent(fileBytes);
                    string mimeType = Path.GetExtension(_newAvatarFilePath).ToLower() == ".png" ? "image/png" : "image/jpeg";
                    fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(mimeType);
                    formData.Add(fileContent, "avatarFile", Path.GetFileName(_newAvatarFilePath));
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Không thể đọc file ảnh: {ex.Message}");
                    btnLuu.IsEnabled = true; return;
                }
            }
            try
            {
                var response = await ApiClient.Instance.PutAsync("api/app/nhanvien/thongtincanhan/update-info", formData);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Cập nhật thành công!");
                    _newAvatarFilePath = null;
                    await LoadDataAsync();
                    ShowPanel("LichSu");
                }
                else
                {
                    string loi = await response.Content.ReadAsStringAsync();
                    MessageBox.Show($"Cập nhật thất bại: {loi}", "Lỗi");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            btnLuu.IsEnabled = true;
        }
        private void BtnHuyChinhSua_Click(object sender, RoutedEventArgs e)
        {
            if (_currentNhanVien != null)
            {
                txtEditHoTen.Text = _currentNhanVien.HoTen;
                txtEditSoDienThoai.Text = _currentNhanVien.SoDienThoai;
                txtEditEmail.Text = _currentNhanVien.Email;
                txtEditDiaChi.Text = _currentNhanVien.DiaChi;
                SetAvatar(_currentNhanVien.AnhDaiDien);
            }
            _newAvatarFilePath = null;
            ShowPanel("LichSu");
        }
        private void BtnChonAnh_Click(object sender, RoutedEventArgs e)
        {
            OpenFileDialog openFileDialog = new OpenFileDialog
            {
                Filter = "Image files (*.png;*.jpeg;*.jpg)|*.png;*.jpeg;*.jpg"
            };
            if (openFileDialog.ShowDialog() == true)
            {
                string filePath = openFileDialog.FileName;
                _newAvatarFilePath = filePath;
                SetAvatar(_newAvatarFilePath);
            }
        }
        #endregion

        #region Logic Panel Đổi Mật Khẩu
        // (Vùng này giữ nguyên, bao gồm logic "hiển thị mật khẩu")
        private async void BtnXacNhanDoiMatKhau_Click(object sender, RoutedEventArgs e)
        {
            string mkCu = chkShowPassword.IsChecked == true ? txtVisibleMatKhauCu.Text : txtMatKhauCu.Password;
            string mkMoi = chkShowPassword.IsChecked == true ? txtVisibleMatKhauMoi.Text : txtMatKhauMoi.Password;
            string xacNhan = chkShowPassword.IsChecked == true ? txtVisibleXacNhanMatKhau.Text : txtXacNhanMatKhau.Password;

            if (string.IsNullOrEmpty(mkCu) || string.IsNullOrEmpty(mkMoi))
            {
                MessageBox.Show("Vui lòng nhập đầy đủ mật khẩu.", "Thiếu thông tin"); return;
            }
            if (mkMoi != xacNhan)
            {
                MessageBox.Show("Mật khẩu mới và xác nhận không khớp.", "Lỗi"); return;
            }

            var request = new DoiMatKhauRequestDto { MatKhauCu = mkCu, MatKhauMoi = mkMoi };
            btnXacNhanDoiMatKhau.IsEnabled = false;

            try
            {
                var response = await ApiClient.Instance.PostAsJsonAsync("api/app/nhanvien/thongtincanhan/change-password", request);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Đổi mật khẩu thành công!", "Thành công");
                    ClearPasswordFields();
                    ShowPanel("LichSu");
                }
                else
                {
                    string loi = await response.Content.ReadAsStringAsync();
                    MessageBox.Show($"Lỗi: {loi}", "Đổi mật khẩu thất bại");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            btnXacNhanDoiMatKhau.IsEnabled = true;
        }
        private void BtnHuyDoiMatKhau_Click(object sender, RoutedEventArgs e)
        {
            ClearPasswordFields();
            ShowPanel("LichSu");
        }
        private void ClearPasswordFields()
        {
            txtMatKhauCu.Password = "";
            txtMatKhauMoi.Password = "";
            txtXacNhanMatKhau.Password = "";
            txtVisibleMatKhauCu.Text = "";
            txtVisibleMatKhauMoi.Text = "";
            txtVisibleXacNhanMatKhau.Text = "";
            if (chkShowPassword != null)
                chkShowPassword.IsChecked = false;
        }
        private void ChkShowPassword_Checked(object sender, RoutedEventArgs e)
        {
            txtVisibleMatKhauCu.Text = txtMatKhauCu.Password;
            txtVisibleMatKhauMoi.Text = txtMatKhauMoi.Password;
            txtVisibleXacNhanMatKhau.Text = txtXacNhanMatKhau.Password;
            txtVisibleMatKhauCu.Visibility = Visibility.Visible;
            txtVisibleMatKhauMoi.Visibility = Visibility.Visible;
            txtVisibleXacNhanMatKhau.Visibility = Visibility.Visible;
            txtMatKhauCu.Visibility = Visibility.Collapsed;
            txtMatKhauMoi.Visibility = Visibility.Collapsed;
            txtXacNhanMatKhau.Visibility = Visibility.Collapsed;
        }
        private void ChkShowPassword_Unchecked(object sender, RoutedEventArgs e)
        {
            txtMatKhauCu.Password = txtVisibleMatKhauCu.Text;
            txtMatKhauMoi.Password = txtVisibleMatKhauMoi.Text;
            txtXacNhanMatKhau.Password = txtVisibleXacNhanMatKhau.Text;
            txtVisibleMatKhauCu.Visibility = Visibility.Collapsed;
            txtVisibleMatKhauMoi.Visibility = Visibility.Collapsed;
            txtVisibleXacNhanMatKhau.Visibility = Visibility.Collapsed;
            txtMatKhauCu.Visibility = Visibility.Visible;
            txtMatKhauMoi.Visibility = Visibility.Visible;
            txtXacNhanMatKhau.Visibility = Visibility.Visible;
        }
        private void TxtMatKhauCu_PasswordChanged(object sender, RoutedEventArgs e)
        {
            if (chkShowPassword.IsChecked == true)
                txtVisibleMatKhauCu.Text = txtMatKhauCu.Password;
        }
        private void TxtVisibleMatKhauCu_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (chkShowPassword.IsChecked == false)
                txtMatKhauCu.Password = txtVisibleMatKhauCu.Text;
        }
        private void TxtMatKhauMoi_PasswordChanged(object sender, RoutedEventArgs e)
        {
            if (chkShowPassword.IsChecked == true)
                txtVisibleMatKhauMoi.Text = txtMatKhauMoi.Password;
        }
        private void TxtVisibleMatKhauMoi_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (chkShowPassword.IsChecked == false)
                txtMatKhauMoi.Password = txtVisibleMatKhauMoi.Text;
        }
        private void TxtXacNhanMatKhau_PasswordChanged(object sender, RoutedEventArgs e)
        {
            if (chkShowPassword.IsChecked == true)
                txtVisibleXacNhanMatKhau.Text = txtXacNhanMatKhau.Password;
        }
        private void TxtVisibleXacNhanMatKhau_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (chkShowPassword.IsChecked == false)
                txtXacNhanMatKhau.Password = txtVisibleXacNhanMatKhau.Text;
        }
        #endregion

        #region Logic Panel Viết Đơn (Đã cập nhật)
        /*
        private async void BtnGuiDon_Click(object sender, RoutedEventArgs e)
        {
            // SỬA: Xóa kiểm tra cmbLoaiDon
            if (dpNgayBatDau.SelectedDate == null ||
                dpNgayKetThuc.SelectedDate == null ||
                string.IsNullOrEmpty(txtLyDo.Text))
            {
                MessageBox.Show("Vui lòng nhập đầy đủ thông tin (Ngày bắt đầu, kết thúc và lý do).", "Thiếu thông tin"); return;
            }
            var ngayBatDau = dpNgayBatDau.SelectedDate.Value;
            var ngayKetThuc = dpNgayKetThuc.SelectedDate.Value;
            if (ngayKetThuc < ngayBatDau)
            {
                MessageBox.Show("Ngày kết thúc không thể trước ngày bắt đầu.", "Lỗi"); return;
            }

            // SỬA: Gán "LoaiDon" là một giá trị chung
            var request = new DonXinNghiRequestDto
            {
                LoaiDon = "Đơn xin nghỉ", // Giá trị chung
                LyDo = txtLyDo.Text,
                NgayBatDau = ngayBatDau,
                NgayKetThuc = ngayKetThuc
            };

            btnGuiDon.IsEnabled = false;
            try
            {
                var response = await ApiClient.Instance.PostAsJsonAsync("api/app/nhanvien/thongtincanhan/submit-leave", request);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Gửi đơn thành công!", "Thành công");
                    // SỬA: Xóa cmbLoaiDon
                    dpNgayBatDau.SelectedDate = DateTime.Today;
                    dpNgayKetThuc.SelectedDate = DateTime.Today;
                    txtLyDo.Text = "";
                    await LoadDataAsync();
                    ShowPanel("LichSu");
                }
                else
                {
                    string loi = await response.Content.ReadAsStringAsync();
                    MessageBox.Show($"Lỗi: {loi}", "Gửi đơn thất bại");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            btnGuiDon.IsEnabled = true;
        }
        
        private void BtnHuyGuiDon_Click(object sender, RoutedEventArgs e)
        {
            // SỬA: Xóa cmbLoaiDon
            dpNgayBatDau.SelectedDate = DateTime.Today;
            dpNgayKetThuc.SelectedDate = DateTime.Today;
            txtLyDo.Text = "";
            ShowPanel("LichSu");
        }
        */
        #endregion
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\ThueSachView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.nhanvien.pages.ThueSachView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.nhanvien.pages"
      mc:Ignorable="d" 
      d:DesignHeight="750" d:DesignWidth="1200"
      Title="ThueSachView"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>

        <Style x:Key="ActionButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,10"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style x:Key="DeleteButton" TargetType="Button" BasedOn="{StaticResource ActionButton}">
            <Setter Property="Background" Value="{StaticResource ErrorBrush}"/>
        </Style>
        <Style x:Key="MaterialTextBox" TargetType="TextBox">
            <Setter Property="Padding" Value="8,10"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
        </Style>
        <Style TargetType="Label">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,10,0,3"/>
        </Style>
    </Page.Resources>

    <Grid Margin="10">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="350"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="380"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Background="White" CornerRadius="8" Padding="15" Margin="0,0,10,0">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <TextBlock Text="Tạo Phiếu Thuê Mới" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}"/>

                    <Label Content="Tên Khách Hàng (*)"/>
                    <TextBox x:Name="txtHoTenKH" Style="{StaticResource MaterialTextBox}" TextChanged="TxtKhachInfo_TextChanged"/>

                    <Label Content="Số Điện Thoại (Nếu có)"/>
                    <TextBox x:Name="txtSdtKH" Style="{StaticResource MaterialTextBox}"
                             ToolTip="Nếu SĐT đã tồn tại, phiếu sẽ tự động gán cho khách cũ."
                             TextChanged="TxtKhachInfo_TextChanged"/>

                    <Label Content="Email (Nếu có)"/>
                    <TextBox x:Name="txtEmailKH" Style="{StaticResource MaterialTextBox}"/>

                    <ListBox x:Name="lbKhachHangResults" MaxHeight="100" 
                             SelectionChanged="LbKhachHangResults_SelectionChanged"
                             Visibility="Collapsed" Margin="0,5,0,0">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Margin="5">
                                    <TextBlock Text="{Binding HoTen}" FontWeight="SemiBold"/>
                                    <TextBlock Text="{Binding SoDienThoai}" Foreground="Gray" FontSize="11"/>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <Label Content="Tìm Sách (ID / Tên)"/>
                    <TextBox x:Name="txtSearchSach" Style="{StaticResource MaterialTextBox}" TextChanged="TxtSearchSach_TextChanged"/>
                    <ListBox x:Name="lbSachResults" MaxHeight="100" SelectionChanged="LbSachResults_SelectionChanged">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock>
                                    <Run Text="{Binding TenSach}"/>
                                    <Run Text="(Còn: "/>
                                    <Run Text="{Binding SoLuongHienCo}"/>
                                    <Run Text=")" Foreground="Gray"/>
                                </TextBlock>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <Label Content="Sách chọn thuê"/>
                    <DataGrid x:Name="dgSachChon" AutoGenerateColumns="False" MaxHeight="150" IsReadOnly="True" CanUserAddRows="False">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Tên Sách" Binding="{Binding TenSach}" Width="*"/>
                            <DataGridTextColumn Header="Tiền Cọc" Binding="{Binding GiaBia, StringFormat=N0}" Width="Auto"/>
                        </DataGrid.Columns>
                    </DataGrid>
                    <Button Content="Xóa sách chọn" Style="{StaticResource DeleteButton}" Padding="8,4" FontSize="12" HorizontalAlignment="Right" Margin="0,5,0,0" Click="BtnXoaSachChon_Click"/>

                    <Label Content="Ngày hẹn trả"/>
                    <DatePicker x:Name="dpNgayHenTra"/>

                    <Border Background="{StaticResource SubtleGrayBrush}" CornerRadius="5" Padding="10" Margin="0,15,0,0">
                        <StackPanel>
                            <TextBlock Text="Tổng Tiền Cọc:" FontWeight="SemiBold"/>
                            <TextBlock x:Name="lblTongCoc" Text="0 đ" FontSize="16" FontWeight="Bold" Foreground="{StaticResource PrimaryBrownBrush}" Margin="0,5,0,0"/>
                            <TextBlock Text="Phí thuê (tạm tính):" FontWeight="SemiBold" Margin="0,5,0,0"/>
                            <TextBlock x:Name="lblPhiThue" Text="0 đ" FontSize="16" FontWeight="Bold" Foreground="{StaticResource PrimaryBrownBrush}" Margin="0,5,0,0"/>
                        </StackPanel>
                    </Border>

                    <Button x:Name="btnTaoPhieuThue" Content="Tạo Phiếu Thuê" Style="{StaticResource ActionButton}" Background="{StaticResource SuccessBrush}" Margin="0,20,0,0" Click="BtnTaoPhieuThue_Click"/>
                </StackPanel>
            </ScrollViewer>
        </Border>

        <Border Grid.Column="1" Background="White" CornerRadius="8" Padding="15">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                    <TextBlock Text="Tìm Phiếu (ID/Tên/SĐT):" VerticalAlignment="Center" Margin="0,0,5,0" FontWeight="SemiBold"/>
                    <TextBox x:Name="txtSearchPhieuThue" Style="{StaticResource MaterialTextBox}" Width="200" TextChanged="TxtSearchPhieuThue_TextChanged"/>

                    <TextBlock Text="Trạng Thái:" VerticalAlignment="Center" Margin="10,0,5,0" FontWeight="SemiBold"/>
                    <ComboBox x:Name="cmbTrangThaiFilter" Width="120" SelectionChanged="CmbTrangThaiFilter_SelectionChanged">
                        <ComboBoxItem Content="Đang Thuê" IsSelected="True"/>
                        <ComboBoxItem Content="Đã Trả"/>
                        <ComboBoxItem Content="Tất cả"/>
                    </ComboBox>
                </StackPanel>

                <Button x:Name="btnGuiNhacHangLoat" Grid.Row="1" Content="Gửi Email Nhắc Hẹn Hàng Loạt (Sắp trễ)" Style="{StaticResource ActionButton}" 
                        Background="#FFB300" Foreground="{StaticResource DarkBrownBrush}"
                        Padding="10,5" Margin="0,0,0,10" Click="BtnGuiNhacHangLoat_Click"/>

                <TabControl Grid.Row="2" x:Name="TabPhieu">
                    <TabItem Header="Phiếu Đang Thuê / Trễ Hạn">
                        <DataGrid x:Name="dgPhieuThue" IsReadOnly="True" AutoGenerateColumns="False" CanUserAddRows="False"
                                  SelectionChanged="DgPhieuThue_SelectionChanged"
                                  LoadingRow="DgPhieuThue_LoadingRow">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ID Phiếu" Binding="{Binding IdPhieuThueSach}" Width="70"/>
                                <DataGridTextColumn Header="Khách Hàng" Binding="{Binding HoTenKH}" Width="*"/>
                                <DataGridTextColumn Header="SĐT" Binding="{Binding SoDienThoaiKH}" Width="100"/>
                                <DataGridTextColumn Header="Ngày Hẹn Trả" Binding="{Binding NgayHenTra, StringFormat='dd/MM/yyyy'}" Width="100"/>
                                <DataGridTextColumn Header="SL Sách" Binding="{Binding SoLuongSach}" Width="70"/>
                                <DataGridTextColumn Header="Tình Trạng" Binding="{Binding TinhTrang}" Width="100"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </TabItem>

                    <TabItem Header="Lịch Sử Trả Sách">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,5,0,10">
                                <TextBlock Text="Tìm Phiếu (ID Trả / ID Thuê):" VerticalAlignment="Center" Margin="0,0,5,0" FontWeight="SemiBold"/>
                                <TextBox x:Name="txtSearchPhieuTra" Style="{StaticResource MaterialTextBox}" Width="200" TextChanged="TxtSearchPhieuTra_TextChanged"/>
                            </StackPanel>

                            <DataGrid Grid.Row="1" x:Name="dgPhieuTra" IsReadOnly="True" AutoGenerateColumns="False" CanUserAddRows="False">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="ID Trả" Binding="{Binding IdPhieuTra}" Width="70"/>
                                    <DataGridTextColumn Header="ID Thuê" Binding="{Binding IdPhieuThueSach}" Width="70"/>
                                    <DataGridTextColumn Header="Ngày Trả" Binding="{Binding NgayTra, StringFormat='dd/MM/yyyy HH:mm'}" Width="120"/>
                                    <DataGridTextColumn Header="Nhân Viên" Binding="{Binding TenNhanVien}" Width="*"/>
                                    <DataGridTextColumn Header="Tiền Hoàn" Binding="{Binding TongHoanTra, StringFormat=N0}" Width="100"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </TabItem>
                </TabControl>
            </Grid>
        </Border>

        <Border Grid.Column="2" Background="White" CornerRadius="8" Padding="15" Margin="10,0,0,0">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel x:Name="panelChiTietPhieu" Visibility="Collapsed">
                    <TextBlock Text="Chi Tiết Phiếu" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}"/>
                    <TextBlock x:Name="lblTenKH_ChiTiet" Text="Nguyễn Văn A" FontWeight="SemiBold" Margin="0,5,0,0"/>
                    <TextBlock x:Name="lblSdtKH_ChiTiet" Text="0909123456" Foreground="Gray"/>

                    <StackPanel x:Name="panelTraSach">
                        <Label Content="Sách trong phiếu (Chọn để trả)"/>
                        <DataGrid x:Name="dgSachTra" AutoGenerateColumns="False" MaxHeight="250" 
                                  SelectionMode="Extended" CanUserAddRows="False">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Tên Sách" Binding="{Binding TenSach}" Width="*"/>
                                <DataGridTextColumn Header="Tiền Phạt" Binding="{Binding TienPhat, StringFormat=N0}" Width="Auto"/>
                                <DataGridTextColumn Header="Tình Trạng" Binding="{Binding TinhTrang}" Width="100"/>
                            </DataGrid.Columns>
                        </DataGrid>

                        <Border Background="{StaticResource SubtleGrayBrush}" CornerRadius="5" Padding="10" Margin="0,15,0,0">
                            <StackPanel>
                                <TextBlock Text="Tổng Tiền Phạt (sách đã chọn):" FontWeight="SemiBold"/>
                                <TextBlock x:Name="lblTongPhat" Text="0 đ" FontSize="16" FontWeight="Bold" Foreground="{StaticResource ErrorBrush}" Margin="0,5,0,0"/>
                                <TextBlock Text="Tổng Phí Thuê (sách đã chọn):" FontWeight="SemiBold" Margin="0,5,0,0"/>
                                <TextBlock x:Name="lblTongPhiThue_Tra" Text="0 đ" FontSize="16" FontWeight="Bold" Foreground="{StaticResource PrimaryBrownBrush}" Margin="0,5,0,0"/>
                                <TextBlock Text="Tổng Cọc Hoàn Trả (sách đã chọn):" FontWeight="SemiBold" Margin="0,5,0,0"/>
                                <TextBlock x:Name="lblTongCoc_Tra" Text="0 đ" FontSize="16" FontWeight="Bold" Foreground="{StaticResource SuccessBrush}" Margin="0,5,0,0"/>
                            </StackPanel>
                        </Border>

                        <Button x:Name="btnXacNhanTra" Content="Xác Nhận Trả Sách (Đã chọn)" Style="{StaticResource ActionButton}" Margin="0,15,0,0" Click="BtnXacNhanTra_Click"/>
                    </StackPanel>

                    <Separator Margin="0,20"/>

                    <Button x:Name="btnGuiNhacHen" Content="Gửi Email Nhắc Hẹn" Style="{StaticResource ActionButton}" 
                            Background="{StaticResource TextGrayBrush}" Padding="10,5" Click="BtnGuiNhacHen_Click"
                            Visibility="Collapsed"/>

                    <Button x:Name="btnInPhieu" Content="In Phiếu Thuê" Style="{StaticResource ActionButton}" 
                            Background="#42A5F5" Padding="10,5" Margin="0,10,0,0" Click="BtnInPhieu_Click"/>

                </StackPanel>
            </ScrollViewer>
        </Border>

        <Border x:Name="LoadingOverlay" Grid.ColumnSpan="3" Background="#80FFFFFF" Visibility="Collapsed">
            <TextBlock Text="Đang xử lý..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\ThueSachView.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media;
using CafebookModel.Model.ModelApp.NhanVien;
using AppCafebookApi.View.common;
using System.Windows.Threading;
using System.Text.Json;
using System.Diagnostics;
using AppCafebookApi.Services;

namespace AppCafebookApi.View.nhanvien.pages
{
    public partial class ThueSachView : Page
    {
        private static readonly HttpClient httpClient;
        private CaiDatThueSachDto _settings = new();

        private PhieuThueChiTietDto? _selectedPhieuChiTiet;

        private DispatcherTimer _searchKhachTimer;
        private DispatcherTimer _searchSachTimer;
        private DispatcherTimer _searchPhieuTraTimer;

        private bool _isUpdatingKhachText = false;

        static ThueSachView()
        {
            httpClient = new HttpClient { BaseAddress = new Uri("http://127.0.0.1:5166") };
        }

        public ThueSachView()
        {
            InitializeComponent();

            _searchKhachTimer = new DispatcherTimer { Interval = TimeSpan.FromMilliseconds(500) };
            _searchKhachTimer.Tick += async (s, e) => { _searchKhachTimer.Stop(); await SearchKhachHangAsync(); };

            _searchSachTimer = new DispatcherTimer { Interval = TimeSpan.FromMilliseconds(500) };
            _searchSachTimer.Tick += async (s, e) => { _searchSachTimer.Stop(); await SearchSachAsync(); };

            _searchPhieuTraTimer = new DispatcherTimer { Interval = TimeSpan.FromMilliseconds(500) };
            _searchPhieuTraTimer.Tick += async (s, e) => { _searchPhieuTraTimer.Stop(); await LoadPhieuTraAsync(); };
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            await LoadSettingsAsync();
            await LoadPhieuThueAsync();
            await LoadPhieuTraAsync();
            LoadingOverlay.Visibility = Visibility.Collapsed;
        }

        // (LoadSettingsAsync, LoadPhieuThueAsync, LoadPhieuTraAsync giữ nguyên)
        // ... (Giữ nguyên các hàm này) ...
        private async Task LoadSettingsAsync()
        {
            try
            {
                _settings = await httpClient.GetFromJsonAsync<CaiDatThueSachDto>("api/app/nhanvien/thuesach/settings") ?? new();
                dpNgayHenTra.SelectedDate = DateTime.Today.AddDays(_settings.SoNgayMuonToiDa);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải cài đặt: {ex.Message}", "Lỗi API");
            }
        }
        private async Task LoadPhieuThueAsync()
        {
            try
            {
                string search = txtSearchPhieuThue.Text;
                string status = (cmbTrangThaiFilter.SelectedItem as ComboBoxItem)?.Content.ToString() ?? "Đang Thuê";

                var phieuList = await httpClient.GetFromJsonAsync<List<PhieuThueGridDto>>($"api/app/nhanvien/thuesach/phieuthue?search={Uri.EscapeDataString(search)}&status={Uri.EscapeDataString(status)}");
                dgPhieuThue.ItemsSource = phieuList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải danh sách phiếu thuê: {ex.Message}", "Lỗi API");
            }
        }
        private async Task LoadPhieuTraAsync()
        {
            try
            {
                string search = txtSearchPhieuTra.Text;
                var phieuTraList = await httpClient.GetFromJsonAsync<List<PhieuTraGridDto>>($"api/app/nhanvien/thuesach/phieutra?search={Uri.EscapeDataString(search)}");
                dgPhieuTra.ItemsSource = phieuTraList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải lịch sử phiếu trả: {ex.Message}", "Lỗi API");
            }
        }

        #region CỘT 1: TẠO PHIẾU

        private void TxtKhachInfo_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (_isUpdatingKhachText) return;
            _searchKhachTimer.Stop();
            _searchKhachTimer.Start();
        }

        private async Task SearchKhachHangAsync()
        {
            string query = !string.IsNullOrWhiteSpace(txtSdtKH.Text) ? txtSdtKH.Text : txtHoTenKH.Text;

            if (string.IsNullOrWhiteSpace(query))
            {
                lbKhachHangResults.ItemsSource = null;
                lbKhachHangResults.Visibility = Visibility.Collapsed;
                return;
            }
            try
            {
                var results = await httpClient.GetFromJsonAsync<List<KhachHangSearchDto>>($"api/app/nhanvien/thuesach/search-khachhang?query={query}");
                if (results != null && results.Any())
                {
                    lbKhachHangResults.ItemsSource = results;
                    lbKhachHangResults.Visibility = Visibility.Visible;
                }
                else
                {
                    lbKhachHangResults.Visibility = Visibility.Collapsed;
                }
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"Lỗi tìm khách: {ex.Message}");
            }
        }

        private void LbKhachHangResults_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (lbKhachHangResults.SelectedItem is KhachHangSearchDto selected)
            {
                _isUpdatingKhachText = true;

                txtHoTenKH.Text = selected.HoTen;
                txtSdtKH.Text = selected.SoDienThoai;
                txtEmailKH.Text = selected.Email;

                _isUpdatingKhachText = false;

                lbKhachHangResults.Visibility = Visibility.Collapsed;
                lbKhachHangResults.ItemsSource = null;
            }
        }

        // (Các hàm Tìm Sách: TxtSearchSach_TextChanged, SearchSachAsync, LbSachResults_SelectionChanged, BtnXoaSachChon_Click, UpdateTongCoc giữ nguyên)
        // ...
        private void TxtSearchSach_TextChanged(object sender, TextChangedEventArgs e) { _searchSachTimer.Stop(); _searchSachTimer.Start(); }
        private async Task SearchSachAsync()
        {
            if (string.IsNullOrEmpty(txtSearchSach.Text))
            {
                lbSachResults.ItemsSource = null;
                return;
            }
            try
            {
                var results = await httpClient.GetFromJsonAsync<List<SachTimKiemDto>>($"api/app/nhanvien/thuesach/search-sach?query={txtSearchSach.Text}");
                lbSachResults.ItemsSource = results;
            }
            catch { /* Bỏ qua lỗi tìm kiếm */ }
        }
        private void LbSachResults_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (lbSachResults.SelectedItem is SachTimKiemDto selectedSach)
            {
                var currentList = (dgSachChon.ItemsSource as List<SachTimKiemDto>) ?? new List<SachTimKiemDto>();
                if (!currentList.Any(s => s.IdSach == selectedSach.IdSach))
                {
                    currentList.Add(selectedSach);
                    dgSachChon.ItemsSource = null;
                    dgSachChon.ItemsSource = currentList;
                    UpdateTongCoc();
                }
                txtSearchSach.Text = "";
                lbSachResults.ItemsSource = null;
            }
        }
        private void BtnXoaSachChon_Click(object sender, RoutedEventArgs e)
        {
            if (dgSachChon.SelectedItem is SachTimKiemDto selected && dgSachChon.ItemsSource is List<SachTimKiemDto> currentList)
            {
                currentList.Remove(selected);
                dgSachChon.ItemsSource = null;
                dgSachChon.ItemsSource = currentList;
                UpdateTongCoc();
            }
        }
        private void UpdateTongCoc()
        {
            var currentList = (dgSachChon.ItemsSource as List<SachTimKiemDto>) ?? new List<SachTimKiemDto>();
            decimal tongCoc = currentList.Sum(s => s.GiaBia);
            decimal phiThue = currentList.Count * _settings.PhiThue;
            lblTongCoc.Text = $"{tongCoc:N0} đ";
            lblPhiThue.Text = $"{phiThue:N0} đ";
        }


        /// <summary>
        /// SỬA LỖI (BUG 1) & CẢI TIẾN (MessageBox)
        /// </summary>
        private async void BtnTaoPhieuThue_Click(object sender, RoutedEventArgs e)
        {
            // CẢI TIẾN: Thêm hộp thoại xác nhận
            var confirm = MessageBox.Show("Xác nhận thuê sách này?", "Xác nhận", MessageBoxButton.YesNo, MessageBoxImage.Question);
            if (confirm == MessageBoxResult.No)
            {
                return;
            }

            var request = new PhieuThueRequestDto();

            // SỬA LỖI (BUG 1): Dùng AuthService.CurrentUser.IdNhanVien
            if (AuthService.CurrentUser == null)
            {
                MessageBox.Show("Lỗi: Không xác định được nhân viên. Vui lòng đăng nhập lại.", "Lỗi Phiên");
                return;
            }
            request.IdNhanVien = AuthService.CurrentUser.IdNhanVien;

            if (string.IsNullOrWhiteSpace(txtHoTenKH.Text))
            {
                MessageBox.Show("Tên khách hàng là bắt buộc.", "Lỗi");
                return;
            }

            request.KhachHangInfo = new KhachHangInfoDto
            {
                HoTen = txtHoTenKH.Text,
                SoDienThoai = string.IsNullOrWhiteSpace(txtSdtKH.Text) ? null : txtSdtKH.Text,
                Email = string.IsNullOrWhiteSpace(txtEmailKH.Text) ? null : txtEmailKH.Text
            };

            var sachList = (dgSachChon.ItemsSource as List<SachTimKiemDto>);
            if (sachList == null || !sachList.Any())
            {
                MessageBox.Show("Vui lòng chọn ít nhất 1 cuốn sách để thuê.", "Lỗi"); return;
            }
            request.SachCanThue = sachList.Select(s => new SachThueRequestDto { IdSach = s.IdSach, TienCoc = s.GiaBia }).ToList();
            request.NgayHenTra = dpNgayHenTra.SelectedDate ?? DateTime.Today.AddDays(_settings.SoNgayMuonToiDa);

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/nhanvien/thuesach", request);
                if (response.IsSuccessStatusCode)
                {
                    var jsonDoc = JsonDocument.Parse(await response.Content.ReadAsStringAsync());
                    var root = jsonDoc.RootElement;
                    int idPhieu = root.GetProperty("idPhieuThueSach").GetInt32();

                    // Xóa MessageBox

                    ResetFormTaoPhieu();
                    await LoadPhieuThueAsync();

                    var printWindow = new PhieuThuePreviewWindow(idPhieu);
                    printWindow.ShowDialog();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}\n\nChi tiết: {ex.InnerException?.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void ResetFormTaoPhieu()
        {
            _isUpdatingKhachText = true;
            txtHoTenKH.Text = "";
            txtSdtKH.Text = "";
            txtEmailKH.Text = "";
            _isUpdatingKhachText = false;

            lbKhachHangResults.ItemsSource = null;
            lbKhachHangResults.Visibility = Visibility.Collapsed;

            txtSearchSach.Text = "";
            lbSachResults.ItemsSource = null;
            dgSachChon.ItemsSource = null;
            dpNgayHenTra.SelectedDate = DateTime.Today.AddDays(_settings.SoNgayMuonToiDa);
            UpdateTongCoc();
        }

        #endregion

        #region CỘT 2: DANH SÁCH

        private async void TxtSearchPhieuThue_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (!IsLoaded) return;
            await LoadPhieuThueAsync();
        }

        private async void CmbTrangThaiFilter_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (!IsLoaded) return;
            await LoadPhieuThueAsync();
        }

        private void TxtSearchPhieuTra_TextChanged(object sender, TextChangedEventArgs e)
        {
            _searchPhieuTraTimer.Stop();
            _searchPhieuTraTimer.Start();
        }

        private async void DgPhieuThue_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgPhieuThue.SelectedItem is PhieuThueGridDto selectedPhieu)
            {
                LoadingOverlay.Visibility = Visibility.Visible;
                try
                {
                    _selectedPhieuChiTiet = await httpClient.GetFromJsonAsync<PhieuThueChiTietDto>($"api/app/nhanvien/thuesach/chitiet/{selectedPhieu.IdPhieuThueSach}");
                    if (_selectedPhieuChiTiet != null)
                    {
                        panelChiTietPhieu.Visibility = Visibility.Visible;
                        lblTenKH_ChiTiet.Text = _selectedPhieuChiTiet.HoTenKH;
                        lblSdtKH_ChiTiet.Text = _selectedPhieuChiTiet.SoDienThoaiKH;

                        var sachChuaTra = _selectedPhieuChiTiet.SachDaThue.Where(s => !s.TinhTrang.Contains("Đã Trả")).ToList();
                        dgSachTra.ItemsSource = sachChuaTra;

                        if (selectedPhieu.TrangThai == "Đã Trả")
                        {
                            panelTraSach.Visibility = Visibility.Collapsed;
                        }
                        else
                        {
                            panelTraSach.Visibility = Visibility.Visible;
                            dgSachTra.SelectAll();
                            UpdateTraSachSummary();
                        }

                        bool sapTre = sachChuaTra.Any(s => (s.NgayHenTra.Date - DateTime.Today).TotalDays == 1);
                        btnGuiNhacHen.Visibility = (sapTre && selectedPhieu.TrangThai == "Đang Thuê") ? Visibility.Visible : Visibility.Collapsed;
                    }
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Lỗi tải chi tiết: {ex.Message}", "Lỗi API");
                    panelChiTietPhieu.Visibility = Visibility.Collapsed;
                }
                finally
                {
                    LoadingOverlay.Visibility = Visibility.Collapsed;
                }
            }
            else
            {
                panelChiTietPhieu.Visibility = Visibility.Collapsed;
                _selectedPhieuChiTiet = null;
            }
        }

        private void DgPhieuThue_LoadingRow(object sender, DataGridRowEventArgs e)
        {
            if (e.Row.DataContext is PhieuThueGridDto item)
            {
                if (item.TinhTrang == "Trễ Hạn")
                {
                    e.Row.Background = new SolidColorBrush(Color.FromArgb(50, 239, 83, 80));
                    e.Row.ToolTip = "Phiếu này đã trễ hạn trả sách.";
                }
                else
                {
                    e.Row.Background = Brushes.Transparent;
                    e.Row.ToolTip = null;
                }
            }
        }

        private async void BtnGuiNhacHangLoat_Click(object sender, RoutedEventArgs e)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsync("api/app/nhanvien/thuesach/send-all-reminders", null);
                if (response.IsSuccessStatusCode)
                {
                    var jsonDoc = JsonDocument.Parse(await response.Content.ReadAsStringAsync());
                    MessageBox.Show(jsonDoc.RootElement.GetProperty("message").GetString(), "Thành công");
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion

        #region CỘT 3: TRẢ SÁCH

        private void UpdateTraSachSummary()
        {
            var selectedSach = dgSachTra.SelectedItems.OfType<ChiTietSachThueDto>().ToList();
            decimal tongPhat = selectedSach.Sum(s => s.TienPhat);
            decimal tongCoc = selectedSach.Sum(s => s.TienCoc);
            decimal tongPhi = selectedSach.Count * _settings.PhiThue;

            lblTongPhat.Text = $"{tongPhat:N0} đ";
            lblTongPhiThue_Tra.Text = $"{tongPhi:N0} đ";
            lblTongCoc_Tra.Text = $"{tongCoc:N0} đ";
        }

        /// <summary>
        /// SỬA LỖI (BUG 1) & CẢI TIẾN (MessageBox, F3)
        /// </summary>
        private async void BtnXacNhanTra_Click(object sender, RoutedEventArgs e)
        {
            // CẢI TIẾN: Thêm hộp thoại xác nhận
            var confirm = MessageBox.Show("Xác nhận trả sách này?", "Xác nhận", MessageBoxButton.YesNo, MessageBoxImage.Question);
            if (confirm == MessageBoxResult.No)
            {
                return;
            }

            if (_selectedPhieuChiTiet == null || dgSachTra.SelectedItems.Count == 0)
            {
                MessageBox.Show("Vui lòng chọn ít nhất 1 cuốn sách để trả.", "Lỗi");
                return;
            }

            var selectedSach = dgSachTra.SelectedItems.OfType<ChiTietSachThueDto>().ToList();

            // SỬA LỖI (BUG 1): Dùng AuthService.CurrentUser.IdNhanVien
            if (AuthService.CurrentUser == null)
            {
                MessageBox.Show("Lỗi: Không xác định được nhân viên. Vui lòng đăng nhập lại.", "Lỗi Phiên");
                return;
            }

            var request = new TraSachRequestDto
            {
                IdPhieuThueSach = _selectedPhieuChiTiet.IdPhieuThueSach,
                IdSachs = selectedSach.Select(s => s.IdSach).ToList(),
                IdNhanVien = AuthService.CurrentUser.IdNhanVien
            };

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/nhanvien/thuesach/return", request);
                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<TraSachResponseDto>();

                    // Xóa MessageBox

                    await LoadPhieuThueAsync();
                    await LoadPhieuTraAsync();
                    panelChiTietPhieu.Visibility = Visibility.Collapsed;

                    var printWindow = new PhieuTraPreviewWindow(result.IdPhieuTra);
                    printWindow.ShowDialog();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnGuiNhacHen_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedPhieuChiTiet == null) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsync($"api/app/nhanvien/thuesach/send-reminder/{_selectedPhieuChiTiet.IdPhieuThueSach}", null);
                if (response.IsSuccessStatusCode)
                {
                    var jsonDoc = JsonDocument.Parse(await response.Content.ReadAsStringAsync());
                    MessageBox.Show(jsonDoc.RootElement.GetProperty("message").GetString(), "Thành công");
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnInPhieu_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedPhieuChiTiet == null) return;

            var printWindow = new PhieuThuePreviewWindow(_selectedPhieuChiTiet.IdPhieuThueSach);
            printWindow.ShowDialog();
        }

        #endregion
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\ManHinhQuanly.xaml
================================================================================
﻿<Window x:Class="AppCafebookApi.View.quanly.ManHinhQuanly"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AppCafebookApi.View.quanly"
        mc:Ignorable="d" 
        Title="Cafebook - Copyright by © Lâm Chu Bảo Toàn | Contact: [lamchubaotoan@gmail.com]" Height="800" Width="1440"
        WindowStartupLocation="CenterScreen"
        FontFamily="Segoe UI"
        WindowState="Maximized"
        Loaded="Window_Loaded">

    <Window.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="SubtleWhiteTextBrush" Color="#BCAAA4"/>
        <SolidColorBrush x:Key="HoverBrownBrush" Color="#8D6E63"/>

        <Geometry x:Key="IconDashboard">M13,3V9H21V3M13,21H21V11H13M3,21H11V15H3M3,13H11V3H3V13Z</Geometry>
        <Geometry x:Key="IconCoffee">M16,5H14V3H12V5H10A3,3 0 0,0 7,8V14H18V8A3,3 0 0,0 15,5M20,19H4V17H20V19Z</Geometry>
        <Geometry x:Key="IconTable">M4,6H20V8H4V6M4,10H20V12H4V10M4,14H20V16H4V14M4,18H20V20H4V18Z</Geometry>
        <Geometry x:Key="IconWarehouse">M12,3L2,8V21H22V8L12,3M19,19H15V13H9V19H5V9.4L12,5.5L19,9.4V19Z</Geometry>
        <Geometry x:Key="IconOrder">M17,17H7V15H17M17,13H7V11H17M17,9H7V7H17M19,3H5C3.9,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.9 20.1,3 19,3Z</Geometry>
        <Geometry x:Key="IconBook">M18,2H6C4.9,2 4,2.9 4,4V20C4,21.1 4.9,22 6,22H18C19.1,22 20,21.1 20,20V4C20,2.9 19.1,2 18,2M11,4H13V12L11,10.8L9,12V4H11Z</Geometry>
        <Geometry x:Key="IconUsers">M16,13C17.7,13 21,13.9 21,15.5V17H11V15.5C11,13.9 14.3,13 16,13M8,13C9.7,13 13,13.9 13,15.5V17H3V15.5C3,13.9 6.3,13 8,13M8,11.5A3.5,3.5 0 0,0 11.5,8A3.5,3.5 0 0,0 8,4.5A3.5,3.5 0 0,0 4.5,8A3.5,3.5 0 0,0 8,11.5M16,11.5A3.5,3.5 0 0,0 19.5,8A3.5,3.5 0 0,0 16,4.5A3.5,3.5 0 0,0 12.5,8A3.5,3.5 0 0,0 16,11.5Z</Geometry>
        <Geometry x:Key="IconCustomer">M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5,5.61 6.79,4 9,4C11.21,4 13,5.61 13,8C13,10.39 11.21,12 9,12C6.79,12 5,10.39 5,8M9,13C11.67,13 17,14.34 17,17V20H1V17C1,14.34 6.33,13 9,13M17.75,10.5A3.75,3.75 0 0,0 21.5,6.75A3.75,3.75 0 0,0 17.75,3A3.75,3.75 0 0,0 14,6.75A3.75,3.75 0 0,0 17.75,10.5M14,17.25C14,16.5 15.17,16 16.5,16C17.83,16 19,16.5 19,17.25V18H14V17.25Z</Geometry>
        <Geometry x:Key="IconNotification">M12,22C13.1,22 14,21.1 14,20H10C10,21.1 10.9,22 12,22M18,16V11C18,7.93 16.36,5.36 13.5,4.68V4C13.5,3.17 12.83,2.5 12,2.5C11.17,2.5 10.5,3.17 10.5,4V4.68C7.63,5.36 6,7.93 6,11V16L4,18V19H20V18L18,16Z</Geometry>
        <Geometry x:Key="IconLogout">M16,17V14H9V12H16V9L20,13L16,17M14,2A2,2 0 0,1 16,4V6H14V4H5V20H14V18H16V20A2,2 0 0,1 14,22H5A2,2 0 0,1 3,20V4A2,2 0 0,1 5,2H14Z</Geometry>
        <Geometry x:Key="IconPromotion">M12.41,2.58C12.03,2.2 11.53,2 11,2H4C2.9,2 2,2.9 2,4V11C2,11.53 2.2,12.03 2.59,12.41L12.42,22.24C12.81,22.63 13.44,22.63 13.83,22.24L22.24,13.82C22.63,13.43 22.63,12.8 22.24,12.41L12.41,2.58M7,7A1.5,1.5 0 0,1 5.5,8.5A1.5,1.5 0 0,1 4,7A1.5,1.5 0 0,1 5.5,5.5A1.5,1.5 0 0,1 7,7Z</Geometry>
        <Geometry x:Key="IconProfile">M12,12A5,5 0 0,1 7,7A5,5 0 0,1 12,2A5,5 0 0,1 17,7A5,5 0 0,1 12,12M12,14C14.67,14 20,15.33 20,18V20H4V18C4,15.33 9.33,14 12,14Z</Geometry>
        <Geometry x:Key="IconLeave">M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.89 20.1,3 19,3M19,19H5V10H19V19M10,14V12H7V14H10M14,14V12H11V14H14M18,14V12H15V14H18Z</Geometry>
        <Geometry x:Key="IconPayroll">M20,6H4V4H20V6M20,10H4V8H20V10M18,14H6V12H18V14M18,18H6V16H18V18M19,20H5C3.89,20 3,19.1 3,18V3C3,1.89 3.89,1 5,1H19C20.1,1 21,1.89 21,3V18C21,19.1 20.1,20 19,20Z</Geometry>

        <Geometry x:Key="IconReview">M12,17.27L18.18,21L17,14.64L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7,14.64L5.82,21L12,17.27Z</Geometry>


        <Style x:Key="NavToggleButton" TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource SubtleWhiteTextBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Padding" Value="20,12"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="border" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" CornerRadius="5" Margin="8,2">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Border x:Name="indicator" Width="4" Height="20" Background="Transparent" CornerRadius="2" VerticalAlignment="Center" Margin="-20,0,10,0"/>
                                <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,15,0">
                                    <Path Data="{Binding Path=Tag, RelativeSource={RelativeSource TemplatedParent}}" Fill="{TemplateBinding Foreground}" Stretch="Uniform" VerticalAlignment="Center"/>
                                </Viewbox>
                                <ContentPresenter Grid.Column="1" HorizontalAlignment="Left" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource HoverBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                                <Setter TargetName="indicator" Property="Background" Value="{StaticResource AccentOrangeBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="FooterButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource SubtleWhiteTextBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Padding" Value="20,12"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" CornerRadius="5" Margin="8,2">
                            <ContentPresenter/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource HoverBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="250"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Background="{StaticResource PrimaryBrownBrush}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <StackPanel Grid.Row="0" Margin="20">
                    <Border x:Name="AvatarBorder"
                            Height="70" Width="70"
                            Background="{StaticResource LightCreamBrush}"
                            CornerRadius="35"
                            Margin="0,0,0,10">
                        <Viewbox Margin="12,10,18,20">
                            <Path Data="{StaticResource IconProfile}" Fill="{StaticResource PrimaryBrownBrush}">
                                <Path.RenderTransform>
                                    <TranslateTransform Y="1.5" />
                                </Path.RenderTransform>
                            </Path>
                        </Viewbox>
                    </Border>
                    <TextBlock x:Name="txtAdminName" Text="Admin" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource WhiteTextBrush}" HorizontalAlignment="Center"/>
                    <TextBlock x:Name="txtUserRole" Text="Quản trị viên" FontSize="13" Foreground="{StaticResource SubtleWhiteTextBrush}" HorizontalAlignment="Center"/>
                </StackPanel>

                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <ToggleButton x:Name="btnTongQuan" Content="Tổng quan &amp; Báo cáo" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconDashboard}" Click="NavButton_Click" IsChecked="True"/>
                        <ToggleButton x:Name="btnBan" Content="Quản lý Bàn" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconTable}" Click="NavButton_Click"/>
                        <ToggleButton x:Name="btnSanPham" Content="Quản lý Sản phẩm" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconCoffee}" Click="NavButton_Click"/>
                        <ToggleButton x:Name="btnKho" Content="Quản lý Kho" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconWarehouse}" Click="NavButton_Click"/>
                        <ToggleButton x:Name="btnDonHang" Content="Quản lý Đơn hàng" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconOrder}" Click="NavButton_Click"/>
                        <ToggleButton x:Name="btnSach" Content="Quản lý Sách" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconBook}" Click="NavButton_Click"/>
                        <ToggleButton x:Name="btnLuong" Content="Quản lý Lương" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconPayroll}" Click="NavButton_Click"/>
                        <ToggleButton x:Name="btnNhanSu" Content="Quản lý Nhân sự" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconUsers}" Click="NavButton_Click"/>
                        <ToggleButton x:Name="btnKhachHang" Content="Quản lý KH &amp; KM" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconPromotion}" Click="NavButton_Click"/>

                        <ToggleButton x:Name="btnDanhGia" Content="Quản lý Đánh Giá" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconReview}" Click="NavButton_Click"/>

                    </StackPanel>
                </ScrollViewer>

                <StackPanel Grid.Row="2" VerticalAlignment="Bottom" Margin="0,0,0,5">
                    <Separator Margin="15" Background="{StaticResource HoverBrownBrush}"/>
                    <Button x:Name="btnThongBao" Style="{StaticResource FooterButton}" Click="BtnThongBao_Click" ToolTip="Xem thông báo mới">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,15,0">
                                <Path Data="{StaticResource IconNotification}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" />
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Thông báo" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            <Border Grid.Column="2" x:Name="BadgeThongBao" Background="Red" CornerRadius="10" Padding="5,1" MinWidth="20" Visibility="Collapsed" VerticalAlignment="Center">
                                <TextBlock x:Name="lblSoThongBao" Text="0" Foreground="White" FontSize="10" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                        </Grid>
                    </Button>
                    <Button x:Name="btnDangXuat" Style="{StaticResource FooterButton}" Click="BtnDangXuat_Click"
                            Background="{StaticResource AccentOrangeBrush}"
                            Foreground="{StaticResource WhiteTextBrush}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,15,0">
                                <Path Data="{StaticResource IconLogout}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Đăng xuất" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <Border Grid.Column="1" Background="{StaticResource LightCreamBrush}">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="2" Direction="270" Color="Black" Opacity="0.1" BlurRadius="10"/>
            </Border.Effect>
            <Frame x:Name="MainFrame" NavigationUIVisibility="Hidden"/>
        </Border>

        <Popup x:Name="PopupThongBao" IsOpen="False" StaysOpen="False" PlacementTarget="{Binding ElementName=btnThongBao}"
               Placement="Top" AllowsTransparency="True" PopupAnimation="Fade"
               Panel.ZIndex="1" Margin="5,0,0,0">
            <Border Background="White" BorderBrush="#DDD" BorderThickness="1" CornerRadius="8"
                    Width="350" MaxHeight="400">
                <Border.Effect>
                    <DropShadowEffect ShadowDepth="2" Color="#CCC" Opacity="0.5" BlurRadius="10"/>
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <TextBlock Text="Thông báo mới" Grid.Row="0" FontWeight="Bold" FontSize="16" Margin="15" Foreground="{StaticResource DarkBrownBrush}"/>
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <ItemsControl x:Name="icThongBaoPopup">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border BorderBrush="#EEE" BorderThickness="0,0,0,1" Padding="15,10"
                                            x:Name="ThongBaoItemBorder" MouseLeftButtonUp="ThongBaoItem_MouseLeftButtonUp"
                                            Background="Transparent" Cursor="Hand">
                                        <StackPanel>
                                            <TextBlock Text="{Binding NoiDung}" TextWrapping="Wrap"/>
                                            <TextBlock FontStyle="Italic" FontSize="11" Foreground="Gray" Margin="0,5,0,0">
                                                <Run Text="{Binding TenNhanVien}"/> - <Run Text="{Binding ThoiGianTao, StringFormat='HH:mm dd/MM'}"/>
                                            </TextBlock>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Popup>
    </Grid>
</Window>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\ManHinhQuanly.xaml.cs
================================================================================
﻿using AppCafebookApi.Services;
using AppCafebookApi.View;
using AppCafebookApi.View.common;
using AppCafebookApi.View.quanly.pages;
using CafebookModel.Model.Data;
using CafebookModel.Model.ModelApp;
using CafebookModel.Utils;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Controls.Primitives;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Threading;

namespace AppCafebookApi.View.quanly
{
    public partial class ManHinhQuanly : Window
    {
        private ToggleButton? currentNavButton;
        private NhanVienDto? currentUser;
        private DispatcherTimer _notificationTimer;
        private static readonly HttpClient httpClient;

        static ManHinhQuanly()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public ManHinhQuanly()
        {
            InitializeComponent();
            _notificationTimer = new DispatcherTimer();
            _notificationTimer.Interval = TimeSpan.FromSeconds(30);
            _notificationTimer.Tick += _notificationTimer_Tick;
        }

        private async void Window_Loaded(object sender, RoutedEventArgs e)
        {
            currentUser = AuthService.CurrentUser;
            if (currentUser != null)
            {
                // ... (Code cập nhật Avatar, Tên, Phân quyền giữ nguyên) ...
                txtAdminName.Text = currentUser.HoTen;
                txtUserRole.Text = currentUser.TenVaiTro;
                AvatarBorder.Child = null;
                BitmapImage avatarImage = HinhAnhHelper.LoadImage(
                    currentUser.AnhDaiDien,
                    HinhAnhPaths.DefaultAvatar
                );
                AvatarBorder.Background = new ImageBrush(avatarImage)
                {
                    Stretch = Stretch.UniformToFill
                };

                // === SỬA LỖI 2: THÊM LOGIC PHÂN QUYỀN ===

                // 1. Ẩn tất cả các nút
                btnTongQuan.Visibility = Visibility.Collapsed;
                btnSanPham.Visibility = Visibility.Collapsed;
                btnBan.Visibility = Visibility.Collapsed;
                btnKho.Visibility = Visibility.Collapsed;
                btnDonHang.Visibility = Visibility.Collapsed;
                btnSach.Visibility = Visibility.Collapsed;
                btnNhanSu.Visibility = Visibility.Collapsed;
                btnKhachHang.Visibility = Visibility.Collapsed;
                btnLuong.Visibility = Visibility.Collapsed; // <-- Nút này bị thiếu trong code của bạn
                btnDanhGia.Visibility = Visibility.Collapsed; // <-- Thêm nút Đánh Giá

                // 2. Hiện lại theo quyền
                if (AuthService.CoQuyen("Dashboard.Xem"))
                    btnTongQuan.Visibility = Visibility.Visible;

                if (AuthService.CoQuyen("SanPham.QuanLy"))
                {
                    btnSanPham.Visibility = Visibility.Visible;
                    btnBan.Visibility = Visibility.Visible;
                    btnSach.Visibility = Visibility.Visible;
                }
                if (AuthService.CoQuyen("Kho.Nhap", "Kho.KiemKe"))
                    btnKho.Visibility = Visibility.Visible;

                if (AuthService.CoQuyen("HoaDon.Tao", "HoaDon.ThanhToan", "HoaDon.Huy"))
                    btnDonHang.Visibility = Visibility.Visible;

                if (AuthService.CoQuyen("NhanSu.QuanLy", "NhanSu.TinhLuong"))
                    btnNhanSu.Visibility = Visibility.Visible;

                // Gộp chung Lương vào Quyền Nhân sự
                if (AuthService.CoQuyen("NhanSu.TinhLuong"))
                    btnLuong.Visibility = Visibility.Visible;

                if (AuthService.CoQuyen("NhanSu.QuanLy"))
                {
                    btnKhachHang.Visibility = Visibility.Visible;
                    btnDanhGia.Visibility = Visibility.Visible; // <-- Hiện nút Đánh Giá
                }
            }

            // (Phần điều hướng mặc định giữ nguyên)
            if (btnTongQuan.Visibility == Visibility.Visible)
            {
                UpdateSelectedButton(btnTongQuan);
                MainFrame.Navigate(new TongQuanView());
            }

            await CheckNotificationsAsync();
            _notificationTimer.Start();
        }

        private async void _notificationTimer_Tick(object? sender, EventArgs e)
        {
            await CheckNotificationsAsync();
        }

        private async Task CheckNotificationsAsync()
        {
            // (Hàm này giữ nguyên)
            try
            {
                var result = await httpClient.GetFromJsonAsync<ThongBaoCountDto>("api/app/thongbao/unread-count");
                if (result != null && result.UnreadCount > 0)
                {
                    lblSoThongBao.Text = result.UnreadCount.ToString();
                    BadgeThongBao.Visibility = Visibility.Visible;
                }
                else
                {
                    BadgeThongBao.Visibility = Visibility.Collapsed;
                }
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"Lỗi kiểm tra thông báo: {ex.Message}");
            }
        }

        /// <summary>
        /// Hàm Click chính, đã được sửa lại
        /// </summary>
        private void NavButton_Click(object sender, RoutedEventArgs e)
        {
            var clickedButton = sender as ToggleButton;
            if (clickedButton == null || clickedButton == currentNavButton)
            {
                if (clickedButton != null) clickedButton.IsChecked = true;
                return;
            }
            Page? pageToNavigate = null;

            if (clickedButton == btnTongQuan)
            {
                pageToNavigate = new TongQuanView();
            }
            else if (clickedButton == btnBan)
            {
                pageToNavigate = new QuanLyBanView();
            }
            else if (clickedButton == btnSanPham)
            {
                pageToNavigate = new QuanLySanPhamView();
            }
            else if (clickedButton == btnDonHang)
            {
                pageToNavigate = new QuanLyDonHangView();
            }
            else if (clickedButton == btnKhachHang)
            {
                pageToNavigate = new QuanLyKhachHangView();
            }
            else if (clickedButton == btnSach)
            {
                pageToNavigate = new QuanLySachView();
            }
            else if (clickedButton == btnNhanSu)
            {
                pageToNavigate = new QuanLyNhanVienView();
            }
            else if (clickedButton == btnLuong)
            {
                pageToNavigate = new QuanLyLuongView();
            }
            else if (clickedButton == btnKho)
            {
                pageToNavigate = new QuanLyTonKhoView();
            }
            // === SỬA LỖI 3: THÊM CASE CHO NÚT ĐÁNH GIÁ ===
            else if (clickedButton == btnDanhGia)
            {
                pageToNavigate = new QuanLyDanhGiaView();
            }
            // === KẾT THÚC SỬA LỖI 3 ===
            else if (clickedButton.Name == "btnLichLamViec")
            {
                pageToNavigate = new QuanLyLichLamViecView();
            }
            else if (clickedButton.Name == "btnDonXinNghi")
            {
                pageToNavigate = new QuanLyDonXinNghiView();
            }
            else if (clickedButton.Name == "btnCaiDatNhanSu")
            {
                pageToNavigate = new CaiDatNhanSuView();
            }
            else if (clickedButton.Name == "btnBaoCaoNhanSu")
            {
                pageToNavigate = new BaoCaoNhanSuView();
            }
            // (Đã xóa dòng 'else if (clickedButton.Name == "")' bị lỗi)

            if (pageToNavigate != null)
            {
                UpdateSelectedButton(clickedButton);
                MainFrame.Navigate(pageToNavigate);
            }
            else
            {
                // (Phần thông báo lỗi giữ nguyên)
                MessageBox.Show($"Chức năng '{clickedButton.Content}' đang được phát triển!", "Thông báo");
                clickedButton.IsChecked = false;
                if (currentNavButton != null)
                {
                    currentNavButton.IsChecked = true;
                }
            }
        }

        private void UpdateSelectedButton(ToggleButton newButton)
        {
            // (Hàm này giữ nguyên)
            if (currentNavButton != null && currentNavButton != newButton)
            {
                currentNavButton.IsChecked = false;
            }
            currentNavButton = newButton;
            currentNavButton.IsChecked = true;
        }

        private async void BtnThongBao_Click(object sender, RoutedEventArgs e)
        {
            // (Hàm này giữ nguyên)
            try
            {
                var allNotifications = await httpClient.GetFromJsonAsync<List<ThongBaoDto>>("api/app/thongbao/all");

                if (allNotifications != null)
                {
                    var unreadNotifications = allNotifications
                        .Where(t => t.DaXem == false)
                        .ToList();
                    icThongBaoPopup.ItemsSource = unreadNotifications;
                }
                else
                {
                    icThongBaoPopup.ItemsSource = null;
                }

                PopupThongBao.IsOpen = true;
                await CheckNotificationsAsync();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Không thể tải thông báo: {ex.Message}", "Lỗi API");
            }
        }

        private async void ThongBaoItem_MouseLeftButtonUp(object sender, System.Windows.Input.MouseButtonEventArgs e)
        {
            // (Hàm này giữ nguyên)
            if (sender is FrameworkElement element && element.DataContext is ThongBaoDto thongBao)
            {
                PopupThongBao.IsOpen = false;

                _ = httpClient.PostAsync($"api/app/thongbao/mark-as-read/{thongBao.IdThongBao}", null);

                if (thongBao.LoaiThongBao == "SuCoBan" && thongBao.IdLienQuan.HasValue)
                {
                    int idBanCanDen = thongBao.IdLienQuan.Value;
                    UpdateSelectedButton(btnBan);
                    MainFrame.Navigate(new QuanLyBanView(idBanCanDen));
                }
                else if (thongBao.LoaiThongBao == "HetHang")
                {
                    UpdateSelectedButton(btnKho);
                    MainFrame.Navigate(new QuanLyTonKhoView());
                }
                else if (thongBao.LoaiThongBao == "DonXinNghi")
                {
                    ToggleButton? targetButton = FindName("btnDonXinNghi") as ToggleButton ?? btnNhanSu;
                    UpdateSelectedButton(targetButton);
                    MainFrame.Navigate(new QuanLyDonXinNghiView());
                }

                await CheckNotificationsAsync();
            }
        }

        private void BtnDangXuat_Click(object sender, RoutedEventArgs e)
        {
            // (Hàm này giữ nguyên)
            var result = MessageBox.Show("Bạn có chắc chắn muốn đăng xuất?",
                                        "Xác nhận đăng xuất",
                                        MessageBoxButton.YesNo,
                                        MessageBoxImage.Question);

            if (result == MessageBoxResult.Yes)
            {
                AuthService.Logout();
                ManHinhDangNhap loginWindow = new ManHinhDangNhap();
                loginWindow.Show();
                this.Close();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\BaoCaoNhanSuView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.BaoCaoNhanSuView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      xmlns:lvc="clr-namespace:LiveCharts.Wpf;assembly=LiveCharts.Wpf"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Báo Cáo &amp; Thống Kê Nhân Sự"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionOrangeBrush" Color="#FFA726"/>
        <SolidColorBrush x:Key="ActionPurpleBrush" Color="#AB47BC"/>
        <SolidColorBrush x:Key="WhiteText" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="AccentOrange" Color="#FF7043"/>
        <SolidColorBrush x:Key="PrimaryBrown" Color="#6F4E37"/>
        
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>
        <Geometry x:Key="IconGenerate">M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z</Geometry>
        <Geometry x:Key="IconExport">M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrown}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteText}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Height" Value="42"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                CornerRadius="21"
                                Background="{TemplateBinding Background}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="2" Color="#6F4E37" Opacity="0.3" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource AccentOrange}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="TabControl">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
        <Style TargetType="TabItem">
            <Setter Property="Background" Value="#E0E0E0"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border x:Name="border" BorderThickness="0,0,0,3" BorderBrush="Transparent" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" Margin="0,0,5,0">
                            <ContentPresenter ContentSource="Header" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="Background" Value="White"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
                                <Setter TargetName="border" Property="Background" Value="#F5F5F5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="KpiCard" TargetType="Border" BasedOn="{StaticResource CardBorder}">
            <Setter Property="Padding" Value="15"/>
            <Setter Property="Margin" Value="0,0,10,0"/>
        </Style>
        <Style x:Key="KpiValue" TargetType="TextBlock">
            <Setter Property="FontSize" Value="24"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>
        <Style x:Key="KpiTitle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
        </Style>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Báo Cáo &amp; Thống Kê Nhân Sự" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Border Grid.Row="1" Margin="10,0,10,10" Padding="15" Background="{StaticResource SubtleGrayBrush}" CornerRadius="4">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="130"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="130"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="200"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="180"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="150"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Text="Từ Ngày:" VerticalAlignment="Center" Margin="0,0,5,0" FontWeight="SemiBold"/>
                    <DatePicker  Grid.Column="1" x:Name="dpStartDate"/>

                    <TextBlock Grid.Column="2" Text="Đến Ngày:" VerticalAlignment="Center" Margin="10,0,5,0" FontWeight="SemiBold"/>
                    <DatePicker Grid.Column="3" x:Name="dpEndDate"/>

                    <TextBlock Grid.Column="4" Text="Nhân viên:" VerticalAlignment="Center" Margin="10,0,5,0" FontWeight="SemiBold"/>
                    <ComboBox Grid.Column="5" x:Name="cmbNhanVienFilter" DisplayMemberPath="HoTen" SelectedValuePath="IdNhanVien"/>

                    <TextBlock Grid.Column="6" Text="Vai trò:" VerticalAlignment="Center" Margin="10,0,5,0" FontWeight="SemiBold"/>
                    <ComboBox Grid.Column="7" x:Name="cmbVaiTroFilter" DisplayMemberPath="Ten" SelectedValuePath="Id"/>

                    <TextBlock Grid.Column="8" Text="Trạng thái:" VerticalAlignment="Center" Margin="10,0,5,0" FontWeight="SemiBold"/>
                    <ComboBox Grid.Column="9" x:Name="cmbTrangThaiFilter">
                        <ComboBoxItem Content="Đang làm việc"/>
                        <ComboBoxItem Content="Nghỉ việc"/>
                        <ComboBoxItem Content="Tất cả"/>
                    </ComboBox>

                    <Button Grid.Column="11" x:Name="btnGenerate" Style="{StaticResource PrimaryButton}" 
                            Background="{StaticResource ActionBlueBrush}" Click="BtnGenerate_Click" 
                            HorizontalAlignment="Right">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconGenerate}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Tạo Báo Cáo" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </Grid>
            </Border>

            <Grid Grid.Row="2" Margin="10,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Border Grid.Column="0" Style="{StaticResource KpiCard}">
                    <StackPanel>
                        <TextBlock x:Name="lblSoLuongNhanVien" Text="0" Style="{StaticResource KpiValue}" Foreground="{StaticResource PrimaryBrownBrush}"/>
                        <TextBlock Text="Tổng số Nhân viên (lọc)" Style="{StaticResource KpiTitle}"/>
                    </StackPanel>
                </Border>
                <Border Grid.Column="1" Style="{StaticResource KpiCard}">
                    <StackPanel>
                        <TextBlock x:Name="lblTongLuongDaTra" Text="0" Style="{StaticResource KpiValue}" Foreground="{StaticResource ActionGreenBrush}"/>
                        <TextBlock Text="Tổng Lương Đã Trả (kỳ)" Style="{StaticResource KpiTitle}"/>
                    </StackPanel>
                </Border>
                <Border Grid.Column="2" Style="{StaticResource KpiCard}">
                    <StackPanel>
                        <TextBlock x:Name="lblTongGioLam" Text="0" Style="{StaticResource KpiValue}" Foreground="{StaticResource ActionBlueBrush}"/>
                        <TextBlock Text="Tổng Giờ Làm (kỳ)" Style="{StaticResource KpiTitle}"/>
                    </StackPanel>
                </Border>
                <Border Grid.Column="3" Style="{StaticResource KpiCard}" Margin="0">
                    <StackPanel>
                        <TextBlock x:Name="lblTongSoNgayNghi" Text="0" Style="{StaticResource KpiValue}" Foreground="{StaticResource ActionOrangeBrush}"/>
                        <TextBlock Text="Tổng Ngày Nghỉ (kỳ)" Style="{StaticResource KpiTitle}"/>
                    </StackPanel>
                </Border>
            </Grid>

            <TabControl Grid.Row="3" Margin="10,10,10,0">
                <TabItem Header="Báo cáo Lương Chi Tiết">
                    <DataGrid x:Name="dgLuong" AutoGenerateColumns="False" IsReadOnly="True" 
                              BorderThickness="0" RowHeaderWidth="0" Margin="5">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Nhân viên" Binding="{Binding HoTenNhanVien}" Width="2*"/>
                            <DataGridTextColumn Header="Vai trò" Binding="{Binding TenVaiTro}" Width="*"/>
                            <DataGridTextColumn Header="Tổng Giờ" Binding="{Binding TongGioLam, StringFormat=F2}" Width="Auto"/>
                            <DataGridTextColumn Header="Lương Giờ" Binding="{Binding TongLuongCoBan, StringFormat=N0}" Width="Auto"/>
                            <DataGridTextColumn Header="Tổng Thưởng" Binding="{Binding TongThuong, StringFormat=N0}" Width="Auto"/>
                            <DataGridTextColumn Header="Tổng Phạt" Binding="{Binding TongPhat, StringFormat=N0}" Width="Auto"/>
                            <DataGridTextColumn Header="Thực Lãnh" Binding="{Binding ThucLanh, StringFormat=N0}" Width="*" FontWeight="Bold"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </TabItem>
                <TabItem Header="Thống kê Nghỉ Phép">
                    <DataGrid x:Name="dgNghiPhep" AutoGenerateColumns="False" IsReadOnly="True" 
                              BorderThickness="0" RowHeaderWidth="0" Margin="5">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Nhân viên" Binding="{Binding HoTenNhanVien}" Width="2*"/>
                            <DataGridTextColumn Header="Vai trò" Binding="{Binding TenVaiTro}" Width="*"/>
                            <DataGridTextColumn Header="Số Đơn Duyệt" Binding="{Binding SoDonDaDuyet}" Width="Auto"/>
                            <DataGridTextColumn Header="Tổng Số Ngày Nghỉ" Binding="{Binding TongSoNgayNghi}" Width="*" FontWeight="Bold"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </TabItem>
                <TabItem Header="Biểu Đồ Lương (Theo Ngày)">
                    <lvc:CartesianChart Margin="10" Series="{Binding LuongChartSeries}">
                        <lvc:CartesianChart.Resources>
                            <Style TargetType="lvc:LineSeries">
                                <Setter Property="Stroke" Value="{StaticResource ActionGreenBrush}"/>
                                <Setter Property="Fill" Value="#4066BB6A"/>
                                <Setter Property="StrokeThickness" Value="3"/>
                                <Setter Property="PointGeometry" Value="{x:Null}"/>
                            </Style>
                        </lvc:CartesianChart.Resources>
                        <lvc:CartesianChart.AxisX>
                            <lvc:Axis Title="Ngày" Labels="{Binding ChartLabels}">
                                <lvc:Axis.Separator>
                                    <lvc:Separator Stroke="#E0E0E0" StrokeThickness="1"/>
                                </lvc:Axis.Separator>
                            </lvc:Axis>
                        </lvc:CartesianChart.AxisX>
                        <lvc:CartesianChart.AxisY>
                            <lvc:Axis Title="Tổng Lương Trả" LabelFormatter="{Binding YFormatter}">
                                <lvc:Axis.Separator>
                                    <lvc:Separator Stroke="#E0E0E0" StrokeThickness="1"/>
                                </lvc:Axis.Separator>
                            </lvc:Axis>
                        </lvc:CartesianChart.AxisY>
                    </lvc:CartesianChart>
                </TabItem>
            </TabControl>

            <StackPanel Grid.Row="4" Orientation="Horizontal" Margin="10,10,0,10">
                <Button x:Name="btnQuayLai" 
                        Style="{StaticResource BackButton}"
                        HorizontalAlignment="Left"
                        Click="BtnQuayLai_Click">
                    <StackPanel Orientation="Horizontal">
                        <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                        <TextBlock Text="Quay lại" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <Button x:Name="btnExport" Style="{StaticResource PrimaryButton}" 
                        Background="{StaticResource ActionGreenBrush}" Click="BtnExport_Click" 
                        HorizontalAlignment="Left" Margin="20,0,0,0">
                    <StackPanel Orientation="Horizontal">
                        <Path Data="{StaticResource IconExport}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                        <TextBlock Text="Xuất Excel" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Đang tạo báo cáo..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\BaoCaoNhanSuView.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Threading.Tasks;
using LiveCharts;
using LiveCharts.Wpf;
using System.Globalization;

namespace AppCafebookApi.View.quanly.pages
{
    public partial class BaoCaoNhanSuView : Page
    {
        private static readonly HttpClient httpClient;

        // Dành cho Biểu đồ
        public SeriesCollection LuongChartSeries { get; set; }
        public string[] ChartLabels { get; set; }
        public Func<double, string> YFormatter { get; set; }

        static BaoCaoNhanSuView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public BaoCaoNhanSuView()
        {
            InitializeComponent();

            // Khởi tạo cho Biểu đồ
            LuongChartSeries = new SeriesCollection
            {
                new LineSeries
                {
                    Title = "Tổng Lương",
                    Values = new ChartValues<decimal>(),
                    LineSmoothness = 0
                }
            };
            ChartLabels = Array.Empty<string>();
            YFormatter = value => value.ToString("N0") + " đ";

            DataContext = this;
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadFiltersAsync();

            var now = DateTime.Now;
            dpStartDate.SelectedDate = new DateTime(now.Year, now.Month, 1);
            dpEndDate.SelectedDate = now;
            cmbTrangThaiFilter.SelectedIndex = 0; // Đang làm việc
        }

        private async Task LoadFiltersAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var filters = await httpClient.GetFromJsonAsync<BaoCaoNhanSu_FiltersDto>("api/app/baocaonhansu/filters");
                if (filters != null)
                {
                    // Lọc Nhân viên
                    var nvList = filters.NhanViens;
                    nvList.Insert(0, new NhanVienLookupDto { IdNhanVien = 0, HoTen = "--- Tất cả Nhân viên ---" });
                    cmbNhanVienFilter.ItemsSource = nvList;
                    cmbNhanVienFilter.SelectedValue = 0;

                    // Lọc Vai trò
                    var vtList = filters.VaiTros;
                    vtList.Insert(0, new FilterLookupDto { Id = 0, Ten = "--- Tất cả Vai trò ---" });
                    cmbVaiTroFilter.ItemsSource = vtList;
                    cmbVaiTroFilter.SelectedValue = 0;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải bộ lọc: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnGenerate_Click(object sender, RoutedEventArgs e)
        {
            if (dpStartDate.SelectedDate == null || dpEndDate.SelectedDate == null)
            {
                MessageBox.Show("Vui lòng chọn Từ Ngày và Đến Ngày.", "Thiếu thông tin");
                return;
            }

            var request = new BaoCaoNhanSuRequestDto
            {
                StartDate = dpStartDate.SelectedDate.Value,
                EndDate = dpEndDate.SelectedDate.Value,
                IdNhanVien = (int)(cmbNhanVienFilter.SelectedValue ?? 0),
                IdVaiTro = (int)(cmbVaiTroFilter.SelectedValue ?? 0),
                TrangThaiNhanVien = (cmbTrangThaiFilter.SelectedItem as ComboBoxItem)?.Content.ToString() ?? "Tất cả"
            };

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/baocaonhansu/report", request);
                if (response.IsSuccessStatusCode)
                {
                    var data = await response.Content.ReadFromJsonAsync<BaoCaoNhanSuDto>();
                    if (data != null)
                    {
                        PopulateReport(data);
                    }
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void PopulateReport(BaoCaoNhanSuDto data)
        {
            var culture = CultureInfo.GetCultureInfo("vi-VN");

            // 1. Cập nhật KPIs
            lblSoLuongNhanVien.Text = data.Kpi.SoLuongNhanVien.ToString();
            lblTongLuongDaTra.Text = data.Kpi.TongLuongDaTra.ToString("C0", culture);
            lblTongGioLam.Text = data.Kpi.TongGioLam.ToString("F2");
            lblTongSoNgayNghi.Text = data.Kpi.TongSoNgayNghi.ToString();

            // 2. Cập nhật DataGrids
            dgLuong.ItemsSource = data.BangLuongChiTiet;
            dgNghiPhep.ItemsSource = data.ThongKeNghiPhep;

            // 3. Cập nhật Biểu đồ
            LuongChartSeries[0].Values.Clear();
            LuongChartSeries[0].Values.AddRange(data.LuongChartData.Select(d => d.TongTien).Cast<object>());
            ChartLabels = data.LuongChartData.Select(d => d.Ngay.ToString("dd/MM")).ToArray();

            // Cần reset DataContext để Chart cập nhật Labels
            DataContext = null;
            DataContext = this;
        }

        private void BtnExport_Click(object sender, RoutedEventArgs e)
        {
            MessageBox.Show("Chức năng Xuất Excel đang được phát triển. Dữ liệu sẽ được lấy từ các bảng và biểu đồ hiện tại.", "Thông báo");
        }

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
            else
            {
                // Fallback nếu không CanGoBack
                this.NavigationService?.Navigate(new QuanLyNhanVienView());
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\CaiDatNhanSuView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.CaiDatNhanSuView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Cấu Hình Nhân Sự &amp; Chính Sách Lương"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="25"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="15,10"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="MaterialInput" TargetType="TextBox">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="SettingLabel" TargetType="TextBlock">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,15,0,5"/>
        </Style>
        <Style x:Key="SettingDescription" TargetType="TextBlock">
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="FontStyle" Value="Italic"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
            <Setter Property="TextWrapping" Value="Wrap"/>
            <Setter Property="Margin" Value="2,2,0,0"/>
        </Style>
        <Style TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,8"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Cấu Hình Nhân Sự &amp; Chính Sách Lương" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Border Grid.Row="1" Margin="10,0,10,10" Style="{StaticResource CardBorder}" MaxWidth="800" HorizontalAlignment="Left">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel x:Name="formCaiDat">

                        <TextBlock Text="QUY TẮC GIỜ LÀM &amp; TĂNG CA" FontSize="14" FontWeight="Bold" Margin="0,0,0,10" 
                                    Foreground="{StaticResource PrimaryBrownBrush}" Padding="0,0,0,5"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,10,0">
                                <TextBlock Style="{StaticResource SettingLabel}" Text="Giờ làm chuẩn / ngày"/>
                                <TextBox x:Name="txtGioLamChuan" Style="{StaticResource MaterialInput}"/>
                                <TextBlock Style="{StaticResource SettingDescription}" Text="Số giờ làm việc chuẩn mỗi ngày (ví dụ: 8)"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="10,0,0,0">
                                <TextBlock Style="{StaticResource SettingLabel}" Text="Hệ số lương OT"/>
                                <TextBox x:Name="txtHeSoOT" Style="{StaticResource MaterialInput}"/>
                                <TextBlock Style="{StaticResource SettingDescription}" Text="Hệ số lương khi làm tăng ca (ví dụ: 1.5)"/>
                            </StackPanel>
                        </Grid>

                        <TextBlock Text="QUY TẮC PHẠT ĐI TRỄ" FontSize="14" FontWeight="Bold" Margin="0,25,0,10" 
                                   Foreground="{StaticResource PrimaryBrownBrush}" Padding="0,0,0,5"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,10,0">
                                <TextBlock Style="{StaticResource SettingLabel}" Text="Số phút đi trễ cho phép"/>
                                <TextBox x:Name="txtPhatDiTre_Phut" Style="{StaticResource MaterialInput}"/>
                                <TextBlock Style="{StaticResource SettingDescription}" Text="Vượt quá ngưỡng này bắt đầu tính phạt (ví dụ: 5)"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="10,0,0,0">
                                <TextBlock Style="{StaticResource SettingLabel}" Text="Hệ số phạt đi trễ"/>
                                <TextBox x:Name="txtPhatDiTre_HeSo" Style="{StaticResource MaterialInput}"/>
                                <TextBlock Style="{StaticResource SettingDescription}" Text="Hệ số phạt (ví dụ: 1.0 = trễ 1 giờ phạt 1 giờ lương)"/>
                            </StackPanel>
                        </Grid>

                        <TextBlock Text="QUY TẮC THƯỞNG CHUYÊN CẦN" FontSize="14" FontWeight="Bold" Margin="0,25,0,10" 
                                    Foreground="{StaticResource PrimaryBrownBrush}" Padding="0,0,0,5"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,10,0">
                                <TextBlock Style="{StaticResource SettingLabel}" Text="Số ngày công yêu cầu"/>
                                <TextBox x:Name="txtChuyenCan_SoNgay" Style="{StaticResource MaterialInput}"/>
                                <TextBlock Style="{StaticResource SettingDescription}" Text="Số ngày công yêu cầu để đạt thưởng (ví dụ: 26)"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="10,0,0,0">
                                <TextBlock Style="{StaticResource SettingLabel}" Text="Tiền thưởng chuyên cần (VND)"/>
                                <TextBox x:Name="txtChuyenCan_TienThuong" Style="{StaticResource MaterialInput}"/>
                                <TextBlock Style="{StaticResource SettingDescription}" Text="Số tiền thưởng (ví dụ: 500000)"/>
                            </StackPanel>
                        </Grid>

                        <TextBlock Text="CHÍNH SÁCH NGHỈ PHÉP" FontSize="14" FontWeight="Bold" Margin="0,25,0,10" 
                                    Foreground="{StaticResource PrimaryBrownBrush}" Padding="0,0,0,5"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,10,0">
                                <TextBlock Style="{StaticResource SettingLabel}" Text="Số ngày phép mặc định / năm"/>
                                <TextBox x:Name="txtPhepNam_MacDinh" Style="{StaticResource MaterialInput}"/>
                                <TextBlock Style="{StaticResource SettingDescription}" Text="Số ngày nghỉ phép có lương mặc định (ví dụ: 12)"/>
                            </StackPanel>
                        </Grid>

                    </StackPanel>
                </ScrollViewer>
            </Border>

            <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="10,0,0,10">
                <Button x:Name="btnQuayLai" 
                        Style="{StaticResource BackButton}"
                        HorizontalAlignment="Left"
                        Click="BtnQuayLai_Click">
                    <StackPanel Orientation="Horizontal">
                        <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                        <TextBlock Text="Quay lại" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <Button x:Name="btnLuu" Grid.Column="5" Style="{StaticResource PrimaryButton}" 
                        Background="{StaticResource SuccessBrush}" Click="BtnLuu_Click" 
                        HorizontalAlignment="Left" Margin="20,0,0,0">
                    <StackPanel Orientation="Horizontal">
                        <Path Data="{StaticResource IconSave}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                        <TextBlock Text="Lưu Cấu Hình" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Đang xử lý..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\CaiDatNhanSuView.xaml.cs
================================================================================
﻿using System;
using System.Globalization;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;

namespace AppCafebookApi.View.quanly.pages
{
    public partial class CaiDatNhanSuView : Page
    {
        private static readonly HttpClient httpClient;
        private CaiDatNhanSuDto _currentSettings = new CaiDatNhanSuDto();

        static CaiDatNhanSuView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public CaiDatNhanSuView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadSettingsAsync();
        }

        private async Task LoadSettingsAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                // === SỬA LỖI CS8601 ===
                // 1. Tải dữ liệu vào một biến tạm 'nullable' (có thể là null)
                var loadedSettings = await httpClient.GetFromJsonAsync<CaiDatNhanSuDto>("api/app/caidatnhansu/all");

                // 2. Kiểm tra biến tạm đó
                if (loadedSettings != null)
                {
                    // 3. Nếu không null, gán nó vào biến non-null của class
                    _currentSettings = loadedSettings;

                    // 4. Giờ có thể dùng _currentSettings một cách an toàn
                    txtGioLamChuan.Text = _currentSettings.GioLamChuan.ToString(CultureInfo.InvariantCulture);
                    txtHeSoOT.Text = _currentSettings.HeSoOT.ToString(CultureInfo.InvariantCulture);
                    txtPhatDiTre_Phut.Text = _currentSettings.PhatDiTre_Phut.ToString();
                    txtPhatDiTre_HeSo.Text = _currentSettings.PhatDiTre_HeSo.ToString(CultureInfo.InvariantCulture);
                    txtChuyenCan_SoNgay.Text = _currentSettings.ChuyenCan_SoNgay.ToString();
                    txtChuyenCan_TienThuong.Text = _currentSettings.ChuyenCan_TienThuong.ToString("F0", CultureInfo.InvariantCulture);
                    txtPhepNam_MacDinh.Text = _currentSettings.PhepNam_MacDinh.ToString();
                }
                else
                {
                    // (Tùy chọn) Thông báo nếu API trả về null
                    MessageBox.Show("Không thể tải dữ liệu cài đặt (API trả về rỗng).", "Lỗi Tải Dữ Liệu");
                }
                // === KẾT THÚC SỬA LỖI ===
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải cài đặt: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                // Validate và Parse
                var dto = new CaiDatNhanSuDto
                {
                    GioLamChuan = decimal.Parse(txtGioLamChuan.Text, CultureInfo.InvariantCulture),
                    HeSoOT = decimal.Parse(txtHeSoOT.Text, CultureInfo.InvariantCulture),
                    PhatDiTre_Phut = int.Parse(txtPhatDiTre_Phut.Text),
                    PhatDiTre_HeSo = decimal.Parse(txtPhatDiTre_HeSo.Text, CultureInfo.InvariantCulture),
                    ChuyenCan_SoNgay = int.Parse(txtChuyenCan_SoNgay.Text),
                    ChuyenCan_TienThuong = decimal.Parse(txtChuyenCan_TienThuong.Text, CultureInfo.InvariantCulture),
                    PhepNam_MacDinh = int.Parse(txtPhepNam_MacDinh.Text)
                };

                // Gọi API
                var response = await httpClient.PutAsJsonAsync("api/app/caidatnhansu/update", dto);

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Lưu cài đặt thành công!", "Thành công");
                    await LoadSettingsAsync(); // Tải lại dữ liệu
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (FormatException)
            {
                MessageBox.Show("Dữ liệu nhập không hợp lệ. Vui lòng kiểm tra các con số (dùng dấu . cho số thập phân).", "Lỗi Định Dạng");
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            // Quay lại trang QL Lương (Module 6)
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\PhanQuyenView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.PhanQuyenView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Phân Quyền Chức Năng"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>

        <Style TargetType="GroupItem">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="GroupItem">
                        <StackPanel>
                            <TextBlock Text="{Binding Name}" 
                                       FontSize="16" FontWeight="Bold" 
                                       Foreground="{StaticResource PrimaryBrownBrush}" 
                                       Margin="5,15,0,5" />
                            <ItemsPresenter />
                        </StackPanel>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Phân Quyền Chức Năng" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Border Grid.Row="1" Style="{StaticResource CardBorder}" Margin="10,0,10,10" Padding="15">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="350"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="300"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" Text="Chọn Vai Trò:" FontWeight="SemiBold" VerticalAlignment="Center"/>
                    <ComboBox Grid.Column="1" x:Name="cmbVaiTro" Margin="10,0,0,0"
                              DisplayMemberPath="TenVaiTro" SelectedValuePath="IdVaiTro"
                              SelectionChanged="CmbVaiTro_SelectionChanged"/>

                    <TextBlock Grid.Column="2" Text="Tìm chức năng:" FontWeight="SemiBold" VerticalAlignment="Center" Margin="20,0,0,0"/>
                    <TextBox Grid.Column="3" x:Name="txtSearchQuyen" Margin="10,0,0,0" TextChanged="TxtSearchQuyen_TextChanged"/>

                    <Button Grid.Column="5" x:Name="btnLuu" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionBlueBrush}" 
                            Click="BtnLuu_Click" IsEnabled="False">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconSave}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Lưu Phân Quyền" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </Grid>
            </Border>

            <Border Grid.Row="2" Margin="10,0,10,10" Style="{StaticResource CardBorder}">
                <ListView x:Name="lvQuyen" BorderThickness="0" Background="Transparent">
                    <ListView.GroupStyle>
                        <GroupStyle HidesIfEmpty="True"/>
                    </ListView.GroupStyle>
                    <ListView.ItemTemplate>


                            <DataTemplate>
                                <CheckBox Content="{Binding TenQuyen}" 
                                      IsChecked="{Binding IsChecked, Mode=TwoWay}"
                                      Margin="5"/>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                </ListView>
            </Border>

            <Button x:Name="btnQuayLai" Grid.Row="3" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" Margin="10,0,0,10"
                    Click="BtnQuayLai_Click">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                    <TextBlock Text="Quay lại" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Đang xử lý..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\PhanQuyenView.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data; // Cần cho CollectionViewSource
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Threading.Tasks;
using System.ComponentModel; // Cần cho ICollectionView

namespace AppCafebookApi.View.quanly.pages
{
    /// <summary>
    /// Lớp View-Model nội bộ để quản lý trạng thái CheckBox
    /// </summary>
    public class QuyenViewItem : INotifyPropertyChanged
    {
        public string IdQuyen { get; set; } = string.Empty;
        public string TenQuyen { get; set; } = string.Empty;
        public string NhomQuyen { get; set; } = string.Empty;

        private bool _isChecked;
        public bool IsChecked
        {
            get => _isChecked;
            set
            {
                if (_isChecked != value)
                {
                    _isChecked = value;
                    PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(nameof(IsChecked)));
                }
            }
        }
        public event PropertyChangedEventHandler? PropertyChanged;
    }

    public partial class PhanQuyenView : Page
    {
        private static readonly HttpClient httpClient;

        // Cache dữ liệu
        private List<VaiTroDto> _allVaiTroList = new List<VaiTroDto>();
        private List<QuyenViewItem> _allPermissionsList = new List<QuyenViewItem>();

        static PhanQuyenView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public PhanQuyenView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            await LoadAllVaiTroAsync();
            await LoadAllQuyenAsync();
            ApplyFilter(); // Hiển thị danh sách rỗng ban đầu
            LoadingOverlay.Visibility = Visibility.Collapsed;
        }

        /// <summary>
        /// Tải danh sách Vai Trò vào ComboBox
        /// </summary>
        private async Task LoadAllVaiTroAsync()
        {
            try
            {
                _allVaiTroList = (await httpClient.GetFromJsonAsync<List<VaiTroDto>>("api/app/vaitro/all")) ?? new List<VaiTroDto>();
                cmbVaiTro.ItemsSource = _allVaiTroList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải danh sách vai trò: {ex.Message}", "Lỗi API");
            }
        }

        /// <summary>
        /// Tải TẤT CẢ các quyền trong hệ thống vào Cache
        /// </summary>
        private async Task LoadAllQuyenAsync()
        {
            try
            {
                var quyenDtos = (await httpClient.GetFromJsonAsync<List<QuyenDto>>("api/app/phanquyen/all-permissions")) ?? new List<QuyenDto>();

                _allPermissionsList = quyenDtos.Select(dto => new QuyenViewItem
                {
                    IdQuyen = dto.IdQuyen,
                    TenQuyen = dto.TenQuyen,
                    NhomQuyen = dto.NhomQuyen,
                    IsChecked = false // Mặc định là false
                }).ToList();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải danh sách quyền: {ex.Message}", "Lỗi API");
            }
        }

        /// <summary>
        /// Khi thay đổi Vai trò, tải các quyền tương ứng
        /// </summary>
        private async void CmbVaiTro_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (cmbVaiTro.SelectedItem is not VaiTroDto selectedVaiTro)
            {
                btnLuu.IsEnabled = false;
                // Bỏ check tất cả
                foreach (var item in _allPermissionsList) { item.IsChecked = false; }
                ApplyFilter();
                return;
            }

            btnLuu.IsEnabled = true;
            LoadingOverlay.Visibility = Visibility.Visible;

            try
            {
                // 1. Tải danh sách ID quyền đã được gán
                var assignedIds = (await httpClient.GetFromJsonAsync<List<string>>($"api/app/phanquyen/for-role/{selectedVaiTro.IdVaiTro}")) ?? new List<string>();

                // 2. Cập nhật trạng thái CheckBox
                foreach (var item in _allPermissionsList)
                {
                    item.IsChecked = assignedIds.Contains(item.IdQuyen);
                }

                // 3. Áp dụng tìm kiếm và hiển thị
                ApplyFilter();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải phân quyền cho vai trò: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        /// <summary>
        /// Lọc danh sách quyền theo từ khóa tìm kiếm
        /// </summary>
        private void TxtSearchQuyen_TextChanged(object sender, TextChangedEventArgs e)
        {
            ApplyFilter();
        }

        /// <summary>
        /// (Quan trọng) Hàm lọc và nhóm ListView
        /// </summary>
        private void ApplyFilter()
        {
            string searchText = txtSearchQuyen.Text.ToLower().Trim();

            IEnumerable<QuyenViewItem> filteredList = _allPermissionsList;

            if (!string.IsNullOrEmpty(searchText))
            {
                filteredList = _allPermissionsList.Where(p =>
                    p.TenQuyen.ToLower().Contains(searchText) ||
                    p.NhomQuyen.ToLower().Contains(searchText));
            }

            // Tạo CollectionViewSource để Gruping
            var cvs = new CollectionViewSource { Source = filteredList };
            cvs.GroupDescriptions.Add(new PropertyGroupDescription("NhomQuyen"));

            lvQuyen.ItemsSource = cvs.View;
        }

        /// <summary>
        /// Lưu thay đổi phân quyền
        /// </summary>
        private async void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            if (cmbVaiTro.SelectedItem is not VaiTroDto selectedVaiTro)
            {
                MessageBox.Show("Vui lòng chọn một vai trò trước khi lưu.", "Chưa chọn Vai trò");
                return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;

            try
            {
                // 1. Lấy tất cả ID được check từ cache
                var checkedIds = _allPermissionsList
                    .Where(p => p.IsChecked)
                    .Select(p => p.IdQuyen)
                    .ToList();

                // 2. Tạo DTO
                var dto = new PhanQuyenDto
                {
                    IdVaiTro = selectedVaiTro.IdVaiTro,
                    DanhSachIdQuyen = checkedIds
                };

                // 3. Gọi API
                var response = await httpClient.PutAsJsonAsync("api/app/phanquyen/update", dto);

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Cập nhật phân quyền thành công!", "Thành công");
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyBanView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyBanView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      xmlns:dto="clr-namespace:CafebookModel.Model.ModelApp;assembly=CafebookModel"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="QuanLyBanView"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="BackgroundHoverBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="BackgroundSelectedBrush" Color="#EFEBE9"/>

        <Geometry x:Key="IconAddFolder">M20,6H12L10,4H4C2.89,4 2,4.89 2,6V18C2,19.1 2.89,20 4,20H20C21.1,20 22,19.1 22,18V8C22,6.89 21.1,6 20,6M18,14H15V17H13V14H10V12H13V9H15V12H18V14Z</Geometry>
        <Geometry x:Key="IconAddTable">M4,6H20V8H4V6M4,10H20V12H4V10M4,14H11V16H4V14M19,16V19H16V21H14V19H11V16H14V14H16V16H19Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconHistory">M13.5,8H12V13L16.28,15.54L17,14.33L13.5,12.25V8M13,3C8.03,3 4,7.03 4,12C4,16.97 8.03,21 13,21C17.97,21 22,16.97 22,12C22,7.03 17.97,3 13,3M13,19C9.13,19 6,15.87 6,12C6,8.13 9.13,5 13,5C16.87,5 20,8.13 20,12C20,15.87 16.87,19 13,19Z</Geometry>
        <Geometry x:Key="IconClearFilter">M14.12,12.5L19.31,7.31L17.89,5.89L12.71,11.08L7.5,5.89L6.09,7.31L11.28,12.5L6.09,17.69L7.5,19.11L12.71,13.92L17.89,19.11L19.31,17.69L14.12,12.5M3,5H21V3H3V5Z</Geometry>
        <Geometry x:Key="IconCheck">M9,20.42L2.79,14.21L4.21,12.79L9,17.58L19.79,6.79L21.21,8.21L9,20.42Z</Geometry>
        
        <Style x:Key="ActionButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,10"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="4" Padding="{TemplateBinding Padding}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.1" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.8"/>
                                <Setter TargetName="border" Property="Effect" Value="{x:Null}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="DeleteButton" TargetType="Button" BasedOn="{StaticResource ActionButton}">
            <Setter Property="Background" Value="{StaticResource ErrorBrush}"/>
        </Style>

        <Style TargetType="Label">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,15,0,5"/>
        </Style>
        <Style x:Key="MaterialTextBox" TargetType="TextBox">
            <Setter Property="Padding" Value="8,10"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TextBox">
                        <Border x:Name="border" 
                                Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}" 
                                BorderThickness="{TemplateBinding BorderThickness}">
                            <ScrollViewer x:Name="PART_ContentHost" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsKeyboardFocused" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="BorderThickness" Value="0,0,0,2"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="IconButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="20" Padding="{TemplateBinding Padding}">
                            <Path Data="{Binding Content, RelativeSource={RelativeSource TemplatedParent}}" 
                                  Fill="{Binding Foreground, RelativeSource={RelativeSource TemplatedParent}}" 
                                  Width="16" Height="16" Stretch="Uniform"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource BackgroundHoverBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="MaterialComboBox" TargetType="ComboBox">
            <Setter Property="Padding" Value="8,10"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="SearchTextBox" TargetType="TextBox" BasedOn="{StaticResource MaterialTextBox}">
            <Setter Property="Padding" Value="8,8"/>
        </Style>
        <Style x:Key="FilterComboBox" TargetType="ComboBox" BasedOn="{StaticResource MaterialComboBox}">
            <Setter Property="Padding" Value="8,8"/>
        </Style>
        <Style TargetType="TabControl">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
        <Style TargetType="TabItem">
            <Setter Property="Background" Value="#E0E0E0"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border x:Name="border" BorderThickness="0,0,0,3" BorderBrush="Transparent" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" Margin="0,0,5,0">
                            <ContentPresenter ContentSource="Header" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="Background" Value="White"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
                                <Setter TargetName="border" Property="Background" Value="#F5F5F5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>


        <Style x:Key="MaterialIconButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="20">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BackgroundHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="MaterialIconToggleButton" TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="20">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BackgroundHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BackgroundSelectedBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

    </Page.Resources>

    <Grid Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="460"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Background="White" CornerRadius="8" Margin="10">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
            </Border.Effect>

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TabControl Grid.Row="0" Margin="5">

                    <TabItem Header="Tất cả Bàn">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10,5,10,10">
                                <TextBlock Text="Lọc Khu vực:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                                <ComboBox x:Name="cmbFilterKhuVuc" 
                                          Width="180" Margin="5"
                                          DisplayMemberPath="TenKhuVuc" 
                                          SelectedValuePath="IdKhuVuc"
                                          Style="{StaticResource FilterComboBox}"
                                          SelectionChanged="CmbFilterKhuVuc_SelectionChanged"/>

                                <TextBlock Text="Tìm kiếm:" VerticalAlignment="Center" Margin="15,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                                <TextBox x:Name="txtSearch" 
                                         Width="200" 
                                         Style="{StaticResource SearchTextBox}"
                                         TextChanged="TxtSearch_TextChanged"/>

                                <Button x:Name="btnClearFilter" ToolTip="Xóa Lọc"
                                        Style="{StaticResource MaterialIconButton}" 
                                        Click="BtnClearFilter_Click" Margin="5,0,0,0">
                                    <Path Data="{StaticResource IconClearFilter}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                                </Button>
                            </StackPanel>

                            <DataGrid Grid.Row="1" x:Name="dgAllBans" AutoGenerateColumns="False" IsReadOnly="True"
                                      SelectionMode="Single" SelectionChanged="DgAllBans_SelectionChanged"
                                      BorderThickness="0" RowHeaderWidth="0" Margin="10,0,10,10">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="ID" Binding="{Binding IdBan}" Width="50"/>
                                    <DataGridTextColumn Header="Số Bàn" Binding="{Binding SoBan}" Width="120"/>
                                    <DataGridTextColumn Header="Khu Vực" Binding="{Binding TenKhuVuc}" Width="120"/>
                                    <DataGridTextColumn Header="Số Ghế" Binding="{Binding SoGhe}" Width="80"/>
                                    <DataGridTextColumn Header="Trạng thái" Binding="{Binding TrangThai}" Width="120"/>
                                    <DataGridTextColumn Header="Ghi chú" Binding="{Binding GhiChu}" Width="*"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </TabItem>

                    <TabItem Header="Quản lý Khu vực">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10,5,10,10">
                                <TextBlock Text="Tìm kiếm Khu vực:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                                <TextBox x:Name="txtSearchKhuVuc" 
                                         Width="200" 
                                         Style="{StaticResource SearchTextBox}"
                                         TextChanged="TxtSearchKhuVuc_TextChanged"/>
                            </StackPanel>

                            <DataGrid Grid.Row="1" x:Name="dgKhuVuc" AutoGenerateColumns="False" IsReadOnly="True"
                                      SelectionMode="Single" SelectionChanged="DgKhuVuc_SelectionChanged"
                                      BorderThickness="0" RowHeaderWidth="0" Margin="10,0,10,10">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="ID" Binding="{Binding IdKhuVuc}" Width="50"/>
                                    <DataGridTextColumn Header="Tên Khu Vực" Binding="{Binding TenKhuVuc}" Width="*"/>
                                    <DataGridTextColumn Header="Mô Tả" Binding="{Binding MoTa}" Width="2*"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </TabItem>

                    <TabItem Header="Sự cố Bàn">
                        <Grid Margin="10">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <Grid Grid.Row="0" Margin="0,5,0,10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <TextBlock Grid.Column="0" x:Name="lblSuCoTitle" 
                                           Text="Sự cố Bàn cần xử lý" 
                                           FontSize="18" FontWeight="Bold" 
                                           Foreground="{StaticResource DarkBrownBrush}"
                                           VerticalAlignment="Center"/>

                                <ToggleButton Grid.Column="1" x:Name="btnToggleSuCoHistory"
                                              Style="{StaticResource MaterialIconToggleButton}"
                                              ToolTip="Xem lịch sử sự cố đã xử lý"
                                              Click="BtnToggleSuCoHistory_Click">
                                    <Path Data="{StaticResource IconHistory}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                                </ToggleButton>
                            </Grid>

                            <ListBox Grid.Row="1" x:Name="lbThongBaoBan" BorderThickness="0" ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Border BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="0,0,0,1" Padding="5,10">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <StackPanel Grid.Column="0">
                                                    <TextBlock Text="{Binding NoiDung}" TextWrapping="Wrap"/>
                                                    <TextBlock FontStyle="Italic" FontSize="11" Foreground="Gray">
                                                        <Run Text="{Binding TenNhanVienTao}"/> - <Run Text="{Binding ThoiGianTao, StringFormat='HH:mm dd/MM'}"/>
                                                    </TextBlock>
                                                </StackPanel>
                                                <Button Grid.Column="1" ToolTip="Đánh dấu đã xử lý" Margin="10,0,0,0" x:Name="btnDanhDauDaDoc" 
                                                        Click="BtnDanhDauDaDoc_Click" 
                                                        Style="{StaticResource IconButton}"
                                                        Content="{StaticResource IconCheck}"
                                                        Foreground="{StaticResource SuccessBrush}"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Grid>
                    </TabItem>
                </TabControl>

                <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,10,0,10">
                    <Button x:Name="btnThemKhuVuc" Click="BtnThemKhuVuc_Click" 
                            Style="{StaticResource MaterialIconButton}" 
                            ToolTip="Thêm Khu Vực Mới" Margin="0,0,10,0">
                        <Path Data="{StaticResource IconAddFolder}" Fill="{StaticResource DarkBrownBrush}" Width="30" Height="25" Stretch="Fill"/>
                    </Button>
                    <Button x:Name="btnThemBan" Click="BtnThemBan_Click" 
                            Style="{StaticResource MaterialIconButton}" 
                            ToolTip="Thêm Bàn Mới">
                        <Path Data="{StaticResource IconAddTable}" Fill="{StaticResource DarkBrownBrush}" Width="30" Height="25" Stretch="Fill"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <Border Grid.Column="1" Background="White" CornerRadius="8" Padding="25" Margin="0,10,10,10">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
            </Border.Effect>
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <TextBlock x:Name="lblFormTitle" Text="Chọn một mục để xem chi tiết" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,5,0,15"/>

                    <Grid x:Name="formChiTiet" IsEnabled="False">

                        <StackPanel x:Name="panelKhuVuc">
                            <Label Content="Tên Khu Vực"/>
                            <TextBox x:Name="txtTenKhuVuc" Text="{Binding TenKhuVuc, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                     Style="{StaticResource MaterialTextBox}"/>

                            <Label Content="Mô tả Khu Vực"/>
                            <TextBox x:Name="txtMoTaKhuVuc" Text="{Binding MoTa, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                     Style="{StaticResource MaterialTextBox}"
                                     Height="80" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"/>
                        </StackPanel>

                        <StackPanel x:Name="panelBan" Visibility="Collapsed">
                            <Label Content="Số Bàn (Tên Bàn)"/>
                            <TextBox x:Name="txtSoBan" Text="{Binding SoBan, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                     Style="{StaticResource MaterialTextBox}"/>

                            <Label Content="Số Ghế"/>
                            <TextBox x:Name="txtSoGhe" Text="{Binding SoGhe, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                     Style="{StaticResource MaterialTextBox}"/>

                            <Label Content="Thuộc Khu Vực"/>
                            <ComboBox x:Name="cmbKhuVuc" DisplayMemberPath="TenKhuVuc" SelectedValuePath="IdKhuVuc"
                                      Style="{StaticResource MaterialComboBox}"/>

                            <Label Content="Trạng thái (Khóa Bàn)"/>
                            <ComboBox x:Name="cmbTrangThai" SelectedValuePath="Content"
                                      Style="{StaticResource MaterialComboBox}">
                                <ComboBoxItem Content="Trống"/>
                                <ComboBoxItem Content="Đang phục vụ"/>
                                <ComboBoxItem Content="Bảo trì"/>
                                <ComboBoxItem Content="Tạm ngưng"/>
                            </ComboBox>

                            <Label Content="Ghi chú (Lý do sự cố)"/>
                            <TextBox x:Name="txtGhiChu" Text="{Binding GhiChu, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                     Style="{StaticResource MaterialTextBox}"
                                     Height="80" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"/>
                        </StackPanel>
                    </Grid>

                    <StackPanel x:Name="panelActions" Orientation="Horizontal" Margin="0,25,0,0">
                        <Button x:Name="btnLuu" Click="BtnLuu_Click" Margin="0,0,10,0" Style="{StaticResource ActionButton}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconSave}" Fill="White" Width="20" Height="20" Margin="0,0,8,0" VerticalAlignment="Center" Stretch="Fill"/>
                                <TextBlock Text="Lưu Thay Đổi" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>

                        <Button x:Name="btnXoa" Click="BtnXoa_Click" Margin="0,0,10,0" Style="{StaticResource DeleteButton}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconDelete}" Fill="White" Width="23" Height="23" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                <TextBlock Text="Xóa" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>

                        <Button x:Name="btnXemLichSu" Visibility="Collapsed" Click="BtnXemLichSu_Click" 
                                Background="#42A5F5" Style="{StaticResource ActionButton}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconHistory}" Fill="White" Width="23" Height="23" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                <TextBlock Text="Xem Lịch sử" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <Border x:Name="LoadingOverlay" Background="#80FFFFFF" Visibility="Collapsed"
                            Grid.RowSpan="2" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                        <TextBlock Text="Đang xử lý..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
                    </Border>
                </StackPanel>
            </ScrollViewer>
        </Border>
    </Grid>
</Page>

================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyBanView.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using System.Windows.Controls.Primitives; // <-- Đã thêm

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyBanView : Page
    {
        private static readonly HttpClient httpClient;
        private List<KhuVucDto> _khuVucList = new List<KhuVucDto>();
        private object? _selectedItem;
        private bool _isAddingNew = false;
        private int? _navigateToBanId = null;

        // Class nội bộ
        private class BanGridItem : BanDto
        {
            public string? TenKhuVuc { get; set; }
        }

        private List<BanGridItem> _allBansList = new List<BanGridItem>();
        private List<KhuVucDto> _filterKhuVucList = new List<KhuVucDto>();

        private List<ThongBaoDto> _allThongBaoList = new List<ThongBaoDto>();
        private bool _showSuCoHistory = false;


        static QuanLyBanView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyBanView()
        {
            InitializeComponent();
        }

        public QuanLyBanView(int banIdToNavigate) : this()
        {
            _navigateToBanId = banIdToNavigate;
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadDataAsync();
            await LoadThongBaoSuCoAsync();

            if (_navigateToBanId.HasValue)
            {
                SelectAndShowBan(_navigateToBanId.Value);
                _navigateToBanId = null;
            }
        }

        private async Task LoadDataAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                _khuVucList = (await httpClient.GetFromJsonAsync<List<KhuVucDto>>("api/app/banquanly/tree"))
                                 ?? new List<KhuVucDto>();

                // 1. Nạp dữ liệu cho ComboBox (trong Form chi tiết)
                cmbKhuVuc.ItemsSource = _khuVucList;

                // 2. Nạp dữ liệu cho DataGrid Khu Vực (Tab 1)
                dgKhuVuc.ItemsSource = _khuVucList;
                ApplyKhuVucFilter(); // Áp dụng filter (nếu có)

                // 3. Tạo danh sách phẳng (flat list) cho DataGrid Bàn (Tab 2)
                _allBansList = _khuVucList.SelectMany(kv => kv.Bans.Select(b => new BanGridItem
                {
                    IdBan = b.IdBan,
                    SoBan = b.SoBan,
                    SoGhe = b.SoGhe,
                    TrangThai = b.TrangThai,
                    GhiChu = b.GhiChu,
                    IdKhuVuc = b.IdKhuVuc,
                    TenKhuVuc = kv.TenKhuVuc
                })).OrderBy(b => b.IdBan).ToList();

                // 4. Nạp dữ liệu cho DataGrid Bàn
                dgAllBans.ItemsSource = _allBansList;

                // 5. Nạp dữ liệu cho ComboBox Lọc Bàn
                _filterKhuVucList = new List<KhuVucDto>(_khuVucList);
                _filterKhuVucList.Insert(0, new KhuVucDto { IdKhuVuc = 0, TenKhuVuc = "--- Tất cả Khu vực ---" });
                cmbFilterKhuVuc.ItemsSource = _filterKhuVucList;
                cmbFilterKhuVuc.SelectedIndex = 0;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải dữ liệu: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
                if (_navigateToBanId == null)
                    ResetForm();
            }
        }

        // --- (LoadThongBaoSuCoAsync, ApplySuCoFilter, BtnToggleSuCoHistory_Click, BtnDanhDauDaDoc_Click giữ nguyên) ---
        #region Sự Cố Bàn (Tab 3)
        private async Task LoadThongBaoSuCoAsync()
        {
            try
            {
                _allThongBaoList = (await httpClient.GetFromJsonAsync<List<ThongBaoDto>>("api/app/thongbao/all"))
                                        ?? new List<ThongBaoDto>();

                _allThongBaoList = _allThongBaoList.Where(t => t.LoaiThongBao == "SuCoBan").ToList();

                ApplySuCoFilter();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải thông báo sự cố: {ex.Message}");
            }
        }

        private void ApplySuCoFilter()
        {
            if (_showSuCoHistory)
            {
                lblSuCoTitle.Text = "Lịch sử Sự cố (Đã xử lý)";
                lbThongBaoBan.ItemsSource = _allThongBaoList
                    .Where(t => t.DaXem == true)
                    .OrderByDescending(t => t.ThoiGianTao)
                    .ToList();
            }
            else
            {
                lblSuCoTitle.Text = "Sự cố Bàn cần xử lý";
                lbThongBaoBan.ItemsSource = _allThongBaoList
                    .Where(t => t.DaXem == false)
                    .OrderByDescending(t => t.ThoiGianTao)
                    .ToList();
            }
        }

        private void BtnToggleSuCoHistory_Click(object sender, RoutedEventArgs e)
        {
            // === SỬA LỖI CS8602 ===
            // Thêm '?' để tránh lỗi nếu sender không phải là ToggleButton
            _showSuCoHistory = (sender as ToggleButton)?.IsChecked == true;
            ApplySuCoFilter();
        }

        private async void BtnDanhDauDaDoc_Click(object sender, RoutedEventArgs e)
        {
            var button = sender as Button;
            var thongBao = button?.DataContext as ThongBaoDto;

            if (thongBao != null)
            {
                if (thongBao.DaXem == false)
                {
                    try
                    {
                        var idThongBao = thongBao.IdThongBao;
                        var response = await httpClient.PostAsync($"api/app/thongbao/mark-as-read/{idThongBao}", null);

                        if (response.IsSuccessStatusCode)
                        {
                            var itemInCache = _allThongBaoList.FirstOrDefault(t => t.IdThongBao == idThongBao);
                            if (itemInCache != null)
                            {
                                itemInCache.DaXem = true;
                            }
                            ApplySuCoFilter();
                        }
                        else
                        {
                            MessageBox.Show($"Lỗi cập nhật: {await response.Content.ReadAsStringAsync()}");
                        }
                    }
                    catch (Exception ex)
                    {
                        MessageBox.Show($"Lỗi cập nhật: {ex.Message}");
                    }
                }
                else
                {
                    MessageBox.Show("Sự cố này đã được xử lý trước đó.");
                }
            }
        }
        #endregion

        private void SelectAndShowBan(int banId)
        {
            // (Giữ nguyên)
            var ban = _khuVucList.SelectMany(kv => kv.Bans).FirstOrDefault(b => b.IdBan == banId);
            if (ban != null)
            {
                _selectedItem = ban;
                PopulateForm();
                var gridItem = _allBansList.FirstOrDefault(b => b.IdBan == banId);
                if (gridItem != null)
                {
                    dgAllBans.SelectedItem = gridItem;
                    dgAllBans.ScrollIntoView(gridItem);
                }
            }
        }

        // --- (Các hàm Lọc/Tìm kiếm Bàn giữ nguyên) ---
        #region Lọc/Tìm kiếm Bàn (Tab 2)
        private void CmbFilterKhuVuc_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            ApplyFilter();
        }

        private void TxtSearch_TextChanged(object sender, TextChangedEventArgs e)
        {
            ApplyFilter();
        }

        private void BtnClearFilter_Click(object sender, RoutedEventArgs e)
        {
            // CẬP NHẬT: Xóa luôn filter của Tab 1
            txtSearchKhuVuc.Text = "";
            ApplyKhuVucFilter();

            if (cmbFilterKhuVuc.SelectedIndex != 0)
                cmbFilterKhuVuc.SelectedIndex = 0;

            if (!string.IsNullOrEmpty(txtSearch.Text))
                txtSearch.Text = "";

            ApplyFilter();
        }

        private void ApplyFilter()
        {
            if (_allBansList == null) return;
            IEnumerable<BanGridItem> filteredView = _allBansList;
            if (cmbFilterKhuVuc.SelectedItem is KhuVucDto selectedKhuVuc && selectedKhuVuc.IdKhuVuc != 0)
            {
                filteredView = filteredView.Where(b => b.IdKhuVuc == selectedKhuVuc.IdKhuVuc);
            }
            string searchText = txtSearch.Text.Trim();
            if (!string.IsNullOrEmpty(searchText))
            {
                filteredView = filteredView.Where(b =>
                    b.SoBan.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                    (b.GhiChu != null && b.GhiChu.Contains(searchText, StringComparison.OrdinalIgnoreCase)) ||
                    b.TrangThai.Contains(searchText, StringComparison.OrdinalIgnoreCase)
                );
            }
            dgAllBans.ItemsSource = filteredView.ToList();
        }
        #endregion

        // --- THÊM MỚI: Các hàm Lọc/Tìm kiếm Khu Vực ---
        #region Lọc/Tìm kiếm Khu Vực (Tab 1)

        private void TxtSearchKhuVuc_TextChanged(object sender, TextChangedEventArgs e)
        {
            ApplyKhuVucFilter();
        }

        private void ApplyKhuVucFilter()
        {
            if (_khuVucList == null) return;

            IEnumerable<KhuVucDto> filteredView = _khuVucList;
            string searchText = txtSearchKhuVuc.Text.Trim();

            if (!string.IsNullOrEmpty(searchText))
            {
                filteredView = filteredView.Where(kv =>
                    kv.TenKhuVuc.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                    (kv.MoTa != null && kv.MoTa.Contains(searchText, StringComparison.OrdinalIgnoreCase))
                );
            }
            dgKhuVuc.ItemsSource = filteredView.ToList();
        }

        #endregion


        // --- CẬP NHẬT: Các hàm chọn Grid ---
        #region Grid Selection & Form Logic

        private void DgKhuVuc_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgKhuVuc.SelectedItem is KhuVucDto selectedKhuVuc)
            {
                _selectedItem = selectedKhuVuc;
                _isAddingNew = false;

                // Bỏ chọn Grid Bàn
                dgAllBans.SelectedItem = null;

                PopulateForm();
            }
        }

        private void DgAllBans_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgAllBans.SelectedItem == null)
            {
                return;
            }

            if (dgAllBans.SelectedItem is BanGridItem selectedBan)
            {
                _selectedItem = _khuVucList
                    .SelectMany(kv => kv.Bans)
                    .FirstOrDefault(b => b.IdBan == selectedBan.IdBan);

                _isAddingNew = false;

                // Bỏ chọn Grid Khu Vực
                dgKhuVuc.SelectedItem = null;

                PopulateForm();
            }
        }

        private void PopulateForm()
        {
            // (Giữ nguyên)
            panelKhuVuc.Visibility = Visibility.Collapsed;
            panelBan.Visibility = Visibility.Collapsed;
            formChiTiet.IsEnabled = false;
            btnXemLichSu.Visibility = Visibility.Collapsed;
            formChiTiet.DataContext = null;

            if (_selectedItem == null)
            {
                lblFormTitle.Text = "Chọn một mục để xem chi tiết";
                return;
            }

            formChiTiet.IsEnabled = true;

            if (_selectedItem is KhuVucDto kv)
            {
                lblFormTitle.Text = "Chi tiết Khu Vực";
                panelKhuVuc.Visibility = Visibility.Visible;
                panelBan.Visibility = Visibility.Collapsed; // Ẩn panel Bàn
                formChiTiet.DataContext = kv;
            }
            else if (_selectedItem is BanDto ban)
            {
                lblFormTitle.Text = "Chi tiết Bàn";
                panelBan.Visibility = Visibility.Visible;
                panelKhuVuc.Visibility = Visibility.Collapsed; // Ẩn panel Khu vực
                formChiTiet.DataContext = ban;

                cmbKhuVuc.SelectedValue = ban.IdKhuVuc;
                cmbTrangThai.Text = ban.TrangThai;
                btnXemLichSu.Visibility = Visibility.Visible;
            }
        }

        private void BtnThemKhuVuc_Click(object sender, RoutedEventArgs e)
        {
            _selectedItem = new KhuVucDto();
            _isAddingNew = true;

            // CẬP NHẬT: Bỏ chọn cả 2 Grid
            dgKhuVuc.SelectedItem = null;
            dgAllBans.SelectedItem = null;

            PopulateForm();
            lblFormTitle.Text = "Thêm Khu Vực Mới";
            formChiTiet.DataContext = _selectedItem;
        }

        private void BtnThemBan_Click(object sender, RoutedEventArgs e)
        {
            int defaultKhuVucId = _khuVucList.FirstOrDefault()?.IdKhuVuc ?? 0;
            _selectedItem = new BanDto { IdKhuVuc = defaultKhuVucId, TrangThai = "Trống" };
            _isAddingNew = true;

            // CẬP NHẬT: Bỏ chọn cả 2 Grid
            dgKhuVuc.SelectedItem = null;
            dgAllBans.SelectedItem = null;

            PopulateForm();
            lblFormTitle.Text = "Thêm Bàn Mới";
            formChiTiet.DataContext = _selectedItem;
        }

        private void ResetForm()
        {
            _selectedItem = null;
            _isAddingNew = false;
            dgAllBans.SelectedItem = null;
            dgKhuVuc.SelectedItem = null; // Thêm
            PopulateForm();
        }

        #endregion

        // --- (Các hàm Lưu, Xóa, Xem Lịch sử giữ nguyên, chúng đã hỗ trợ KhuVuc) ---
        #region API Calls (Lưu, Xóa, Lịch sử)
        private async void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedItem == null) return;
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                HttpResponseMessage response;
                if (_selectedItem is KhuVucDto kv)
                {
                    var dto = new KhuVucUpdateRequestDto { TenKhuVuc = txtTenKhuVuc.Text, MoTa = txtMoTaKhuVuc.Text };
                    if (_isAddingNew)
                        response = await httpClient.PostAsJsonAsync("api/app/banquanly/khuvuc", dto);
                    else
                        response = await httpClient.PutAsJsonAsync($"api/app/banquanly/khuvuc/{kv.IdKhuVuc}", dto);
                }
                else if (_selectedItem is BanDto ban)
                {
                    var dto = new BanUpdateRequestDto
                    {
                        SoBan = txtSoBan.Text,
                        SoGhe = int.TryParse(txtSoGhe.Text, out int ghe) ? ghe : 0,
                        IdKhuVuc = (int)cmbKhuVuc.SelectedValue,
                        TrangThai = cmbTrangThai.Text,
                        GhiChu = txtGhiChu.Text
                    };

                    if (_isAddingNew)
                        response = await httpClient.PostAsJsonAsync("api/app/banquanly/ban", dto);
                    else
                        response = await httpClient.PutAsJsonAsync($"api/app/banquanly/ban/{ban.IdBan}", dto);
                }
                else
                {
                    throw new InvalidOperationException("Loại đối tượng không xác định.");
                }

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Lưu thành công!", "Thông báo");
                    await LoadDataAsync();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi: {ex.Message}", "Lỗi");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXoa_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedItem == null) return;
            string endpoint;
            string tenMuc;

            if (_selectedItem is KhuVucDto kv)
            {
                endpoint = $"api/app/banquanly/khuvuc/{kv.IdKhuVuc}";
                tenMuc = kv.TenKhuVuc;
            }
            else if (_selectedItem is BanDto ban)
            {
                endpoint = $"api/app/banquanly/ban/{ban.IdBan}";
                tenMuc = ban.SoBan;
            }
            else
            {
                return;
            }

            if (MessageBox.Show($"Bạn có chắc chắn muốn xóa '{tenMuc}' không?", "Xác nhận xóa", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.No)
            {
                return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync(endpoint);

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Xóa thành công!", "Thông báo");
                    await LoadDataAsync();
                }
                else if (response.StatusCode == HttpStatusCode.Conflict)
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Không thể xóa");
                }
                else
                {
                    MessageBox.Show($"Lỗi: {response.ReasonPhrase}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi: {ex.Message}", "Lỗi");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXemLichSu_Click(object sender, RoutedEventArgs e)
        {
            if (!(_selectedItem is BanDto ban)) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var history = await httpClient.GetFromJsonAsync<BanHistoryDto>($"api/app/banquanly/ban/{ban.IdBan}/history");
                if (history != null)
                {
                    MessageBox.Show(
                        $"Lịch sử Bàn: {ban.SoBan}\n\n" +
                        $"- Tổng số lượt phục vụ (HĐ đã thanh toán): {history.SoLuotPhucVu}\n" +
                        $"- Tổng doanh thu mang lại: {history.TongDoanhThu:N0} VND\n" +
                        $"- Tổng số lượt đặt trước: {history.SoLuotDatTruoc}",
                        "Lịch sử Bàn"
                    );
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải lịch sử: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }
        #endregion
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyDanhGiaView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyDanhGiaView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1000"
      Title="QuanLyDanhGiaView"
      Loaded="Page_Loaded"
      FontFamily="Segoe UI">

    <Page.Resources>
        <local:StatusToButtonStyleConverter x:Key="StatusToButtonStyleConverter"/>
        <local:NullOrEmptyToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <local:StatusToStyleConverter x:Key="StatusToStyleConverter"/>
        <local:StatusToContentConverter x:Key="StatusToContentConverter"/>


        <Style TargetType="Button" x:Key="BaseButton">
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="Margin" Value="5"/>
            <Setter Property="MinWidth" Value="80"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style TargetType="Button" x:Key="PrimaryButton" BasedOn="{StaticResource BaseButton}">
            <Setter Property="Background" Value="#6F4E37"/>

            <Setter Property="Foreground" Value="White"/>
        </Style>
        <Style TargetType="Button" x:Key="SecondaryButton" BasedOn="{StaticResource BaseButton}">
            <Setter Property="Background" Value="#A1887F"/>
            <Setter Property="Foreground" Value="White"/>
        </Style>
        <Style TargetType="Button" x:Key="WarningButton" BasedOn="{StaticResource BaseButton}">
            <Setter Property="Background" Value="#D27D2D"/>

            <Setter Property="Foreground" Value="White"/>
        </Style>
    </Page.Resources>

    <Grid Background="#FFF8E1">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>

        </Grid.RowDefinitions>

        <TextBlock Text="Quản lý Đánh giá Khách hàng"
                   Grid.Row="0"
                   FontSize="24" FontWeight="SemiBold"
                   Foreground="#4E342E"
                   Margin="20"/>


        <Border Grid.Row="1" Background="White" CornerRadius="5" Margin="20,0,20,15" Padding="20"
                BorderBrush="#E0E0E0" BorderThickness="1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>

                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Margin="0,0,20,0">
                    <TextBlock Text="Tổng quan Sản phẩm" FontSize="18" FontWeight="SemiBold" Foreground="#4E342E"/>
                    <TextBlock Text="Nhập tên món để xem thống kê đánh giá" Margin="0,5,0,10" Foreground="#6D4C41"/>

                    <TextBox x:Name="txtProductSearch" 
                             Height="35" 
                             FontSize="14"
                             Padding="5"
  
                           TextChanged="TxtProductSearch_TextChanged"/>
                    <ListBox x:Name="lbSearchResults" 
                             MaxHeight="150" 
                     
         Margin="0,5,0,0"
                             DisplayMemberPath="TenSanPham"
                             SelectionChanged="LbSearchResults_SelectionChanged"/>
                </StackPanel>

                <Border Grid.Column="1" 
 Background="#F9FBE7" CornerRadius="5" Padding="20" MinWidth="250">
                    <StackPanel VerticalAlignment="Center">
                        <TextBlock Text="ĐIỂM TRUNG BÌNH (Sao)" FontSize="12" Foreground="Gray"/>
                        <TextBlock x:Name="tbAvgRating" Text="0.0" FontSize="32" FontWeight="Bold" Foreground="#f5b301" Margin="0,2,0,0"/>


                        <TextBlock Text="TỔNG SỐ ĐÁNH GIÁ (Hiển thị)" FontSize="12" Foreground="Gray" Margin="0,15,0,0"/>
                        <TextBlock x:Name="tbTotalReviews" Text="0" FontSize="32" FontWeight="Bold" Foreground="#4E342E" Margin="0,2,0,0"/>
                    </StackPanel>
                </Border>
            </Grid>

        </Border>

        <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="20,0,20,10">
            <TextBlock Text="Lọc theo sao:" VerticalAlignment="Center" Margin="0,0,5,0"/>
            <ComboBox x:Name="cbFilterSao" Width="100" Margin="0,0,20,0">
                <ComboBoxItem Content="Tất cả" Tag="{x:Null}"/>
                <ComboBoxItem Content="5 Sao" Tag="5"/>

                <ComboBoxItem Content="4 Sao" Tag="4"/>
                <ComboBoxItem Content="3 Sao" Tag="3"/>
                <ComboBoxItem Content="2 Sao" Tag="2"/>
                <ComboBoxItem Content="1 Sao" Tag="1"/>
            </ComboBox>
            <TextBlock Text="Trạng thái:" VerticalAlignment="Center" Margin="0,0,5,0"/>

            <ComboBox x:Name="cbFilterTrangThai" Width="120" Margin="0,0,20,0">
                <ComboBoxItem Content="Tất cả" Tag="{x:Null}"/>
                <ComboBoxItem Content="Hiển thị" Tag="Hiển thị"/>
                <ComboBoxItem Content="Đã ẩn" Tag="Đã ẩn"/>
            </ComboBox>
            <Button x:Name="btnFilter" Content="Lọc" Style="{StaticResource PrimaryButton}" Click="BtnFilter_Click"/>
        </StackPanel>


        <ListView x:Name="lvDanhGia" Grid.Row="3" Margin="20,0,20,10"
                  ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                  SelectionMode="Single"
                  SelectionChanged="LvDanhGia_SelectionChanged">
            <ListView.ItemContainerStyle>
                <Style TargetType="ListViewItem">
                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>

                </Style>
            </ListView.ItemContainerStyle>
            <ListView.ItemTemplate>
                <DataTemplate>
                    <Border Background="White" CornerRadius="5" BorderBrush="#EEE" BorderThickness="1"
                       
         Padding="15" Margin="0,5">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>

                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0" Margin="0,0,15,0">

                                <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                                    <TextBlock Text="{Binding SoSao, StringFormat='{}{0} Sao'}" 
                                           
     FontWeight="Bold" FontSize="16" Foreground="#f5b301"/>
                                    <TextBlock Text="từ" Margin="5,0" VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding TenKhachHang}" FontWeight="SemiBold" VerticalAlignment="Center"/>

                                    <TextBlock Text="lúc" Margin="5,0" VerticalAlignment="Center" FontStyle="Italic"/>
                                    <TextBlock Text="{Binding NgayTao, StringFormat='HH:mm dd/MM/yyyy'}" VerticalAlignment="Center" FontStyle="Italic"/>
                                </StackPanel>

                                <TextBlock Text="{Binding TenSanPham}" FontSize="14" FontWeight="Bold" Margin="0,0,0,5"
                                           Visibility="{Binding TenSanPham, Converter={StaticResource NullToVisibilityConverter}}"/>

                                <TextBlock Text="{Binding BinhLuan}" TextWrapping="Wrap" Margin="0,0,0,10"
                                           Visibility="{Binding BinhLuan, Converter={StaticResource NullToVisibilityConverter}}"/>
                                <Image Source="{Binding HinhAnhUrl}" MaxHeight="150" 
 HorizontalAlignment="Left"
                                       Visibility="{Binding HinhAnhUrl, Converter={StaticResource NullToVisibilityConverter}}"/>
                                <Border Background="#f9f9f9" CornerRadius="3" Padding="10" Margin="0,10,0,0"
                      
                                        BorderBrush="#EEE" BorderThickness="1"
                                        Visibility="{Binding PhanHoi, Converter={StaticResource NullToVisibilityConverter}}">
                                    <StackPanel>

                                        <TextBlock FontWeight="SemiBold" Margin="0,0,0,5">
                                            <Run Text="Phản hồi từ "/>
            
                                 <Run Text="{Binding PhanHoi.TenNhanVien}"/>:
                                        </TextBlock>

                                        <TextBlock Text="{Binding PhanHoi.NoiDung}" TextWrapping="Wrap"/>
                                    </StackPanel>
                                </Border>

                            </StackPanel>
                            <StackPanel Grid.Column="1" VerticalAlignment="Top">

                                <Button x:Name="btnToggleStatus"
                                        Tag="{Binding IdDanhGia}" Click="BtnToggleStatus_Click"
                                        Style="{Binding TrangThai, Converter={StaticResource StatusToStyleConverter}}"
                                        Content="{Binding TrangThai, Converter={StaticResource StatusToContentConverter}}"/>

                                <Button x:Name="btnReply" Content="Trả lời"
                                        Tag="{Binding}" Click="BtnReply_Click"
                                        Style="{StaticResource SecondaryButton}"/>

                            </StackPanel>
                        </Grid>
                    </Border>
                </DataTemplate>
            </ListView.ItemTemplate>
        </ListView>

        <StackPanel Grid.Row="4" Orientation="Horizontal" HorizontalAlignment="Right" Margin="20">

            <Button x:Name="btnPrevPage" Content="&lt; Trước" Style="{StaticResource SecondaryButton}" Click="BtnPrevPage_Click"/>
            <TextBlock x:Name="tbCurrentPage" Text="1 / 1" VerticalAlignment="Center" Margin="10,0"/>
            <Button x:Name="btnNextPage" Content="Sau &gt;" Style="{StaticResource SecondaryButton}" Click="BtnNextPage_Click"/>
        </StackPanel>

        <Popup x:Name="popupReply" Placement="Center" StaysOpen="False"
               AllowsTransparency="True" PopupAnimation="Fade">
            <Border Background="White" BorderBrush="Gray" BorderThickness="1" CornerRadius="5"
          
           Width="400" Padding="15">
                <Border.Effect>
                    <DropShadowEffect ShadowDepth="3" Opacity="0.3" BlurRadius="5"/>
                </Border.Effect>
                <StackPanel>

                    <TextBlock Text="Trả lời đánh giá" FontSize="18" FontWeight="SemiBold" Margin="0,0,0,10"/>
                    <TextBlock x:Name="tbReviewInfo" TextWrapping="Wrap" FontStyle="Italic" Background="#f5f5f5" Padding="5" Margin="0,0,0,10"/>
                    <TextBox x:Name="txtReplyInput" Height="100" TextWrapping="Wrap" VerticalScrollBarVisibility="Auto"
                             AcceptsReturn="True"/>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0">
                        <Button x:Name="btnSendReply" Content="Gửi" Style="{StaticResource PrimaryButton}" Click="BtnSendReply_Click"/>
                        <Button x:Name="btnCancelReply" Content="Hủy" Style="{StaticResource SecondaryButton}" Click="BtnCancelReply_Click"/>
                    </StackPanel>

                </StackPanel>
            </Border>
        </Popup>

    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyDanhGiaView.xaml.cs
================================================================================
﻿using AppCafebookApi.Services;
using CafebookModel.Model.ModelApp;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Globalization;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Threading; // THÊM DÒNG NÀY

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyDanhGiaView : Page
    {
        private readonly HttpClient _httpClient;
        private int _currentPage = 1;
        private int _totalPages = 1;

        private DispatcherTimer _searchTimer; // Timer cho tìm kiếm

        public QuanLyDanhGiaView()
        {
            InitializeComponent();

            // SỬA LỖI: Dùng HttpClient từ ApiClient Singleton
            _httpClient = ApiClient.Instance; // <-- Dòng này ĐÚNG

            // Khởi tạo timer
            _searchTimer = new DispatcherTimer
            {
                Interval = TimeSpan.FromMilliseconds(500) // Chờ 0.5 giây sau khi gõ
            };
            _searchTimer.Tick += SearchTimer_Tick;
        }

        // === LOGIC CHO TAB 1 (QUẢN LÝ ĐÁNH GIÁ) ===

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            cbFilterSao.SelectedIndex = 0;
            cbFilterTrangThai.SelectedIndex = 0;
            await LoadDataAsync();
        }

        private async Task LoadDataAsync()
        {
            try
            {
                int? filterSao = (cbFilterSao.SelectedItem as ComboBoxItem)?.Tag as int?;
                string? trangThai = (cbFilterTrangThai.SelectedItem as ComboBoxItem)?.Tag as string;

                var result = await GetReviewsAsync(_currentPage, filterSao, trangThai);

                if (result != null)
                {
                    lvDanhGia.ItemsSource = result.Items;
                    _totalPages = result.TotalPages;
                    _currentPage = result.CurrentPage;

                    tbCurrentPage.Text = $"{_currentPage} / {_totalPages}";
                    btnPrevPage.IsEnabled = _currentPage > 1;
                    btnNextPage.IsEnabled = _currentPage < _totalPages;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi khi tải danh sách đánh giá: {ex.Message}", "Lỗi API");
            }
        }

        private async void BtnFilter_Click(object sender, RoutedEventArgs e)
        {
            _currentPage = 1;
            await LoadDataAsync();
        }

        private async void BtnPrevPage_Click(object sender, RoutedEventArgs e)
        {
            if (_currentPage > 1)
            {
                _currentPage--;
                await LoadDataAsync();
            }
        }

        private async void BtnNextPage_Click(object sender, RoutedEventArgs e)
        {
            if (_currentPage < _totalPages)
            {
                _currentPage++;
                await LoadDataAsync();
            }
        }

        private async void BtnToggleStatus_Click(object sender, RoutedEventArgs e)
        {
            if ((sender as Button)?.Tag is int idDanhGia)
            {
                try
                {
                    bool success = await ToggleReviewStatusAsync(idDanhGia);
                    if (success)
                    {
                        await LoadDataAsync();
                    }
                    else
                    {
                        MessageBox.Show("Không thể cập nhật trạng thái.", "Lỗi");
                    }
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Lỗi: {ex.Message}", "Lỗi API");
                }
            }
        }

        private void BtnReply_Click(object sender, RoutedEventArgs e)
        {
            if ((sender as Button)?.Tag is DanhGiaQuanLyDto review)
            {
                popupReply.DataContext = review;
                tbReviewInfo.Text = $"Đang trả lời: \"{review.BinhLuan?.Substring(0, Math.Min(50, review.BinhLuan.Length))}...\"";
                txtReplyInput.Text = review.PhanHoi?.NoiDung ?? "";
                popupReply.IsOpen = true;
                txtReplyInput.Focus();
            }
        }

        private async void BtnSendReply_Click(object sender, RoutedEventArgs e)
        {
            if (popupReply.DataContext is DanhGiaQuanLyDto review)
            {
                string noiDung = txtReplyInput.Text;
                if (string.IsNullOrWhiteSpace(noiDung))
                {
                    MessageBox.Show("Vui lòng nhập nội dung phản hồi.", "Thiếu thông tin");
                    return;
                }

                try
                {
                    bool success = await ReplyToReviewAsync(review.IdDanhGia, noiDung);
                    if (success)
                    {
                        MessageBox.Show("Gửi phản hồi thành công!");
                        popupReply.IsOpen = false;
                        await LoadDataAsync();
                    }
                    else
                    {
                        MessageBox.Show("Không thể gửi phản hồi.", "Lỗi");
                    }
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Lỗi: {ex.Message}", "Lỗi API");
                }
            }
        }

        private void BtnCancelReply_Click(object sender, RoutedEventArgs e)
        {
            popupReply.IsOpen = false;
        }

        // === CÁC HÀM HELPER GỌI API (Tab 1) ===

        private async Task<PaginatedResult<DanhGiaQuanLyDto>?> GetReviewsAsync(int page = 1, int? filterSao = null, string? trangThai = null)
        {
            try
            {
                var queryParams = new List<string> { $"page={page}", "pageSize=10" };
                if (filterSao.HasValue) { queryParams.Add($"filterSao={filterSao.Value}"); }
                if (!string.IsNullOrEmpty(trangThai)) { queryParams.Add($"trangThai={Uri.EscapeDataString(trangThai)}"); }
                string url = $"api/app/quanlydanhgia?{string.Join("&", queryParams)}";

                var response = await _httpClient.GetAsync(url);

                // NẾU LÀ 401 (Chưa đăng nhập) THÌ SẼ BÁO LỖI
                if (!response.IsSuccessStatusCode)
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    throw new Exception($"API Error: {response.StatusCode} - {errorContent}");
                }

                return await response.Content.ReadFromJsonAsync<PaginatedResult<DanhGiaQuanLyDto>>();
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"Lỗi GetReviewsAsync: {ex.Message}");
                throw;
            }
        }

        private async Task<bool> ReplyToReviewAsync(int idDanhGia, string noiDung)
        {
            try
            {
                var input = new PhanHoiInputDto { NoiDung = noiDung };
                var response = await _httpClient.PostAsJsonAsync($"api/app/quanlydanhgia/{idDanhGia}/reply", input);
                return response.IsSuccessStatusCode; // Sẽ là true nếu API chạy thành công
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"Lỗi ReplyToReviewAsync: {ex.Message}");
                return false;
            }
        }

        private async Task<bool> ToggleReviewStatusAsync(int idDanhGia)
        {
            try
            {
                var response = await _httpClient.PutAsync($"api/app/quanlydanhgia/{idDanhGia}/toggle-status", null);
                return response.IsSuccessStatusCode;
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"Lỗi ToggleReviewStatusAsync: {ex.Message}");
                return false;
            }
        }

        // === LOGIC MỚI CHO TAB 2 (TỔNG QUAN) ===

        private void TxtProductSearch_TextChanged(object sender, TextChangedEventArgs e)
        {
            // Reset timer mỗi khi gõ phím
            _searchTimer.Stop();
            _searchTimer.Start();
        }

        private async void SearchTimer_Tick(object? sender, EventArgs e)
        {
            _searchTimer.Stop(); // Dừng timer
            string query = txtProductSearch.Text;

            if (string.IsNullOrWhiteSpace(query))
            {
                lbSearchResults.ItemsSource = null;
                return;
            }

            try
            {
                var products = await SearchProductsAsync(query);
                lbSearchResults.ItemsSource = products;
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"Lỗi tìm kiếm sản phẩm: {ex.Message}");
            }
        }

        // === BƯỚC 1: TÁI CẤU TRÚC LOGIC RA HÀM RIÊNG ===
        private async Task UpdateProductStats(int? productId)
        {
            // Nếu không có Id sản phẩm (ví dụ: đánh giá chung), thì reset
            if (!productId.HasValue)
            {
                tbAvgRating.Text = "0.0";
                tbTotalReviews.Text = "0";
                return;
            }

            try
            {
                // Gọi API lấy thống kê (hàm này đã có)
                var stats = await GetProductStatsAsync(productId.Value);
                if (stats != null)
                {
                    tbAvgRating.Text = stats.AverageRating.ToString("0.0");
                    tbTotalReviews.Text = stats.TotalReviews.ToString();
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi lấy thống kê: {ex.Message}");
                tbAvgRating.Text = "Lỗi";
                tbTotalReviews.Text = "Lỗi";
            }
        }

        // === BƯỚC 2: CẬP NHẬT HÀM CŨ ===
        private async void LbSearchResults_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (lbSearchResults.SelectedItem is ProductSearchResultDto product)
            {
                // Gọi hàm helper mới
                await UpdateProductStats(product.IdSanPham);
            }
        }

        // === BƯỚC 3: THÊM HÀM MỚI CHO LISTVIEW ===
        private async void LvDanhGia_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            // Lấy đánh giá được chọn từ ListView
            if (lvDanhGia.SelectedItem is DanhGiaQuanLyDto review)
            {
                // Gọi hàm helper mới với IdSanPham từ đánh giá
                await UpdateProductStats(review.IdSanPham);
            }
        }

        // === CÁC HÀM HELPER GỌI API (Tab 2) ===

        private async Task<List<ProductSearchResultDto>?> SearchProductsAsync(string query)
        {
            var response = await _httpClient.GetAsync($"api/app/quanlydanhgia/search-products?query={Uri.EscapeDataString(query)}");
            response.EnsureSuccessStatusCode(); // Sẽ báo lỗi nếu API thất bại
            return await response.Content.ReadFromJsonAsync<List<ProductSearchResultDto>>();
        }

        private async Task<ProductStatsDto?> GetProductStatsAsync(int productId)
        {
            var response = await _httpClient.GetAsync($"api/app/quanlydanhgia/product-stats?productId={productId}");
            response.EnsureSuccessStatusCode();
            return await response.Content.ReadFromJsonAsync<ProductStatsDto>();
        }
    }

    // --- CONVERTER (Giữ nguyên) ---
    public class StatusToButtonStyleConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            string trangThai = value as string ?? "";
            Style? style;
            if (trangThai == "Hiển thị")
            {
                style = Application.Current.TryFindResource("WarningButton") as Style;
            }
            else
            {
                style = Application.Current.TryFindResource("SecondaryButton") as Style;
            }

            if (style != null)
            {
                Style newStyle = new Style(typeof(Button), style);
                newStyle.Setters.Add(new Setter(ContentControl.ContentProperty, trangThai == "Hiển thị" ? "Ẩn" : "Hiện"));
                return newStyle;
            }
            return Application.Current.TryFindResource("BaseButton");
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }
    // BƯỚC 1: THAY THẾ 'StatusToButtonStyleConverter' BẰNG CONVERTER NÀY
    public class StatusToStyleConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            string trangThai = value as string ?? "";
            Style? style;
            if (trangThai == "Hiển thị")
            {
                style = Application.Current.TryFindResource("WarningButton") as Style;
            }
            else
            {
                style = Application.Current.TryFindResource("SecondaryButton") as Style;
            }
            return style ?? Application.Current.TryFindResource("BaseButton");
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }

    // BƯỚC 2: THÊM CONVERTER MỚI NÀY VÀO
    public class StatusToContentConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            string trangThai = value as string ?? "";
            return trangThai == "Hiển thị" ? "Ẩn" : "Hiện";
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }

    // --- KẾT THÚC SỬA LỖI ---
    // --- CONVERTER (Giữ nguyên) ---
    public class NullOrEmptyToVisibilityConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value == null)
                return Visibility.Collapsed;
            if (value is string str)
            {
                return string.IsNullOrWhiteSpace(str) ? Visibility.Collapsed : Visibility.Visible;
            }
            return Visibility.Visible;
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyDonHangView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyDonHangView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="QuanLyDonHangView" FontFamily="Segoe UI" Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="StatusGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="StatusRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="StatusBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="StatusYellowBrush" Color="#FFF9C4"/>
        <SolidColorBrush x:Key="StatusCanceledBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>

        
        <Geometry x:Key="IconFilter">M14,12V19.88C14.04,20.18 13.94,20.5 13.71,20.71C13.32,21.1 12.69,21.1 12.3,20.71L10.29,18.7C10.06,18.47 9.96,18.16 10,17.87V12H14M15,9H9V4H15V9Z</Geometry>
        <Geometry x:Key="IconFilterOff">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconPrint">M19,8H5C3.34,8 2,9.34 2,11V17H6V21H18V17H22V11C22,9.34 20.66,8 19,8M16,19H8V14H16V19M19,12C18.45,12 18,11.55 18,11C18,10.45 18.45,10 19,10C19.55,10 20,10.45 20,11C20,11.55 19.55,12 19,12M18,3H6V7H18V3Z</Geometry>
        <Geometry x:Key="IconCancel">M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z</Geometry>
        <Geometry x:Key="IconDelivery">M16,11H12.5V8H8V14H10V11H10.5L12.5,13L14.5,11H16M20,8H17V6H10V8H7L3,12V18H5V20H7V18H17V20H19V18H21V12L20,8Z</Geometry>
        <Geometry x:Key="IconExcel">M21.17 3.25Q21.5 3.25 21.76 3.5 22 3.74 22 4.08V19.92Q22 20.26 21.76 20.5 21.5 20.75 21.17 20.75H7.83Q7.5 20.75 7.24 20.5 7 20.26 7 19.92V4.08Q7 3.74 7.24 3.5 7.5 3.25 7.83 3.25H21.17M13.83 18.25V15.7H11.5V14.05L13.72 10.63H11.6V9H16.33V10.65L14.12 14.07H16.25V15.7H13.83V18.25M6.25 15.5Q6.25 15.15 6.04 14.88 5.82 14.6 5.5 14.6H3.5Q3.18 14.6 2.96 14.88 2.75 15.15 2.75 15.5V17.5Q2.75 17.82 2.96 18.1 3.18 18.38 3.5 18.38H5.5Q5.82 18.38 6.04 18.1 6.25 17.82 6.25 17.5V15.5M6.25 9.5Q6.25 9.18 6.04 8.9 5.82 8.62 5.5 8.62H3.5Q3.18 8.62 2.96 8.9 2.75 9.18 2.75 9.5V11.5Q2.75 11.82 2.96 12.1 3.18 12.38 3.5 12.38H5.5Q5.82 12.38 6.04 12.1 6.25 11.82 6.25 11.5V9.5Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="DataGridRowStyle" TargetType="DataGridRow">
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding TrangThai}" Value="Đã thanh toán">
                    <Setter Property="Background" Value="{StaticResource StatusGreenBrush}"/>
                    <Setter Property="Opacity" Value="0.7"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TrangThai}" Value="Chưa thanh toán">
                    <Setter Property="Background" Value="{StaticResource StatusYellowBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding LoaiHoaDon}" Value="Giao hàng">
                    <Setter Property="Background" Value="{StaticResource StatusBlueBrush}"/>
                    <Setter Property="Opacity" Value="0.6"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TrangThai}" Value="Đã hủy">
                    <Setter Property="Background" Value="{StaticResource StatusCanceledBrush}"/>
                    <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="{StaticResource WhiteTextBrush}" CornerRadius="8" Padding="15" Margin="15,15,15,0">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
            </Border.Effect>
            <WrapPanel Orientation="Horizontal">
                <TextBlock Text="Từ ngày:" VerticalAlignment="Center" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}" Margin="5"/>
                <DatePicker x:Name="dpTuNgay" Width="130" Margin="5" VerticalContentAlignment="Center"/>
                <TextBlock Text="Đến ngày:" VerticalAlignment="Center" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}" Margin="10,5,5,5"/>
                <DatePicker x:Name="dpDenNgay" Width="130" Margin="5" VerticalContentAlignment="Center"/>

                <TextBlock Text="Trạng thái:" VerticalAlignment="Center" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}" Margin="10,5,5,5"/>
                <ComboBox x:Name="cmbTrangThai" Width="140" Margin="5" VerticalContentAlignment="Center">
                    <ComboBoxItem Content="Tất cả"/>
                    <ComboBoxItem Content="Chưa thanh toán"/>
                    <ComboBoxItem Content="Đã thanh toán"/>
                    <ComboBoxItem Content="Đã hủy"/>
                </ComboBox>

                <TextBlock Text="Nhân viên:" VerticalAlignment="Center" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}" Margin="10,5,5,5"/>
                <ComboBox x:Name="cmbNhanVien" Width="140" Margin="5" DisplayMemberPath="Ten" SelectedValuePath="Id" VerticalContentAlignment="Center"/>

                <TextBlock Text="Tìm kiếm (Mã HĐ, SĐT):" VerticalAlignment="Center" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}" Margin="10,5,5,5"/>
                <TextBox x:Name="txtSearch" Width="150" Margin="5" VerticalContentAlignment="Center" BorderThickness="0,0,0,1" Background="Transparent"/>

                <Button x:Name="btnLoc" Margin="10,5,5,5" Style="{StaticResource PrimaryButton}" Click="BtnLoc_Click" Width="80">
                    <StackPanel Orientation="Horizontal">
                        <Path Data="{StaticResource IconFilter}" Fill="White" Width="14" Height="14" Margin="0,0,8,0" Stretch="Uniform"/>
                        <TextBlock Text="Lọc" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
                <Button x:Name="btnXoaLoc" Margin="5" Style="{StaticResource PrimaryButton}" Background="White" Foreground="{StaticResource TextGrayBrush}" BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="1" Click="BtnXoaLoc_Click">
                    <StackPanel Orientation="Horizontal">
                        <Path Data="{StaticResource IconFilterOff}" Fill="{StaticResource TextGrayBrush}" Width="14" Height="14" Margin="0,0,8,0" Stretch="Uniform"/>
                        <TextBlock Text="Xóa lọc" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
                <Button x:Name="btnNavigate_PhuThu" 
                        Margin="15,5,5,5" 
                        Style="{StaticResource PrimaryButton}" 
                        Background="{StaticResource ActionBlueBrush}" 
                        Click="BtnNavigate_PhuThu_Click" 
                        Width="140">
                    <TextBlock Text="Quản lý Phụ thu" VerticalAlignment="Center"/>
                </Button>
            </WrapPanel>
        </Border>
        <Grid Grid.Row="1" Margin="15">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/>
                <ColumnDefinition Width="1*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Background="{StaticResource WhiteTextBrush}" CornerRadius="8">
                <Border.Effect>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Border.Effect>
                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Text="Danh sách Đơn hàng" Style="{StaticResource HeaderTextBlock}"/>

                    <DataGrid Grid.Row="1" x:Name="dgDonHang" AutoGenerateColumns="False" IsReadOnly="True" 
                              SelectionMode="Single" SelectionChanged="DgDonHang_SelectionChanged"
                              BorderThickness="0" RowHeaderWidth="0"
                              RowStyle="{StaticResource DataGridRowStyle}">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Mã HĐ" Binding="{Binding IdHoaDon}" Width="60"/>
                            <DataGridTextColumn Header="Thời gian" Binding="{Binding ThoiGianTao, StringFormat='dd/MM HH:mm'}" Width="110"/>
                            <DataGridTextColumn Header="Nhân viên" Binding="{Binding TenNhanVien}" Width="*"/>
                            <DataGridTextColumn Header="Khách hàng" Binding="{Binding TenKhachHang}" Width="*"/>
                            <DataGridTextColumn Header="Bàn/Loại" Binding="{Binding SoBan}" Width="100"/>
                            <DataGridTextColumn Header="Thành tiền" Binding="{Binding ThanhTien, StringFormat=N0}" Width="100"/>
                            <DataGridTextColumn Header="Trạng thái" Binding="{Binding TrangThai}" Width="110"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <Button Grid.Row="2" x:Name="btnExportToExcel" HorizontalAlignment="Left" Margin="0,15,0,0"
                                Style="{StaticResource PrimaryButton}" Background="#00724C"
                                Click="BtnExportToExcel_Click">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconExcel}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Xuất Excel" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                </Grid>
            </Border>

            <Border Grid.Column="1" Background="{StaticResource WhiteTextBrush}" CornerRadius="8" Margin="15,0,0,0" Padding="20">
                <Border.Effect>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Text="Chi tiết Đơn hàng" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,15"/>

                    <TextBlock Grid.Row="1" Text="Món ăn" FontWeight="SemiBold" Margin="0,0,0,5"/>
                    <DataGrid Grid.Row="2" x:Name="dgChiTietDonHang" AutoGenerateColumns="False" IsReadOnly="True" Background="Transparent" BorderThickness="0">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Sản phẩm" Binding="{Binding TenSanPham}" Width="*"/>
                            <DataGridTextColumn Header="SL" Binding="{Binding SoLuong}" Width="40"/>
                            <DataGridTextColumn Header="Thành tiền" Binding="{Binding ThanhTien, StringFormat=N0}" Width="80"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <TextBlock Grid.Row="3" Text="Phụ thu" FontWeight="SemiBold" Margin="0,10,0,5"/>
                    <ItemsControl Grid.Row="4" x:Name="icPhuThuChiTiet" Margin="0,0,0,15">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid>
                                    <TextBlock Text="{Binding TenPhuThu}" HorizontalAlignment="Left" Foreground="Gray"/>
                                    <TextBlock Text="{Binding SoTien, StringFormat=+ {0:N0}}" HorizontalAlignment="Right" Foreground="Gray"/>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <StackPanel Grid.Row="5" Margin="0,15,0,0">
                        <Button x:Name="btnInLaiHoaDon" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionBlueBrush}" IsEnabled="False" Click="BtnInLaiHoaDon_Click" Height="40">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconPrint}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="In lại Hóa đơn" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            </StackPanel>
                        </Button>
                        <Button x:Name="btnGiaoHang" Margin="0,8,0,0" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionBlueBrush}" IsEnabled="False" Click="BtnGiaoHang_Click" Height="40">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconDelivery}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="Bắt đầu Giao Hàng" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            </StackPanel>
                        </Button>
                        <Button x:Name="btnHuyDonHang" Margin="0,8,0,0" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionRedBrush}" IsEnabled="False" Click="BtnHuyDonHang_Click" Height="40">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconCancel}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="Hủy Đơn hàng" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyDonHangView.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using Microsoft.Win32; // Cho Excel
using System.IO; // Cho Excel
using OfficeOpenXml; // Cho Excel
using System.Globalization; // Cho Excel
using AppCafebookApi.View.common; // <-- THÊM MỚI
using CafebookModel.Model.ModelApp.NhanVien; // <-- THÊM MỚI

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyDonHangView : Page
    {
        private static readonly HttpClient httpClient;
        private List<DonHangDto> _currentOrderList = new List<DonHangDto>();

        static QuanLyDonHangView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyDonHangView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            dpTuNgay.SelectedDate = DateTime.Today;
            dpDenNgay.SelectedDate = DateTime.Today;
            cmbTrangThai.SelectedIndex = 0;

            await LoadFiltersAsync();
            await LoadDataGridAsync();
        }

        private async Task LoadFiltersAsync()
        {
            try
            {
                var filters = await httpClient.GetFromJsonAsync<DonHangFiltersDto>("api/app/donhang/filters");
                if (filters != null)
                {
                    filters.NhanViens.Insert(0, new FilterLookupDto { Id = 0, Ten = "Tất cả Nhân viên" });
                    cmbNhanVien.ItemsSource = filters.NhanViens;
                    cmbNhanVien.SelectedValue = 0;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải bộ lọc: {ex.Message}", "Lỗi API");
            }
        }

        private async Task LoadDataGridAsync()
        {
            if (dpTuNgay.SelectedDate == null || dpDenNgay.SelectedDate == null) return;

            DateTime startDate = dpTuNgay.SelectedDate.Value;
            DateTime endDate = dpDenNgay.SelectedDate.Value;
            string trangThai = (cmbTrangThai.SelectedItem as ComboBoxItem)?.Content.ToString() ?? "Tất cả";
            int nhanVienId = (int)(cmbNhanVien.SelectedValue ?? 0);
            string searchText = txtSearch.Text;

            try
            {
                var url = $"api/app/donhang/search?" +
                          $"startDate={startDate:yyyy-MM-dd}" +
                          $"&endDate={endDate:yyyy-MM-dd}" +
                          $"&trangThai={Uri.EscapeDataString(trangThai)}" +
                          $"&nhanVienId={nhanVienId}" +
                          $"&searchText={Uri.EscapeDataString(searchText)}";

                _currentOrderList = (await httpClient.GetFromJsonAsync<List<DonHangDto>>(url)) ?? new List<DonHangDto>();
                dgDonHang.ItemsSource = _currentOrderList;

                // Xóa chi tiết
                dgChiTietDonHang.ItemsSource = null;
                icPhuThuChiTiet.ItemsSource = null; // <-- THÊM MỚI
                btnInLaiHoaDon.IsEnabled = false;
                btnHuyDonHang.IsEnabled = false;
                btnGiaoHang.IsEnabled = false;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải danh sách đơn hàng: {ex.Message}", "Lỗi API");
            }
        }

        private async void BtnLoc_Click(object sender, RoutedEventArgs e)
        {
            await LoadDataGridAsync();
        }

        private async void BtnXoaLoc_Click(object sender, RoutedEventArgs e)
        {
            dpTuNgay.SelectedDate = DateTime.Today;
            dpDenNgay.SelectedDate = DateTime.Today;
            cmbTrangThai.SelectedIndex = 0;
            cmbNhanVien.SelectedValue = 0;
            txtSearch.Text = "";
            await LoadDataGridAsync();
        }

        /// <summary>
        /// Khi chọn một đơn hàng, tải chi tiết
        /// </summary>
        private async void DgDonHang_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgDonHang.SelectedItem is not DonHangDto selectedOrder)
            {
                dgChiTietDonHang.ItemsSource = null;
                icPhuThuChiTiet.ItemsSource = null; // <-- THÊM MỚI
                btnInLaiHoaDon.IsEnabled = false;
                btnHuyDonHang.IsEnabled = false;
                btnGiaoHang.IsEnabled = false;
                return;
            }

            try
            {
                // ### SỬA: Gọi API mới (GetDonHangFullDetailsDto) ###
                var details = await httpClient.GetFromJsonAsync<DonHangFullDetailsDto>($"api/app/donhang/details/{selectedOrder.IdHoaDon}");
                if (details != null)
                {
                    dgChiTietDonHang.ItemsSource = details.Items;
                    icPhuThuChiTiet.ItemsSource = details.Surcharges; // <-- THÊM MỚI
                }

                // Logic kích hoạt nút
                btnInLaiHoaDon.IsEnabled = true;

                if (selectedOrder.TrangThai == "Đã thanh toán" || selectedOrder.TrangThai == "Đã hủy")
                {
                    btnHuyDonHang.IsEnabled = false;
                    btnGiaoHang.IsEnabled = false;
                }
                else
                {
                    btnHuyDonHang.IsEnabled = true;
                    if (selectedOrder.LoaiHoaDon == "Giao hàng")
                    {
                        btnGiaoHang.IsEnabled = true;
                    }
                    else
                    {
                        btnGiaoHang.IsEnabled = false;
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải chi tiết đơn hàng: {ex.Message}", "Lỗi API");
            }
        }

        // ### SỬA: Thay đổi hàm này ###
        private async void BtnInLaiHoaDon_Click(object sender, RoutedEventArgs e)
        {
            if (dgDonHang.SelectedItem is not DonHangDto selectedOrder) return;

            try
            {
                // 1. Gọi API mới để lấy đầy đủ dữ liệu in
                var dto = await httpClient.GetFromJsonAsync<HoaDonPreviewDto>($"api/app/donhang/reprint-data/{selectedOrder.IdHoaDon}");

                if (dto == null)
                {
                    MessageBox.Show("Không thể lấy dữ liệu in.", "Lỗi");
                    return;
                }

                // 2. Mở cửa sổ in
                var previewWindow = new HoaDonPreviewWindow(dto);
                previewWindow.ShowDialog();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi khi lấy dữ liệu in: {ex.Message}", "Lỗi API");
            }
        }

        private async void BtnHuyDonHang_Click(object sender, RoutedEventArgs e)
        {
            if (dgDonHang.SelectedItem is DonHangDto selectedOrder)
            {
                var result = MessageBox.Show($"Bạn có chắc chắn muốn HỦY Hóa đơn {selectedOrder.IdHoaDon} không?", "Xác nhận Hủy", MessageBoxButton.YesNo, MessageBoxImage.Warning);
                if (result == MessageBoxResult.No) return;

                await UpdateOrderStatus(selectedOrder.IdHoaDon, "Hủy");
            }
        }

        private async void BtnGiaoHang_Click(object sender, RoutedEventArgs e)
        {
            if (dgDonHang.SelectedItem is DonHangDto selectedOrder)
            {
                var result = MessageBox.Show($"Xác nhận bắt đầu GIAO HÀNG cho HĐ {selectedOrder.IdHoaDon}?", "Xác nhận Giao hàng", MessageBoxButton.YesNo, MessageBoxImage.Question);
                if (result == MessageBoxResult.No) return;

                await UpdateOrderStatus(selectedOrder.IdHoaDon, "Đang giao");
            }
        }

        private async Task UpdateOrderStatus(int hoaDonId, string newStatus)
        {
            try
            {
                var response = await httpClient.PutAsJsonAsync($"api/app/donhang/update-status/{hoaDonId}", newStatus);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show($"Cập nhật trạng thái thành '{newStatus}' thành công.", "Thành công");
                    await LoadDataGridAsync(); // Tải lại danh sách
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
        }

        private void BtnExportToExcel_Click(object sender, RoutedEventArgs e)
        {
            var sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                FileName = $"DSDonHang_{DateTime.Now:yyyyMMdd_HHmm}.xlsx"
            };

            if (sfd.ShowDialog() == true)
            {
                try
                {
                    ExcelPackage.License.SetNonCommercialPersonal("CafeBook");
                    using (var package = new ExcelPackage(new FileInfo(sfd.FileName)))
                    {
                        var ws = package.Workbook.Worksheets.Add("DanhSachDonHang");
                        ws.Cells["A1"].Value = "Danh sách Đơn hàng";
                        ws.Cells["A1:D1"].Merge = true;
                        ws.Cells["A1"].Style.Font.Bold = true;
                        ws.Cells["A1"].Style.Font.Size = 16;

                        ws.Cells["A3"].LoadFromCollection(_currentOrderList, true, OfficeOpenXml.Table.TableStyles.Medium9);

                        // Định dạng cột
                        ws.Column(2).Style.Numberformat.Format = "dd/MM/yyyy HH:mm";
                        ws.Column(6).Style.Numberformat.Format = "#,##0 \"đ\"";
                        ws.Cells[ws.Dimension.Address].AutoFitColumns();

                        package.Save();
                    }
                    MessageBox.Show("Xuất Excel thành công!", "Thông báo");
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Lỗi khi xuất Excel: {ex.Message}", "Lỗi");
                }
            }
        }
        // ### THÊM HÀM MỚI NÀY VÀO CUỐI FILE ###
        private void BtnNavigate_PhuThu_Click(object sender, RoutedEventArgs e)
        {
            // (Giả định QuanLyPhuThuView ở cùng namespace)
            this.NavigationService?.Navigate(new QuanLyPhuThuView());
        }
        // ### KẾT THÚC THÊM MỚI ###
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyDonViChuyenDoiView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyDonViChuyenDoiView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quản lý Đơn vị Chuyển đổi"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>

        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>


        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Quản lý Đơn vị Chuyển đổi" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="380"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Margin="10,0,15,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Text="Danh sách Đơn vị tính" Style="{StaticResource HeaderTextBlock}"/>
                        <DataGrid Grid.Row="1" x:Name="dgDonVi" AutoGenerateColumns="False" IsReadOnly="True" 
                                  SelectionMode="Single" SelectionChanged="DgDonVi_SelectionChanged"
                                  BorderThickness="0" RowHeaderWidth="0">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Tên Nguyên Liệu" Binding="{Binding TenNguyenLieu}" Width="*"/>
                                <DataGridTextColumn Header="Tên Đơn Vị" Binding="{Binding TenDonVi}" Width="100"/>
                                <DataGridTextColumn Header="Hệ số Quy đổi" Binding="{Binding GiaTriQuyDoi}" Width="100"/>
                                <DataGridCheckBoxColumn Header="ĐV Cơ bản?" Binding="{Binding LaDonViCoBan}" Width="80"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>

                <Border Grid.Column="1" Margin="0,0,10,10" Style="{StaticResource CardBorder}">
                    <StackPanel>
                        <TextBlock Text="Thông tin Đơn vị" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,15"/>

                        <TextBlock Text="Thuộc Nguyên liệu (*):" Margin="0,0,0,5"/>
                        <ComboBox x:Name="cmbNguyenLieu" DisplayMemberPath="Ten" SelectedValuePath="Id" Margin="0,0,0,10"
                                  IsEditable="True" IsTextSearchEnabled="True"/>

                        <TextBlock Text="Tên Đơn vị (vd: gram, ml, gói) (*):" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtTenDonVi" Margin="0,0,0,10"/>

                        <TextBlock x:Name="lblGiaTriQuyDoi" Text="Giá trị quy đổi (so với ĐVT cơ bản) (*):" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtGiaTriQuyDoi" Margin="0,0,0,10"/>

                        <CheckBox x:Name="chkLaDonViCoBan" Content="Đây là Đơn vị cơ bản (Hệ số = 1)" 
                                  Margin="0,10,0,15" Checked="ChkLaDonViCoBan_Changed" Unchecked="ChkLaDonViCoBan_Changed"/>

                        <Grid Height="40">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Button x:Name="btnLamMoi" Grid.Column="0" ToolTip="Làm mới" Click="BtnLamMoi_Click" Background="Transparent" BorderThickness="0">
                                <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="22" Height="22"/>
                            </Button>
                            <Button x:Name="btnThem" Grid.Column="1" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionGreenBrush}" Click="BtnThem_Click" Margin="10,0,5,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconAdd}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="Thêm" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                            <Button x:Name="btnLuu" Grid.Column="2" Style="{StaticResource PrimaryButton}" Click="BtnLuu_Click" Margin="5,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconSave}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="Lưu" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                            <Button x:Name="btnXoa" Grid.Column="3" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionRedBrush}" Click="BtnXoa_Click" Margin="5,0,0,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconDelete}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="Xóa" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </Grid>
                    </StackPanel>
                </Border>
            </Grid>

            <Button x:Name="btnQuayLai" Grid.Row="2" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" Margin="10,0,0,10"
                    Click="BtnQuayLai_Click">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                    <TextBlock Text="Quay lại Tồn Kho" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Đang tải..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyDonViChuyenDoiView.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using System.Globalization;

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyDonViChuyenDoiView : Page
    {
        private static readonly HttpClient httpClient;
        private List<DonViChuyenDoiDtoo> _allDonViList = new List<DonViChuyenDoiDtoo>();
        private List<FilterLookupDto> _nguyenLieuList = new List<FilterLookupDto>();
        private DonViChuyenDoiDtoo? _selectedDonVi = null;

        static QuanLyDonViChuyenDoiView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyDonViChuyenDoiView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadNguyenLieuComboBox();
            await LoadDataGridAsync();
            ResetForm();
        }

        /// <summary>
        /// Tải danh sách Nguyên liệu cho ComboBox
        /// </summary>
        private async Task LoadNguyenLieuComboBox()
        {
            try
            {
                // Tận dụng API 'filters' của SanPham
                var filters = await httpClient.GetFromJsonAsync<SanPhamFiltersDto>("api/app/sanpham/filters");
                if (filters != null)
                {
                    _nguyenLieuList = filters.NguyenLieus;
                    _nguyenLieuList.Insert(0, new FilterLookupDto { Id = 0, Ten = "-- Chọn Nguyên Liệu --" });
                    cmbNguyenLieu.ItemsSource = _nguyenLieuList;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải danh sách nguyên liệu: {ex.Message}", "Lỗi API");
            }
        }

        /// <summary>
        /// Tải DataGrid
        /// </summary>
        private async Task LoadDataGridAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                _allDonViList = (await httpClient.GetFromJsonAsync<List<DonViChuyenDoiDtoo>>("api/app/donvichuyendoi")) ?? new List<DonViChuyenDoiDtoo>();
                dgDonVi.ItemsSource = _allDonViList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải danh sách đơn vị: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        /// <summary>
        /// Đưa Form về trạng thái thêm mới
        /// </summary>
        private void ResetForm()
        {
            _selectedDonVi = null;
            dgDonVi.SelectedItem = null;
            btnThem.IsEnabled = true;
            btnLuu.IsEnabled = false;
            btnXoa.IsEnabled = false;

            cmbNguyenLieu.SelectedValue = 0;
            txtTenDonVi.Text = "";
            txtGiaTriQuyDoi.Text = "0";
            chkLaDonViCoBan.IsChecked = false;

            // Kích hoạt lại các trường
            cmbNguyenLieu.IsEnabled = true;
            txtGiaTriQuyDoi.IsEnabled = true;
            lblGiaTriQuyDoi.Visibility = Visibility.Visible;
            txtGiaTriQuyDoi.Visibility = Visibility.Visible;
        }

        private void DgDonVi_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgDonVi.SelectedItem is not DonViChuyenDoiDtoo selected)
            {
                ResetForm();
                return;
            }

            _selectedDonVi = selected;
            btnThem.IsEnabled = false;
            btnLuu.IsEnabled = true;
            btnXoa.IsEnabled = true;

            cmbNguyenLieu.SelectedValue = selected.IdNguyenLieu;
            txtTenDonVi.Text = selected.TenDonVi;
            txtGiaTriQuyDoi.Text = selected.GiaTriQuyDoi.ToString(CultureInfo.InvariantCulture);
            chkLaDonViCoBan.IsChecked = selected.LaDonViCoBan;

            // Không cho phép đổi Nguyên liệu khi Sửa (để tránh lỗi logic)
            cmbNguyenLieu.IsEnabled = false;
        }

        private void ChkLaDonViCoBan_Changed(object sender, RoutedEventArgs e)
        {
            if (chkLaDonViCoBan.IsChecked == true)
            {
                txtGiaTriQuyDoi.Text = "1";
                txtGiaTriQuyDoi.IsEnabled = false;
                lblGiaTriQuyDoi.Visibility = Visibility.Collapsed;
                txtGiaTriQuyDoi.Visibility = Visibility.Collapsed;
            }
            else
            {
                txtGiaTriQuyDoi.Text = "0";
                txtGiaTriQuyDoi.IsEnabled = true;
                lblGiaTriQuyDoi.Visibility = Visibility.Visible;
                txtGiaTriQuyDoi.Visibility = Visibility.Visible;
            }
        }

        private async void BtnThem_Click(object sender, RoutedEventArgs e)
        {
            await SaveAsync(isCreating: true);
        }

        private async void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            await SaveAsync(isCreating: false);
        }

        private async Task SaveAsync(bool isCreating)
        {
            if ((int)cmbNguyenLieu.SelectedValue == 0)
            {
                MessageBox.Show("Vui lòng chọn nguyên liệu.", "Lỗi"); return;
            }
            if (string.IsNullOrWhiteSpace(txtTenDonVi.Text))
            {
                MessageBox.Show("Tên đơn vị không được để trống.", "Lỗi"); return;
            }
            if (!decimal.TryParse(txtGiaTriQuyDoi.Text, NumberStyles.Any, CultureInfo.InvariantCulture, out decimal giaTri) || giaTri <= 0)
            {
                MessageBox.Show("Giá trị quy đổi phải là số dương.", "Lỗi"); return;
            }

            var dto = new DonViChuyenDoiUpdateRequestDto
            {
                IdNguyenLieu = (int)cmbNguyenLieu.SelectedValue,
                TenDonVi = txtTenDonVi.Text,
                GiaTriQuyDoi = giaTri,
                LaDonViCoBan = chkLaDonViCoBan.IsChecked ?? false
            };

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                HttpResponseMessage response;
                if (isCreating)
                {
                    response = await httpClient.PostAsJsonAsync("api/app/donvichuyendoi", dto);
                }
                else
                {
                    response = await httpClient.PutAsJsonAsync($"api/app/donvichuyendoi/{_selectedDonVi?.IdChuyenDoi}", dto);
                }

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Lưu thành công!", "Thông báo");
                    await LoadDataGridAsync();
                    ResetForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXoa_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedDonVi == null) return;

            var result = MessageBox.Show($"Bạn có chắc muốn xóa đơn vị '{_selectedDonVi.TenDonVi}' của '{_selectedDonVi.TenNguyenLieu}'?", "Xác nhận", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/donvichuyendoi/{_selectedDonVi.IdChuyenDoi}");
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Xóa thành công!", "Thông báo");
                    await LoadDataGridAsync();
                    ResetForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Không thể xóa");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnLamMoi_Click(object sender, RoutedEventArgs e)
        {
            ResetForm();
        }

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyDonXinNghiView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyDonXinNghiView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quản lý Đơn Xin Nghỉ"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionOrangeBrush" Color="#FFA726"/>
        <SolidColorBrush x:Key="StatusPendingBrush" Color="#FFC107"/>
        <SolidColorBrush x:Key="StatusRejectedBrush" Color="#F44336"/>
        <SolidColorBrush x:Key="StatusApprovedBrush" Color="#4CAF50"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        
        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>
        <Geometry x:Key="IconApprove">M12,2C6.48,2 2,6.48 2,12C2,17.52 6.48,22 12,22C17.52,22 22,17.52 22,12C22,6.48 17.52,2 12,2M10,17L5,12L6.41,10.59L10,14.17L17.59,6.58L19,8L10,17Z</Geometry>
        <Geometry x:Key="IconReject">M12,2C6.48,2 2,6.48 2,12C2,17.52 6.48,22 12,22C17.52,22 22,17.52 22,12C22,6.48 17.52,2 12,2M17,13.41L13.41,17L12,15.59L8.41,19L7,17.59L10.59,14L7,10.41L8.41,9L12,12.59L15.59,9L17,10.41L13.41,14L17,17.59V13.41Z</Geometry>
        <Geometry x:Key="IconReport">M10,17L6,21H18L14,17H10M10,10H14V15H10V10M4,3H20C21.1,3 22,3.9 22,5V17C22,18.1 21.1,19 20,19H4C2.9,19 2,18.1 2,17V5C2,3.9 2.9,3 4,3Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>

        <Style x:Key="StatusTextBlock" TargetType="TextBlock">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="8,3"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Text" Value="{Binding TrangThai}"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding TrangThai}" Value="Chờ duyệt">
                    <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
                    <Setter Property="Background" Value="{StaticResource StatusPendingBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TrangThai}" Value="Đã duyệt">
                    <Setter Property="Foreground" Value="White"/>
                    <Setter Property="Background" Value="{StaticResource StatusApprovedBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TrangThai}" Value="Đã từ chối">
                    <Setter Property="Foreground" Value="White"/>
                    <Setter Property="Background" Value="{StaticResource StatusRejectedBrush}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Quản lý Đơn Xin Nghỉ" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="420"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Margin="10,0,15,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                            <TextBlock Text="Tìm kiếm:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                            <TextBox x:Name="txtSearchNhanVien" Width="200" TextChanged="Filters_Changed"/>

                            <TextBlock Text="Trạng thái:" VerticalAlignment="Center" Margin="15,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                            <ComboBox x:Name="cmbTrangThaiFilter" Width="150" SelectionChanged="Filters_Changed">
                                <ComboBoxItem Content="Tất cả"/>
                                <ComboBoxItem Content="Chờ duyệt"/>
                                <ComboBoxItem Content="Đã duyệt"/>
                                <ComboBoxItem Content="Đã từ chối"/>
                            </ComboBox>
                        </StackPanel>

                        <DataGrid Grid.Row="1" x:Name="dgDonXinNghi" AutoGenerateColumns="False" IsReadOnly="True" 
                                  SelectionMode="Single" SelectionChanged="DgDonXinNghi_SelectionChanged"
                                  BorderThickness="0" RowHeaderWidth="0">
                            <DataGrid.Columns>
                                <DataGridTemplateColumn Header="Trạng thái" Width="100">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Border CornerRadius="4" Margin="2">
                                                <TextBlock Style="{StaticResource StatusTextBlock}"/>
                                            </Border>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTextColumn Header="Nhân viên" Binding="{Binding TenNhanVien}" Width="*"/>
                                <DataGridTextColumn Header="Từ Ngày" Binding="{Binding NgayBatDau, StringFormat='dd/MM/yyyy'}" Width="100"/>
                                <DataGridTextColumn Header="Đến Ngày" Binding="{Binding NgayKetThuc, StringFormat='dd/MM/yyyy'}" Width="100"/>
                                <DataGridTextColumn Header="Lý do" Binding="{Binding LyDo}" Width="2*"/>
                                <DataGridTextColumn Header="Người duyệt" Binding="{Binding TenNguoiDuyet}" Width="120"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>

                <Border Grid.Column="1" Margin="0,0,10,10" Style="{StaticResource CardBorder}">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock x:Name="lblFormTitle" Text="Tạo Đơn Mới" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,5,0,15" VerticalAlignment="Center"/>
                                <Button x:Name="btnLamMoi" Grid.Column="1" ToolTip="Tạo đơn mới" Click="BtnLamMoi_Click" Style="{StaticResource PrimaryButton}" Background="Transparent" BorderThickness="0">
                                    <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="22" Height="22"/>
                                </Button>
                            </Grid>

                            <StackPanel x:Name="formTaoDon">
                                <TextBlock Text="Nhân viên xin nghỉ:" Margin="0,0,0,5" FontSize="12" FontWeight="SemiBold"/>
                                <ComboBox x:Name="cmbNhanVien" DisplayMemberPath="HoTen" SelectedValuePath="IdNhanVien" Margin="0,0,0,10"/>

                                <TextBlock Text="Loại đơn:" Margin="0,0,0,5" FontSize="12" FontWeight="SemiBold"/>
                                <ComboBox x:Name="cmbLoaiDon" Margin="0,0,0,10">
                                    <ComboBoxItem Content="Nghỉ có phép"/>
                                    <ComboBoxItem Content="Nghỉ không phép"/>
                                    <ComboBoxItem Content="Nghỉ bệnh"/>
                                </ComboBox>

                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0" Margin="0,0,5,0">
                                        <TextBlock Text="Từ Ngày:" Margin="0,0,0,5" FontSize="12" FontWeight="SemiBold"/>
                                        <DatePicker x:Name="dpNgayBatDau" Margin="0,0,0,10"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="1" Margin="5,0,0,0">
                                        <TextBlock Text="Đến Ngày:" Margin="0,0,0,5" FontSize="12" FontWeight="SemiBold"/>
                                        <DatePicker x:Name="dpNgayKetThuc" Margin="0,0,0,10"/>
                                    </StackPanel>
                                </Grid>

                                <TextBlock Text="Lý do:" Margin="0,0,0,5" FontSize="12" FontWeight="SemiBold"/>
                                <TextBox x:Name="txtLyDo" Margin="0,0,0,15" Height="80" TextWrapping="Wrap" AcceptsReturn="True"/>

                                <Button x:Name="btnThemDon" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionBlueBrush}" 
                                        Click="BtnThemDon_Click" Padding="12">
                                    <StackPanel Orientation="Horizontal">
                                        <Path Data="{StaticResource IconAdd}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                        <TextBlock Text="Tạo Đơn Xin Nghỉ" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>

                            <StackPanel x:Name="formDuyetDon" Visibility="Collapsed">
                                <TextBlock Text="Ghi chú phê duyệt:" Margin="0,15,0,5" FontSize="12" FontWeight="SemiBold"/>
                                <TextBox x:Name="txtGhiChuPheDuyet" Margin="0,0,0,15" Height="60" TextWrapping="Wrap" AcceptsReturn="True"/>

                                <Grid Height="40" Margin="0,5,0,15">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Button x:Name="btnDuyet" Grid.Column="0" Style="{StaticResource PrimaryButton}" Background="{StaticResource StatusApprovedBrush}" 
                                            Click="BtnDuyet_Click" Margin="0,0,5,0">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconApprove}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                            <TextBlock Text="Duyệt Đơn" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                    <Button x:Name="btnTuChoi" Grid.Column="1" Style="{StaticResource PrimaryButton}" Background="{StaticResource StatusRejectedBrush}" 
                                            Click="BtnTuChoi_Click" Margin="5,0,0,0">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconReject}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                            <TextBlock Text="Từ Chối" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                </Grid>

                                <Button x:Name="btnXoa" Style="{StaticResource PrimaryButton}" Background="{StaticResource TextGrayBrush}" 
                                        Click="BtnXoa_Click" Padding="12">
                                    <StackPanel Orientation="Horizontal">
                                        <Path Data="{StaticResource IconDelete}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                        <TextBlock Text="Xóa Đơn (Hủy yêu cầu)" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                            <Button x:Name="btnGoToBaoCao" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionBlueBrush}" 
                                Click="BtnGoToBaoCao_Click" Margin="0,20,0,0">
                                <StackPanel Orientation="Horizontal">
                                    <Path Data="{StaticResource IconReport}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                    <TextBlock Text="Xem Báo Cáo Nghỉ Phép" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </ScrollViewer>
                </Border>
            </Grid>

            <Button x:Name="btnQuayLai" Grid.Row="2" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" Margin="10,0,0,10"
                    Click="BtnQuayLai_Click">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                    <TextBlock Text="Quay lại" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Đang xử lý..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyDonXinNghiView.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Threading.Tasks;
using System.Net;
using AppCafebookApi.Services; // Cần cho AuthService

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyDonXinNghiView : Page
    {
        private static readonly HttpClient httpClient;
        private List<DonXinNghiDto> _allDonNghiList = new List<DonXinNghiDto>();
        private List<NhanVienLookupDto> _allNhanVienList = new List<NhanVienLookupDto>();
        private DonXinNghiDto? _selectedDon = null;

        static QuanLyDonXinNghiView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyDonXinNghiView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            await LoadNhanVienAsync();
            cmbTrangThaiFilter.SelectedIndex = 1; // Mặc định lọc "Chờ duyệt"
            await LoadDataGridAsync();
            ResetForm();
            LoadingOverlay.Visibility = Visibility.Collapsed;
        }

        #region Tải Dữ Liệu & Lọc

        private async Task LoadNhanVienAsync()
        {
            try
            {
                // Tận dụng API của Module 4
                _allNhanVienList = (await httpClient.GetFromJsonAsync<List<NhanVienLookupDto>>("api/app/lichlamviec/all-nhanvien")) ?? new List<NhanVienLookupDto>();
                cmbNhanVien.ItemsSource = _allNhanVienList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải danh sách nhân viên: {ex.Message}", "Lỗi API");
            }
        }

        private async Task LoadDataGridAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;

            string searchText = txtSearchNhanVien.Text;
            string trangThai = (cmbTrangThaiFilter.SelectedItem as ComboBoxItem)?.Content.ToString() ?? "Tất cả";

            try
            {
                var url = $"api/app/donxinnghi/search?searchText={Uri.EscapeDataString(searchText)}&trangThai={Uri.EscapeDataString(trangThai)}";
                _allDonNghiList = (await httpClient.GetFromJsonAsync<List<DonXinNghiDto>>(url)) ?? new List<DonXinNghiDto>();
                dgDonXinNghi.ItemsSource = _allDonNghiList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải danh sách đơn nghỉ: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void Filters_Changed(object sender, RoutedEventArgs e)
        {
            if (this.IsLoaded)
                await LoadDataGridAsync();
        }

        #endregion

        #region Form & CRUD

        private void ResetForm()
        {
            _selectedDon = null;
            dgDonXinNghi.SelectedItem = null;

            lblFormTitle.Text = "Tạo Đơn Mới";
            formTaoDon.Visibility = Visibility.Visible;
            formDuyetDon.Visibility = Visibility.Collapsed;

            cmbNhanVien.SelectedValue = -1;
            cmbLoaiDon.SelectedIndex = 0; // Nghỉ có phép
            dpNgayBatDau.SelectedDate = DateTime.Today;
            dpNgayKetThuc.SelectedDate = DateTime.Today;
            txtLyDo.Text = "";
            txtGhiChuPheDuyet.Text = "";

            // Gán nhân viên mặc định nếu người dùng là NV
            if (AuthService.CurrentUser != null && AuthService.CurrentUser.TenVaiTro != "Quản lý" && AuthService.CurrentUser.TenVaiTro != "Quản trị viên")
            {
                cmbNhanVien.SelectedValue = AuthService.CurrentUser.IdNhanVien;
                cmbNhanVien.IsEnabled = false; // NV không thể tạo đơn cho người khác
            }
            else
            {
                cmbNhanVien.IsEnabled = true;
            }
        }

        private void DgDonXinNghi_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgDonXinNghi.SelectedItem is not DonXinNghiDto selected)
            {
                ResetForm();
                return;
            }

            _selectedDon = selected;

            lblFormTitle.Text = $"Chi tiết Đơn: {selected.TenNhanVien}";
            formTaoDon.Visibility = Visibility.Visible; // Hiển thị thông tin

            // Điền thông tin
            cmbNhanVien.SelectedValue = _allNhanVienList.FirstOrDefault(nv => nv.HoTen == selected.TenNhanVien)?.IdNhanVien ?? -1;
            cmbLoaiDon.Text = selected.LoaiDon;
            dpNgayBatDau.SelectedDate = selected.NgayBatDau;
            dpNgayKetThuc.SelectedDate = selected.NgayKetThuc;
            txtLyDo.Text = selected.LyDo;
            txtGhiChuPheDuyet.Text = selected.GhiChuPheDuyet;

            // Kiểm tra quyền (Quản lý mới thấy nút duyệt)
            if (AuthService.CoQuyen("NhanSu.QuanLy")) // Giả sử quyền là "NhanSu.QuanLy"
            {
                if (selected.TrangThai == "Chờ duyệt")
                {
                    formDuyetDon.Visibility = Visibility.Visible;
                    btnXoa.IsEnabled = true; // Cho phép Xóa (Hủy)
                }
                else
                {
                    formDuyetDon.Visibility = Visibility.Collapsed; // Đã xử lý, ẩn nút
                    btnXoa.IsEnabled = false; // Không cho xóa
                }
                // Admin có thể sửa đơn chưa duyệt
                formTaoDon.IsEnabled = (selected.TrangThai == "Chờ duyệt");
                btnThemDon.Visibility = Visibility.Collapsed; // Ẩn nút Thêm khi đang xem
            }
            else // Nếu là nhân viên
            {
                formTaoDon.IsEnabled = false; // NV không được sửa sau khi tạo
                formDuyetDon.Visibility = Visibility.Collapsed; // NV không được duyệt
            }
        }

        private void BtnLamMoi_Click(object sender, RoutedEventArgs e)
        {
            ResetForm();
        }

        private async void BtnThemDon_Click(object sender, RoutedEventArgs e)
        {
            if (cmbNhanVien.SelectedValue == null)
            {
                MessageBox.Show("Vui lòng chọn nhân viên.", "Lỗi"); return;
            }
            if (dpNgayBatDau.SelectedDate == null || dpNgayKetThuc.SelectedDate == null)
            {
                MessageBox.Show("Vui lòng chọn ngày bắt đầu và kết thúc.", "Lỗi"); return;
            }
            if (dpNgayKetThuc.SelectedDate < dpNgayBatDau.SelectedDate)
            {
                MessageBox.Show("Ngày kết thúc không thể trước ngày bắt đầu.", "Lỗi"); return;
            }

            var dto = new DonXinNghiCreateDto
            {
                IdNhanVien = (int)cmbNhanVien.SelectedValue,
                LoaiDon = (cmbLoaiDon.SelectedItem as ComboBoxItem)?.Content.ToString() ?? "Nghỉ có phép",
                LyDo = txtLyDo.Text,
                NgayBatDau = dpNgayBatDau.SelectedDate.Value,
                NgayKetThuc = dpNgayKetThuc.SelectedDate.Value
            };

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/donxinnghi", dto);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Tạo đơn thành công!", "Thông báo");
                    await LoadDataGridAsync();
                    ResetForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnDuyet_Click(object sender, RoutedEventArgs e)
        {
            await HandleApprovalAsync(isApproving: true);
        }

        private async void BtnTuChoi_Click(object sender, RoutedEventArgs e)
        {
            await HandleApprovalAsync(isApproving: false);
        }

        private async Task HandleApprovalAsync(bool isApproving)
        {
            if (_selectedDon == null) return;
            if (AuthService.CurrentUser == null)
            {
                MessageBox.Show("Lỗi phiên đăng nhập. Không tìm thấy người duyệt.", "Lỗi"); return;
            }

            var dto = new DonXinNghiActionDto
            {
                IdNguoiDuyet = AuthService.CurrentUser.IdNhanVien,
                GhiChuPheDuyet = txtGhiChuPheDuyet.Text
            };

            string endpoint = isApproving ? $"api/app/donxinnghi/approve/{_selectedDon.IdDonXinNghi}"
                                          : $"api/app/donxinnghi/reject/{_selectedDon.IdDonXinNghi}";

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PutAsJsonAsync(endpoint, dto);
                var responseString = await response.Content.ReadAsStringAsync();

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show(isApproving ? "Duyệt đơn thành công." : "Đã từ chối đơn.", "Thông báo");
                    await LoadDataGridAsync();
                    ResetForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {responseString}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXoa_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedDon == null || _selectedDon.TrangThai != "Chờ duyệt")
            {
                MessageBox.Show("Chỉ có thể xóa đơn ở trạng thái 'Chờ duyệt'.", "Không thể xóa");
                return;
            }

            var result = MessageBox.Show($"Bạn có chắc muốn xóa đơn của '{_selectedDon.TenNhanVien}'?", "Xác nhận", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/donxinnghi/{_selectedDon.IdDonXinNghi}");
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Xóa đơn thành công!", "Thông báo");
                    await LoadDataGridAsync();
                    ResetForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Không thể xóa");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion
        private void BtnGoToBaoCao_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new BaoCaoNhanSuView());
        }
        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            // Quay lại trang QL Lịch (Module 4)
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyKhachHangView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyKhachHangView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quản lý Khách hàng" FontFamily="Segoe UI" Loaded="Page_Loaded"
      Background="#FFF8E1">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="StatusYellowBrush" Color="#FFF9C4"/>
        <SolidColorBrush x:Key="StatusCanceledBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="StatusGreenBrush" Color="#E8F5E9"/>

        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconUpload">M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z</Geometry>
        <Geometry x:Key="IconLock">M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8H17V6A5,5 0 0,0 12,1A5,5 0 0,0 7,6V8H6A2,2 0 0,0 4,10V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V10A2,2 0 0,0 18,8Z</Geometry>
        <Geometry x:Key="IconUnlock">M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8H17V6A5,5 0 0,0 12,1A5,5 0 0,0 7,6H9V8H18V10H20V20H4V10H6V8H7A5,5 0 0,0 12,1Z</Geometry>
        <Geometry x:Key="IconExcel">M21.17 3.25Q21.5 3.25 21.76 3.5 22 3.74 22 4.08V19.92Q22 20.26 21.76 20.5 21.5 20.75 21.17 20.75H7.83Q7.5 20.75 7.24 20.5 7 20.26 7 19.92V4.08Q7 3.74 7.24 3.5 7.5 3.25 7.83 3.25H21.17M13.83 18.25V15.7H11.5V14.05L13.72 10.63H11.6V9H16.33V10.65L14.12 14.07H16.25V15.7H13.83V18.25M6.25 15.5Q6.25 15.15 6.04 14.88 5.82 14.6 5.5 14.6H3.5Q3.18 14.6 2.96 14.88 2.75 15.15 2.75 15.5V17.5Q2.75 17.82 2.96 18.1 3.18 18.38 3.5 18.38H5.5Q5.82 18.38 6.04 18.1 6.25 17.82 6.25 17.5V15.5M6.25 9.5Q6.25 9.18 6.04 8.9 5.82 8.62 5.5 8.62H3.5Q3.18 8.62 2.96 8.9 2.75 9.18 2.75 9.5V11.5Q2.75 11.82 2.96 12.1 3.18 12.38 3.5 12.38H5.5Q5.82 12.38 6.04 12.1 6.25 11.82 6.25 11.5V9.5Z</Geometry>
        <Geometry x:Key="IconPromotion">M12.41,2.58C12.03,2.2 11.53,2 11,2H4C2.9,2 2,2.9 2,4V11C2,11.53 2.2,12.03 2.59,12.41L12.42,22.24C12.81,22.63 13.44,22.63 13.83,22.24L22.24,13.82C22.63,13.43 22.63,12.8 22.24,12.41L12.41,2.58M7,7A1.5,1.5 0 0,1 5.5,8.5A1.5,1.5 0 0,1 4,7A1.5,1.5 0 0,1 5.5,5.5A1.5,1.5 0 0,1 7,7Z</Geometry>
        <Geometry x:Key="IconSettings">M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M12,22C11.6,22 11.2,21.9 10.8,21.7L9.1,20.9C5.1,19.3 2,15.2 2,10.9V5L12,2L22,5V10.9C22,15.2 18.9,19.3 14.9,20.9L13.2,21.7C12.8,21.9 12.4,22 12,22Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>
        <Style x:Key="RightAligned" TargetType="TextBlock">
            <Setter Property="TextAlignment" Value="Right"/>
        </Style>
        <Style x:Key="CustomerDataGridRowStyle" TargetType="DataGridRow">
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding BiKhoa}" Value="True">
                    <Setter Property="Background" Value="#FFEBEE"/>
                    <Setter Property="Foreground" Value="{StaticResource ActionRedBrush}"/>
                    <Setter Property="FontStyle" Value="Italic"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="AvatarImage" TargetType="Image">
            <Setter Property="Width" Value="100"/>
            <Setter Property="Height" Value="100"/>
            <Setter Property="Stretch" Value="UniformToFill"/>
        </Style>

    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <Border Grid.Row="0" Background="{StaticResource WhiteTextBrush}" CornerRadius="8" Padding="15" Margin="0,0,0,15">
                <WrapPanel Orientation="Horizontal">
                    <TextBlock Text="Tìm kiếm (Tên, SĐT, Email):" VerticalAlignment="Center" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
                    <TextBox x:Name="txtSearchKhachHang" Width="200" Margin="10,0,0,0" TextChanged="TxtSearchKhachHang_TextChanged"/>
                    <TextBlock Text="Trạng thái:" VerticalAlignment="Center" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}" Margin="20,0,0,0"/>
                    <ComboBox x:Name="cmbFilterTrangThai" Width="150" Margin="10,0,0,0" SelectionChanged="CmbFilterTrangThai_SelectionChanged">
                        <ComboBoxItem Content="Tất cả" Tag="{x:Null}"/>
                        <ComboBoxItem Content="Đang hoạt động" Tag="False"/>
                        <ComboBoxItem Content="Bị khóa" Tag="True"/>
                    </ComboBox>

                    <Button x:Name="btnExportExcel" Margin="20,0,0,0" Style="{StaticResource PrimaryButton}" Background="#00724C" Click="BtnExportExcel_Click" Padding="10,5">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconExcel}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Xuất Excel" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <Button x:Name="btnGoToKhuyenMai" Margin="10,0,0,0" Style="{StaticResource PrimaryButton}" Background="{StaticResource AccentOrangeBrush}" Click="BtnGoToKhuyenMai_Click" Padding="10,5">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconPromotion}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Quản lý Khuyến mãi" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <Button x:Name="btnCaiDatDiem" Margin="10,0,0,0" Style="{StaticResource PrimaryButton}" Background="{StaticResource TextGrayBrush}" Click="BtnCaiDatDiem_Click" Padding="10,5">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconSettings}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Cài đặt Điểm" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                </WrapPanel>
            </Border>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="420"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Margin="0,0,15,0" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Text="Danh sách Khách hàng" Style="{StaticResource HeaderTextBlock}"/>
                        <DataGrid Grid.Row="1" x:Name="dgKhachHang" AutoGenerateColumns="False" IsReadOnly="True" 
                                  SelectionMode="Single" SelectionChanged="DgKhachHang_SelectionChanged"
                                  BorderThickness="0" RowHeaderWidth="0"
                                  RowStyle="{StaticResource CustomerDataGridRowStyle}">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ID" Binding="{Binding IdKhachHang}" Width="50"/>
                                <DataGridTextColumn Header="Họ Tên" Binding="{Binding HoTen}" Width="*"/>
                                <DataGridTextColumn Header="Số điện thoại" Binding="{Binding SoDienThoai}" Width="120"/>
                                <DataGridTextColumn Header="Email" Binding="{Binding Email}" Width="150"/>
                                <DataGridTextColumn Header="Ngày tạo" Binding="{Binding NgayTao, StringFormat='dd/MM/yyyy'}" Width="100"/>
                                <DataGridTextColumn Header="Trạng thái" Binding="{Binding TrangThai}" Width="100"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>

                <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <Border Style="{StaticResource CardBorder}">
                            <StackPanel>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock x:Name="lblFormTitle" Text="Thông tin Khách hàng" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,15"/>
                                    <Button x:Name="btnLamMoiKH" Grid.Column="1" ToolTip="Tạo mới" Click="BtnLamMoiKH_Click" 
                                            Background="Transparent" BorderThickness="0" Cursor="Hand" Width="40" Height="40">
                                        <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                                    </Button>
                                </Grid>

                                <Grid Margin="0,0,0,15">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <Border Grid.Column="0" BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="1" Width="100" Height="100" Background="{StaticResource SubtleGrayBrush}" CornerRadius="50">
                                        <Ellipse>
                                            <Ellipse.Fill>
                                                <ImageBrush x:Name="AvatarPreview" Stretch="UniformToFill"/>
                                            </Ellipse.Fill>
                                        </Ellipse>
                                    </Border>

                                    <StackPanel Grid.Column="1" VerticalAlignment="Bottom" Orientation="Horizontal" Margin="15,0,0,0">
                                        <Button x:Name="btnChonAnh" 
                                                Style="{StaticResource PrimaryButton}" Background="#F5F5F5" 
                                                BorderBrush="#E0E0E0" Foreground="{StaticResource DarkBrownBrush}"
                                                Click="BtnChonAnh_Click">
                                            <StackPanel Orientation="Horizontal">
                                                <Path Data="{StaticResource IconUpload}" Fill="{StaticResource DarkBrownBrush}" Width="23" Height="23" Margin="0,0,8,0"/>
                                                <TextBlock Text="Chọn Avatar" VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </Button>

                                        <Button x:Name="btnXoaAnh" 
                                                Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionRedBrush}" 
                                                Margin="10,0,0,0" 
                                                Click="BtnXoaAnh_Click">
                                            <StackPanel Orientation="Horizontal">
                                                <Path Data="{StaticResource IconDelete}" Fill="White"  Width="23" Height="23" Margin="0,0,8,0"/>
                                                <TextBlock Text="Xóa" VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </Button>
                                    </StackPanel>
                                </Grid>

                                <Label Content="Họ tên (*)"/>
                                <TextBox x:Name="txtHoTenKH"/>
                                <Label Content="Số điện thoại (*)"/>
                                <TextBox x:Name="txtSdtKH"/>
                                <Label Content="Email"/>
                                <TextBox x:Name="txtEmailKH"/>
                                <Label Content="Tên đăng nhập (Web)"/>
                                <TextBox x:Name="txtTenDangNhapKH"/>
                                <Label Content="Địa chỉ"/>
                                <TextBox x:Name="txtDiaChiKH"/>
                                <Label Content="Điểm tích lũy"/>
                                <TextBox x:Name="txtDiemTichLuy" IsReadOnly="False"/>

                                <WrapPanel Orientation="Horizontal" Margin="0,20,0,0">
                                    <Button x:Name="btnThemKH" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionGreenBrush}" Click="BtnThemKH_Click" Margin="0,0,8,0" Padding="15,10">
                                        <TextBlock Text="Thêm Mới"/>
                                    </Button>
                                    <Button x:Name="btnLuuKH" Style="{StaticResource PrimaryButton}" Click="BtnLuuKH_Click" Margin="0,0,8,0" Padding="15,10">
                                        <TextBlock Text="Lưu Thay Đổi"/>
                                    </Button>
                                    <Button x:Name="btnXoaKH" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionRedBrush}" Click="BtnXoaKH_Click" Padding="15,10">
                                        <TextBlock Text="Xóa"/>
                                    </Button>
                                </WrapPanel>
                                <WrapPanel Orientation="Horizontal" Margin="0,10,0,0">
                                    <Button x:Name="btnKhoaKH" Style="{StaticResource PrimaryButton}" Background="{StaticResource AccentOrangeBrush}" Click="BtnKhoaKH_Click" Margin="0,0,8,0" Padding="15,10">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconLock}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                            <TextBlock Text="Khóa Tài Khoản" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                    <Button x:Name="btnMoKhoaKH" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionBlueBrush}" Click="BtnMoKhoaKH_Click" Padding="15,10">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconUnlock}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                            <TextBlock Text="Mở Khóa" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                </WrapPanel>
                            </StackPanel>
                        </Border>

                        <Border Style="{StaticResource CardBorder}" Margin="0,20,0,0">
                            <StackPanel>
                                <TextBlock Text="Lịch sử Giao dịch" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,10"/>
                                <TextBlock Text="Đơn hàng đã mua:" FontWeight="SemiBold" Margin="0,0,0,5"/>
                                <DataGrid x:Name="dgLichSuDonHang" AutoGenerateColumns="False" IsReadOnly="True" MaxHeight="150" RowHeaderWidth="0">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Mã HĐ" Binding="{Binding IdHoaDon}" Width="60"/>
                                        <DataGridTextColumn Header="Ngày" Binding="{Binding ThoiGianTao, StringFormat='dd/MM/yy'}" Width="80"/>
                                        <DataGridTextColumn Header="Tổng tiền" Binding="{Binding ThanhTien, StringFormat=N0}" Width="*" ElementStyle="{StaticResource RightAligned}"/>
                                        <DataGridTextColumn Header="Trạng thái" Binding="{Binding TrangThai}" Width="100"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                                <TextBlock Text="Sách đã thuê:" FontWeight="SemiBold" Margin="0,10,0,5"/>
                                <DataGrid x:Name="dgLichSuThueSach" AutoGenerateColumns="False" IsReadOnly="True" MaxHeight="150" RowHeaderWidth="0">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Mã Phiếu" Binding="{Binding IdPhieuThue}" Width="70"/>
                                        <DataGridTextColumn Header="Tên Sách" Binding="{Binding TieuDeSach}" Width="*"/>
                                        <DataGridTextColumn Header="Ngày Thuê" Binding="{Binding NgayThue, StringFormat='dd/MM/yy'}" Width="80"/>
                                        <DataGridTextColumn Header="Trạng thái" Binding="{Binding TrangThai}" Width="100"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Đang tải..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyKhachHangView.xaml.cs
================================================================================
﻿// Tập tin: AppCafebookApi/View/quanly/pages/QuanLyKhachHangView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using Microsoft.Win32;
using System.IO;
using AppCafebookApi.Services;
using CafebookModel.Utils;
using OfficeOpenXml;
using System.Text.RegularExpressions;
using AppCafebookApi.View.common;
using System.Net.Http.Headers; // <-- THÊM

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyKhachHangView : Page
    {
        private static readonly HttpClient httpClient;

        private List<KhachHangDto> _allKhachHangList = new List<KhachHangDto>();

        // SỬA: Dùng DTO chi tiết (Detail)
        private KhachHangDetailDto? _selectedKhachHang = null;

        // SỬA: Thay thế Base64
        private string? _currentAvatarFilePath = null;
        private bool _deleteAvatarRequest = false;

        static QuanLyKhachHangView()
        {
            httpClient = new HttpClient
            {
                // SỬA: Dùng 127.0.0.1
                BaseAddress = new Uri("http://127.0.0.1:5166")
            };
        }

        public QuanLyKhachHangView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            cmbFilterTrangThai.SelectedIndex = 0; // "Tất cả"
            await LoadKhachHangGridAsync();
            ResetKhachHangForm();
        }

        #region TAB 1: KHÁCH HÀNG

        // --- Tải dữ liệu & Lọc ---
        private async Task LoadKhachHangGridAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            string searchText = txtSearchKhachHang.Text;
            bool? biKhoa = (cmbFilterTrangThai.SelectedItem as ComboBoxItem)?.Tag as bool?;
            try
            {
                var url = $"api/app/khachhang/search?searchText={Uri.EscapeDataString(searchText)}";
                if (biKhoa.HasValue)
                {
                    url += $"&biKhoa={biKhoa.Value}";
                }
                _allKhachHangList = (await httpClient.GetFromJsonAsync<List<KhachHangDto>>(url)) ?? new List<KhachHangDto>();
                dgKhachHang.ItemsSource = _allKhachHangList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải danh sách khách hàng: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void TxtSearchKhachHang_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (this.IsLoaded)
                await LoadKhachHangGridAsync();
        }

        private async void CmbFilterTrangThai_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (cmbFilterTrangThai.IsLoaded)
            {
                await LoadKhachHangGridAsync();
            }
        }

        // --- Form & CRUD ---

        private void ResetKhachHangForm()
        {
            _selectedKhachHang = null;
            _currentAvatarFilePath = null;
            _deleteAvatarRequest = false;

            dgKhachHang.SelectedItem = null;
            lblFormTitle.Text = "Thêm Khách hàng Mới";
            btnThemKH.Visibility = Visibility.Visible;
            btnLuuKH.Visibility = Visibility.Collapsed;
            btnXoaKH.Visibility = Visibility.Collapsed;
            btnKhoaKH.Visibility = Visibility.Collapsed;
            btnMoKhoaKH.Visibility = Visibility.Collapsed;
            txtHoTenKH.Text = "";
            txtSdtKH.Text = "";
            txtEmailKH.Text = "";
            txtTenDangNhapKH.Text = "";
            txtDiaChiKH.Text = "";
            txtDiemTichLuy.Text = "0";
            dgLichSuDonHang.ItemsSource = null;
            dgLichSuThueSach.ItemsSource = null;
            AvatarPreview.ImageSource = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultAvatar);
        }

        private async void DgKhachHang_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgKhachHang.SelectedItem is not KhachHangDto selected)
            {
                ResetKhachHangForm();
                return;
            }
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                _selectedKhachHang = await httpClient.GetFromJsonAsync<KhachHangDetailDto>($"api/app/khachhang/details/{selected.IdKhachHang}");
                if (_selectedKhachHang == null)
                {
                    ResetKhachHangForm();
                    return;
                }

                _currentAvatarFilePath = null;
                _deleteAvatarRequest = false;

                lblFormTitle.Text = "Cập nhật Khách hàng";
                btnThemKH.Visibility = Visibility.Collapsed;
                btnLuuKH.Visibility = Visibility.Visible;
                btnXoaKH.Visibility = Visibility.Visible;
                btnKhoaKH.Visibility = _selectedKhachHang.BiKhoa ? Visibility.Collapsed : Visibility.Visible;
                btnMoKhoaKH.Visibility = _selectedKhachHang.BiKhoa ? Visibility.Visible : Visibility.Collapsed;
                txtHoTenKH.Text = _selectedKhachHang.HoTen;
                txtSdtKH.Text = _selectedKhachHang.SoDienThoai;
                txtEmailKH.Text = _selectedKhachHang.Email;
                txtTenDangNhapKH.Text = _selectedKhachHang.TenDangNhap;
                txtDiaChiKH.Text = _selectedKhachHang.DiaChi;
                txtDiemTichLuy.Text = _selectedKhachHang.DiemTichLuy.ToString();
                dgLichSuDonHang.ItemsSource = _selectedKhachHang.LichSuDonHang;
                dgLichSuThueSach.ItemsSource = _selectedKhachHang.LichSuThueSach;

                // SỬA: Load ảnh từ URL
                AvatarPreview.ImageSource = HinhAnhHelper.LoadImage(_selectedKhachHang.AnhDaiDienUrl, HinhAnhPaths.DefaultAvatar);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải chi tiết khách hàng: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnLamMoiKH_Click(object sender, RoutedEventArgs e)
        {
            ResetKhachHangForm();
        }

        private void BtnChonAnh_Click(object sender, RoutedEventArgs e)
        {
            var ofd = new OpenFileDialog { Filter = "Image files|*.png;*.jpg;*.jpeg", Title = "Chọn Avatar" };
            if (ofd.ShowDialog() == true)
            {
                try
                {
                    // SỬA: Chỉ lưu đường dẫn file
                    _currentAvatarFilePath = ofd.FileName;
                    _deleteAvatarRequest = false;
                    AvatarPreview.ImageSource = HinhAnhHelper.LoadImage(_currentAvatarFilePath, HinhAnhPaths.DefaultAvatar);
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Lỗi đọc file ảnh: {ex.Message}", "Lỗi File");
                    _currentAvatarFilePath = null;
                    AvatarPreview.ImageSource = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultAvatar);
                }
            }
        }

        // THÊM: Nút Xóa Ảnh
        private void BtnXoaAnh_Click(object sender, RoutedEventArgs e)
        {
            _currentAvatarFilePath = null;
            _deleteAvatarRequest = true;
            AvatarPreview.ImageSource = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultAvatar);
        }

        // SỬA: Tách hàm Validate riêng
        private bool ValidateKhachHangInput(out MultipartFormDataContent form)
        {
            form = new MultipartFormDataContent();
            if (string.IsNullOrWhiteSpace(txtHoTenKH.Text) || string.IsNullOrWhiteSpace(txtSdtKH.Text))
            {
                MessageBox.Show("Họ tên và Số điện thoại là bắt buộc.", "Thiếu thông tin");
                return false;
            }
            if (!string.IsNullOrEmpty(txtEmailKH.Text) && !Regex.IsMatch(txtEmailKH.Text, @"^[^@\s]+@[^@\s]+\.[^@\s]+$"))
            {
                MessageBox.Show("Định dạng Email không hợp lệ.", "Lỗi");
                return false;
            }

            // 1. Thêm các trường dữ liệu
            form.Add(new StringContent(txtHoTenKH.Text), "HoTen");
            form.Add(new StringContent(txtSdtKH.Text), "SoDienThoai");
            form.Add(new StringContent(txtEmailKH.Text ?? ""), "Email");
            form.Add(new StringContent(txtTenDangNhapKH.Text ?? ""), "TenDangNhap");
            form.Add(new StringContent(txtDiaChiKH.Text ?? ""), "DiaChi");
            form.Add(new StringContent(int.TryParse(txtDiemTichLuy.Text, out int diem) ? diem.ToString() : "0"), "DiemTichLuy");

            // 2. Thêm file
            if (!string.IsNullOrEmpty(_currentAvatarFilePath))
            {
                var fileStream = File.OpenRead(_currentAvatarFilePath);
                var streamContent = new StreamContent(fileStream);
                streamContent.Headers.ContentType = new MediaTypeHeaderValue("image/jpeg");
                form.Add(streamContent, "AnhDaiDienUpload", Path.GetFileName(_currentAvatarFilePath));
            }

            // 3. Thêm cờ Xóa
            if (_deleteAvatarRequest)
            {
                form.Add(new StringContent("true"), "XoaAnhDaiDien");
            }

            return true;
        }

        private async void BtnThemKH_Click(object sender, RoutedEventArgs e)
        {
            if (!ValidateKhachHangInput(out var form)) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsync("api/app/khachhang", form);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Thêm khách hàng thành công!", "Thông báo");
                    await LoadKhachHangGridAsync();
                    ResetKhachHangForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnLuuKH_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedKhachHang == null || !ValidateKhachHangInput(out var form)) return;

            // Thêm Id vào form
            form.Add(new StringContent(_selectedKhachHang.IdKhachHang.ToString()), "IdKhachHang");

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PutAsync($"api/app/khachhang/{_selectedKhachHang.IdKhachHang}", form);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Cập nhật thành công!", "Thông báo");
                    await LoadKhachHangGridAsync();
                    ResetKhachHangForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnKhoaKH_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedKhachHang == null) return;
            await UpdateKhachHangStatus(_selectedKhachHang.IdKhachHang, true);
        }

        private async void BtnMoKhoaKH_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedKhachHang == null) return;
            await UpdateKhachHangStatus(_selectedKhachHang.IdKhachHang, false);
        }

        private async Task UpdateKhachHangStatus(int id, bool biKhoa)
        {
            string action = biKhoa ? "KHÓA" : "MỞ KHÓA";
            if (MessageBox.Show($"Bạn có chắc muốn {action} tài khoản này?", "Xác nhận", MessageBoxButton.YesNo) == MessageBoxResult.No)
                return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                // SỬA: Gửi JSON object
                var response = await httpClient.PutAsJsonAsync($"api/app/khachhang/update-status/{id}", new { BiKhoa = biKhoa });
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show($"{action} thành công.", "Thông báo");
                    await LoadKhachHangGridAsync();
                    ResetKhachHangForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXoaKH_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedKhachHang == null) return;
            var result = MessageBox.Show($"Bạn có chắc chắn muốn XÓA vĩnh viễn khách hàng '{_selectedKhachHang.HoTen}'?\n(Hành động này không thể hoàn tác)", "Xác nhận Xóa", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/khachhang/{_selectedKhachHang.IdKhachHang}");
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Xóa thành công!", "Thông báo");
                    await LoadKhachHangGridAsync();
                    ResetKhachHangForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Không thể xóa");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnExportExcel_Click(object sender, RoutedEventArgs e)
        {
            // (Logic Export giữ nguyên)
        }

        #endregion

        #region KHUYẾN MÃI (Điều hướng)
        // (Logic Navigation giữ nguyên)
        private void BtnGoToKhuyenMai_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new QuanLyKhuyenMaiView());
        }
        private void BtnCaiDatDiem_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new CaiDatWindow());
        }

        #endregion
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyKhuyenMaiView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyKhuyenMaiView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quản lý Khuyến mãi" FontFamily="Segoe UI" Loaded="Page_Loaded"
      Background="#FFF8E1">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="StatusGreenBrush" Color="#E8F5E9"/>
        <SolidColorBrush x:Key="StatusGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="StatusRedBrush" Color="#FFEBEE"/>
        <Geometry x:Key="IconExcel">M21.17 3.25Q21.5 3.25 21.76 3.5 22 3.74 22 4.08V19.92Q22 20.26 21.76 20.5 21.5 20.75 21.17 20.75H7.83Q7.5 20.75 7.24 20.5 7 20.26 7 19.92V4.08Q7 3.74 7.24 3.5 7.5 3.25 7.83 3.25H21.17M13.83 18.25V15.7H11.5V14.05L13.72 10.63H11.6V9H16.33V10.65L14.12 14.07H16.25V15.7H13.83V18.25M6.25 15.5Q6.25 15.15 6.04 14.88 5.82 14.6 5.5 14.6H3.5Q3.18 14.6 2.96 14.88 2.75 15.15 2.75 15.5V17.5Q2.75 17.82 2.96 18.1 3.18 18.38 3.5 18.38H5.5Q5.82 18.38 6.04 18.1 6.25 17.82 6.25 17.5V15.5M6.25 9.5Q6.25 9.18 6.04 8.9 5.82 8.62 5.5 8.62H3.5Q3.18 8.62 2.96 8.9 2.75 9.18 2.75 9.5V11.5Q2.75 11.82 2.96 12.1 3.18 12.38 3.5 12.38H5.5Q5.82 12.38 6.04 12.1 6.25 11.82 6.25 11.5V9.5Z</Geometry>
        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconFilter">M14,12V19.88C14.04,20.18 13.94,20.5 13.71,20.71C13.32,21.1 12.69,21.1 12.3,20.71L10.29,18.7C10.06,18.47 9.96,18.16 10,17.87V12H14M15,9H9V4H15V9Z</Geometry>
        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>
        <Style x:Key="PromotionDataGridRowStyle" TargetType="DataGridRow">
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding TrangThai}" Value="Hoạt động">
                    <Setter Property="Background" Value="{StaticResource StatusGreenBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TrangThai}" Value="Tạm dừng">
                    <Setter Property="Background" Value="{StaticResource StatusRedBrush}"/>
                    <Setter Property="Foreground" Value="{StaticResource ActionRedBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TrangThai}" Value="Hết hạn">
                    <Setter Property="Background" Value="{StaticResource StatusGrayBrush}"/>
                    <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
                    <Setter Property="FontStyle" Value="Italic"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="450"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Margin="0,0,15,0" Style="{StaticResource CardBorder}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Text="Danh sách Khuyến mãi" Style="{StaticResource HeaderTextBlock}"/>

                    <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,15">
                        <TextBlock Text="Tìm Mã:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                        <TextBox x:Name="txtSearchMaKM" Width="120" TextChanged="Filter_Changed"/>

                        <TextBlock Text="Trạng thái:" VerticalAlignment="Center" Margin="15,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                        <ComboBox x:Name="cmbFilterTrangThai" Width="150" SelectionChanged="Filter_Changed">
                            <ComboBoxItem Content="Tất cả"/>
                            <ComboBoxItem Content="Hoạt động"/>
                            <ComboBoxItem Content="Tạm dừng"/>
                            <ComboBoxItem Content="Hết hạn"/>
                        </ComboBox>
                    </StackPanel>

                    <DataGrid Grid.Row="2" x:Name="dgKhuyenMai" AutoGenerateColumns="False" IsReadOnly="True" 
                              SelectionMode="Single" SelectionChanged="DgKhuyenMai_SelectionChanged"
                              BorderThickness="0" RowHeaderWidth="0"
                              RowStyle="{StaticResource PromotionDataGridRowStyle}">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Mã KM" Binding="{Binding MaKhuyenMai}" Width="100"/>
                            <DataGridTextColumn Header="Tên chương trình" Binding="{Binding TenKhuyenMai}" Width="*"/>
                            <DataGridTextColumn Header="Giảm" Binding="{Binding GiaTriGiam}" Width="80"/>
                            <DataGridTextColumn Header="Tối đa" Binding="{Binding GiamToiDa, StringFormat=N0}" Width="80"/>
                            <DataGridTextColumn Header="SL Còn" Binding="{Binding SoLuongConLai}" Width="80"/>
                            <DataGridTextColumn Header="Bắt đầu" Binding="{Binding NgayBatDau, StringFormat='dd/MM/yy'}" Width="80"/>
                            <DataGridTextColumn Header="Kết thúc" Binding="{Binding NgayKetThuc, StringFormat='dd/MM/yy'}" Width="80"/>
                            <DataGridTextColumn Header="Trạng thái" Binding="{Binding TrangThai}" Width="100"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="0,15,0,0">
                        <Button x:Name="btnQuayLai" Style="{StaticResource BackButton}"
                                HorizontalAlignment="Left" 
                                Click="BtnQuayLai_Click">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="&lt; Quay lại" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>

                        <Button x:Name="btnExportToExcel" HorizontalAlignment="Left" Margin="20,0,0,0"
                                Style="{StaticResource PrimaryButton}" Background="#00724C"
                                Click="BtnExportToExcel_Click">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconExcel}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="Xuất Excel" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <Border Grid.Column="1" Style="{StaticResource CardBorder}">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <TextBlock Text="Thông tin Chương trình Khuyến mãi" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,15"/>

                        <TextBlock Text="Mã Khuyến mãi (Không dấu, VIẾT LIỀN):" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtMaKhuyenMai" Margin="0,0,0,10"/>

                        <TextBlock Text="Tên chương trình:" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtTenKM" Margin="0,0,0,10"/>
                        <TextBlock Text="Mô tả (Ghi chú nội bộ):" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtMoTa" Height="40" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10"/>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,5,0">
                                <TextBlock Text="Loại giảm giá:" Margin="0,0,0,5"/>
                                <ComboBox x:Name="cmbLoaiGiamGia">
                                    <ComboBoxItem Content="Phần Trăm" Tag="PhanTram"/>
                                    <ComboBoxItem Content="Số Tiền" Tag="SoTien"/>
                                </ComboBox>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="5,0,0,0">
                                <TextBlock Text="Giá trị giảm (VND hoặc %):" Margin="0,0,0,5"/>
                                <TextBox x:Name="txtGiaTriGiam"/>
                            </StackPanel>
                        </Grid>

                        <TextBlock Text="Giảm tối đa (Nếu là %):" Margin="0,10,0,5"/>
                        <TextBox x:Name="txtGiamToiDa" Margin="0,0,0,10"/>

                        <TextBlock Text="Mô tả ĐK (Hiển thị ở bảng):" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtDieuKienApDung" Margin="0,0,0,10"/>

                        <TextBlock Text="Điều kiện áp dụng (tùy chọn):" FontWeight="SemiBold" Margin="0,15,0,5"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,5,0">
                                <TextBlock Text="Hóa đơn tối thiểu (VND):" Margin="0,0,0,5"/>
                                <TextBox x:Name="txtDonHangToiThieu"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="5,0,0,0">
                                <TextBlock Text="Số lượng còn lại:" Margin="0,0,0,5"/>
                                <TextBox x:Name="txtSoLuongConLai" ToolTip="Để 0 hoặc trống nếu không giới hạn"/>
                            </StackPanel>
                        </Grid>

                        <TextBlock Text="Sản phẩm áp dụng:" Margin="0,10,0,5"/>
                        <ComboBox x:Name="cmbSanPhamApDung" DisplayMemberPath="Ten" SelectedValuePath="Id"
                                  IsEditable="True" IsTextSearchEnabled="True" Margin="0,0,0,10"/>

                        <Grid Margin="0,10,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,5,0">
                                <TextBlock Text="Ngày Bắt đầu:" Margin="0,0,0,5"/>
                                <DatePicker x:Name="dpNgayBatDau"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="5,0,0,0">
                                <TextBlock Text="Ngày Kết thúc:" Margin="0,0,0,5"/>
                                <DatePicker x:Name="dpNgayKetThuc"/>
                            </StackPanel>
                        </Grid>

                        <Grid Margin="0,10,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,5,0">
                                <TextBlock Text="Thứ (vd: 2,3,4):" Margin="0,0,0,5"/>
                                <TextBox x:Name="txtDayOfWeek"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="5,0,5,0">
                                <TextBlock Text="Giờ Bắt đầu (HH:mm):" Margin="0,0,0,5"/>
                                <TextBox x:Name="txtTimeStart"/>
                            </StackPanel>
                            <StackPanel Grid.Column="2" Margin="5,0,0,0">
                                <TextBlock Text="Giờ Kết thúc (HH:mm):" Margin="0,0,0,5"/>
                                <TextBox x:Name="txtTimeEnd"/>
                            </StackPanel>
                        </Grid>

                        <Button x:Name="btnTamDung" Style="{StaticResource PrimaryButton}" Background="{StaticResource AccentOrangeBrush}" Margin="0,15,0,0" Click="BtnTamDung_Click">
                            <TextBlock Text="Tạm Dừng / Kích Hoạt Lại" VerticalAlignment="Center"/>
                        </Button>

                        <Grid Margin="0,20,0,0" Height="41">
                            <Button x:Name="btnLamMoi" ToolTip="Làm mới" Click="BtnLamMoi_Click" Background="Transparent" BorderThickness="0" Cursor="Hand" Width="41" HorizontalAlignment="Left">
                                <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="22" Height="22"/>
                            </Button>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button x:Name="btnThem" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionGreenBrush}" Click="BtnThem_Click" Margin="0,0,8,0">
                                    <StackPanel Orientation="Horizontal">
                                        <Viewbox Width="23" Height="23" Margin="0,0,8,0">
                                            <Path Data="{StaticResource IconAdd}" Fill="White"/>
                                        </Viewbox>
                                        <TextBlock Text="Thêm" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                                <Button x:Name="btnLuu" Style="{StaticResource PrimaryButton}" Margin="0,0,8,0" Click="BtnLuu_Click">
                                    <StackPanel Orientation="Horizontal">
                                        <Viewbox Width="23" Height="23" Margin="0,0,8,0">
                                            <Path Data="{StaticResource IconSave}" Fill="White"/>
                                        </Viewbox>
                                        <TextBlock Text="Lưu" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                                <Button x:Name="btnXoa" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionRedBrush}" Click="BtnXoa_Click">
                                    <StackPanel Orientation="Horizontal">
                                        <Viewbox Width="23" Height="23" Margin="0,0,8,0">
                                            <Path Data="{StaticResource IconDelete}" Fill="White"/>
                                        </Viewbox>
                                        <TextBlock Text="Xóa" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                        </Grid>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Đang tải..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyKhuyenMaiView.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using Microsoft.Win32;
using System.IO;
using OfficeOpenXml;
using OfficeOpenXml.Table;
using System.Globalization;

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyKhuyenMaiView : Page
    {
        private static readonly HttpClient httpClient;
        private List<KhuyenMaiDto> _allKhuyenMaiList = new List<KhuyenMaiDto>();
        private KhuyenMaiUpdateRequestDto? _selectedKhuyenMai = null;
        private List<FilterLookupDto> _sanPhamList = new List<FilterLookupDto>();

        static QuanLyKhuyenMaiView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyKhuyenMaiView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            cmbFilterTrangThai.SelectedIndex = 0; // "Tất cả"

            await LoadKhuyenMaiFiltersAsync();
            await LoadKhuyenMaiDataAsync();
        }

        /// <summary>
        /// Tải các bộ lọc (Danh sách sản phẩm)
        /// </summary>
        private async Task LoadKhuyenMaiFiltersAsync()
        {
            try
            {
                var response = await httpClient.GetAsync("/api/app/khuyenmai/filters");
                if (response.IsSuccessStatusCode)
                {
                    _sanPhamList = (await response.Content.ReadFromJsonAsync<List<FilterLookupDto>>()) ?? new List<FilterLookupDto>();
                    _sanPhamList.Insert(0, new FilterLookupDto { Id = 0, Ten = "Không áp dụng (cho toàn hóa đơn)" });

                    cmbSanPhamApDung.ItemsSource = _sanPhamList;
                    cmbSanPhamApDung.SelectedValue = 0;
                }
                else
                {
                    MessageBox.Show("Không thể tải danh sách sản phẩm.");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi khi tải bộ lọc: {ex.Message}");
            }
        }

        /// <summary>
        /// Tải dữ liệu chính cho DataGrid và làm mới form
        /// </summary>
        private async Task LoadKhuyenMaiDataAsync()
        {
            SetLoading(true);
            try
            {
                string maKM = txtSearchMaKM.Text;
                string trangThai = (cmbFilterTrangThai.SelectedItem as ComboBoxItem)?.Content?.ToString() ?? "Tất cả";

                var response = await httpClient.GetAsync($"/api/app/khuyenmai/search?maKhuyenMai={maKM}&trangThai={trangThai}");
                if (response.IsSuccessStatusCode)
                {
                    _allKhuyenMaiList = (await response.Content.ReadFromJsonAsync<List<KhuyenMaiDto>>()) ?? new List<KhuyenMaiDto>();
                    dgKhuyenMai.ItemsSource = _allKhuyenMaiList;
                    LamMoiUI(); // Làm mới form chi tiết
                }
                else
                {
                    MessageBox.Show("Không thể tải danh sách khuyến mãi.");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}");
            }
            finally
            {
                SetLoading(false);
            }
        }

        private async void Filter_Changed(object sender, RoutedEventArgs e)
        {
            if (IsLoaded)
            {
                await LoadKhuyenMaiDataAsync();
            }
        }

        private async void DgKhuyenMai_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgKhuyenMai.SelectedItem is KhuyenMaiDto selectedDto)
            {
                await LoadChiTietKhuyenMai(selectedDto.IdKhuyenMai);
            }
        }

        /// <summary>
        /// SỬA: Cập nhật logic tải chi tiết (Trạng thái SỬA)
        /// </summary>
        private async Task LoadChiTietKhuyenMai(int id)
        {
            SetLoading(true);
            try
            {
                var response = await httpClient.GetAsync($"/api/app/khuyenmai/{id}");
                if (response.IsSuccessStatusCode)
                {
                    _selectedKhuyenMai = await response.Content.ReadFromJsonAsync<KhuyenMaiUpdateRequestDto>();
                    if (_selectedKhuyenMai != null)
                    {
                        // Hiển thị dữ liệu lên form
                        txtMaKhuyenMai.Text = _selectedKhuyenMai.MaKhuyenMai;
                        txtTenKM.Text = _selectedKhuyenMai.TenChuongTrinh;
                        txtMoTa.Text = _selectedKhuyenMai.MoTa;

                        cmbLoaiGiamGia.SelectedValue = _selectedKhuyenMai.LoaiGiamGia == "PhanTram"
                            ? (cmbLoaiGiamGia.Items[0] as ComboBoxItem)
                            : (cmbLoaiGiamGia.Items[1] as ComboBoxItem);

                        txtGiaTriGiam.Text = _selectedKhuyenMai.GiaTriGiam.ToString(CultureInfo.InvariantCulture);
                        txtGiamToiDa.Text = _selectedKhuyenMai.GiamToiDa?.ToString(CultureInfo.InvariantCulture) ?? "0";
                        txtDieuKienApDung.Text = _selectedKhuyenMai.DieuKienApDung;
                        txtDonHangToiThieu.Text = _selectedKhuyenMai.HoaDonToiThieu?.ToString(CultureInfo.InvariantCulture) ?? "0";
                        txtSoLuongConLai.Text = _selectedKhuyenMai.SoLuongConLai?.ToString() ?? "0";
                        cmbSanPhamApDung.SelectedValue = _selectedKhuyenMai.IdSanPhamApDung ?? 0;
                        dpNgayBatDau.SelectedDate = _selectedKhuyenMai.NgayBatDau;
                        dpNgayKetThuc.SelectedDate = _selectedKhuyenMai.NgayKetThuc;
                        txtDayOfWeek.Text = _selectedKhuyenMai.NgayTrongTuan;
                        txtTimeStart.Text = _selectedKhuyenMai.GioBatDau;
                        txtTimeEnd.Text = _selectedKhuyenMai.GioKetThuc;

                        // SỬA: Ẩn/Hiện các nút cho trạng thái "Chỉnh Sửa"
                        btnThem.Visibility = Visibility.Collapsed;
                        btnLuu.Visibility = Visibility.Visible;
                        btnXoa.Visibility = Visibility.Visible;
                        btnTamDung.Visibility = Visibility.Visible;

                        // Bật các nút (an toàn)
                        btnLuu.IsEnabled = true;
                        btnXoa.IsEnabled = true;
                        btnTamDung.IsEnabled = true;
                    }
                }
                else
                {
                    MessageBox.Show("Không tìm thấy chi tiết khuyến mãi.");
                    LamMoiUI(); // <-- Quan trọng: Nếu lỗi, reset về trạng thái "Thêm Mới"
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải chi tiết: {ex.Message}");
                LamMoiUI(); // <-- Quan trọng: Nếu lỗi, reset về trạng thái "Thêm Mới"
            }
            finally
            {
                SetLoading(false);
            }
        }

        private async void BtnThem_Click(object sender, RoutedEventArgs e)
        {
            if (!ValidateInput()) return;

            var dto = MapDtoFromUi();
            dto.TrangThai = "Hoạt động"; // Mặc định khi thêm mới

            SetLoading(true);
            try
            {
                var response = await httpClient.PostAsJsonAsync("/api/app/khuyenmai", dto);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Thêm khuyến mãi thành công!");
                    await LoadKhuyenMaiDataAsync(); // Tải lại lưới
                }
                else
                {
                    string error = await response.Content.ReadAsStringAsync();
                    MessageBox.Show($"Lỗi khi thêm: {error}", "Lỗi");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}");
            }
            finally
            {
                SetLoading(false);
            }
        }

        private async void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedKhuyenMai == null) return;
            if (!ValidateInput()) return;

            var dto = MapDtoFromUi();
            dto.IdKhuyenMai = _selectedKhuyenMai.IdKhuyenMai;
            dto.TrangThai = _selectedKhuyenMai.TrangThai; // Giữ trạng thái cũ khi lưu

            SetLoading(true);
            try
            {
                var response = await httpClient.PutAsJsonAsync($"/api/app/khuyenmai/{dto.IdKhuyenMai}", dto);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Cập nhật thành công!");
                    await LoadKhuyenMaiDataAsync(); // Tải lại lưới
                }
                else
                {
                    string error = await response.Content.ReadAsStringAsync();
                    MessageBox.Show($"Lỗi khi cập nhật: {error}", "Lỗi");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}");
            }
            finally
            {
                SetLoading(false);
            }
        }

        private async void BtnXoa_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedKhuyenMai == null) return;

            if (MessageBox.Show($"Bạn có chắc muốn xóa mã: {_selectedKhuyenMai.MaKhuyenMai}?", "Xác nhận xóa", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.Yes)
            {
                SetLoading(true);
                try
                {
                    var response = await httpClient.DeleteAsync($"/api/app/khuyenmai/{_selectedKhuyenMai.IdKhuyenMai}");
                    if (response.IsSuccessStatusCode)
                    {
                        MessageBox.Show("Xóa thành công!");
                        await LoadKhuyenMaiDataAsync();
                    }
                    else
                    {
                        string error = await response.Content.ReadAsStringAsync();
                        MessageBox.Show($"Lỗi khi xóa: {error}", "Lỗi");
                    }
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Lỗi kết nối: {ex.Message}");
                }
                finally
                {
                    SetLoading(false);
                }
            }
        }

        private async void BtnTamDung_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedKhuyenMai == null) return;

            SetLoading(true);
            try
            {
                var response = await httpClient.PatchAsync($"/api/app/khuyenmai/togglestatus/{_selectedKhuyenMai.IdKhuyenMai}", null);
                if (response.IsSuccessStatusCode)
                {
                    string newStatus = await response.Content.ReadAsStringAsync();
                    MessageBox.Show($"Đã cập nhật trạng thái thành: {newStatus}");
                    await LoadKhuyenMaiDataAsync(); // Tải lại để cập nhật chi tiết
                }
                else
                {
                    string error = await response.Content.ReadAsStringAsync();
                    MessageBox.Show($"Lỗi: {error}", "Lỗi");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}");
            }
            finally
            {
                SetLoading(false);
            }
        }

        private async void BtnLamMoi_Click(object sender, RoutedEventArgs e)
        {
            LamMoiUI(); // Xóa form
            if (_allKhuyenMaiList.Count == 0) // Chỉ tải lại nếu lưới rỗng
            {
                await LoadKhuyenMaiDataAsync();
            }
        }

        private KhuyenMaiUpdateRequestDto MapDtoFromUi()
        {
            return new KhuyenMaiUpdateRequestDto
            {
                MaKhuyenMai = txtMaKhuyenMai.Text,
                TenChuongTrinh = txtTenKM.Text,
                MoTa = txtMoTa.Text,
                LoaiGiamGia = (cmbLoaiGiamGia.SelectedItem as ComboBoxItem)?.Tag.ToString() ?? "SoTien",
                GiaTriGiam = decimal.TryParse(txtGiaTriGiam.Text, NumberStyles.Any, CultureInfo.InvariantCulture, out var gt) ? gt : 0,

                GiamToiDa = decimal.TryParse(txtGiamToiDa.Text, NumberStyles.Any, CultureInfo.InvariantCulture, out var max) ? max : 0,
                HoaDonToiThieu = decimal.TryParse(txtDonHangToiThieu.Text, NumberStyles.Any, CultureInfo.InvariantCulture, out var min) ? min : 0,
                SoLuongConLai = int.TryParse(txtSoLuongConLai.Text, out var sl) ? sl : 0,
                DieuKienApDung = txtDieuKienApDung.Text,
                IdSanPhamApDung = (int)cmbSanPhamApDung.SelectedValue,
                NgayBatDau = dpNgayBatDau.SelectedDate ?? DateTime.Today,
                NgayKetThuc = dpNgayKetThuc.SelectedDate ?? DateTime.Today.AddDays(1),
                NgayTrongTuan = txtDayOfWeek.Text,
                GioBatDau = txtTimeStart.Text,
                GioKetThuc = txtTimeEnd.Text
            };
        }

        /// <summary>
        /// SỬA: Xóa (clear) tất cả các trường UI (Trạng thái THÊM MỚI)
        /// </summary>
        private void LamMoiUI()
        {
            _selectedKhuyenMai = null;
            dgKhuyenMai.SelectedItem = null; // Bỏ chọn trên lưới

            txtMaKhuyenMai.Clear();
            txtTenKM.Clear();
            txtMoTa.Clear();
            cmbLoaiGiamGia.SelectedIndex = -1;
            txtGiaTriGiam.Clear();

            txtGiamToiDa.Text = "0";
            txtDieuKienApDung.Clear();
            txtDonHangToiThieu.Text = "0";
            txtSoLuongConLai.Text = "0";
            if (cmbSanPhamApDung.Items.Count > 0)
                cmbSanPhamApDung.SelectedValue = 0;
            dpNgayBatDau.SelectedDate = null;
            dpNgayKetThuc.SelectedDate = null;
            txtDayOfWeek.Clear();
            txtTimeStart.Clear();
            txtTimeEnd.Clear();

            // SỬA: Ẩn/Hiện các nút cho trạng thái "Thêm Mới"
            btnThem.Visibility = Visibility.Visible;
            btnLuu.Visibility = Visibility.Collapsed;
            btnXoa.Visibility = Visibility.Collapsed;
            btnTamDung.Visibility = Visibility.Collapsed;

            // Vẫn giữ logic IsEnabled (an toàn)
            btnLuu.IsEnabled = false;
            btnXoa.IsEnabled = false;
            btnTamDung.IsEnabled = false;
        }

        private bool ValidateInput()
        {
            if (string.IsNullOrWhiteSpace(txtMaKhuyenMai.Text))
            {
                MessageBox.Show("Mã khuyến mãi không được để trống.");
                return false;
            }
            if (string.IsNullOrWhiteSpace(txtTenKM.Text))
            {
                MessageBox.Show("Tên chương trình không được để trống.");
                return false;
            }
            if (cmbLoaiGiamGia.SelectedItem == null)
            {
                MessageBox.Show("Vui lòng chọn loại giảm giá.");
                return false;
            }
            if (!decimal.TryParse(txtGiaTriGiam.Text, NumberStyles.Any, CultureInfo.InvariantCulture, out var gtri) || gtri <= 0)
            {
                MessageBox.Show("Giá trị giảm phải là một số lớn hơn 0.");
                return false;
            }
            if (dpNgayBatDau.SelectedDate == null || dpNgayKetThuc.SelectedDate == null)
            {
                MessageBox.Show("Ngày bắt đầu và kết thúc không được để trống.");
                return false;
            }
            if (dpNgayKetThuc.SelectedDate < dpNgayBatDau.SelectedDate)
            {
                MessageBox.Show("Ngày kết thúc không thể nhỏ hơn ngày bắt đầu.");
                return false;
            }

            // Kiểm tra giờ nếu được nhập
            if (!string.IsNullOrWhiteSpace(txtTimeStart.Text) && !TimeSpan.TryParse(txtTimeStart.Text, out _))
            {
                MessageBox.Show("Giờ bắt đầu không hợp lệ. Vui lòng nhập dạng HH:mm (ví dụ: 08:00).");
                return false;
            }
            if (!string.IsNullOrWhiteSpace(txtTimeEnd.Text) && !TimeSpan.TryParse(txtTimeEnd.Text, out _))
            {
                MessageBox.Show("Giờ kết thúc không hợp lệ. Vui lòng nhập dạng HH:mm (ví dụ: 22:00).");
                return false;
            }

            return true;
        }

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (NavigationService.CanGoBack)
            {
                NavigationService.GoBack();
            }
        }

        private void SetLoading(bool isLoading)
        {
            LoadingOverlay.Visibility = isLoading ? Visibility.Visible : Visibility.Collapsed;
            MainPanel.IsEnabled = !isLoading;
        }

        // (Hàm Export Excel giữ nguyên)
        private async void BtnExportToExcel_Click(object sender, RoutedEventArgs e)
        {
            if (_allKhuyenMaiList.Count == 0)
            {
                MessageBox.Show("Không có dữ liệu để xuất.", "Thông báo");
                return;
            }

            SaveFileDialog sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                FileName = $"DS_KhuyenMai_{DateTime.Now:ddMMyyyy_HHmmss}.xlsx"
            };

            if (sfd.ShowDialog() == true)
            {
                SetLoading(true);
                try
                {
                    ExcelPackage.License.SetNonCommercialPersonal("CafeBook");

                    await Task.Run(() =>
                    {
                        using (var package = new ExcelPackage(new FileInfo(sfd.FileName)))
                        {
                            var ws = package.Workbook.Worksheets.Add("DanhSachKhuyenMai");
                            ws.Cells["A1"].Value = "Danh sách Khuyến mãi";
                            ws.Cells["A1:D1"].Merge = true;
                            ws.Cells["A1"].Style.Font.Bold = true;
                            ws.Cells["A1"].Style.Font.Size = 16;

                            // Sửa: Đảm bảo dữ liệu mới nhất được xuất
                            var dataToExport = _allKhuyenMaiList.Select(km => new {
                                km.MaKhuyenMai,
                                km.TenKhuyenMai,
                                km.GiaTriGiam,
                                km.GiamToiDa,
                                km.SoLuongConLai,
                                km.DieuKienApDung,
                                km.NgayBatDau,
                                km.NgayKetThuc,
                                km.TrangThai
                            });

                            ws.Cells["A3"].LoadFromCollection(dataToExport, true, TableStyles.Medium9);

                            // Định dạng cột
                            ws.Cells[ws.Dimension.Address].AutoFitColumns();
                            var cols = ws.Cells["3:3"];
                            int ngayBatDauCol = cols.First(c => c.Text == "NgayBatDau").Start.Column;
                            int ngayKetThucCol = cols.First(c => c.Text == "NgayKetThuc").Start.Column;

                            ws.Column(ngayBatDauCol).Style.Numberformat.Format = "dd/MM/yyyy";
                            ws.Column(ngayKetThucCol).Style.Numberformat.Format = "dd/MM/yyyy";

                            package.Save();
                        }
                    });
                    MessageBox.Show("Xuất Excel thành công!", "Thông báo");
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Lỗi khi xuất Excel: {ex.Message}\n\nĐảm bảo file không đang được mở.", "Lỗi");
                }
                finally
                {
                    SetLoading(false);
                }
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyKiemKhoView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyKiemKhoView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quản lý Kiểm Kho" FontFamily="Segoe UI" Loaded="Page_Loaded"
      Background="#FFF8E1">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Quản lý Kiểm Kho" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="2*"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Margin="10,0,15,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Text="Lịch sử Phiếu Kiểm Kho" Style="{StaticResource HeaderTextBlock}"/>
                        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,10">
                            <TextBlock Text="Từ:" VerticalAlignment="Center"/>
                            <DatePicker x:Name="dpTuNgay_Phieu" Width="120" Margin="5,0,0,0"/>
                            <TextBlock Text="Đến:" VerticalAlignment="Center" Margin="10,0,5,0"/>
                            <DatePicker x:Name="dpDenNgay_Phieu" Width="120" Margin="0,0,10,0"/>
                            <Button x:Name="btnLocPhieu" Content="Lọc" Style="{StaticResource PrimaryButton}" Padding="10,5" Click="BtnLocPhieu_Click" Width="50"/>
                        </StackPanel>
                        <DataGrid Grid.Row="2" x:Name="dgPhieuKiemKho" AutoGenerateColumns="False" IsReadOnly="True" 
                                  SelectionMode="Single" SelectionChanged="DgPhieuKiemKho_SelectionChanged" 
                                  BorderThickness="0" RowHeaderWidth="0">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ID" Binding="{Binding IdPhieuKiemKho}" Width="40"/>
                                <DataGridTextColumn Header="Ngày Kiểm" Binding="{Binding NgayKiem, StringFormat='dd/MM/yyyy'}" Width="100"/>
                                <DataGridTextColumn Header="Người Kiểm" Binding="{Binding TenNhanVienKiem}" Width="*"/>
                                <DataGridTextColumn Header="Trạng thái" Binding="{Binding TrangThai}" Width="100"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>

                <Border Grid.Column="1" Margin="0,0,10,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <Grid Grid.Row="0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" x:Name="lblChiTietTitle" Text="Chi tiết Phiếu Kiểm Kho" Style="{StaticResource HeaderTextBlock}"/>
                            <Button Grid.Column="1" x:Name="btnTaoPhieuMoi" Style="{StaticResource PrimaryButton}" Click="BtnTaoPhieuMoi_Click" Padding="10,8">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconNew}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="Tạo Phiếu Kiểm Mới" VerticalAlignment="Center" Margin="0,1,0,0"/>
                                </StackPanel>
                            </Button>
                        </Grid>

                        <Border Grid.Row="1" x:Name="panelNhapChiTiet" Background="{StaticResource LightCreamBrush}" 
                                CornerRadius="4" Padding="15" Margin="0,0,0,15"
                                IsEnabled="False">
                            <StackPanel>
                                <TextBlock x:Name="lblTenNL_ChiTiet" Text="Chọn một nguyên liệu từ lưới bên dưới..." FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}"/>
                                <Grid Margin="0,10,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0" Text="Tồn HT:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                    <TextBlock Grid.Column="1" x:Name="lblTonKhoHT_ChiTiet" Text="0" VerticalAlignment="Center" FontWeight="Bold"/>

                                    <TextBlock Grid.Column="2" Text="Tồn Thực Tế (*):" VerticalAlignment="Center" Margin="10,0,5,0"/>
                                    <TextBox Grid.Column="3" x:Name="txtTonKhoThucTe" Width="80" HorizontalAlignment="Left"/>
                                </Grid>
                                <Grid Margin="0,10,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="Lý do chênh lệch:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                    <TextBox Grid.Column="1" x:Name="txtLyDo"/>
                                    <Button Grid.Column="2" x:Name="btnCapNhatDong" Content="Cập nhật" Style="{StaticResource PrimaryButton}" Padding="10,5" Margin="10,0,0,0"
                                            Click="BtnCapNhatDong_Click"/>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,0,0,10">
                            <TextBlock Text="Tìm kiếm nguyên liệu:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="{StaticResource TextGrayBrush}"/>
                            <TextBox x:Name="txtSearchKiemKho" Width="300" TextChanged="TxtSearchKiemKho_TextChanged"/>
                        </StackPanel>

                        <DataGrid Grid.Row="3" x:Name="dgChiTietKiemKho" AutoGenerateColumns="False" Margin="0,0,0,10"
                                  IsReadOnly="True" CanUserAddRows="False" CanUserDeleteRows="False"
                                  SelectionChanged="DgChiTietKiemKho_SelectionChanged">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Tên Nguyên liệu" Binding="{Binding TenNguyenLieu}" Width="*" IsReadOnly="True"/>
                                <DataGridTextColumn Header="ĐVT" Binding="{Binding DonViTinh}" Width="80" IsReadOnly="True"/>
                                <DataGridTextColumn Header="Tồn (Hệ thống)" Binding="{Binding TonKhoHeThong, StringFormat=N2}" Width="110" IsReadOnly="True"/>
                                <DataGridTextColumn Header="Tồn (Thực tế)" Binding="{Binding TonKhoThucTe, StringFormat=N2}" Width="110" IsReadOnly="True"/>
                                <DataGridTextColumn Header="Chênh lệch" Binding="{Binding ChenhLech, StringFormat=N2}" Width="100" IsReadOnly="True"/>
                                <DataGridTextColumn Header="Lý do" Binding="{Binding LyDoChenhLech}" Width="*" IsReadOnly="True"/>
                            </DataGrid.Columns>
                        </DataGrid>

                        <StackPanel Grid.Row="4" Orientation="Horizontal" HorizontalAlignment="Right">
                            <TextBlock Text="Tổng chênh lệch (Giá trị):" VerticalAlignment="Center" Margin="0,0,10,0" FontWeight="SemiBold"/>
                            <TextBlock x:Name="lblTongChenhLech" Text="0 VND" VerticalAlignment="Center" FontSize="16" FontWeight="Bold" Foreground="{StaticResource ActionRedBrush}"/>
                            <Button x:Name="btnLuuPhieuKiem" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionGreenBrush}" Click="BtnLuuPhieuKiem_Click" Margin="20,0,0,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconSave}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="Lưu &amp; Cân Bằng Kho" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>

            <Button x:Name="btnQuayLai" Grid.Row="2" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" Margin="10,0,0,10"
                    Click="BtnQuayLai_Click">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="16" Height="16" Margin="0,0,5,0"/>
                    <TextBlock Text="Quay lại Tồn Kho" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Đang tải..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyKiemKhoView.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using System.Collections.ObjectModel;
using System.Globalization;
using AppCafebookApi.Services;

namespace AppCafebookApi.View.quanly.pages
{
    // (DTOs placeholder giữ nguyên - chúng nên ở trong /Model/ModelApp/KhoDto.cs)
    #region DTOs (Tạm thời định nghĩa ở đây)
    public class PhieuKiemKhoDto
    {
        public int IdPhieuKiemKho { get; set; }
        public DateTime NgayKiem { get; set; }
        public string TenNhanVienKiem { get; set; } = string.Empty;
        public string TrangThai { get; set; } = string.Empty;
    }

    public class ChiTietKiemKhoDto
    {
        public int IdNguyenLieu { get; set; }
        public string TenNguyenLieu { get; set; } = string.Empty;
        public string DonViTinh { get; set; } = string.Empty;
        public decimal TonKhoHeThong { get; set; }
        public decimal TonKhoThucTe { get; set; }
        public decimal ChenhLech => TonKhoThucTe - TonKhoHeThong;
        public string? LyDoChenhLech { get; set; }
        public decimal GiaTriChenhLech { get; set; }
    }

    public class PhieuKiemKhoCreateDto
    {
        public int IdNhanVien { get; set; }
        public DateTime NgayKiem { get; set; }
        public string? GhiChu { get; set; }
        public List<ChiTietKiemKhoDto> ChiTiet { get; set; } = new();
    }
    #endregion

    public partial class QuanLyKiemKhoView : Page
    {
        private static readonly HttpClient httpClient;

        private List<PhieuKiemKhoDto> _phieuKiemKhoList = new List<PhieuKiemKhoDto>();
        private ObservableCollection<ChiTietKiemKhoDto> _fullKiemKhoList = new ObservableCollection<ChiTietKiemKhoDto>();
        private ObservableCollection<ChiTietKiemKhoDto> _chiTietKiemKhoList = new ObservableCollection<ChiTietKiemKhoDto>();

        private PhieuKiemKhoDto? _selectedPhieu;
        private bool _isCreatingPhieu = false;

        static QuanLyKiemKhoView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyKiemKhoView()
        {
            InitializeComponent();
            dpTuNgay_Phieu.SelectedDate = DateTime.Today.AddDays(-30);
            dpDenNgay_Phieu.SelectedDate = DateTime.Today;
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadPhieuKiemKhoAsync();
            ResetForm();
        }

        private async Task LoadPhieuKiemKhoAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            DateTime? start = dpTuNgay_Phieu.SelectedDate;
            DateTime? end = dpDenNgay_Phieu.SelectedDate;

            try
            {
                string url = "api/app/kho/phieukiemkho";
                if (start.HasValue && end.HasValue)
                {
                    url += $"?startDate={start.Value:yyyy-MM-dd}&endDate={end.Value:yyyy-MM-dd}";
                }

                _phieuKiemKhoList = (await httpClient.GetFromJsonAsync<List<PhieuKiemKhoDto>>(url)) ?? new List<PhieuKiemKhoDto>();
                dgPhieuKiemKho.ItemsSource = _phieuKiemKhoList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải phiếu kiểm kho: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void ResetForm()
        {
            _selectedPhieu = null;
            _isCreatingPhieu = false;
            dgPhieuKiemKho.SelectedItem = null;

            lblChiTietTitle.Text = "Chi tiết Phiếu Kiểm Kho";
            lblTongChenhLech.Text = "0 VND";
            txtSearchKiemKho.Text = "";

            _chiTietKiemKhoList.Clear();
            _fullKiemKhoList.Clear();
            dgChiTietKiemKho.ItemsSource = null;
            dgChiTietKiemKho.IsReadOnly = true;
            btnLuuPhieuKiem.IsEnabled = false;

            panelNhapChiTiet.IsEnabled = false; // Tắt form nhập
            ResetChiTietForm();
        }

        // --- THÊM MỚI: Hàm reset form nhập liệu ---
        private void ResetChiTietForm()
        {
            lblTenNL_ChiTiet.Text = "Chọn một nguyên liệu từ lưới...";
            lblTonKhoHT_ChiTiet.Text = "0";
            txtTonKhoThucTe.Text = "0";
            txtLyDo.Text = "";
            panelNhapChiTiet.IsEnabled = false;
        }

        private async void BtnTaoPhieuMoi_Click(object sender, RoutedEventArgs e)
        {
            ResetForm();
            _isCreatingPhieu = true;
            lblChiTietTitle.Text = "Tạo Phiếu Kiểm Kho Mới";
            btnLuuPhieuKiem.IsEnabled = true;
            dgChiTietKiemKho.IsReadOnly = true; // Lưới luôn ReadOnly

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var currentStock = (await httpClient.GetFromJsonAsync<List<ChiTietKiemKhoDto>>("api/app/kho/phieukiemkho/taomoi")) ?? new List<ChiTietKiemKhoDto>();

                foreach (var item in currentStock)
                {
                    item.TonKhoThucTe = item.TonKhoHeThong;
                }

                _fullKiemKhoList = new ObservableCollection<ChiTietKiemKhoDto>(currentStock);
                dgChiTietKiemKho.ItemsSource = _fullKiemKhoList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải dữ liệu kho: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnLocPhieu_Click(object sender, RoutedEventArgs e)
        {
            await LoadPhieuKiemKhoAsync();
        }

        private async void DgPhieuKiemKho_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgPhieuKiemKho.SelectedItem is not PhieuKiemKhoDto selected)
            {
                ResetForm();
                return;
            }

            _selectedPhieu = selected;
            _isCreatingPhieu = false;
            btnLuuPhieuKiem.IsEnabled = false;
            dgChiTietKiemKho.IsReadOnly = true;
            txtSearchKiemKho.Text = "";
            ResetChiTietForm(); // Tắt form nhập

            try
            {
                var details = await httpClient.GetFromJsonAsync<List<ChiTietKiemKhoDto>>($"api/app/kho/phieukiemkho/{selected.IdPhieuKiemKho}");

                _fullKiemKhoList = new ObservableCollection<ChiTietKiemKhoDto>(details ?? new List<ChiTietKiemKhoDto>());
                dgChiTietKiemKho.ItemsSource = _fullKiemKhoList;

                lblChiTietTitle.Text = $"Chi tiết Phiếu {selected.IdPhieuKiemKho}";
                lblTongChenhLech.Text = _fullKiemKhoList.Sum(ct => ct.GiaTriChenhLech).ToString("N0") + " VND";
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải chi tiết phiếu: {ex.Message}", "Lỗi API");
            }
        }

        private void TxtSearchKiemKho_TextChanged(object sender, TextChangedEventArgs e)
        {
            string searchText = txtSearchKiemKho.Text.ToLower();

            if (string.IsNullOrWhiteSpace(searchText))
            {
                dgChiTietKiemKho.ItemsSource = _fullKiemKhoList;
            }
            else
            {
                var filteredList = _fullKiemKhoList
                    .Where(nl => nl.TenNguyenLieu.ToLower().Contains(searchText))
                    .ToList();

                _chiTietKiemKhoList = new ObservableCollection<ChiTietKiemKhoDto>(filteredList);
                dgChiTietKiemKho.ItemsSource = _chiTietKiemKhoList;
            }
        }

        // =================================================================
        // === SỬA LỖI HÀM NÀY (System.InvalidOperationException) ===
        // =================================================================
        private void DgChiTietKiemKho_CellEditEnding(object sender, DataGridCellEditEndingEventArgs e)
        {
            // Tự động tính Chênh lệch

            // XÓA: Task.Delay(100).ContinueWith(...

            // THAY BẰNG:
            // Xếp hàng tác vụ Refresh() vào Dispatcher với mức ưu tiên thấp (ContextIdle).
            // Điều này đảm bảo giao dịch (edit transaction) kết thúc TRƯỚC KHI Refresh() được gọi.
            Dispatcher.BeginInvoke(new Action(() =>
            {
                dgChiTietKiemKho.Items.Refresh();
            }), System.Windows.Threading.DispatcherPriority.ContextIdle);
        }
        // =================================================================
        // === KẾT THÚC SỬA LỖI ===
        // =================================================================
        // --- XÓA HÀM DgChiTietKiemKho_CellEditEnding ---
        // private void DgChiTietKiemKho_CellEditEnding(...) { ... }

        // --- THÊM MỚI: Xử lý chọn dòng chi tiết ---
        private void DgChiTietKiemKho_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgChiTietKiemKho.SelectedItem is ChiTietKiemKhoDto selected && _isCreatingPhieu)
            {
                panelNhapChiTiet.IsEnabled = true;
                lblTenNL_ChiTiet.Text = selected.TenNguyenLieu;
                lblTonKhoHT_ChiTiet.Text = selected.TonKhoHeThong.ToString("N2");
                txtTonKhoThucTe.Text = selected.TonKhoThucTe.ToString("N2");
                txtLyDo.Text = selected.LyDoChenhLech;
                txtTonKhoThucTe.Focus();
            }
            else
            {
                ResetChiTietForm();
            }
        }

        // --- THÊM MỚI: Xử lý nút "Cập nhật dòng" ---
        private void BtnCapNhatDong_Click(object sender, RoutedEventArgs e)
        {
            if (dgChiTietKiemKho.SelectedItem is not ChiTietKiemKhoDto selectedItem)
            {
                MessageBox.Show("Vui lòng chọn một dòng trong lưới để cập nhật.", "Lỗi");
                return;
            }

            // Tìm item tương ứng trong danh sách GỐC
            var itemInFullList = _fullKiemKhoList.FirstOrDefault(i => i.IdNguyenLieu == selectedItem.IdNguyenLieu);
            if (itemInFullList == null) return;

            // Lấy dữ liệu từ form
            if (!decimal.TryParse(txtTonKhoThucTe.Text, NumberStyles.Any, CultureInfo.InvariantCulture, out var thucTe))
            {
                MessageBox.Show("Số lượng thực tế không hợp lệ.", "Lỗi");
                return;
            }

            // Cập nhật DỮ LIỆU GỐC (trong _fullKiemKhoList)
            itemInFullList.TonKhoThucTe = thucTe;
            itemInFullList.LyDoChenhLech = txtLyDo.Text;

            // Refresh lại DataGrid (an toàn, vì không ở trong CellEditEnding)
            dgChiTietKiemKho.Items.Refresh();

            // Reset form nhập
            ResetChiTietForm();
            dgChiTietKiemKho.SelectedItem = null;
        }

        private async void BtnLuuPhieuKiem_Click(object sender, RoutedEventArgs e)
        {
            if (!_isCreatingPhieu || _fullKiemKhoList.Count == 0)
            {
                MessageBox.Show("Vui lòng 'Tạo Phiếu Mới' trước khi lưu.", "Lỗi");
                return;
            }
            if (AuthService.CurrentUser == null)
            {
                MessageBox.Show("Lỗi phiên đăng nhập. Vui lòng đăng nhập lại.", "Lỗi");
                return;
            }

            var dto = new PhieuKiemKhoCreateDto
            {
                IdNhanVien = AuthService.CurrentUser.IdNhanVien,
                NgayKiem = DateTime.Now,
                ChiTiet = _fullKiemKhoList.ToList() // Luôn lưu list gốc
            };

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/kho/phieukiemkho", dto);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Lưu phiếu kiểm kho và cân bằng kho thành công!", "Thông báo");
                    await LoadPhieuKiemKhoAsync();
                    ResetForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService?.CanGoBack == true)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyLichLamViecView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyLichLamViecView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="750" d:DesignWidth="1200"
      Title="Quản lý Lịch Làm Việc &amp; Ca Làm"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionOrangeBrush" Color="#FFA726"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>
        
        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>
        <Geometry x:Key="IconAssign">M19,3H14V5H19V18L14,12V21H19C20.1,21 21,20.1 21,19V5C21,3.9 20.1,3 19,3M5,3C3.9,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H10V12L5,18V5H10V3H5Z</Geometry>
        <Geometry x:Key="IconLeave">M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.89 20.1,3 19,3M19,19H5V10H19V19M10,14V12H7V14H10M14,14V12H11V14H14M18,14V12H15V14H18Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="GroupItem">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="GroupItem">
                        <StackPanel>
                            <TextBlock Text="{Binding Name}" 
                                       FontSize="16" FontWeight="Bold" 
                                       Foreground="{StaticResource PrimaryBrownBrush}" 
                                       Margin="5,15,0,5" />
                            <ItemsPresenter />
                        </StackPanel>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Quản lý Lịch Làm Việc &amp; Ca Làm" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="320"/>
                    <ColumnDefinition Width="320"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Margin="10,0,5,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Text="Ca Làm Việc Mẫu" Style="{StaticResource HeaderTextBlock}"/>

                        <StackPanel Grid.Row="1">
                            <TextBlock Text="Tên Ca:" Margin="0,0,0,5" FontSize="12" FontWeight="SemiBold"/>
                            <TextBox x:Name="txtTenCa" Margin="0,0,0,10"/>

                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0" Margin="0,0,5,0">
                                    <TextBlock Text="Giờ Bắt Đầu (HH:mm):" Margin="0,0,0,5" FontSize="12" FontWeight="SemiBold"/>
                                    <TextBox x:Name="txtGioBatDau" Margin="0,0,0,10"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1" Margin="5,0,0,0">
                                    <TextBlock Text="Giờ Kết Thúc (HH:mm):" Margin="0,0,0,5" FontSize="12" FontWeight="SemiBold"/>
                                    <TextBox x:Name="txtGioKetThuc" Margin="0,0,0,10"/>
                                </StackPanel>
                            </Grid>

                            <Grid Height="40" Margin="0,5,0,15">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Button x:Name="btnLamMoiCa" Grid.Column="0" ToolTip="Làm mới Form" Click="BtnLamMoiCa_Click" Background="Transparent" BorderThickness="0">
                                    <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="22" Height="22"/>
                                </Button>
                                <Button x:Name="btnThemCa" Grid.Column="1" Style="{StaticResource PrimaryButton}" Background="{StaticResource SuccessBrush}" Click="BtnThemCa_Click" Margin="10,0,5,0">
                                    <StackPanel Orientation="Horizontal">
                                        <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                            <Path Data="{StaticResource IconAdd}" Fill="White"/>
                                        </Viewbox>
                                        <TextBlock Text="Thêm" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                                <Button x:Name="btnLuuCa" Grid.Column="2" Style="{StaticResource PrimaryButton}" Click="BtnLuuCa_Click" Margin="5,0">
                                    <StackPanel Orientation="Horizontal">
                                        <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                            <Path Data="{StaticResource IconSave}" Fill="White"/>
                                        </Viewbox>
                                        <TextBlock Text="Lưu" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                                <Button x:Name="btnXoaCa" Grid.Column="3" Style="{StaticResource PrimaryButton}" Background="{StaticResource ErrorBrush}" Click="BtnXoaCa_Click" Margin="5,0,0,0">
                                    <StackPanel Orientation="Horizontal">
                                        <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                            <Path Data="{StaticResource IconDelete}" Fill="White"/>
                                        </Viewbox>
                                        <TextBlock Text="Xóa" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                            </Grid>
                        </StackPanel>

                        <DataGrid Grid.Row="2" x:Name="dgCaMau" AutoGenerateColumns="False" IsReadOnly="True" 
                                  SelectionMode="Single" SelectionChanged="DgCaMau_SelectionChanged"
                                  BorderThickness="0" RowHeaderWidth="0">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Tên Ca" Binding="{Binding TenCa}" Width="*"/>
                                <DataGridTextColumn Header="Bắt đầu" Binding="{Binding GioBatDau, StringFormat=hh\\:mm}" Width="Auto"/>
                                <DataGridTextColumn Header="Kết thúc" Binding="{Binding GioKetThuc, StringFormat=hh\\:mm}" Width="Auto"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>

                <Border Grid.Column="1" Margin="5,0,5,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Text="Gán Lịch Mới" Style="{StaticResource HeaderTextBlock}"/>

                        <StackPanel Grid.Row="1">
                            <TextBlock Text="Gán cho ngày:" Margin="0,0,0,5" FontSize="12" FontWeight="SemiBold"/>
                            <DatePicker x:Name="dpNgayGanLich" Margin="0,0,0,10"/>

                            <TextBlock Text="Chọn ca mẫu:" Margin="0,0,0,5" FontSize="12" FontWeight="SemiBold"/>
                            <ComboBox x:Name="cmbCaDeGan" DisplayMemberPath="TenCa" SelectedValuePath="IdCa" Margin="0,0,0,15"/>
                        </StackPanel>

                        <StackPanel Grid.Row="2">
                            <TextBlock Text="Chọn nhân viên:" Margin="0,0,0,5" FontSize="12" FontWeight="SemiBold"/>
                            <Border BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="1" CornerRadius="4">
                                <ListView x:Name="lbNhanVienDeGan" MaxHeight="300" BorderThickness="0">
                                    <ListView.ItemTemplate>
                                        <DataTemplate>
                                            <CheckBox Content="{Binding HoTen}" 
                                                      IsChecked="{Binding IsChecked, Mode=TwoWay}"
                                                      Margin="5"/>
                                        </DataTemplate>
                                    </ListView.ItemTemplate>
                                </ListView>
                            </Border>
                        </StackPanel>

                        <Button Grid.Row="3" x:Name="btnGanLich" Style="{StaticResource PrimaryButton}" 
                                Background="{StaticResource ActionBlueBrush}" 
                                Click="BtnGanLich_Click" Margin="0,20,0,0" Padding="15">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconAssign}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="Gán Lịch Làm Việc" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </Grid>
                </Border>

                <Border Grid.Column="2" Margin="5,0,10,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Text="Xem Lịch Làm Việc" Style="{StaticResource HeaderTextBlock}"/>

                        <Calendar Grid.Row="1" x:Name="calendarView" 
                                  SelectedDatesChanged="CalendarView_SelectedDatesChanged"
                                  Margin="0,0,0,15"/>

                        <ListView Grid.Row="2" x:Name="lbLichLamViecHomNay" BorderThickness="0" Background="Transparent">
                            <ListView.GroupStyle>
                                <GroupStyle HidesIfEmpty="True"/>
                            </ListView.GroupStyle>

                            <ListView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Width="350">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                            <TextBlock Text="{Binding HoTenNhanVien}" FontWeight="SemiBold"/>

                                            <TextBlock Opacity="0.8">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Text" Value="{Binding LyDoNghi}"/>
                                                        <Setter Property="Foreground" Value="{StaticResource ActionOrangeBrush}"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding LoaiLich}" Value="CaLam">
                                                                <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
                                                                <Setter Property="Text">
                                                                    <Setter.Value>
                                                                        <MultiBinding StringFormat="{}{0:hh\:mm} - {1:hh\:mm}">
                                                                            <Binding Path="GioBatDau"/>
                                                                            <Binding Path="GioKetThuc"/>
                                                                        </MultiBinding>
                                                                    </Setter.Value>
                                                                </Setter>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                        </StackPanel>

                                        <Button x:Name="btnXoaLich" Grid.Column="1" ToolTip="Xóa lịch này"
                                            Background="Transparent"
                                            Click="BtnXoaLich_Click"
                                            Tag="{Binding IdLich}">
                                            <Path Data="{StaticResource IconDelete}" Fill="{StaticResource ErrorBrush}" Width="23" Height="23"/>

                                            <Button.Style>
                                                <Style TargetType="Button" BasedOn="{StaticResource PrimaryButton}">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding LoaiLich}" Value="NghiPhep">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Button.Style>
                                        </Button>
                                    </Grid>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </Grid>
                </Border>
            </Grid>

            <Button x:Name="btnQuayLai" Grid.Row="2" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" Margin="10,0,0,10"
                    Click="BtnQuayLai_Click">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                    <TextBlock Text="Quay lại" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
            <Button Grid.Row="3" x:Name="btnGoToDonXinNghi" Style="{StaticResource PrimaryButton}" 
                                Background="{StaticResource ActionOrangeBrush}" 
                                Click="BtnGoToDonXinNghi_Click" Margin="0,15,0,0" Width="200" Padding="10" HorizontalAlignment="Right">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconLeave}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                    <TextBlock Text="Quản lý Đơn Xin Nghỉ" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Đang xử lý..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyLichLamViecView.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Threading.Tasks;
using System.ComponentModel; // Cần cho INotifyPropertyChanged
using System.Globalization; // Cần cho TimeSpan.ParseExact
using System.Net;

namespace AppCafebookApi.View.quanly.pages
{
    /// <summary>
    /// View-Model nội bộ cho CheckBox Nhân viên
    /// </summary>
    public class NhanVienCheckItem : INotifyPropertyChanged
    {
        public int IdNhanVien { get; set; }
        public string HoTen { get; set; } = string.Empty;

        private bool _isChecked;
        public bool IsChecked
        {
            get => _isChecked;
            set
            {
                if (_isChecked != value)
                {
                    _isChecked = value;
                    PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(nameof(IsChecked)));
                }
            }
        }
        public event PropertyChangedEventHandler? PropertyChanged;
    }

    public partial class QuanLyLichLamViecView : Page
    {
        private static readonly HttpClient httpClient;
        private List<CaLamViecDto> _allCaMauList = new List<CaLamViecDto>();
        private List<NhanVienCheckItem> _allNhanVienList = new List<NhanVienCheckItem>();
        private CaLamViecDto? _selectedCaMau = null;

        static QuanLyLichLamViecView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyLichLamViecView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            await LoadCaMauAsync();
            await LoadNhanVienAsync();
            ResetCaMauForm();

            calendarView.SelectedDate = DateTime.Today; // Tự động chọn hôm nay
            await LoadLichLamViecByDateAsync(DateTime.Today);

            LoadingOverlay.Visibility = Visibility.Collapsed;
        }

        #region === QUẢN LÝ CA MẪU (CỘT 1) ===

        private async Task LoadCaMauAsync()
        {
            try
            {
                _allCaMauList = (await httpClient.GetFromJsonAsync<List<CaLamViecDto>>("api/app/calamviec/all")) ?? new List<CaLamViecDto>();
                dgCaMau.ItemsSource = _allCaMauList;
                cmbCaDeGan.ItemsSource = _allCaMauList; // Cập nhật ComboBox
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải danh sách ca mẫu: {ex.Message}", "Lỗi API");
            }
        }

        private void ResetCaMauForm()
        {
            _selectedCaMau = null;
            dgCaMau.SelectedItem = null;
            txtTenCa.Text = "";
            txtGioBatDau.Text = "08:00";
            txtGioKetThuc.Text = "16:00";
            btnThemCa.IsEnabled = true;
            btnLuuCa.IsEnabled = false;
            btnXoaCa.IsEnabled = false;
        }

        private void DgCaMau_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgCaMau.SelectedItem is CaLamViecDto selected)
            {
                _selectedCaMau = selected;
                txtTenCa.Text = selected.TenCa;
                txtGioBatDau.Text = selected.GioBatDau.ToString(@"hh\:mm");
                txtGioKetThuc.Text = selected.GioKetThuc.ToString(@"hh\:mm");
                btnThemCa.IsEnabled = false;
                btnLuuCa.IsEnabled = true;
                btnXoaCa.IsEnabled = true;
            }
        }

        private void BtnLamMoiCa_Click(object sender, RoutedEventArgs e)
        {
            ResetCaMauForm();
        }

        private async void BtnThemCa_Click(object sender, RoutedEventArgs e)
        {
            await SaveCaMauAsync(isCreating: true);
        }

        private async void BtnLuuCa_Click(object sender, RoutedEventArgs e)
        {
            await SaveCaMauAsync(isCreating: false);
        }

        private async Task SaveCaMauAsync(bool isCreating)
        {
            if (string.IsNullOrWhiteSpace(txtTenCa.Text))
            {
                MessageBox.Show("Tên ca là bắt buộc.", "Lỗi"); return;
            }
            if (!TimeSpan.TryParseExact(txtGioBatDau.Text, @"hh\:mm", CultureInfo.InvariantCulture, out var gioBatDau) ||
                !TimeSpan.TryParseExact(txtGioKetThuc.Text, @"hh\:mm", CultureInfo.InvariantCulture, out var gioKetThuc))
            {
                MessageBox.Show("Giờ bắt đầu hoặc kết thúc không hợp lệ. Vui lòng dùng định dạng HH:mm (ví dụ: 08:00 hoặc 14:30).", "Lỗi định dạng");
                return;
            }

            var dto = new CaLamViecDto
            {
                TenCa = txtTenCa.Text,
                GioBatDau = gioBatDau,
                GioKetThuc = gioKetThuc
            };

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                HttpResponseMessage response;
                if (isCreating)
                {
                    response = await httpClient.PostAsJsonAsync("api/app/calamviec", dto);
                }
                else
                {
                    // === SỬA LỖI CS8602 ===
                    // Thêm toán tử '!' (null-forgiving) vì logic UI đã đảm bảo _selectedCaMau không null khi lưu.
                    dto.IdCa = _selectedCaMau!.IdCa;
                    response = await httpClient.PutAsJsonAsync($"api/app/calamviec/{dto.IdCa}", dto);
                }

                if (response.IsSuccessStatusCode)
                {
                    await LoadCaMauAsync();
                    ResetCaMauForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXoaCa_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedCaMau == null) return;

            var result = MessageBox.Show($"Bạn có chắc muốn xóa ca '{_selectedCaMau.TenCa}'?", "Xác nhận", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/calamviec/{_selectedCaMau.IdCa}");
                if (response.IsSuccessStatusCode)
                {
                    await LoadCaMauAsync();
                    ResetCaMauForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Không thể xóa");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion

        #region === GÁN LỊCH (CỘT 2) ===

        private async Task LoadNhanVienAsync()
        {
            try
            {
                var dtos = (await httpClient.GetFromJsonAsync<List<NhanVienLookupDto>>("api/app/lichlamviec/all-nhanvien")) ?? new List<NhanVienLookupDto>();
                _allNhanVienList = dtos.Select(d => new NhanVienCheckItem
                {
                    IdNhanVien = d.IdNhanVien,
                    HoTen = d.HoTen,
                    IsChecked = false
                }).ToList();
                lbNhanVienDeGan.ItemsSource = _allNhanVienList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải danh sách nhân viên: {ex.Message}", "Lỗi API");
            }
        }

        private async void BtnGanLich_Click(object sender, RoutedEventArgs e)
        {
            if (dpNgayGanLich.SelectedDate == null)
            {
                MessageBox.Show("Vui lòng chọn ngày để gán lịch.", "Lỗi"); return;
            }
            if (cmbCaDeGan.SelectedValue == null)
            {
                MessageBox.Show("Vui lòng chọn ca làm việc mẫu.", "Lỗi"); return;
            }
            var selectedNhanVienIds = _allNhanVienList
                .Where(nv => nv.IsChecked)
                .Select(nv => nv.IdNhanVien)
                .ToList();
            if (!selectedNhanVienIds.Any())
            {
                MessageBox.Show("Vui lòng chọn ít nhất một nhân viên.", "Lỗi"); return;
            }

            var dto = new LichLamViecCreateDto
            {
                NgayGanLich = dpNgayGanLich.SelectedDate.Value,
                IdCa = (int)cmbCaDeGan.SelectedValue,
                DanhSachIdNhanVien = selectedNhanVienIds
            };

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/lichlamviec/assign", dto);

                // === SỬA LỖI CS1977: Dùng DTO cụ thể ===
                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<LichLamViecAssignResponseDto>();
                    if (result == null) throw new Exception("Không thể đọc phản hồi API.");

                    string message = result.Message;
                    var failures = result.Failures;

                    if (failures.Any())
                    {
                        message += "\n\nCác lỗi xảy ra:\n- " + string.Join("\n- ", failures);
                        MessageBox.Show(message, "Cảnh báo", MessageBoxButton.OK, MessageBoxImage.Warning);
                    }
                    else
                    {
                        MessageBox.Show(message, "Thành công", MessageBoxButton.OK, MessageBoxImage.Information);
                    }
                }
                else
                {
                    MessageBox.Show($"Lỗi API: {await response.Content.ReadAsStringAsync()}", "Lỗi");
                }
                // === KẾT THÚC SỬA LỖI ===


                // Làm mới lịch nếu ngày gán = ngày đang xem
                if (calendarView.SelectedDate == dto.NgayGanLich.Date)
                {
                    await LoadLichLamViecByDateAsync(dto.NgayGanLich.Date);
                }
                // Bỏ check tất cả nhân viên
                foreach (var nv in _allNhanVienList) { nv.IsChecked = false; }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion

        #region === XEM LỊCH (CỘT 3) ===

        private async void CalendarView_SelectedDatesChanged(object sender, SelectionChangedEventArgs e)
        {
            if (calendarView.SelectedDate.HasValue)
            {
                await LoadLichLamViecByDateAsync(calendarView.SelectedDate.Value);
            }
        }

        private async Task LoadLichLamViecByDateAsync(DateTime date)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var data = (await httpClient.GetFromJsonAsync<List<LichLamViecDisplayDto>>($"api/app/lichlamviec/by-date?date={date:yyyy-MM-dd}")) ?? new List<LichLamViecDisplayDto>();

                // Nhóm theo Tên Ca (Ca Sáng, Ca Chiều, Nghỉ Phép)
                var cvs = new CollectionViewSource { Source = data };
                cvs.GroupDescriptions.Add(new PropertyGroupDescription("TenCa", new TenCaToNhomConverter()));

                lbLichLamViecHomNay.ItemsSource = cvs.View;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải lịch làm việc: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXoaLich_Click(object sender, RoutedEventArgs e)
        {
            var button = sender as Button;
            if (button?.Tag == null) return;

            int idLichLamViec = (int)button.Tag;

            var result = MessageBox.Show("Bạn có chắc muốn xóa lịch làm việc này?", "Xác nhận", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/lichlamviec/{idLichLamViec}");
                if (response.IsSuccessStatusCode)
                {
                    // Tải lại lịch
                    if (calendarView.SelectedDate.HasValue)
                    {
                        await LoadLichLamViecByDateAsync(calendarView.SelectedDate.Value);
                    }
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Không thể xóa");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            // Quay lại trang QL Nhân Viên
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
            else
            {
                // Fallback nếu không CanGoBack
                this.NavigationService?.Navigate(new QuanLyNhanVienView());
            }
        }

        private void BtnGoToDonXinNghi_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new QuanLyDonXinNghiView());
        }
    }

    /// <summary>
    /// Converter để nhóm "Nghỉ Phép" vào một nhóm riêng
    /// </summary>
    public class TenCaToNhomConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value is string tenCa)
            {
                return string.IsNullOrEmpty(tenCa) ? "Nghỉ Phép / Khác" : tenCa;
            }
            return "Khác";
        }
        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyLuongView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyLuongView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quản lý Hệ Thống Lương"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionOrangeBrush" Color="#FFA726"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="PrimaryBrown" Color="#6F4E37"/>
        <SolidColorBrush x:Key="AccentOrange" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteText" Color="#FFFFFF"/>
        <Geometry x:Key="IconPayment">M17,15V14H19V11H21V14H23V15H21V18H19V15H17M1,3H21C22.1,3 23,3.9 23,5V9H1V5C1,3.9 1.9,3 1,3M3,7H7V11H3V7M3,13H7V17H3V13M9,7H21V11H9V7M9,13H15V17H9V13Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconCalculate">M19,3H5C3.89,3 3,3.89 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.89 20.1,3 19,3M19,19H5V5H19V19M16.25,7.72L15.18,6.65L12,9.83L8.82,6.65L7.75,7.72L10.93,10.9L7.75,14.08L8.82,15.15L12,11.97L15.18,15.15L16.25,14.08L13.07,10.9L16.25,7.72Z</Geometry>
        <Geometry x:Key="IconFinalize">M12,16L19.36,10.27L21,12L12,18L3,12L4.63,10.27L12,16M12,3L3,9L12,15L21,9L12,3Z</Geometry>
        <Geometry x:Key="IconReport">M10,17L6,21H18L14,17H10M10,10H14V15H10V10M4,3H20C21.1,3 22,3.9 22,5V17C22,18.1 21.1,19 20,19H4C2.9,19 2,18.1 2,17V5C2,3.9 2.9,3 4,3Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrown}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteText}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Height" Value="42"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                CornerRadius="21"
                                Background="{TemplateBinding Background}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="2" Color="#6F4E37" Opacity="0.3" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource AccentOrange}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>

        <Style TargetType="TabControl">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
        <Style TargetType="TabItem">
            <Setter Property="Background" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
            <Setter Property="Padding" Value="15,8"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border x:Name="border" BorderThickness="0,0,0,3" BorderBrush="Transparent" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" Margin="0,0,5,0">
                            <ContentPresenter ContentSource="Header" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="Background" Value="White"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Quản lý Lương &amp; Chấm Công" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <TabControl Grid.Row="1" Margin="10,0,10,10">

                <TabItem Header="Bảng Chấm Công (Hàng ngày)">
                    <Grid Background="White" Margin="0,5,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="300"/>
                        </Grid.ColumnDefinitions>

                        <Grid Grid.Column="0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10">
                                <TextBlock Text="Chọn ngày:" VerticalAlignment="Center" Margin="0,0,5,0" FontWeight="SemiBold"/>
                                <DatePicker x:Name="dpNgayChamCong" Width="150" SelectedDateChanged="DpNgayChamCong_SelectedDateChanged"/>
                            </StackPanel>

                            <DataGrid Grid.Row="1" x:Name="dgChamCong" AutoGenerateColumns="False" IsReadOnly="True" 
                                      SelectionMode="Single" SelectionChanged="DgChamCong_SelectionChanged"
                                      BorderThickness="0" RowHeaderWidth="0" Margin="10,0,10,10">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Nhân viên" Binding="{Binding HoTenNhanVien}" Width="*"/>
                                    <DataGridTextColumn Header="Ca" Binding="{Binding TenCa}" Width="Auto"/>
                                    <DataGridTextColumn Header="Giờ Ca" Binding="{Binding GioCaBatDau, StringFormat=hh\\:mm}" Width="Auto"/>
                                    <DataGridTextColumn Header="Giờ Vào" Binding="{Binding GioVao, StringFormat=HH:mm:ss}" Width="Auto"/>
                                    <DataGridTextColumn Header="Giờ Ra" Binding="{Binding GioRa, StringFormat=HH:mm:ss}" Width="Auto"/>
                                    <DataGridTextColumn Header="Giờ Làm" Binding="{Binding SoGioLam, StringFormat=F2}" Width="Auto"/>
                                    <DataGridTextColumn Header="Trạng thái" Binding="{Binding TrangThai}" Width="Auto"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>

                        <Border Grid.Column="1" Background="{StaticResource SubtleGrayBrush}" Padding="15">
                            <StackPanel x:Name="formChamCong" IsEnabled="False">
                                <TextBlock x:Name="lblChamCongTitle" Text="Điều chỉnh Chấm Công" FontWeight="Bold" FontSize="16" Margin="0,0,0,10"/>
                                <TextBlock Text="Nhân viên:" Margin="0,0,0,5" FontSize="12"/>
                                <TextBlock x:Name="lblChamCongNhanVien" Text="[Tên NV]" FontWeight="SemiBold" Margin="0,0,0,10"/>

                                <TextBlock Text="Giờ Vào (HH:mm):" Margin="0,0,0,5" FontSize="12"/>
                                <TextBox x:Name="txtGioVaoMoi" Margin="0,0,0,10"/>

                                <TextBlock Text="Giờ Ra (HH:mm):" Margin="0,0,0,5" FontSize="12"/>
                                <TextBox x:Name="txtGioRaMoi" Margin="0,0,0,15"/>

                                <Button x:Name="btnLuuChamCong" Style="{StaticResource PrimaryButton}" Click="BtnLuuChamCong_Click">
                                    <StackPanel Orientation="Horizontal">
                                        <Path Data="{StaticResource IconSave}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                        <TextBlock Text="Lưu Điều Chỉnh" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                        </Border>
                    </Grid>
                </TabItem>

                <TabItem Header="Thưởng/Phạt Thủ Công">
                    <Grid Background="White" Margin="0,5,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="400"/>
                        </Grid.ColumnDefinitions>

                        <Grid Grid.Column="0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10">
                                <TextBlock Text="Chọn nhân viên:" VerticalAlignment="Center" Margin="0,0,5,0" FontWeight="SemiBold"/>
                                <ComboBox x:Name="cmbNhanVienThuongPhat" DisplayMemberPath="HoTen" SelectedValuePath="IdNhanVien" 
                                          Width="250" SelectionChanged="CmbNhanVienThuongPhat_SelectionChanged"/>
                            </StackPanel>

                            <DataGrid Grid.Row="1" x:Name="dgThuongPhat" AutoGenerateColumns="False" IsReadOnly="True" 
                                      BorderThickness="0" RowHeaderWidth="0" Margin="10,0,10,10">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Ngày" Binding="{Binding NgayTao, StringFormat='dd/MM/yyyy'}" Width="Auto"/>
                                    <DataGridTextColumn Header="Số Tiền" Binding="{Binding SoTien, StringFormat=N0}" Width="100"/>
                                    <DataGridTextColumn Header="Lý do" Binding="{Binding LyDo}" Width="*"/>
                                    <DataGridTextColumn Header="Người tạo" Binding="{Binding TenNguoiTao}" Width="120"/>
                                    <DataGridTemplateColumn Header="Xóa" Width="50">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Button x:Name="btnXoaThuongPhat" ToolTip="Xóa" Click="BtnXoaThuongPhat_Click" 
                                                        Style="{StaticResource PrimaryButton}" Background="Transparent">
                                                    <Path Data="{StaticResource IconDelete}" Fill="{StaticResource ErrorBrush}" Width="23" Height="23"/>
                                                </Button>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>

                        <Border Grid.Column="1" Background="{StaticResource SubtleGrayBrush}" Padding="15">
                            <StackPanel x:Name="formThuongPhat" IsEnabled="False">
                                <TextBlock Text="Thêm Thưởng/Phạt" FontWeight="Bold" FontSize="16" Margin="0,0,0,10"/>

                                <TextBlock Text="Số Tiền (VND):" Margin="0,0,0,5" FontSize="12"/>
                                <TextBox x:Name="txtSoTien" Margin="0,0,0,10" ToolTip="Nhập số âm (ví dụ: -50000) nếu là Phạt"/>

                                <TextBlock Text="Lý do:" Margin="0,0,0,5" FontSize="12"/>
                                <TextBox x:Name="txtLyDoThuongPhat" Margin="0,0,0,15" Height="80" TextWrapping="Wrap" AcceptsReturn="True"/>

                                <Button x:Name="btnThemThuongPhat" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionBlueBrush}" 
                                        Click="BtnThemThuongPhat_Click">
                                    <StackPanel Orientation="Horizontal">
                                        <Path Data="{StaticResource IconAdd}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                        <TextBlock Text="Thêm Khoản" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                        </Border>
                    </Grid>
                </TabItem>

                <TabItem Header="Tính &amp; Chốt Lương">
                    <Grid Background="White" Margin="0,5,0,0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <Border Grid.Row="0" Margin="10" Padding="15" Background="{StaticResource SubtleGrayBrush}" CornerRadius="6">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- Từ ngày - Đến ngày -->
                                <StackPanel Orientation="Horizontal" Grid.Column="0" Grid.ColumnSpan="4" VerticalAlignment="Center">
                                    <TextBlock Text="Từ Ngày:" VerticalAlignment="Center" Margin="0,0,5,0" FontWeight="SemiBold"/>
                                    <DatePicker x:Name="dpNgayBatDauLuong" Width="130"/>

                                    <TextBlock Text="Đến Ngày:" VerticalAlignment="Center" Margin="15,0,5,0" FontWeight="SemiBold"/>
                                    <DatePicker x:Name="dpNgayKetThucLuong" Width="130"/>
                                </StackPanel>

                                <!-- Các nút chức năng -->
                                <StackPanel Grid.Column="4" Orientation="Horizontal" HorizontalAlignment="Right" >
                                    <Button x:Name="btnTinhLuong"
                                            Style="{StaticResource PrimaryButton}" 
                                            Background="{StaticResource ActionOrangeBrush}" 
                                            Click="BtnTinhLuong_Click"
                                            Width="160" Height="36">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconCalculate}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                            <TextBlock Text="Tính Lương (Tạm)" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>

                                    <Button x:Name="btnChotLuong"
                                            Style="{StaticResource PrimaryButton}" 
                                            Background="{StaticResource SuccessBrush}" 
                                            Click="BtnChotLuong_Click"
                                            Width="120" Height="36"
                                            IsEnabled="False">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconFinalize}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                            <TextBlock Text="Chốt Lương" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>

                                    <Button x:Name="btnGoToPhatLuong"
                                            Style="{StaticResource PrimaryButton}" 
                                            Background="{StaticResource PrimaryBrownBrush}" 
                                            Click="BtnGoToPhatLuong_Click"
                                            Width="160" Height="36">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconPayment}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                            <TextBlock Text="Phát Lương" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>

                                    <Button x:Name="btnGoToBaoCao"
                                            Style="{StaticResource PrimaryButton}" 
                                            Background="{StaticResource ActionBlueBrush}" 
                                            Click="BtnGoToBaoCao_Click"
                                            Width="130" Height="36">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconReport}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                            <TextBlock Text="Báo Cáo" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                            </Grid>
                        </Border>


                        <DataGrid Grid.Row="1" x:Name="dgBangKeLuong" AutoGenerateColumns="False" IsReadOnly="True" 
                                  BorderThickness="0" RowHeaderWidth="0" Margin="10,0,10,10">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Nhân viên" Binding="{Binding HoTenNhanVien}" Width="*"/>
                                <DataGridTextColumn Header="Lương/Giờ" Binding="{Binding LuongCoBan, StringFormat=N0}" Width="Auto"/>
                                <DataGridTextColumn Header="Giờ Làm" Binding="{Binding TongGioLam, StringFormat=F2}" Width="Auto"/>
                                <DataGridTextColumn Header="Lương Giờ" Binding="{Binding TienLuongGio, StringFormat=N0}" Width="Auto"/>
                                <DataGridTextColumn Header="Tổng Thưởng" Binding="{Binding TongThuong, StringFormat=N0}" Width="Auto"/>
                                <DataGridTextColumn Header="Tổng Phạt" Binding="{Binding TongPhat, StringFormat=N0}" Width="Auto"/>
                                <DataGridTextColumn Header="THỰC LÃNH" Binding="{Binding ThucLanh, StringFormat=N0}" Width="120" FontWeight="Bold"/>
                                <DataGridTextColumn Header="Chi tiết" Binding="{Binding ChiTiet}" Width="2*"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </TabItem>
            </TabControl>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Đang xử lý..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyLuongView.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Threading.Tasks;
using System.Net;
using AppCafebookApi.Services; // Cần cho AuthService
using System.Globalization;
using System.Text.Json; // <-- THÊM VÀO ĐỂ SỬA LỖI CS8602

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyLuongView : Page
    {
        private static readonly HttpClient httpClient;
        private List<NhanVienLookupDto> _allNhanVienList = new List<NhanVienLookupDto>();
        private List<PhieuThuongPhatDto> _currentThuongPhatList = new List<PhieuThuongPhatDto>();
        private List<LuongBangKeDto> _currentBangKeList = new List<LuongBangKeDto>();
        private ChamCongDto? _selectedChamCong = null;

        static QuanLyLuongView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyLuongView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            await LoadNhanVienAsync();

            // Tab 1
            dpNgayChamCong.SelectedDate = DateTime.Today;
            await LoadChamCongAsync(DateTime.Today);

            // Tab 3
            var now = DateTime.Now;
            dpNgayBatDauLuong.SelectedDate = new DateTime(now.Year, now.Month, 1);
            dpNgayKetThucLuong.SelectedDate = dpNgayBatDauLuong.SelectedDate.Value.AddMonths(1).AddDays(-1);

            LoadingOverlay.Visibility = Visibility.Collapsed;
        }

        private async Task LoadNhanVienAsync()
        {
            try
            {
                // Tận dụng API của Module 4
                _allNhanVienList = (await httpClient.GetFromJsonAsync<List<NhanVienLookupDto>>("api/app/lichlamviec/all-nhanvien")) ?? new List<NhanVienLookupDto>();
                cmbNhanVienThuongPhat.ItemsSource = _allNhanVienList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải danh sách nhân viên: {ex.Message}", "Lỗi API");
            }
        }

        #region === TAB 1: BẢNG CHẤM CÔNG ===

        private async Task LoadChamCongAsync(DateTime date)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            formChamCong.IsEnabled = false;
            _selectedChamCong = null;
            try
            {
                var data = (await httpClient.GetFromJsonAsync<List<ChamCongDto>>($"api/app/luong/chamcong?date={date:yyyy-MM-dd}")) ?? new List<ChamCongDto>();
                dgChamCong.ItemsSource = data;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải bảng chấm công: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void DpNgayChamCong_SelectedDateChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dpNgayChamCong.SelectedDate.HasValue)
            {
                await LoadChamCongAsync(dpNgayChamCong.SelectedDate.Value);
            }
        }

        private void DgChamCong_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgChamCong.SelectedItem is ChamCongDto selected)
            {
                _selectedChamCong = selected;
                formChamCong.IsEnabled = true;
                lblChamCongNhanVien.Text = selected.HoTenNhanVien;
                // Hiển thị HH:mm
                txtGioVaoMoi.Text = selected.GioVao?.ToString("HH:mm") ?? "";
                txtGioRaMoi.Text = selected.GioRa?.ToString("HH:mm") ?? "";
            }
            else
            {
                _selectedChamCong = null;
                formChamCong.IsEnabled = false;
                lblChamCongNhanVien.Text = "[Chọn 1 mục]";
                txtGioVaoMoi.Text = "";
                txtGioRaMoi.Text = "";
            }
        }

        // File: AppCafebookApi/View/quanly/pages/QuanLyLuongView.xaml.cs (CẬP NHẬT HÀM)

        private async void BtnLuuChamCong_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedChamCong == null) return;

            DateTime ngayLam = _selectedChamCong.NgayLam;
            DateTime? gioVaoMoi = null;
            DateTime? gioRaMoi = null;

            try
            {
                if (!string.IsNullOrWhiteSpace(txtGioVaoMoi.Text))
                {
                    var tsVao = TimeSpan.ParseExact(txtGioVaoMoi.Text, @"hh\:mm", CultureInfo.InvariantCulture);
                    gioVaoMoi = ngayLam.Add(tsVao);
                }
                if (!string.IsNullOrWhiteSpace(txtGioRaMoi.Text))
                {
                    var tsRa = TimeSpan.ParseExact(txtGioRaMoi.Text, @"hh\:mm", CultureInfo.InvariantCulture);
                    gioRaMoi = ngayLam.Add(tsRa);
                    if (gioRaMoi < gioVaoMoi) gioRaMoi = gioRaMoi.Value.AddDays(1);
                }
            }
            catch
            {
                MessageBox.Show("Định dạng giờ không hợp lệ. Vui lòng dùng HH:mm (ví dụ: 08:00 hoặc 17:30).", "Lỗi định dạng");
                return;
            }

            var dto = new ChamCongUpdateDto
            {
                IdChamCong = _selectedChamCong.IdChamCong,
                IdLichLamViec = _selectedChamCong.IdLichLamViec, // <-- THÊM DÒNG NÀY
                GioVaoMoi = gioVaoMoi,
                GioRaMoi = gioRaMoi
            };

            // ============== XÓA BỎ ĐOẠN CODE GÂY LỖI ==============
            // if (dto.IdChamCong == 0)
            // {
            //     MessageBox.Show("Lỗi: Không thể cập nhật thủ công cho nhân viên chưa chấm công lần nào. (Tính năng này cần được nâng cấp API)", "Lỗi");
            //     return;
            // }
            // =======================================================

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                // (Logic gọi API giữ nguyên)
                var response = await httpClient.PutAsJsonAsync($"api/app/luong/chamcong", dto);
                if (response.IsSuccessStatusCode)
                {
                    // === SỬA LỖI CS8629 ===
                    // Thêm kiểm tra HasValue để trình biên dịch không cảnh báo
                    if (dpNgayChamCong.SelectedDate.HasValue)
                    {
                        await LoadChamCongAsync(dpNgayChamCong.SelectedDate.Value);
                    }
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion

        #region === TAB 2: THƯỞNG/PHẠT ===

        private async Task LoadThuongPhatAsync(int idNhanVien)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            formThuongPhat.IsEnabled = true;
            try
            {
                _currentThuongPhatList = (await httpClient.GetFromJsonAsync<List<PhieuThuongPhatDto>>($"api/app/thuongphat/pending/{idNhanVien}")) ?? new List<PhieuThuongPhatDto>();
                dgThuongPhat.ItemsSource = _currentThuongPhatList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải danh sách thưởng/phạt: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void CmbNhanVienThuongPhat_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (cmbNhanVienThuongPhat.SelectedValue is int idNhanVien)
            {
                await LoadThuongPhatAsync(idNhanVien);
            }
            else
            {
                dgThuongPhat.ItemsSource = null;
                formThuongPhat.IsEnabled = false;
            }
        }

        private async void BtnThemThuongPhat_Click(object sender, RoutedEventArgs e)
        {
            if (cmbNhanVienThuongPhat.SelectedValue == null)
            {
                MessageBox.Show("Vui lòng chọn nhân viên.", "Lỗi"); return;
            }
            if (!decimal.TryParse(txtSoTien.Text, out var soTien) || soTien == 0)
            {
                MessageBox.Show("Số tiền không hợp lệ. Dùng số âm (-) cho khoản phạt.", "Lỗi"); return;
            }
            if (string.IsNullOrWhiteSpace(txtLyDoThuongPhat.Text))
            {
                MessageBox.Show("Vui lòng nhập lý do.", "Lỗi"); return;
            }

            var dto = new PhieuThuongPhatCreateDto
            {
                IdNhanVien = (int)cmbNhanVienThuongPhat.SelectedValue,
                IdNguoiTao = AuthService.CurrentUser?.IdNhanVien ?? 0,
                SoTien = soTien,
                LyDo = txtLyDoThuongPhat.Text
            };

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/thuongphat", dto);
                if (response.IsSuccessStatusCode)
                {
                    txtSoTien.Text = "";
                    txtLyDoThuongPhat.Text = "";
                    await LoadThuongPhatAsync(dto.IdNhanVien);
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXoaThuongPhat_Click(object sender, RoutedEventArgs e)
        {
            if ((sender as Button)?.DataContext is not PhieuThuongPhatDto item) return;

            var result = MessageBox.Show($"Bạn có chắc muốn xóa khoản [ {item.SoTien:N0} - {item.LyDo} ] ?", "Xác nhận", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/thuongphat/{item.IdPhieuThuongPhat}");
                if (response.IsSuccessStatusCode)
                {
                    await LoadThuongPhatAsync(item.IdNhanVien);
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Không thể xóa");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion

        #region === TAB 3: TÍNH & CHỐT LƯƠNG ===

        private async void BtnTinhLuong_Click(object sender, RoutedEventArgs e)
        {
            if (dpNgayBatDauLuong.SelectedDate == null || dpNgayKetThucLuong.SelectedDate == null)
            {
                MessageBox.Show("Vui lòng chọn Ngày Bắt Đầu và Kết Thúc.", "Lỗi"); return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            btnChotLuong.IsEnabled = false;
            try
            {
                var sDate = dpNgayBatDauLuong.SelectedDate.Value;
                var eDate = dpNgayKetThucLuong.SelectedDate.Value;

                var url = $"api/app/luong/calculate?startDate={sDate:yyyy-MM-dd}&endDate={eDate:yyyy-MM-dd}";
                _currentBangKeList = (await httpClient.GetFromJsonAsync<List<LuongBangKeDto>>(url)) ?? new List<LuongBangKeDto>();

                dgBangKeLuong.ItemsSource = _currentBangKeList;
                if (_currentBangKeList.Any())
                {
                    btnChotLuong.IsEnabled = true;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tính lương: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnChotLuong_Click(object sender, RoutedEventArgs e)
        {
            if (_currentBangKeList == null || !_currentBangKeList.Any())
            {
                MessageBox.Show("Không có dữ liệu lương để chốt. Vui lòng nhấn 'Tính Lương' trước.", "Lỗi"); return;
            }
            if (dpNgayBatDauLuong.SelectedDate == null)
            {
                MessageBox.Show("Ngày bắt đầu không hợp lệ.", "Lỗi"); return;
            }

            int thang = dpNgayBatDauLuong.SelectedDate.Value.Month;
            int nam = dpNgayBatDauLuong.SelectedDate.Value.Year;

            var result = MessageBox.Show($"Bạn có chắc muốn CHỐT LƯƠNG cho Tháng {thang}/{nam}?\n\nSau khi chốt sẽ không thể hoàn tác.", "Xác nhận Chốt Lương", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;

            var dto = new LuongFinalizeDto
            {
                Thang = thang,
                Nam = nam,
                IdNguoiChot = AuthService.CurrentUser?.IdNhanVien ?? 0,
                DanhSachBangKe = _currentBangKeList
            };

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/luong/finalize", dto);
                var message = await response.Content.ReadAsStringAsync(); // Đọc message dù thành công hay thất bại

                if (response.IsSuccessStatusCode)
                {
                    // === SỬA LỖI CS8602 ===
                    // Phân tích JSON một cách an toàn
                    string successMessage = "Chốt lương thành công!"; // Tin nhắn mặc định
                    try
                    {
                        // var successObj = System.Text.Json.JsonSerializer.Deserialize<dynamic>(message); // Dòng cũ
                        // Thay <dynamic> bằng <JsonElement> và kiểm tra an toàn
                        var successObj = JsonSerializer.Deserialize<JsonElement>(message);

                        if (successObj.TryGetProperty("message", out var messageProp) &&
                            messageProp.ValueKind == JsonValueKind.String)
                        {
                            // Dùng '??' để xử lý
                            successMessage = messageProp.GetString() ?? successMessage;
                        }
                    }
                    catch (JsonException)
                    {
                        // 'message' không phải là JSON hợp lệ, nhưng vẫn thành công
                    }
                    MessageBox.Show(successMessage, "Chốt Lương Thành Công", MessageBoxButton.OK, MessageBoxImage.Information);
                    // === KẾT THÚC SỬA LỖI ===

                    // Reset
                    _currentBangKeList = new List<LuongBangKeDto>();
                    dgBangKeLuong.ItemsSource = null;
                    btnChotLuong.IsEnabled = false;

                    // Tải lại Tab 2 (vì các phiếu đã được gán)
                    if (cmbNhanVienThuongPhat.SelectedValue is int idNhanVien)
                    {
                        await LoadThuongPhatAsync(idNhanVien);
                    }
                }
                else
                {
                    MessageBox.Show($"Lỗi: {message}", "Lỗi Chốt Lương");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion
        /*
        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }*/
        private void BtnGoToBaoCao_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService.Navigate(new BaoCaoNhanSuView());
        }

        private void BtnGoToPhatLuong_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService.Navigate(new QuanLyPhatLuongView());
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyNguyenLieuView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyNguyenLieuView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quản lý Nguyên Liệu" FontFamily="Segoe UI" Loaded="Page_Loaded"
      Background="#FFF8E1">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>

        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconSettings">M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M12,22C11.6,22 11.2,21.9 10.8,21.7L9.1,20.9C5.1,19.3 2,15.2 2,10.9V5L12,2L22,5V10.9C22,15.2 18.9,19.3 14.9,20.9L13.2,21.7C12.8,21.9 12.4,22 12,22Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Quản lý Nguyên Liệu" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="350"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Margin="10,0,15,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Text="Danh sách Nguyên liệu" Style="{StaticResource HeaderTextBlock}"/>
                        <DataGrid Grid.Row="1" x:Name="dgNguyenLieu" AutoGenerateColumns="False" IsReadOnly="True" 
                                  SelectionMode="Single" SelectionChanged="DgNguyenLieu_SelectionChanged" 
                                  BorderThickness="0" RowHeaderWidth="0">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ID" Binding="{Binding IdNguyenLieu}" Width="50"/>
                                <DataGridTextColumn Header="Tên Nguyên Liệu" Binding="{Binding TenNguyenLieu}" Width="*"/>
                                <DataGridTextColumn Header="ĐVT Cơ bản" Binding="{Binding DonViTinh}" Width="100"/>
                                <DataGridTextColumn Header="Tồn Kho" Binding="{Binding TonKho, StringFormat=N2}" Width="100"/>
                                <DataGridTextColumn Header="Ngưỡng Cảnh báo" Binding="{Binding TonKhoToiThieu, StringFormat=N2}" Width="120"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>

                <Border Grid.Column="1" Margin="0,0,10,10" Style="{StaticResource CardBorder}">
                    <StackPanel>
                        <TextBlock Text="Thông tin Nguyên liệu" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,15"/>

                        <TextBlock Text="Tên nguyên liệu:" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtTenNL_crud" Margin="0,0,0,10"/>

                        <TextBlock Text="Đơn vị tính cơ bản (để tồn kho):" Margin="0,0,0,5"/>
                        <ComboBox x:Name="cmbDonViTinh_crud" Margin="0,0,0,10" IsEditable="True">
                            <ComboBoxItem Content="kg"/>
                            <ComboBoxItem Content="lít"/>
                            <ComboBoxItem Content="cái"/>
                            <ComboBoxItem Content="quả"/>
                            <ComboBoxItem Content="chai"/>
                            <ComboBoxItem Content="hộp"/>
                            <ComboBoxItem Content="gram"/>
                            <ComboBoxItem Content="ml"/>
                        </ComboBox>

                        <TextBlock Text="Ngưỡng cảnh báo hết hàng:" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtNguongCanhBao_crud" Margin="0,0,0,15"/>

                        <Grid Height="40">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Button x:Name="btnLamMoiNL" Grid.Column="0" ToolTip="Làm mới" Click="BtnLamMoiNL_Click" Background="Transparent" BorderThickness="0">
                                <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="22" Height="22"/>
                            </Button>
                            <Button x:Name="btnThemNL" Grid.Column="1" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionGreenBrush}" Click="BtnThemNL_Click" Margin="10,0,5,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconAdd}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="Thêm" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                            <Button x:Name="btnLuuNL" Grid.Column="2" Style="{StaticResource PrimaryButton}" Click="BtnLuuNL_Click" Margin="5,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconSave}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="Lưu" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                            <Button x:Name="btnXoaNL" Grid.Column="3" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionRedBrush}" Click="BtnXoaNL_Click" Margin="5,0,0,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconDelete}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="Xóa" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </Grid>

                        <Button x:Name="btnQuanLyDVT" 
                                Style="{StaticResource PrimaryButton}" 
                                Background="{StaticResource ActionBlueBrush}" 
                                Click="BtnQuanLyDVT_Click" 
                                Margin="0,15,0,0">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconSettings}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="Quản lý Đơn Vị Tính (gram, ml...)" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>

                    </StackPanel>
                </Border>
            </Grid>

            <Button x:Name="btnQuayLai" Grid.Row="2" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" Margin="10,0,0,10"
                    Click="BtnQuayLai_Click">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                    <TextBlock Text="Quay lại Tồn Kho" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Đang tải..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyNguyenLieuView.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using System.Globalization;

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyNguyenLieuView : Page
    {
        private static readonly HttpClient httpClient;
        private List<NguyenLieuCrudDto> _nguyenLieuList = new List<NguyenLieuCrudDto>();

        static QuanLyNguyenLieuView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyNguyenLieuView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadDataGridAsync();
            ResetNguyenLieuForm();
        }

        private async Task LoadDataGridAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                _nguyenLieuList = (await httpClient.GetFromJsonAsync<List<NguyenLieuCrudDto>>("api/app/nguyenlieu/all")) ?? new List<NguyenLieuCrudDto>();
                dgNguyenLieu.ItemsSource = _nguyenLieuList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải nguyên liệu: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void ResetNguyenLieuForm()
        {
            dgNguyenLieu.SelectedItem = null;
            txtTenNL_crud.Text = "";
            cmbDonViTinh_crud.Text = "kg";
            txtNguongCanhBao_crud.Text = "0";
            btnThemNL.IsEnabled = true;
            btnLuuNL.IsEnabled = false;
            btnXoaNL.IsEnabled = false;
        }

        private void DgNguyenLieu_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgNguyenLieu.SelectedItem is NguyenLieuCrudDto selected)
            {
                txtTenNL_crud.Text = selected.TenNguyenLieu;
                cmbDonViTinh_crud.Text = selected.DonViTinh;
                txtNguongCanhBao_crud.Text = selected.TonKhoToiThieu.ToString(CultureInfo.InvariantCulture);
                btnThemNL.IsEnabled = false;
                btnLuuNL.IsEnabled = true;
                btnXoaNL.IsEnabled = true;
            }
            else
            {
                ResetNguyenLieuForm();
            }
        }

        private async void BtnThemNL_Click(object sender, RoutedEventArgs e)
        {
            await SaveNguyenLieuAsync(isCreating: true);
        }

        private async void BtnLuuNL_Click(object sender, RoutedEventArgs e)
        {
            await SaveNguyenLieuAsync(isCreating: false);
        }

        private async Task SaveNguyenLieuAsync(bool isCreating)
        {
            var dto = new NguyenLieuUpdateRequestDto
            {
                TenNguyenLieu = txtTenNL_crud.Text,
                DonViTinh = cmbDonViTinh_crud.Text,
                TonKhoToiThieu = decimal.TryParse(txtNguongCanhBao_crud.Text, NumberStyles.Any, CultureInfo.InvariantCulture, out var n) ? n : 0
            };

            if (string.IsNullOrWhiteSpace(dto.TenNguyenLieu) || string.IsNullOrWhiteSpace(dto.DonViTinh))
            {
                MessageBox.Show("Tên và Đơn vị tính là bắt buộc.", "Lỗi"); return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                HttpResponseMessage response;
                if (isCreating)
                {
                    response = await httpClient.PostAsJsonAsync("api/app/nguyenlieu", dto);
                }
                else
                {
                    int id = (dgNguyenLieu.SelectedItem as NguyenLieuCrudDto)?.IdNguyenLieu ?? 0;
                    response = await httpClient.PutAsJsonAsync($"api/app/nguyenlieu/{id}", dto);
                }

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Lưu thành công!", "Thông báo");
                    await LoadDataGridAsync();
                    ResetNguyenLieuForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXoaNL_Click(object sender, RoutedEventArgs e)
        {
            if (dgNguyenLieu.SelectedItem is not NguyenLieuCrudDto selected) return;

            if (MessageBox.Show($"Bạn có chắc muốn xóa '{selected.TenNguyenLieu}'?", "Xác nhận", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.No)
                return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/nguyenlieu/{selected.IdNguyenLieu}");
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Xóa thành công!", "Thông báo");
                    await LoadDataGridAsync();
                    ResetNguyenLieuForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Không thể xóa");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnLamMoiNL_Click(object sender, RoutedEventArgs e)
        {
            ResetNguyenLieuForm();
        }

        // Nút điều hướng
        private void BtnQuanLyDVT_Click(object sender, RoutedEventArgs e)
        {
            // Điều hướng đến trang Đơn Vị Chuyển Đổi 
            this.NavigationService?.Navigate(new QuanLyDonViChuyenDoiView());
        }

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyNhaCungCapView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyNhaCungCapView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quản lý Nhà Cung Cấp" FontFamily="Segoe UI" Loaded="Page_Loaded"
      Background="#FFF8E1">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>

        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>

        <Geometry x:Key="IconExcel">M21.17 3.25Q21.5 3.25 21.76 3.5 22 3.74 22 4.08V19.92Q22 20.26 21.76 20.5 21.5 20.75 21.17 20.75H7.83Q7.5 20.75 7.24 20.5 7 20.26 7 19.92V4.08Q7 3.74 7.24 3.5 7.5 3.25 7.83 3.25H21.17M13.83 18.25V15.7H11.5V14.05L13.72 10.63H11.6V9H16.33V10.65L14.12 14.07H16.25V15.7H13.83V18.25M6.25 15.5Q6.25 15.15 6.04 14.88 5.82 14.6 5.5 14.6H3.5Q3.18 14.6 2.96 14.88 2.75 15.15 2.75 15.5V17.5Q2.75 17.82 2.96 18.1 3.18 18.38 3.5 18.38H5.5Q5.82 18.38 6.04 18.1 6.25 17.82 6.25 17.5V15.5M6.25 9.5Q6.25 9.18 6.04 8.9 5.82 8.62 5.5 8.62H3.5Q3.18 8.62 2.96 8.9 2.75 9.18 2.75 9.5V11.5Q2.75 11.82 2.96 12.1 3.18 12.38 3.5 12.38H5.5Q5.82 12.38 6.04 12.1 6.25 11.82 6.25 11.5V9.5Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Quản lý Nhà Cung Cấp" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="350"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Margin="10,0,15,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Text="Danh sách Nhà Cung Cấp" Style="{StaticResource HeaderTextBlock}"/>

                        <DataGrid Grid.Row="1" x:Name="dgNhaCungCap" AutoGenerateColumns="False" IsReadOnly="True" 
                                  SelectionMode="Single" SelectionChanged="DgNhaCungCap_SelectionChanged" 
                                  BorderThickness="0" RowHeaderWidth="0">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ID" Binding="{Binding IdNhaCungCap}" Width="50"/>
                                <DataGridTextColumn Header="Tên Nhà Cung Cấp" Binding="{Binding TenNhaCungCap}" Width="*"/>
                                <DataGridTextColumn Header="Số điện thoại" Binding="{Binding SoDienThoai}" Width="150"/>
                                <DataGridTextColumn Header="Địa chỉ" Binding="{Binding DiaChi}" Width="200"/>
                            </DataGrid.Columns>
                        </DataGrid>

                        <Button Grid.Row="2" x:Name="btnExportExcel" HorizontalAlignment="Left" Margin="0,15,0,0"
                                Style="{StaticResource PrimaryButton}" Background="#00724C"
                                Click="BtnExportExcel_Click">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconExcel}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="Xuất Excel" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </Grid>
                </Border>

                <Border Grid.Column="1" Margin="0,0,10,10" Style="{StaticResource CardBorder}">
                    <StackPanel>
                        <TextBlock Text="Thông tin Nhà Cung cấp" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,15"/>
                        <TextBlock Text="Tên nhà cung cấp:" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtTenNCC" Margin="0,0,0,10"/>
                        <TextBlock Text="Số điện thoại:" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtSdtNCC" Margin="0,0,0,10"/>
                        <TextBlock Text="Địa chỉ:" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtDiaChiNCC" Margin="0,0,0,10" Height="60" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"/>
                        <TextBlock Text="Email:" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtEmailNCC" Margin="0,0,0,15"/>
                        <Grid Height="40">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Button x:Name="btnLamMoiNCC" Grid.Column="0" ToolTip="Làm mới" Click="BtnLamMoiNCC_Click" Background="Transparent" BorderThickness="0">
                                <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="22" Height="22"/>
                            </Button>
                            <Button x:Name="btnThemNCC" Grid.Column="1" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionGreenBrush}" Click="BtnThemNCC_Click" Margin="10,0,5,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconAdd}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="Thêm" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                            <Button x:Name="btnLuuNCC" Grid.Column="2" Style="{StaticResource PrimaryButton}" Click="BtnLuuNCC_Click" Margin="5,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconSave}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="Lưu" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                            <Button x:Name="btnXoaNCC" Grid.Column="3" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionRedBrush}" Click="BtnXoaNCC_Click" Margin="5,0,0,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconDelete}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="Xóa" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </Grid>
                    </StackPanel>
                </Border>
            </Grid>

            <Button x:Name="btnQuayLai" Grid.Row="2" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" Margin="10,0,0,10"
                    Click="BtnQuayLai_Click">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                    <TextBlock Text="Quay lại Tồn Kho" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Đang tải..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyNhaCungCapView.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
// THÊM MỚI: Using cho Excel
using Microsoft.Win32;
using System.IO;
using OfficeOpenXml;
using OfficeOpenXml.Table;

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyNhaCungCapView : Page
    {
        private static readonly HttpClient httpClient;
        private List<NhaCungCapDto> _nhaCungCapList = new List<NhaCungCapDto>();

        static QuanLyNhaCungCapView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyNhaCungCapView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadNhaCungCapAsync();
            ResetNhaCungCapForm();
        }

        private async Task LoadNhaCungCapAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                _nhaCungCapList = (await httpClient.GetFromJsonAsync<List<NhaCungCapDto>>("api/app/kho/nhacungcap")) ?? new List<NhaCungCapDto>();
                dgNhaCungCap.ItemsSource = _nhaCungCapList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải nhà cung cấp: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void ResetNhaCungCapForm()
        {
            dgNhaCungCap.SelectedItem = null;
            txtTenNCC.Text = "";
            txtSdtNCC.Text = "";
            txtDiaChiNCC.Text = "";
            txtEmailNCC.Text = "";
            btnThemNCC.IsEnabled = true;
            btnLuuNCC.IsEnabled = false;
            btnXoaNCC.IsEnabled = false;
        }

        private void DgNhaCungCap_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgNhaCungCap.SelectedItem is NhaCungCapDto selected)
            {
                txtTenNCC.Text = selected.TenNhaCungCap;
                txtSdtNCC.Text = selected.SoDienThoai;
                txtDiaChiNCC.Text = selected.DiaChi;
                txtEmailNCC.Text = selected.Email;
                btnThemNCC.IsEnabled = false;
                btnLuuNCC.IsEnabled = true;
                btnXoaNCC.IsEnabled = true;
            }
            else
            {
                ResetNhaCungCapForm();
            }
        }

        private async void BtnThemNCC_Click(object sender, RoutedEventArgs e)
        {
            await SaveNhaCungCapAsync(isCreating: true);
        }

        private async void BtnLuuNCC_Click(object sender, RoutedEventArgs e)
        {
            await SaveNhaCungCapAsync(isCreating: false);
        }

        private async Task SaveNhaCungCapAsync(bool isCreating)
        {
            if (string.IsNullOrWhiteSpace(txtTenNCC.Text))
            {
                MessageBox.Show("Tên nhà cung cấp là bắt buộc.", "Lỗi"); return;
            }

            var dto = new NhaCungCapDto
            {
                TenNhaCungCap = txtTenNCC.Text,
                SoDienThoai = txtSdtNCC.Text,
                DiaChi = txtDiaChiNCC.Text,
                Email = txtEmailNCC.Text
            };

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                HttpResponseMessage response;
                if (isCreating)
                {
                    response = await httpClient.PostAsJsonAsync("api/app/kho/nhacungcap", dto);
                }
                else
                {
                    int id = (dgNhaCungCap.SelectedItem as NhaCungCapDto)?.IdNhaCungCap ?? 0;
                    response = await httpClient.PutAsJsonAsync($"api/app/kho/nhacungcap/{id}", dto);
                }

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Lưu thành công!", "Thông báo");
                    await LoadNhaCungCapAsync();
                    ResetNhaCungCapForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXoaNCC_Click(object sender, RoutedEventArgs e)
        {
            if (dgNhaCungCap.SelectedItem is not NhaCungCapDto selected) return;

            if (MessageBox.Show($"Bạn có chắc muốn xóa '{selected.TenNhaCungCap}'?", "Xác nhận", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.No)
                return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/kho/nhacungcap/{selected.IdNhaCungCap}");
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Xóa thành công!", "Thông báo");
                    await LoadNhaCungCapAsync();
                    ResetNhaCungCapForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Không thể xóa");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnLamMoiNCC_Click(object sender, RoutedEventArgs e)
        {
            ResetNhaCungCapForm();
        }

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService?.CanGoBack == true)
            {
                this.NavigationService.GoBack();
            }
        }

        // --- THÊM MỚI: HÀM XUẤT EXCEL ---
        private void BtnExportExcel_Click(object sender, RoutedEventArgs e)
        {
            if (_nhaCungCapList == null || !_nhaCungCapList.Any())
            {
                MessageBox.Show("Không có dữ liệu để xuất.", "Thông báo");
                return;
            }

            var sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                FileName = $"DSNhaCungCap_{DateTime.Now:yyyyMMdd_HHmm}.xlsx"
            };

            if (sfd.ShowDialog() == true)
            {
                try
                {
                    ExcelPackage.License.SetNonCommercialPersonal("CafeBook");
                    using (var package = new ExcelPackage(new FileInfo(sfd.FileName)))
                    {
                        var ws = package.Workbook.Worksheets.Add("DanhSachNCC");
                        ws.Cells["A1"].Value = "Danh sách Nhà Cung Cấp";
                        ws.Cells["A1:D1"].Merge = true;
                        ws.Cells["A1"].Style.Font.Bold = true;
                        ws.Cells["A1"].Style.Font.Size = 16;

                        // Tải dữ liệu vào, tự động nhận Header
                        ws.Cells["A3"].LoadFromCollection(_nhaCungCapList, true, TableStyles.Medium9);
                        ws.Cells[ws.Dimension.Address].AutoFitColumns();

                        package.Save();
                    }
                    MessageBox.Show("Xuất Excel thành công!", "Thông báo");
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Lỗi khi xuất Excel: {ex.Message}\n\nĐảm bảo file không đang được mở.", "Lỗi");
                }
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyNhanVienView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyNhanVienView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quản lý Nhân viên"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="BackgroundHoverBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="StatusRedBrush" Color="#FFEBEE"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="SubtleWhiteTextBrush" Color="#BCAAA4"/>
        <SolidColorBrush x:Key="HoverBrownBrush" Color="#8D6E63"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        
        <Geometry x:Key="IconCalendar">M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconUpload">M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z</Geometry>
        <Geometry x:Key="IconRole">M12,1L9,4H6C4.9,4 4,4.9 4,6V18C4,19.1 4.9,20 6,20H18C19.1,20 20,19.1 20,18V6C20,4.9 19.1,4 18,4H15L12,1M12,6C13.66,6 15,7.34 15,9C15,10.66 13.66,12 12,12C10.34,12 9,10.66 9,9C9,7.34 10.34,6 12,6M16,14C17.67,14 20,15.33 20,17V18H4V17C4,15.33 6.33,14 8,14H16Z</Geometry>
        <Geometry x:Key="IconExcel">M21.17 3.25Q21.5 3.25 21.76 3.5 22 3.74 22 4.08V19.92Q22 20.26 21.76 20.5 21.5 20.75 21.17 20.75H7.83Q7.5 20.75 7.24 20.5 7 20.26 7 19.92V4.08Q7 3.74 7.24 3.5 7.5 3.25 7.83 3.25H21.17M13.83 18.25V15.7H11.5V14.05L13.72 10.63H11.6V9H16.33V10.65L14.12 14.07H16.25V15.7H13.83V18.25M6.25 15.5Q6.25 15.15 6.04 14.88 5.82 14.6 5.5 14.6H3.5Q3.18 14.6 2.96 14.88 2.75 15.15 2.75 15.5V17.5Q2.75 17.82 2.96 18.1 3.18 18.38 3.5 18.38H5.5Q5.82 18.38 6.04 18.1 6.25 17.82 6.25 17.5V15.5M6.25 9.5Q6.25 9.18 6.04 8.9 5.82 8.62 5.5 8.62H3.5Q3.18 8.62 2.96 8.9 2.75 9.18 2.75 9.5V11.5Q2.75 11.82 2.96 12.1 3.18 12.38 3.5 12.38H5.5Q5.82 12.38 6.04 12.1 6.25 11.82 6.25 11.5V9.5Z</Geometry>
        <Geometry x:Key="IconLeave">M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.89 20.1,3 19,3M19,19H5V10H19V19M10,14V12H7V14H10M14,14V12H11V14H14M18,14V12H15V14H18Z</Geometry>
        <Geometry x:Key="IconCustomer">M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5,5.61 6.79,4 9,4C11.21,4 13,5.61 13,8C13,10.39 11.21,12 9,12C6.79,12 5,10.39 5,8M9,13C11.67,13 17,14.34 17,17V20H1V17C1,14.34 6.33,13 9,13M17.75,10.5A3.75,3.75 0 0,0 21.5,6.75A3.75,3.75 0 0,0 17.75,3A3.75,3.75 0 0,0 14,6.75A3.75,3.75 0 0,0 17.75,10.5M14,17.25C14,16.5 15.17,16 16.5,16C17.83,16 19,16.5 19,17.25V18H14V17.25Z</Geometry>
        <Geometry x:Key="IconPromotion">M12.41,2.58C12.03,2.2 11.53,2 11,2H4C2.9,2 2,2.9 2,4V11C2,11.53 2.2,12.03 2.59,12.41L12.42,22.24C12.81,22.63 13.44,22.63 13.83,22.24L22.24,13.82C22.63,13.43 22.63,12.8 22.24,12.41L12.41,2.58M7,7A1.5,1.5 0 0,1 5.5,8.5A1.5,1.5 0 0,1 4,7A1.5,1.5 0 0,1 5.5,5.5A1.5,1.5 0 0,1 7,7Z</Geometry>
        <Geometry x:Key="IconPayroll">M20,6H4V4H20V6M20,10H4V8H20V10M18,14H6V12H18V14M18,18H6V16H18V18M19,20H5C3.89,20 3,19.1 3,18V3C3,1.89 3.89,1 5,1H19C20.1,1 21,1.89 21,3V18C21,19.1 20.1,20 19,20Z</Geometry>
        <Geometry x:Key="IconSettings">M12,15.5C10.07,15.5 8.5,13.93 8.5,12C8.5,10.07 10.07,8.5 12,8.5C13.93,8.5 15.5,10.07 15.5,12C15.5,13.93 13.93,15.5 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z</Geometry>
        <Geometry x:Key="IconReport">M18,17H16V15H18M18,13H16V11H18M18,9H16V7H18M14,17H12V15H14M14,13H12V11H14M14,9H12V7H14M10,17H8V15H10M10,13H8V11H10M10,9H8V7H10M6,17H4V15H6M6,13H4V11H6M6,9H4V7H6M20,19V3H17V1H7V3H4V19C4,20.11 4.9,21 6,21H18C19.1,21 20,20.11 20,19M18,5H6V19H18V5Z</Geometry>
        
        <Style x:Key="ActionButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,10"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="4" Padding="{TemplateBinding Padding}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.1" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.8"/>
                                <Setter TargetName="border" Property="Effect" Value="{x:Null}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="DeleteButton" TargetType="Button" BasedOn="{StaticResource ActionButton}">
            <Setter Property="Background" Value="{StaticResource ErrorBrush}"/>
        </Style>
        <Style x:Key="MaterialIconButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="20">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BackgroundHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="Label">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,15,0,5"/>
        </Style>
        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="PasswordBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>

        <Style x:Key="SearchTextBox" TargetType="TextBox" BasedOn="{StaticResource MaterialInput}">
            <Setter Property="Padding" Value="8,8"/>
        </Style>
        <Style x:Key="FilterComboBox" TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}">
            <Setter Property="Padding" Value="8,8"/>
        </Style>
        <Style x:Key="AvatarImage" TargetType="Image">
            <Setter Property="Width" Value="100"/>
            <Setter Property="Height" Value="100"/>
            <Setter Property="Stretch" Value="UniformToFill"/>
        </Style>

        <Style x:Key="EmployeeDataGridRowStyle" TargetType="DataGridRow">
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding TrangThaiLamViec}" Value="Nghỉ việc">
                    <Setter Property="Background" Value="{StaticResource StatusRedBrush}"/>
                    <Setter Property="Foreground" Value="{StaticResource ErrorBrush}"/>
                    <Setter Property="FontStyle" Value="Italic"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="NavToggleButton" TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource SubtleWhiteTextBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Padding" Value="20,12"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="border" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" CornerRadius="5" Margin="8,2">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Border x:Name="indicator" Width="4" Height="20" Background="Transparent" CornerRadius="2" VerticalAlignment="Center" Margin="-20,0,10,0"/>
                                <Viewbox Grid.Column="0" Width="23" Height="23" Margin="0,0,15,0">
                                    <Path Data="{Binding Path=Tag, RelativeSource={RelativeSource TemplatedParent}}" Fill="{TemplateBinding Foreground}" Stretch="Uniform" VerticalAlignment="Center"/>
                                </Viewbox>
                                <ContentPresenter Grid.Column="1" HorizontalAlignment="Left" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource HoverBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                                <Setter TargetName="indicator" Property="Background" Value="{StaticResource AccentOrangeBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="420"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Background="White" CornerRadius="8" Margin="10">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
            </Border.Effect>

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <WrapPanel Grid.Row="0" Orientation="Horizontal" Margin="10,5,10,10">
                    <TextBlock Text="Tìm kiếm:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                    <TextBox x:Name="txtSearchNhanVien" Width="200" Style="{StaticResource SearchTextBox}" TextChanged="Filter_Changed"/>

                    <TextBlock Text="Vai trò:" VerticalAlignment="Center" Margin="15,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                    <ComboBox x:Name="cmbFilterVaiTro" Width="180" DisplayMemberPath="Ten" SelectedValuePath="Id"
                              Style="{StaticResource FilterComboBox}" SelectionChanged="Filter_Changed"/>

                    <Button x:Name="btnGoToRoles" ToolTip="Quản lý Vai trò &amp; Phân quyền" Style="{StaticResource MaterialIconButton}" 
                            Click="BtnGoToRoles_Click" Margin="5,0,0,0">
                        <Path Data="{StaticResource IconRole}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                    </Button>
                    <Button x:Name="btnGoToLichLamViec" ToolTip="Quản lý Lịch Làm Việc" Style="{StaticResource MaterialIconButton}" 
                            Click="BtnGoToLichLamViec_Click" Margin="5,0,0,0">
                        <Path Data="{StaticResource IconCalendar}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                    </Button>

                    <Button x:Name="btnGoToDonXinNghi" ToolTip="Quản lý Đơn Nghỉ" Style="{StaticResource MaterialIconButton}" 
                            Click="BtnGoToDonXinNghi_Click" Margin="5,0,0,0">
                        <Path Data="{StaticResource IconLeave}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                    </Button>
                    <Button x:Name="btnGoToBaoCao" ToolTip="Báo Cáo Nhân Sự" Style="{StaticResource MaterialIconButton}" 
                            Click="BtnGoToBaoCao_Click" Margin="5,0,0,0">
                        <Path Data="{StaticResource IconReport}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                    </Button>
                    <Button x:Name="btnGoToHieuSuat" ToolTip="Báo Cáo Hiệu Suất Nhân Viên" Style="{StaticResource MaterialIconButton}" 
                            Click="BtnGoToHieuSuat_Click" Margin="5,0,0,0">
                        <Path Data="{StaticResource IconPayroll}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                    </Button>
                    <Button x:Name="btnGoToCaiDat" ToolTip="Cấu Hình Nhân Sự" Style="{StaticResource MaterialIconButton}" 
                            Click="BtnGoToCaiDat_Click" Margin="5,0,0,0">
                        <Path Data="{StaticResource IconSettings}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                    </Button>
                </WrapPanel>

                <DataGrid Grid.Row="1" x:Name="dgNhanVien" AutoGenerateColumns="False" IsReadOnly="True"
                          SelectionMode="Single" SelectionChanged="DgNhanVien_SelectionChanged"
                          BorderThickness="0" RowHeaderWidth="0" Margin="10,0,10,10"
                          RowStyle="{StaticResource EmployeeDataGridRowStyle}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="ID" Binding="{Binding IdNhanVien}" Width="50"/>
                        <DataGridTextColumn Header="Họ Tên" Binding="{Binding HoTen}" Width="*"/>
                        <DataGridTextColumn Header="Vai Trò" Binding="{Binding TenVaiTro}" Width="120"/>
                        <DataGridTextColumn Header="Lương/Giờ" Binding="{Binding LuongCoBan, StringFormat=N0}" Width="100"/>
                        <DataGridTextColumn Header="Trạng thái" Binding="{Binding TrangThaiLamViec}" Width="100"/>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Border>

        <Border Grid.Column="1" Background="White" CornerRadius="8" Padding="25" Margin="0,10,10,10">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
            </Border.Effect>
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock x:Name="lblFormTitle" Text="Thông tin Nhân viên" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,5,0,15" VerticalAlignment="Center"/>
                        <Button x:Name="btnLamMoiForm" Grid.Column="1" ToolTip="Tạo nhân viên mới" Click="BtnLamMoiForm_Click" 
                                Style="{StaticResource MaterialIconButton}">
                            <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                        </Button>
                    </Grid>

                    <Grid x:Name="formChiTiet" IsEnabled="False">
                        <StackPanel>
                            <Grid Margin="0,0,0,15">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <Border Grid.Column="0" BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="1" Width="100" Height="100" Background="{StaticResource SubtleGrayBrush}" CornerRadius="50">
                                    <Ellipse>
                                        <Ellipse.Fill>
                                            <ImageBrush x:Name="AvatarPreview" Stretch="UniformToFill"/>
                                        </Ellipse.Fill>
                                    </Ellipse>
                                </Border>

                                <StackPanel Grid.Column="1" VerticalAlignment="Bottom" Orientation="Horizontal" Margin="15,0,0,0">
                                    <Button x:Name="btnChonAnh" 
                                            Style="{StaticResource ActionButton}" Background="#F5F5F5" 
                                            BorderBrush="#E0E0E0" Foreground="{StaticResource DarkBrownBrush}"
                                            Click="BtnChonAnh_Click">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconUpload}" Fill="{StaticResource DarkBrownBrush}" Width="20" Height="20" Margin="0,0,8,0"/>
                                            <TextBlock Text="Chọn ảnh bìa" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>

                                    <Button x:Name="btnXoaAnh" 
                                            Style="{StaticResource DeleteButton}" 
                                            Margin="10,0,0,0" 
                                            Click="BtnXoaAnh_Click">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconDelete}" Fill="White" Width="18" Height="18" Margin="0,0,8,0"/>
                                            <TextBlock Text="Xóa ảnh" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                            </Grid>

                            <Label Content="Họ Tên (*)"/>
                            <TextBox x:Name="txtHoTen"/>

                            <Label Content="Tên Đăng Nhập (*)"/>
                            <TextBox x:Name="txtTenDangNhap"/>

                            <Label x:Name="lblMatKhau" Content="Mật Khẩu (*)"/>
                            <PasswordBox x:Name="txtMatKhau"/>
                            <TextBlock x:Name="lblMatKhauInfo" Text="Bỏ trống nếu không muốn đổi mật khẩu" FontSize="11" FontStyle="Italic" Foreground="Gray" Margin="0,5,0,0" Visibility="Collapsed"/>

                            <Label Content="Vai Trò (*)"/>
                            <ComboBox x:Name="cmbVaiTro" DisplayMemberPath="Ten" SelectedValuePath="Id"/>

                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0" Margin="0,0,10,0">
                                    <Label Content="Lương/Giờ (*)"/>
                                    <TextBox x:Name="txtLuongCoBan"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1" Margin="10,0,0,0">
                                    <Label Content="Trạng thái (*)"/>
                                    <ComboBox x:Name="cmbTrangThai">
                                        <ComboBoxItem Content="Đang làm việc"/>
                                        <ComboBoxItem Content="Nghỉ việc"/>
                                    </ComboBox>
                                </StackPanel>
                            </Grid>

                            <Label Content="Ngày Vào Làm"/>
                            <DatePicker x:Name="dpNgayVaoLam"/>

                            <Label Content="Số Điện Thoại"/>
                            <TextBox x:Name="txtSoDienThoai"/>

                            <Label Content="Email"/>
                            <TextBox x:Name="txtEmail"/>

                            <Label Content="Địa Chỉ"/>
                            <TextBox x:Name="txtDiaChi" Height="80" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"/>
                        </StackPanel>
                    </Grid>

                    <StackPanel x:Name="panelActions" Orientation="Horizontal" Margin="0,25,0,0">
                        <Button x:Name="btnThem" Click="BtnThem_Click" Margin="0,0,10,0" Style="{StaticResource ActionButton}" Background="{StaticResource SuccessBrush}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconAdd}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="Thêm Nhân Viên" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        <Button x:Name="btnLuu" Click="BtnLuu_Click" Margin="0,0,10,0" Style="{StaticResource ActionButton}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconSave}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="Lưu Thay Đổi" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        <Button x:Name="btnXoa" Click="BtnXoa_Click" Margin="0,0,10,0" Style="{StaticResource DeleteButton}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconDelete}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="Xóa" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <Border x:Name="LoadingOverlay" Background="#80FFFFFF" Visibility="Collapsed"
                            Grid.RowSpan="2" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                        <TextBlock Text="Đang xử lý..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
                    </Border>
                </StackPanel>
            </ScrollViewer>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyNhanVienView.xaml.cs
================================================================================
﻿// Tập tin: AppCafebookApi/View/quanly/pages/QuanLyNhanVienView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using Microsoft.Win32;
using System.IO;
using AppCafebookApi.Services;
using CafebookModel.Utils;
using System.Globalization;
using AppCafebookApi.View.common;
using System.Net.Http.Headers; // <-- THÊM

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyNhanVienView : Page
    {
        private static readonly HttpClient httpClient;
        private List<NhanVienGridDto> _allNhanVienList = new List<NhanVienGridDto>();
        private List<FilterLookupDto> _vaiTroList = new List<FilterLookupDto>();

        // SỬA: Dùng DTO chi tiết (Detail) để nhận URL
        private NhanVienDetailDto? _selectedNhanVien = null;

        // SỬA: Thay thế Base64 bằng đường dẫn file
        private string? _currentAvatarFilePath = null;
        private bool _deleteAvatarRequest = false;

        static QuanLyNhanVienView()
        {
            httpClient = new HttpClient
            {
                // SỬA: Đổi port về 5166 (theo launchSettings.json của bạn)
                BaseAddress = new Uri("http://127.0.0.1:5166")
            };
        }

        public QuanLyNhanVienView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadFiltersAsync();
            await LoadDataGridAsync();
            ResetForm();
        }

        #region Tải Dữ Liệu & Lọc

        private async Task LoadFiltersAsync()
        {
            try
            {
                var filters = await httpClient.GetFromJsonAsync<NhanSuFiltersDto>("api/app/nhanvien/filters");
                if (filters != null)
                {
                    _vaiTroList = filters.VaiTros;
                    var filterVaiTro = new List<FilterLookupDto>(_vaiTroList);
                    filterVaiTro.Insert(0, new FilterLookupDto { Id = 0, Ten = "Tất cả Vai trò" });
                    cmbFilterVaiTro.ItemsSource = filterVaiTro;
                    cmbFilterVaiTro.SelectedValue = 0;
                    cmbVaiTro.ItemsSource = _vaiTroList;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải bộ lọc: {ex.Message}", "Lỗi API");
            }
        }

        private async Task LoadDataGridAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            string searchText = txtSearchNhanVien.Text;
            int vaiTroId = (int)(cmbFilterVaiTro.SelectedValue ?? 0);

            try
            {
                var url = $"api/app/nhanvien/search?searchText={Uri.EscapeDataString(searchText)}&vaiTroId={vaiTroId}";
                _allNhanVienList = (await httpClient.GetFromJsonAsync<List<NhanVienGridDto>>(url)) ?? new List<NhanVienGridDto>();
                dgNhanVien.ItemsSource = _allNhanVienList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải danh sách nhân viên: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void Filter_Changed(object sender, RoutedEventArgs e)
        {
            if (this.IsLoaded)
                await LoadDataGridAsync();
        }

        // SỬA: Thêm sự kiện cho XAML
        private void Filter_Changed(object sender, TextChangedEventArgs e)
        {
            if (this.IsLoaded)
                _ = LoadDataGridAsync();
        }

        #endregion

        #region Form & CRUD

        private void ResetForm()
        {
            _selectedNhanVien = null;
            _currentAvatarFilePath = null;
            _deleteAvatarRequest = false;

            dgNhanVien.SelectedItem = null;
            formChiTiet.IsEnabled = true;
            panelActions.Visibility = Visibility.Visible;

            btnThem.Visibility = Visibility.Visible;
            btnLuu.Visibility = Visibility.Collapsed;
            btnXoa.Visibility = Visibility.Collapsed;

            lblFormTitle.Text = "Thêm Nhân Viên Mới";
            lblMatKhau.Visibility = Visibility.Visible;
            txtMatKhau.Visibility = Visibility.Visible;
            lblMatKhauInfo.Visibility = Visibility.Collapsed;

            txtHoTen.Text = "";
            txtTenDangNhap.Text = "";
            txtMatKhau.Password = "";
            cmbVaiTro.SelectedIndex = -1;
            txtLuongCoBan.Text = "0";
            cmbTrangThai.SelectedIndex = 0;
            dpNgayVaoLam.SelectedDate = DateTime.Today;
            txtSoDienThoai.Text = "";
            txtEmail.Text = "";
            txtDiaChi.Text = "";

            AvatarPreview.ImageSource = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultAvatar);
        }

        private async void DgNhanVien_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgNhanVien.SelectedItem is not NhanVienGridDto selected)
            {
                ResetForm();
                return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                // SỬA: Gọi NhanVienDetailDto
                _selectedNhanVien = await httpClient.GetFromJsonAsync<NhanVienDetailDto>($"api/app/nhanvien/details/{selected.IdNhanVien}");
                if (_selectedNhanVien == null)
                {
                    ResetForm();
                    return;
                }

                _currentAvatarFilePath = null;
                _deleteAvatarRequest = false;

                formChiTiet.IsEnabled = true;
                panelActions.Visibility = Visibility.Visible;
                btnThem.Visibility = Visibility.Collapsed;
                btnLuu.Visibility = Visibility.Visible;
                btnXoa.Visibility = Visibility.Visible;

                lblFormTitle.Text = "Cập nhật Nhân Viên";
                lblMatKhau.Visibility = Visibility.Collapsed;
                txtMatKhau.Visibility = Visibility.Collapsed;
                lblMatKhauInfo.Visibility = Visibility.Visible;
                txtMatKhau.Password = "";

                txtHoTen.Text = _selectedNhanVien.HoTen;
                txtTenDangNhap.Text = _selectedNhanVien.TenDangNhap;
                cmbVaiTro.SelectedValue = _selectedNhanVien.IdVaiTro;
                txtLuongCoBan.Text = _selectedNhanVien.LuongCoBan.ToString("F0");
                cmbTrangThai.Text = _selectedNhanVien.TrangThaiLamViec;
                dpNgayVaoLam.SelectedDate = _selectedNhanVien.NgayVaoLam;
                txtSoDienThoai.Text = _selectedNhanVien.SoDienThoai;
                txtEmail.Text = _selectedNhanVien.Email;
                txtDiaChi.Text = _selectedNhanVien.DiaChi;

                // SỬA: Load ảnh từ URL
                AvatarPreview.ImageSource = HinhAnhHelper.LoadImage(_selectedNhanVien.AnhDaiDienUrl, HinhAnhPaths.DefaultAvatar);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải chi tiết: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnLamMoiForm_Click(object sender, RoutedEventArgs e)
        {
            ResetForm();
        }

        private void BtnChonAnh_Click(object sender, RoutedEventArgs e)
        {
            var ofd = new OpenFileDialog { Filter = "Image files|*.png;*.jpg;*.jpeg", Title = "Chọn Avatar" };
            if (ofd.ShowDialog() == true)
            {
                try
                {
                    // SỬA: Chỉ lưu đường dẫn file
                    _currentAvatarFilePath = ofd.FileName;
                    _deleteAvatarRequest = false;
                    AvatarPreview.ImageSource = HinhAnhHelper.LoadImage(_currentAvatarFilePath, HinhAnhPaths.DefaultAvatar);
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Lỗi đọc file ảnh: {ex.Message}", "Lỗi File");
                    _currentAvatarFilePath = null;
                    AvatarPreview.ImageSource = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultAvatar);
                }
            }
        }

        // SỬA: Thêm hàm này (từ XAML của bạn)
        private void BtnXoaAnh_Click(object sender, RoutedEventArgs e)
        {
            _currentAvatarFilePath = null;
            _deleteAvatarRequest = true;
            AvatarPreview.ImageSource = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultAvatar);
        }

        private async void BtnThem_Click(object sender, RoutedEventArgs e)
        {
            await SaveNhanVienAsync(isCreating: true);
        }

        private async void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            await SaveNhanVienAsync(isCreating: false);
        }

        // SỬA: Dùng MultipartFormDataContent
        private async Task SaveNhanVienAsync(bool isCreating)
        {
            // ... (validation) ...
            if (string.IsNullOrWhiteSpace(txtHoTen.Text) || string.IsNullOrWhiteSpace(txtTenDangNhap.Text))
            {
                MessageBox.Show("Họ tên và Tên đăng nhập là bắt buộc.", "Lỗi"); return;
            }
            if (isCreating && string.IsNullOrWhiteSpace(txtMatKhau.Password))
            {
                MessageBox.Show("Mật khẩu là bắt buộc khi tạo mới.", "Lỗi"); return;
            }
            if (cmbVaiTro.SelectedValue == null)
            {
                MessageBox.Show("Vui lòng chọn Vai trò.", "Lỗi"); return;
            }

            // SỬA: Dùng MultipartFormDataContent
            using var form = new MultipartFormDataContent();

            // 1. Thêm các trường dữ liệu
            form.Add(new StringContent(txtHoTen.Text), "HoTen");
            form.Add(new StringContent(txtTenDangNhap.Text), "TenDangNhap");
            if (!string.IsNullOrWhiteSpace(txtMatKhau.Password))
                form.Add(new StringContent(txtMatKhau.Password), "MatKhau");

            // === SỬA LỖI CS8604 (Dòng 281) ===
            // Dùng string interpolation ($"") để đảm bảo kết quả luôn là `string` (non-null)
            // Logic (dòng 269) đã đảm bảo SelectedValue không null
            form.Add(new StringContent($"{cmbVaiTro.SelectedValue!}"), "IdVaiTro");

            form.Add(new StringContent(decimal.TryParse(txtLuongCoBan.Text, out var l) ? l.ToString() : "0"), "LuongCoBan");
            form.Add(new StringContent(((cmbTrangThai.SelectedItem as ComboBoxItem)?.Content?.ToString()) ?? "Đang làm việc"), "TrangThaiLamViec");
            form.Add(new StringContent((dpNgayVaoLam.SelectedDate ?? DateTime.Today).ToString("o")), "NgayVaoLam"); // Gửi ISO 8601
            form.Add(new StringContent(txtSoDienThoai.Text ?? ""), "SoDienThoai");
            form.Add(new StringContent(txtEmail.Text ?? ""), "Email");
            form.Add(new StringContent(txtDiaChi.Text ?? ""), "DiaChi");

            if (!isCreating)
            {
                // (Fix từ lần trước)
                form.Add(new StringContent(_selectedNhanVien!.IdNhanVien.ToString()), "IdNhanVien");
            }

            // 2. Thêm file
            if (!string.IsNullOrEmpty(_currentAvatarFilePath))
            {
                var fileStream = File.OpenRead(_currentAvatarFilePath);
                var streamContent = new StreamContent(fileStream);
                streamContent.Headers.ContentType = new MediaTypeHeaderValue("image/jpeg");
                form.Add(streamContent, "AnhDaiDienUpload", Path.GetFileName(_currentAvatarFilePath));
            }

            // 3. Thêm cờ Xóa
            if (_deleteAvatarRequest)
            {
                form.Add(new StringContent("true"), "XoaAnhDaiDien");
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                HttpResponseMessage response;
                if (isCreating)
                {
                    response = await httpClient.PostAsync("api/app/nhanvien", form);
                }
                else
                {
                    // (Fix từ lần trước)
                    response = await httpClient.PutAsync($"api/app/nhanvien/{_selectedNhanVien!.IdNhanVien}", form);
                }

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Lưu thành công!", "Thông báo");
                    await LoadDataGridAsync();
                    ResetForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
                _currentAvatarFilePath = null;
                _deleteAvatarRequest = false;
            }
        }

        private async void BtnXoa_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedNhanVien == null) return;

            var result = MessageBox.Show($"Bạn có chắc muốn xóa nhân viên '{_selectedNhanVien.HoTen}'?", "Xác nhận", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/nhanvien/{_selectedNhanVien.IdNhanVien}");
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Xóa thành công!", "Thông báo");
                    await LoadDataGridAsync();
                    ResetForm();
                }
                else if (response.StatusCode == HttpStatusCode.Conflict)
                {
                    var error = await response.Content.ReadAsStringAsync();
                    var confirmDeactivate = MessageBox.Show($"{error}\n\nBạn có muốn chuyển trạng thái nhân viên này thành 'Nghỉ việc' không?", "Không thể xóa", MessageBoxButton.YesNo, MessageBoxImage.Question);

                    if (confirmDeactivate == MessageBoxResult.Yes)
                    {
                        // SỬA: Gửi JSON chuẩn
                        var statusResponse = await httpClient.PutAsJsonAsync($"api/app/nhanvien/update-status/{_selectedNhanVien.IdNhanVien}", new { newStatus = "Nghỉ việc" });
                        if (statusResponse.IsSuccessStatusCode)
                        {
                            MessageBox.Show("Đã cập nhật trạng thái thành 'Nghỉ việc'.", "Thành công");
                            await LoadDataGridAsync();
                            ResetForm();
                        }
                        else
                        {
                            MessageBox.Show("Lỗi khi cập nhật trạng thái.", "Lỗi API");
                        }
                    }
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion

        #region Navigation
        // ... (Toàn bộ region Navigation giữ nguyên) ...
        private void BtnGoToRoles_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new QuanLyVaiTroView());
        }
        private void BtnGoToBaoCao_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new BaoCaoNhanSuView());
        }
        private void BtnGoToLichLamViec_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new QuanLyLichLamViecView());
        }
        private void BtnGoToDonXinNghi_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new QuanLyDonXinNghiView());
        }/*
        private void BtnGoToLuong_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new QuanLyLuongView());
        }*/
        private void BtnGoToCaiDat_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new CaiDatNhanSuView());
        }
        private void BtnGoToHieuSuat_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new BaoCaoHieuSuatNhanVientPreviewWindow());
        }
        #endregion
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyNhapKhoView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyNhapKhoView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quản lý Nhập Kho" FontFamily="Segoe UI" Loaded="Page_Loaded"
      Background="#FFF8E1">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>

        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Quản lý Nhập Kho" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*"/>
                    <ColumnDefinition Width="3*"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Margin="10,0,15,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Text="Danh sách Phiếu nhập" Style="{StaticResource HeaderTextBlock}"/>

                        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,10">
                            <TextBlock Text="Từ:" VerticalAlignment="Center"/>
                            <DatePicker x:Name="dpTuNgay_Phieu" Width="120" Margin="5,0,0,0"/>
                            <TextBlock Text="Đến:" VerticalAlignment="Center" Margin="10,0,5,0"/>
                            <DatePicker x:Name="dpDenNgay_Phieu" Width="120" Margin="0,0,10,0"/>
                            <Button x:Name="btnLocPhieu" Content="Lọc" Style="{StaticResource PrimaryButton}" Padding="10,5" Click="BtnLocPhieu_Click" Width="50"/>
                        </StackPanel>

                        <DataGrid Grid.Row="2" x:Name="dgPhieuNhap" AutoGenerateColumns="False" IsReadOnly="True" 
                                  SelectionMode="Single" SelectionChanged="DgPhieuNhap_SelectionChanged" 
                                  BorderThickness="0" RowHeaderWidth="0">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ID" Binding="{Binding IdPhieuNhapKho}" Width="40"/>
                                <DataGridTextColumn Header="Ngày" Binding="{Binding NgayNhap, StringFormat='dd/MM/yyyy'}" Width="100"/>
                                <DataGridTextColumn Header="NCC" Binding="{Binding TenNhaCungCap}" Width="*"/>
                                <DataGridTextColumn Header="Tổng tiền" Binding="{Binding TongTien, StringFormat=N0}" Width="100"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>

                <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto" Margin="0,0,10,10">
                    <StackPanel>
                        <Border Style="{StaticResource CardBorder}">
                            <StackPanel>
                                <Grid Margin="0,0,0,15">
                                    <TextBlock Text="Thông tin Phiếu nhập" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" VerticalAlignment="Center" />
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                        <Button x:Name="btnTaoPhieuMoi" Style="{StaticResource PrimaryButton}" Click="BtnTaoPhieuMoi_Click" Padding="10,8">
                                            <StackPanel Orientation="Horizontal">
                                                <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                                    <Path Data="{StaticResource IconNew}" Fill="White"/>
                                                </Viewbox>
                                                <TextBlock Text="Tạo Phiếu Mới" VerticalAlignment="Center" Margin="0,1,0,0"/>
                                            </StackPanel>
                                        </Button>
                                    </StackPanel>
                                </Grid>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Ngày nhập:" VerticalAlignment="Center" Margin="0,5,15,5"/>
                                    <DatePicker Grid.Row="0" Grid.Column="1" x:Name="dpNgayNhap" Margin="0,5"/>
                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Nhà cung cấp:" VerticalAlignment="Center" Margin="0,5,15,5"/>
                                    <ComboBox Grid.Row="1" Grid.Column="1" x:Name="cmbNhaCungCap_PhieuNhap" Margin="0,5" DisplayMemberPath="TenNhaCungCap" SelectedValuePath="IdNhaCungCap"/>
                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Tổng tiền:" VerticalAlignment="Center" Margin="0,5,15,5"/>
                                    <TextBlock Grid.Row="2" Grid.Column="1" x:Name="lblTongTien" Margin="0,5" FontSize="16" FontWeight="Bold" Foreground="{StaticResource ActionRedBrush}" Text="0 VND"/>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <Border Style="{StaticResource CardBorder}" Margin="0,15,0,0">
                            <StackPanel>
                                <TextBlock Text="Chi tiết Nguyên liệu" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,10"/>

                                <Grid x:Name="panelNhapChiTiet" Margin="0,0,0,10" IsEnabled="False">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="80"/>
                                        <ColumnDefinition Width="100"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <ComboBox Grid.Column="0" x:Name="cmbNguyenLieu_PhieuNhap" DisplayMemberPath="TenNguyenLieu" SelectedValuePath="IdNguyenLieu" VerticalContentAlignment="Center"
                                              Margin="0,0,10,0" ToolTip="Chọn Nguyên Liệu"/>
                                    <TextBox Grid.Column="1" x:Name="txtSoLuongNL" Margin="0,0,10,0" ToolTip="Số lượng" VerticalContentAlignment="Center"/>
                                    <TextBox Grid.Column="2" x:Name="txtDonGiaNL" Margin="0,0,10,0" ToolTip="Đơn giá (theo ĐVT cơ bản)" VerticalContentAlignment="Center"/>
                                    <Button Grid.Column="3" x:Name="btnThemVaoPhieu" Style="{StaticResource PrimaryButton}" Click="BtnThemVaoPhieu_Click" Padding="8"
                                            Background="{StaticResource ActionBlueBrush}">
                                        <Viewbox Width="16" Height="16">
                                            <Path Data="{StaticResource IconAdd}" Fill="White"/>
                                        </Viewbox>
                                    </Button>
                                </Grid>

                                <DataGrid x:Name="dgChiTietPhieuNhap" AutoGenerateColumns="False" MaxHeight="250"
                                          CanUserAddRows="False" CanUserDeleteRows="True" IsReadOnly="True"
                                          SelectionChanged="DgChiTietPhieuNhap_SelectionChanged">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Tên Nguyên liệu" Binding="{Binding TenNguyenLieu}" Width="*" IsReadOnly="True"/>
                                        <DataGridTextColumn Header="Số lượng" Binding="{Binding SoLuongNhap, StringFormat=N2}" Width="80"/>
                                        <DataGridTextColumn Header="Đơn giá" Binding="{Binding DonGiaNhap, StringFormat=N0}" Width="100"/>
                                        <DataGridTextColumn Header="Thành tiền" Binding="{Binding ThanhTien, StringFormat=N0}" Width="100" IsReadOnly="True"/>
                                    </DataGrid.Columns>
                                </DataGrid>

                                <Button x:Name="btnLuuPhieuNhap" Margin="0,15,0,0" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionGreenBrush}" Click="BtnLuuPhieuNhap_Click">
                                    <StackPanel Orientation="Horizontal">
                                        <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                            <Path Data="{StaticResource IconSave}" Fill="White"/>
                                        </Viewbox>
                                        <TextBlock Text="Lưu Phiếu Nhập" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </Grid>

            <Button x:Name="btnQuayLai" Grid.Row="2" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" Margin="10,0,0,10"
                    Click="BtnQuayLai_Click">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="16" Height="16" Margin="0,0,5,0"/>
                    <TextBlock Text="Quay lại Tồn Kho" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Đang tải..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyNhapKhoView.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using System.Collections.ObjectModel;
using System.Globalization;
using AppCafebookApi.Services;

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyNhapKhoView : Page
    {
        private static readonly HttpClient httpClient;

        private List<PhieuNhapDto> _phieuNhapList = new List<PhieuNhapDto>();
        // SỬA ĐỔI: Dùng ChiTietPhieuNhapCreateDto vì nó có IdNguyenLieu
        private ObservableCollection<ChiTietPhieuNhapCreateDto> _chiTietPhieuNhapList = new ObservableCollection<ChiTietPhieuNhapCreateDto>();
        private PhieuNhapDto? _selectedPhieuNhap = null;
        private bool _isCreatingPhieuNhap = false;

        private List<NhaCungCapDto> _nhaCungCapList = new List<NhaCungCapDto>();
        private List<NguyenLieuCrudDto> _nguyenLieuList = new List<NguyenLieuCrudDto>();

        static QuanLyNhapKhoView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyNhapKhoView()
        {
            InitializeComponent();
            dpTuNgay_Phieu.SelectedDate = DateTime.Today.AddDays(-30);
            dpDenNgay_Phieu.SelectedDate = DateTime.Today;
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            await LoadNguyenLieuAsync();
            await LoadNhaCungCapAsync();
            await LoadPhieuNhapAsync();
            ResetPhieuNhapForm();
            LoadingOverlay.Visibility = Visibility.Collapsed;
        }

        #region Tải Dữ Liệu

        private async Task LoadNguyenLieuAsync()
        {
            try
            {
                _nguyenLieuList = (await httpClient.GetFromJsonAsync<List<NguyenLieuCrudDto>>("api/app/kho/nguyenlieu")) ?? new List<NguyenLieuCrudDto>();

                var nlList = _nguyenLieuList.Select(nl => new { nl.IdNguyenLieu, TenNguyenLieu = $"{nl.TenNguyenLieu} ({nl.DonViTinh})" }).ToList();
                nlList.Insert(0, new { IdNguyenLieu = 0, TenNguyenLieu = "-- Chọn Nguyên Liệu --" });

                // Gán cho ComboBox trong Form nhập
                cmbNguyenLieu_PhieuNhap.ItemsSource = nlList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải nguyên liệu: {ex.Message}", "Lỗi API");
            }
        }

        private async Task LoadNhaCungCapAsync()
        {
            try
            {
                _nhaCungCapList = (await httpClient.GetFromJsonAsync<List<NhaCungCapDto>>("api/app/kho/nhacungcap")) ?? new List<NhaCungCapDto>();

                var nccList = _nhaCungCapList.Select(ncc => new { ncc.IdNhaCungCap, ncc.TenNhaCungCap }).ToList();
                nccList.Insert(0, new { IdNhaCungCap = 0, TenNhaCungCap = "Nhập lẻ (Không NCC)" });
                cmbNhaCungCap_PhieuNhap.ItemsSource = nccList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải nhà cung cấp: {ex.Message}", "Lỗi API");
            }
        }

        private async Task LoadPhieuNhapAsync()
        {
            DateTime? start = dpTuNgay_Phieu.SelectedDate;
            DateTime? end = dpDenNgay_Phieu.SelectedDate;

            try
            {
                string url = "api/app/kho/phieunhap";
                if (start.HasValue && end.HasValue)
                {
                    url += $"?startDate={start.Value:yyyy-MM-dd}&endDate={end.Value:yyyy-MM-dd}";
                }

                _phieuNhapList = (await httpClient.GetFromJsonAsync<List<PhieuNhapDto>>(url)) ?? new List<PhieuNhapDto>();
                dgPhieuNhap.ItemsSource = _phieuNhapList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải phiếu nhập: {ex.Message}", "Lỗi API");
            }
        }

        #endregion

        #region TAB 3: NHẬP KHO

        private void ResetPhieuNhapForm()
        {
            _selectedPhieuNhap = null;
            _isCreatingPhieuNhap = false;
            dgPhieuNhap.SelectedItem = null;

            dpNgayNhap.SelectedDate = DateTime.Today;
            cmbNhaCungCap_PhieuNhap.SelectedValue = 0;
            lblTongTien.Text = "0 VND";

            _chiTietPhieuNhapList.Clear();
            dgChiTietPhieuNhap.ItemsSource = null; // Xóa ItemsSource

            btnLuuPhieuNhap.IsEnabled = false;
            panelNhapChiTiet.IsEnabled = false; // Tắt panel nhập
        }

        private void BtnTaoPhieuMoi_Click(object sender, RoutedEventArgs e)
        {
            ResetPhieuNhapForm();
            _isCreatingPhieuNhap = true;
            btnLuuPhieuNhap.IsEnabled = true;
            panelNhapChiTiet.IsEnabled = true; // Bật panel nhập

            // Gán ItemsSource là list rỗng
            dgChiTietPhieuNhap.ItemsSource = _chiTietPhieuNhapList;
        }

        private async void BtnLocPhieu_Click(object sender, RoutedEventArgs e)
        {
            await LoadPhieuNhapAsync();
        }

        private async void DgPhieuNhap_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgPhieuNhap.SelectedItem is not PhieuNhapDto selected)
            {
                ResetPhieuNhapForm();
                return;
            }

            _selectedPhieuNhap = selected;
            _isCreatingPhieuNhap = false;
            btnLuuPhieuNhap.IsEnabled = false;
            panelNhapChiTiet.IsEnabled = false; // Tắt panel nhập

            try
            {
                var details = await httpClient.GetFromJsonAsync<List<ChiTietPhieuNhapDto>>($"api/app/kho/phieunhap/{selected.IdPhieuNhapKho}");

                // Chuyển đổi DTO chi tiết sang DTO tạo (để DataGrid hiển thị)
                _chiTietPhieuNhapList = new ObservableCollection<ChiTietPhieuNhapCreateDto>(
                    details?.Select(d => new ChiTietPhieuNhapCreateDto
                    {
                        IdNguyenLieu = d.IdNguyenLieu,
                        SoLuongNhap = d.SoLuongNhap,
                        DonGiaNhap = d.DonGiaNhap
                    }) ?? new List<ChiTietPhieuNhapCreateDto>()
                );

                dgChiTietPhieuNhap.ItemsSource = _chiTietPhieuNhapList;
                CalculateTotal(); // Tính tổng

                dpNgayNhap.SelectedDate = selected.NgayNhap;
                var ncc = _nhaCungCapList.FirstOrDefault(n => n.TenNhaCungCap == selected.TenNhaCungCap);
                cmbNhaCungCap_PhieuNhap.SelectedValue = ncc?.IdNhaCungCap ?? 0;

                lblTongTien.Text = selected.TongTien.ToString("N0") + " VND";
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải chi tiết phiếu: {ex.Message}", "Lỗi API");
            }
        }

        // --- SỬA LỖI: Thay thế BtnThemDong và CellEditEnding ---

        private void BtnThemVaoPhieu_Click(object sender, RoutedEventArgs e)
        {
            if (!_isCreatingPhieuNhap) return;

            if (cmbNguyenLieu_PhieuNhap.SelectedValue == null || (int)cmbNguyenLieu_PhieuNhap.SelectedValue == 0)
            {
                MessageBox.Show("Vui lòng chọn một nguyên liệu.", "Lỗi"); return;
            }
            if (!decimal.TryParse(txtSoLuongNL.Text, NumberStyles.Any, CultureInfo.InvariantCulture, out decimal soLuong) || soLuong <= 0)
            {
                MessageBox.Show("Số lượng phải là số dương.", "Lỗi"); return;
            }
            if (!decimal.TryParse(txtDonGiaNL.Text, NumberStyles.Any, CultureInfo.InvariantCulture, out decimal donGia) || donGia < 0)
            {
                MessageBox.Show("Đơn giá không hợp lệ.", "Lỗi"); return;
            }

            int idNguyenLieu = (int)cmbNguyenLieu_PhieuNhap.SelectedValue;

            // Kiểm tra xem đã tồn tại chưa
            var existingItem = _chiTietPhieuNhapList.FirstOrDefault(i => i.IdNguyenLieu == idNguyenLieu);
            if (existingItem != null)
            {
                // Cập nhật
                existingItem.SoLuongNhap += soLuong;
                existingItem.DonGiaNhap = donGia; // Cập nhật đơn giá mới
            }
            else
            {
                // Thêm mới
                _chiTietPhieuNhapList.Add(new ChiTietPhieuNhapCreateDto
                {
                    IdNguyenLieu = idNguyenLieu,
                    SoLuongNhap = soLuong,
                    DonGiaNhap = donGia
                });
            }

            RefreshDataGrid();
            ResetInputFields();
        }

        private void DgChiTietPhieuNhap_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            // Cho phép xóa khi đang tạo phiếu
            if (_isCreatingPhieuNhap && dgChiTietPhieuNhap.SelectedItem is ChiTietPhieuNhapCreateDto selectedItem)
            {
                if (MessageBox.Show($"Bạn có muốn xóa '{selectedItem.IdNguyenLieu}' khỏi phiếu nhập?", "Xác nhận", MessageBoxButton.YesNo) == MessageBoxResult.Yes)
                {
                    _chiTietPhieuNhapList.Remove(selectedItem);
                    RefreshDataGrid();
                }
                dgChiTietPhieuNhap.SelectedItem = null;
            }
        }

        private void DgChiTietPhieuNhap_CellEditEnding(object sender, DataGridCellEditEndingEventArgs e)
        {
            // Dùng Dispatcher.BeginInvoke để Refresh SAU KHI edit kết thúc
            Dispatcher.BeginInvoke(new Action(() =>
            {
                // Tính toán lại tổng tiền từ danh sách nguồn
                decimal tongTien = 0;
                foreach (var item in _chiTietPhieuNhapList)
                {
                    tongTien += (item.SoLuongNhap * item.DonGiaNhap);
                }
                lblTongTien.Text = tongTien.ToString("N0") + " VND";

                // Nạp lại DataGrid (cách an toàn nhất)
                RefreshDataGrid();

            }), System.Windows.Threading.DispatcherPriority.ContextIdle);
        }

        private void ResetInputFields()
        {
            cmbNguyenLieu_PhieuNhap.SelectedValue = 0;
            txtSoLuongNL.Text = "";
            txtDonGiaNL.Text = "";
        }

        // Hàm này phải tồn tại trong QuanLyNhapKhoView.xaml.cs
        private void RefreshDataGrid()
        {
            dgChiTietPhieuNhap.ItemsSource = null;

            // Gán lại tên (vì DTO create không có tên)
            var displayList = _chiTietPhieuNhapList.Select(ct => new
            {
                ct.IdNguyenLieu,
                // Thêm kiểm tra null cho _nguyenLieuList
                TenNguyenLieu = _nguyenLieuList?.FirstOrDefault(nl => nl.IdNguyenLieu == ct.IdNguyenLieu)?.TenNguyenLieu ?? "...",
                ct.SoLuongNhap,
                ct.DonGiaNhap,
                ThanhTien = ct.SoLuongNhap * ct.DonGiaNhap
            }).ToList();

            dgChiTietPhieuNhap.ItemsSource = displayList;
            CalculateTotal();
        }

        private void CalculateTotal()
        {
            decimal tongTien = _chiTietPhieuNhapList.Sum(item => item.SoLuongNhap * item.DonGiaNhap);
            lblTongTien.Text = tongTien.ToString("N0") + " VND";
        }

        // --- HẾT PHẦN SỬA LỖI ---


        private async void BtnLuuPhieuNhap_Click(object sender, RoutedEventArgs e)
        {
            if (!_isCreatingPhieuNhap || _chiTietPhieuNhapList.Count == 0)
            {
                MessageBox.Show("Vui lòng 'Tạo Phiếu Mới' và 'Thêm Dòng' nguyên liệu trước khi lưu.", "Lỗi");
                return;
            }
            if (AuthService.CurrentUser == null)
            {
                MessageBox.Show("Lỗi phiên đăng nhập. Vui lòng đăng nhập lại.", "Lỗi");
                return;
            }

            var dto = new PhieuNhapCreateDto
            {
                IdNhanVien = AuthService.CurrentUser.IdNhanVien,
                IdNhaCungCap = (int)cmbNhaCungCap_PhieuNhap.SelectedValue > 0 ? (int)cmbNhaCungCap_PhieuNhap.SelectedValue : null,
                NgayNhap = dpNgayNhap.SelectedDate ?? DateTime.Today,
                GhiChu = null,
                ChiTiet = _chiTietPhieuNhapList.Where(ct => ct.IdNguyenLieu > 0 && ct.SoLuongNhap > 0)
                                               .Select(ct => new ChiTietPhieuNhapCreateDto
                                               {
                                                   IdNguyenLieu = ct.IdNguyenLieu,
                                                   SoLuongNhap = ct.SoLuongNhap,
                                                   DonGiaNhap = ct.DonGiaNhap
                                               }).ToList()
            };

            if (!dto.ChiTiet.Any())
            {
                MessageBox.Show("Phiếu nhập phải có ít nhất 1 nguyên liệu hợp lệ.", "Lỗi");
                return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/kho/phieunhap", dto);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Lưu phiếu nhập kho thành công!", "Thông báo");
                    await LoadPhieuNhapAsync(); // Tải lại lưới phiếu nhập
                    ResetPhieuNhapForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService?.CanGoBack == true)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyPhatLuongView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyPhatLuongView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quản lý Phát Lương"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" 
Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionOrangeBrush" Color="#FFA726"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="PrimaryBrown" Color="#6F4E37"/>
        <SolidColorBrush x:Key="AccentOrange" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" 
Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteText" Color="#FFFFFF"/>

        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>
        <Geometry x:Key="IconSearch">M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L21.5,20L20,21.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z</Geometry>
        <Geometry x:Key="IconView">M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" 
Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrown}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteText}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Height" 
Value="42"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                CornerRadius="21"
                                Background="{TemplateBinding 
Background}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="2" Color="#6F4E37" Opacity="0.3" 
BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource 
AccentOrange}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" 
Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                                <Setter TargetName="border" Property="Opacity" Value="0.7"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" 
Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" 
Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>

        <Style x:Key="IconDataGridButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="15">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="{StaticResource SubtleGrayBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
            <TextBlock Text="Phát Lương &amp; Phiếu Lương Đã Chốt" Style="{StaticResource HeaderTextBlock}" VerticalAlignment="Center" Margin="0,0,0,0"/>
        </StackPanel>

        <Border Grid.Row="1" Style="{StaticResource CardBorder}" Margin="0,0,0,15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <TextBlock Text="Lọc theo kỳ:" VerticalAlignment="Center" FontWeight="SemiBold" Margin="0,0,15,0"/>

                <TextBlock Grid.Column="1" Text="Tháng:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                <ComboBox Grid.Column="2" x:Name="cmbThang" Width="100"/>

                <TextBlock Grid.Column="3" Text="Năm:" VerticalAlignment="Center" Margin="20,0,5,0"/>
                <ComboBox Grid.Column="4" x:Name="cmbNam" Width="100"/>

                <Button Grid.Column="5" x:Name="btnLoc" Style="{StaticResource PrimaryButton}" Click="BtnLoc_Click" HorizontalAlignment="Left" Margin="20,0,0,0" Width="100" Height="38" Padding="0">
                    <StackPanel Orientation="Horizontal">
                        <Path Data="{StaticResource IconSearch}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                        <TextBlock Text="Lọc" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
            </Grid>
        </Border>

        <Border Grid.Row="2" Style="{StaticResource CardBorder}" Padding="0">
            <DataGrid x:Name="dgPhieuLuong" AutoGenerateColumns="False" IsReadOnly="True" 
                      SelectionMode="Single"
                      BorderThickness="0" RowHeaderWidth="0" 
                      Background="White"
                      RowStyle="{StaticResource {x:Type DataGridRow}}"
                      CellStyle="{StaticResource {x:Type DataGridCell}}"
                      ColumnHeaderStyle="{StaticResource {x:Type DataGridColumnHeader}}">

                <DataGrid.Columns>
                    <DataGridTextColumn Header="Nhân viên" Binding="{Binding HoTenNhanVien}" Width="2*"/>
                    <DataGridTextColumn Header="Kỳ Lương" Width="Auto">
                        <DataGridTextColumn.Binding>
                            <MultiBinding StringFormat="{}{0}/{1}">
                                <Binding Path="Thang"/>
                                <Binding Path="Nam"/>
                            </MultiBinding>
                        </DataGridTextColumn.Binding>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="Tổng Giờ" Binding="{Binding TongGioLam, StringFormat=F2}" Width="Auto"/>
                    <DataGridTextColumn Header="Thực Lãnh" Binding="{Binding ThucLanh, StringFormat=N0}" Width="1.2*"/>
                    <DataGridTextColumn Header="Ngày Chốt" Binding="{Binding NgayChot, StringFormat='dd/MM/yyyy HH:mm'}" Width="1.5*"/>

                    <DataGridTemplateColumn Header="Trạng Thái" Width="1.2*">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding TrangThai}" FontWeight="SemiBold" VerticalAlignment="Center" HorizontalAlignment="Left" Margin="10,0,0,0">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding TrangThai}" Value="Đã phát">
                                                    <Setter Property="Foreground" Value="{StaticResource SuccessBrush}"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding TrangThai}" Value="Đã chốt">
                                                    <Setter Property="Foreground" Value="{StaticResource ActionOrangeBrush}"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTemplateColumn Header="Xem" Width="60">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Button x:Name="btnXemChiTiet" Style="{StaticResource IconDataGridButton}" ToolTip="Xem chi tiết &amp; Phát lương" 
                                        Click="BtnXemChiTiet_Click">
                                    <Path Data="{StaticResource IconView}" Fill="{StaticResource ActionBlueBrush}" Width="23" Height="23"/>
                                </Button>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </Border>

        <Button x:Name="btnQuayLai" Grid.Row="3" 
                Style="{StaticResource BackButton}"
                HorizontalAlignment="Left" Margin="0,10,0,0"
                Click="BtnQuayLai_Click">
            <StackPanel Orientation="Horizontal">
                <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                <TextBlock Text="Quay lại" VerticalAlignment="Center"/>
            </StackPanel>
        </Button>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Đang tải dữ liệu..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyPhatLuongView.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using AppCafebookApi.Services; // Cần cho AuthService
using AppCafebookApi.View.Common; // Cần cho PhieuLuongPreviewWindow
using CafebookModel.Model.ModelApp; // Cần cho DTOs

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyPhatLuongView : Page
    {
        private static readonly HttpClient httpClient;

        static QuanLyPhatLuongView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyPhatLuongView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await SetupFiltersAsync();
            await LoadDanhSachPhieuLuongAsync();
        }

        private Task SetupFiltersAsync()
        {
            // Setup Tháng
            cmbThang.ItemsSource = Enumerable.Range(1, 12).Select(m => new { Value = m, Display = $"Tháng {m}" });
            cmbThang.DisplayMemberPath = "Display";
            cmbThang.SelectedValuePath = "Value";
            cmbThang.SelectedValue = DateTime.Now.Month;

            // Setup Năm
            int currentYear = DateTime.Now.Year;
            cmbNam.ItemsSource = Enumerable.Range(currentYear - 2, 5).Select(y => new { Value = y, Display = $"Năm {y}" });
            cmbNam.DisplayMemberPath = "Display";
            cmbNam.SelectedValuePath = "Value";
            cmbNam.SelectedValue = currentYear;

            return Task.CompletedTask;
        }

        private async Task LoadDanhSachPhieuLuongAsync()
        {
            if (cmbThang.SelectedValue == null || cmbNam.SelectedValue == null)
                return;

            int thang = (int)cmbThang.SelectedValue;
            int nam = (int)cmbNam.SelectedValue;

            LoadingOverlay.Visibility = Visibility.Visible;
            dgPhieuLuong.ItemsSource = null;

            try
            {
                var response = await httpClient.GetAsync($"api/app/phatluong/danhsach?thang={thang}&nam={nam}");

                if (response.IsSuccessStatusCode)
                {
                    var data = await response.Content.ReadFromJsonAsync<List<PhieuLuongDto>>();
                    dgPhieuLuong.ItemsSource = data;
                }
                else
                {
                    MessageBox.Show($"Lỗi tải danh sách: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnLoc_Click(object sender, RoutedEventArgs e)
        {
            await LoadDanhSachPhieuLuongAsync();
        }

        private async void BtnXemChiTiet_Click(object sender, RoutedEventArgs e)
        {
            if ((sender as Button)?.DataContext is not PhieuLuongDto selectedPhieu)
                return;

            // Mở Window popup và truyền ID
            var popup = new PhieuLuongPreviewWindow(selectedPhieu.IdPhieuLuong);

            // ShowDialog để chặn tương tác với cửa sổ chính
            // DialogResult sẽ là 'true' nếu người dùng nhấn "Xác nhận Phát Lương" thành công
            bool? result = popup.ShowDialog();

            if (result == true)
            {
                // Nếu phát lương thành công, tải lại danh sách để cập nhật trạng thái
                await LoadDanhSachPhieuLuongAsync();
            }
        }

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyPhuThuView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyPhuThuView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="QuanLyPhuThuView" FontFamily="Segoe UI" Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>

        <Geometry x:Key="IconBack">M15.41,16.59L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.59Z</Geometry>

        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Opacity" Value="0.8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}">
                            <ContentPresenter VerticalAlignment="Center" HorizontalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Opacity" Value="1"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>

        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Grid Grid.Row="0" Margin="15,15,15,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="350"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Background="{StaticResource WhiteTextBrush}" CornerRadius="8" Padding="20">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,15">
                        <TextBlock Text="Quản lý Phụ thu" Style="{StaticResource HeaderTextBlock}" Margin="0"/>
                        <Button x:Name="btnThemMoi" Content="Thêm mới" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionGreenBrush}" VerticalAlignment="Center" Margin="20,0,0,0" Click="BtnThemMoi_Click"/>
                    </StackPanel>

                    <DataGrid Grid.Row="1" x:Name="dgPhuThu" AutoGenerateColumns="False" IsReadOnly="True" 
                              SelectionMode="Single" SelectionChanged="DgPhuThu_SelectionChanged"
                              BorderThickness="0" RowHeaderWidth="0">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="ID" Binding="{Binding IdPhuThu}" Width="50"/>
                            <DataGridTextColumn Header="Tên Phụ thu" Binding="{Binding TenPhuThu}" Width="*"/>
                            <DataGridTextColumn Header="Giá trị" Binding="{Binding GiaTri, StringFormat=N0}" Width="100"/>
                            <DataGridTextColumn Header="Loại" Binding="{Binding LoaiGiaTri}" Width="70"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Border>

            <Border Grid.Column="1" Background="{StaticResource WhiteTextBrush}" CornerRadius="8" Margin="15,0,0,0" Padding="20">
                <StackPanel x:Name="formPanel">
                    <TextBlock x:Name="lblFormTitle" Text="Thêm Phụ thu mới" Style="{StaticResource HeaderTextBlock}"/>
                    <TextBox x:Name="txtIdPhuThu" Text="0" Visibility="Collapsed"/>
                    <TextBlock Text="Tên Phụ thu:" FontWeight="SemiBold" Margin="0,0,0,5"/>
                    <TextBox x:Name="txtTenPhuThu" Padding="8" Margin="0,0,0,15"/>
                    <TextBlock Text="Loại Giá trị:" FontWeight="SemiBold" Margin="0,0,0,5"/>
                    <ComboBox x:Name="cmbLoaiGiaTri" Padding="8" Margin="0,0,0,15" SelectedIndex="0">
                        <ComboBoxItem Content="VND"/>
                        <ComboBoxItem Content="%"/>
                    </ComboBox>
                    <TextBlock Text="Giá trị:" FontWeight="SemiBold" Margin="0,0,0,5"/>
                    <TextBox x:Name="txtGiaTri" Padding="8" Margin="0,0,0,20"/>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button x:Name="btnHuy" Content="Hủy" Style="{StaticResource PrimaryButton}" 
                                Background="White" Foreground="{StaticResource TextGrayBrush}" 
                                BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="1" 
                                Width="80" Margin="0,0,10,0" Click="BtnHuy_Click"/>

                        <Button x:Name="btnXoa" Content="Xóa" Style="{StaticResource PrimaryButton}" 
                                Background="{StaticResource ActionRedBrush}" 
                                Width="80" Margin="0,0,10,0" Click="BtnXoa_Click" IsEnabled="False"/>

                        <Button x:Name="btnLuu" Content="Thêm" Style="{StaticResource PrimaryButton}" 
                                Background="{StaticResource ActionGreenBrush}" 
                                Width="100" Click="BtnLuu_Click"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>

        <Button x:Name="btnQuayLai" Grid.Row="1" 
                Style="{StaticResource BackButton}"
                HorizontalAlignment="Left" Margin="25,10,0,10"
                Click="BtnQuayLai_Click">
            <StackPanel Orientation="Horizontal">
                <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                <TextBlock Text="Quay lại" VerticalAlignment="Center" FontSize="14"/>
            </StackPanel>
        </Button>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyPhuThuView.xaml.cs
================================================================================
﻿using CafebookModel.Model.Entities;
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Net;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyPhuThuView : Page
    {
        private static readonly HttpClient httpClient;
        private ObservableCollection<PhuThu> _phuThuCollection = new ObservableCollection<PhuThu>();
        private PhuThu? _selectedPhuThu;

        static QuanLyPhuThuView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyPhuThuView()
        {
            InitializeComponent();
            dgPhuThu.ItemsSource = _phuThuCollection;
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadDataGridAsync();
            ResetForm();
        }

        private async Task LoadDataGridAsync()
        {
            try
            {
                var phuThus = await httpClient.GetFromJsonAsync<List<PhuThu>>("api/app/quanly/phuthu");
                if (phuThus != null)
                {
                    _phuThuCollection.Clear();
                    foreach (var item in phuThus.OrderBy(p => p.TenPhuThu))
                    {
                        _phuThuCollection.Add(item);
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải danh sách phụ thu: {ex.Message}", "Lỗi API");
            }
        }

        private void ResetForm()
        {
            _selectedPhuThu = null;
            dgPhuThu.SelectedItem = null;
            lblFormTitle.Text = "Thêm Phụ thu mới";
            txtIdPhuThu.Text = "0";
            txtTenPhuThu.Clear();
            txtGiaTri.Text = "0";
            cmbLoaiGiaTri.SelectedIndex = 0; // "VND"
            btnLuu.Content = "Thêm";
            btnXoa.IsEnabled = false;
        }

        private void BtnThemMoi_Click(object sender, RoutedEventArgs e)
        {
            ResetForm();
        }

        private void DgPhuThu_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgPhuThu.SelectedItem is PhuThu selected)
            {
                _selectedPhuThu = selected;
                lblFormTitle.Text = "Sửa Phụ thu";
                txtIdPhuThu.Text = selected.IdPhuThu.ToString();
                txtTenPhuThu.Text = selected.TenPhuThu;
                txtGiaTri.Text = selected.GiaTri.ToString();
                cmbLoaiGiaTri.SelectedValue = selected.LoaiGiaTri; // Giả định ComboBoxItem Content khớp

                btnLuu.Content = "Lưu";
                btnXoa.IsEnabled = true;
            }
        }

        private void BtnHuy_Click(object sender, RoutedEventArgs e)
        {
            ResetForm();
        }

        private async void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            // --- Validation ---
            if (string.IsNullOrWhiteSpace(txtTenPhuThu.Text))
            {
                MessageBox.Show("Tên phụ thu không được để trống.", "Lỗi");
                return;
            }
            if (!decimal.TryParse(txtGiaTri.Text, out decimal giaTri))
            {
                MessageBox.Show("Giá trị phải là một con số.", "Lỗi");
                return;
            }

            // --- Tạo đối tượng ---
            var phuThu = new PhuThu
            {
                IdPhuThu = int.Parse(txtIdPhuThu.Text),
                TenPhuThu = txtTenPhuThu.Text,
                GiaTri = giaTri,
                LoaiGiaTri = (cmbLoaiGiaTri.SelectedItem as ComboBoxItem)?.Content.ToString() ?? "VND"
            };

            try
            {
                if (phuThu.IdPhuThu == 0) // THÊM MỚI
                {
                    var response = await httpClient.PostAsJsonAsync("api/app/quanly/phuthu", phuThu);
                    if (response.IsSuccessStatusCode)
                    {
                        var newItem = await response.Content.ReadFromJsonAsync<PhuThu>();
                        if (newItem != null) _phuThuCollection.Add(newItem);
                        MessageBox.Show("Thêm phụ thu thành công!", "Thông báo");
                    }
                    else
                    {
                        MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                    }
                }
                else // CẬP NHẬT
                {
                    var response = await httpClient.PutAsJsonAsync($"api/app/quanly/phuthu/{phuThu.IdPhuThu}", phuThu);
                    if (response.IsSuccessStatusCode)
                    {
                        // Cập nhật item trong list (cách đơn giản là tải lại)
                        await LoadDataGridAsync();
                        MessageBox.Show("Cập nhật thành công!", "Thông báo");
                    }
                    else
                    {
                        MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                    }
                }
                ResetForm();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
        }

        private async void BtnXoa_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedPhuThu == null) return;

            var result = MessageBox.Show($"Bạn có chắc chắn muốn XÓA phụ thu '{_selectedPhuThu.TenPhuThu}' không?",
                                         "Xác nhận Xóa", MessageBoxButton.YesNo, MessageBoxImage.Warning);

            if (result == MessageBoxResult.No) return;

            try
            {
                var response = await httpClient.DeleteAsync($"api/app/quanly/phuthu/{_selectedPhuThu.IdPhuThu}");

                if (response.IsSuccessStatusCode)
                {
                    _phuThuCollection.Remove(_selectedPhuThu);
                    MessageBox.Show("Xóa thành công!", "Thông báo");
                    ResetForm();
                }
                else if (response.StatusCode == HttpStatusCode.Conflict)
                {
                    // Lỗi 409: Đã được sử dụng (theo logic controller)
                    string errorMessage = await response.Content.ReadAsStringAsync();
                    MessageBox.Show(errorMessage, "Không thể xóa");
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
        }

        // ### THÊM HÀM MỚI NÀY VÀO CUỐI FILE ###
        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLySachView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLySachView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      xmlns:common="clr-namespace:AppCafebookApi.View.common"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="QuanLySachView"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="BackgroundHoverBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="BackgroundSelectedBrush" Color="#EFEBE9"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>

        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconClearFilter">M14.12,12.5L19.31,7.31L17.89,5.89L12.71,11.08L7.5,5.89L6.09,7.31L11.28,12.5L6.09,17.69L7.5,19.11L12.71,13.92L17.89,19.11L19.31,17.69L14.12,12.5M3,5H21V3H3V5Z</Geometry>
        <Geometry x:Key="IconUpload">M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z</Geometry>
        <Geometry x:Key="IconReport">M10,17L6,21H18L14,17H10M10,10H14V15H10V10M4,3H20C21.1,3 22,3.9 22,5V17C22,18.1 21.1,19 20,19H4C2.9,19 2,18.1 2,17V5C2,3.9 2.9,3 4,3Z</Geometry>
        <Geometry x:Key="IconSettings">M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M12,22C11.6,22 11.2,21.9 10.8,21.7L9.1,20.9C5.1,19.3 2,15.2 2,10.9V5L12,2L22,5V10.9C22,15.2 18.9,19.3 14.9,20.9L13.2,21.7C12.8,21.9 12.4,22 12,22Z</Geometry>

        <Style x:Key="ActionButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,10"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="4" Padding="{TemplateBinding Padding}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.1" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.8"/>
                                <Setter TargetName="border" Property="Effect" Value="{x:Null}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="DeleteButton" TargetType="Button" BasedOn="{StaticResource ActionButton}">
            <Setter Property="Background" Value="{StaticResource ErrorBrush}"/>
        </Style>
        <Style x:Key="MaterialIconButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="20">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BackgroundHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="Label">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,15,0,5"/>
        </Style>
        <Style x:Key="MaterialTextBox" TargetType="TextBox">
            <Setter Property="Padding" Value="8,10"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TextBox">
                        <Border x:Name="border" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}">
                            <ScrollViewer x:Name="PART_ContentHost" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsKeyboardFocused" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="BorderThickness" Value="0,0,0,2"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="MaterialComboBox" TargetType="ComboBox">
            <Setter Property="Padding" Value="8,10"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="SearchTextBox" TargetType="TextBox" BasedOn="{StaticResource MaterialTextBox}">
            <Setter Property="Padding" Value="8,8"/>
        </Style>
        <Style x:Key="FilterComboBox" TargetType="ComboBox" BasedOn="{StaticResource MaterialComboBox}">
            <Setter Property="Padding" Value="8,8"/>
        </Style>
        <Style TargetType="TabControl">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
        <Style TargetType="TabItem">
            <Setter Property="Background" Value="#E0E0E0"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border x:Name="border" BorderThickness="0,0,0,3" BorderBrush="Transparent" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" Margin="0,0,5,0">
                            <ContentPresenter ContentSource="Header" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="Background" Value="White"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
                                <Setter TargetName="border" Property="Background" Value="#F5F5F5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BookCoverImage" TargetType="Image">
            <Setter Property="Width" Value="120"/>
            <Setter Property="Height" Value="160"/>
            <Setter Property="Stretch" Value="UniformToFill"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
        </Style>

        <Style x:Key="AddHelperComboBox" TargetType="ComboBox" BasedOn="{StaticResource MaterialComboBox}">
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="IsTextSearchEnabled" Value="True"/>
            <Setter Property="IsEditable" Value="True"/>
        </Style>
    </Page.Resources>

    <Grid Opacity="1" x:Name="MainGrid">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="470"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Background="White" CornerRadius="8" Margin="10">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
            </Border.Effect>

            <TabControl Margin="5">
                <TabItem Header="Quản lý Sách">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10,5,10,10">
                            <TextBlock Text="Tìm kiếm:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                            <TextBox x:Name="txtSearchSach" Width="200" Style="{StaticResource SearchTextBox}" TextChanged="TxtSearchSach_TextChanged"/>
                            <TextBlock Text="Thể loại:" VerticalAlignment="Center" Margin="15,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                            <ComboBox x:Name="cmbFilterTheLoai" Width="180" DisplayMemberPath="Ten" SelectedValuePath="Id" Margin="5"
                                      Style="{StaticResource FilterComboBox}" SelectionChanged="CmbFilterTheLoai_SelectionChanged"/>
                            <Button x:Name="btnClearFilter" ToolTip="Xóa Lọc" Style="{StaticResource MaterialIconButton}" 
                                    Click="BtnClearFilter_Click" Margin="5,0,0,0">
                                <Path Data="{StaticResource IconClearFilter}" Fill="{StaticResource TextGrayBrush}" Width="20" Height="20"/>
                            </Button>
                        </StackPanel>
                        <DataGrid Grid.Row="1" x:Name="dgSach" AutoGenerateColumns="False" IsReadOnly="True"
                                  SelectionMode="Single" SelectionChanged="DgSach_SelectionChanged"
                                  BorderThickness="0" RowHeaderWidth="0" Margin="10,0,10,10">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ID" Binding="{Binding IdSach}" Width="50"/>
                                <DataGridTextColumn Header="Tên Sách" Binding="{Binding TenSach}" Width="*"/>
                                <DataGridTextColumn Header="Tác Giả" Binding="{Binding TenTacGia}" Width="180"/>
                                <DataGridTextColumn Header="Thể Loại" Binding="{Binding TenTheLoai}" Width="150"/>
                                <DataGridTextColumn Header="Vị trí" Binding="{Binding ViTri}" Width="80"/>
                                <DataGridTextColumn Header="Tổng SL" Binding="{Binding SoLuongTong}" Width="80"/>
                                <DataGridTextColumn Header="Đang Thuê" Binding="{Binding SoLuongDangMuon}" Width="80"/>
                                <DataGridTextColumn Header="Còn Lại" Binding="{Binding SoLuongHienCo}" Width="80"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </TabItem>

                <TabItem Header="Lịch sử &amp; Trễ hạn">
                    <Grid Margin="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <StackPanel Grid.Row="0" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,0,10">
                            <Button x:Name="btnCaiDatPhiThue"
                                    Style="{StaticResource ActionButton}" Background="{StaticResource TextGrayBrush}"
                                    Click="BtnCaiDatPhiThue_Click" Margin="0,0,10,0">
                                <StackPanel Orientation="Horizontal">
                                    <Path Data="{StaticResource IconSettings}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                    <TextBlock Text="Cài đặt Phí thuê" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>

                            <Button x:Name="btnXemBaoCaoSach"
                                    Style="{StaticResource ActionButton}" Background="#42A5F5"
                                    Click="BtnXemBaoCaoSach_Click">
                                <StackPanel Orientation="Horizontal">
                                    <Path Data="{StaticResource IconReport}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                    <TextBlock Text="Xem Báo Cáo Tồn Kho Sách" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </StackPanel>

                        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,10">
                            <TextBlock Text="Từ ngày:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                            <DatePicker x:Name="dpTuNgay" Width="120" Margin="0,0,10,0"/>
                            <TextBlock Text="Đến ngày:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                            <DatePicker x:Name="dpDenNgay" Width="120" Margin="0,0,10,0"/>
                            <Button x:Name="btnLocNgay" Content="Lọc" Click="BtnLocNgay_Click" Style="{StaticResource ActionButton}" Padding="10,5" Margin="0,0,5,0"/>
                            <Button x:Name="btnLamMoiLichSu" Content="Làm mới" Click="BtnLamMoiLichSu_Click" Style="{StaticResource ActionButton}" Background="{StaticResource TextGrayBrush}" Padding="10,5"/>
                        </StackPanel>

                        <TabControl Grid.Row="2">
                            <TabItem Header="Sách Quá Hạn">
                                <DataGrid x:Name="dgSachQuaHan" AutoGenerateColumns="False" IsReadOnly="True" BorderThickness="0" RowHeaderWidth="0">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Tên Sách" Binding="{Binding TenSach}" Width="*"/>
                                        <DataGridTextColumn Header="Khách hàng" Binding="{Binding HoTen}" Width="150"/>
                                        <DataGridTextColumn Header="SĐT" Binding="{Binding SoDienThoai}" Width="100"/>
                                        <DataGridTextColumn Header="Ngày Hẹn Trả" Binding="{Binding NgayHenTra, StringFormat='dd/MM/yyyy'}" Width="100"/>
                                        <DataGridTextColumn Header="Trạng thái" Binding="{Binding TinhTrang}" Width="100"/>

                                        <DataGridTemplateColumn Header="Hành động" Width="150">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                        <Button Content="Liên hệ" Tag="{Binding}" Click="BtnLienHe_Click" Style="{StaticResource ActionButton}" Background="#42A5F5" FontSize="10" Padding="8,4" Margin="0,0,5,0"/>
                                                        <Button Content="Gia hạn" Tag="{Binding}" Click="BtnGiaHan_Click" Style="{StaticResource ActionButton}" Background="#FFB74D" Foreground="{StaticResource DarkBrownBrush}" FontSize="10" Padding="8,4"/>
                                                    </StackPanel>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </TabItem>
                            <TabItem Header="Lịch sử Thuê (Mới nhất)">
                                <DataGrid x:Name="dgLichSuThue" AutoGenerateColumns="False" IsReadOnly="True" BorderThickness="0" RowHeaderWidth="0">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Tên Sách" Binding="{Binding TenSach}" Width="*"/>
                                        <DataGridTextColumn Header="Khách hàng" Binding="{Binding TenKhachHang}" Width="150"/>
                                        <DataGridTextColumn Header="Ngày Thuê" Binding="{Binding NgayThue, StringFormat='dd/MM/yyyy'}" Width="100"/>
                                        <DataGridTextColumn Header="Ngày Trả" Binding="{Binding NgayTraThucTe, StringFormat='dd/MM/yyyy'}" Width="100"/>
                                        <DataGridTextColumn Header="Tiền Phạt" Binding="{Binding TienPhat, StringFormat=N0}" Width="80"/>
                                        <DataGridTextColumn Header="Trạng thái" Binding="{Binding TrangThai}" Width="100"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </TabItem>
                        </TabControl>
                    </Grid>
                </TabItem>

                <TabItem Header="Quản lý Danh mục">
                    <Grid Margin="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                            <Button Content="Quản lý Tác giả" Click="BtnShowTacGia_Click" Style="{StaticResource ActionButton}" Margin="0,0,10,0"/>
                            <Button Content="Quản lý Thể loại" Click="BtnShowTheLoai_Click" Style="{StaticResource ActionButton}" Margin="0,0,10,0"/>
                            <Button Content="Quản lý Nhà Xuất Bản" Click="BtnShowNXB_Click" Style="{StaticResource ActionButton}"/>
                        </StackPanel>

                        <Grid Grid.Row="1">
                            <Border x:Name="borderTacGia" Visibility="Visible"
                                    Padding="15" Background="{StaticResource SubtleGrayBrush}" CornerRadius="8">
                                <StackPanel>
                                    <TextBlock Text="Tác Giả" FontSize="16" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,10"/>
                                    <ListBox x:Name="lbTacGia" DisplayMemberPath="Ten" SelectedValuePath="Id" Height="180" Margin="0,0,0,10" SelectionChanged="LbTacGia_SelectionChanged"/>
                                    <Label Content="Tên Tác Giả"/>
                                    <TextBox x:Name="txtTenTacGia" Style="{StaticResource MaterialTextBox}" Margin="0,0,0,10"/>
                                    <Label Content="Giới thiệu (Mô tả)"/>
                                    <TextBox x:Name="txtMoTaTacGia" Style="{StaticResource MaterialTextBox}" Height="80" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Margin="0,0,0,10"/>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                        <Button x:Name="btnThemTacGia" Content="Thêm" Click="BtnThemTacGia_Click" Style="{StaticResource ActionButton}" Background="{StaticResource SuccessBrush}" Padding="10,5" Margin="0,0,5,0"/>
                                        <Button x:Name="btnLuuTacGia" Content="Lưu" Click="BtnLuuTacGia_Click" Style="{StaticResource ActionButton}" Padding="10,5" Margin="0,0,5,0"/>
                                        <Button x:Name="btnXoaTacGia" Content="Xóa" Click="BtnXoaTacGia_Click" Style="{StaticResource DeleteButton}" Padding="10,5"/>
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                            <Border x:Name="borderTheLoai" Visibility="Collapsed"
                                    Padding="15" Background="{StaticResource SubtleGrayBrush}" CornerRadius="8">
                                <StackPanel>
                                    <TextBlock Text="Thể Loại" FontSize="16" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,10"/>
                                    <ListBox x:Name="lbTheLoai" DisplayMemberPath="Ten" SelectedValuePath="Id" Height="180" Margin="0,0,0,10" SelectionChanged="LbTheLoai_SelectionChanged"/>
                                    <Label Content="Tên Thể Loại"/>
                                    <TextBox x:Name="txtTenTheLoai" Style="{StaticResource MaterialTextBox}" Margin="0,0,0,10"/>
                                    <Label Content="Mô tả"/>
                                    <TextBox x:Name="txtMoTaTheLoai" Style="{StaticResource MaterialTextBox}" Height="80" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Margin="0,0,0,10"/>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                        <Button x:Name="btnThemTheLoai" Content="Thêm" Click="BtnThemTheLoai_Click" Style="{StaticResource ActionButton}" Background="{StaticResource SuccessBrush}" Padding="10,5" Margin="0,0,5,0"/>
                                        <Button x:Name="btnLuuTheLoai" Content="Lưu" Click="BtnLuuTheLoai_Click" Style="{StaticResource ActionButton}" Padding="10,5" Margin="0,0,5,0"/>
                                        <Button x:Name="btnXoaTheLoai" Content="Xóa" Click="BtnXoaTheLoai_Click" Style="{StaticResource DeleteButton}" Padding="10,5"/>
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                            <Border x:Name="borderNXB" Visibility="Collapsed"
                                    Padding="15" Background="{StaticResource SubtleGrayBrush}" CornerRadius="8">
                                <StackPanel>
                                    <TextBlock Text="Nhà Xuất Bản" FontSize="16" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,10"/>
                                    <ListBox x:Name="lbNhaXuatBan" DisplayMemberPath="Ten" SelectedValuePath="Id" Height="180" Margin="0,0,0,10" SelectionChanged="LbNhaXuatBan_SelectionChanged"/>
                                    <Label Content="Tên Nhà Xuất Bản"/>
                                    <TextBox x:Name="txtTenNhaXuatBan" Style="{StaticResource MaterialTextBox}" Margin="0,0,0,10"/>
                                    <Label Content="Mô tả"/>
                                    <TextBox x:Name="txtMoTaNXB" Style="{StaticResource MaterialTextBox}" Height="80" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Margin="0,0,0,10"/>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                        <Button x:Name="btnThemNXB" Content="Thêm" Click="BtnThemNXB_Click" Style="{StaticResource ActionButton}" Background="{StaticResource SuccessBrush}" Padding="10,5" Margin="0,0,5,0"/>
                                        <Button x:Name="btnLuuNXB" Content="Lưu" Click="BtnLuuNXB_Click" Style="{StaticResource ActionButton}" Padding="10,5" Margin="0,0,5,0"/>
                                        <Button x:Name="btnXoaNXB" Content="Xóa" Click="BtnXoaNXB_Click" Style="{StaticResource DeleteButton}" Padding="10,5"/>
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                        </Grid>
                    </Grid>
                </TabItem>
            </TabControl>
        </Border>

        <Border Grid.Column="1" Background="White" CornerRadius="8" Padding="25" Margin="0,10,10,10">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
            </Border.Effect>
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock x:Name="lblFormTitle" Text="Thông tin Sách" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,5,0,15" VerticalAlignment="Center"/>
                        <Button x:Name="btnLamMoiForm" Grid.Column="1" ToolTip="Tạo sách mới" Click="BtnLamMoiForm_Click" 
                                 Style="{StaticResource MaterialIconButton}">
                            <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="25" Height="25"/>
                        </Button>
                    </Grid>

                    <Grid x:Name="formChiTiet" IsEnabled="False">
                        <StackPanel>
                            <Grid Margin="0,0,0,15">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Border Grid.Column="0" BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="1" Width="120" Height="160" Background="{StaticResource SubtleGrayBrush}">
                                    <Image x:Name="AnhBiaPreview" Style="{StaticResource BookCoverImage}"/>
                                </Border>
                                <StackPanel Grid.Column="1" VerticalAlignment="Bottom" Orientation="Horizontal" Margin="15,0,0,0">
                                    <Button x:Name="btnChonAnh" 
                                            Style="{StaticResource ActionButton}" Background="#F5F5F5" 
                                            BorderBrush="#E0E0E0" Foreground="{StaticResource DarkBrownBrush}"
                                            Click="BtnChonAnh_Click">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconUpload}" Fill="{StaticResource DarkBrownBrush}" Width="20" Height="20" Margin="0,0,8,0"/>
                                            <TextBlock Text="Chọn ảnh bìa" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                    <Button x:Name="btnXoaAnh" 
                                            Style="{StaticResource DeleteButton}" 
                                            Margin="10,0,0,0" 
                                            Click="BtnXoaAnh_Click">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconDelete}" Fill="White" Width="18" Height="18" Margin="0,0,8,0"/>
                                            <TextBlock Text="Xóa ảnh" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                            </Grid>

                            <Label Content="Tên Sách (*)"/>
                            <TextBox x:Name="txtTenSach" Style="{StaticResource MaterialTextBox}"/>

                            <Label Content="Tác Giả (Gõ tên, cách nhau bằng dấu phẩy ',')"/>
                            <TextBox x:Name="txtTacGiaList" Style="{StaticResource MaterialTextBox}"
                                     Height="60" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"/>
                            <ComboBox x:Name="cmbAddTacGia" DisplayMemberPath="Ten" 
                                      SelectionChanged="CmbAddTacGia_SelectionChanged"
                                      Style="{StaticResource AddHelperComboBox}"
                                      Margin="0,5,0,0"
                                      ToolTip="...hoặc chọn từ danh sách này để thêm nhanh."/>

                            <Label Content="Thể Loại (Gõ tên, cách nhau bằng dấu phẩy ',')"/>
                            <TextBox x:Name="txtTheLoaiList" Style="{StaticResource MaterialTextBox}"
                                     Height="60" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"/>
                            <ComboBox x:Name="cmbAddTheLoai" DisplayMemberPath="Ten" 
                                      SelectionChanged="CmbAddTheLoai_SelectionChanged"
                                      Style="{StaticResource AddHelperComboBox}"
                                      Margin="0,5,0,0"
                                      ToolTip="...hoặc chọn từ danh sách này để thêm nhanh."/>

                            <Label Content="Nhà Xuất Bản (Gõ tên, cách nhau bằng dấu phẩy ',')"/>
                            <TextBox x:Name="txtNXBList" Style="{StaticResource MaterialTextBox}"
                                     Height="60" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"/>
                            <ComboBox x:Name="cmbAddNXB" DisplayMemberPath="Ten" 
                                      SelectionChanged="CmbAddNXB_SelectionChanged"
                                      Style="{StaticResource AddHelperComboBox}"
                                      Margin="0,5,0,0"
                                      ToolTip="...hoặc chọn từ danh sách này để thêm nhanh."/>

                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0" Margin="0,0,10,0">
                                    <Label Content="Năm Xuất Bản"/>
                                    <TextBox x:Name="txtNamXuatBan" Style="{StaticResource MaterialTextBox}"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1" Margin="10,0,0,0">
                                    <Label Content="Tổng Số Lượng (*)"/>
                                    <TextBox x:Name="txtSoLuongTong" Style="{StaticResource MaterialTextBox}"/>
                                </StackPanel>
                            </Grid>

                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0" Margin="0,0,10,0">
                                    <Label Content="Giá Bìa (Tiền cọc)"/>
                                    <TextBox x:Name="txtGiaBia" Style="{StaticResource MaterialTextBox}"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1" Margin="10,0,0,0">
                                    <Label Content="Vị trí (Kệ sách)"/>
                                    <TextBox x:Name="txtViTri" Style="{StaticResource MaterialTextBox}"/>
                                </StackPanel>
                            </Grid>

                            <Label Content="Mô tả"/>
                            <TextBox x:Name="txtMoTa" Style="{StaticResource MaterialTextBox}"
                                     Height="100" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"/>
                        </StackPanel>
                    </Grid>

                    <StackPanel x:Name="panelActions" Orientation="Horizontal" Margin="0,25,0,0">
                        <Button x:Name="btnLuu" Click="BtnLuu_Click" Margin="0,0,10,0" Style="{StaticResource ActionButton}" Background="{StaticResource SuccessBrush}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconSave}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="Lưu Sách" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        <Button x:Name="btnXoa" Click="BtnXoa_Click" Margin="0,0,10,0" Style="{StaticResource DeleteButton}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconDelete}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="Xóa" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <Border x:Name="LoadingOverlay" Background="#80FFFFFF" Visibility="Collapsed"
                            Grid.RowSpan="2" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                        <TextBlock Text="Đang xử lý..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
                    </Border>
                </StackPanel>
            </ScrollViewer>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLySachView.xaml.cs
================================================================================
﻿// Tập tin: AppCafebookApi/View/quanly/pages/QuanLySachView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using Microsoft.Win32;
using System.IO;
using AppCafebookApi.Services;
using CafebookModel.Utils;
using AppCafebookApi.View.common;
using CafebookModel.Model.Entities;
using System.Net.Http.Headers;

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLySachView : Page
    {
        private static readonly HttpClient httpClient;
        private List<SachDto> _allSachList = new List<SachDto>();
        private SachDetailDto? _selectedSachDetails = null;
        private string? _currentAnhBiaFilePath = null;
        private bool _deleteImageRequest = false;

        private List<FilterLookupDto> _theLoaiList = new List<FilterLookupDto>();
        private List<FilterLookupDto> _tacGiaList = new List<FilterLookupDto>();
        private List<FilterLookupDto> _nhaXuatBanList = new List<FilterLookupDto>();

        static QuanLySachView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://127.0.0.1:5166")
            };
        }

        public QuanLySachView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadFiltersAsync();
            await LoadDataGridAsync();
            await LoadRentalsAsync(null, null);
            ResetForm();
        }

        #region 1. Tải Dữ Liệu
        private async Task LoadFiltersAsync()
        {
            try
            {
                var filters = await httpClient.GetFromJsonAsync<SachFiltersDto>("api/app/sach/filters");
                if (filters != null)
                {
                    _theLoaiList = filters.TheLoais;
                    _tacGiaList = filters.TacGias;
                    _nhaXuatBanList = filters.NhaXuatBans;

                    // Bộ lọc (Grid)
                    var filterTheLoai = new List<FilterLookupDto>(_theLoaiList);
                    filterTheLoai.Insert(0, new FilterLookupDto { Id = 0, Ten = "Tất cả Thể loại" });
                    cmbFilterTheLoai.ItemsSource = filterTheLoai;
                    if (cmbFilterTheLoai.SelectedValue == null) cmbFilterTheLoai.SelectedValue = 0;

                    // SỬA: Form (Cột phải) - Gán nguồn cho ComboBox
                    cmbAddTheLoai.ItemsSource = _theLoaiList;
                    cmbAddTacGia.ItemsSource = _tacGiaList;
                    cmbAddNXB.ItemsSource = _nhaXuatBanList;

                    // Tab Danh mục
                    lbTacGia.ItemsSource = _tacGiaList;
                    lbTheLoai.ItemsSource = _theLoaiList;
                    lbNhaXuatBan.ItemsSource = _nhaXuatBanList;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải bộ lọc: {ex.Message}", "Lỗi API");
            }
        }

        // (LoadDataGridAsync và LoadRentalsAsync giữ nguyên)
        private async Task LoadDataGridAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            string searchText = txtSearchSach.Text;
            int theLoaiId = (int)(cmbFilterTheLoai.SelectedValue ?? 0);
            try
            {
                var url = $"api/app/sach/search?searchText={Uri.EscapeDataString(searchText)}&theLoaiId={theLoaiId}";
                _allSachList = (await httpClient.GetFromJsonAsync<List<SachDto>>(url)) ?? new List<SachDto>();
                dgSach.ItemsSource = _allSachList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải danh sách sách: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }
        private async Task LoadRentalsAsync(DateTime? fromDate, DateTime? toDate)
        {
            try
            {
                string url = "api/app/sach/rentals";
                var queryParams = new List<string>();
                if (fromDate.HasValue)
                    queryParams.Add($"fromDate={fromDate.Value:yyyy-MM-dd}");
                if (toDate.HasValue)
                    queryParams.Add($"toDate={toDate.Value:yyyy-MM-dd}");

                if (queryParams.Count > 0)
                    url += "?" + string.Join("&", queryParams);

                var rentalData = await httpClient.GetFromJsonAsync<SachRentalsDto>(url);

                if (rentalData != null)
                {
                    dgSachQuaHan.ItemsSource = rentalData.SachQuaHan;
                    dgLichSuThue.ItemsSource = rentalData.LichSuThue;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải lịch sử thuê sách: {ex.Message}", "Lỗi API");
            }
        }
        #endregion

        #region 2. Form Chi Tiết Sách
        private void ResetForm()
        {
            _selectedSachDetails = null;
            _currentAnhBiaFilePath = null;
            _deleteImageRequest = false;

            dgSach.SelectedItem = null;
            formChiTiet.IsEnabled = true;
            panelActions.Visibility = Visibility.Visible;
            btnXoa.Visibility = Visibility.Collapsed;
            lblFormTitle.Text = "Thêm Sách Mới";
            txtTenSach.Text = "";
            txtNamXuatBan.Text = "";
            txtSoLuongTong.Text = "1";
            txtMoTa.Text = "";
            txtGiaBia.Text = "0";
            txtViTri.Text = "";

            // SỬA: Xóa văn bản của TextBox
            txtTacGiaList.Text = string.Empty;
            txtTheLoaiList.Text = string.Empty;
            txtNXBList.Text = string.Empty;

            // SỬA: Xóa lựa chọn ComboBox
            cmbAddTacGia.SelectedItem = null;
            cmbAddTheLoai.SelectedItem = null;
            cmbAddNXB.SelectedItem = null;

            AnhBiaPreview.Source = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultBookCover);
        }

        private async void DgSach_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgSach.SelectedItem is not SachDto selected)
            {
                ResetForm();
                return;
            }
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                _selectedSachDetails = await httpClient.GetFromJsonAsync<SachDetailDto>($"api/app/sach/details/{selected.IdSach}");

                if (_selectedSachDetails == null)
                {
                    ResetForm();
                    return;
                }

                _currentAnhBiaFilePath = null;
                _deleteImageRequest = false;

                formChiTiet.IsEnabled = true;
                panelActions.Visibility = Visibility.Visible;
                btnXoa.Visibility = Visibility.Visible;
                lblFormTitle.Text = "Cập nhật Sách";

                txtTenSach.Text = _selectedSachDetails.TenSach;
                txtNamXuatBan.Text = _selectedSachDetails.NamXuatBan?.ToString() ?? "";
                txtSoLuongTong.Text = _selectedSachDetails.SoLuongTong.ToString();
                txtMoTa.Text = _selectedSachDetails.MoTa;
                txtGiaBia.Text = _selectedSachDetails.GiaBia?.ToString("F0") ?? "0";
                txtViTri.Text = _selectedSachDetails.ViTri;

                // SỬA: Đặt văn bản cho TextBox dựa trên List<int>
                var tacGiaNames = _tacGiaList
                    .Where(t => _selectedSachDetails.IdTacGias.Contains(t.Id))
                    .Select(t => t.Ten);
                txtTacGiaList.Text = string.Join(", ", tacGiaNames);

                var theLoaiNames = _theLoaiList
                    .Where(t => _selectedSachDetails.IdTheLoais.Contains(t.Id))
                    .Select(t => t.Ten);
                txtTheLoaiList.Text = string.Join(", ", theLoaiNames);

                var nxbNames = _nhaXuatBanList
                    .Where(t => _selectedSachDetails.IdNhaXuatBans.Contains(t.Id))
                    .Select(t => t.Ten);
                txtNXBList.Text = string.Join(", ", nxbNames);

                // Xóa lựa chọn ComboBox
                cmbAddTacGia.SelectedItem = null;
                cmbAddTheLoai.SelectedItem = null;
                cmbAddNXB.SelectedItem = null;

                AnhBiaPreview.Source = HinhAnhHelper.LoadImage(_selectedSachDetails.AnhBiaUrl, HinhAnhPaths.DefaultBookCover);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải chi tiết sách: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        // (BtnChonAnh_Click và BtnXoaAnh_Click giữ nguyên)
        private void BtnChonAnh_Click(object sender, RoutedEventArgs e)
        {
            var ofd = new OpenFileDialog { Filter = "Image files|*.png;*.jpg;*.jpeg", Title = "Chọn ảnh bìa sách" };
            if (ofd.ShowDialog() == true)
            {
                try
                {
                    _currentAnhBiaFilePath = ofd.FileName;
                    _deleteImageRequest = false;
                    AnhBiaPreview.Source = HinhAnhHelper.LoadImage(_currentAnhBiaFilePath, HinhAnhPaths.DefaultBookCover);
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Lỗi đọc file ảnh: {ex.Message}", "Lỗi File");
                    _currentAnhBiaFilePath = null;
                    AnhBiaPreview.Source = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultBookCover);
                }
            }
        }
        private void BtnXoaAnh_Click(object sender, RoutedEventArgs e)
        {
            _currentAnhBiaFilePath = null;
            _deleteImageRequest = true;
            AnhBiaPreview.Source = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultBookCover);
        }
        #endregion

        #region 3. Lọc / Form
        // (Các hàm trong Region này giữ nguyên)
        private async void TxtSearchSach_TextChanged(object sender, TextChangedEventArgs e)
        {
            await LoadDataGridAsync();
        }
        private async void CmbFilterTheLoai_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (cmbFilterTheLoai.IsLoaded)
            {
                await LoadDataGridAsync();
            }
        }
        private async void BtnClearFilter_Click(object sender, RoutedEventArgs e)
        {
            txtSearchSach.Text = "";
            cmbFilterTheLoai.SelectedValue = 0;
            await LoadDataGridAsync();
        }
        private void BtnLamMoiForm_Click(object sender, RoutedEventArgs e)
        {
            ResetForm();
        }
        #endregion

        #region 4. Lưu/Xóa Sách

        // SỬA: BtnLuu_Click (dùng logic "Smart TextBox")
        private async void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            // (Validation giữ nguyên)
            if (string.IsNullOrWhiteSpace(txtTenSach.Text))
            {
                MessageBox.Show("Tên sách không được để trống.", "Lỗi"); return;
            }
            if (!int.TryParse(txtSoLuongTong.Text, out int soLuong) || soLuong <= 0)
            {
                MessageBox.Show("Số lượng tổng phải là số dương.", "Lỗi"); return;
            }
            if (!decimal.TryParse(txtGiaBia.Text, out _))
            {
                MessageBox.Show("Giá bìa phải là số (hoặc để 0).", "Lỗi"); return;
            }
            if (!string.IsNullOrEmpty(txtNamXuatBan.Text) && !int.TryParse(txtNamXuatBan.Text, out _))
            {
                MessageBox.Show("Năm xuất bản phải là số (hoặc để trống).", "Lỗi"); return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                // SỬA: Xử lý chuỗi tên để lấy List<int>
                // Tự động tạo mới nếu tên không tồn tại
                var tacGiaIds = await ProcessNameListAsync(txtTacGiaList.Text, "api/app/sach/tacgia", _tacGiaList);
                var theLoaiIds = await ProcessNameListAsync(txtTheLoaiList.Text, "api/app/sach/theloai", _theLoaiList);
                var nxbIds = await ProcessNameListAsync(txtNXBList.Text, "api/app/sach/nhaxuatban", _nhaXuatBanList);

                // Nếu ProcessNameListAsync trả về null (do lỗi), dừng lại
                if (tacGiaIds == null || theLoaiIds == null || nxbIds == null)
                {
                    LoadingOverlay.Visibility = Visibility.Collapsed;
                    return;
                }

                using var form = new MultipartFormDataContent();

                // 1. Thêm các trường dữ liệu (Giữ nguyên)
                form.Add(new StringContent(txtTenSach.Text), "TenSach");
                if (int.TryParse(txtNamXuatBan.Text, out int nam))
                    form.Add(new StringContent(nam.ToString()), "NamXuatBan");
                form.Add(new StringContent(txtMoTa.Text ?? ""), "MoTa");
                form.Add(new StringContent(soLuong.ToString()), "SoLuongTong");
                if (decimal.TryParse(txtGiaBia.Text, out decimal gia))
                    form.Add(new StringContent(gia.ToString()), "GiaBia");
                form.Add(new StringContent(txtViTri.Text ?? ""), "ViTri");

                // SỬA: Thêm các List<int> đã được xử lý
                foreach (var id in tacGiaIds)
                {
                    form.Add(new StringContent(id.ToString()), "IdTacGias");
                }
                foreach (var id in theLoaiIds)
                {
                    form.Add(new StringContent(id.ToString()), "IdTheLoais");
                }
                foreach (var id in nxbIds)
                {
                    form.Add(new StringContent(id.ToString()), "IdNhaXuatBans");
                }

                bool isCreating = (_selectedSachDetails == null);

                // 2. Thêm file (nếu có)
                if (!string.IsNullOrEmpty(_currentAnhBiaFilePath))
                {
                    var fileStream = File.OpenRead(_currentAnhBiaFilePath);
                    var streamContent = new StreamContent(fileStream);
                    streamContent.Headers.ContentType = new MediaTypeHeaderValue("image/jpeg");
                    form.Add(streamContent, "AnhBiaUpload", Path.GetFileName(_currentAnhBiaFilePath));
                }

                // 3. Thêm cờ Xóa ảnh (nếu có)
                if (_deleteImageRequest)
                {
                    form.Add(new StringContent("true"), "XoaAnhBia");
                }

                if (!isCreating)
                {
                    form.Add(new StringContent(_selectedSachDetails!.IdSach.ToString()), "IdSach");
                }

                HttpResponseMessage response;

                if (isCreating)
                {
                    response = await httpClient.PostAsync("api/app/sach", form);
                }
                else
                {
                    response = await httpClient.PutAsync($"api/app/sach/{_selectedSachDetails!.IdSach}", form);
                }

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Lưu thành công!", "Thông báo");

                    // SỬA: Tải lại Filters để cập nhật các mục vừa tạo mới
                    await LoadFiltersAsync();
                    await LoadDataGridAsync();

                    if (isCreating)
                    {
                        var newSach = await response.Content.ReadFromJsonAsync<SachDetailDto>();
                        if (newSach != null)
                        {
                            var newItemInGrid = _allSachList.FirstOrDefault(s => s.IdSach == newSach.IdSach);
                            dgSach.SelectedItem = newItemInGrid;
                        }
                    }
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
                _currentAnhBiaFilePath = null;
                _deleteImageRequest = false;
            }
        }

        // THÊM: Hàm Helper để xử lý logic "Smart TextBox"
        /// <summary>
        /// Xử lý chuỗi tên (cách nhau bằng dấu phẩy),
        /// tự động tạo mới nếu tên chưa có trong cache.
        /// </summary>
        /// <returns>Danh sách ID hoặc null nếu có lỗi.</returns>
        private async Task<List<int>?> ProcessNameListAsync(string commaSeparatedText, string createEndpoint, List<FilterLookupDto> localCacheList)
        {
            var ids = new List<int>();
            var nameList = commaSeparatedText.Split(',')
                                            .Select(s => s.Trim())
                                            .Where(s => !string.IsNullOrEmpty(s))
                                            .Distinct(StringComparer.OrdinalIgnoreCase) // Loại bỏ trùng lặp
                                            .ToList();

            foreach (var name in nameList)
            {
                // 1. Kiểm tra cache (danh sách có sẵn)
                var existing = localCacheList.FirstOrDefault(t => t.Ten.Equals(name, StringComparison.OrdinalIgnoreCase));

                if (existing != null)
                {
                    ids.Add(existing.Id);
                }
                else
                {
                    // 2. Tự động tạo mới nếu không tìm thấy
                    try
                    {
                        var dto = new FilterLookupDto { Ten = name, MoTa = null };
                        var response = await httpClient.PostAsJsonAsync(createEndpoint, dto);

                        if (response.IsSuccessStatusCode)
                        {
                            var newDto = await response.Content.ReadFromJsonAsync<FilterLookupDto>();
                            if (newDto != null)
                            {
                                ids.Add(newDto.Id);
                                localCacheList.Add(newDto); // Cập nhật cache để lần sau không tạo nữa
                            }
                        }
                        else
                        {
                            MessageBox.Show($"Lỗi khi tự động tạo '{name}': {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                            return null; // Dừng lại nếu có lỗi
                        }
                    }
                    catch (Exception ex)
                    {
                        MessageBox.Show($"Lỗi kết nối khi tạo '{name}': {ex.Message}", "Lỗi API");
                        return null; // Dừng lại nếu có lỗi
                    }
                }
            }
            return ids;
        }


        // (BtnXoa_Click giữ nguyên)
        private async void BtnXoa_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedSachDetails == null) return;
            var result = MessageBox.Show($"Bạn có chắc chắn muốn xóa sách '{_selectedSachDetails.TenSach}'?",
                                          "Xác nhận xóa", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/sach/{_selectedSachDetails.IdSach}");
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Xóa thành công!", "Thông báo");
                    await LoadDataGridAsync();
                    ResetForm();
                }
                else if (response.StatusCode == HttpStatusCode.Conflict)
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Không thể xóa");
                }
                else
                {
                    MessageBox.Show($"Lỗi không xác định: {response.ReasonPhrase}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion

        #region 5. CRUD Danh mục (Giữ nguyên)

        // (Tất cả các hàm trong region 5 giữ nguyên)
        private void BtnShowTacGia_Click(object sender, RoutedEventArgs e)
        {
            borderTacGia.Visibility = Visibility.Visible;
            borderTheLoai.Visibility = Visibility.Collapsed;
            borderNXB.Visibility = Visibility.Collapsed;
        }

        private void BtnShowTheLoai_Click(object sender, RoutedEventArgs e)
        {
            borderTacGia.Visibility = Visibility.Collapsed;
            borderTheLoai.Visibility = Visibility.Visible;
            borderNXB.Visibility = Visibility.Collapsed;
        }

        private void BtnShowNXB_Click(object sender, RoutedEventArgs e)
        {
            borderTacGia.Visibility = Visibility.Collapsed;
            borderTheLoai.Visibility = Visibility.Collapsed;
            borderNXB.Visibility = Visibility.Visible;
        }

        private void LbTacGia_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (lbTacGia.SelectedItem is FilterLookupDto selected)
            {
                txtTenTacGia.Text = selected.Ten;
                txtMoTaTacGia.Text = selected.MoTa;
            }
        }
        private async void BtnThemTacGia_Click(object sender, RoutedEventArgs e)
        {
            await CrudLookupAsync("api/app/sach/tacgia", null, txtTenTacGia.Text, txtMoTaTacGia.Text);
        }
        private async void BtnLuuTacGia_Click(object sender, RoutedEventArgs e)
        {
            if (lbTacGia.SelectedItem is FilterLookupDto selected)
            {
                await CrudLookupAsync($"api/app/sach/tacgia/{selected.Id}", selected.Id, txtTenTacGia.Text, txtMoTaTacGia.Text);
            }
        }
        private async void BtnXoaTacGia_Click(object sender, RoutedEventArgs e)
        {
            if (lbTacGia.SelectedItem is FilterLookupDto selected)
            {
                await CrudLookupAsync($"api/app/sach/tacgia/{selected.Id}", selected.Id, null, null, isDelete: true);
            }
        }

        private void LbTheLoai_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (lbTheLoai.SelectedItem is FilterLookupDto selected)
            {
                txtTenTheLoai.Text = selected.Ten;
                txtMoTaTheLoai.Text = selected.MoTa;
            }
        }
        private async void BtnThemTheLoai_Click(object sender, RoutedEventArgs e)
        {
            await CrudLookupAsync("api/app/sach/theloai", null, txtTenTheLoai.Text, txtMoTaTheLoai.Text);
        }
        private async void BtnLuuTheLoai_Click(object sender, RoutedEventArgs e)
        {
            if (lbTheLoai.SelectedItem is FilterLookupDto selected)
            {
                await CrudLookupAsync($"api/app/sach/theloai/{selected.Id}", selected.Id, txtTenTheLoai.Text, txtMoTaTheLoai.Text);
            }
        }
        private async void BtnXoaTheLoai_Click(object sender, RoutedEventArgs e)
        {
            if (lbTheLoai.SelectedItem is FilterLookupDto selected)
            {
                await CrudLookupAsync($"api/app/sach/theloai/{selected.Id}", selected.Id, null, null, isDelete: true);
            }
        }

        private void LbNhaXuatBan_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (lbNhaXuatBan.SelectedItem is FilterLookupDto selected)
            {
                txtTenNhaXuatBan.Text = selected.Ten;
                txtMoTaNXB.Text = selected.MoTa;
            }
        }
        private async void BtnThemNXB_Click(object sender, RoutedEventArgs e)
        {
            await CrudLookupAsync("api/app/sach/nhaxuatban", null, txtTenNhaXuatBan.Text, txtMoTaNXB.Text);
        }
        private async void BtnLuuNXB_Click(object sender, RoutedEventArgs e)
        {
            if (lbNhaXuatBan.SelectedItem is FilterLookupDto selected)
            {
                await CrudLookupAsync($"api/app/sach/nhaxuatban/{selected.Id}", selected.Id, txtTenNhaXuatBan.Text, txtMoTaNXB.Text);
            }
        }
        private async void BtnXoaNXB_Click(object sender, RoutedEventArgs e)
        {
            if (lbNhaXuatBan.SelectedItem is FilterLookupDto selected)
            {
                await CrudLookupAsync($"api/app/sach/nhaxuatban/{selected.Id}", selected.Id, null, null, isDelete: true);
            }
        }

        private async Task CrudLookupAsync(string endpoint, int? id, string? ten, string? moTa, bool isDelete = false)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                HttpResponseMessage response;
                if (isDelete)
                {
                    if (MessageBox.Show("Bạn có chắc chắn muốn xóa?", "Xác nhận", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.No)
                    {
                        LoadingOverlay.Visibility = Visibility.Collapsed;
                        return;
                    }
                    response = await httpClient.DeleteAsync(endpoint);
                }
                else if (string.IsNullOrWhiteSpace(ten))
                {
                    MessageBox.Show("Tên không được để trống.", "Lỗi");
                    LoadingOverlay.Visibility = Visibility.Collapsed;
                    return;
                }
                else
                {
                    var dto = new FilterLookupDto { Ten = ten };
                    if (id.HasValue)
                        dto.Id = id.Value;
                    if (moTa != null)
                        dto.MoTa = moTa;

                    if (id.HasValue) // Update (PUT)
                    {
                        response = await httpClient.PutAsJsonAsync(endpoint, dto);
                    }
                    else // Create (POST)
                    {
                        response = await httpClient.PostAsJsonAsync(endpoint, dto);
                    }
                }

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Thao tác thành công!", "Thông báo");
                    await LoadFiltersAsync(); // Tải lại TOÀN BỘ (cho cả 3 listbox)
                    ResetLookupForms();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void ResetLookupForms()
        {
            txtTenTacGia.Text = string.Empty;
            txtMoTaTacGia.Text = string.Empty;
            lbTacGia.SelectedItem = null;

            txtTenTheLoai.Text = string.Empty;
            txtMoTaTheLoai.Text = string.Empty;
            lbTheLoai.SelectedItem = null;

            txtTenNhaXuatBan.Text = string.Empty;
            txtMoTaNXB.Text = string.Empty;
            lbNhaXuatBan.SelectedItem = null;
        }
        #endregion

        #region 6. Navigation Buttons
        // (Giữ nguyên)
        private void BtnXemBaoCaoSach_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new BapCaoTonKhoSachPreviewWindow());
        }
        private void BtnCaiDatPhiThue_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new CaiDatWindow());
        }
        #endregion

        #region 7. Lịch sử & Trễ hạn Actions
        // (Giữ nguyên)
        private async void BtnLocNgay_Click(object sender, RoutedEventArgs e)
        {
            await LoadRentalsAsync(dpTuNgay.SelectedDate, dpDenNgay.SelectedDate);
        }

        private async void BtnLamMoiLichSu_Click(object sender, RoutedEventArgs e)
        {
            dpTuNgay.SelectedDate = null;
            dpDenNgay.SelectedDate = null;
            await LoadRentalsAsync(null, null);
        }

        private void BtnLienHe_Click(object sender, RoutedEventArgs e)
        {
            if ((sender as Button)?.Tag is BaoCaoSachTreHanDto item)
            {
                MessageBox.Show($"Đang liên hệ khách: {item.HoTen}\nSĐT: {item.SoDienThoai}", "Liên hệ");
            }
        }

        private void BtnGiaHan_Click(object sender, RoutedEventArgs e)
        {
            if ((sender as Button)?.Tag is BaoCaoSachTreHanDto item)
            {
                MessageBox.Show($"Mở cửa sổ gia hạn cho sách: {item.TenSach}\nKhách: {item.HoTen}", "Gia hạn");
            }
        }
        #endregion

        // THÊM: Region 8 cho logic ComboBox Helper
        #region 8. ComboBox Helper Logic

        /// <summary>
        /// Hàm chung để thêm item được chọn từ ComboBox vào TextBox
        /// </summary>
        private void AddItemToTextBox(TextBox targetTextBox, ComboBox sourceComboBox)
        {
            if (sourceComboBox.SelectedItem is not FilterLookupDto selected)
            {
                return;
            }

            var currentText = targetTextBox.Text;
            var currentNames = currentText.Split(',')
                                          .Select(s => s.Trim())
                                          .Where(s => !string.IsNullOrEmpty(s))
                                          .ToList();

            // Chỉ thêm nếu tên chưa có trong danh sách
            if (!currentNames.Contains(selected.Ten, StringComparer.OrdinalIgnoreCase))
            {
                currentNames.Add(selected.Ten);
                targetTextBox.Text = string.Join(", ", currentNames);
            }

            // Reset ComboBox để chờ chọn tiếp
            sourceComboBox.SelectedItem = null;
            sourceComboBox.Text = string.Empty;
        }

        private void CmbAddTacGia_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            AddItemToTextBox(txtTacGiaList, cmbAddTacGia);
        }

        private void CmbAddTheLoai_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            AddItemToTextBox(txtTheLoaiList, cmbAddTheLoai);
        }

        private void CmbAddNXB_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            AddItemToTextBox(txtNXBList, cmbAddNXB);
        }

        #endregion
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLySanPhamView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLySanPhamView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="QuanLySanPhamView"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="BackgroundHoverBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="BackgroundSelectedBrush" Color="#EFEBE9"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>

        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconClearFilter">M14.12,12.5L19.31,7.31L17.89,5.89L12.71,11.08L7.5,5.89L6.09,7.31L11.28,12.5L6.09,17.69L7.5,19.11L12.71,13.92L17.89,19.11L19.31,17.69L14.12,12.5M3,5H21V3H3V5Z</Geometry>
        <Geometry x:Key="IconUpload">M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z</Geometry>
        <Geometry x:Key="IconExcel">M21.17 3.25Q21.5 3.25 21.76 3.5 22 3.74 22 4.08V19.92Q22 20.26 21.76 20.5 21.5 20.75 21.17 20.75H7.83Q7.5 20.75 7.24 20.5 7 20.26 7 19.92V4.08Q7 3.74 7.24 3.5 7.5 3.25 7.83 3.25H21.17M13.83 18.25V15.7H11.5V14.05L13.72 10.63H11.6V9H16.33V10.65L14.12 14.07H16.25V15.7H13.83V18.25M6.25 15.5Q6.25 15.15 6.04 14.88 5.82 14.6 5.5 14.6H3.5Q3.18 14.6 2.96 14.88 2.75 15.15 2.75 15.5V17.5Q2.75 17.82 2.96 18.1 3.18 18.38 3.5 18.38H5.5Q5.82 18.38 6.04 18.1 6.25 17.82 6.25 17.5V15.5M6.25 9.5Q6.25 9.18 6.04 8.9 5.82 8.62 5.5 8.62H3.5Q3.18 8.62 2.96 8.9 2.75 9.18 2.75 9.5V11.5Q2.75 11.82 2.96 12.1 3.18 12.38 3.5 12.38H5.5Q5.82 12.38 6.04 12.1 6.25 11.82 6.25 11.5V9.5Z</Geometry>

        <Style x:Key="ActionButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,10"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="4" Padding="{TemplateBinding Padding}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.1" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.8"/>
                                <Setter TargetName="border" Property="Effect" Value="{x:Null}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="DeleteButton" TargetType="Button" BasedOn="{StaticResource ActionButton}">
            <Setter Property="Background" Value="{StaticResource ErrorBrush}"/>
        </Style>
        <Style x:Key="MaterialIconButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="20">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BackgroundHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="Label">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,15,0,5"/>
        </Style>
        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>

        <Style x:Key="SearchTextBox" TargetType="TextBox" BasedOn="{StaticResource MaterialInput}">
            <Setter Property="Padding" Value="8,8"/>
        </Style>
        <Style x:Key="FilterComboBox" TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}">
            <Setter Property="Padding" Value="8,8"/>
        </Style>
        <Style TargetType="TabControl">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
        <Style TargetType="TabItem">
            <Setter Property="Background" Value="#E0E0E0"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border x:Name="border" BorderThickness="0,0,0,3" BorderBrush="Transparent" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" Margin="0,0,5,0">
                            <ContentPresenter ContentSource="Header" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="Background" Value="White"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
                                <Setter TargetName="border" Property="Background" Value="#F5F5F5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="ProductImage" TargetType="Image">
            <Setter Property="Width" Value="140"/>
            <Setter Property="Height" Value="140"/>
            <Setter Property="Stretch" Value="Uniform"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
        </Style>
        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

    </Page.Resources>

    <Grid Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="420"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Background="White" CornerRadius="8" Margin="10">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
            </Border.Effect>

            <TabControl x:Name="MainTabControl" Margin="5">

                <TabItem Header="Quản lý Sản phẩm">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <WrapPanel Grid.Row="0" Orientation="Horizontal" Margin="10,5,10,10">
                            <TextBlock Text="Tìm kiếm:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                            <TextBox x:Name="txtSearchSanPham" Width="200" TextChanged="TxtSearchSanPham_TextChanged"/>
                            <TextBlock Text="Danh mục:" VerticalAlignment="Center" Margin="15,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                            <ComboBox x:Name="cmbFilterDanhMuc" Width="180" DisplayMemberPath="Ten" SelectedValuePath="Id"
                                      SelectionChanged="Filter_SelectionChanged"/>
                            <TextBlock Text="Trạng thái:" VerticalAlignment="Center" Margin="15,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                            <ComboBox x:Name="cmbFilterTrangThai" Width="120" SelectionChanged="Filter_SelectionChanged">
                                <ComboBoxItem Content="Tất cả" Tag="{x:Null}"/>
                                <ComboBoxItem Content="Đang bán" Tag="True"/>
                                <ComboBoxItem Content="Tạm ngưng" Tag="False"/>
                            </ComboBox>
                            <Button x:Name="btnClearFilter" ToolTip="Xóa Lọc" Style="{StaticResource MaterialIconButton}" 
                                    Click="BtnClearFilter_Click" Margin="5,0,0,0">
                                <Path Data="{StaticResource IconClearFilter}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                            </Button>
                        </WrapPanel>
                        <DataGrid Grid.Row="1" x:Name="dgSanPham" AutoGenerateColumns="False" IsReadOnly="True"
                                  SelectionMode="Single" SelectionChanged="DgSanPham_SelectionChanged"
                                  BorderThickness="0" RowHeaderWidth="0" Margin="10,0,10,10">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ID" Binding="{Binding IdSanPham}" Width="50"/>
                                <DataGridTextColumn Header="Tên Sản Phẩm" Binding="{Binding TenSanPham}" Width="*"/>
                                <DataGridTextColumn Header="Đơn Giá" Binding="{Binding GiaBan, StringFormat=N0}" Width="100"/>
                                <DataGridTextColumn Header="Danh Mục" Binding="{Binding TenDanhMuc}" Width="150"/>
                                <DataGridCheckBoxColumn Header="Đang Bán" Binding="{Binding TrangThaiKinhDoanh}" Width="80"/>
                            </DataGrid.Columns>
                        </DataGrid>

                        <Button Grid.Row="2" x:Name="btnExportToExcel" HorizontalAlignment="Left" Margin="10,0,0,10"
                                Style="{StaticResource PrimaryButton}" Background="#00724C"
                                Click="BtnExportToExcel_Click">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconExcel}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="Xuất Excel" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </Grid>
                </TabItem>

                <TabItem Header="Quản lý Danh mục">
                    <Grid Margin="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="380"/>
                        </Grid.ColumnDefinitions>
                        <Border Grid.Column="0" Margin="0,0,10,0" Padding="15" Background="{StaticResource SubtleGrayBrush}" CornerRadius="8">
                            <StackPanel>
                                <TextBlock Text="Danh Mục (Loại Sản Phẩm)" FontSize="16" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,10"/>
                                <ListBox x:Name="lbDanhMuc" DisplayMemberPath="Ten" SelectedValuePath="Id" Height="400" Margin="0,0,0,10" SelectionChanged="LbDanhMuc_SelectionChanged"/>
                            </StackPanel>
                        </Border>
                        <Border Grid.Column="1" Margin="10,0,0,0" Padding="15" Background="{StaticResource SubtleGrayBrush}" CornerRadius="8">
                            <StackPanel>
                                <TextBlock Text="Chi tiết Danh Mục" FontSize="16" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,10"/>
                                <Label Content="Tên Danh Mục"/>
                                <TextBox x:Name="txtTenDanhMuc" Margin="0,0,0,10"/>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                    <Button x:Name="btnThemDanhMuc" Content="Thêm Mới" Click="BtnThemDanhMuc_Click" Style="{StaticResource PrimaryButton}" Background="{StaticResource SuccessBrush}" Padding="10,5" Margin="0,0,5,0"/>
                                    <Button x:Name="btnLuuDanhMuc" Content="Lưu" Click="BtnLuuDanhMuc_Click" Style="{StaticResource PrimaryButton}" Padding="10,5" Margin="0,0,5,0"/>
                                    <Button x:Name="btnXoaDanhMuc" Content="Xóa" Click="BtnXoaDanhMuc_Click" Style="{StaticResource DeleteButton}" Padding="10,5"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </Grid>
                </TabItem>

                <TabItem Header="Định lượng Nguyên Liệu">
                    <Grid Margin="10">
                        <TextBlock x:Name="lblDinhLuongInfo" Text="Chọn một sản phẩm ở Tab 'Quản lý Sản phẩm' để xem và sửa định lượng." 
                                   VerticalAlignment="Center" HorizontalAlignment="Center"
                                   Foreground="{StaticResource TextGrayBrush}" FontSize="16" TextWrapping="Wrap" TextAlignment="Center"/>

                        <Grid x:Name="panelDinhLuong" Visibility="Collapsed">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" x:Name="lblDinhLuongTitle" Text="Định lượng cho: [Tên Sản Phẩm]" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,15"/>

                            <DataGrid Grid.Row="1" x:Name="dgDinhLuong" AutoGenerateColumns="False" IsReadOnly="True" MaxHeight="300" RowHeaderWidth="0"
                                      SelectionChanged="DgDinhLuong_SelectionChanged">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Nguyên liệu" Binding="{Binding TenNguyenLieu}" Width="*"/>
                                    <DataGridTextColumn Header="Số Lượng" Binding="{Binding SoLuong}" Width="100"/>
                                    <DataGridTextColumn Header="Đơn Vị Tính" Binding="{Binding TenDonViSuDung}" Width="100"/>
                                </DataGrid.Columns>
                            </DataGrid>

                            <Grid Grid.Row="2" Margin="0,15,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="100"/>
                                    <ColumnDefinition Width="120"/>
                                </Grid.ColumnDefinitions>

                                <ComboBox Grid.Column="0" x:Name="cmbNguyenLieu" DisplayMemberPath="Ten" SelectedValuePath="Id" Margin="0,0,10,0" VerticalAlignment="Center"
                                          SelectionChanged="CmbNguyenLieu_SelectionChanged"
                                          IsEditable="True" IsTextSearchEnabled="True"/>

                                <TextBox Grid.Column="1" x:Name="txtSoLuongNL" Margin="0,0,10,0" VerticalAlignment="Center"/>

                                <ComboBox Grid.Column="2" x:Name="cmbDonViTinhNL" DisplayMemberPath="Ten" SelectedValuePath="Id" VerticalAlignment="Center"/>
                            </Grid>

                            <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,15,0,0">
                                <Button x:Name="btnLuuDinhLuong" Style="{StaticResource ActionButton}" Content="Thêm / Cập nhật NL" Click="BtnLuuDinhLuong_Click" Padding="10,5" Margin="0,0,8,0"/>
                                <Button x:Name="btnXoaDinhLuong" Style="{StaticResource DeleteButton}" Content="Xóa NL" Click="BtnXoaDinhLuong_Click" Padding="10,5"/>
                            </StackPanel>
                        </Grid>
                    </Grid>
                </TabItem>
            </TabControl>
        </Border>

        <Border Grid.Column="1" Background="White" CornerRadius="8" Padding="25" Margin="0,10,10,10">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
            </Border.Effect>
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock x:Name="lblFormTitle" Text="Thông tin Sản phẩm" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,5,0,15" VerticalAlignment="Center"/>
                        <Button x:Name="btnLamMoiForm" Grid.Column="1" ToolTip="Tạo sản phẩm mới" Click="BtnLamMoiForm_Click" 
                                Style="{StaticResource MaterialIconButton}">
                            <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                        </Button>
                    </Grid>
                    <Grid x:Name="formChiTietSP" IsEnabled="False">
                        <StackPanel>
                            <Grid Margin="0,0,0,15">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <Border Grid.Column="0" BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="1" Width="140" Height="140" Background="{StaticResource SubtleGrayBrush}">
                                    <Image x:Name="AnhSanPhamPreview" Style="{StaticResource ProductImage}"/>
                                </Border>

                                <StackPanel Grid.Column="1" VerticalAlignment="Bottom" Orientation="Horizontal" Margin="15,0,0,0">
                                    <Button x:Name="btnChonAnh" 
                                            Style="{StaticResource ActionButton}" Background="#F5F5F5" 
                                            BorderBrush="#E0E0E0" Foreground="{StaticResource DarkBrownBrush}"
                                            Click="BtnChonAnh_Click">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconUpload}" Fill="{StaticResource DarkBrownBrush}" Width="23" Height="23" Margin="0,0,8,0"/>
                                            <TextBlock Text="Chọn ảnh" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>

                                    <Button x:Name="btnXoaAnh" 
                                            Style="{StaticResource DeleteButton}" 
                                            Margin="10,0,0,0" 
                                            Click="BtnXoaAnh_Click">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconDelete}" Fill="White" Width="20" Height="20" Margin="0,0,8,0"/>
                                            <TextBlock Text="Xóa ảnh" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                            </Grid>

                            <Label Content="Tên Sản Phẩm (*)"/>
                            <TextBox x:Name="txtTenSanPham"/>
                            <Label Content="Danh Mục (*)"/>
                            <ComboBox x:Name="cmbDanhMuc" DisplayMemberPath="Ten" SelectedValuePath="Id" 
                                      IsEditable="True" IsTextSearchEnabled="True"/>
                            <Label Content="Đơn Giá (*)"/>
                            <TextBox x:Name="txtDonGia"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0" Margin="0,0,10,0">
                                    <Label Content="Nhóm In (Bar/Bếp)"/>
                                    <ComboBox x:Name="cmbNhomIn" IsEditable="True">
                                        <ComboBoxItem Content="Bar"/>
                                        <ComboBoxItem Content="Bếp"/>
                                        <ComboBoxItem Content="Khác"/>
                                    </ComboBox>
                                </StackPanel>
                                <StackPanel Grid.Column="1" Margin="10,0,0,0">
                                    <Label Content="Trạng thái"/>
                                    <ComboBox x:Name="cmbTrangThai">
                                        <ComboBoxItem Content="Đang bán" Tag="True" IsSelected="True"/>
                                        <ComboBoxItem Content="Tạm ngưng" Tag="False"/>
                                    </ComboBox>
                                </StackPanel>
                            </Grid>
                            <Label Content="Mô tả"/>
                            <TextBox x:Name="txtMoTa" Height="100" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"/>
                        </StackPanel>
                    </Grid>
                    <StackPanel x:Name="panelActions" Orientation="Horizontal" Margin="0,25,0,0">
                        <Button x:Name="btnLuu" Click="BtnLuu_Click" Margin="0,0,10,0" Style="{StaticResource ActionButton}" Background="{StaticResource SuccessBrush}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconSave}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="Lưu Sản Phẩm" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        <Button x:Name="btnXoa" Click="BtnXoa_Click" Margin="0,0,10,0" Style="{StaticResource DeleteButton}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconDelete}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="Xóa" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                    <Border x:Name="LoadingOverlay" Background="#80FFFFFF" Visibility="Collapsed"
                            Grid.RowSpan="2" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                        <TextBlock Text="Đang xử lý..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
                    </Border>
                </StackPanel>
            </ScrollViewer>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLySanPhamView.xaml.cs
================================================================================
﻿// Tập tin: AppCafebookApi/View/quanly/pages/QuanLySanPhamView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using Microsoft.Win32;
using System.IO; // <-- Thêm
using AppCafebookApi.Services;
using CafebookModel.Utils;
using AppCafebookApi.View.common;
using System.Globalization;
using OfficeOpenXml;
using CafebookModel.Model.Entities;
using System.Net.Http.Headers; // <-- Thêm

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLySanPhamView : Page
    {
        private static readonly HttpClient httpClient;
        private List<SanPhamDto> _allSanPhamList = new List<SanPhamDto>();

        private SanPhamDetailDto? _selectedSanPhamDetails = null;

        // SỬA: Đã xóa Base64, dùng 2 biến này để quản lý file upload
        private string? _currentAnhBiaFilePath = null; // Lưu đường dẫn file cục bộ
        private bool _deleteImageRequest = false;     // Đánh dấu yêu cầu xóa ảnh

        // Cache (Giữ nguyên)
        private List<FilterLookupDto> _danhMucList = new List<FilterLookupDto>();
        private List<FilterLookupDto> _nguyenLieuList = new List<FilterLookupDto>();
        private List<DonViChuyenDoiDto> _donViTinhList = new List<DonViChuyenDoiDto>();

        static QuanLySanPhamView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://127.0.0.1:5166")
            };
        }

        public QuanLySanPhamView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadFiltersAsync();
            await LoadDataGridAsync();
            ResetForm();
            ResetDanhMucForm();
            ResetDinhLuongForm();
        }

        #region 1. Tải Dữ Liệu (Sản Phẩm, Lọc, Định Lượng)

        // (Hàm LoadFiltersAsync giữ nguyên)
        private async Task LoadFiltersAsync()
        {
            try
            {
                var filters = await httpClient.GetFromJsonAsync<SanPhamFiltersDto>("api/app/sanpham/filters");
                if (filters != null)
                {
                    _danhMucList = filters.DanhMucs;
                    _nguyenLieuList = filters.NguyenLieus;
                    _donViTinhList = filters.DonViTinhs;
                    var filterDanhMuc = new List<FilterLookupDto>(_danhMucList);
                    filterDanhMuc.Insert(0, new FilterLookupDto { Id = 0, Ten = "Tất cả Danh mục" });
                    cmbFilterDanhMuc.ItemsSource = filterDanhMuc;
                    if (cmbFilterDanhMuc.SelectedValue == null) cmbFilterDanhMuc.SelectedValue = 0;
                    if (cmbFilterTrangThai.SelectedValue == null) cmbFilterTrangThai.SelectedIndex = 0;
                    lbDanhMuc.ItemsSource = _danhMucList;
                    var nlList = new List<FilterLookupDto>(_nguyenLieuList);
                    nlList.Insert(0, new FilterLookupDto { Id = 0, Ten = "-- Chọn Nguyên Liệu --" });
                    cmbNguyenLieu.ItemsSource = nlList;
                    var formDanhMuc = new List<FilterLookupDto>(_danhMucList);
                    formDanhMuc.Insert(0, new FilterLookupDto { Id = 0, Ten = "-- Chọn Danh mục --" });
                    cmbDanhMuc.ItemsSource = formDanhMuc;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải bộ lọc: {ex.Message}", "Lỗi API");
            }
        }

        // (Hàm LoadDataGridAsync giữ nguyên)
        private async Task LoadDataGridAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            string searchText = txtSearchSanPham.Text;
            int danhMucId = (int)(cmbFilterDanhMuc.SelectedValue ?? 0);
            bool? trangThai = (cmbFilterTrangThai.SelectedItem as ComboBoxItem)?.Tag as bool?;
            try
            {
                var url = $"api/app/sanpham/search?searchText={Uri.EscapeDataString(searchText)}&danhMucId={danhMucId}";
                if (trangThai.HasValue)
                {
                    url += $"&trangThai={trangThai.Value}";
                }
                _allSanPhamList = (await httpClient.GetFromJsonAsync<List<SanPhamDto>>(url)) ?? new List<SanPhamDto>();
                dgSanPham.ItemsSource = _allSanPhamList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải danh sách sản phẩm: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        // (Hàm LoadDinhLuongGridAsync giữ nguyên)
        private async Task LoadDinhLuongGridAsync(int idSanPham)
        {
            if (idSanPham == 0)
            {
                panelDinhLuong.Visibility = Visibility.Collapsed;
                lblDinhLuongInfo.Visibility = Visibility.Visible;
                return;
            }
            try
            {
                var data = await httpClient.GetFromJsonAsync<List<DinhLuongDto>>($"api/app/sanpham/{idSanPham}/dinhluong");
                dgDinhLuong.ItemsSource = data;
                lblDinhLuongTitle.Text = $"Định lượng cho: {_selectedSanPhamDetails?.TenSanPham}";
                panelDinhLuong.Visibility = Visibility.Visible;
                lblDinhLuongInfo.Visibility = Visibility.Collapsed;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải định lượng: {ex.Message}", "Lỗi API");
            }
        }

        #endregion

        #region 2. Form Chi Tiết (Sản Phẩm)

        private void ResetForm()
        {
            _selectedSanPhamDetails = null;

            // SỬA: Đặt lại 2 biến quản lý file
            _currentAnhBiaFilePath = null;
            _deleteImageRequest = false;

            dgSanPham.SelectedItem = null;
            formChiTietSP.IsEnabled = true;
            panelActions.Visibility = Visibility.Visible;
            btnXoa.Visibility = Visibility.Collapsed;
            lblFormTitle.Text = "Thêm Sản Phẩm Mới";
            txtTenSanPham.Text = "";
            txtDonGia.Text = "0";
            txtMoTa.Text = "";
            cmbDanhMuc.SelectedValue = 0;
            cmbDanhMuc.Text = string.Empty;
            cmbNhomIn.SelectedIndex = 0; // "Bar"
            cmbTrangThai.SelectedIndex = 0; // "Đang bán"

            // SỬA: Dùng HinhAnhHelper.LoadImage (với nguồn null)
            AnhSanPhamPreview.Source = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultFoodIcon);

            panelDinhLuong.Visibility = Visibility.Collapsed;
            lblDinhLuongInfo.Visibility = Visibility.Visible;
            dgDinhLuong.ItemsSource = null;
        }

        private async void DgSanPham_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgSanPham.SelectedItem is not SanPhamDto selected)
            {
                ResetForm();
                return;
            }
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                _selectedSanPhamDetails = await httpClient.GetFromJsonAsync<SanPhamDetailDto>($"api/app/sanpham/details/{selected.IdSanPham}");

                if (_selectedSanPhamDetails == null)
                {
                    ResetForm();
                    return;
                }

                // SỬA: Đặt lại 2 biến quản lý file
                _currentAnhBiaFilePath = null;
                _deleteImageRequest = false;

                formChiTietSP.IsEnabled = true;
                panelActions.Visibility = Visibility.Visible;
                btnXoa.Visibility = Visibility.Visible;
                lblFormTitle.Text = $"Cập nhật: {_selectedSanPhamDetails.TenSanPham}";
                txtTenSanPham.Text = _selectedSanPhamDetails.TenSanPham;
                txtDonGia.Text = _selectedSanPhamDetails.GiaBan.ToString("F0");
                txtMoTa.Text = _selectedSanPhamDetails.MoTa;
                cmbDanhMuc.SelectedValue = _selectedSanPhamDetails.IdDanhMuc ?? 0;
                cmbNhomIn.Text = _selectedSanPhamDetails.NhomIn;
                cmbTrangThai.SelectedIndex = _selectedSanPhamDetails.TrangThaiKinhDoanh ? 0 : 1;

                // SỬA: Dùng HinhAnhHelper.LoadImage với URL
                AnhSanPhamPreview.Source = HinhAnhHelper.LoadImage(_selectedSanPhamDetails.HinhAnhUrl, HinhAnhPaths.DefaultFoodIcon);
                await LoadDinhLuongGridAsync(_selectedSanPhamDetails.IdSanPham);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải chi tiết sản phẩm: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnChonAnh_Click(object sender, RoutedEventArgs e)
        {
            var ofd = new OpenFileDialog { Filter = "Image files|*.png;*.jpg;*.jpeg", Title = "Chọn ảnh sản phẩm" };
            if (ofd.ShowDialog() == true)
            {
                try
                {
                    // SỬA: Chỉ lưu đường dẫn file và đánh dấu
                    _currentAnhBiaFilePath = ofd.FileName;
                    _deleteImageRequest = false; // Đã chọn file mới, không xóa

                    // SỬA: Dùng HinhAnhHelper.LoadImage (nó tự nhận diện đường dẫn file)
                    AnhSanPhamPreview.Source = HinhAnhHelper.LoadImage(_currentAnhBiaFilePath, HinhAnhPaths.DefaultFoodIcon);
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Lỗi đọc file ảnh: {ex.Message}", "Lỗi File");
                    _currentAnhBiaFilePath = null;
                    AnhSanPhamPreview.Source = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultFoodIcon);
                }
            }
        }

        // THÊM: Nút Xóa Ảnh
        private void BtnXoaAnh_Click(object sender, RoutedEventArgs e)
        {
            _currentAnhBiaFilePath = null; // Xóa đường dẫn file
            _deleteImageRequest = true;   // Đánh dấu yêu cầu xóa
            AnhSanPhamPreview.Source = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultFoodIcon); // Hiển thị ảnh mặc định
        }

        // SỬA: VIẾT LẠI HOÀN TOÀN HÀM LƯU
        private async void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            // (Phần validation giữ nguyên)
            if (string.IsNullOrWhiteSpace(txtTenSanPham.Text))
            {
                MessageBox.Show("Tên sản phẩm không được để trống.", "Lỗi"); return;
            }
            if (!decimal.TryParse(txtDonGia.Text, out decimal donGia) || donGia < 0)
            {
                MessageBox.Show("Đơn giá không hợp lệ.", "Lỗi"); return;
            }
            if (string.IsNullOrWhiteSpace(cmbDanhMuc.Text) || ((int?)cmbDanhMuc.SelectedValue ?? 0) == 0 && !(_danhMucList.Any(d => d.Ten.Equals(cmbDanhMuc.Text, StringComparison.OrdinalIgnoreCase))))
            {
                MessageBox.Show("Vui lòng chọn hoặc nhập một danh mục hợp lệ.", "Lỗi"); return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                int? danhMucId = await GetOrCreateLookupIdAsync(cmbDanhMuc.Text, _danhMucList, "api/app/sanpham/danhmuc", true);
                if (danhMucId == null)
                {
                    LoadingOverlay.Visibility = Visibility.Collapsed;
                    return;
                }

                // SỬA: Dùng MultipartFormDataContent thay vì DTO
                using var form = new MultipartFormDataContent();

                // 1. Thêm các trường dữ liệu (giống tên thuộc tính DTO)
                form.Add(new StringContent(txtTenSanPham.Text), "TenSanPham");
                if (danhMucId.HasValue)
                    form.Add(new StringContent(danhMucId.Value.ToString()), "IdDanhMuc");
                form.Add(new StringContent(donGia.ToString()), "GiaBan");
                form.Add(new StringContent(txtMoTa.Text ?? ""), "MoTa");
                form.Add(new StringContent((cmbTrangThai.SelectedIndex == 0).ToString()), "TrangThaiKinhDoanh");
                form.Add(new StringContent(cmbNhomIn.Text ?? ""), "NhomIn");

                bool isCreating = (_selectedSanPhamDetails == null);

                // 2. Thêm file (nếu có)
                if (!string.IsNullOrEmpty(_currentAnhBiaFilePath))
                {
                    var fileStream = File.OpenRead(_currentAnhBiaFilePath);
                    var streamContent = new StreamContent(fileStream);
                    streamContent.Headers.ContentType = new MediaTypeHeaderValue("image/jpeg"); // Hoặc "image/png"
                    form.Add(streamContent, "HinhAnhUpload", Path.GetFileName(_currentAnhBiaFilePath));
                }

                // 3. Thêm cờ Xóa ảnh (nếu có)
                if (_deleteImageRequest)
                {
                    form.Add(new StringContent("true"), "XoaHinhAnh");
                }

                // Gán Id nếu là Update
                if (!isCreating)
                {
                    // === SỬA LỖI CS8602 (Dòng 316) ===
                    // Thêm '!' vì logic !isCreating đảm bảo _selectedSanPhamDetails không null
                    form.Add(new StringContent(_selectedSanPhamDetails!.IdSanPham.ToString()), "IdSanPham");
                }


                HttpResponseMessage response;

                if (isCreating)
                {
                    response = await httpClient.PostAsync("api/app/sanpham", form);
                }
                else
                {
                    // === SỬA LỖI CS8602 (Dòng 328) ===
                    // Thêm '!' (lý do tương tự)
                    response = await httpClient.PutAsync($"api/app/sanpham/{_selectedSanPhamDetails!.IdSanPham}", form);
                }

                if (response.IsSuccessStatusCode)
                {
                    await LoadDataGridAsync();
                    await LoadFiltersAsync();

                    if (isCreating)
                    {
                        var newSanPham = await response.Content.ReadFromJsonAsync<SanPhamDetailDto>();

                        // === SỬA LỖI CS8602 (Dòng 339) ===
                        // Thêm kiểm tra null sau khi deserialize
                        if (newSanPham == null)
                        {
                            MessageBox.Show("Lỗi: API đã tạo thành công nhưng không trả về dữ liệu.", "Lỗi Phản Hồi API");
                            return; // Thoát sớm
                        }

                        MessageBox.Show($"Sản phẩm '{newSanPham.TenSanPham}' đã được tạo.\n\nVUI LÒNG THÊM ĐỊNH LƯỢNG NGUYÊN LIỆU.", "Thêm Định Lượng");

                        var newItemInGrid = _allSanPhamList.FirstOrDefault(s => s.IdSanPham == newSanPham.IdSanPham);
                        dgSanPham.SelectedItem = newItemInGrid;
                        MainTabControl.SelectedIndex = 2;
                    }
                    else // CẬP NHẬT
                    {
                        MessageBox.Show("Lưu thành công!", "Thông báo");
                    }
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
                // SỬA: Đặt lại 2 biến quản lý file
                _currentAnhBiaFilePath = null;
                _deleteImageRequest = false;
            }
        }

        private async void BtnXoa_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedSanPhamDetails == null) return;
            var result = MessageBox.Show($"Bạn có chắc chắn muốn xóa '{_selectedSanPhamDetails.TenSanPham}'?", "Xác nhận", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/sanpham/{_selectedSanPhamDetails.IdSanPham}");
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Xóa thành công!", "Thông báo");
                    await LoadDataGridAsync();
                    ResetForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnLamMoiForm_Click(object sender, RoutedEventArgs e)
        {
            ResetForm();
        }
        // ... (BtnXoa_Click, BtnLamMoiForm giữ nguyên) ...
        #endregion

        // ... (Toàn bộ các Region 3, 4, 5, 6 giữ nguyên) ...
        // (Các hàm Tab Danh Mục và Tab Định Lượng giữ nguyên)
        #region 3. Lọc / Tìm kiếm / Excel
        private async void Filter_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (cmbFilterDanhMuc.IsLoaded && cmbFilterTrangThai.IsLoaded)
            {
                await LoadDataGridAsync();
            }
        }
        private async void TxtSearchSanPham_TextChanged(object sender, TextChangedEventArgs e)
        {
            await LoadDataGridAsync();
        }
        private async void BtnClearFilter_Click(object sender, RoutedEventArgs e)
        {
            txtSearchSanPham.Text = "";
            cmbFilterDanhMuc.SelectedValue = 0;
            cmbFilterTrangThai.SelectedIndex = 0;
            await LoadDataGridAsync();
        }
        private void BtnExportToExcel_Click(object sender, RoutedEventArgs e)
        {
            var sfd = new SaveFileDialog { Filter = "Excel Files (*.xlsx)|*.xlsx", FileName = $"DSSP_{DateTime.Now:yyyyMMdd_HHmm}.xlsx" };
            if (sfd.ShowDialog() == true)
            {
                try
                {
                    ExcelPackage.License.SetNonCommercialPersonal("CafeBook");
                    using (var package = new ExcelPackage(new FileInfo(sfd.FileName)))
                    {
                        var ws = package.Workbook.Worksheets.Add("DanhSachSanPham");
                        ws.Cells["A1"].Value = "Danh sách Sản phẩm";
                        ws.Cells["A1:D1"].Merge = true;
                        ws.Cells["A1"].Style.Font.Bold = true;
                        ws.Cells["A1"].Style.Font.Size = 16;
                        ws.Cells["A3"].LoadFromCollection(_allSanPhamList, true, OfficeOpenXml.Table.TableStyles.Medium9);
                        ws.Column(3).Style.Numberformat.Format = "#,##0 \"đ\"";
                        ws.Cells[ws.Dimension.Address].AutoFitColumns();
                        package.Save();
                    }
                    MessageBox.Show("Xuất Excel thành công!", "Thông báo");
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Lỗi khi xuất Excel: {ex.Message}", "Lỗi");
                }
            }
        }
        #endregion
        #region 4. Tab Quản lý Danh mục (CRUD Danh Mục)
        private void ResetDanhMucForm()
        {
            txtTenDanhMuc.Text = "";
            lbDanhMuc.SelectedItem = null;
        }
        private void LbDanhMuc_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (lbDanhMuc.SelectedItem is FilterLookupDto selected)
            {
                txtTenDanhMuc.Text = selected.Ten;
            }
        }
        private async void BtnThemDanhMuc_Click(object sender, RoutedEventArgs e)
        {
            await CrudLookupAsync("api/app/sanpham/danhmuc", null, txtTenDanhMuc.Text, false, true);
        }
        private async void BtnLuuDanhMuc_Click(object sender, RoutedEventArgs e)
        {
            if (lbDanhMuc.SelectedItem is FilterLookupDto selected)
            {
                await CrudLookupAsync($"api/app/sanpham/danhmuc/{selected.Id}", selected.Id, txtTenDanhMuc.Text, false, true);
            }
        }
        private async void BtnXoaDanhMuc_Click(object sender, RoutedEventArgs e)
        {
            if (lbDanhMuc.SelectedItem is FilterLookupDto selected)
            {
                await CrudLookupAsync($"api/app/sanpham/danhmuc/{selected.Id}", selected.Id, null, true, true);
            }
        }
        #endregion
        #region 5. Tab Định Lượng
        private void ResetDinhLuongForm()
        {
            cmbNguyenLieu.SelectedValue = 0;
            txtSoLuongNL.Text = "0";
            cmbDonViTinhNL.ItemsSource = null;
        }
        private void CmbNguyenLieu_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            int selectedNLId = 0;
            if (cmbNguyenLieu.SelectedItem is FilterLookupDto selectedNL)
            {
                selectedNLId = selectedNL.Id;
            }
            else if (!string.IsNullOrEmpty(cmbNguyenLieu.Text))
            {
                var matchedNL = _nguyenLieuList.FirstOrDefault(nl => nl.Ten.Equals(cmbNguyenLieu.Text, StringComparison.OrdinalIgnoreCase));
                if (matchedNL != null)
                {
                    selectedNLId = matchedNL.Id;
                }
            }
            if (selectedNLId > 0)
            {
                var dvtChoNL = _donViTinhList.Where(d => d.IdNguyenLieu == selectedNLId).ToList();
                cmbDonViTinhNL.ItemsSource = dvtChoNL;
                if (dvtChoNL.Any())
                {
                    cmbDonViTinhNL.SelectedIndex = 0;
                }
            }
            else
            {
                cmbDonViTinhNL.ItemsSource = null;
            }
        }
        private void DgDinhLuong_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgDinhLuong.SelectedItem is DinhLuongDto selected)
            {
                cmbNguyenLieu.SelectedValue = selected.IdNguyenLieu;
                cmbDonViTinhNL.SelectedValue = selected.IdDonViSuDung;
                txtSoLuongNL.Text = selected.SoLuong.ToString(CultureInfo.InvariantCulture);
            }
        }
        private async void BtnLuuDinhLuong_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedSanPhamDetails == null) return;
            if (cmbNguyenLieu.SelectedValue == null || (int)cmbNguyenLieu.SelectedValue == 0)
            {
                MessageBox.Show("Vui lòng chọn một nguyên liệu.", "Lỗi"); return;
            }
            if (cmbDonViTinhNL.SelectedValue == null)
            {
                MessageBox.Show("Vui lòng chọn đơn vị tính.", "Lỗi"); return;
            }
            if (!decimal.TryParse(txtSoLuongNL.Text, NumberStyles.Any, CultureInfo.InvariantCulture, out decimal soLuong) || soLuong <= 0)
            {
                MessageBox.Show("Số lượng phải là số dương.", "Lỗi"); return;
            }
            var dto = new DinhLuongUpdateRequestDto
            {
                IdSanPham = _selectedSanPhamDetails.IdSanPham,
                IdNguyenLieu = (int)cmbNguyenLieu.SelectedValue,
                IdDonViSuDung = (int)cmbDonViTinhNL.SelectedValue,
                SoLuong = soLuong
            };
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/sanpham/dinhluong", dto);
                if (response.IsSuccessStatusCode)
                {
                    await LoadDinhLuongGridAsync(dto.IdSanPham);
                    ResetDinhLuongForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }
        private async void BtnXoaDinhLuong_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedSanPhamDetails == null) return;
            if (dgDinhLuong.SelectedItem is not DinhLuongDto selected)
            {
                MessageBox.Show("Vui lòng chọn một nguyên liệu từ danh sách để xóa.", "Lỗi"); return;
            }
            var result = MessageBox.Show($"Xóa '{selected.TenNguyenLieu}' khỏi công thức?", "Xác nhận", MessageBoxButton.YesNo);
            if (result == MessageBoxResult.No) return;
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/sanpham/dinhluong/{_selectedSanPhamDetails.IdSanPham}/{selected.IdNguyenLieu}");
                if (response.IsSuccessStatusCode)
                {
                    await LoadDinhLuongGridAsync(_selectedSanPhamDetails.IdSanPham);
                    ResetDinhLuongForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }
        #endregion
        #region 6. Helper Functions (Smart ComboBox, CRUD)
        private async Task<int?> GetOrCreateLookupIdAsync(string tenDaNhap, List<FilterLookupDto> list, string apiEndpoint, bool isDanhMuc = false)
        {
            if (string.IsNullOrWhiteSpace(tenDaNhap) || tenDaNhap.StartsWith("--"))
            {
                if (isDanhMuc) return null;
                return null;
            }
            var item = list.FirstOrDefault(x => x.Ten.Equals(tenDaNhap, StringComparison.OrdinalIgnoreCase));
            if (item != null)
            {
                return item.Id;
            }
            try
            {
                var response = await httpClient.PostAsJsonAsync(apiEndpoint, new FilterLookupDto { Ten = tenDaNhap });
                if (response.IsSuccessStatusCode)
                {
                    var newItem = await response.Content.ReadFromJsonAsync<FilterLookupDto>();
                    if (newItem != null)
                    {
                        if (isDanhMuc) _danhMucList.Add(newItem);
                        return newItem.Id;
                    }
                    return null;
                }
                else
                {
                    MessageBox.Show($"Không thể tự động thêm '{tenDaNhap}': {await response.Content.ReadAsStringAsync()}", "Lỗi Tạo Mới");
                    return null;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi API khi tạo mới: {ex.Message}", "Lỗi");
                return null;
            }
        }
        private async Task CrudLookupAsync(string endpoint, int? id, string? ten, bool isDelete = false, bool isDanhMuc = false)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                HttpResponseMessage response;
                if (isDelete)
                {
                    if (MessageBox.Show("Bạn có chắc chắn muốn xóa?", "Xác nhận", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.No)
                    {
                        LoadingOverlay.Visibility = Visibility.Collapsed;
                        return;
                    }
                    response = await httpClient.DeleteAsync(endpoint);
                }
                else if (string.IsNullOrWhiteSpace(ten))
                {
                    MessageBox.Show("Tên không được để trống.", "Lỗi");
                    LoadingOverlay.Visibility = Visibility.Collapsed;
                    return;
                }
                else if (id.HasValue && id > 0) // Update (PUT)
                {
                    response = await httpClient.PutAsJsonAsync(endpoint, new FilterLookupDto { Id = id.Value, Ten = ten });
                }
                else // Create (POST)
                {
                    response = await httpClient.PostAsJsonAsync(endpoint, new FilterLookupDto { Ten = ten });
                }

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Thao tác thành công!", "Thông báo");
                    await LoadFiltersAsync(); // Tải lại TOÀN BỘ
                    if (isDanhMuc) ResetDanhMucForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }
        #endregion
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyTonKhoView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyTonKhoView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quản lý Tồn Kho" FontFamily="Segoe UI" Loaded="Page_Loaded"
      Background="#FFF8E1">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="StatusYellowBrush" Color="#FFF9C4"/>
        <SolidColorBrush x:Key="StatusRedBrush" Color="#FFEBEE"/>

        <Geometry x:Key="IconWarehouse">M12,3L2,8V21H22V8L12,3M19,19H15V13H9V19H5V9.4L12,5.5L19,9.4V19Z</Geometry>
        <Geometry x:Key="IconBoxIn">M16.75 9H15.25V6H9.25V9H7.75L12.25 13.5L16.75 9M19.35 15.04C19.76 14.63 20 14.11 20 13.5V6C20 4.9 19.1 4 18 4H6C4.9 4 4 4.9 4 6V13.5C4 14.11 4.24 14.63 4.65 15.04L9 19.38V22H15V19.38L19.35 15.04Z</Geometry>
        <Geometry x:Key="IconBoxOut">M5.63 15.04C5.22 14.63 5 14.11 5 13.5V6C5 4.9 5.9 4 7 4H17C18.1 4 19 4.9 19 6V13.5C19 14.11 18.78 14.63 18.37 15.04L14 19.38V22H10V19.38L5.63 15.04M8 11H9.5V14H14.5V11H16L12 6.5L8 11Z</Geometry>
        <Geometry x:Key="IconChecklist">M21,17.45V6.5C21,5.4 20.1,4.5 19,4.5H13V6.5H19V17.45L16.73,15.18L15.32,16.59L20,21.27L21.39,19.89L21,19.5V19.5L21,17.45M11,6.5H5V19.5H11V6.5M9,11.5H7V13.5H9V11.5M17,11.5H13V13.5H17V11.5M17,8.5H13V10.5H17V8.5Z</Geometry>
        <Geometry x:Key="IconSupplier">M16,13C17.7,13 21,13.9 21,15.5V17H11V15.5C11,13.9 14.3,13 16,13M8,13C9.7,13 13,13.9 13,15.5V17H3V15.5C3,13.9 6.3,13 8,13M8,11.5A3.5,3.5 0 0,0 11.5,8A3.5,3.5 0 0,0 8,4.5A3.5,3.5 0 0,0 4.5,8A3.5,3.5 0 0,0 8,11.5M16,11.5A3.5,3.5 0 0,0 19.5,8A3.5,3.5 0 0,0 16,4.5A3.5,3.5 0 0,0 12.5,8A3.5,3.5 0 0,0 16,11.5Z</Geometry>
        <Geometry x:Key="IconSettings">M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M12,22C11.6,22 11.2,21.9 10.8,21.7L9.1,20.9C5.1,19.3 2,15.2 2,10.9V5L12,2L22,5V10.9C22,15.2 18.9,19.3 14.9,20.9L13.2,21.7C12.8,21.9 12.4,22 12,22Z</Geometry>

        <Geometry x:Key="IconReport">M10,17L6,21H18L14,17H10M10,10H14V15H10V10M4,3H20C21.1,3 22,3.9 22,5V17C22,18.1 21.1,19 20,19H4C2.9,19 2,18.1 2,17V5C2,3.9 2.9,3 4,3Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="DataGridRow" x:Key="StockDataGridRowStyle">
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding TinhTrang}" Value="Hết hàng">
                    <Setter Property="Background" Value="{StaticResource StatusRedBrush}"/>
                    <Setter Property="Foreground" Value="{StaticResource ActionRedBrush}"/>
                    <Setter Property="FontWeight" Value="Bold"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TinhTrang}" Value="Sắp hết">
                    <Setter Property="Background" Value="{StaticResource StatusYellowBrush}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <Border Grid.Row="0" Style="{StaticResource CardBorder}" Margin="0,0,0,15">
                <WrapPanel Orientation="Horizontal">
                    <Button x:Name="btnGoToTonKho" Style="{StaticResource PrimaryButton}" Margin="0,0,10,10" IsEnabled="False" Background="{StaticResource DarkBrownBrush}">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconWarehouse}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Tồn Kho" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <Button x:Name="btnGoToNguyenLieu" Style="{StaticResource PrimaryButton}" Margin="0,0,10,10" Click="BtnGoToNguyenLieu_Click">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconSettings}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Quản lý Nguyên Liệu" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <Button x:Name="btnGoToNhapKho" Style="{StaticResource PrimaryButton}" Margin="0,0,10,10" Click="BtnGoToNhapKho_Click">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconBoxIn}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Quản lý Nhập Kho" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <Button x:Name="btnGoToXuatHuy" Style="{StaticResource PrimaryButton}" Margin="0,0,10,10" Click="BtnGoToXuatHuy_Click">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconBoxOut}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Quản lý Xuất Hủy" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <Button x:Name="btnGoToKiemKho" Style="{StaticResource PrimaryButton}" Margin="0,0,10,10" Click="BtnGoToKiemKho_Click">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconChecklist}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Quản lý Kiểm Kho" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <Button x:Name="btnGoToNCC" Style="{StaticResource PrimaryButton}" Margin="0,0,10,10" Click="BtnGoToNCC_Click">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconSupplier}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Nhà Cung Cấp" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <Button x:Name="btnGoToBaoCaoKho" Style="{StaticResource PrimaryButton}" Margin="0,0,10,10" Click="BtnGoToBaoCaoKho_Click" Background="#00724C">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconReport}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Xem Báo Cáo Kho" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </WrapPanel>
            </Border>

            <Border Grid.Row="1" Style="{StaticResource CardBorder}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <TextBlock Grid.Row="0" Text="Tất cả Nguyên liệu trong kho" Style="{StaticResource HeaderTextBlock}"/>
                    <DataGrid Grid.Row="1" x:Name="dgTonKho" AutoGenerateColumns="False" IsReadOnly="True" 
                              BorderThickness="0" RowHeaderWidth="0">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="ID" Binding="{Binding IdNguyenLieu}" Width="50"/>
                            <DataGridTextColumn Header="Tên Nguyên liệu" Binding="{Binding TenNguyenLieu}" Width="*"/>
                            <DataGridTextColumn Header="Số lượng tồn" Binding="{Binding TonKho, StringFormat=N2}" Width="150"/>
                            <DataGridTextColumn Header="Đơn vị tính" Binding="{Binding DonViTinh}" Width="150"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Border>

            <GridSplitter Grid.Row="2" Height="5" HorizontalAlignment="Stretch" Background="Transparent" ResizeBehavior="PreviousAndNext"/>

            <Border Grid.Row="3" Style="{StaticResource CardBorder}" Margin="0,5,0,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <TextBlock Grid.Row="0" Text="Cảnh báo Tồn kho thấp (Tự động)" Style="{StaticResource HeaderTextBlock}" Foreground="{StaticResource ActionRedBrush}"/>
                    <DataGrid Grid.Row="1" x:Name="dgCanhBao" AutoGenerateColumns="False" IsReadOnly="True" 
                              BorderThickness="0" RowHeaderWidth="0"
                              RowStyle="{StaticResource StockDataGridRowStyle}">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="ID" Binding="{Binding IdNguyenLieu}" Width="50"/>
                            <DataGridTextColumn Header="Tên Nguyên liệu" Binding="{Binding TenNguyenLieu}" Width="*"/>
                            <DataGridTextColumn Header="SL Tồn" Binding="{Binding TonKho, StringFormat=N2}" Width="100"/>
                            <DataGridTextColumn Header="ĐVT" Binding="{Binding DonViTinh}" Width="80"/>
                            <DataGridTextColumn Header="Ngưỡng" Binding="{Binding TonKhoToiThieu, StringFormat=N2}" Width="100"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Border>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Đang tải..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyTonKhoView.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using AppCafebookApi.View.common; // <-- THÊM MỚI

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyTonKhoView : Page
    {
        private static readonly HttpClient httpClient;
        private List<NguyenLieuTonKhoDto> _tonKhoList = new List<NguyenLieuTonKhoDto>();

        static QuanLyTonKhoView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyTonKhoView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadTonKhoAsync();
        }

        private async Task LoadTonKhoAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                _tonKhoList = (await httpClient.GetFromJsonAsync<List<NguyenLieuTonKhoDto>>("api/app/kho/tonkho")) ?? new List<NguyenLieuTonKhoDto>();

                dgTonKho.ItemsSource = _tonKhoList.Where(nl => nl.TinhTrang == "Đủ dùng").ToList();
                dgCanhBao.ItemsSource = _tonKhoList.Where(nl => nl.TinhTrang == "Sắp hết" || nl.TinhTrang == "Hết hàng").ToList();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải tồn kho: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #region Navigation

        private void BtnGoToNguyenLieu_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new QuanLyNguyenLieuView());
        }

        private void BtnGoToNhapKho_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new QuanLyNhapKhoView());
        }

        private void BtnGoToXuatHuy_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new QuanLyXuatHuyView());
        }

        private void BtnGoToKiemKho_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new QuanLyKiemKhoView());
        }

        private void BtnGoToNCC_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new QuanLyNhaCungCapView());
        }

        // --- THÊM MỚI: Xử lý nút Báo Cáo ---
        private void BtnGoToBaoCaoKho_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new BaoCaoTonKhoNguyenLieuPreviewWindow());
        }

        #endregion
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyVaiTroView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyVaiTroView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quản lý Vai trò"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>
        
        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>
        <Geometry x:Key="IconPermissions">M12,3L1,9L12,15L23,9L12,3M19,9.3L19,16.6C19,17.2 18.7,17.8 18.2,18.1L12,22L5.8,18.1C5.3,17.8 5,17.2 5,16.6V9.3L12,13.2L19,9.3Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Quản lý Vai Trò &amp; Phân Quyền" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="350"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Margin="10,0,15,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Text="Danh sách Vai trò" Style="{StaticResource HeaderTextBlock}"/>
                        <DataGrid Grid.Row="1" x:Name="dgVaiTro" AutoGenerateColumns="False" IsReadOnly="True" 
                                  SelectionMode="Single" SelectionChanged="DgVaiTro_SelectionChanged"
                                  BorderThickness="0" RowHeaderWidth="0">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ID" Binding="{Binding IdVaiTro}" Width="50"/>
                                <DataGridTextColumn Header="Tên Vai Trò" Binding="{Binding TenVaiTro}" Width="*"/>
                                <DataGridTextColumn Header="Mô Tả" Binding="{Binding MoTa}" Width="2*"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>

                <Border Grid.Column="1" Margin="0,0,10,10" Style="{StaticResource CardBorder}">
                    <StackPanel>
                        <TextBlock Text="Thông tin Vai trò" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,15"/>

                        <TextBlock Text="Tên Vai Trò:" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtTenVaiTro" Margin="0,0,0,10"/>

                        <TextBlock Text="Mô tả:" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtMoTa" Margin="0,0,0,15" Height="80" TextWrapping="Wrap" AcceptsReturn="True"/>

                        <Grid Height="40">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Button x:Name="btnLamMoi" Grid.Column="0" ToolTip="Làm mới" Click="BtnLamMoi_Click" Background="Transparent" BorderThickness="0">
                                <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="22" Height="22"/>
                            </Button>
                            <Button x:Name="btnThem" Grid.Column="1" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionGreenBrush}" Click="BtnThem_Click" Margin="10,0,5,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconAdd}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="Thêm" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                            <Button x:Name="btnLuu" Grid.Column="2" Style="{StaticResource PrimaryButton}" Click="BtnLuu_Click" Margin="5,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconSave}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="Lưu" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                            <Button x:Name="btnXoa" Grid.Column="3" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionRedBrush}" Click="BtnXoa_Click" Margin="5,0,0,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconDelete}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="Xóa" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </Grid>

                        <Button x:Name="btnGoToPhanQuyen" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionBlueBrush}" 
                                Click="BtnGoToPhanQuyen_Click" Margin="0,20,0,0">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconPermissions}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="Phân Quyền Chức Năng (Chưa có)" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Border>
            </Grid>

            <Button x:Name="btnQuayLai" Grid.Row="2" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" Margin="10,0,0,10"
                    Click="BtnQuayLai_Click">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                    <TextBlock Text="Quay lại" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Đang tải..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyVaiTroView.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyVaiTroView : Page
    {
        private static readonly HttpClient httpClient;
        private List<VaiTroDto> _allVaiTroList = new List<VaiTroDto>();
        private VaiTroDto? _selectedVaiTro = null;

        static QuanLyVaiTroView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyVaiTroView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadDataGridAsync();
            ResetForm();
        }

        private async Task LoadDataGridAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                _allVaiTroList = (await httpClient.GetFromJsonAsync<List<VaiTroDto>>("api/app/vaitro/all")) ?? new List<VaiTroDto>();
                dgVaiTro.ItemsSource = _allVaiTroList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải danh sách vai trò: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void ResetForm()
        {
            _selectedVaiTro = null;
            dgVaiTro.SelectedItem = null;
            txtTenVaiTro.Text = "";
            txtMoTa.Text = "";
            btnThem.IsEnabled = true;
            btnLuu.IsEnabled = false;
            btnXoa.IsEnabled = false;
        }

        private void DgVaiTro_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgVaiTro.SelectedItem is VaiTroDto selected)
            {
                _selectedVaiTro = selected;
                txtTenVaiTro.Text = selected.TenVaiTro;
                txtMoTa.Text = selected.MoTa;
                btnThem.IsEnabled = false;
                btnLuu.IsEnabled = true;
                btnXoa.IsEnabled = true;
            }
            else
            {
                ResetForm();
            }
        }

        private async void BtnThem_Click(object sender, RoutedEventArgs e)
        {
            await SaveAsync(isCreating: true);
        }

        private async void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            await SaveAsync(isCreating: false);
        }

        private async Task SaveAsync(bool isCreating)
        {
            if (string.IsNullOrWhiteSpace(txtTenVaiTro.Text))
            {
                MessageBox.Show("Tên vai trò là bắt buộc.", "Lỗi"); return;
            }

            var dto = new VaiTroDto
            {
                TenVaiTro = txtTenVaiTro.Text,
                MoTa = txtMoTa.Text
            };

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                HttpResponseMessage response;
                if (isCreating)
                {
                    response = await httpClient.PostAsJsonAsync("api/app/vaitro", dto);
                }
                else
                {
                    // === SỬA LỖI CS8602 ===
                    // Thêm '!' vì logic UI (btnLuu.IsEnabled) đảm bảo _selectedVaiTro không null
                    dto.IdVaiTro = _selectedVaiTro!.IdVaiTro;
                    response = await httpClient.PutAsJsonAsync($"api/app/vaitro/{dto.IdVaiTro}", dto);
                }

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Lưu thành công!", "Thông báo");
                    await LoadDataGridAsync();
                    ResetForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXoa_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedVaiTro == null) return;

            var result = MessageBox.Show($"Bạn có chắc muốn xóa vai trò '{_selectedVaiTro.TenVaiTro}'?", "Xác nhận", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/vaitro/{_selectedVaiTro.IdVaiTro}");
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Xóa thành công!", "Thông báo");
                    await LoadDataGridAsync();
                    ResetForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Không thể xóa");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnLamMoi_Click(object sender, RoutedEventArgs e)
        {
            ResetForm();
        }

        private void BtnGoToPhanQuyen_Click(object sender, RoutedEventArgs e)
        {
            // Chuyển sang trang Phân Quyền
            this.NavigationService?.Navigate(new PhanQuyenView());
        }

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyXuatHuyView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyXuatHuyView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quản lý Xuất Hủy" FontFamily="Segoe UI" Loaded="Page_Loaded"
      Background="#FFF8E1">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>

        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Quản lý Xuất Hủy Nguyên Liệu" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*"/>
                    <ColumnDefinition Width="3*"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Margin="10,0,15,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Text="Lịch sử Phiếu Xuất Hủy" Style="{StaticResource HeaderTextBlock}"/>

                        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,10">
                            <TextBlock Text="Từ:" VerticalAlignment="Center"/>
                            <DatePicker x:Name="dpTuNgay_Phieu" Width="120" Margin="5,0,0,0"/>
                            <TextBlock Text="Đến:" VerticalAlignment="Center" Margin="10,0,5,0"/>
                            <DatePicker x:Name="dpDenNgay_Phieu" Width="120" Margin="0,0,10,0"/>
                            <Button x:Name="btnLocPhieu" Content="Lọc" Style="{StaticResource PrimaryButton}" Padding="10,5" Width="50" Click="BtnLocPhieu_Click"/>
                        </StackPanel>

                        <DataGrid Grid.Row="2" x:Name="dgPhieuXuatHuy" AutoGenerateColumns="False" IsReadOnly="True" 
                                  SelectionMode="Single" SelectionChanged="DgPhieuXuatHuy_SelectionChanged" 
                                  BorderThickness="0" RowHeaderWidth="0">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ID" Binding="{Binding IdPhieuXuatHuy}" Width="40"/>
                                <DataGridTextColumn Header="Ngày Hủy" Binding="{Binding NgayXuatHuy, StringFormat='dd/MM/yyyy'}" Width="100"/>
                                <DataGridTextColumn Header="Người Lập" Binding="{Binding TenNhanVien}" Width="*"/>
                                <DataGridTextColumn Header="Giá Trị Hủy" Binding="{Binding TongGiaTriHuy, StringFormat=N0}" Width="100"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>

                <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto" Margin="0,0,10,10">
                    <StackPanel>
                        <Border Style="{StaticResource CardBorder}">
                            <StackPanel>
                                <Grid Margin="0,0,0,15">
                                    <TextBlock Text="Thông tin Phiếu Hủy" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" VerticalAlignment="Center" />
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                        <Button x:Name="btnTaoPhieuMoi" Style="{StaticResource PrimaryButton}" Click="BtnTaoPhieuMoi_Click" Padding="10,8">
                                            <StackPanel Orientation="Horizontal">
                                                <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                                    <Path Data="{StaticResource IconNew}" Fill="White"/>
                                                </Viewbox>
                                                <TextBlock Text="Tạo Phiếu Mới" VerticalAlignment="Center" Margin="0,1,0,0"/>
                                            </StackPanel>
                                        </Button>
                                    </StackPanel>
                                </Grid>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Ngày hủy:" VerticalAlignment="Center" Margin="0,5,15,5"/>
                                    <DatePicker Grid.Row="0" Grid.Column="1" x:Name="dpNgayHuy" Margin="0,5"/>
                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Lý do hủy (*):" VerticalAlignment="Top" Margin="0,10,15,5"/>
                                    <TextBox Grid.Row="1" Grid.Column="1" x:Name="txtLyDoHuy" Margin="0,5" Height="60" TextWrapping="Wrap" AcceptsReturn="True"/>
                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Tổng giá trị:" VerticalAlignment="Center" Margin="0,5,15,5"/>
                                    <TextBlock Grid.Row="2" Grid.Column="1" x:Name="lblTongGiaTriHuy" Margin="0,5" FontSize="16" FontWeight="Bold" Foreground="{StaticResource ActionRedBrush}" Text="0 VND"/>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <Border Style="{StaticResource CardBorder}" Margin="0,15,0,0">
                            <StackPanel>
                                <TextBlock Text="Chi tiết Nguyên liệu Hủy" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,10"/>
                                <DataGrid x:Name="dgChiTietPhieuHuy" AutoGenerateColumns="False" MaxHeight="250"
                                          CanUserAddRows="False" CanUserDeleteRows="True"
                                          CellEditEnding="DgChiTietPhieuHuy_CellEditEnding">
                                    <DataGrid.Columns>
                                        <DataGridComboBoxColumn Header="Tên Nguyên liệu" x:Name="colNguyenLieu" 
                                                                SelectedValueBinding="{Binding IdNguyenLieu}" 
                                                                SelectedValuePath="IdNguyenLieu" 
                                                                DisplayMemberPath="TenNguyenLieu" Width="*"/>
                                        <DataGridTextColumn Header="Số lượng Hủy" Binding="{Binding SoLuong}" Width="100"/>
                                        <DataGridTextColumn Header="Giá trị Hủy" Binding="{Binding ThanhTien, StringFormat=N0}" Width="120" IsReadOnly="True"/>
                                    </DataGrid.Columns>
                                </DataGrid>

                                <Button x:Name="btnThemDong" Style="{StaticResource PrimaryButton}" Margin="0,10,0,0" Padding="10,5" HorizontalAlignment="Left"
                                        Click="BtnThemDong_Click" Background="{StaticResource ActionBlueBrush}">
                                    <StackPanel Orientation="Horizontal">
                                        <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                            <Path Data="{StaticResource IconAdd}" Fill="White"/>
                                        </Viewbox>
                                        <TextBlock Text="Thêm Dòng" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>

                                <Button x:Name="btnLuuPhieuHuy" Margin="0,15,0,0" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionGreenBrush}" Click="BtnLuuPhieuHuy_Click">
                                    <StackPanel Orientation="Horizontal">
                                        <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                            <Path Data="{StaticResource IconSave}" Fill="White"/>
                                        </Viewbox>
                                        <TextBlock Text="Lưu Phiếu Hủy" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </Grid>

            <Button x:Name="btnQuayLai" Grid.Row="2" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" Margin="10,0,0,10"
                    Click="BtnQuayLai_Click">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                    <TextBlock Text="Quay lại Tồn Kho" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Đang tải..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyXuatHuyView.xaml.cs
================================================================================
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using System.Collections.ObjectModel;
using System.Globalization;
using AppCafebookApi.Services;

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyXuatHuyView : Page
    {
        private static readonly HttpClient httpClient;

        private List<PhieuXuatHuyDto> _phieuXuatHuyList = new List<PhieuXuatHuyDto>();
        private ObservableCollection<ChiTietPhieuXuatHuyDto> _chiTietPhieuHuyList = new ObservableCollection<ChiTietPhieuXuatHuyDto>();
        private bool _isCreatingPhieuHuy = false;

        // Cache
        private List<NguyenLieuCrudDto> _nguyenLieuList = new List<NguyenLieuCrudDto>(); // Dùng cho ComboBox

        static QuanLyXuatHuyView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyXuatHuyView()
        {
            InitializeComponent();
            dpTuNgay_Phieu.SelectedDate = DateTime.Today.AddDays(-30);
            dpDenNgay_Phieu.SelectedDate = DateTime.Today;
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            await LoadNguyenLieuAsync();
            await LoadPhieuHuyAsync();
            ResetPhieuHuyForm();
            LoadingOverlay.Visibility = Visibility.Collapsed;
        }

        #region Tải Dữ Liệu

        private async Task LoadNguyenLieuAsync()
        {
            try
            {
                _nguyenLieuList = (await httpClient.GetFromJsonAsync<List<NguyenLieuCrudDto>>("api/app/kho/nguyenlieu")) ?? new List<NguyenLieuCrudDto>();

                var nlList = _nguyenLieuList.Select(nl => new { nl.IdNguyenLieu, TenNguyenLieu = $"{nl.TenNguyenLieu} (Tồn: {nl.TonKho:N2} {nl.DonViTinh})" }).ToList();
                nlList.Insert(0, new { IdNguyenLieu = 0, TenNguyenLieu = "-- Chọn Nguyên Liệu --" });
                colNguyenLieu.ItemsSource = nlList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải nguyên liệu: {ex.Message}", "Lỗi API");
            }
        }

        private async Task LoadPhieuHuyAsync()
        {
            DateTime? start = dpTuNgay_Phieu.SelectedDate;
            DateTime? end = dpDenNgay_Phieu.SelectedDate;

            try
            {
                string url = "api/app/kho/phieuxuathuy";
                if (start.HasValue && end.HasValue)
                {
                    url += $"?startDate={start.Value:yyyy-MM-dd}&endDate={end.Value:yyyy-MM-dd}";
                }

                _phieuXuatHuyList = (await httpClient.GetFromJsonAsync<List<PhieuXuatHuyDto>>(url)) ?? new List<PhieuXuatHuyDto>();
                dgPhieuXuatHuy.ItemsSource = _phieuXuatHuyList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải phiếu hủy: {ex.Message}", "Lỗi API");
            }
        }

        #endregion

        #region Xử lý Form

        private void ResetPhieuHuyForm()
        {
            _isCreatingPhieuHuy = false;
            dgPhieuXuatHuy.SelectedItem = null;

            dpNgayHuy.SelectedDate = DateTime.Today;
            txtLyDoHuy.Text = "";
            lblTongGiaTriHuy.Text = "0 VND";

            _chiTietPhieuHuyList.Clear();
            dgChiTietPhieuHuy.ItemsSource = _chiTietPhieuHuyList;

            btnLuuPhieuHuy.IsEnabled = false;
            btnThemDong.IsEnabled = false;
            dgChiTietPhieuHuy.IsReadOnly = true;
        }

        private void BtnTaoPhieuMoi_Click(object sender, RoutedEventArgs e)
        {
            ResetPhieuHuyForm();
            _isCreatingPhieuHuy = true;
            btnLuuPhieuHuy.IsEnabled = true;
            btnThemDong.IsEnabled = true;
            dgChiTietPhieuHuy.IsReadOnly = false;
        }

        private async void BtnLocPhieu_Click(object sender, RoutedEventArgs e)
        {
            await LoadPhieuHuyAsync();
        }

        private async void DgPhieuXuatHuy_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgPhieuXuatHuy.SelectedItem is not PhieuXuatHuyDto selected)
            {
                ResetPhieuHuyForm();
                return;
            }

            _isCreatingPhieuHuy = false;
            btnLuuPhieuHuy.IsEnabled = false;
            btnThemDong.IsEnabled = false;
            dgChiTietPhieuHuy.IsReadOnly = true;

            try
            {
                var details = await httpClient.GetFromJsonAsync<List<ChiTietPhieuXuatHuyDto>>($"api/app/kho/phieuxuathuy/{selected.IdPhieuXuatHuy}");
                _chiTietPhieuHuyList = new ObservableCollection<ChiTietPhieuXuatHuyDto>(details ?? new List<ChiTietPhieuXuatHuyDto>());
                dgChiTietPhieuHuy.ItemsSource = _chiTietPhieuHuyList;

                dpNgayHuy.SelectedDate = selected.NgayXuatHuy;
                txtLyDoHuy.Text = selected.LyDoXuatHuy;
                lblTongGiaTriHuy.Text = selected.TongGiaTriHuy.ToString("N0") + " VND";
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi tải chi tiết phiếu hủy: {ex.Message}", "Lỗi API");
            }
        }

        private void BtnThemDong_Click(object sender, RoutedEventArgs e)
        {
            _chiTietPhieuHuyList.Add(new ChiTietPhieuXuatHuyDto { SoLuong = 1 });
            dgChiTietPhieuHuy.ItemsSource = _chiTietPhieuHuyList;
        }

        private void DgChiTietPhieuHuy_CellEditEnding(object sender, DataGridCellEditEndingEventArgs e)
        {
            // Không cần tính tổng, API sẽ tự tính
        }

        private async void BtnLuuPhieuHuy_Click(object sender, RoutedEventArgs e)
        {
            if (!_isCreatingPhieuHuy || _chiTietPhieuHuyList.Count == 0)
            {
                MessageBox.Show("Vui lòng 'Tạo Phiếu Mới' và 'Thêm Dòng' nguyên liệu trước khi lưu.", "Lỗi");
                return;
            }
            if (AuthService.CurrentUser == null)
            {
                MessageBox.Show("Lỗi phiên đăng nhập. Vui lòng đăng nhập lại.", "Lỗi");
                return;
            }
            if (string.IsNullOrWhiteSpace(txtLyDoHuy.Text))
            {
                MessageBox.Show("Lý do hủy là bắt buộc.", "Lỗi");
                return;
            }

            var dto = new PhieuXuatHuyCreateDto
            {
                IdNhanVien = AuthService.CurrentUser.IdNhanVien,
                NgayXuatHuy = dpNgayHuy.SelectedDate ?? DateTime.Today,
                LyDoXuatHuy = txtLyDoHuy.Text,
                ChiTiet = _chiTietPhieuHuyList.Where(ct => ct.IdNguyenLieu > 0 && ct.SoLuong > 0)
                                              .Select(ct => new ChiTietPhieuXuatHuyCreateDto
                                              {
                                                  IdNguyenLieu = ct.IdNguyenLieu,
                                                  SoLuong = ct.SoLuong
                                              }).ToList()
            };

            if (!dto.ChiTiet.Any())
            {
                MessageBox.Show("Phiếu hủy phải có ít nhất 1 nguyên liệu hợp lệ.", "Lỗi");
                return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/kho/phieuxuathuy", dto);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Lưu phiếu xuất hủy thành công!", "Thông báo");
                    await LoadPhieuHuyAsync();
                    ResetPhieuHuyForm();
                }
                else
                {
                    MessageBox.Show($"Lỗi: {await response.Content.ReadAsStringAsync()}", "Lỗi API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lỗi kết nối: {ex.Message}", "Lỗi API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService?.CanGoBack == true)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\TongQuanView.xaml
================================================================================
﻿<Page x:Class="AppCafebookApi.View.quanly.pages.TongQuanView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      
      xmlns:lvc="clr-namespace:LiveCharts.Wpf;assembly=LiveCharts.Wpf"
      
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="DashboardView"
      FontFamily="Segoe UI"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionOrangeBrush" Color="#FFA726"/>

        <Geometry x:Key="IconRevenue">M11.8,10.9C11.4,11.2 10.8,11.5 10,11.5C8.6,11.5 7.5,10.4 7.5,9C7.5,7.6 8.6,6.5 10,6.5C10.8,6.5 11.4,6.8 11.8,7.1L12.9,6C12,5.2 11,4.5 10,4.5C7.2,4.5 5,6.7 5,9.5C5,12.3 7.2,14.5 10,14.5C11,14.5 12,13.8 12.9,13L11.8,10.9M12,3H1V1H12V3M12,21H1V19H12V21M17.5,12.5A1.5,1.5 0 0,1 16,11A1.5,1.5 0 0,1 17.5,9.5A1.5,1.5 0 0,1 19,11A1.5,1.5 0 0,1 17.5,12.5M15.5,17H19.5V15H15.5V17Z</Geometry>
        <Geometry x:Key="IconOrder">M17,17H7V15H17M17,13H7V11H17M17,9H7V7H17M19,3H5C3.9,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.9 20.1,3 19,3Z</Geometry>
        <Geometry x:Key="IconStar">M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z</Geometry>
        <Geometry x:Key="IconDownload">M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z</Geometry>
        <Geometry x:Key="IconSettings">M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M12,22C11.6,22 11.2,21.9 10.8,21.7L9.1,20.9C5.1,19.3 2,15.2 2,10.9V5L12,2L22,5V10.9C22,15.2 18.9,19.3 14.9,20.9L13.2,21.7C12.8,21.9 12.4,22 12,22Z</Geometry>

        <Style x:Key="KpiCard" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Margin" Value="0,0,20,0"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="ReportButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource SubtleGrayBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="12"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Margin" Value="0,0,0,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="6">
                            <ContentPresenter Margin="{TemplateBinding Padding}" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid x:Name="MainPanel" Background="{StaticResource LightCreamBrush}" Margin="10" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Text="Tổng quan Hôm nay" FontSize="28" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,10,0,20"/>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Style="{StaticResource KpiCard}">
                <Grid>
                    <Path Data="{StaticResource IconRevenue}" Fill="{StaticResource ActionGreenBrush}" Width="48" Height="48" Stretch="Uniform" HorizontalAlignment="Right" VerticalAlignment="Top" Opacity="0.1"/>
                    <StackPanel>
                        <TextBlock x:Name="lblDoanhThu" Text="0 VND" FontSize="26" FontWeight="Bold" Foreground="{StaticResource ActionGreenBrush}"/>
                        <TextBlock Text="DOANH THU" FontSize="14" Foreground="{StaticResource TextGrayBrush}" Margin="0,5,0,0"/>
                    </StackPanel>
                </Grid>
            </Border>
            <Border Grid.Column="1" Style="{StaticResource KpiCard}">
                <Grid>
                    <Path Data="{StaticResource IconOrder}" Fill="{StaticResource ActionBlueBrush}" Width="48" Height="48" Stretch="Uniform" HorizontalAlignment="Right" VerticalAlignment="Top" Opacity="0.1"/>
                    <StackPanel>
                        <TextBlock x:Name="lblDonHang" Text="0" FontSize="26" FontWeight="Bold" Foreground="{StaticResource ActionBlueBrush}"/>
                        <TextBlock Text="ĐƠN HÀNG" FontSize="14" Foreground="{StaticResource TextGrayBrush}" Margin="0,5,0,0"/>
                    </StackPanel>
                </Grid>
            </Border>
            <Border Grid.Column="2" Style="{StaticResource KpiCard}" Margin="0">
                <Grid>
                    <Path Data="{StaticResource IconStar}" Fill="{StaticResource ActionOrangeBrush}" Width="48" Height="48" Stretch="Uniform" HorizontalAlignment="Right" VerticalAlignment="Top" Opacity="0.1"/>
                    <StackPanel>
                        <TextBlock x:Name="lblSanPhamBanChay" Text="Chưa có" FontSize="22" FontWeight="Bold" Foreground="{StaticResource ActionOrangeBrush}" TextTrimming="CharacterEllipsis"/>
                        <TextBlock Text="SẢN PHẨM BÁN CHẠY" FontSize="14" Foreground="{StaticResource TextGrayBrush}" Margin="0,5,0,0"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>

        <Grid Grid.Row="2" Margin="0,20,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="3*"/>
                <ColumnDefinition Width="1*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Style="{StaticResource KpiCard}" Margin="0,0,20,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <TextBlock Grid.Row="0" Text="Doanh thu 30 ngày qua" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>

                    <lvc:CartesianChart Grid.Row="1" Margin="0,15,0,0" Series="{Binding SeriesCollection}">
                        <lvc:CartesianChart.Resources>
                            <Style TargetType="lvc:LineSeries">
                                <Setter Property="Stroke" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter Property="Fill" Value="#406F4E37"/>
                                <Setter Property="StrokeThickness" Value="3"/>
                                <Setter Property="PointGeometry" Value="{x:Null}"/>
                            </Style>
                            <Style TargetType="lvc:DefaultTooltip">
                                <Setter Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                                <Setter Property="CornerRadius" Value="4"/>
                            </Style>
                        </lvc:CartesianChart.Resources>
                        <lvc:CartesianChart.AxisX>
                            <lvc:Axis Title="Ngày" Labels="{Binding Labels}">
                                <lvc:Axis.Separator>
                                    <lvc:Separator Stroke="#E0E0E0" StrokeThickness="1"/>
                                </lvc:Axis.Separator>
                            </lvc:Axis>
                        </lvc:CartesianChart.AxisX>
                        <lvc:CartesianChart.AxisY>
                            <lvc:Axis Title="Doanh thu" LabelFormatter="{Binding YFormatter}">
                                <lvc:Axis.Separator>
                                    <lvc:Separator Stroke="#E0E0E0" StrokeThickness="1"/>
                                </lvc:Axis.Separator>
                            </lvc:Axis>
                        </lvc:CartesianChart.AxisY>
                    </lvc:CartesianChart>

                </Grid>
            </Border>

            <Border Grid.Column="1" Style="{StaticResource KpiCard}" Margin="0">
                <StackPanel>
                    <TextBlock Text="Báo cáo &amp; Tác vụ" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,15" Foreground="{StaticResource DarkBrownBrush}"/>
                    <Button x:Name="btnExportRevenue" Style="{StaticResource ReportButton}" Click="BtnExportRevenue_Click">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,10,0">
                                <Path Data="{StaticResource IconDownload}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Xuất Báo cáo Doanh thu" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                    <Button x:Name="btnExportTonKhoSach" Style="{StaticResource ReportButton}" Click="BtnExportTonKhoSach_Click">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,10,0">
                                <Path Data="{StaticResource IconDownload}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Xuất Tồn kho Sách" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                    <Button x:Name="btnExportNguyenLieu" Style="{StaticResource ReportButton}" Click="BtnExportNguyenLieu_Click">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,10,0">
                                <Path Data="{StaticResource IconDownload}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Xuất Tồn kho Nguyên liệu" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                    <Button x:Name="btnExportPerformance" Style="{StaticResource ReportButton}" Click="BtnExportPerformance_Click">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,10,0">
                                <Path Data="{StaticResource IconDownload}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Xuất Hiệu suất NV" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                    <Button x:Name="btnCaiDat" Style="{StaticResource ReportButton}" Margin="0,20,0,0" Click="BtnCaiDat_Click">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,10,0">
                                <Path Data="{StaticResource IconSettings}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Cài đặt thông tin hiển thị" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</Page>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\TongQuanView.xaml.cs
================================================================================
﻿using AppCafebookApi.View.common;
using CafebookModel.Model.ModelApp;
// --- 1. SỬ DỤNG CÁC USING CŨ CỦA LIVECHARTS ---
using LiveCharts;
using LiveCharts.Wpf;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation; // <-- Đảm bảo bạn có using này

namespace AppCafebookApi.View.quanly.pages
{
    public partial class TongQuanView : Page
    {
        // --- 2. KHAI BÁO HTTPCLIENT ---
        private static readonly HttpClient httpClient;

        static TongQuanView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166") // URL của API
            };
        }

        // --- 3. KHAI BÁO CÁC THUỘC TÍNH BINDING CŨ ---
        public SeriesCollection SeriesCollection { get; set; }
        public string[] Labels { get; set; }
        public Func<double, string> YFormatter { get; set; }

        // --- 4. CONSTRUCTOR ---
        public TongQuanView()
        {
            InitializeComponent();

            // Khởi tạo các giá trị cho biểu đồ
            SeriesCollection = new SeriesCollection
            {
                new LineSeries
                {
                    Title = "Doanh thu",
                    Values = new ChartValues<decimal>(), // Khởi tạo rỗng
                    LineSmoothness = 0 // Tắt làm mịn
                }
            };

            Labels = Array.Empty<string>(); // Khởi tạo rỗng
            YFormatter = value => value.ToString("N0") + " VND"; // Định dạng tiền

            // Set DataContext để XAML có thể binding
            DataContext = this;
        }

        // --- 5. HÀM LOAD DỮ LIỆU TỪ API ---
        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            try
            {
                // Gọi API (API Controller giữ nguyên, không cần sửa)
                var data = await httpClient.GetFromJsonAsync<DashboardSummaryDto>("api/app/dashboard/summary");

                if (data != null)
                {
                    // 1. Cập nhật các Thẻ KPI
                    lblDoanhThu.Text = data.TongDoanhThuHomNay.ToString("N0") + " VND";
                    lblDonHang.Text = data.TongDonHangHomNay.ToString();
                    lblSanPhamBanChay.Text = data.SanPhamBanChayHomNay;

                    // 2. Cập nhật Biểu đồ (theo cách của LVC 0.9.7)

                    // Xóa dữ liệu cũ
                    SeriesCollection[0].Values.Clear();

                    // Thêm dữ liệu mới
                    foreach (var item in data.DoanhThu30Ngay)
                    {
                        SeriesCollection[0].Values.Add(item.TongTien);
                    }

                    // Cập nhật nhãn trục X
                    Labels = data.DoanhThu30Ngay.Select(d => d.Ngay.ToString("dd/MM")).ToArray();

                    // Cập nhật lại DataContext để binding nhận thay đổi (cho Labels)
                    DataContext = null;
                    DataContext = this;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Không thể tải dữ liệu Dashboard: {ex.Message}", "Lỗi API", MessageBoxButton.OK, MessageBoxImage.Error);
                lblDoanhThu.Text = "Lỗi";
                lblDonHang.Text = "Lỗi";
                lblSanPhamBanChay.Text = "Lỗi";
            }
        }


        // --- CÁC HÀM XỬ LÝ NÚT BẤM (BÁO CÁO) ---
        // (Giữ nguyên không thay đổi)

        // THAY THẾ HÀM NÀY
        private void BtnExportRevenue_Click(object sender, RoutedEventArgs e)
        {
            // Lỗi của bạn là do dùng code cũ (ShowDialog)
            // Code mới phải là điều hướng (Navigate)
            if (this.NavigationService != null)
            {
                this.NavigationService.Navigate(new BaocaodoanhthuPreviewWindow());
            }
        }

        // --- THAY THẾ HÀM NÀY ---
        private void BtnExportTonKhoSach_Click(object sender, RoutedEventArgs e)
        {
            // Điều hướng Frame (MainFrame) đến trang Báo cáo Sách
            if (this.NavigationService != null)
            {
                this.NavigationService.Navigate(new BapCaoTonKhoSachPreviewWindow());
            }
        }

        // --- THAY THẾ HÀM NÀY ---
        private void BtnExportNguyenLieu_Click(object sender, RoutedEventArgs e)
        {
            // Điều hướng Frame (MainFrame) đến trang Báo cáo Kho
            this.NavigationService?.Navigate(new BaoCaoTonKhoNguyenLieuPreviewWindow());
        }

        // --- THAY THẾ HÀM NÀY ---
        private void BtnExportPerformance_Click(object sender, RoutedEventArgs e)
        {
            // Điều hướng Frame (MainFrame) đến trang Báo cáo Hiệu suất
            this.NavigationService?.Navigate(new BaoCaoHieuSuatNhanVientPreviewWindow());
        }

        // THAY THẾ HÀM NÀY
        private void BtnCaiDat_Click(object sender, RoutedEventArgs e)
        {
            // SỬA LỖI: Dùng trực tiếp NavigationService của Page
            if (this.NavigationService != null)
            {
                // Điều hướng Frame (MainFrame) đến trang CaiDatWindow
                this.NavigationService.Navigate(new CaiDatWindow());
            }
            else
            {
                MessageBox.Show("Không tìm thấy dịch vụ điều hướng.");
            }
        }
    }
}
================================================================================

