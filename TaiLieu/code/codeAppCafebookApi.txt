Backend: C#.
Frontend: xaml.
Database: SQL Server Management Studio 21.
IDE: Visual Studio Insiders.
tÃªn projec: AppCafebookApi.
ná»n táº£ng: WPF App, Net Framework 8.0.
//////////////////////////
ğŸŒ³ Solution 'AppCafebookApi' (4 of 4 projects)
â”‚
â”œâ”€â”€ ğŸ™ GitHub Actions/
â”‚
â”œâ”€â”€ ğŸ”· AppCafebookApi/ (Dá»± Ã¡n WPF Desktop)
â”‚   â”œâ”€â”€ â¡ï¸ Dependencies/
â”‚   â”œâ”€â”€ ğŸ“‚ Assets/
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ images/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ default-avatar.png
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ default-book-cover.png
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ default-food-icon.png
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ logo.ico
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ–¼ï¸ logo.png
â”‚   â”‚   â””â”€â”€ ğŸ“‚ Fonts/
â”‚   â”‚       â””â”€â”€ ğŸ…°ï¸ Font Awesome 6 Free-Solid-900.otf
â”‚   â”œâ”€â”€ ğŸ“‚ Services/
â”‚   â”‚   â”œâ”€â”€ C# AuthService.cs
â”‚   â”‚   â””â”€â”€ C# HinhAnhHelpers.cs
â”‚   â”œâ”€â”€ ğŸ“‚ View/
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ Common/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ BaocaodoanhthuPreviewWindow.xaml
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ BaoCaoHieuSuatNhanVientPreview.xaml
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ BaoCaoTonKhoNguyenLieuPreviewWindo...
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ BapCaoTonKhoSachPreviewWindow.xaml
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ InputDialogWindow.xaml
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ PhieuLuongPreviewWindow.xaml
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ WelcomeWindow.xaml
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ nhanvien/
â”‚   â”‚   â”‚    â”œâ”€â”€ ğŸ“‚ pages/
â”‚   â”‚   â”‚    â”‚     â”œâ”€â”€ ğŸ“„ SoDoBanView.xaml
â”‚   â”‚   â”‚    â”‚     â””â”€â”€ ğŸ“„ GoiMonView.xaml
â”‚   â”‚   â”‚    â””â”€â”€ ğŸ“„ ManHinhNhanVien.xaml
â”‚   â”‚   â””â”€â”€ ğŸ“‚ quanly/
â”‚   â”‚       â”œâ”€â”€ ğŸ“‚ pages/
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ BaoCaoNhanSuView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ CaiDatNhanSuView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ PhanQuyenView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyBanView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyDonHangView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyDonViChuyenDoiView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyDonXinNghiView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyKiemKhoView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyKhachHangView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyKhuyenMaiView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyLichLamViecView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyLuongView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyNguyenLieuView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyNhaCungCapView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyNhanVienView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyNhapKhoView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyPhatLuongView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLySachView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLySanPhamView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyVaiTroView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyXuatHuyView.xaml
â”‚   â”‚       â”‚   â””â”€â”€ ğŸ“„ TongQuanView.xaml
â”‚   â”‚       â”œâ”€â”€ ğŸ“„ ManHinhQuanly.xaml
â”‚   â”‚       â””â”€â”€ ğŸ“„ ManHinhDangNhap.xaml
â”‚   â”œâ”€â”€ âš™ï¸ App.xaml
â”‚   â””â”€â”€ ğŸ–¼ï¸ logo.ico
â”‚
â”œâ”€â”€ ğŸ”· CafebookApi/ (Dá»± Ã¡n ASP.NET Core API Backend)
â”‚   â”œâ”€â”€ â¡ï¸ Connected Services/
â”‚   â”œâ”€â”€ â¡ï¸ Dependencies/
â”‚   â”œâ”€â”€ ğŸ“‚ Properties/
â”‚   â”‚   â””â”€â”€ ğŸ“„ launchSettings.json
â”‚   â”œâ”€â”€ ğŸ“‚ wwwroot/
â”‚   â”‚   â””â”€â”€ ğŸ“‚ images/
â”‚   â”‚       â”œâ”€â”€ ğŸ“‚ avatars/
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“‚ avatarKH/
â”‚   â”‚       â”‚   â””â”€â”€ ğŸ“‚ avatarNV/
â”‚   â”‚       â”œâ”€â”€ ğŸ“‚ books/
â”‚   â”‚       â””â”€â”€ ğŸ“‚ foods/
â”‚   â”œâ”€â”€ ğŸ“‚ Controllers/
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ App/
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“‚ NhanVien/
â”‚   â”‚   â”‚   â”‚    â”œâ”€â”€ GoiMonController.cs
â”‚   â”‚   â”‚   â”‚    â”œâ”€â”€ GiaoHangController.cs
â”‚   â”‚   â”‚   â”‚    â”œâ”€â”€ SoDoBanController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# BanQuanLyController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# BaoCaoController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# BaoCaoHieuSuatController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# BaoCaoNhanSuController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# BaoCaoSachController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# BaoCaoTonKhoController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# CaiDatController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# CaiDatNhanSuController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# CalamViecController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# DashboardController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# DonHangController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# DonViChuyenDoiController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# DonXinNghiController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# KhachHangController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# KhoController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# KhuyenMaiController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# LichLamViecController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# LuongController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# NguyenLieuController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# NhaCungCapController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# NhanVienController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# PhanQuyenController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# PhatLuongController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# SachController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# SanPhamController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# SoDoBanController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# TaiKhoanController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# ThongBaoController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# ThuongPhatController.cs
â”‚   â”‚   â”‚   â””â”€â”€ C# VaiTroController.cs
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ Shared/
â”‚   â”‚   â””â”€â”€ ğŸ“‚ Web/
â”‚   â”‚       â”œâ”€â”€ C# KhachHangTaiKhoanController.cs
â”‚   â”‚       â”œâ”€â”€ C# NhanVienTaiKhoanController.cs
â”‚   â”‚       â”œâ”€â”€ C# TrangChuController.cs
â”‚   â”‚       â””â”€â”€ C# WebQuanLyController.cs
â”‚   â”œâ”€â”€ ğŸ“‚ Data/
â”‚   â”‚   â””â”€â”€ C# CafebookDbContext.cs
â”‚   â”œâ”€â”€ ğŸ“‚ Services/
â”‚   â”œâ”€â”€ ğŸ“„ appsettings.json
â”‚   â””â”€â”€ C# Program.cs
â”‚
â”œâ”€â”€ ğŸ”· WebCafebookApi/ (Dá»± Ã¡n ASP.NET Core Web App - Razor Pages)
â”‚   â”œâ”€â”€ â¡ï¸ Connected Services/
â”‚   â”œâ”€â”€ â¡ï¸ Dependencies/
â”‚   â”œâ”€â”€ ğŸ“‚ Properties/
â”‚   â”‚   â””â”€â”€ ğŸ“„ launchSettings.json
â”‚   â”œâ”€â”€ ğŸ“‚ wwwroot/
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ css/
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ site.css
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ images/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ default-avatar.png
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ default-book-cover.png
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ default-food-icon.png
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ logo.ico
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ–¼ï¸ logo.png
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ js/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ profile.js
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ site.js
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ lib/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ bootstrap/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ dist/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ css/
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ bootstrap.css
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ bootstrap-grid.css
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ bootstrap-reboot.css
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ bootstrap-utilities.css
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“‚ js/
â”‚   â”‚   â”‚   â”‚   â”‚       â””â”€â”€ ğŸ“„ bootstrap.js
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ LICENSE
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ jquery/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ dist/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ jquery.js
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ LICENSE.txt
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ LICENSE
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ jquery-validation/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ dist/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ additional-methods.js
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ jquery.validate.js
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ LICENSE.md
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“‚ jquery-validation-unobtrusive/
â”‚   â”‚   â”‚       â”œâ”€â”€ ğŸ“‚ dist/
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ ğŸ“„ jquery.validate.unobtrusive.js
â”‚   â”‚   â”‚       â””â”€â”€ ğŸ“„ LICENSE.txt  <-- (ÄÃ£ cáº­p nháº­t tá»« áº£nh má»›i)
â”‚   â”‚   â””â”€â”€ ğŸ–¼ï¸ favicon.ico
â”‚   â”œâ”€â”€ ğŸ“‚ Data/
â”‚   â”œâ”€â”€ ğŸ“‚ Pages/
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ Account/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ DangKyView.cshtml
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ DangNhapView.cshtml
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ DangXuat.cshtml
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ QuenMatKhauView.cshtml
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ employee/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ _Layout_Employee.cshtml
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ _ViewStart.cshtml
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ DangNhapEmployee.cshtml
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ DangXuat.cshtml
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ SoDoBanView.cshtml
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ WebQuanLyView.cshtml
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ Shared/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ _ViewImports.cshtml
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ _ViewStart.cshtml
â”‚   â”‚   â””â”€â”€ ğŸ“„ TrangChuView.cshtml
â”‚   â”œâ”€â”€ ğŸ“‚ Services/
â”‚   â”œâ”€â”€ ğŸ“„ appsettings.json
â”‚   â”œâ”€â”€ ğŸ“„ appsettings.Development.json
â”‚   â””â”€â”€ C# Program.cs
â”‚
â””â”€â”€ ğŸ”· CafebookModel/ (Dá»± Ã¡n Class Library - Shared Models)
    â”œâ”€â”€ â¡ï¸ Dependencies/
   ğŸ“‚ Model
    â”œâ”€â”€ ğŸ“‚ Data/
    â”‚   â””â”€â”€ C# NhanVienDto.cs
    â”œâ”€â”€ ğŸ“‚ ModelApi/
    â”‚   â”œâ”€â”€ C# LoginRequestModel.cs
    â”‚   â””â”€â”€ C# LoginResponseModel.cs
    â”œâ”€â”€ ğŸ“‚ ModelApp/
    â”‚   â”œâ”€â”€ C# BanQuanLyDto.cs
    â”‚   â”œâ”€â”€ C# BaoCaoDto.cs
    â”‚   â”œâ”€â”€ C# BaoCaoHieuSuatDto.cs
    â”‚   â”œâ”€â”€ C# BaoCaoSachDto.cs
    â”‚   â”œâ”€â”€ C# BaoCaoTonKhoDto.cs
    â”‚   â”œâ”€â”€ C# CaiDatDto.cs
    â”‚   â”œâ”€â”€ C# CaiDatThongTinCuaHangDto.cs
    â”‚   â”œâ”€â”€ C# ChartDataPoint.cs
    â”‚   â”œâ”€â”€ C# DashboardSummaryDto.cs
    â”‚   â”œâ”€â”€ C# DonHangDto.cs
    â”‚   â”œâ”€â”€ C# DonViChuyenDoiDto.cs
    â”‚   â”œâ”€â”€ C# DonXinNghiDto.cs
    â”‚   â”œâ”€â”€ C# KhachHangDto.cs
    â”‚   â”œâ”€â”€ C# KhoDto.cs
    â”‚   â”œâ”€â”€ C# KhuyenMaiDto.cs
    â”‚   â”œâ”€â”€ C# NhanSuDto.cs
    â”‚   â”œâ”€â”€ C# PhatLuongDto.cs
    â”‚   â”œâ”€â”€ C# SachDto.cs
    â”‚   â”œâ”€â”€ C# SanPhamDto.cs
    â”‚   â”œâ”€â”€ C# SoDoBanDto.cs
    â”‚   â””â”€â”€ C# ThongBaoDto.cs
    â”œâ”€â”€ ğŸ“‚ ModelWeb/
    â”‚   â”œâ”€â”€ C# DangKyRequestModel.cs
    â”‚   â”œâ”€â”€ C# KhachHangDto.cs
    â”‚   â”œâ”€â”€ C# TrangChuDto.cs
    â”‚   â”œâ”€â”€ C# WebLoginResponseModel.cs
    â”‚   â””â”€â”€ C# WebQuanLyDashboardModel.cs
    â”œâ”€â”€ Entities.cs
    â””â”€â”€ ğŸ“‚ Utils/
        â”œâ”€â”€ C# HinhAnhPaths.cs
        â””â”€â”€ C# SlugifyUtil.cs
//////////////////////////
AppCafebookApi
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\Assets\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\Assets\images\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\Assets\images\default-avatar.png
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\Assets\images\default-book-cover.png
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\Assets\images\default-food-icon.png
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\Assets\images\logo.ico
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\Assets\images\logo.png
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\Assets\Fonts\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\Assets\Fonts\Font Awesome 6 Free-Solid-900.otf
//////////////////////////
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\Services\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\Services\AuthService.cs
using CafebookModel.Model.Data;
using CafebookModel.Model.ModelApi;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;

namespace AppCafebookApi.Services
{
    public static class AuthService
    {
        // 1. LÆ°u trá»¯ thÃ´ng tin ngÆ°á»i dÃ¹ng hiá»‡n táº¡i
        public static NhanVienDto? CurrentUser { get; private set; }

        // 2. Cáº¥u hÃ¬nh HttpClient
        private static readonly HttpClient _httpClient;

        static AuthService()
        {
            _httpClient = new HttpClient
            {
                // Láº¥y tá»« file launchSettings.json cá»§a API
                BaseAddress = new System.Uri("http://localhost:5166")
            };
            _httpClient.DefaultRequestHeaders.Accept.Clear();
            _httpClient.DefaultRequestHeaders.Accept.Add(
                new System.Net.Http.Headers.MediaTypeWithQualityHeaderValue("application/json"));
        }

        // 3. ÄÄƒng nháº­p báº±ng API
        public static async Task<LoginResponseModel> LoginAsync(LoginRequestModel model)
        {
            try
            {
                var response = await _httpClient.PostAsJsonAsync("/api/app/taikhoan/login", model);

                if (response.IsSuccessStatusCode)
                {
                    var loginResponse = await response.Content.ReadFromJsonAsync<LoginResponseModel>();
                    if (loginResponse != null && loginResponse.Success)
                    {
                        CurrentUser = loginResponse.UserData; // LÆ°u ngÆ°á»i dÃ¹ng
                    }
                    return loginResponse ?? new LoginResponseModel { Success = false, Message = "KhÃ´ng thá»ƒ Ä‘á»c pháº£n há»“i." };
                }

                // Thá»­ Ä‘á»c ná»™i dung lá»—i náº¿u cÃ³
                var errorResponse = await response.Content.ReadFromJsonAsync<LoginResponseModel>();
                return errorResponse ?? new LoginResponseModel { Success = false, Message = $"Lá»—i: {response.StatusCode}" };
            }
            catch (HttpRequestException ex)
            {
                return new LoginResponseModel { Success = false, Message = $"Lá»—i káº¿t ná»‘i API: {ex.Message}" };
            }
        }

        // 4. Kiá»ƒm tra tÃ i khoáº£n Backdoor
        public static LoginResponseModel LoginBackdoor(LoginRequestModel model)
        {
            if (model.TenDangNhap == "admin@cafebook.com" && model.MatKhau == "123456")
            {
                var user = new NhanVienDto
                {
                    HoTen = "Quáº£n trá»‹ viÃªn Há»‡ thá»‘ng",
                    TenVaiTro = "Quáº£n trá»‹ viÃªn",
                    DanhSachQuyen = new List<string> { "FULL" }
                };
                CurrentUser = user; // LÆ°u ngÆ°á»i dÃ¹ng
                return new LoginResponseModel { Success = true, UserData = user };
            }

            if (model.TenDangNhap == "nhanvien@cafebook.com" && model.MatKhau == "123456")
            {
                var user = new NhanVienDto
                {
                    HoTen = "NhÃ¢n viÃªn Demo",
                    TenVaiTro = "Phá»¥c vá»¥",
                    DanhSachQuyen = new List<string> { "BanHang.Xem" }
                };
                CurrentUser = user; // LÆ°u ngÆ°á»i dÃ¹ng
                return new LoginResponseModel { Success = true, UserData = user };
            }

            // Náº¿u khÃ´ng pháº£i backdoor
            return new LoginResponseModel { Success = false };
        }

        // 1. HÃ€M ÄÄ‚NG XUáº¤T (XÃ“A Dá»® LIá»†U SESSION)
        public static void Logout()
        {
            CurrentUser = null;
        }

        // 2. HÃ€M KIá»‚M TRA Má»˜T QUYá»€N
        public static bool CoQuyen(string idQuyen)
        {
            if (CurrentUser == null || CurrentUser.DanhSachQuyen == null)
            {
                return false;
            }

            // Quáº£n trá»‹ viÃªn (tá»« CSDL) hoáº·c backdoor "FULL" luÃ´n cÃ³ quyá»n
            if (CurrentUser.TenVaiTro == "Quáº£n trá»‹ viÃªn" || CurrentUser.DanhSachQuyen.Contains("FULL"))
            {
                return true;
            }

            // Kiá»ƒm tra quyá»n cá»¥ thá»ƒ
            return CurrentUser.DanhSachQuyen.Contains(idQuyen);
        }

        // 3. HÃ€M KIá»‚M TRA NHIá»€U QUYá»€N (Logic "OR")
        // (Ráº¥t há»¯u Ã­ch Ä‘á»ƒ kiá»ƒm tra 1 trong nhiá»u quyá»n, vÃ­ dá»¥: QL Kho)
        public static bool CoQuyen(params string[] quyenIds)
        {
            if (CurrentUser == null || CurrentUser.DanhSachQuyen == null)
            {
                return false;
            }

            if (CurrentUser.TenVaiTro == "Quáº£n trá»‹ viÃªn" || CurrentUser.DanhSachQuyen.Contains("FULL"))
            {
                return true;
            }

            // Kiá»ƒm tra xem ngÆ°á»i dÃ¹ng cÃ³ Báº¤T Ká»² quyá»n nÃ o trong danh sÃ¡ch khÃ´ng
            return quyenIds.Any(id => CurrentUser.DanhSachQuyen.Contains(id));
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\Services\HinhAnhHelper.cs
// Táº­p tin: AppCafebookApi/Services/HinhAnhHelper.cs
using System;
using System.IO;
using System.Windows.Media;
using System.Windows.Media.Imaging;
// KHÃ”NG Cáº¦N using System.Windows; ná»¯a

namespace AppCafebookApi.Services
{
    public static class HinhAnhHelper
    {
        /// <summary>
        /// Sá»¬A Äá»”I: Táº£i áº£nh tá»« URL Web hoáº·c ÄÆ°á»ng dáº«n File cá»¥c bá»™.
        /// </summary>
        public static BitmapImage LoadImage(string? imageSource, string defaultImagePath)
        {
            if (string.IsNullOrEmpty(imageSource))
            {
                // 1. KhÃ´ng cÃ³ nguá»“n -> Táº£i áº£nh máº·c Ä‘á»‹nh (pack://)
                return LoadImageFromPackUri(defaultImagePath);
            }

            // 2. Nguá»“n lÃ  URL (http://...)
            if (imageSource.StartsWith("http", StringComparison.OrdinalIgnoreCase))
            {
                try
                {
                    var image = new BitmapImage();
                    image.BeginInit();
                    image.UriSource = new Uri(imageSource, UriKind.Absolute);
                    image.CreateOptions = BitmapCreateOptions.IgnoreImageCache;
                    image.CacheOption = BitmapCacheOption.OnLoad;
                    image.EndInit();

                    // Sá»¬A: ÄÃƒ XÃ“A DÃ’NG image.Freeze();

                    return image;
                }
                catch (Exception) // Sá»¬A: XÃ³a MessageBox, chá»‰ tráº£ vá» áº£nh máº·c Ä‘á»‹nh
                {
                    return LoadImageFromPackUri(defaultImagePath); // Lá»—i URL -> Táº£i máº·c Ä‘á»‹nh
                }
            }

            // 3. (Sá»¬A) Nguá»“n lÃ  má»™t Ä‘Æ°á»ng dáº«n file cá»¥c bá»™ (DÃ¹ng cho Preview)
            if (File.Exists(imageSource))
            {
                try
                {
                    var image = new BitmapImage();
                    image.BeginInit();
                    image.UriSource = new Uri(imageSource, UriKind.Absolute);
                    image.CacheOption = BitmapCacheOption.OnLoad;
                    image.EndInit();
                    // Sá»¬A: ÄÃƒ XÃ“A DÃ’NG image.Freeze();
                    return image;
                }
                catch
                {
                    return LoadImageFromPackUri(defaultImagePath);
                }
            }

            return LoadImageFromPackUri(defaultImagePath);
        }

        /// <summary>
        /// (Giá»¯ nguyÃªn) HÃ m táº£i áº£nh tá»« Resource (pack://)
        /// </summary>
        private static BitmapImage LoadImageFromPackUri(string uriPath)
        {
            try
            {
                var image = new BitmapImage();
                var uri = new Uri($"pack://application:,,,/AppCafebookApi;component{uriPath}", UriKind.Absolute);

                image.BeginInit();
                image.UriSource = uri;
                image.CacheOption = BitmapCacheOption.OnLoad;
                image.EndInit();
                image.Freeze(); // Freeze á»Ÿ Ä‘Ã¢y thÃ¬ an toÃ n, vÃ¬ file náº±m sáºµn trong app
                return image;
            }
            catch (Exception)
            {
                // Táº¡o áº£nh 1x1 trong suá»‘t náº¿u resource bá»‹ lá»—i
                var image = new BitmapImage();
                var writeableBitmap = new WriteableBitmap(1, 1, 96, 96, PixelFormats.Pbgra32, null);
                using (var stream = new MemoryStream())
                {
                    var encoder = new PngBitmapEncoder();
                    encoder.Frames.Add(BitmapFrame.Create(writeableBitmap));
                    encoder.Save(stream);
                    stream.Position = 0;
                    image.BeginInit();
                    image.CacheOption = BitmapCacheOption.OnLoad;
                    image.StreamSource = stream;
                    image.EndInit();
                }
                image.Freeze();
                return image;
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\BaocaodoanhthuPreviewWindow.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\BaocaodoanhthuPreviewWindow.xaml
<Page x:Class="AppCafebookApi.View.common.BaocaodoanhthuPreviewWindow"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:local="clr-namespace:AppCafebookApi.View.common"
      mc:Ignorable="d"
      Title="Xem trÆ°á»›c BÃ¡o cÃ¡o Doanh thu - Lá»£i nhuáº­n" 
      d:DesignHeight="720" d:DesignWidth="1000"
      Background="#FFF8E1"
      FontFamily="Segoe UI"
      Loaded="Page_Loaded">
    
    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        
        <Style TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,8"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="KpiCard" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="15"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="KpiValue" TargetType="TextBlock">
            <Setter Property="FontSize" Value="24"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>
        <Style x:Key="KpiTitle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
        </Style>
        <Style TargetType="DataGrid">
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="CanUserAddRows" Value="False"/>
            <Setter Property="CanUserDeleteRows" Value="False"/>
            <Setter Property="IsReadOnly" Value="True"/>
            <Setter Property="AutoGenerateColumns" Value="False"/>
            <Setter Property="GridLinesVisibility" Value="None"/>
        </Style>
    </Page.Resources>

    <Grid Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="White" Padding="15" Margin="10" CornerRadius="8">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="Tá»« ngÃ y:" VerticalAlignment="Center" Margin="5"/>
                <DatePicker x:Name="dpStartDate" Width="150" VerticalAlignment="Center"/>
                <TextBlock Text="Äáº¿n ngÃ y:" VerticalAlignment="Center" Margin="20,5,5,5"/>
                <DatePicker x:Name="dpEndDate" Width="150" VerticalAlignment="Center"/>
                <Button x:Name="btnGenerate" Content="Táº¡o BÃ¡o CÃ¡o" Margin="20,0,0,0" Click="BtnGenerate_Click"/>
            </StackPanel>
        </Border>

        <Grid Grid.Row="1" Margin="10,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblDoanhThuRong" Text="0" Style="{StaticResource KpiValue}" Foreground="#42A5F5"/>
                    <TextBlock Text="Doanh Thu RÃ²ng" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="1" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblTongGiaVon" Text="0" Style="{StaticResource KpiValue}" Foreground="#EF5350"/>
                    <TextBlock Text="Tá»•ng GiÃ¡ Vá»‘n (COGS)" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="2" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblLoiNhuanGop" Text="0" Style="{StaticResource KpiValue}" Foreground="#FFA726"/>
                    <TextBlock Text="Lá»£i Nhuáº­n Gá»™p" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="3" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblChiPhiOpex" Text="0" Style="{StaticResource KpiValue}" Foreground="#EF5350"/>
                    <TextBlock Text="Chi PhÃ­ Váº­n HÃ nh" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="4" Style="{StaticResource KpiCard}" Margin="0">
                <StackPanel>
                    <TextBlock x:Name="lblLoiNhuanRong" Text="0" Style="{StaticResource KpiValue}" Foreground="#66BB6A"/>
                    <TextBlock Text="Lá»£i Nhuáº­n RÃ²ng (Dá»± kiáº¿n)" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
        </Grid>

        <TabControl Grid.Row="2" Margin="10">
            <TabItem Header="Top Sáº£n pháº©m BÃ¡n cháº¡y">
                <DataGrid x:Name="dgTopSanPham">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="TÃªn Sáº£n Pháº©m" Binding="{Binding TenSanPham}" Width="*"/>
                        <DataGridTextColumn Header="Tá»•ng Sá»‘ LÆ°á»£ng" Binding="{Binding TongSoLuongBan}" Width="150"/>
                        <DataGridTextColumn Header="Tá»•ng Doanh Thu" Binding="{Binding TongDoanhThu, StringFormat=N0}" Width="200"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="Chi tiáº¿t Doanh thu">
                <DataGrid x:Name="dgChiTietDoanhThu" MaxHeight="300" VerticalAlignment="Top">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Chá»‰ sá»‘" Binding="{Binding Key}" Width="*" FontWeight="SemiBold"/>
                        <DataGridTextColumn Header="GiÃ¡ trá»‹" Binding="{Binding Value, StringFormat=N0}" Width="200"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="Chi tiáº¿t Chi phÃ­ &amp; GiÃ¡ vá»‘n">
                <DataGrid x:Name="dgChiTietChiPhi" MaxHeight="300" VerticalAlignment="Top">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Chá»‰ sá»‘" Binding="{Binding Key}" Width="*" FontWeight="SemiBold"/>
                        <DataGridTextColumn Header="GiÃ¡ trá»‹" Binding="{Binding Value, StringFormat=N0}" Width="200"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
        </TabControl>

        <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="25">
            <Button x:Name="btnBack" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" 
                    Click="BtnBack_Click">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="&lt; Quay láº¡i" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>

            <Button x:Name="btnExportToExcel" 
                    Content="Xuáº¥t Excel" 
                    Margin="20,0,0,0" 
                    HorizontalAlignment="Right"
                    Click="BtnExportToExcel_Click" />
        </StackPanel>

        <Border x:Name="LoadingOverlay" Grid.Row="1" Grid.RowSpan="3" Background="#80FFFFFF" Visibility="Collapsed">
            <TextBlock Text="Äang táº¡o bÃ¡o cÃ¡o..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\BaocaodoanhthuPreviewWindow.xaml.cs
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;

// --- THÃŠM CÃC USING Äá»‚ XUáº¤T EXCEL ---
using System.IO;
using Microsoft.Win32;
using OfficeOpenXml;
using OfficeOpenXml.Style;

namespace AppCafebookApi.View.common
{
    public partial class BaocaodoanhthuPreviewWindow : Page
    {
        private static readonly HttpClient httpClient;
        private BaoCaoTongHopDto? currentReportData;

        static BaocaodoanhthuPreviewWindow()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public BaocaodoanhthuPreviewWindow()
        {
            InitializeComponent();
        }

        private void Page_Loaded(object sender, RoutedEventArgs e)
        {
            var now = DateTime.Now;
            dpStartDate.SelectedDate = new DateTime(now.Year, now.Month, 1);
            dpEndDate.SelectedDate = now;
        }

        private async void BtnGenerate_Click(object sender, RoutedEventArgs e)
        {
            if (dpStartDate.SelectedDate == null || dpEndDate.SelectedDate == null)
            {
                MessageBox.Show("Vui lÃ²ng chá»n cáº£ NgÃ y báº¯t Ä‘áº§u vÃ  NgÃ y káº¿t thÃºc.", "Thiáº¿u thÃ´ng tin");
                return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            btnGenerate.IsEnabled = false;

            var request = new BaoCaoRequestDto
            {
                StartDate = dpStartDate.SelectedDate.Value,
                EndDate = dpEndDate.SelectedDate.Value
            };

            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/baocao/doanhthu", request);
                if (response.IsSuccessStatusCode)
                {
                    currentReportData = await response.Content.ReadFromJsonAsync<BaoCaoTongHopDto>();
                    if (currentReportData != null)
                    {
                        PopulateUi(currentReportData);
                    }
                }
                else
                {
                    MessageBox.Show($"Lá»—i API: {response.ReasonPhrase}", "Lá»—i");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"KhÃ´ng thá»ƒ káº¿t ná»‘i API: {ex.Message}", "Lá»—i");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
                btnGenerate.IsEnabled = true;
            }
        }

        private void PopulateUi(BaoCaoTongHopDto data)
        {
            var culture = CultureInfo.GetCultureInfo("vi-VN");

            lblDoanhThuRong.Text = data.Kpi.DoanhThuRong.ToString("C0", culture);
            lblTongGiaVon.Text = data.Kpi.TongGiaVon.ToString("C0", culture);
            lblLoiNhuanGop.Text = data.Kpi.LoiNhuanGop.ToString("C0", culture);
            lblChiPhiOpex.Text = data.Kpi.ChiPhiOpex.ToString("C0", culture);
            lblLoiNhuanRong.Text = data.Kpi.LoiNhuanRong.ToString("C0", culture);

            dgTopSanPham.ItemsSource = data.TopSanPham;

            var dtList = new List<KeyValuePair<string, decimal>>
            {
                new("Tá»•ng doanh thu gá»‘c", data.ChiTietDoanhThu.TongDoanhThuGoc),
                new("Tá»•ng giáº£m giÃ¡", data.ChiTietDoanhThu.TongGiamGia),
                new("Tá»•ng phá»¥ thu", data.ChiTietDoanhThu.TongPhuThu),
                new("DOANH THU RÃ’NG", data.ChiTietDoanhThu.DoanhThuRong),
                new("Tá»•ng sá»‘ hÃ³a Ä‘Æ¡n", data.ChiTietDoanhThu.SoLuongHoaDon),
                new("GiÃ¡ trá»‹ trung bÃ¬nh HÄ", data.ChiTietDoanhThu.GiaTriTrungBinhHD)
            };
            dgChiTietDoanhThu.ItemsSource = dtList;

            var cpList = new List<KeyValuePair<string, decimal>>
            {
                new("Tá»•ng GiÃ¡ Vá»‘n HÃ ng BÃ¡n (COGS)", data.ChiTietChiPhi.TongGiaVon_COGS),
                new("Tá»•ng Chi PhÃ­ LÆ°Æ¡ng", data.ChiTietChiPhi.TongChiPhiLuong),
                new("Tá»•ng Chi PhÃ­ Há»§y HÃ ng", data.ChiTietChiPhi.TongChiPhiHuyHang)
            };
            dgChiTietChiPhi.ItemsSource = cpList;
        }

        private async void BtnExportToExcel_Click(object sender, RoutedEventArgs e)
        {
            if (currentReportData == null)
            {
                MessageBox.Show("ChÆ°a cÃ³ dá»¯ liá»‡u bÃ¡o cÃ¡o Ä‘á»ƒ xuáº¥t. Vui lÃ²ng nháº¥n 'Táº¡o BÃ¡o CÃ¡o' trÆ°á»›c.", "ChÆ°a cÃ³ dá»¯ liá»‡u");
                return;
            }

            // Sá»¬A Lá»–I CS8629: Kiá»ƒm tra null cho DatePicker á»Ÿ Ä‘Ã¢y
            if (dpStartDate.SelectedDate == null || dpEndDate.SelectedDate == null)
            {
                MessageBox.Show("NgÃ y báº¯t Ä‘áº§u hoáº·c káº¿t thÃºc khÃ´ng há»£p lá»‡.", "Lá»—i");
                return;
            }

            var sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                FileName = $"BaoCaoDoanhThu_{DateTime.Now:yyyyMMdd_HHmm}.xlsx"
            };

            if (sfd.ShowDialog() == true)
            {
                try
                {
                    LoadingOverlay.Visibility = Visibility.Visible;

                    // Sá»¬A Lá»–I CS8629: Truyá»n ngÃ y vÃ o hÃ m
                    await CreateExcelReportAsync(
                        sfd.FileName,
                        currentReportData,
                        dpStartDate.SelectedDate.Value,
                        dpEndDate.SelectedDate.Value);

                    LoadingOverlay.Visibility = Visibility.Collapsed;
                    MessageBox.Show($"ÄÃ£ xuáº¥t bÃ¡o cÃ¡o thÃ nh cÃ´ng!\n\nÄÆ°á»ng dáº«n: {sfd.FileName}", "ThÃ nh cÃ´ng", MessageBoxButton.OK, MessageBoxImage.Information);
                }
                catch (Exception ex)
                {
                    LoadingOverlay.Visibility = Visibility.Collapsed;
                    MessageBox.Show($"CÃ³ lá»—i khi xuáº¥t Excel: {ex.Message}\n\nÄáº£m báº£o báº¡n Ä‘Ã£ Ä‘Ã³ng file Excel (náº¿u nÃ³ Ä‘ang má»Ÿ).", "Lá»—i Xuáº¥t File", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        // DÃ¡n Ä‘Ã¨ lÃªn hÃ m CreateExcelReportAsync CÅ¨ cá»§a báº¡n
        private async Task CreateExcelReportAsync(string filePath, BaoCaoTongHopDto data, DateTime startDate, DateTime endDate)
        {
            // Giáº¥y phÃ©p EPPlus
            ExcelPackage.License.SetNonCommercialPersonal("CafeBook");
            var fileInfo = new FileInfo(filePath);

            // XÃ³a file cÅ© náº¿u tá»“n táº¡i
            if (fileInfo.Exists)
            {
                fileInfo.Delete();
            }

            using (var package = new ExcelPackage(fileInfo))
            {
                // --- 1. Äá»ŠNH NGHÄ¨A CÃC STYLE TÃI Sá»¬ Dá»¤NG ---

                // Style cho TiÃªu Ä‘á» chÃ­nh (Merge cell, to, Ä‘áº­m)
                Action<ExcelRange> styleMainTitle = (range) =>
                {
                    range.Merge = true;
                    range.Style.Font.Bold = true;
                    range.Style.Font.Size = 16;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    range.Style.Fill.PatternType = ExcelFillStyle.Solid;
                    range.Style.Fill.BackgroundColor.SetColor(System.Drawing.ColorTranslator.FromHtml("#333366")); // Xanh Ä‘áº­m
                    range.Style.Font.Color.SetColor(System.Drawing.Color.White);
                };

                // Style cho TiÃªu Ä‘á» phá»¥ (Merge cell, nghiÃªng)
                Action<ExcelRange> styleSubTitle = (range) =>
                {
                    range.Merge = true;
                    range.Style.Font.Italic = true;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                };

                // Style cho TiÃªu Ä‘á» nhÃ³m (Äáº­m, ná»n xÃ¡m)
                Action<ExcelRange> styleGroupHeader = (range) =>
                {
                    range.Merge = true;
                    range.Style.Font.Bold = true;
                    range.Style.Fill.PatternType = ExcelFillStyle.Solid;
                    range.Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);
                };

                // Äá»‹nh dáº¡ng tiá»n tá»‡ VND (canh pháº£i)
                var currencyFormat = "#,##0 \"Ä‘\"";
                Action<ExcelRange> styleCurrency = (range) =>
                {
                    range.Style.Numberformat.Format = currencyFormat;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                };

                // Style cho Lá»£i nhuáº­n (Xanh, Ä‘áº­m)
                Action<ExcelRange> styleProfit = (range) =>
                {
                    styleCurrency(range);
                    range.Style.Font.Bold = true;
                    range.Style.Font.Color.SetColor(System.Drawing.Color.Green);
                };

                // Style cho Chi phÃ­ (Äá»)
                Action<ExcelRange> styleExpense = (range) =>
                {
                    styleCurrency(range);
                    range.Style.Font.Color.SetColor(System.Drawing.Color.Red);
                };

                // --- 2. SHEET 1: BÃO CÃO Tá»”NG QUAN (P&L) ---
                var wsPL = package.Workbook.Worksheets.Add("BÃ¡o CÃ¡o Tá»•ng Quan");

                // TiÃªu Ä‘á»
                wsPL.Cells["A1:D1"].Value = "BÃO CÃO KINH DOANH Tá»”NG QUAN";
                styleMainTitle(wsPL.Cells["A1:D1"]);

                wsPL.Cells["A2:D2"].Value = $"Tá»« ngÃ y {startDate:dd/MM/yyyy} Ä‘áº¿n {endDate:dd/MM/yyyy}";
                styleSubTitle(wsPL.Cells["A2:D2"]);

                // P&L (Lá»£i nhuáº­n & Lá»—)
                wsPL.Cells["A4:B4"].Value = "Káº¾T QUáº¢ KINH DOANH CHÃNH (P&L)";
                styleGroupHeader(wsPL.Cells["A4:B4"]);

                wsPL.Cells["A5"].Value = "Doanh Thu RÃ²ng";
                wsPL.Cells["B5"].Value = data.Kpi.DoanhThuRong;
                styleCurrency(wsPL.Cells["B5"]);

                wsPL.Cells["A6"].Value = "(-) Tá»•ng GiÃ¡ Vá»‘n (COGS)";
                wsPL.Cells["B6"].Value = data.Kpi.TongGiaVon;
                styleExpense(wsPL.Cells["B6"]);

                wsPL.Cells["A7"].Value = "(=) Lá»£i Nhuáº­n Gá»™p";
                wsPL.Cells["B7"].Value = data.Kpi.LoiNhuanGop;
                styleProfit(wsPL.Cells["B7"]); // Lá»£i nhuáº­n gá»™p nÃªn luÃ´n lÃ  mÃ u xanh

                wsPL.Cells["A8"].Value = "(-) Chi PhÃ­ Váº­n HÃ nh (OPEX)";
                wsPL.Cells["B8"].Value = data.Kpi.ChiPhiOpex;
                styleExpense(wsPL.Cells["B8"]);

                wsPL.Cells["A9"].Value = "(=) Lá»¢I NHUáº¬N RÃ’NG";
                wsPL.Cells["B9"].Value = data.Kpi.LoiNhuanRong;
                // Lá»£i nhuáº­n rÃ²ng cÃ³ thá»ƒ Ã¢m hoáº·c dÆ°Æ¡ng
                if (data.Kpi.LoiNhuanRong >= 0)
                {
                    styleProfit(wsPL.Cells["B9"]);
                }
                else
                {
                    styleExpense(wsPL.Cells["B9"]);
                }
                wsPL.Cells["A9"].Style.Font.Bold = true;

                // Káº» viá»n cho báº£ng P&L
                wsPL.Cells["A4:B9"].Style.Border.BorderAround(ExcelBorderStyle.Medium);

                // Chi tiáº¿t Doanh thu
                wsPL.Cells["D4:E4"].Value = "CHI TIáº¾T DOANH THU";
                styleGroupHeader(wsPL.Cells["D4:E4"]);
                wsPL.Cells["D5"].Value = "Tá»•ng doanh thu gá»‘c";
                wsPL.Cells["E5"].Value = data.ChiTietDoanhThu.TongDoanhThuGoc;
                wsPL.Cells["D6"].Value = "Tá»•ng giáº£m giÃ¡";
                wsPL.Cells["E6"].Value = data.ChiTietDoanhThu.TongGiamGia;
                wsPL.Cells["D7"].Value = "Tá»•ng phá»¥ thu";
                wsPL.Cells["E7"].Value = data.ChiTietDoanhThu.TongPhuThu;
                wsPL.Cells["D8"].Value = "DOANH THU RÃ’NG";
                wsPL.Cells["E8"].Value = data.ChiTietDoanhThu.DoanhThuRong;
                wsPL.Cells["D8,E8"].Style.Font.Bold = true;

                wsPL.Cells["D10"].Value = "Sá»‘ lÆ°á»£ng hÃ³a Ä‘Æ¡n";
                wsPL.Cells["E10"].Value = data.ChiTietDoanhThu.SoLuongHoaDon;
                wsPL.Cells["D11"].Value = "GiÃ¡ trá»‹ trung bÃ¬nh HÄ";
                wsPL.Cells["E11"].Value = data.ChiTietDoanhThu.GiaTriTrungBinhHD;

                // Äá»‹nh dáº¡ng tiá»n tá»‡ cho nhÃ³m Doanh Thu
                styleCurrency(wsPL.Cells["E5:E8"]);
                styleCurrency(wsPL.Cells["E11"]);
                wsPL.Cells["E10"].Style.Numberformat.Format = "#,##0";
                wsPL.Cells["D4:E11"].Style.Border.BorderAround(ExcelBorderStyle.Medium);

                // Chi tiáº¿t Chi PhÃ­
                wsPL.Cells["D13:E13"].Value = "CHI TIáº¾T CHI PHÃ";
                styleGroupHeader(wsPL.Cells["D13:E13"]);
                wsPL.Cells["D14"].Value = "Tá»•ng GiÃ¡ Vá»‘n (COGS)";
                wsPL.Cells["E14"].Value = data.ChiTietChiPhi.TongGiaVon_COGS;
                wsPL.Cells["D15"].Value = "Tá»•ng Chi PhÃ­ LÆ°Æ¡ng";
                wsPL.Cells["E15"].Value = data.ChiTietChiPhi.TongChiPhiLuong;
                wsPL.Cells["D16"].Value = "Tá»•ng Chi PhÃ­ Há»§y HÃ ng";
                wsPL.Cells["E16"].Value = data.ChiTietChiPhi.TongChiPhiHuyHang;

                // Äá»‹nh dáº¡ng tiá»n tá»‡ cho nhÃ³m Chi PhÃ­
                styleCurrency(wsPL.Cells["E14:E16"]);
                wsPL.Cells["D13:E16"].Style.Border.BorderAround(ExcelBorderStyle.Medium);

                // Tá»± Ä‘á»™ng cÄƒn chá»‰nh cá»™t
                wsPL.Cells[wsPL.Dimension.Address].AutoFitColumns();
                wsPL.Column(1).Width = 25; // Cá»™t A
                wsPL.Column(2).Width = 20; // Cá»™t B
                wsPL.Column(4).Width = 25; // Cá»™t D
                wsPL.Column(5).Width = 20; // Cá»™t E

                // --- 3. SHEET 2: TOP Sáº¢N PHáº¨M ---
                var wsTop = package.Workbook.Worksheets.Add("Top Sáº£n Pháº©m");

                wsTop.Cells["A1:C1"].Value = "TOP Sáº¢N PHáº¨M BÃN CHáº Y";
                styleMainTitle(wsTop.Cells["A1:C1"]);

                wsTop.Cells["A2:C2"].Value = $"Tá»« ngÃ y {startDate:dd/MM/yyyy} Ä‘áº¿n {endDate:dd/MM/yyyy}";
                styleSubTitle(wsTop.Cells["A2:C2"]);

                // DÃ¹ng LoadFromCollection Ä‘á»ƒ táº¡o báº£ng tá»± Ä‘á»™ng
                wsTop.Cells["A4"].LoadFromCollection(data.TopSanPham, true, OfficeOpenXml.Table.TableStyles.Medium9);

                // Äá»‹nh dáº¡ng láº¡i cá»™t sá»‘ lÆ°á»£ng vÃ  tiá»n tá»‡ trong báº£ng
                var tbl = wsTop.Tables[0];
                tbl.Columns["TongSoLuongBan"].TotalsRowFunction = OfficeOpenXml.Table.RowFunctions.Sum;
                wsTop.Cells[tbl.Address.Start.Row + 1, tbl.Columns["TongSoLuongBan"].Position + 1, tbl.Address.End.Row, tbl.Columns["TongSoLuongBan"].Position + 1].Style.Numberformat.Format = "#,##0";

                tbl.Columns["TongDoanhThu"].TotalsRowFunction = OfficeOpenXml.Table.RowFunctions.Sum;
                wsTop.Cells[tbl.Address.Start.Row + 1, tbl.Columns["TongDoanhThu"].Position + 1, tbl.Address.End.Row, tbl.Columns["TongDoanhThu"].Position + 1].Style.Numberformat.Format = currencyFormat;

                wsTop.Cells[wsTop.Dimension.Address].AutoFitColumns();

                // --- 4. LÆ¯U FILE ---
                await package.SaveAsync();
            }
        }

        private void BtnBack_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\BaoCaoHieuSuatNhanVientPreview.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\BaoCaoHieuSuatNhanVientPreview.xaml
<Page x:Class="AppCafebookApi.View.common.BaoCaoHieuSuatNhanVientPreviewWindow"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.common"
      mc:Ignorable="d" 
      d:DesignHeight="720" d:DesignWidth="1000"
      Title="BÃ¡o cÃ¡o Hiá»‡u suáº¥t NhÃ¢n viÃªn"
      Background="#FFF8E1"
      FontFamily="Segoe UI"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>

        <Style TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,8"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="KpiCard" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="15"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="KpiValue" TargetType="TextBlock">
            <Setter Property="FontSize" Value="24"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>
        <Style x:Key="KpiTitle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
        </Style>
        <Style TargetType="DataGrid">
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="CanUserAddRows" Value="False"/>
            <Setter Property="CanUserDeleteRows" Value="False"/>
            <Setter Property="IsReadOnly" Value="True"/>
            <Setter Property="AutoGenerateColumns" Value="False"/>
            <Setter Property="GridLinesVisibility" Value="None"/>
        </Style>
    </Page.Resources>

    <Grid Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="White" Padding="15" Margin="10" CornerRadius="8">
            <WrapPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="Tá»« ngÃ y:" VerticalAlignment="Center" Margin="5"/>
                <DatePicker x:Name="dpStartDate" Width="150" VerticalAlignment="Center" Margin="0,0,15,0"/>

                <TextBlock Text="Äáº¿n ngÃ y:" VerticalAlignment="Center" Margin="5"/>
                <DatePicker x:Name="dpEndDate" Width="150" VerticalAlignment="Center" Margin="0,0,15,0"/>

                <TextBlock Text="Vai trÃ²:" VerticalAlignment="Center" Margin="5"/>
                <ComboBox x:Name="cmbVaiTro" Width="150" VerticalAlignment="Center" Margin="0,0,15,0"
                          DisplayMemberPath="Ten" SelectedValuePath="Id"/>

                <TextBlock Text="TÃªn nhÃ¢n viÃªn:" VerticalAlignment="Center" Margin="5"/>
                <TextBox x:Name="txtSearchNhanVien" Width="150" VerticalAlignment="Center" Margin="0,0,15,0"/>

                <Button x:Name="btnGenerate" Content="Táº¡o BÃ¡o CÃ¡o" Margin="20,15,0,0" Click="BtnGenerate_Click"/>
            </WrapPanel>
        </Border>

        <Grid Grid.Row="1" Margin="10,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblTongDoanhThu" Text="0" Style="{StaticResource KpiValue}" Foreground="#42A5F5"/>
                    <TextBlock Text="Tá»•ng Doanh Thu (NV)" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="1" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblTongGioLam" Text="0" Style="{StaticResource KpiValue}" Foreground="#6F4E37"/>
                    <TextBlock Text="Tá»•ng Giá» LÃ m (ÄÃ£ CC)" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="2" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblTongSoCaLam" Text="0" Style="{StaticResource KpiValue}" Foreground="#66BB6A"/>
                    <TextBlock Text="Tá»•ng Sá»‘ Ca LÃ m" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="3" Style="{StaticResource KpiCard}" Margin="0">
                <StackPanel>
                    <TextBlock x:Name="lblTongLanHuyMon" Text="0" Style="{StaticResource KpiValue}" Foreground="#EF5350"/>
                    <TextBlock Text="Tá»•ng Láº§n Há»§y MÃ³n (Lá»—i)" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
        </Grid>

        <TabControl x:Name="MainTabControl" Grid.Row="2" Margin="10">
            <TabItem Header="Hiá»‡u suáº¥t BÃ¡n hÃ ng">
                <DataGrid x:Name="dgSalesPerformance">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="TÃªn NhÃ¢n ViÃªn" Binding="{Binding HoTen}" Width="*"/>
                        <DataGridTextColumn Header="Vai TrÃ²" Binding="{Binding TenVaiTro}" Width="120"/>
                        <DataGridTextColumn Header="Tá»•ng Doanh Thu" Binding="{Binding TongDoanhThu, StringFormat=N0}" Width="130"/>
                        <DataGridTextColumn Header="Sá»‘ HÄ" Binding="{Binding SoHoaDon}" Width="80"/>
                        <DataGridTextColumn Header="Doanh thu / HÄ" Binding="{Binding DoanhThuTrungBinh, StringFormat=N0}" Width="120"/>
                        <DataGridTextColumn Header="Sá»‘ láº§n Há»§y mÃ³n" Binding="{Binding SoLanHuyMon}" Width="120"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="Hiá»‡u suáº¥t Váº­n hÃ nh (Kho)">
                <DataGrid x:Name="dgOperationalPerformance">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="TÃªn NhÃ¢n ViÃªn" Binding="{Binding HoTen}" Width="*"/>
                        <DataGridTextColumn Header="Vai TrÃ²" Binding="{Binding TenVaiTro}" Width="120"/>
                        <DataGridTextColumn Header="Sá»‘ Phiáº¿u Nháº­p" Binding="{Binding PhieuNhap}" Width="120"/>
                        <DataGridTextColumn Header="Sá»‘ Phiáº¿u Kiá»ƒm" Binding="{Binding PhieuKiem}" Width="120"/>
                        <DataGridTextColumn Header="Sá»‘ Phiáº¿u Há»§y" Binding="{Binding PhieuHuy}" Width="120"/>
                        <DataGridTextColumn Header="Sá»‘ ÄÆ¡n ÄÃ£ Duyá»‡t" Binding="{Binding DonDuyet}" Width="120"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="ChuyÃªn cáº§n &amp; Vi pháº¡m">
                <DataGrid x:Name="dgAttendance">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="TÃªn NhÃ¢n ViÃªn" Binding="{Binding HoTen}" Width="*"/>
                        <DataGridTextColumn Header="Tá»•ng Sá»‘ Ca LÃ m" Binding="{Binding TongSoCaLam}" Width="120"/>
                        <DataGridTextColumn Header="Tá»•ng Giá» LÃ m (CC)" Binding="{Binding TongGioLam}" Width="140"/>
                        <DataGridTextColumn Header="Sá»‘ ÄÆ¡n Xin Nghá»‰" Binding="{Binding SoDonXinNghi}" Width="120"/>
                        <DataGridTextColumn Header="ÄÃ£ Duyá»‡t" Binding="{Binding SoDonDaDuyet}" Width="100"/>
                        <DataGridTextColumn Header="Chá» Duyá»‡t" Binding="{Binding SoDonChoDuyet}" Width="100"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
        </TabControl>

        <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="25">
            <Button x:Name="btnBack" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" 
                    Click="BtnBack_Click">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="&lt; Quay láº¡i" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>

            <Button x:Name="btnExportToExcel" 
                    Content="Xuáº¥t Excel" 
                    Margin="20,0,0,0" 
                    HorizontalAlignment="Right"
                    Click="BtnExportToExcel_Click" />
        </StackPanel>

        <Border x:Name="LoadingOverlay" Grid.Row="1" Grid.RowSpan="3" Background="#80FFFFFF" Visibility="Collapsed">
            <TextBlock Text="Äang táº¡o bÃ¡o cÃ¡o..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\BaoCaoHieuSuatNhanVientPreview.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.IO;
using Microsoft.Win32;
using OfficeOpenXml;
using OfficeOpenXml.Style;
using System.Threading.Tasks;
using Newtonsoft.Json.Linq; // Cáº§n NuGet Newtonsoft.Json
using System.Globalization;

namespace AppCafebookApi.View.common
{
    public partial class BaoCaoHieuSuatNhanVientPreviewWindow : Page
    {
        private static readonly HttpClient httpClient;
        private BaoCaoHieuSuatTongHopDto? currentReportData;

        static BaoCaoHieuSuatNhanVientPreviewWindow()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public BaoCaoHieuSuatNhanVientPreviewWindow()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            // Thiáº¿t láº­p ngÃ y máº·c Ä‘á»‹nh (vÃ­ dá»¥: thÃ¡ng nÃ y)
            var now = DateTime.Now;
            dpStartDate.SelectedDate = new DateTime(now.Year, now.Month, 1);
            dpEndDate.SelectedDate = now;

            await LoadFiltersAsync();
            await GenerateReportAsync();
        }

        private async Task LoadFiltersAsync()
        {
            try
            {
                var response = await httpClient.GetStringAsync("api/app/baocaohieusuat/filters");
                var json = JObject.Parse(response);

                var vaiTros = json["vaiTros"]?.ToObject<List<FilterLookupDto>>() ?? new List<FilterLookupDto>();
                vaiTros.Insert(0, new FilterLookupDto { Id = 0, Ten = "Táº¥t cáº£ Vai trÃ²" });
                cmbVaiTro.ItemsSource = vaiTros;
                cmbVaiTro.SelectedValue = 0;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"KhÃ´ng thá»ƒ táº£i bá»™ lá»c: {ex.Message}", "Lá»—i API");
            }
        }

        private async void BtnGenerate_Click(object sender, RoutedEventArgs e)
        {
            await GenerateReportAsync();
        }

        private async Task GenerateReportAsync()
        {
            if (dpStartDate.SelectedDate == null || dpEndDate.SelectedDate == null)
            {
                MessageBox.Show("Vui lÃ²ng chá»n cáº£ NgÃ y báº¯t Ä‘áº§u vÃ  NgÃ y káº¿t thÃºc.", "Thiáº¿u thÃ´ng tin");
                return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            btnGenerate.IsEnabled = false;

            var request = new BaoCaoHieuSuatRequestDto
            {
                StartDate = dpStartDate.SelectedDate.Value,
                EndDate = dpEndDate.SelectedDate.Value,
                SearchText = string.IsNullOrEmpty(txtSearchNhanVien.Text) ? null : txtSearchNhanVien.Text,
                VaiTroId = (int)cmbVaiTro.SelectedValue == 0 ? (int?)null : (int)cmbVaiTro.SelectedValue,
            };

            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/baocaohieusuat/report", request);
                if (response.IsSuccessStatusCode)
                {
                    currentReportData = await response.Content.ReadFromJsonAsync<BaoCaoHieuSuatTongHopDto>();
                    if (currentReportData != null)
                    {
                        PopulateUi(currentReportData);
                    }
                }
                else
                {
                    MessageBox.Show($"Lá»—i API: {response.ReasonPhrase}", "Lá»—i");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"KhÃ´ng thá»ƒ káº¿t ná»‘i API: {ex.Message}", "Lá»—i");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
                btnGenerate.IsEnabled = true;
            }
        }

        private void PopulateUi(BaoCaoHieuSuatTongHopDto data)
        {
            var culture = CultureInfo.GetCultureInfo("vi-VN");

            // 1. Cáº­p nháº­t Tháº» KPI
            lblTongDoanhThu.Text = data.Kpi.TongDoanhThu.ToString("C0", culture);
            lblTongGioLam.Text = data.Kpi.TongGioLam.ToString("N1");
            lblTongSoCaLam.Text = data.Kpi.TongSoCaLam.ToString();
            lblTongLanHuyMon.Text = data.Kpi.TongLanHuyMon.ToString();

            // 2. Cáº­p nháº­t cÃ¡c Tab
            dgSalesPerformance.ItemsSource = data.SalesPerformance;
            dgOperationalPerformance.ItemsSource = data.OperationalPerformance;
            dgAttendance.ItemsSource = data.Attendance;
        }

        // DÃ¡n Ä‘Ã¨ lÃªn hÃ m BtnExportToExcel_Click CÅ¨
        private async void BtnExportToExcel_Click(object sender, RoutedEventArgs e)
        {
            if (currentReportData == null)
            {
                MessageBox.Show("ChÆ°a cÃ³ dá»¯ liá»‡u bÃ¡o cÃ¡o Ä‘á»ƒ xuáº¥t. Vui lÃ²ng nháº¥n 'Lá»c BÃ¡o CÃ¡o' trÆ°á»›c.", "ChÆ°a cÃ³ dá»¯ liá»‡u");
                return;
            }

            // KIá»‚M TRA QUAN TRá»ŒNG: Äáº£m báº£o ngÃ y Ä‘Ã£ Ä‘Æ°á»£c chá»n
            if (dpStartDate.SelectedDate == null || dpEndDate.SelectedDate == null)
            {
                MessageBox.Show("Vui lÃ²ng chá»n ngÃ y báº¯t Ä‘áº§u vÃ  káº¿t thÃºc há»£p lá»‡.", "Lá»—i ngÃ y");
                return;
            }

            var sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                FileName = $"BaoCaoHieuSuatNV_{DateTime.Now:yyyyMMdd_HHmm}.xlsx"
            };

            if (sfd.ShowDialog() == true)
            {
                try
                {
                    LoadingOverlay.Visibility = Visibility.Visible;

                    // Sá»¬A Lá»–I: Truyá»n ngÃ y vÃ o hÃ m
                    await CreateExcelReportAsync(
                        sfd.FileName,
                        currentReportData,
                        dpStartDate.SelectedDate.Value,
                        dpEndDate.SelectedDate.Value);

                    LoadingOverlay.Visibility = Visibility.Collapsed;

                    MessageBox.Show($"ÄÃ£ xuáº¥t bÃ¡o cÃ¡o thÃ nh cÃ´ng!\n\nÄÆ°á»ng dáº«n: {sfd.FileName}", "ThÃ nh cÃ´ng", MessageBoxButton.OK, MessageBoxImage.Information);
                }
                catch (Exception ex)
                {
                    LoadingOverlay.Visibility = Visibility.Collapsed;
                    MessageBox.Show($"CÃ³ lá»—i khi xuáº¥t Excel: {ex.Message}\n\nÄáº£m báº£o báº¡n Ä‘Ã£ Ä‘Ã³ng file Excel (náº¿u nÃ³ Ä‘ang má»Ÿ).", "Lá»—i Xuáº¥t File", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        // DÃ¡n Ä‘Ã¨ lÃªn hÃ m CreateExcelReportAsync CÅ¨ cá»§a báº¡n
        private async Task CreateExcelReportAsync(string filePath, BaoCaoHieuSuatTongHopDto data, DateTime startDate, DateTime endDate)
        {
            ExcelPackage.License.SetNonCommercialPersonal("CafeBook");
            var fileInfo = new FileInfo(filePath);

            if (fileInfo.Exists)
            {
                fileInfo.Delete(); // XÃ³a file cÅ© náº¿u tá»“n táº¡i
            }

            using (var package = new ExcelPackage(fileInfo))
            {
                // --- 1. Äá»ŠNH NGHÄ¨A STYLES & FORMATS ---
                var currencyFormat = "#,##0 \"Ä‘\"";
                var numberFormat = "#,##0";
                var decimalFormat = "#,##0.0";
                var culture = CultureInfo.GetCultureInfo("vi-VN");

                // Style cho TiÃªu Ä‘á» chÃ­nh (Merge cell, to, Ä‘áº­m, ná»n xanh)
                Action<ExcelRange> styleMainTitle = (range) =>
                {
                    range.Merge = true;
                    range.Style.Font.Bold = true;
                    range.Style.Font.Size = 16;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    range.Style.Fill.PatternType = ExcelFillStyle.Solid;
                    range.Style.Fill.BackgroundColor.SetColor(System.Drawing.ColorTranslator.FromHtml("#333366")); // Xanh Ä‘áº­m
                    range.Style.Font.Color.SetColor(System.Drawing.Color.White);
                };

                // Style cho TiÃªu Ä‘á» phá»¥ (Merge cell, nghiÃªng)
                Action<ExcelRange> styleSubTitle = (range) =>
                {
                    range.Merge = true;
                    range.Style.Font.Italic = true;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                };

                // --- 2. SHEET 1: Tá»”NG QUAN (Sheet Má»šI) ---
                var wsTongQuan = package.Workbook.Worksheets.Add("Tá»•ng Quan Hiá»‡u Suáº¥t");

                // TiÃªu Ä‘á»
                wsTongQuan.Cells["A1:D1"].Value = "BÃO CÃO Tá»”NG QUAN HIá»†U SUáº¤T";
                styleMainTitle(wsTongQuan.Cells["A1:D1"]);

                wsTongQuan.Cells["A2:D2"].Value = $"BÃ¡o cÃ¡o cho ká»³ tá»« {startDate:dd/MM/yyyy} Ä‘áº¿n {endDate:dd/MM/yyyy}";
                styleSubTitle(wsTongQuan.Cells["A2:D2"]);

                // Hiá»ƒn thá»‹ KPIs
                wsTongQuan.Cells["A4"].Value = "CHá»ˆ Sá» KPI TOÃ€N QUÃN";
                wsTongQuan.Cells["A4:B4"].Merge = true;
                wsTongQuan.Cells["A4:B4"].Style.Font.Bold = true;
                wsTongQuan.Cells["A4:B4"].Style.Fill.PatternType = ExcelFillStyle.Solid;
                wsTongQuan.Cells["A4:B4"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);

                wsTongQuan.Cells["A5"].Value = "Tá»•ng Doanh Thu";
                wsTongQuan.Cells["B5"].Value = data.Kpi.TongDoanhThu;
                wsTongQuan.Cells["B5"].Style.Numberformat.Format = currencyFormat;

                wsTongQuan.Cells["A6"].Value = "Tá»•ng Giá» LÃ m";
                wsTongQuan.Cells["B6"].Value = data.Kpi.TongGioLam;
                wsTongQuan.Cells["B6"].Style.Numberformat.Format = decimalFormat;

                wsTongQuan.Cells["A7"].Value = "Tá»•ng Sá»‘ Ca LÃ m";
                wsTongQuan.Cells["B7"].Value = data.Kpi.TongSoCaLam;
                wsTongQuan.Cells["B7"].Style.Numberformat.Format = numberFormat;

                wsTongQuan.Cells["A8"].Value = "Tá»•ng Láº§n Há»§y MÃ³n";
                wsTongQuan.Cells["B8"].Value = data.Kpi.TongLanHuyMon;
                wsTongQuan.Cells["B8"].Style.Numberformat.Format = numberFormat;
                if (data.Kpi.TongLanHuyMon > 0)
                {
                    wsTongQuan.Cells["A8:B8"].Style.Font.Color.SetColor(System.Drawing.Color.Red);
                    wsTongQuan.Cells["A8:B8"].Style.Font.Bold = true;
                }

                // CHá»ˆ Sá» Má»šI (QUAN TRá»ŒNG)
                decimal doanhThuPerGioLam = (data.Kpi.TongGioLam > 0) ? (data.Kpi.TongDoanhThu / (decimal)data.Kpi.TongGioLam) : 0;
                wsTongQuan.Cells["A10"].Value = "HIá»†U SUáº¤T (Doanh Thu / Giá»)";
                wsTongQuan.Cells["B10"].Value = doanhThuPerGioLam;
                wsTongQuan.Cells["B10"].Style.Numberformat.Format = currencyFormat;
                wsTongQuan.Cells["A10:B10"].Style.Font.Bold = true;
                wsTongQuan.Cells["A10:B10"].Style.Font.Color.SetColor(System.Drawing.Color.Green);

                // Káº» viá»n
                wsTongQuan.Cells["A4:B8"].Style.Border.BorderAround(ExcelBorderStyle.Medium);
                wsTongQuan.Cells["A10:B10"].Style.Border.BorderAround(ExcelBorderStyle.Medium);

                wsTongQuan.Cells[wsTongQuan.Dimension.Address].AutoFitColumns();

                // --- 3. SHEET 2: HIá»†U SUáº¤T BÃN HÃ€NG ---
                var ws1 = package.Workbook.Worksheets.Add("Hiá»‡u Suáº¥t BÃ¡n HÃ ng");
                ws1.Cells["A1:F1"].Value = "BÃ¡o cÃ¡o Hiá»‡u suáº¥t BÃ¡n hÃ ng (Thu ngÃ¢n, Phá»¥c vá»¥)";
                styleMainTitle(ws1.Cells["A1:F1"]);

                ws1.Cells["A3"].LoadFromCollection(data.SalesPerformance, true, OfficeOpenXml.Table.TableStyles.Medium9);
                var tbl1 = ws1.Tables[0];

                // Äá»‹nh dáº¡ng cá»™t
                ws1.Cells[tbl1.Address.Start.Row + 1, tbl1.Columns["TongDoanhThu"].Position + 1, tbl1.Address.End.Row, tbl1.Columns["TongDoanhThu"].Position + 1].Style.Numberformat.Format = currencyFormat;
                ws1.Cells[tbl1.Address.Start.Row + 1, tbl1.Columns["SoHoaDon"].Position + 1, tbl1.Address.End.Row, tbl1.Columns["SoHoaDon"].Position + 1].Style.Numberformat.Format = numberFormat;
                ws1.Cells[tbl1.Address.Start.Row + 1, tbl1.Columns["DoanhThuTrungBinh"].Position + 1, tbl1.Address.End.Row, tbl1.Columns["DoanhThuTrungBinh"].Position + 1].Style.Numberformat.Format = currencyFormat;

                // Äá»‹nh dáº¡ng cÃ³ Ä‘iá»u kiá»‡n: TÃ´ Ä‘á» cá»™t "Há»§y MÃ³n" náº¿u > 0
                var huyMonColRange = ws1.Cells[tbl1.Address.Start.Row + 1, tbl1.Columns["SoLanHuyMon"].Position + 1, tbl1.Address.End.Row, tbl1.Columns["SoLanHuyMon"].Position + 1];
                huyMonColRange.Style.Numberformat.Format = numberFormat;
                var cfRuleHuyMon = huyMonColRange.ConditionalFormatting.AddGreaterThan();
                cfRuleHuyMon.Formula = "0";
                cfRuleHuyMon.Style.Font.Color.SetColor(System.Drawing.Color.Red);
                cfRuleHuyMon.Style.Font.Bold = true;

                ws1.Cells[ws1.Dimension.Address].AutoFitColumns();

                // --- 4. SHEET 3: HIá»†U SUáº¤T Váº¬N HÃ€NH (Kho, Quáº£n lÃ½) ---
                var ws2 = package.Workbook.Worksheets.Add("Hiá»‡u Suáº¥t Váº­n HÃ nh");
                ws2.Cells["A1:F1"].Value = "BÃ¡o cÃ¡o Hiá»‡u suáº¥t Váº­n hÃ nh (Kho, Quáº£n lÃ½)";
                styleMainTitle(ws2.Cells["A1:F1"]);

                ws2.Cells["A3"].LoadFromCollection(data.OperationalPerformance, true, OfficeOpenXml.Table.TableStyles.Medium10);
                var tbl2 = ws2.Tables[0];

                // Äá»‹nh dáº¡ng sá»‘
                ws2.Cells[tbl2.Address.Start.Row + 1, 3, tbl2.Address.End.Row, tbl2.Address.End.Column].Style.Numberformat.Format = numberFormat;

                ws2.Cells[ws2.Dimension.Address].AutoFitColumns();

                // --- 5. SHEET 4: CHUYÃŠN Cáº¦N ---
                var ws3 = package.Workbook.Worksheets.Add("BÃ¡o CÃ¡o ChuyÃªn Cáº§n");
                ws3.Cells["A1:F1"].Value = "BÃ¡o cÃ¡o ChuyÃªn cáº§n & Vi pháº¡m";
                styleMainTitle(ws3.Cells["A1:F1"]);

                ws3.Cells["A3"].LoadFromCollection(data.Attendance, true, OfficeOpenXml.Table.TableStyles.Medium11);
                var tbl3 = ws3.Tables[0];

                // Äá»‹nh dáº¡ng cá»™t
                ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["TongGioLam"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["TongGioLam"].Position + 1].Style.Numberformat.Format = decimalFormat;
                ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["TongSoCaLam"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["TongSoCaLam"].Position + 1].Style.Numberformat.Format = numberFormat;
                ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["SoDonXinNghi"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["SoDonXinNghi"].Position + 1].Style.Numberformat.Format = numberFormat;
                ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["SoDonDaDuyet"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["SoDonDaDuyet"].Position + 1].Style.Numberformat.Format = numberFormat;

                // Äá»‹nh dáº¡ng cÃ³ Ä‘iá»u kiá»‡n: TÃ´ vÃ ng cá»™t "Chá» Duyá»‡t" náº¿u > 0 (Ä‘á»ƒ quáº£n lÃ½ chÃº Ã½)
                var choDuyetColRange = ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["SoDonChoDuyet"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["SoDonChoDuyet"].Position + 1];
                choDuyetColRange.Style.Numberformat.Format = numberFormat;
                var cfRuleChoDuyet = choDuyetColRange.ConditionalFormatting.AddGreaterThan();
                cfRuleChoDuyet.Formula = "0";
                cfRuleChoDuyet.Style.Fill.PatternType = ExcelFillStyle.Solid;
                cfRuleChoDuyet.Style.Fill.BackgroundColor.Color = System.Drawing.Color.LightGoldenrodYellow;
                cfRuleChoDuyet.Style.Font.Bold = true;

                ws3.Cells[ws3.Dimension.Address].AutoFitColumns();

                // --- 6. LÆ¯U FILE ---
                await package.SaveAsync();
            }
        }

        private void BtnBack_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\BaoCaoTonKhoNguyenLieuPreviewWindow.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\BaoCaoTonKhoNguyenLieuPreviewWindow.xaml
<Page x:Class="AppCafebookApi.View.common.BaoCaoTonKhoNguyenLieuPreviewWindow"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.common"
      mc:Ignorable="d" 
      d:DesignHeight="720" d:DesignWidth="1000"
      Title="BÃ¡o cÃ¡o Tá»“n kho NguyÃªn liá»‡u"
      Background="#FFF8E1"
      FontFamily="Segoe UI"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>

        <Style TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,8"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="KpiCard" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="15"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="KpiValue" TargetType="TextBlock">
            <Setter Property="FontSize" Value="24"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>
        <Style x:Key="KpiTitle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
        </Style>
        <Style TargetType="DataGrid">
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="CanUserAddRows" Value="False"/>
            <Setter Property="CanUserDeleteRows" Value="False"/>
            <Setter Property="IsReadOnly" Value="True"/>
            <Setter Property="AutoGenerateColumns" Value="False"/>
            <Setter Property="GridLinesVisibility" Value="None"/>
        </Style>
    </Page.Resources>

    <Grid Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="White" Padding="15" Margin="10" CornerRadius="8">
            <WrapPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="TÃªn NguyÃªn liá»‡u:" VerticalAlignment="Center" Margin="5"/>
                <TextBox x:Name="txtSearch" Width="200" VerticalAlignment="Center" Margin="0,0,15,0"/>

                <TextBlock Text="NhÃ  Cung cáº¥p:" VerticalAlignment="Center" Margin="5"/>
                <ComboBox x:Name="cmbNhaCungCap" Width="180" VerticalAlignment="Center" Margin="0,0,15,0"
                          DisplayMemberPath="Ten" SelectedValuePath="Id"/>

                <CheckBox x:Name="chkLowStockOnly" Content="Chá»‰ hiá»ƒn thá»‹ hÃ ng sáº¯p háº¿t" 
                          VerticalAlignment="Center" Margin="15,0,0,0"/>

                    <Button x:Name="btnGenerate" Content="Lá»c BÃ¡o CÃ¡o" Margin="20,0,0,0" Click="BtnGenerate_Click"/>
            </WrapPanel>
        </Border>

        <Grid Grid.Row="1" Margin="10,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblGiaTriTonKho" Text="0" Style="{StaticResource KpiValue}" Foreground="#42A5F5"/>
                    <TextBlock Text="Tá»•ng GiÃ¡ Trá»‹ Tá»“n Kho" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="1" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblSPSapHet" Text="0" Style="{StaticResource KpiValue}" Foreground="#FFA726"/>
                    <TextBlock Text="Sá»‘ LÆ°á»£ng SP Sáº¯p Háº¿t" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="2" Style="{StaticResource KpiCard}" Margin="0">
                <StackPanel>
                    <TextBlock x:Name="lblGiaTriDaHuy" Text="0" Style="{StaticResource KpiValue}" Foreground="#EF5350"/>
                    <TextBlock Text="Tá»•ng GiÃ¡ Trá»‹ ÄÃ£ Há»§y (30 ngÃ y)" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
        </Grid>

        <TabControl x:Name="MainTabControl" Grid.Row="2" Margin="10">
            <TabItem Header="BÃ¡o cÃ¡o Tá»“n kho Hiá»‡n táº¡i">
                <DataGrid x:Name="dgInventory">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="TÃªn NguyÃªn Liá»‡u" Binding="{Binding TenNguyenLieu}" Width="*"/> 
                        <DataGridTextColumn Header="ÄÆ¡n vá»‹ tÃ­nh" Binding="{Binding DonViTinh}" Width="100"/> 
                        <DataGridTextColumn Header="Tá»“n kho (HT)" Binding="{Binding TonKho}" Width="120"/> 
                        <DataGridTextColumn Header="Tá»“n kho Tá»‘i thiá»ƒu" Binding="{Binding TonKhoToiThieu}" Width="120"/> 
                        <DataGridTextColumn Header="TÃ¬nh Tráº¡ng" Binding="{Binding TinhTrang}" Width="120"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="Lá»‹ch sá»­ Kiá»ƒm KÃª (ChÃªnh lá»‡ch)">
                <DataGrid x:Name="dgAuditHistory">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="NgÃ y Kiá»ƒm" Binding="{Binding NgayKiem, StringFormat='dd/MM/yyyy'}" Width="120"/>
                        <DataGridTextColumn Header="TÃªn NguyÃªn Liá»‡u" Binding="{Binding TenNguyenLieu}" Width="*"/> 
                        <DataGridTextColumn Header="Tá»“n (Há»‡ thá»‘ng)" Binding="{Binding TonKhoHeThong}" Width="120"/> 
                        <DataGridTextColumn Header="Tá»“n (Thá»±c táº¿)" Binding="{Binding TonKhoThucTe}" Width="120"/> 
                        <DataGridTextColumn Header="ChÃªnh lá»‡ch" Binding="{Binding ChenhLech}" Width="120"/> 
                        <DataGridTextColumn Header="LÃ½ do" Binding="{Binding LyDoChenhLech}" Width="200"/> 
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="Lá»‹ch sá»­ Há»§y HÃ ng">
                <DataGrid x:Name="dgWasteHistory">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="NgÃ y Há»§y" Binding="{Binding NgayHuy, StringFormat='dd/MM/yyyy'}" Width="120"/>
                        <DataGridTextColumn Header="TÃªn NguyÃªn Liá»‡u" Binding="{Binding TenNguyenLieu}" Width="*"/>
                        <DataGridTextColumn Header="Sá»‘ LÆ°á»£ng Há»§y" Binding="{Binding SoLuongHuy}" Width="120"/> 
                        <DataGridTextColumn Header="GiÃ¡ trá»‹ Há»§y" Binding="{Binding GiaTriHuy, StringFormat=N0}" Width="120"/> 
                        <DataGridTextColumn Header="LÃ½ do Há»§y" Binding="{Binding LyDoHuy}" Width="250"/> 
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
        </TabControl>

        <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="25">
            <Button x:Name="btnBack" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" 
                    Click="BtnBack_Click">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="&lt; Quay láº¡i" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>

            <Button x:Name="btnExportToExcel" 
                    Content="Xuáº¥t Excel" 
                    Margin="20,0,0,0" 
                    HorizontalAlignment="Right"
                    Click="BtnExportToExcel_Click" />
        </StackPanel>

        <Border x:Name="LoadingOverlay" Grid.Row="1" Grid.RowSpan="3" Background="#80FFFFFF" Visibility="Collapsed">
            <TextBlock Text="Äang táº¡o bÃ¡o cÃ¡o..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\BaoCaoTonKhoNguyenLieuPreviewWindow.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.IO;
using Microsoft.Win32;
using OfficeOpenXml;
using OfficeOpenXml.Style;
using System.Threading.Tasks;
using Newtonsoft.Json.Linq; // Cáº§n NuGet Newtonsoft.Json
using System.Globalization;

namespace AppCafebookApi.View.common
{
    public partial class BaoCaoTonKhoNguyenLieuPreviewWindow : Page
    {
        private static readonly HttpClient httpClient;
        private BaoCaoTonKhoTongHopDto? currentReportData;

        static BaoCaoTonKhoNguyenLieuPreviewWindow()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public BaoCaoTonKhoNguyenLieuPreviewWindow()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadFiltersAsync();
            await GenerateReportAsync();
        }

        private async Task LoadFiltersAsync()
        {
            try
            {
                // DÃ¹ng JObject Ä‘á»ƒ parse dynamic JSON
                var response = await httpClient.GetStringAsync("api/app/baocaokho/filters");
                var json = JObject.Parse(response);

                var nhaCungCaps = json["nhaCungCaps"]?.ToObject<List<FilterLookupDto>>() ?? new List<FilterLookupDto>();
                nhaCungCaps.Insert(0, new FilterLookupDto { Id = 0, Ten = "Táº¥t cáº£ NCC" });
                cmbNhaCungCap.ItemsSource = nhaCungCaps;
                cmbNhaCungCap.SelectedValue = 0;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"KhÃ´ng thá»ƒ táº£i bá»™ lá»c: {ex.Message}", "Lá»—i API");
            }
        }

        private async void BtnGenerate_Click(object sender, RoutedEventArgs e)
        {
            await GenerateReportAsync();
        }

        private async Task GenerateReportAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            btnGenerate.IsEnabled = false;

            var request = new BaoCaoTonKhoRequestDto
            {
                SearchText = string.IsNullOrEmpty(txtSearch.Text) ? null : txtSearch.Text,
                NhaCungCapId = (int)cmbNhaCungCap.SelectedValue == 0 ? (int?)null : (int)cmbNhaCungCap.SelectedValue,
                ShowLowStockOnly = chkLowStockOnly.IsChecked ?? false
            };

            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/baocaokho/report", request);
                if (response.IsSuccessStatusCode)
                {
                    currentReportData = await response.Content.ReadFromJsonAsync<BaoCaoTonKhoTongHopDto>();
                    if (currentReportData != null)
                    {
                        PopulateUi(currentReportData);
                    }
                }
                else
                {
                    MessageBox.Show($"Lá»—i API: {response.ReasonPhrase}", "Lá»—i");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"KhÃ´ng thá»ƒ káº¿t ná»‘i API: {ex.Message}", "Lá»—i");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
                btnGenerate.IsEnabled = true;
            }
        }

        private void PopulateUi(BaoCaoTonKhoTongHopDto data)
        {
            var culture = CultureInfo.GetCultureInfo("vi-VN");

            // 1. Cáº­p nháº­t Tháº» KPI
            lblGiaTriTonKho.Text = data.Kpi.TongGiaTriTonKho.ToString("C0", culture);
            lblSPSapHet.Text = data.Kpi.SoLuongSPSapHet.ToString();
            lblGiaTriDaHuy.Text = data.Kpi.TongGiaTriDaHuy.ToString("C0", culture);

            // 2. Cáº­p nháº­t cÃ¡c Tab
            dgInventory.ItemsSource = data.ChiTietTonKho;
            dgAuditHistory.ItemsSource = data.LichSuKiemKe;
            dgWasteHistory.ItemsSource = data.LichSuHuyHang;
        }

        private async void BtnExportToExcel_Click(object sender, RoutedEventArgs e)
        {
            if (currentReportData == null)
            {
                MessageBox.Show("ChÆ°a cÃ³ dá»¯ liá»‡u bÃ¡o cÃ¡o Ä‘á»ƒ xuáº¥t. Vui lÃ²ng nháº¥n 'Lá»c BÃ¡o CÃ¡o' trÆ°á»›c.", "ChÆ°a cÃ³ dá»¯ liá»‡u");
                return;
            }

            var sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                FileName = $"BaoCaoTonKhoNguyenLieu_{DateTime.Now:yyyyMMdd_HHmm}.xlsx"
            };

            if (sfd.ShowDialog() == true)
            {
                try
                {
                    LoadingOverlay.Visibility = Visibility.Visible;
                    await CreateExcelReportAsync(sfd.FileName, currentReportData);
                    LoadingOverlay.Visibility = Visibility.Collapsed;

                    MessageBox.Show($"ÄÃ£ xuáº¥t bÃ¡o cÃ¡o thÃ nh cÃ´ng!\n\nÄÆ°á»ng dáº«n: {sfd.FileName}", "ThÃ nh cÃ´ng", MessageBoxButton.OK, MessageBoxImage.Information);
                }
                catch (Exception ex)
                {
                    LoadingOverlay.Visibility = Visibility.Collapsed;
                    MessageBox.Show($"CÃ³ lá»—i khi xuáº¥t Excel: {ex.Message}\n\nÄáº£m báº£o báº¡n Ä‘Ã£ Ä‘Ã³ng file Excel (náº¿u nÃ³ Ä‘ang má»Ÿ).", "Lá»—i Xuáº¥t File", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        // DÃ¡n Ä‘Ã¨ lÃªn hÃ m CreateExcelReportAsync CÅ¨ cá»§a báº¡n
        private async Task CreateExcelReportAsync(string filePath, BaoCaoTonKhoTongHopDto data)
        {
            ExcelPackage.License.SetNonCommercialPersonal("CafeBook");
            var fileInfo = new FileInfo(filePath);

            if (fileInfo.Exists)
            {
                fileInfo.Delete(); // XÃ³a file cÅ© náº¿u tá»“n táº¡i Ä‘á»ƒ trÃ¡nh lá»—i
            }

            using (var package = new ExcelPackage(fileInfo))
            {
                // --- 1. Äá»ŠNH NGHÄ¨A CÃC STYLE TÃI Sá»¬ Dá»¤NG ---

                // Äá»‹nh dáº¡ng tiá»n tá»‡ VND
                var currencyFormat = "#,##0 \"Ä‘\"";
                // Äá»‹nh dáº¡ng sá»‘ nguyÃªn
                var numberFormat = "#,##0";
                // Äá»‹nh dáº¡ng sá»‘ tháº­p phÃ¢n (cho kg, lÃ­t,...)
                var decimalFormat = "#,##0.00";
                // Äá»‹nh dáº¡ng ngÃ y
                var dateFormat = "dd/MM/yyyy";

                // Style cho TiÃªu Ä‘á» chÃ­nh (Merge cell, to, Ä‘áº­m, ná»n xanh)
                Action<ExcelRange> styleMainTitle = (range) =>
                {
                    range.Merge = true;
                    range.Style.Font.Bold = true;
                    range.Style.Font.Size = 16;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    range.Style.Fill.PatternType = ExcelFillStyle.Solid;
                    range.Style.Fill.BackgroundColor.SetColor(System.Drawing.ColorTranslator.FromHtml("#333366")); // Xanh Ä‘áº­m
                    range.Style.Font.Color.SetColor(System.Drawing.Color.White);
                };

                // Style cho TiÃªu Ä‘á» phá»¥ (Merge cell, nghiÃªng)
                Action<ExcelRange> styleSubTitle = (range) =>
                {
                    range.Merge = true;
                    range.Style.Font.Italic = true;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                };

                // --- 2. SHEET 1: Tá»”NG QUAN KHO (Sheet Má»šI) ---
                var wsTongQuan = package.Workbook.Worksheets.Add("Tá»•ng Quan Kho");

                // TiÃªu Ä‘á»
                wsTongQuan.Cells["A1:C1"].Value = "BÃO CÃO Tá»”NG QUAN KHO";
                styleMainTitle(wsTongQuan.Cells["A1:C1"]);

                wsTongQuan.Cells["A2:C2"].Value = $"BÃ¡o cÃ¡o táº¡o lÃºc: {DateTime.Now:dd/MM/yyyy HH:mm}";
                styleSubTitle(wsTongQuan.Cells["A2:C2"]);

                // Hiá»ƒn thá»‹ KPIs
                wsTongQuan.Cells["A4"].Value = "CHá»ˆ Sá» QUAN TRá»ŒNG";
                wsTongQuan.Cells["A4:B4"].Merge = true;
                wsTongQuan.Cells["A4:B4"].Style.Font.Bold = true;
                wsTongQuan.Cells["A4:B4"].Style.Fill.PatternType = ExcelFillStyle.Solid;
                wsTongQuan.Cells["A4:B4"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);

                wsTongQuan.Cells["A5"].Value = "Tá»•ng GiÃ¡ Trá»‹ Tá»“n Kho";
                wsTongQuan.Cells["B5"].Value = data.Kpi.TongGiaTriTonKho;
                wsTongQuan.Cells["B5"].Style.Numberformat.Format = currencyFormat;
                wsTongQuan.Cells["B5"].Style.Font.Bold = true;

                wsTongQuan.Cells["A6"].Value = "SL NguyÃªn Liá»‡u Sáº¯p Háº¿t";
                wsTongQuan.Cells["B6"].Value = data.Kpi.SoLuongSPSapHet;
                wsTongQuan.Cells["B6"].Style.Numberformat.Format = numberFormat;

                // TÃ´ mÃ u cáº£nh bÃ¡o náº¿u cÃ³ hÃ ng sáº¯p háº¿t
                if (data.Kpi.SoLuongSPSapHet > 0)
                {
                    wsTongQuan.Cells["B6"].Style.Font.Color.SetColor(System.Drawing.Color.OrangeRed);
                    wsTongQuan.Cells["B6"].Style.Font.Bold = true;
                }

                wsTongQuan.Cells["A7"].Value = "GiÃ¡ Trá»‹ Há»§y (30 ngÃ y qua)";
                wsTongQuan.Cells["B7"].Value = data.Kpi.TongGiaTriDaHuy;
                wsTongQuan.Cells["B7"].Style.Numberformat.Format = currencyFormat;

                // TÃ´ mÃ u Ä‘á» náº¿u cÃ³ hÃ ng bá»‹ há»§y
                if (data.Kpi.TongGiaTriDaHuy > 0)
                {
                    wsTongQuan.Cells["B7"].Style.Font.Color.SetColor(System.Drawing.Color.Red);
                    wsTongQuan.Cells["B7"].Style.Font.Bold = true;
                }

                // Káº» viá»n cho báº£ng KPI
                wsTongQuan.Cells["A4:B7"].Style.Border.BorderAround(ExcelBorderStyle.Medium);
                wsTongQuan.Cells[wsTongQuan.Dimension.Address].AutoFitColumns();

                // --- 3. SHEET 2: CHI TIáº¾T Tá»’N KHO ---
                var ws1 = package.Workbook.Worksheets.Add("Chi Tiáº¿t Tá»“n Kho");
                ws1.Cells["A1:E1"].Value = "BÃ¡o cÃ¡o Tá»“n kho NguyÃªn liá»‡u Chi tiáº¿t";
                styleMainTitle(ws1.Cells["A1:E1"]);

                // Load dá»¯ liá»‡u vÃ o Báº£ng (Table)
                ws1.Cells["A3"].LoadFromCollection(data.ChiTietTonKho, true, OfficeOpenXml.Table.TableStyles.Medium9);
                var tbl1 = ws1.Tables[0];

                // Äá»‹nh dáº¡ng sá»‘ cho cÃ¡c cá»™t trong báº£ng
                ws1.Cells[tbl1.Address.Start.Row + 1, tbl1.Columns["tonKho"].Position + 1, tbl1.Address.End.Row, tbl1.Columns["tonKho"].Position + 1].Style.Numberformat.Format = decimalFormat;
                ws1.Cells[tbl1.Address.Start.Row + 1, tbl1.Columns["TonKhoToiThieu"].Position + 1, tbl1.Address.End.Row, tbl1.Columns["TonKhoToiThieu"].Position + 1].Style.Numberformat.Format = decimalFormat;

                // *** Äá»ŠNH Dáº NG CÃ“ ÄIá»€U KIá»†N (CONDITIONAL FORMATTING) ***
                // Tá»± Ä‘á»™ng tÃ´ mÃ u cÃ¡c dÃ²ng dá»±a trÃªn "TinhTrang"
                var tinhTrangCol = tbl1.Columns["TinhTrang"].Position + 1;
                // VÃ¹ng Ã¡p dá»¥ng: toÃ n bá»™ báº£ng
                var dataRange1 = new ExcelAddress(tbl1.Address.Start.Row + 1, 1, tbl1.Address.End.Row, tbl1.Address.End.Column);

                // Quy táº¯c 1: Háº¿t hÃ ng
                var ruleHetHang = ws1.ConditionalFormatting.AddExpression(dataRange1);
                ruleHetHang.Formula = $"${ExcelCellAddress.GetColumnLetter(tinhTrangCol)}{dataRange1.Start.Row}=\"Háº¿t hÃ ng\"";
                ruleHetHang.Style.Fill.BackgroundColor.Color = System.Drawing.Color.IndianRed;
                ruleHetHang.Style.Font.Color.Color = System.Drawing.Color.White;

                // Quy táº¯c 2: Sáº¯p háº¿t
                var ruleSapHet = ws1.ConditionalFormatting.AddExpression(dataRange1);
                ruleSapHet.Formula = $"${ExcelCellAddress.GetColumnLetter(tinhTrangCol)}{dataRange1.Start.Row}=\"Sáº¯p háº¿t\"";
                ruleSapHet.Style.Fill.BackgroundColor.Color = System.Drawing.Color.LightGoldenrodYellow;

                ws1.Cells[ws1.Dimension.Address].AutoFitColumns();

                // --- 4. SHEET 3: Lá»ŠCH Sá»¬ KIá»‚M KÃŠ ---
                var ws2 = package.Workbook.Worksheets.Add("Lá»‹ch Sá»­ Kiá»ƒm KÃª");
                ws2.Cells["A1:F1"].Value = "Lá»‹ch sá»­ Kiá»ƒm KÃª (ChÃªnh lá»‡ch)";
                styleMainTitle(ws2.Cells["A1:F1"]);

                ws2.Cells["A3"].LoadFromCollection(data.LichSuKiemKe, true, OfficeOpenXml.Table.TableStyles.Medium10);
                var tbl2 = ws2.Tables[0];

                // Äá»‹nh dáº¡ng cá»™t ngÃ y
                var ngayKiemColRange = ws2.Cells[tbl2.Address.Start.Row + 1, tbl2.Columns["NgayKiem"].Position + 1, tbl2.Address.End.Row, tbl2.Columns["NgayKiem"].Position + 1];
                ngayKiemColRange.Style.Numberformat.Format = dateFormat;

                // Äá»‹nh dáº¡ng cÃ¡c cá»™t sá»‘ lÆ°á»£ng
                ws2.Cells[tbl2.Address.Start.Row + 1, tbl2.Columns["TonKhoHeThong"].Position + 1, tbl2.Address.End.Row, tbl2.Columns["TonKhoHeThong"].Position + 1].Style.Numberformat.Format = decimalFormat;
                ws2.Cells[tbl2.Address.Start.Row + 1, tbl2.Columns["TonKhoThucTe"].Position + 1, tbl2.Address.End.Row, tbl2.Columns["TonKhoThucTe"].Position + 1].Style.Numberformat.Format = decimalFormat;

                // Äá»‹nh dáº¡ng cÃ³ Ä‘iá»u kiá»‡n cho cá»™t ChÃªnh Lá»‡ch
                var chenhLechColRange = ws2.Cells[tbl2.Address.Start.Row + 1, tbl2.Columns["ChenhLech"].Position + 1, tbl2.Address.End.Row, tbl2.Columns["ChenhLech"].Position + 1];
                chenhLechColRange.Style.Numberformat.Format = decimalFormat;
                // TÃ´ Ä‘á» náº¿u < 0 (máº¥t mÃ¡t)
                var cfRuleLoss = chenhLechColRange.ConditionalFormatting.AddLessThan();
                cfRuleLoss.Formula = "0"; // GÃ¡n giÃ¡ trá»‹ so sÃ¡nh lÃ  "0"
                cfRuleLoss.Style.Font.Color.Color = System.Drawing.Color.Red;
                // TÃ´ xanh náº¿u > 0 (dÆ°)
                var cfRuleGain = chenhLechColRange.ConditionalFormatting.AddGreaterThan();
                cfRuleGain.Formula = "0"; // GÃ¡n giÃ¡ trá»‹ so sÃ¡nh lÃ  "0"
                cfRuleGain.Style.Font.Color.Color = System.Drawing.Color.Green;

                ws2.Cells[ws2.Dimension.Address].AutoFitColumns();

                // --- 5. SHEET 4: Lá»ŠCH Sá»¬ Há»¦Y HÃ€NG ---
                var ws3 = package.Workbook.Worksheets.Add("Lá»‹ch Sá»­ Há»§y HÃ ng");
                ws3.Cells["A1:E1"].Value = "Lá»‹ch sá»­ Há»§y HÃ ng";
                styleMainTitle(ws3.Cells["A1:E1"]);

                ws3.Cells["A3"].LoadFromCollection(data.LichSuHuyHang, true, OfficeOpenXml.Table.TableStyles.Medium11);
                var tbl3 = ws3.Tables[0];

                // Äá»‹nh dáº¡ng cá»™t ngÃ y
                var ngayHuyColRange = ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["NgayHuy"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["NgayHuy"].Position + 1];
                ngayHuyColRange.Style.Numberformat.Format = dateFormat;

                // Äá»‹nh dáº¡ng cá»™t sá»‘ lÆ°á»£ng há»§y
                ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["SoLuongHuy"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["SoLuongHuy"].Position + 1].Style.Numberformat.Format = decimalFormat;

                // Äá»‹nh dáº¡ng cá»™t giÃ¡ trá»‹ há»§y (tiá»n tá»‡)
                var giaTriHuyColRange = ws3.Cells[tbl3.Address.Start.Row + 1, tbl3.Columns["GiaTriHuy"].Position + 1, tbl3.Address.End.Row, tbl3.Columns["GiaTriHuy"].Position + 1];
                giaTriHuyColRange.Style.Numberformat.Format = currencyFormat;
                // TÃ´ mÃ u Ä‘á» cho giÃ¡ trá»‹ há»§y
                var cfRuleHuy = giaTriHuyColRange.ConditionalFormatting.AddGreaterThan();
                cfRuleHuy.Formula = "0"; // GÃ¡n giÃ¡ trá»‹ so sÃ¡nh lÃ  "0"
                cfRuleHuy.Style.Font.Color.Color = System.Drawing.Color.Red;

                ws3.Cells[ws3.Dimension.Address].AutoFitColumns();

                // --- 6. LÆ¯U FILE ---
                await package.SaveAsync();
            }
        }

        private void BtnBack_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\BapCaoTonKhoSachPreviewWindow.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\BapCaoTonKhoSachPreviewWindow.xaml
<Page x:Class="AppCafebookApi.View.common.BapCaoTonKhoSachPreviewWindow"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.common"
      mc:Ignorable="d" 
      d:DesignHeight="720" d:DesignWidth="1000"
      Title="BÃ¡o cÃ¡o Tá»“n kho SÃ¡ch"
      Background="#FFF8E1"
      FontFamily="Segoe UI"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>

        <Style TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,8"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="KpiCard" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="15"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="KpiValue" TargetType="TextBlock">
            <Setter Property="FontSize" Value="24"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>
        <Style x:Key="KpiTitle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
        </Style>
        <Style TargetType="DataGrid">
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="CanUserAddRows" Value="False"/>
            <Setter Property="CanUserDeleteRows" Value="False"/>
            <Setter Property="IsReadOnly" Value="True"/>
            <Setter Property="AutoGenerateColumns" Value="False"/>
            <Setter Property="GridLinesVisibility" Value="None"/>
        </Style>
    </Page.Resources>

    <Grid Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="White" Padding="15" Margin="10" CornerRadius="8">
            <WrapPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="TÃªn sÃ¡ch:" VerticalAlignment="Center" Margin="5"/>
                <TextBox x:Name="txtSearch" Width="200" VerticalAlignment="Center" Margin="0,0,15,0"/>

                <TextBlock Text="Thá»ƒ loáº¡i:" VerticalAlignment="Center" Margin="5"/>
                <ComboBox x:Name="cmbTheLoai" Width="150" VerticalAlignment="Center" Margin="0,0,15,0"
                          DisplayMemberPath="Ten" SelectedValuePath="Id"/>

                <TextBlock Text="TÃ¡c giáº£:" VerticalAlignment="Center" Margin="5"/>
                <ComboBox x:Name="cmbTacGia" Width="150" VerticalAlignment="Center" Margin="0,0,15,0"
                          DisplayMemberPath="Ten" SelectedValuePath="Id"/>

                <Button x:Name="btnGenerate" Content="Lá»c BÃ¡o CÃ¡o" Margin="20,0,0,0" Click="BtnGenerate_Click"/>
            </WrapPanel>
        </Border>

        <Grid Grid.Row="1" Margin="10,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblTongDauSach" Text="0" Style="{StaticResource KpiValue}" Foreground="#42A5F5"/>
                    <TextBlock Text="Tá»•ng Äáº§u SÃ¡ch" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="1" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblTongSoLuong" Text="0" Style="{StaticResource KpiValue}" Foreground="#6F4E37"/>
                    <TextBlock Text="Tá»•ng Sá»‘ LÆ°á»£ng SÃ¡ch" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="2" Style="{StaticResource KpiCard}" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock x:Name="lblDangChoThue" Text="0" Style="{StaticResource KpiValue}" Foreground="#EF5350"/>
                    <TextBlock Text="Äang Cho ThuÃª" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
            <Border Grid.Column="3" Style="{StaticResource KpiCard}" Margin="0">
                <StackPanel>
                    <TextBlock x:Name="lblSanSang" Text="0" Style="{StaticResource KpiValue}" Foreground="#66BB6A"/>
                    <TextBlock Text="Sáºµn SÃ ng" Style="{StaticResource KpiTitle}"/>
                </StackPanel>
            </Border>
        </Grid>

        <TabControl x:Name="MainTabControl" Grid.Row="2" Margin="10">
            <TabItem Header="BÃ¡o cÃ¡o Tá»“n kho Chi tiáº¿t">
                <DataGrid x:Name="dgInventoryDetails">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="TÃªn SÃ¡ch" Binding="{Binding TenSach}" Width="*"/>
                        <DataGridTextColumn Header="TÃ¡c Giáº£" Binding="{Binding TenTacGia}" Width="150"/>
                        <DataGridTextColumn Header="Thá»ƒ Loáº¡i" Binding="{Binding TenTheLoai}" Width="150"/>
                        <DataGridTextColumn Header="Tá»•ng SL" Binding="{Binding SoLuongTong}" Width="80"/>
                        <DataGridTextColumn Header="Äang ThuÃª" Binding="{Binding SoLuongDangMuon}" Width="80"/>
                        <DataGridTextColumn Header="CÃ²n Láº¡i" Binding="{Binding SoLuongConLai}" Width="80"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="SÃ¡ch Äang ThuÃª &amp; Trá»… Háº¡n">
                <DataGrid x:Name="dgRentedOverdue">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="TÃªn SÃ¡ch" Binding="{Binding TenSach}" Width="*"/>
                        <DataGridTextColumn Header="KhÃ¡ch HÃ ng" Binding="{Binding HoTen}" Width="150"/>
                        <DataGridTextColumn Header="SÄT KhÃ¡ch" Binding="{Binding SoDienThoai}" Width="120"/>
                        <DataGridTextColumn Header="NgÃ y ThuÃª" Binding="{Binding NgayThue, StringFormat='dd/MM/yyyy'}" Width="120"/>
                        <DataGridTextColumn Header="NgÃ y Háº¹n Tráº£" Binding="{Binding NgayHenTra, StringFormat='dd/MM/yyyy'}" Width="120"/>
                        <DataGridTextColumn Header="TÃ¬nh Tráº¡ng" Binding="{Binding TinhTrang}" Width="120"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <TabItem Header="Top SÃ¡ch ÄÆ°á»£c ThuÃª Nhiá»u Nháº¥t">
                <DataGrid x:Name="dgTopRented">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="TÃªn SÃ¡ch" Binding="{Binding TenSach}" Width="*"/>
                        <DataGridTextColumn Header="TÃ¡c Giáº£" Binding="{Binding TenTacGia}" Width="200"/>
                        <DataGridTextColumn Header="Tá»•ng LÆ°á»£t ThuÃª" Binding="{Binding TongLuotThue}" Width="150"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
        </TabControl>

        <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="25">
            <Button x:Name="btnBack" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" 
                    Click="BtnBack_Click">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="&lt; Quay láº¡i" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>

            <Button x:Name="btnExportToExcel" 
                    Content="Xuáº¥t Excel" 
                    Margin="20,0,0,0" 
                    HorizontalAlignment="Right"
                    Click="BtnExportToExcel_Click" />
        </StackPanel>

        <Border x:Name="LoadingOverlay" Grid.Row="1" Grid.RowSpan="3" Background="#80FFFFFF" Visibility="Collapsed">
            <TextBlock Text="Äang táº¡o bÃ¡o cÃ¡o..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\BapCaoTonKhoSachPreviewWindow.xaml.cs
using CafebookModel.Model.ModelApp;
using Microsoft.Win32;
// using Newtonsoft.Json.Linq; // KhÃ´ng cáº§n using nÃ y
using OfficeOpenXml;
using OfficeOpenXml.Style;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;

// --- Sá»¬A Lá»–I CS0246: THÃŠM 2 USING NÃ€Y ---
using System.Text.Json;
using System.Text.Json.Serialization;
// --- Káº¾T THÃšC Sá»¬A Lá»–I ---

namespace AppCafebookApi.View.common
{
    public partial class BapCaoTonKhoSachPreviewWindow : Page
    {
        private static readonly HttpClient httpClient;
        private BaoCaoSachTongHopDto? currentReportData;

        static BapCaoTonKhoSachPreviewWindow()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public BapCaoTonKhoSachPreviewWindow()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadFiltersAsync();
            await GenerateReportAsync();
        }

        private async Task LoadFiltersAsync()
        {
            try
            {
                var response = await httpClient.GetFromJsonAsync<JsonElement?>("api/app/baocaosach/filters");

                // Sá»¬A Lá»–I CS0019: DÃ¹ng .HasValue Ä‘á»ƒ kiá»ƒm tra null
                if (!response.HasValue)
                {
                    MessageBox.Show("KhÃ´ng nháº­n Ä‘Æ°á»£c dá»¯ liá»‡u lá»c.", "Lá»—i API");
                    return;
                }

                // Chuyá»ƒn Ä‘á»•i an toÃ n
                var theLoais = response.Value.GetProperty("theLoais").Deserialize<List<FilterLookupDto>>() ?? new List<FilterLookupDto>();
                theLoais.Insert(0, new FilterLookupDto { Id = 0, Ten = "Táº¥t cáº£ Thá»ƒ loáº¡i" });
                cmbTheLoai.ItemsSource = theLoais;
                cmbTheLoai.SelectedValue = 0;

                var tacGias = response.Value.GetProperty("tacGias").Deserialize<List<FilterLookupDto>>() ?? new List<FilterLookupDto>();
                tacGias.Insert(0, new FilterLookupDto { Id = 0, Ten = "Táº¥t cáº£ TÃ¡c giáº£" });
                cmbTacGia.ItemsSource = tacGias;
                cmbTacGia.SelectedValue = 0;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"KhÃ´ng thá»ƒ táº£i bá»™ lá»c: {ex.Message}", "Lá»—i API");
            }
        }

        private async void BtnGenerate_Click(object sender, RoutedEventArgs e)
        {
            await GenerateReportAsync();
        }

        private async Task GenerateReportAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            btnGenerate.IsEnabled = false;

            var request = new BaoCaoSachRequestDto
            {
                SearchText = string.IsNullOrEmpty(txtSearch.Text) ? null : txtSearch.Text,
                TheLoaiId = (int)cmbTheLoai.SelectedValue == 0 ? (int?)null : (int)cmbTheLoai.SelectedValue,
                TacGiaId = (int)cmbTacGia.SelectedValue == 0 ? (int?)null : (int)cmbTacGia.SelectedValue
            };

            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/baocaosach/report", request);
                if (response.IsSuccessStatusCode)
                {
                    currentReportData = await response.Content.ReadFromJsonAsync<BaoCaoSachTongHopDto>();
                    if (currentReportData != null)
                    {
                        PopulateUi(currentReportData);
                    }
                }
                else
                {
                    MessageBox.Show($"Lá»—i API: {response.ReasonPhrase}", "Lá»—i");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"KhÃ´ng thá»ƒ káº¿t ná»‘i API: {ex.Message}", "Lá»—i");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
                btnGenerate.IsEnabled = true;
            }
        }

        private void PopulateUi(BaoCaoSachTongHopDto data)
        {
            lblTongDauSach.Text = data.Kpi.TongDauSach.ToString();
            lblTongSoLuong.Text = data.Kpi.TongSoLuong.ToString();
            lblDangChoThue.Text = data.Kpi.DangChoThue.ToString();
            lblSanSang.Text = data.Kpi.SanSang.ToString();

            dgInventoryDetails.ItemsSource = data.ChiTietTonKho;
            dgRentedOverdue.ItemsSource = data.SachTreHan;
            dgTopRented.ItemsSource = data.TopSachThue;
        }

        private async void BtnExportToExcel_Click(object sender, RoutedEventArgs e)
        {
            if (currentReportData == null)
            {
                MessageBox.Show("ChÆ°a cÃ³ dá»¯ liá»‡u bÃ¡o cÃ¡o Ä‘á»ƒ xuáº¥t. Vui lÃ²ng nháº¥n 'Lá»c BÃ¡o CÃ¡o' trÆ°á»›c.", "ChÆ°a cÃ³ dá»¯ liá»‡u");
                return;
            }

            var sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                FileName = $"BaoCaoTonKhoSach_{DateTime.Now:yyyyMMdd_HHmm}.xlsx"
            };

            if (sfd.ShowDialog() == true)
            {
                try
                {
                    LoadingOverlay.Visibility = Visibility.Visible;
                    await CreateExcelReportAsync(sfd.FileName, currentReportData);
                    LoadingOverlay.Visibility = Visibility.Collapsed;

                    MessageBox.Show($"ÄÃ£ xuáº¥t bÃ¡o cÃ¡o thÃ nh cÃ´ng!\n\nÄÆ°á»ng dáº«n: {sfd.FileName}", "ThÃ nh cÃ´ng", MessageBoxButton.OK, MessageBoxImage.Information);
                }
                catch (Exception ex)
                {
                    LoadingOverlay.Visibility = Visibility.Collapsed;
                    MessageBox.Show($"CÃ³ lá»—i khi xuáº¥t Excel: {ex.Message}\n\nÄáº£m báº£o báº¡n Ä‘Ã£ Ä‘Ã³ng file Excel (náº¿u nÃ³ Ä‘ang má»Ÿ).", "Lá»—i Xuáº¥t File", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        // DÃ¡n Ä‘Ã¨ lÃªn hÃ m CreateExcelReportAsync CÅ¨ cá»§a báº¡n
        private async Task CreateExcelReportAsync(string filePath, BaoCaoSachTongHopDto data)
        {
            // Giáº¥y phÃ©p EPPlus
            ExcelPackage.License.SetNonCommercialPersonal("CafeBook");
            var fileInfo = new FileInfo(filePath);

            // XÃ³a file cÅ© náº¿u tá»“n táº¡i Ä‘á»ƒ trÃ¡nh lá»—i
            if (fileInfo.Exists)
            {
                fileInfo.Delete();
            }

            using (var package = new ExcelPackage(fileInfo))
            {
                // --- TÃ™Y CHá»ˆNH STYLE ---
                // Äá»‹nh nghÄ©a má»™t style chung cho tiÃªu Ä‘á»
                Action<ExcelRange> styleTitle = (range) =>
                {
                    range.Style.Font.Bold = true;
                    range.Style.Font.Size = 14;
                    range.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    range.Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                    range.Style.Fill.PatternType = ExcelFillStyle.Solid;
                    range.Style.Fill.BackgroundColor.SetColor(System.Drawing.ColorTranslator.FromHtml("#4F81BD")); // MÃ u xanh Ä‘áº­m
                    range.Style.Font.Color.SetColor(System.Drawing.Color.White);
                };

                // --- Sheet 1: Tá»”NG QUAN (Sheet má»›i) ---
                var wsTongQuan = package.Workbook.Worksheets.Add("Tá»•ng Quan");
                wsTongQuan.Cells["A1:D1"].Merge = true;
                wsTongQuan.Cells["A1"].Value = "BÃO CÃO Tá»”NG QUAN - CAFEBOOK";
                styleTitle(wsTongQuan.Cells["A1:D1"]);

                wsTongQuan.Cells["A3"].Value = "BÃ¡o cÃ¡o Ä‘Æ°á»£c táº¡o lÃºc:";
                wsTongQuan.Cells["B3"].Value = DateTime.Now;
                wsTongQuan.Cells["B3"].Style.Numberformat.Format = "dd/MM/yyyy HH:mm:ss";
                wsTongQuan.Cells["A3:B3"].Style.Font.Bold = true;

                // ThÃªm dá»¯ liá»‡u KPI
                wsTongQuan.Cells["A5"].Value = "Chá»‰ sá»‘";
                wsTongQuan.Cells["B5"].Value = "Sá»‘ lÆ°á»£ng";
                wsTongQuan.Cells["A5:B5"].Style.Font.Bold = true;
                wsTongQuan.Cells["A5:B5"].Style.Fill.PatternType = ExcelFillStyle.Solid;
                wsTongQuan.Cells["A5:B5"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);

                wsTongQuan.Cells["A6"].Value = "Tá»•ng Ä‘áº§u sÃ¡ch";
                wsTongQuan.Cells["B6"].Value = data.Kpi.TongDauSach;

                wsTongQuan.Cells["A7"].Value = "Tá»•ng sá»‘ lÆ°á»£ng (cuá»‘n)";
                wsTongQuan.Cells["B7"].Value = data.Kpi.TongSoLuong;

                wsTongQuan.Cells["A8"].Value = "Äang cho thuÃª";
                wsTongQuan.Cells["B8"].Value = data.Kpi.DangChoThue;

                wsTongQuan.Cells["A9"].Value = "Sáºµn sÃ ng cho thuÃª";
                wsTongQuan.Cells["B9"].Value = data.Kpi.SanSang;

                // Káº» viá»n cho báº£ng KPI
                var kpiRange = wsTongQuan.Cells["A5:B9"];
                kpiRange.Style.Border.Top.Style = ExcelBorderStyle.Thin;
                kpiRange.Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                kpiRange.Style.Border.Left.Style = ExcelBorderStyle.Thin;
                kpiRange.Style.Border.Right.Style = ExcelBorderStyle.Thin;

                wsTongQuan.Cells[wsTongQuan.Dimension.Address].AutoFitColumns();


                // --- Sheet 2: Tá»“n Kho Chi Tiáº¿t ---
                var ws1 = package.Workbook.Worksheets.Add("Chi Tiáº¿t Tá»“n Kho");
                ws1.Cells["A1:F1"].Merge = true;
                ws1.Cells["A1"].Value = "BÃ¡o cÃ¡o Tá»“n kho Chi tiáº¿t";
                styleTitle(ws1.Cells["A1:F1"]);

                // Load dá»¯ liá»‡u tá»« Collection vÃ  Ã¡p dá»¥ng Style Báº£ng chuyÃªn nghiá»‡p
                // "true" = in ra tÃªn cá»™t (headers)
                ws1.Cells["A3"].LoadFromCollection(data.ChiTietTonKho, true, OfficeOpenXml.Table.TableStyles.Medium9);
                ws1.Cells[ws1.Dimension.Address].AutoFitColumns();


                // --- Sheet 3: SÃ¡ch Äang ThuÃª & Trá»… Háº¡n ---
                var ws2 = package.Workbook.Worksheets.Add("SÃ¡ch Trá»… Háº¡n");
                ws2.Cells["A1:F1"].Merge = true;
                ws2.Cells["A1"].Value = "BÃ¡o cÃ¡o SÃ¡ch Äang ThuÃª & Trá»… Háº¡n";
                styleTitle(ws2.Cells["A1:F1"]);

                ws2.Cells["A3"].LoadFromCollection(data.SachTreHan, true, OfficeOpenXml.Table.TableStyles.Medium10);

                // Cáº§n Ä‘á»‹nh dáº¡ng láº¡i cá»™t ngÃ y thÃ¡ng sau khi load
                // +3 lÃ  vÃ¬ báº¯t Ä‘áº§u tá»« A3 (1 title, 1 header, 1 data row)
                int rowCountSheet2 = data.SachTreHan.Count + 3;
                ws2.Cells[$"D4:E{rowCountSheet2}"].Style.Numberformat.Format = "dd/MM/yyyy HH:mm";
                ws2.Cells[ws2.Dimension.Address].AutoFitColumns();


                // --- Sheet 4: Top SÃ¡ch ThuÃª ---
                var ws3 = package.Workbook.Worksheets.Add("Top SÃ¡ch ThuÃª");
                ws3.Cells["A1:C1"].Merge = true;
                ws3.Cells["A1"].Value = "Top SÃ¡ch ÄÆ°á»£c ThuÃª Nhiá»u Nháº¥t";
                styleTitle(ws3.Cells["A1:C1"]);

                ws3.Cells["A3"].LoadFromCollection(data.TopSachThue, true, OfficeOpenXml.Table.TableStyles.Medium11);
                ws3.Cells[ws3.Dimension.Address].AutoFitColumns();

                // LÆ°u file
                await package.SaveAsync();
            }
        }

        private void BtnBack_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\CaiDatWindow.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\CaiDatWindow.xaml
<Page x:Class="AppCafebookApi.View.common.CaiDatWindow"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:local="clr-namespace:AppCafebookApi.View.common"
      mc:Ignorable="d"
      d:DesignHeight="700" d:DesignWidth="900"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <Style TargetType="GroupItem">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="GroupItem">
                        <StackPanel>
                            <TextBlock Text="{Binding Name}" 
                                       FontSize="16" FontWeight="Bold" 
                                       Foreground="{StaticResource PrimaryBrownBrush}" 
                                       Margin="5,15,0,5" />
                            <ItemsPresenter />
                        </StackPanel>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="SettingTextBox" TargetType="Grid">
            <Setter Property="Margin" Value="0,2,0,10"/>
        </Style>

        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style x:Key="PlaceholderTextBlock" TargetType="TextBlock">
            <Setter Property="Foreground" Value="#AAAAAA"/>
            <Setter Property="IsHitTestVisible" Value="False"/>
            <Setter Property="Margin" Value="5,0"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Grid.Row" Value="0"/>
        </Style>

        <Style x:Key="HelperTextBlock" TargetType="TextBlock">
            <Setter Property="Foreground" Value="#757575"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="TextWrapping" Value="Wrap"/>
            <Setter Property="Grid.Row" Value="1" />
            <Setter Property="Margin" Value="2,2,0,0"/>
        </Style>

        <Style x:Key="SaveButton" TargetType="Button">
            <Setter Property="Background" Value="#66BB6A"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Content" Value="LÆ°u"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>

        <Style TargetType="TextBox">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>

    </Page.Resources>

    <Grid Margin="20" Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Text="CÃ i Ä‘áº·t ThÃ´ng tin QuÃ¡n &amp; Há»‡ thá»‘ng" FontSize="20" FontWeight="Bold" Foreground="#4E342E" Margin="0,0,0,15"/>

        <ListView x:Name="lvSettings" Grid.Row="1" Background="White" BorderThickness="1" BorderBrush="#E0E0E0">

            <ListView.GroupStyle>
                <GroupStyle HidesIfEmpty="True"/>
            </ListView.GroupStyle>

            <ListView.View>
                <GridView>
                    <GridViewColumn Header="GiÃ¡ trá»‹" Width="550">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <Grid Style="{StaticResource SettingTextBox}">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <TextBox x:Name="txtValue" 
                                             Text="{Binding GiaTri, UpdateSourceTrigger=PropertyChanged}" 
                                             Padding="5" 
                                             BorderThickness="1" 
                                             BorderBrush="#BDBDBD"
                                             TextWrapping="Wrap" AcceptsReturn="True"
                                             MinHeight="30" MaxHeight="100" Grid.Row="0"/>

                                    <TextBlock Text="{Binding MoTa}">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock" BasedOn="{StaticResource PlaceholderTextBlock}">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Text, ElementName=txtValue}" Value="">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>

                                    <TextBlock Text="{Binding MoTa}">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock" BasedOn="{StaticResource HelperTextBlock}">
                                                <Setter Property="Visibility" Value="Visible"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Text, ElementName=txtValue}" Value="">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </Grid>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>

                    <GridViewColumn Header="HÃ nh Ä‘á»™ng" Width="100">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <Button Content="LÆ°u" 
                                        Style="{StaticResource SaveButton}"
                                        Click="BtnSaveRow_Click"
                                        Tag="{Binding}"/>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                    <GridViewColumn Header="TÃªn CÃ i Äáº·t (áº¨n)" Width="0" DisplayMemberBinding="{Binding TenCaiDat}"/>
                </GridView>
            </ListView.View>
        </ListView>

        <Border x:Name="LoadingOverlay" Grid.Row="1" Background="#80FFFFFF" Visibility="Collapsed">
            <TextBlock Text="Äang táº£i dá»¯ liá»‡u..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="16" FontWeight="SemiBold" Foreground="#4E342E"/>
        </Border>

        <StackPanel Grid.Row="2" Margin="0,15,0,0">
            <Border x:Name="NotificationBorder" Background="{StaticResource SuccessBrush}" 
                    CornerRadius="4" Padding="15,10" Margin="0,0,0,10"
                    Visibility="Collapsed">
                <Border.Effect>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.1" BlurRadius="10"/>
                </Border.Effect>
                <TextBlock x:Name="NotificationText" Text="LÆ°u thÃ nh cÃ´ng!" 
                           Foreground="White" FontWeight="SemiBold"
                           HorizontalAlignment="Center" VerticalAlignment="Center"/>
            </Border>
            <Button x:Name="btnBack" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" 
                    Click="BtnBack_Click">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="&lt; Quay láº¡i" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </StackPanel>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\CaiDatWindow.xaml.cs
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Data;
using System.Windows.Controls;
using CafebookModel.Model.ModelApp;
using System.Windows.Threading;
using System.Windows.Media;

namespace AppCafebookApi.View.common
{
    // Lá»›p ná»™i bá»™ Ä‘á»ƒ há»— trá»£ grouping
    public class CaiDatViewItem : CaiDatDto
    {
        public string Nhom { get; set; } = "CÃ i Äáº·t KhÃ¡c";
    }

    public partial class CaiDatWindow : Page
    {
        private static readonly HttpClient httpClient;
        private ObservableCollection<CaiDatViewItem> settingsList = new ObservableCollection<CaiDatViewItem>();
        private DispatcherTimer notificationTimer;

        static CaiDatWindow()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public CaiDatWindow()
        {
            InitializeComponent();
            notificationTimer = new DispatcherTimer
            {
                Interval = TimeSpan.FromSeconds(3)
            };
            notificationTimer.Tick += NotificationTimer_Tick;
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.GetFromJsonAsync<List<CaiDatDto>>("api/app/caidat/all");

                if (response != null)
                {
                    // 1. CHUYá»‚N DTO THÃ€NH VIEWITEM VÃ€ PHÃ‚N NHÃ“M
                    var viewItems = response
                        .OrderBy(s => GetNhomOrder(s.TenCaiDat)) // Sáº¯p xáº¿p theo thá»© tá»± logic
                        .ThenBy(s => s.TenCaiDat) // Sáº¯p xáº¿p theo tÃªn
                        .Select(dto => new CaiDatViewItem
                        {
                            TenCaiDat = dto.TenCaiDat,
                            GiaTri = dto.GiaTri,
                            MoTa = dto.MoTa,
                            Nhom = GetNhom(dto.TenCaiDat) // HÃ m phÃ¢n nhÃ³m
                        });

                    settingsList = new ObservableCollection<CaiDatViewItem>(viewItems);

                    // 2. Táº O COLLECTIONVIEW Äá»‚ GROUPING
                    var cvs = new CollectionViewSource();
                    cvs.Source = settingsList;
                    cvs.GroupDescriptions.Add(new PropertyGroupDescription("Nhom"));

                    lvSettings.ItemsSource = cvs.View;
                }
            }
            catch (Exception ex)
            {
                ShowNotification($"KhÃ´ng thá»ƒ táº£i cÃ i Ä‘áº·t: {ex.Message}", isError: true);
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        /// <summary>
        /// Cáº¬P NHáº¬T: HÃ m helper Ä‘á»ƒ phÃ¢n loáº¡i cÃ i Ä‘áº·t theo nhÃ³m
        /// </summary>
        private string GetNhom(string tenCaiDat)
        {
            if (tenCaiDat == "TenQuan" || tenCaiDat == "DiaChi" || tenCaiDat == "SoDienThoai" || tenCaiDat == "Wifi_MatKhau")
            {
                return "1. ThÃ´ng tin Chung (In HÃ³a Ä‘Æ¡n)";
            }
            if (tenCaiDat == "GioiThieu" || tenCaiDat == "LienHe_GioMoCua")
            {
                return "2. CÃ i Ä‘áº·t ThÃ´ng Tin QuÃ¡n (Web)";
            }
            if (tenCaiDat.StartsWith("LienHe_") && tenCaiDat != "LienHe_GioMoCua")
            {
                return "3. CÃ i Äáº·t Máº¡ng XÃ£ Há»™i (Web)";
            }
            if (tenCaiDat.StartsWith("Sach_"))
            {
                return "4. CÃ i Ä‘áº·t ThuÃª SÃ¡ch";
            }
            if (tenCaiDat.StartsWith("DiemTichLuy_"))
            {
                return "5. CÃ i Ä‘áº·t Äiá»ƒm TÃ­ch LÅ©y";
            }
            if (tenCaiDat.StartsWith("AI_Chat_"))
            {
                return "6. CÃ i Ä‘áº·t AI (NÃ¢ng cao)";
            }
            return "7. CÃ i Äáº·t KhÃ¡c";
        }

        // Cáº¬P NHáº¬T: HÃ m helper Ä‘á»ƒ sáº¯p xáº¿p nhÃ³m theo thá»© tá»±
        private int GetNhomOrder(string tenCaiDat)
        {
            if (tenCaiDat == "TenQuan" || tenCaiDat == "DiaChi" || tenCaiDat == "SoDienThoai" || tenCaiDat == "Wifi_MatKhau") return 1;
            if (tenCaiDat == "GioiThieu" || tenCaiDat == "LienHe_GioMoCua") return 2;
            if (tenCaiDat.StartsWith("LienHe_") && tenCaiDat != "LienHe_GioMoCua") return 3;
            if (tenCaiDat.StartsWith("Sach_")) return 4;
            if (tenCaiDat.StartsWith("DiemTichLuy_")) return 5;
            if (tenCaiDat.StartsWith("AI_Chat_")) return 6;
            return 7;
        }

        // (CÃ¡c hÃ m BtnSaveRow_Click, ShowNotification, NotificationTimer_Tick, BtnBack_Click giá»¯ nguyÃªn)

        private async void BtnSaveRow_Click(object sender, RoutedEventArgs e)
        {
            var button = sender as Button;
            if (button == null) return;

            var itemToSave = button.Tag as CaiDatViewItem;
            if (itemToSave == null) return;

            button.IsEnabled = false;
            button.Content = "Äang lÆ°u...";

            try
            {
                var dto = new CaiDatDto
                {
                    TenCaiDat = itemToSave.TenCaiDat,
                    GiaTri = itemToSave.GiaTri,
                    MoTa = itemToSave.MoTa
                };

                var response = await httpClient.PutAsJsonAsync("api/app/caidat/update-single", dto);

                if (response.IsSuccessStatusCode)
                {
                    ShowNotification($"ÄÃ£ lÆ°u '{itemToSave.MoTa}' thÃ nh cÃ´ng!");
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    ShowNotification($"Lá»—i khi lÆ°u: {error}", isError: true);
                }
            }
            catch (Exception ex)
            {
                ShowNotification($"KhÃ´ng thá»ƒ lÆ°u: {ex.Message}", isError: true);
            }
            finally
            {
                button.IsEnabled = true;
                button.Content = "LÆ°u";
            }
        }

        private void ShowNotification(string message, bool isError = false)
        {
            notificationTimer.Stop();
            NotificationText.Text = message;
            if (isError)
            {
                NotificationBorder.Background = (SolidColorBrush)FindResource("ErrorBrush");
            }
            else
            {
                NotificationBorder.Background = (SolidColorBrush)FindResource("SuccessBrush");
            }
            NotificationBorder.Visibility = Visibility.Visible;
            notificationTimer.Start();
        }

        private void NotificationTimer_Tick(object? sender, EventArgs e)
        {
            notificationTimer.Stop();
            NotificationBorder.Visibility = Visibility.Collapsed;
        }

        private void BtnBack_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\ChonKhuyenMaiWindow.xaml e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\ChonKhuyenMaiWindow.xaml.cs
<Window x:Class="AppCafebookApi.View.common.ChonKhuyenMaiWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AppCafebookApi.View.common"
        mc:Ignorable="d"
        Title="Chá»n Khuyáº¿n MÃ£i Ãp Dá»¥ng" 
        Height="600" Width="450"
        WindowStartupLocation="CenterScreen"
        WindowStyle="ToolWindow"
        FontFamily="Segoe UI"
        Loaded="Window_Loaded"
        Background="#FFF8E1">

    <Window.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="StatusRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="StatusGreenBrush" Color="#66BB6A"/>

        <Style x:Key="KhuyenMaiItemStyle" TargetType="ListBoxItem">
            <Setter Property="Padding" Value="15,10"/>
            <Setter Property="Margin" Value="0,0,0,5"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderThickness" Value="3,0,0,0"/>
            <Setter Property="BorderBrush" Value="{StaticResource AccentOrangeBrush}"/>

            <Style.Triggers>
                <DataTrigger Binding="{Binding IsEligible}" Value="False">
                    <Setter Property="IsEnabled" Value="False"/>
                    <Setter Property="BorderBrush" Value="#BDBDBD"/>
                    <Setter Property="Opacity" Value="0.6"/>
                </DataTrigger>
                <Trigger Property="IsSelected" Value="true">
                    <Setter Property="Background" Value="#FFF1DE"/>
                    <Setter Property="BorderBrush" Value="#D27D2D"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="ActionButton" TargetType="Button">
            <Setter Property="Padding" Value="15"/>
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBox x:Name="txtSearch" 
                 FontSize="14" 
                 Padding="10" Margin="10" 
                 TextChanged="TxtSearch_TextChanged"
                 Text="Nháº­p mÃ£ hoáº·c tÃªn KM..."/>

        <ListBox Grid.Row="1" x:Name="lvKhuyenMai" 
                 HorizontalContentAlignment="Stretch"
                 SelectionMode="Single"
                 SelectedValuePath="IdKhuyenMai"
                 ItemContainerStyle="{StaticResource KhuyenMaiItemStyle}"
                 Background="Transparent" BorderThickness="0">
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="{Binding TenChuongTrinh}" 
                                       FontSize="16" FontWeight="Bold" 
                                       Foreground="{StaticResource DarkBrownBrush}"/>
                            <TextBlock Text="{Binding MaKhuyenMai, StringFormat=' ({0})'}" 
                                       FontSize="14" FontStyle="Italic" VerticalAlignment="Bottom"
                                       Margin="5,0,0,0"
                                       Foreground="{StaticResource AccentOrangeBrush}"/>
                        </StackPanel>

                        <TextBlock Grid.Row="1" Text="{Binding DieuKienApDung}" 
                                   TextWrapping="Wrap" 
                                   FontSize="13"
                                   Foreground="{StaticResource TextGrayBrush}"/>

                        <TextBlock Grid.Row="2" Text="{Binding IneligibilityReason}" 
                                   TextWrapping="Wrap" 
                                   FontSize="13" FontWeight="SemiBold"
                                   Margin="0,5,0,0"
                                   Foreground="{StaticResource StatusRedBrush}">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsEligible}" Value="False">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>

                        <Border CornerRadius="0,5,0,5" 
                                Background="{StaticResource StatusGreenBrush}" 
                                HorizontalAlignment="Right" 
                                VerticalAlignment="Top"
                                Margin="0,-10,-15,0"
                                Padding="8,3">
                            <TextBlock Text="CÃ³ thá»ƒ Ã¡p dá»¥ng" Foreground="White" FontSize="10" FontWeight="Bold"/>
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsEligible}" Value="True">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                        </Border>

                    </Grid>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <Border Grid.Row="2" Background="White" Padding="10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Button x:Name="btnHuy" Content="Há»§y" 
                        Click="BtnHuy_Click" 
                        Style="{StaticResource ActionButton}" 
                        Background="{StaticResource TextGrayBrush}" 
                        Margin="0,0,5,0"/>
                <Button x:Name="btnApDung" Grid.Column="1" Content="Ãp Dá»¥ng" 
                        Click="BtnApDung_Click" 
                        Style="{StaticResource ActionButton}" 
                        Background="{StaticResource PrimaryBrownBrush}" 
                        Margin="5,0,0,0"/>
            </Grid>
        </Border>
    </Grid>
</Window>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\ChonKhuyenMaiWindow.xaml.cs
using CafebookModel.Model.ModelApp.NhanVien;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;

namespace AppCafebookApi.View.common
{
    public partial class ChonKhuyenMaiWindow : Window
    {
        private readonly int _idHoaDon;
        private readonly int? _currentSelectedId;
        private static readonly HttpClient _httpClient;
        private List<KhuyenMaiHienThiDto> _allKms = new List<KhuyenMaiHienThiDto>();

        public int? SelectedId { get; private set; }

        static ChonKhuyenMaiWindow()
        {
            _httpClient = new HttpClient { BaseAddress = new Uri("http://localhost:5166") };
        }

        public ChonKhuyenMaiWindow(int idHoaDon, int? currentSelectedId)
        {
            InitializeComponent();
            _idHoaDon = idHoaDon;
            _currentSelectedId = currentSelectedId;
        }

        private async void Window_Loaded(object sender, RoutedEventArgs e)
        {
            this.IsEnabled = false;
            try
            {
                var response = await _httpClient.GetAsync($"api/app/nhanvien/khuyenmai/available/{_idHoaDon}");

                if (response.IsSuccessStatusCode)
                {
                    _allKms = await response.Content.ReadFromJsonAsync<List<KhuyenMaiHienThiDto>>() ?? new List<KhuyenMaiHienThiDto>();

                    // Sá»¬A Lá»–I: GÃ¡n giÃ¡ trá»‹ MaKhuyenMai Ä‘á»ƒ trÃ¡nh NullReference
                    _allKms.Insert(0, new KhuyenMaiHienThiDto
                    {
                        IdKhuyenMai = 0,
                        TenChuongTrinh = "-- KhÃ´ng Ã¡p dá»¥ng --",
                        MaKhuyenMai = "", // <-- THÃŠM DÃ’NG NÃ€Y
                        DieuKienApDung = "Chá»n má»¥c nÃ y Ä‘á»ƒ gá»¡ bá» khuyáº¿n mÃ£i hiá»‡n táº¡i.",
                        IsEligible = true
                    });

                    lvKhuyenMai.ItemsSource = _allKms;

                    if (_currentSelectedId.HasValue)
                    {
                        lvKhuyenMai.SelectedValue = _currentSelectedId.Value;
                    }
                    else
                    {
                        lvKhuyenMai.SelectedValue = 0;
                    }
                }
                else
                {
                    MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lá»—i táº£i Khuyáº¿n mÃ£i");
                    this.Close();
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message, "Lá»—i API");
                this.Close();
            }
            this.IsEnabled = true;
        }

        private void TxtSearch_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (lvKhuyenMai == null || _allKms == null)
            {
                return;
            }

            string filter = txtSearch.Text.ToLower().Trim();
            if (string.IsNullOrEmpty(filter) || filter == "nháº­p mÃ£ hoáº·c tÃªn km...")
            {
                lvKhuyenMai.ItemsSource = _allKms;
                return;
            }

            // Sá»¬A Lá»–I: ThÃªm kiá»ƒm tra null cho MaKhuyenMai (máº·c dÃ¹ Ä‘Ã£ fix á»Ÿ trÃªn)
            var filteredList = _allKms.Where(k =>
                k.TenChuongTrinh.ToLower().Contains(filter) ||
                (k.MaKhuyenMai ?? "").ToLower().Contains(filter) || // <-- Sá»¬A DÃ’NG NÃ€Y
                k.IdKhuyenMai == 0
            ).ToList();

            lvKhuyenMai.ItemsSource = filteredList;
        }

        private void BtnApDung_Click(object sender, RoutedEventArgs e)
        {
            if (lvKhuyenMai.SelectedItem == null)
            {
                MessageBox.Show("Vui lÃ²ng chá»n má»™t khuyáº¿n mÃ£i.", "ChÆ°a chá»n");
                return;
            }

            var selectedKm = (KhuyenMaiHienThiDto)lvKhuyenMai.SelectedItem;

            // Kiá»ƒm tra IsEligible Ä‘Ã£ Ä‘Æ°á»£c style loáº¡ibá», nhÆ°ng Ä‘Ã¢y lÃ  check logic cuá»‘i
            if (!selectedKm.IsEligible)
            {
                MessageBox.Show($"KhÃ´ng thá»ƒ Ã¡p dá»¥ng khuyáº¿n mÃ£i nÃ y.\nLÃ½ do: {selectedKm.IneligibilityReason}", "KhÃ´ng Ä‘á»§ Ä‘iá»u kiá»‡n", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            this.SelectedId = selectedKm.IdKhuyenMai;
            this.DialogResult = true;
            this.Close();
        }

        private void BtnHuy_Click(object sender, RoutedEventArgs e)
        {
            this.DialogResult = false;
            this.Close();
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\HoaDonPreviewWindow.xaml e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\HoaDonPreviewWindow.xaml.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp.NhanVien;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App.NhanVien
{
    [Route("api/app/nhanvien/thanhtoan")]
    [ApiController]
    public class ThanhToanController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private decimal _tiLeDoiDiem = 1000m;
        private decimal _tiLeNhanDiem = 10000m;
        private Dictionary<string, string> _settings = new Dictionary<string, string>();

        public ThanhToanController(CafebookDbContext context)
        {
            _context = context;
        }

        // HÃ m helper táº£i cÃ i Ä‘áº·t
        private async Task LoadCaiDat()
        {
            _settings = await _context.CaiDats
                .Where(c =>
                    c.TenCaiDat == "DiemTichLuy_DoiVND" ||
                    c.TenCaiDat == "DiemTichLuy_NhanVND" ||
                    c.TenCaiDat == "TenQuan" ||
                    c.TenCaiDat == "DiaChi" ||
                    c.TenCaiDat == "SoDienThoai" ||
                    c.TenCaiDat == "Wifi_MatKhau")
                .AsNoTracking()
                .ToDictionaryAsync(c => c.TenCaiDat, c => c.GiaTri);

            decimal.TryParse(_settings.GetValueOrDefault("DiemTichLuy_DoiVND", "1000"), out _tiLeDoiDiem);
            decimal.TryParse(_settings.GetValueOrDefault("DiemTichLuy_NhanVND", "10000"), out _tiLeNhanDiem);
            if (_tiLeNhanDiem == 0) _tiLeNhanDiem = 10000;
            if (_tiLeDoiDiem == 0) _tiLeDoiDiem = 1000;
        }

        /// <summary>
        /// Táº£i dá»¯ liá»‡u cho mÃ n hÃ¬nh ThanhToanView
        /// </summary>
        [HttpGet("load/{idHoaDon}")]
        public async Task<IActionResult> LoadThanhToanData(int idHoaDon)
        {
            await LoadCaiDat(); // Táº£i cÃ i Ä‘áº·t

            var hoaDon = await _context.HoaDons
                .Include(h => h.Ban)
                .AsNoTracking()
                .FirstOrDefaultAsync(h => h.IdHoaDon == idHoaDon);

            if (hoaDon == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y hÃ³a Ä‘Æ¡n.");

            var hoaDonInfo = new HoaDonInfoDto
            {
                IdHoaDon = hoaDon.IdHoaDon,
                SoBan = hoaDon.Ban?.SoBan ?? hoaDon.LoaiHoaDon,
                LoaiHoaDon = hoaDon.LoaiHoaDon,
                TongTienGoc = hoaDon.TongTienGoc,
                GiamGia = hoaDon.GiamGia,
                ThanhTien = hoaDon.ThanhTien,
            };

            var chiTietItems = await _context.ChiTietHoaDons
                .Where(c => c.IdHoaDon == idHoaDon)
                .AsNoTracking()
                .Select(c => new ChiTietDto
                {
                    IdChiTietHoaDon = c.IdChiTietHoaDon,
                    IdSanPham = c.IdSanPham,
                    TenSanPham = c.SanPham.TenSanPham,
                    SoLuong = c.SoLuong,
                    DonGia = c.DonGia,
                    ThanhTien = c.ThanhTien
                }).ToListAsync();

            var phuThusDaApDung = await _context.ChiTietPhuThuHoaDons
                .Where(pt => pt.IdHoaDon == idHoaDon)
                .AsNoTracking()
                .Select(pt => new PhuThuDto
                {
                    IdPhuThu = pt.IdPhuThu,
                    TenPhuThu = pt.PhuThu.TenPhuThu,
                    SoTien = pt.SoTien,
                    LoaiGiaTri = pt.PhuThu.LoaiGiaTri,
                    GiaTri = pt.PhuThu.GiaTri
                }).ToListAsync();

            var idPhuThuDaApDung = phuThusDaApDung.Select(p => p.IdPhuThu);
            var phuThusKhaDung = await _context.PhuThus
                .Where(p => !idPhuThuDaApDung.Contains(p.IdPhuThu))
                .AsNoTracking()
                .ToListAsync();

            var khuyenMaiLink = await _context.HoaDonKhuyenMais
                .AsNoTracking()
                .FirstOrDefaultAsync(hkm => hkm.IdHoaDon == idHoaDon);

            KhachHang? khachHang = null;
            if (hoaDon.IdKhachHang.HasValue)
            {
                khachHang = await _context.KhachHangs.AsNoTracking().FirstOrDefaultAsync(kh => kh.IdKhachHang == hoaDon.IdKhachHang.Value);
            }

            // Sá»¬A Lá»–I CS0117: Táº£i danh sÃ¡ch KH cho ComboBox
            var khachHangsList = await _context.KhachHangs
                .AsNoTracking()
                .Select(kh => new KhachHangTimKiemDto
                {
                    IdKhachHang = kh.IdKhachHang,
                    DisplayText = kh.HoTen + " - " + (kh.SoDienThoai ?? kh.Email),
                    KhachHangData = kh
                }).ToListAsync();

            return Ok(new ThanhToanViewDto
            {
                HoaDonInfo = hoaDonInfo,
                ChiTietItems = chiTietItems,
                IdKhuyenMaiDaApDung = khuyenMaiLink?.IdKhuyenMai, // Tráº£ vá» ID
                PhuThusDaApDung = phuThusDaApDung,
                PhuThusKhaDung = phuThusKhaDung,
                KhachHang = khachHang,
                KhachHangsList = khachHangsList, // Tráº£ vá» DS KhÃ¡ch hÃ ng
                DiemTichLuy_DoiVND = _tiLeDoiDiem,
                DiemTichLuy_NhanVND = _tiLeNhanDiem,

                TenQuan = _settings.GetValueOrDefault("TenQuan", "CafeBook"),
                DiaChi = _settings.GetValueOrDefault("DiaChi", "N/A"),
                SoDienThoai = _settings.GetValueOrDefault("SoDienThoai", "N/A"),
                WifiMatKhau = _settings.GetValueOrDefault("Wifi_MatKhau", "N/A")
            });
        }

        [HttpGet("find-customer")]
        public async Task<IActionResult> FindCustomer([FromQuery] string query)
        {
            if (string.IsNullOrEmpty(query)) return BadRequest();
            var khachHang = await _context.KhachHangs
                .FirstOrDefaultAsync(kh => kh.SoDienThoai == query || kh.Email == query || kh.HoTen.Contains(query));
            if (khachHang == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y khÃ¡ch hÃ ng.");
            return Ok(khachHang);
        }

        [HttpPost("pay")]
        public async Task<IActionResult> ProcessPayment([FromBody] ThanhToanRequestDto req)
        {
            await LoadCaiDat();

            var hoaDonGoc = await _context.HoaDons
                .Include(h => h.Ban)
                .Include(h => h.ChiTietHoaDons)
                .Include(h => h.ChiTietPhuThuHoaDons)
                .FirstOrDefaultAsync(h => h.IdHoaDon == req.IdHoaDonGoc);

            if (hoaDonGoc == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y hÃ³a Ä‘Æ¡n gá»‘c.");
            if (hoaDonGoc.TrangThai != "ChÆ°a thanh toÃ¡n") return Conflict("HÃ³a Ä‘Æ¡n nÃ y Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½.");

            var allItemsGocIds = hoaDonGoc.ChiTietHoaDons.Select(c => c.IdChiTietHoaDon).ToList();
            bool isFullPayment = allItemsGocIds.Count == req.IdChiTietTach.Count && allItemsGocIds.All(req.IdChiTietTach.Contains);

            HoaDon hoaDonThanhToan;

            var chiTietTach = hoaDonGoc.ChiTietHoaDons
                .Where(c => req.IdChiTietTach.Contains(c.IdChiTietHoaDon)).ToList();

            var phuThuDaApDungGoc = hoaDonGoc.ChiTietPhuThuHoaDons
                .Where(pt => req.IdPhuThuTach.Contains(pt.IdPhuThu)).ToList();
            var idPhuThuMoi = req.IdPhuThuTach.Where(id => !phuThuDaApDungGoc.Any(pt => pt.IdPhuThu == id)).ToList();
            var phuThuMoi = await _context.PhuThus.Where(p => idPhuThuMoi.Contains(p.IdPhuThu)).ToListAsync();

            if (isFullPayment)
            {
                hoaDonThanhToan = hoaDonGoc;
                if (req.IdKhachHang.HasValue)
                    hoaDonThanhToan.IdKhachHang = req.IdKhachHang;
            }
            else
            {
                hoaDonThanhToan = new HoaDon
                {
                    IdBan = hoaDonGoc.IdBan,
                    IdNhanVien = hoaDonGoc.IdNhanVien,
                    IdKhachHang = req.IdKhachHang,
                    ThoiGianTao = hoaDonGoc.ThoiGianTao,
                    LoaiHoaDon = hoaDonGoc.LoaiHoaDon,
                    GhiChu = $"TÃ¡ch tá»« HÄ #{hoaDonGoc.IdHoaDon}"
                };
                _context.HoaDons.Add(hoaDonThanhToan);
                await _context.SaveChangesAsync();

                decimal tongTienTach = 0;
                foreach (var chiTiet in chiTietTach)
                {
                    chiTiet.IdHoaDon = hoaDonThanhToan.IdHoaDon;
                    tongTienTach += chiTiet.ThanhTien;
                }
                hoaDonThanhToan.TongTienGoc = tongTienTach;

                decimal tongPhuThuTach = 0;
                foreach (var phuThu in phuThuDaApDungGoc)
                {
                    phuThu.IdHoaDon = hoaDonThanhToan.IdHoaDon;
                    tongPhuThuTach += phuThu.SoTien;
                }
                foreach (var ptMoi in phuThuMoi)
                {
                    decimal soTienPT = string.Equals(ptMoi.LoaiGiaTri, "%", StringComparison.OrdinalIgnoreCase)
                        ? (tongTienTach * (ptMoi.GiaTri / 100))
                        : ptMoi.GiaTri;
                    _context.ChiTietPhuThuHoaDons.Add(new ChiTietPhuThuHoaDon
                    {
                        IdHoaDon = hoaDonThanhToan.IdHoaDon,
                        IdPhuThu = ptMoi.IdPhuThu,
                        SoTien = soTienPT
                    });
                    tongPhuThuTach += soTienPT;
                }
                hoaDonThanhToan.TongPhuThu = tongPhuThuTach;

                hoaDonGoc.TongTienGoc = hoaDonGoc.ChiTietHoaDons.Sum(c => c.ThanhTien);
                hoaDonGoc.TongPhuThu = hoaDonGoc.ChiTietPhuThuHoaDons.Sum(pt => pt.SoTien);
            }

            decimal giamGiaKM = 0;
            decimal giamGiaDiem = 0;

            if (req.IdKhuyenMai.HasValue && req.IdKhuyenMai > 0)
            {
                var km = await _context.KhuyenMais.FindAsync(req.IdKhuyenMai.Value);
                if (km != null)
                {
                    giamGiaKM = await CalculateDiscount(km, hoaDonThanhToan.TongTienGoc, chiTietTach);
                    _context.HoaDonKhuyenMais.Add(new HoaDon_KhuyenMai { IdHoaDon = hoaDonThanhToan.IdHoaDon, IdKhuyenMai = km.IdKhuyenMai });
                    if (km.SoLuongConLai.HasValue && km.SoLuongConLai > 0) km.SoLuongConLai -= 1;
                }
            }

            KhachHang? khachHang = null;
            if (req.IdKhachHang.HasValue)
            {
                khachHang = await _context.KhachHangs.FindAsync(req.IdKhachHang.Value);
            }

            if (khachHang != null && req.DiemSuDung > 0)
            {
                if (khachHang.DiemTichLuy < req.DiemSuDung)
                    return BadRequest("KhÃ¡ch hÃ ng khÃ´ng Ä‘á»§ Ä‘iá»ƒm tÃ­ch lÅ©y.");

                giamGiaDiem = req.DiemSuDung * _tiLeDoiDiem;

                // Sá»¬A Lá»–I CS0019: TongPhuThu lÃ  decimal (khÃ´ng rá»—ng)
                decimal tongTruocDiem = hoaDonThanhToan.TongTienGoc + hoaDonThanhToan.TongPhuThu - giamGiaKM;

                if (giamGiaDiem > tongTruocDiem)
                {
                    giamGiaDiem = tongTruocDiem;
                    req.DiemSuDung = (int)Math.Ceiling(giamGiaDiem / _tiLeDoiDiem);
                }

                khachHang.DiemTichLuy -= req.DiemSuDung;
                hoaDonThanhToan.IdKhachHang = khachHang.IdKhachHang;
            }

            hoaDonThanhToan.GiamGia = giamGiaKM + giamGiaDiem;

            await TruKho(hoaDonThanhToan.IdNhanVien, chiTietTach);

            hoaDonThanhToan.TrangThai = "ÄÃ£ thanh toÃ¡n";
            hoaDonThanhToan.ThoiGianThanhToan = DateTime.Now;
            hoaDonThanhToan.PhuongThucThanhToan = req.PhuongThucThanhToan;

            await _context.SaveChangesAsync();

            _context.GiaoDichThanhToans.Add(new GiaoDichThanhToan
            {
                IdHoaDon = hoaDonThanhToan.IdHoaDon,
                MaGiaoDichNgoai = $"HD_{hoaDonThanhToan.IdHoaDon}_{DateTime.Now:HHmmss}",
                CongThanhToan = req.PhuongThucThanhToan,
                SoTien = hoaDonThanhToan.ThanhTien,
                ThoiGianGiaoDich = (DateTime)hoaDonThanhToan.ThoiGianThanhToan,
                TrangThai = "ThÃ nh cÃ´ng"
            });

            if (khachHang != null && _tiLeNhanDiem > 0)
            {
                if (req.DiemSuDung == 0)
                {
                    int diemMoi = (int)Math.Floor(hoaDonThanhToan.ThanhTien / _tiLeNhanDiem);
                    if (diemMoi > 0)
                    {
                        khachHang.DiemTichLuy += diemMoi;
                    }
                }
            }

            if (isFullPayment || (hoaDonGoc.TongTienGoc == 0 && hoaDonGoc.TongPhuThu == 0))
            {
                if (hoaDonGoc.Ban != null)
                {
                    hoaDonGoc.Ban.TrangThai = "Trá»‘ng";
                }
                if (!isFullPayment)
                {
                    hoaDonGoc.TrangThai = "ÄÃ£ há»§y";
                }
            }

            await _context.SaveChangesAsync();
            return Ok(new { message = "Thanh toÃ¡n thÃ nh cÃ´ng!", isFullPayment = isFullPayment });
        }

        #region HÃ m Helper (Trá»« kho, TÃ­nh KM)

        private async Task TruKho(int idNhanVien, ICollection<ChiTietHoaDon> chiTietList)
        {
            foreach (var chiTiet in chiTietList)
            {
                var dinhLuongList = await _context.DinhLuongs
                    .Include(d => d.NguyenLieu)
                    .Include(d => d.DonViSuDung)
                    .Where(d => d.IdSanPham == chiTiet.IdSanPham)
                    .ToListAsync();

                foreach (var dl in dinhLuongList)
                {
                    var nguyenLieu = await _context.NguyenLieus.FindAsync(dl.IdNguyenLieu);
                    if (nguyenLieu != null)
                    {
                        decimal luongCanTru = (dl.SoLuongSuDung * dl.DonViSuDung.GiaTriQuyDoi) * chiTiet.SoLuong;
                        nguyenLieu.TonKho -= luongCanTru;

                        if (nguyenLieu.TonKho <= nguyenLieu.TonKhoToiThieu)
                        {
                            _context.ThongBaos.Add(new ThongBao
                            {
                                IdNhanVienTao = idNhanVien,
                                NoiDung = $"Cáº£nh bÃ¡o: Tá»“n kho '{nguyenLieu.TenNguyenLieu}' chá»‰ cÃ²n {nguyenLieu.TonKho:N2} {nguyenLieu.DonViTinh}.",
                                ThoiGianTao = DateTime.Now,
                                LoaiThongBao = "CanhBaoKho",
                                IdLienQuan = nguyenLieu.IdNguyenLieu
                            });
                        }
                    }
                }
            }
        }

        private async Task<decimal> CalculateDiscount(KhuyenMai km, decimal tongTienGoc, ICollection<ChiTietHoaDon> chiTietList)
        {
            decimal tongTienGocChoKM = tongTienGoc;
            if (km.IdSanPhamApDung.HasValue)
            {
                tongTienGocChoKM = chiTietList
                    .Where(c => c.IdSanPham == km.IdSanPhamApDung.Value)
                    .Sum(c => c.ThanhTien);
            }

            decimal giamGia = 0;
            if (string.Equals(km.LoaiGiamGia, "PhanTram", StringComparison.OrdinalIgnoreCase))
            {
                giamGia = tongTienGocChoKM * (km.GiaTriGiam / 100);
                if (km.GiamToiDa.HasValue && giamGia > km.GiamToiDa.Value)
                {
                    giamGia = km.GiamToiDa.Value;
                }
            }
            else // SoTien
            {
                giamGia = km.GiaTriGiam;
            }
            return await Task.FromResult(giamGia);
        }

        #endregion
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\HoaDonPreviewWindow.xaml.cs
using CafebookModel.Model.ModelApp.NhanVien;
using System;
using System.Windows;
using System.Windows.Controls;

namespace AppCafebookApi.View.common
{
    public partial class HoaDonPreviewWindow : Window // Sá»¬A: Äá»•i Page thÃ nh Window
    {
        private readonly HoaDonPreviewDto _data;

        // Sá»¬A: Constructor nháº­n DTO
        public HoaDonPreviewWindow(HoaDonPreviewDto data)
        {
            InitializeComponent();
            _data = data;
        }

        private void Window_Loaded(object sender, RoutedEventArgs e)
        {
            // 1. Bind ThÃ´ng tin quÃ¡n
            lblTenQuan.Text = _data.TenQuan;
            lblDiaChi.Text = _data.DiaChi;
            lblSoDienThoai.Text = $"SÄT: {_data.SoDienThoai}";
            lblWifi.Text = $"Wifi: {_data.WifiMatKhau}";

            // 2. Bind ThÃ´ng tin HÃ³a Ä‘Æ¡n
            lblTieuDe.Text = _data.IsProvisional ? "PHIáº¾U Táº M TÃNH" : "HÃ“A ÄÆ N THANH TOÃN";
            lblSoHoaDon.Text = $"Sá»‘ HÄ: #{_data.IdHoaDon}";
            lblBan.Text = $"BÃ n: {_data.SoBan}";
            lblNhanVien.Text = $"NhÃ¢n viÃªn: {_data.TenNhanVien}";
            lblNgay.Text = $"Giá» vÃ o: {_data.ThoiGianTao:dd/MM/yyyy HH:mm}";
            lblKhachHang.Text = $"KhÃ¡ch: {_data.TenKhachHang}";

            // 3. Bind Danh sÃ¡ch
            dgItems.ItemsSource = _data.Items;
            icPhuThu.ItemsSource = _data.Surcharges;

            // 4. Bind Tiá»n
            lblTongTienGoc.Text = _data.TongTienGoc.ToString("N0");
            lblGiamGiaKM.Text = $"- {_data.GiamGiaKM:N0}";
            lblGiamGiaDiem.Text = $"- {_data.GiamGiaDiem:N0}";
            lblTongPhuThu.Text = $"+ {_data.TongPhuThu:N0}";
            lblThanhTien.Text = _data.ThanhTien.ToString("N0") + " Ä‘";

            // áº¨n giáº£m giÃ¡ Ä‘iá»ƒm náº¿u lÃ  Táº¡m tÃ­nh
            if (_data.IsProvisional)
            {
                gridGiamGiaDiem.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnIn_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                PrintDialog printDialog = new PrintDialog();
                if (printDialog.ShowDialog() == true)
                {
                    // áº¨n nÃºt In vÃ  Scrollbar trÆ°á»›c khi in
                    btnIn.Visibility = Visibility.Collapsed;
                    (printArea.Parent as ScrollViewer).VerticalScrollBarVisibility = ScrollBarVisibility.Hidden;

                    printDialog.PrintVisual(printArea, "HÃ³a Ä‘Æ¡n CafeBook");

                    // Hiá»‡n láº¡i nÃºt In
                    btnIn.Visibility = Visibility.Visible;
                    (printArea.Parent as ScrollViewer).VerticalScrollBarVisibility = ScrollBarVisibility.Auto;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i in: {ex.Message}");
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\InputDialogWindow.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\InputDialogWindow.xaml
<Window x:Class="AppCafebookApi.View.common.InputDialogWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Nháº­p thÃ´ng tin" Height="200" Width="400"
        WindowStartupLocation="CenterOwner" WindowStyle="ToolWindow"
        Background="#FFF8E1" FontFamily="Segoe UI">
    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock x:Name="lblPrompt" Grid.Row="0" Text="Vui lÃ²ng nháº­p:" TextWrapping="Wrap" Margin="0,0,0,10"/>

        <TextBox x:Name="txtInput" Grid.Row="1" VerticalAlignment="Top"
                 BorderBrush="#6F4E37" Padding="5" AcceptsReturn="True" TextWrapping="Wrap"/>

        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0">
            <Button x:Name="btnOk" Content="Äá»“ng Ã½" Width="80" Click="BtnOk_Click" IsDefault="True"/>
            <Button x:Name="btnCancel" Content="Há»§y" Width="80" Margin="10,0,0,0" IsCancel="True" Background="#757575"/>
        </StackPanel>
    </Grid>
</Window>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\InputDialogWindow.xaml.cs
using System.Windows;

namespace AppCafebookApi.View.common
{
    public partial class InputDialogWindow : Window
    {
        public string InputText { get; private set; } = string.Empty;

        public InputDialogWindow(string title, string prompt)
        {
            InitializeComponent();
            this.Title = title;
            lblPrompt.Text = prompt;
        }

        private void BtnOk_Click(object sender, RoutedEventArgs e)
        {
            this.InputText = txtInput.Text;
            this.DialogResult = true;
            this.Close();
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\PhieuLuongPreviewWindow.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\PhieuLuongPreviewWindow.xaml
<Window x:Class="AppCafebookApi.View.Common.PhieuLuongPreviewWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Chi tiáº¿t Phiáº¿u LÆ°Æ¡ng" Height="700" Width="500"
        WindowStartupLocation="CenterOwner" ShowInTaskbar="False"
        WindowStyle="ToolWindow" FontFamily="Segoe UI" FontSize="14"
        Background="White"
        Loaded="Window_Loaded">

    <Window.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionOrangeBrush" Color="#FFA726"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="PrimaryBrown" Color="#6F4E37"/>
        <SolidColorBrush x:Key="AccentOrange" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteText" Color="#FFFFFF"/>

        <Geometry x:Key="IconConfirm">M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z</Geometry>
        <Geometry x:Key="IconPrint">M19,8H5C3.34,8 2,9.34 2,11V17H6V21H18V17H22V11C22,9.34 20.66,8 19,8M16,19H8V14H16V19M19,12C18.45,12 18,11.55 18,11C18,10.45 18.45,10 19,10C19.55,10 20,10.45 20,11C20,11.55 19.55,12 19,12M18,3H6V7H18V3Z</Geometry>
        <Geometry x:Key="IconClose">M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z</Geometry>

        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrown}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteText}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Height" Value="42"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                CornerRadius="21"
                                Background="{TemplateBinding Background}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="2" Color="#6F4E37" Opacity="0.3" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource AccentOrange}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                                <Setter TargetName="border" Property="Opacity" Value="0.7"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="SecondaryButton" TargetType="Button" BasedOn="{StaticResource PrimaryButton}">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="BorderThickness" Value="2"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                CornerRadius="21"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource SubtleGrayBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto">

            <Border x:Name="printArea" Background="White" Margin="20" Padding="25" BorderBrush="LightGray" BorderThickness="1">

                <StackPanel>

                    <StackPanel x:Name="headerPanel">
                        <TextBlock Text="{Binding TenQuan}" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center" Foreground="{StaticResource DarkBrownBrush}"/>
                        <TextBlock Text="{Binding DiaChi}" FontSize="11" Foreground="{StaticResource TextGrayBrush}" HorizontalAlignment="Center" Margin="0,0,0,2"/>
                        <TextBlock Text="{Binding SoDienThoai, StringFormat='SÄT: {0}'}" FontSize="11" Foreground="{StaticResource TextGrayBrush}" HorizontalAlignment="Center"/>
                    </StackPanel>

                    <TextBlock Text="PHIáº¾U THANH TOÃN LÆ¯Æ NG" FontSize="18" FontWeight="SemiBold" HorizontalAlignment="Center" Margin="0,20,0,15" Foreground="{StaticResource PrimaryBrownBrush}"/>

                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition/>
                            <RowDefinition/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Grid.Column="0" Text="NhÃ¢n viÃªn:" FontWeight="SemiBold" Margin="0,2,10,2"/>
                        <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding HoTenNhanVien}" TextAlignment="Right" FontWeight="SemiBold" FontSize="16"/>
                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Ká»³ lÆ°Æ¡ng:" FontWeight="SemiBold" Margin="0,2,10,2"/>
                        <StackPanel Grid.Row="1" Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                            <TextBlock Text="{Binding Thang}"/>
                            <TextBlock Text="/"/>
                            <TextBlock Text="{Binding Nam}"/>
                        </StackPanel>
                    </Grid>

                    <Border BorderBrush="LightGray" BorderThickness="1" CornerRadius="3" Padding="10">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition/>
                                <RowDefinition/>
                                <RowDefinition/>
                                <RowDefinition/>
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="LÆ°Æ¡ng cÆ¡ báº£n (giá»)" Margin="0,3"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding LuongCoBan, StringFormat='{}{0:N0} Ä‘/giá»'}" TextAlignment="Right" Margin="0,3" FontWeight="SemiBold"/>
                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Tá»•ng giá» lÃ m" Margin="0,3"/>
                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding TongGioLam, StringFormat='{}{0:F2} giá»'}" TextAlignment="Right" Margin="0,3" FontWeight="SemiBold"/>
                            <TextBlock Grid.Row="2" Grid.Column="0" Text="CÃ¡c khoáº£n thÆ°á»Ÿng" Margin="0,3"/>
                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding TienThuong, StringFormat='+ {0:N0} Ä‘'}" Foreground="{StaticResource SuccessBrush}" TextAlignment="Right" Margin="0,3" FontWeight="SemiBold"/>
                            <TextBlock Grid.Row="3" Grid.Column="0" Text="CÃ¡c khoáº£n pháº¡t" Margin="0,3"/>
                            <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding KhauTru, StringFormat='- {0:N0} Ä‘'}" Foreground="{StaticResource ErrorBrush}" TextAlignment="Right" Margin="0,3" FontWeight="SemiBold"/>
                        </Grid>
                    </Border>

                    <Grid Margin="0,15,0,20">
                        <TextBlock Text="THá»°C LÃƒNH" FontSize="18" FontWeight="Bold" VerticalAlignment="Center" HorizontalAlignment="Left" Foreground="{StaticResource DarkBrownBrush}"/>
                        <TextBlock Text="{Binding ThucLanh, StringFormat='{}{0:N0} Ä‘'}" FontSize="20" FontWeight="Bold" Foreground="{StaticResource AccentOrange}" HorizontalAlignment="Right"/>
                    </Grid>
                    <Border BorderBrush="LightGray" BorderThickness="0,1,0,0" Padding="0,10,0,0" Margin="0,0,0,20">
                        <Grid TextElement.FontSize="12" TextElement.Foreground="{StaticResource TextGrayBrush}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition/>
                                <RowDefinition/>
                                <RowDefinition/>
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Tráº¡ng thÃ¡i:" Margin="0,2,10,2"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding TrangThai}" FontWeight="Bold" TextAlignment="Right">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding TrangThai}" Value="ÄÃ£ phÃ¡t">
                                                <Setter Property="Foreground" Value="{StaticResource SuccessBrush}"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding TrangThai}" Value="ÄÃ£ chá»‘t">
                                                <Setter Property="Foreground" Value="{StaticResource ActionOrangeBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                            <TextBlock Grid.Row="1" Grid.Column="0" Text="NgÃ y phÃ¡t:" Margin="0,2,10,2"/>
                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding NgayPhat, StringFormat='dd/MM/yyyy HH:mm'}" TextAlignment="Right"/>
                            <TextBlock Grid.Row="2" Grid.Column="0" Text="NgÆ°á»i phÃ¡t:" Margin="0,2,10,2"/>
                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding TenNguoiPhat}" TextAlignment="Right"/>
                        </Grid>
                    </Border>
                    <Grid Margin="0,20,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                            <TextBlock Text="NgÆ°á»i phÃ¡t" HorizontalAlignment="Center" FontWeight="SemiBold"/>
                            <TextBlock Text="(KÃ½, ghi rÃµ há» tÃªn)" HorizontalAlignment="Center" FontSize="11" FontStyle="Italic" Foreground="{StaticResource TextGrayBrush}"/>
                        </StackPanel>
                        <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                            <TextBlock Text="NgÆ°á»i nháº­n" HorizontalAlignment="Center" FontWeight="SemiBold"/>
                            <TextBlock Text="(KÃ½, ghi rÃµ há» tÃªn)" HorizontalAlignment="Center" FontSize="11" FontStyle="Italic" Foreground="{StaticResource TextGrayBrush}"/>
                        </StackPanel>
                    </Grid>

                </StackPanel>
            </Border>
        </ScrollViewer>

        <Border Grid.Row="1" Background="{StaticResource SubtleGrayBrush}" BorderBrush="LightGray" BorderThickness="0,1,0,0" Padding="15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <Button x:Name="btnXacNhanPhat" Grid.Column="0" Style="{StaticResource PrimaryButton}" 
                        Background="{StaticResource SuccessBrush}" Click="BtnXacNhanPhat_Click" 
                        Width="Auto" Padding="15,0" Grid.ColumnSpan="2" Margin="0,5,72,5">
                    <StackPanel Orientation="Horizontal">
                        <Path Data="{StaticResource IconConfirm}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                        <TextBlock Text="XÃ¡c nháº­n PhÃ¡t LÆ°Æ¡ng" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <Button x:Name="btnPrint" Grid.Column="2" Style="{StaticResource SecondaryButton}" 
                        Content="In Phiáº¿u" Width="100" Margin="5" Click="BtnPrint_Click"/>

                <Button x:Name="btnClose" Grid.Column="3" Style="{StaticResource SecondaryButton}" 
                        Background="{StaticResource TextGrayBrush}" Foreground="White" BorderThickness="0"
                        Content="ÄÃ³ng" Width="100" Margin="5" Click="BtnClose_Click" IsCancel="True"/>
            </Grid>
        </Border>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="2" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Äang xá»­ lÃ½..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" 
Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Window>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\PhieuLuongPreviewWindow.xaml.cs
using System;
using System.Linq; // Cáº§n thÃªm
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using AppCafebookApi.Services;
using CafebookModel.Model.ModelApp;

namespace AppCafebookApi.View.Common
{
    public partial class PhieuLuongPreviewWindow : Window
    {
        private static readonly HttpClient httpClient;
        private int _idPhieuLuong;
        private PhieuLuongChiTietDto? _phieuLuong;
        private CaiDatThongTinCuaHangDto? _thongTinCuaHang; // ThÃªm Ä‘á»‘i tÆ°á»£ng má»›i

        static PhieuLuongPreviewWindow()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public PhieuLuongPreviewWindow(int idPhieuLuong)
        {
            InitializeComponent();
            _idPhieuLuong = idPhieuLuong;
        }

        private async void Window_Loaded(object sender, RoutedEventArgs e)
        {
            LoadingOverlay.Visibility = Visibility.Visible;

            // Thá»±c hiá»‡n song song 2 tÃ¡c vá»¥ táº£i dá»¯ liá»‡u
            var loadPhieuTask = LoadChiTietPhieuLuongAsync();
            var loadInfoTask = LoadThongTinCuaHangAsync();

            await Task.WhenAll(loadPhieuTask, loadInfoTask);

            // GÃ¡n DataContext sau khi cáº£ hai Ä‘Ã£ táº£i xong
            if (_phieuLuong != null && _thongTinCuaHang != null)
            {
                // GÃ¡n chi tiáº¿t phiáº¿u lÆ°Æ¡ng cho khu vá»±c chÃ­nh (printArea)
                printArea.DataContext = _phieuLuong;

                // GÃ¡n thÃ´ng tin cá»­a hÃ ng cho khu vá»±c header (headerPanel)
                headerPanel.DataContext = _thongTinCuaHang;

                // Xá»­ lÃ½ logic nÃºt báº¥m (náº¿u cáº§n)
                if (_phieuLuong.TrangThai == "ÄÃ£ phÃ¡t")
                {
                    btnXacNhanPhat.IsEnabled = false;
                    if (btnXacNhanPhat.Content is StackPanel sp)
                    {
                        var tb = sp.Children.OfType<TextBlock>().FirstOrDefault();
                        if (tb != null)
                        {
                            tb.Text = "ÄÃ£ PhÃ¡t";
                        }
                    }
                }
            }
            else
            {
                MessageBox.Show("KhÃ´ng thá»ƒ táº£i Ä‘áº§y Ä‘á»§ thÃ´ng tin phiáº¿u lÆ°Æ¡ng hoáº·c thÃ´ng tin cá»­a hÃ ng.", "Lá»—i API");
                this.Close();
            }

            LoadingOverlay.Visibility = Visibility.Collapsed;
        }

        /// <summary>
        /// Táº£i chi tiáº¿t phiáº¿u lÆ°Æ¡ng (API 1)
        /// </summary>
        private async Task LoadChiTietPhieuLuongAsync()
        {
            try
            {
                var response = await httpClient.GetAsync($"api/app/phatluong/chitiet/{_idPhieuLuong}");
                if (response.IsSuccessStatusCode)
                {
                    _phieuLuong = await response.Content.ReadFromJsonAsync<PhieuLuongChiTietDto>();
                }
                else
                {
                    // Xá»­ lÃ½ lá»—i á»Ÿ hÃ m Window_Loaded
                }
            }
            catch (Exception)
            {
                // Xá»­ lÃ½ lá»—i á»Ÿ hÃ m Window_Loaded
            }
        }

        /// <summary>
        /// Táº£i thÃ´ng tin cá»­a hÃ ng (API 2)
        /// </summary>
        private async Task LoadThongTinCuaHangAsync()
        {
            try
            {
                var response = await httpClient.GetAsync("api/app/caidat/thong-tin-cua-hang");
                if (response.IsSuccessStatusCode)
                {
                    _thongTinCuaHang = await response.Content.ReadFromJsonAsync<CaiDatThongTinCuaHangDto>();
                }
                else
                {
                    // Náº¿u tháº¥t báº¡i, táº¡o Ä‘á»‘i tÆ°á»£ng rá»—ng Ä‘á»ƒ trÃ¡nh lá»—i
                    _thongTinCuaHang = new CaiDatThongTinCuaHangDto { TenQuan = "N/A", DiaChi = "N/A", SoDienThoai = "N/A" };
                }
            }
            catch (Exception)
            {
                _thongTinCuaHang = new CaiDatThongTinCuaHangDto { TenQuan = "Lá»—i", DiaChi = "Lá»—i", SoDienThoai = "Lá»—i" };
            }
        }

        // ... (CÃ¡c hÃ m BtnXacNhanPhat_Click, BtnPrint_Click, BtnClose_Click giá»¯ nguyÃªn y há»‡t) ...

        private async void BtnXacNhanPhat_Click(object sender, RoutedEventArgs e)
        {
            if (_phieuLuong == null || AuthService.CurrentUser == null)
            {
                MessageBox.Show("Lá»—i: KhÃ´ng cÃ³ thÃ´ng tin phiáº¿u lÆ°Æ¡ng hoáº·c ngÆ°á»i dÃ¹ng.", "Lá»—i");
                return;
            }

            var confirm = MessageBox.Show($"XÃ¡c nháº­n phÃ¡t lÆ°Æ¡ng cho:\n\nNhÃ¢n viÃªn: {_phieuLuong.HoTenNhanVien}\nSá»‘ tiá»n: {_phieuLuong.ThucLanh:N0} Ä‘",
                                        "XÃ¡c nháº­n PhÃ¡t LÆ°Æ¡ng", MessageBoxButton.YesNo, MessageBoxImage.Warning);

            if (confirm == MessageBoxResult.No) return;

            LoadingOverlay.Visibility = Visibility.Visible;

            var dto = new PhatLuongXacNhanDto
            {
                IdNguoiPhat = AuthService.CurrentUser.IdNhanVien
            };

            try
            {
                var response = await httpClient.PutAsJsonAsync($"api/app/phatluong/xacnhan/{_idPhieuLuong}", dto);

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("XÃ¡c nháº­n phÃ¡t lÆ°Æ¡ng thÃ nh cÃ´ng!", "ThÃ nh cÃ´ng", MessageBoxButton.OK, MessageBoxImage.Information);
                    this.DialogResult = true;
                    this.Close();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnPrint_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                PrintDialog printDialog = new PrintDialog();
                if (printDialog.ShowDialog() == true)
                {
                    var scrollViewer = printArea.Parent as ScrollViewer;
                    if (scrollViewer != null)
                    {
                        scrollViewer.VerticalScrollBarVisibility = ScrollBarVisibility.Hidden;
                    }

                    printDialog.PrintVisual(printArea, "In Phiáº¿u LÆ°Æ¡ng");

                    if (scrollViewer != null)
                    {
                        scrollViewer.VerticalScrollBarVisibility = ScrollBarVisibility.Auto;
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i khi in: {ex.Message}", "Lá»—i In áº¥n");
            }
        }

        private void BtnClose_Click(object sender, RoutedEventArgs e)
        {
            this.DialogResult = false;
            this.Close();
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\WelcomeWindow.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\WelcomeWindow.xaml
<Window x:Class="AppCafebookApi.View.Common.WelcomeWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AppCafebookApi.View.Common"
        Title="ChÃ o má»«ng" Height="280" Width="540"
        WindowStartupLocation="CenterOwner"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent"
        ShowInTaskbar="False" Topmost="True" ResizeMode="NoResize"
        Loaded="Window_Loaded">
    
    <Window.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="DarkTextBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>

        <Style TargetType="ProgressBar">
            <Setter Property="Background" Value="#E0D8C6"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Height" Value="6"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ProgressBar">
                        <Grid>
                            <Border x:Name="PART_Track" CornerRadius="3" Background="{TemplateBinding Background}"/>
                            <Border x:Name="PART_Indicator" CornerRadius="3" Background="{TemplateBinding Foreground}" HorizontalAlignment="Left"/>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid>
        <Border Background="#CC4E342E" CornerRadius="12"/>

        <Border x:Name="WelcomeCard" Width="460" Height="200" CornerRadius="12" 
                Background="{StaticResource LightCreamBrush}"
                HorizontalAlignment="Center" VerticalAlignment="Center"
                RenderTransformOrigin="0.5, 0.5">
            <Border.RenderTransform>
                <ScaleTransform ScaleX="0.9" ScaleY="0.9"/>
            </Border.RenderTransform>
            <Border.Effect>
                <DropShadowEffect Color="#000" BlurRadius="25" Opacity="0.2" ShadowDepth="5"/>
            </Border.Effect>
            <Border.Triggers>
                <EventTrigger RoutedEvent="Loaded">
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.4"/>
                            <DoubleAnimation Storyboard.TargetName="WelcomeCard" Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)" To="1" Duration="0:0:0.4">
                                <DoubleAnimation.EasingFunction>
                                    <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                                </DoubleAnimation.EasingFunction>
                            </DoubleAnimation>
                            <DoubleAnimation Storyboard.TargetName="WelcomeCard" Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)" To="1" Duration="0:0:0.4">
                                <DoubleAnimation.EasingFunction>
                                    <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                                </DoubleAnimation.EasingFunction>
                            </DoubleAnimation>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
            </Border.Triggers>

            <Grid>
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <TextBlock x:Name="txtWelcome" Text="CHÃ€O Má»ªNG" 
                               FontWeight="Bold" 
                               FontSize="28" 
                               TextAlignment="Center" 
                               Margin="0,0,0,15"/>

                    <StackPanel VerticalAlignment="Center">
                        <TextBlock x:Name="txtUserGreeting" 
                                   Text="Xin chÃ o, [TÃªn]" 
                                   FontSize="18" 
                                   FontWeight="SemiBold" 
                                   Foreground="{StaticResource DarkTextBrush}"
                                   HorizontalAlignment="Center"/>
                        <TextBlock x:Name="txtSub" 
                                   Text="Äang chuáº©n bá»‹ khÃ´ng gian lÃ m viá»‡c cho báº¡n..." 
                                   FontSize="13" 
                                   Foreground="{StaticResource DarkTextBrush}" Opacity="0.7"
                                   Margin="0,6,0,12"
                                   HorizontalAlignment="Center"/>
                        <ProgressBar Width="280" IsIndeterminate="True"/>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\Common\WelcomeWindow.xaml.cs
using AppCafebookApi.Services; // <--- THÃŠM DÃ’NG NÃ€Y
using CafebookModel.Model.Data;
using CafebookModel.Utils; // <--- Sá»¬ Dá»¤NG HELPER Má»šI
using System;
using System.Windows;
using System.Windows.Media; // ThÃªm
using System.Windows.Media.Imaging; // ThÃªm
using System.Windows.Threading;
using System.Windows.Controls; // <-- ThÃªm dÃ²ng nÃ y Ä‘á»ƒ nháº­n diá»‡n StackPanel
using System.Linq;             // <-- ThÃªm dÃ²ng nÃ y Ä‘á»ƒ nháº­n diá»‡n .OfType vÃ  .FirstOrDefault

namespace AppCafebookApi.View.Common
{
    public partial class WelcomeWindow : Window
    {
        private readonly NhanVienDto? _user;
        private DispatcherTimer? _timer;

        public WelcomeWindow()
        {
            InitializeComponent();
        }

        public WelcomeWindow(NhanVienDto user)
        {
            InitializeComponent();
            _user = user;
        }

        private void Window_Loaded(object sender, RoutedEventArgs e)
        {
            if (_user != null)
            {
                txtUserGreeting.Text = $"Xin chÃ o, {_user.HoTen}";

                // 1. Táº£i áº£nh báº±ng HinhAnhHelper
                BitmapImage avatar = HinhAnhHelper.LoadImage(
                    _user.AnhDaiDien ?? string.Empty,
                    HinhAnhPaths.DefaultAvatar
                );

                // 2. GÃN áº¢NH VÃ€O UI (ÄÃƒ Sá»¬A)
                if (avatar != null)
                {
                    // Trong WelcomeWindow.xaml, khÃ´ng cÃ³ Image, 
                    // chÃºng ta gÃ¡n vÃ o <Ellipse.Fill> cá»§a <Ellipse>

                    // (Giáº£ sá»­ Ellipse náº±m trong StackPanel)
                    var stackPanel = txtWelcome.Parent as StackPanel;
                    if (stackPanel != null)
                    {
                        // TÃ¬m Ellipse (lÃ  control Ä‘áº§u tiÃªn trong StackPanel)
                        var ellipse = stackPanel.Children.OfType<System.Windows.Shapes.Ellipse>().FirstOrDefault();
                        if (ellipse != null)
                        {
                            ellipse.Fill = new ImageBrush(avatar)
                            {
                                Stretch = Stretch.UniformToFill
                            };
                        }
                    }
                }
            }

            // Cáº¥u hÃ¬nh timer
            _timer = new DispatcherTimer
            {
                Interval = TimeSpan.FromMilliseconds(2500)
            };
            _timer.Tick += Timer_Tick;
            _timer.Start();
        }

        private void Timer_Tick(object? sender, EventArgs e)
        {
            _timer?.Stop();
            this.Close();
        }

        // XÃ“A 2 HÃ€M LoadImageFromBase64 VÃ€ LoadImageFromPath CÅ¨ á» ÄÃ‚Y
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\GoiMonView.xaml e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\GoiMonView.xaml.cs
<Page x:Class="AppCafebookApi.View.nhanvien.pages.GoiMonView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.nhanvien.pages"
      mc:Ignorable="d" 
      d:DesignHeight="720" d:DesignWidth="1280"
      Title="GoiMonView" FontFamily="Segoe UI" Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#EEEEEE"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="StatusGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="StatusRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="StatusYellowBrush" Color="#FFA726"/>

        <Geometry x:Key="IconSave">M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z</Geometry>
        <Geometry x:Key="IconPrint">M19,8H5C3.34,8 2,9.34 2,11V17H6V21H18V17H22V11C22,9.34 20.66,8 19,8M16,19H8V14H16V19M19,12C18.45,12 18,11.55 18,11C18,10.45 18.45,10 19,10C19.55,10 20,10.45 20,11C20,11.55 19.55,12 19,12M18,3H6V7H18V3Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>
        <Geometry x:Key="IconPay">M11,16H13V15H11V16M15,11H9V10C9,8.67 10.17,7.54 11.5,7.5C12.84,7.54 14,8.67 14,10V11H15M17,10C17,7.24 14.76,5 12,5C9.24,5 7,7.24 7,10V11H5V20H19V11H17V10Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z</Geometry>

        <Style x:Key="DataGridButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource SubtleGrayBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Width" Value="24"/>
            <Setter Property="Height" Value="24"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="DeleteDataGridButtonStyle" TargetType="Button" BasedOn="{StaticResource DataGridButtonStyle}">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#FFE8E8"/>
                    <Setter Property="Foreground" Value="{StaticResource StatusRedBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="InvoiceDataGridStyle" TargetType="DataGrid">
            <Setter Property="AutoGenerateColumns" Value="False"/>
            <Setter Property="CanUserAddRows" Value="False"/>
            <Setter Property="GridLinesVisibility" Value="Horizontal"/>
            <Setter Property="HorizontalGridLinesBrush" Value="{StaticResource SubtleGrayBrush}"/>
            <Setter Property="HeadersVisibility" Value="Column"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="RowHeight" Value="45"/>
        </Style>

        <Style TargetType="DataGridColumnHeader">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0,0,0,2"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
        </Style>

        <Style TargetType="DataGridCell">
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Style.Triggers>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="{StaticResource LightCreamBrush}"/>
                    <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="CategoryRadioButton" TargetType="RadioButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="Padding" Value="15,12"/>
            <Setter Property="BorderThickness" Value="3,0,0,0"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RadioButton">
                        <Border x:Name="border" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Left" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource SubtleGrayBrush}"/>
                </Trigger>
                <Trigger Property="IsChecked" Value="True">
                    <Setter Property="FontWeight" Value="SemiBold"/>
                    <Setter Property="Background" Value="{StaticResource LightCreamBrush}"/>
                    <Setter Property="BorderBrush" Value="{StaticResource AccentOrangeBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="ProductCard" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource LightCreamBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Margin" Value="10"/>
            <Setter Property="Width" Value="140"/>
            <Setter Property="Height" Value="150"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" CornerRadius="8">
                            <Border.Effect>
                                <DropShadowEffect x:Name="shadow" ShadowDepth="1" Color="#000" Opacity="0.05" BlurRadius="8"/>
                            </Border.Effect>
                            <ContentPresenter/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Trigger.EnterActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <ColorAnimation Storyboard.TargetName="Bd" Storyboard.TargetProperty="(Border.BorderBrush).(SolidColorBrush.Color)" To="#D27D2D" Duration="0:0:0.2"/>
                                            <DoubleAnimation Storyboard.TargetName="shadow" Storyboard.TargetProperty="Opacity" To="0.15" Duration="0:0:0.2" />
                                        </Storyboard>
                                    </BeginStoryboard>
                                </Trigger.EnterActions>
                                <Trigger.ExitActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <ColorAnimation Storyboard.TargetName="Bd" Storyboard.TargetProperty="(Border.BorderBrush).(SolidColorBrush.Color)" To="#E0E0E0" Duration="0:0:0.2"/>
                                            <DoubleAnimation Storyboard.TargetName="shadow" Storyboard.TargetProperty="Opacity" To="0.05" Duration="0:0:0.2" />
                                        </Storyboard>
                                    </BeginStoryboard>
                                </Trigger.ExitActions>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="ActionButton" TargetType="Button">
            <Setter Property="Padding" Value="15"/>
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
    </Page.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="220"/>
            <ColumnDefinition Width="3*"/>
            <ColumnDefinition Width="2*"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Background="{StaticResource WhiteTextBrush}">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <ItemsControl x:Name="lbLoaiSP">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <RadioButton GroupName="Categories" 
                                         Content="{Binding TenLoaiSP}" 
                                         Style="{StaticResource CategoryRadioButton}"
                                         Checked="Category_Checked"
                                         DataContext="{Binding}"/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Border>

        <Grid Grid.Column="1" Background="{StaticResource SubtleGrayBrush}">
            <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                <ItemsControl x:Name="icSanPham">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Margin="5"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Button Style="{StaticResource ProductCard}" Click="ProductButton_Click" DataContext="{Binding}">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <Border Grid.Row="0" 
                                            Background="{StaticResource BorderGrayBrush}" 
                                            CornerRadius="6,6,0,0"
                                            ClipToBounds="True">
                                        <Image Source="{Binding HinhAnh}" 
                                               Stretch="UniformToFill" />
                                    </Border>
                                    <StackPanel Grid.Row="1" Margin="8">
                                        <TextBlock Text="{Binding TenSanPham}" FontWeight="SemiBold" TextWrapping="Wrap" TextAlignment="Center" Height="38" FontSize="14" Foreground="{StaticResource DarkBrownBrush}"/>
                                        <TextBlock Text="{Binding DonGia, StringFormat={}{0:N0} Ä‘}" Foreground="{StaticResource PrimaryBrownBrush}" HorizontalAlignment="Center" Margin="0,5,0,0" FontWeight="Bold"/>
                                    </StackPanel>
                                </Grid>
                            </Button>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Grid>

        <Grid Grid.Column="2" Background="{StaticResource LightCreamBrush}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <Border Grid.Row="0" Padding="20,15" BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="0,0,0,1">
                <TextBlock x:Name="lblTieuDeHoaDon" Text="HÃ³a Ä‘Æ¡n - BÃ n ..." FontSize="20" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}"/>
            </Border>

            <DataGrid Grid.Row="1" x:Name="dgChiTietHoaDon" Style="{StaticResource InvoiceDataGridStyle}">

                <DataGrid.Columns>
                    <DataGridTextColumn Header="TÃªn MÃ³n" Binding="{Binding TenSanPham}" Width="*" IsReadOnly="True"/>

                    <DataGridTemplateColumn Header="Sá»‘ LÆ°á»£ng" Width="100">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <Button x:Name="btnGiamSL" Content="-" Style="{StaticResource DataGridButtonStyle}" Click="BtnGiamSL_Click" Padding="0" Width="20" Height="20"/>
                                    <TextBlock Text="{Binding SoLuong}" Margin="8,0" VerticalAlignment="Center" FontWeight="SemiBold"/>
                                    <Button x:Name="btnTangSL" Content="+" Style="{StaticResource DataGridButtonStyle}" Click="BtnTangSL_Click" Padding="0" Width="20" Height="20"/>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTextColumn Header="ÄÆ¡n GiÃ¡" Binding="{Binding DonGia, StringFormat=N0}" Width="80" IsReadOnly="True"/>
                    <DataGridTextColumn Header="ThÃ nh Tiá»n" Binding="{Binding ThanhTien, StringFormat=N0}" Width="*" IsReadOnly="True" FontWeight="SemiBold"/>

                    <DataGridTemplateColumn Header="XÃ³a" Width="40">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Button x:Name="btnXoaMon" Style="{StaticResource DeleteDataGridButtonStyle}" ToolTip="XÃ³a mÃ³n"
                                        Click="BtnXoaMon_Click">
                                    <Viewbox Width="12" Height="12">
                                        <Path Data="{StaticResource IconDelete}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                                    </Viewbox>
                                </Button>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>

            <Border Grid.Row="2" Background="{StaticResource WhiteTextBrush}" Padding="15">
                <Border.Effect>
                    <DropShadowEffect ShadowDepth="0" BlurRadius="15" Opacity="0.1" Color="Black"/>
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <Grid Grid.Row="0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Tá»•ng tiá»n:" Margin="5" FontSize="14" Foreground="{StaticResource TextGrayBrush}"/>
                        <TextBlock Grid.Row="0" Grid.Column="1" Grid.ColumnSpan="2" x:Name="lblTongTien" Text="0" Margin="5" FontSize="14" HorizontalAlignment="Right" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Khuyáº¿n mÃ£i:" Margin="5" VerticalAlignment="Center"/>

                        <Button Grid.Row="1" Grid.Column="1" x:Name="btnChonKhuyenMai" 
                                Content="-- Chá»n Khuyáº¿n mÃ£i --" 
                                Margin="5,5,0,5" 
                                Click="BtnChonKhuyenMai_Click"
                                FontWeight="SemiBold"/>

                        <Button Grid.Row="1" Grid.Column="2" x:Name="btnHuyKhuyenMai" 
                                Content="X" 
                                ToolTip="Gá»¡ bá» khuyáº¿n mÃ£i"
                                Margin="5,5,5,5" 
                                Click="BtnHuyKhuyenMai_Click"
                                Background="{StaticResource StatusRedBrush}" 
                                Foreground="White"
                                FontWeight="Bold" Width="25"
                                Visibility="Collapsed"/>

                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Tiá»n giáº£m:" Margin="5" FontSize="14" Foreground="{StaticResource TextGrayBrush}"/>
                        <TextBlock Grid.Row="2" Grid.Column="1" Grid.ColumnSpan="2" x:Name="lblTienGiam" Text="0" Margin="5" FontSize="14" HorizontalAlignment="Right" Foreground="{StaticResource StatusGreenBrush}" FontWeight="SemiBold"/>

                        <Separator Grid.Row="3" Grid.ColumnSpan="3" Margin="0,10"/>
                    </Grid>

                    <Grid Grid.Row="1" Margin="0,0,0,15">
                        <TextBlock Text="THÃ€NH TIá»€N" FontSize="18" FontWeight="Bold" VerticalAlignment="Center" Foreground="{StaticResource DarkBrownBrush}"/>
                        <TextBlock x:Name="lblThanhTien" Text="0 VND" FontSize="22" FontWeight="Bold" HorizontalAlignment="Right" Foreground="{StaticResource PrimaryBrownBrush}"/>
                    </Grid>

                    <Grid Grid.Row="2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <Button x:Name="btnThanhToan" Grid.Column="0" Style="{StaticResource ActionButton}" Background="{StaticResource StatusGreenBrush}" Click="BtnThanhToan_Click">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,10,0" VerticalAlignment="Center">
                                    <Path Data="{StaticResource IconPay}" Fill="White"/>
                                </Viewbox>
                                <TextBlock Grid.Column="1" Text="Thanh ToÃ¡n" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            </Grid>
                        </Button>

                        <Button x:Name="btnHuyDon" Grid.Column="1" ToolTip="Há»§y HÃ³a Ä‘Æ¡n" Style="{StaticResource ActionButton}" 
                                Background="{StaticResource StatusRedBrush}" Click="BtnHuyDon_Click" Margin="5,0,0,0">
                            <Viewbox Width="18" Height="18">
                                <Path Data="{StaticResource IconDelete}" Fill="White"/>
                            </Viewbox>
                        </Button>
                        <Button x:Name="btnLuu" Grid.Column="2" ToolTip="LÆ°u HÃ³a Ä‘Æ¡n" Style="{StaticResource ActionButton}" Background="{StaticResource ActionBlueBrush}" Click="BtnLuu_Click" Margin="5,0,0,0">
                            <Viewbox Width="18" Height="18">
                                <Path Data="{StaticResource IconSave}" Fill="White"/>
                            </Viewbox>
                        </Button>
                        <Button x:Name="btnInTamTinh" Grid.Column="3" ToolTip="In Táº¡m tÃ­nh" Style="{StaticResource ActionButton}" Background="{StaticResource ActionGrayBrush}" Click="BtnInTamTinh_Click" Margin="5,0,0,0">
                            <Viewbox Width="18" Height="18">
                                <Path Data="{StaticResource IconPrint}" Fill="White"/>
                            </Viewbox>
                        </Button>
                        <Button x:Name="btnQuayLai" Grid.Column="4" ToolTip="Quay láº¡i SÆ¡ Ä‘á»“ bÃ n" Style="{StaticResource ActionButton}" Background="{StaticResource SubtleGrayBrush}" Foreground="{StaticResource DarkBrownBrush}" Click="BtnQuayLai_Click" Margin="5,0,0,0">
                            <Viewbox Width="18" Height="18">
                                <Path Data="{StaticResource IconBack}" Fill="{StaticResource DarkBrownBrush}"/>
                            </Viewbox>
                        </Button>
                    </Grid>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\GoiMonView.xaml.cs
using AppCafebookApi.Services;
using AppCafebookApi.View.common;
using CafebookModel.Model.ModelApp.NhanVien;
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Text.Json; // ThÃªm
using System.Text.Json.Serialization;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media;

namespace AppCafebookApi.View.nhanvien.pages
{
    public partial class GoiMonView : Page
    {
        // Lá»›p helper há»©ng káº¿t quáº£ AddItem
        private class AddItemResponseDto
        {
            [JsonPropertyName("updatedHoaDonInfo")]
            public HoaDonInfoDto? updatedHoaDonInfo { get; set; }
            [JsonPropertyName("newItem")]
            public ChiTietDto? newItem { get; set; }
        }

        private readonly int _idHoaDon;
        private static readonly HttpClient _httpClient;

        // Biáº¿n cá»¥c bá»™ Ä‘á»ƒ lÆ°u tráº¡ng thÃ¡i
        private List<SanPhamDto> _allSanPhams = new List<SanPhamDto>();
        private ObservableCollection<ChiTietDto> _chiTietItems = new ObservableCollection<ChiTietDto>();
        private List<KhuyenMaiDto> _availableKms = new List<KhuyenMaiDto>(); // <-- LÆ¯U TRá»® KM
        private int? _currentKhuyenMaiId = null; // <-- LÆ¯U ID KM HIá»†N Táº I
        private bool _isDataLoading = true;

        static GoiMonView()
        {
            _httpClient = new HttpClient { BaseAddress = new Uri("http://localhost:5166") };
        }

        public GoiMonView(int idHoaDon)
        {
            InitializeComponent();
            _idHoaDon = idHoaDon;
            dgChiTietHoaDon.ItemsSource = _chiTietItems;
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadDataAsync();
        }

        private async Task LoadDataAsync()
        {
            _isDataLoading = true;
            try
            {
                var response = await _httpClient.GetFromJsonAsync<GoiMonViewDto>($"api/app/nhanvien/goimon/load/{_idHoaDon}");
                if (response == null)
                {
                    MessageBox.Show("KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u hÃ³a Ä‘Æ¡n.", "Lá»—i API");
                    return;
                }

                _allSanPhams = response.SanPhams ?? new List<SanPhamDto>();

                var danhMucs = response.DanhMucs ?? new List<DanhMucDto>();
                danhMucs.Insert(0, new DanhMucDto { IdDanhMuc = 0, TenLoaiSP = "Táº¥t cáº£" });
                lbLoaiSP.ItemsSource = danhMucs;

                _chiTietItems.Clear();
                response.ChiTietItems?.ForEach(item => _chiTietItems.Add(item));

                // LÆ°u danh sÃ¡ch KM Ä‘á»ƒ cáº­p nháº­t UI
                _availableKms = response.KhuyenMais ?? new List<KhuyenMaiDto>();
                // XÃ³a ComboBox: cmbKhuyenMai.ItemsSource = _availableKms;

                UpdateBillUI(response.HoaDonInfo);

                if (lbLoaiSP.Items.Count > 0)
                {
                    lbLoaiSP.UpdateLayout();
                    var container = lbLoaiSP.ItemContainerGenerator.ContainerFromIndex(0) as FrameworkElement;
                    var rb = FindVisualChild<RadioButton>(container);
                    if (rb != null)
                    {
                        rb.IsChecked = true;
                    }
                    else
                    {
                        icSanPham.ItemsSource = _allSanPhams;
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i dá»¯ liá»‡u: {ex.Message}", "Lá»—i nghiÃªm trá»ng");
            }
            _isDataLoading = false;
        }

        private T? FindVisualChild<T>(DependencyObject? obj) where T : DependencyObject
        {
            if (obj == null) return null;
            for (int i = 0; i < VisualTreeHelper.GetChildrenCount(obj); i++)
            {
                DependencyObject child = VisualTreeHelper.GetChild(obj, i);
                if (child != null && child is T)
                    return (T)child;
                else
                {
                    T? childOfChild = FindVisualChild<T>(child);
                    if (childOfChild != null)
                        return childOfChild;
                }
            }
            return null;
        }

        private void UpdateBillUI(HoaDonInfoDto info)
        {
            if (info == null) return;

            lblTieuDeHoaDon.Text = $"HÃ³a Ä‘Æ¡n - {info.SoBan}";
            lblTongTien.Text = info.TongTienGoc.ToString("N0");
            lblTienGiam.Text = info.GiamGia.ToString("N0");
            lblThanhTien.Text = info.ThanhTien.ToString("N0") + " VND";

            _currentKhuyenMaiId = info.IdKhuyenMai; // Cáº­p nháº­t ID hiá»‡n táº¡i

            // Cáº­p nháº­t Button thay vÃ¬ ComboBox
            if (_currentKhuyenMaiId.HasValue && _currentKhuyenMaiId != 0)
            {
                var km = _availableKms.FirstOrDefault(k => k.IdKhuyenMai == _currentKhuyenMaiId);
                btnChonKhuyenMai.Content = km?.TenKhuyenMai ?? "ÄÃ£ chá»n KM";
                btnHuyKhuyenMai.Visibility = Visibility.Visible;
            }
            else
            {
                btnChonKhuyenMai.Content = "-- Chá»n Khuyáº¿n mÃ£i --";
                btnHuyKhuyenMai.Visibility = Visibility.Collapsed;
            }
        }

        private void Category_Checked(object sender, RoutedEventArgs e)
        {
            var radioButton = sender as RadioButton;
            var danhMuc = radioButton?.DataContext as DanhMucDto;

            if (danhMuc == null)
            {
                if (radioButton != null && radioButton.Content.ToString() == "Táº¥t cáº£")
                {
                    icSanPham.ItemsSource = _allSanPhams;
                }
                return;
            }

            if (danhMuc.IdDanhMuc == 0) // "Táº¥t cáº£"
            {
                icSanPham.ItemsSource = _allSanPhams;
            }
            else
            {
                icSanPham.ItemsSource = _allSanPhams.Where(s => s.IdDanhMuc == danhMuc.IdDanhMuc).ToList();
            }
        }

        private async void ProductButton_Click(object sender, RoutedEventArgs e)
        {
            var sanPham = (sender as Button)?.DataContext as SanPhamDto;
            if (sanPham == null) return;

            var request = new AddItemRequest
            {
                IdHoaDon = _idHoaDon,
                IdSanPham = sanPham.IdSanPham,
                SoLuong = 1
            };

            try
            {
                var response = await _httpClient.PostAsJsonAsync("api/app/nhanvien/goimon/add-item", request);
                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<AddItemResponseDto>();
                    if (result?.updatedHoaDonInfo == null || result.newItem == null) return;

                    UpdateBillUI(result.updatedHoaDonInfo);

                    ChiTietDto newItem = result.newItem;
                    var existingItem = _chiTietItems.FirstOrDefault(c => c.IdChiTietHoaDon == newItem.IdChiTietHoaDon);
                    if (existingItem != null)
                    {
                        existingItem.SoLuong = newItem.SoLuong;
                        existingItem.ThanhTien = newItem.ThanhTien;
                    }
                    else
                    {
                        _chiTietItems.Add(newItem);
                    }
                    dgChiTietHoaDon.Items.Refresh();
                }
                else
                {
                    MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lá»—i thÃªm mÃ³n");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message, "Lá»—i API");
            }
        }

        private async void BtnGiamSL_Click(object sender, RoutedEventArgs e)
        {
            var item = (sender as Button)?.DataContext as ChiTietDto;
            if (item == null) return;
            await UpdateQuantityAsync(item, item.SoLuong - 1);
        }

        private async void BtnTangSL_Click(object sender, RoutedEventArgs e)
        {
            var item = (sender as Button)?.DataContext as ChiTietDto;
            if (item == null) return;
            await UpdateQuantityAsync(item, item.SoLuong + 1);
        }

        private async void BtnXoaMon_Click(object sender, RoutedEventArgs e)
        {
            var item = (sender as Button)?.DataContext as ChiTietDto;
            if (item == null) return;

            var result = MessageBox.Show($"Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a [{item.TenSanPham}]?", "XÃ¡c nháº­n xÃ³a", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.Yes)
            {
                await UpdateQuantityAsync(item, 0);
            }
        }

        private async Task UpdateQuantityAsync(ChiTietDto item, int soLuongMoi)
        {
            var request = new UpdateSoLuongRequest
            {
                IdChiTietHoaDon = item.IdChiTietHoaDon,
                SoLuongMoi = soLuongMoi
            };

            try
            {
                var response = await _httpClient.PutAsJsonAsync("api/app/nhanvien/goimon/update-quantity", request);
                if (response.IsSuccessStatusCode)
                {
                    var hoaDonInfo = await response.Content.ReadFromJsonAsync<HoaDonInfoDto>();
                    if (hoaDonInfo != null) UpdateBillUI(hoaDonInfo);

                    if (soLuongMoi <= 0)
                    {
                        _chiTietItems.Remove(item);
                    }
                    else
                    {
                        item.SoLuong = soLuongMoi;
                        item.ThanhTien = item.SoLuong * item.DonGia;
                    }
                    dgChiTietHoaDon.Items.Refresh();
                }
                else
                {
                    MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lá»—i cáº­p nháº­t");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message, "Lá»—i API");
            }
        }

        // === LOGIC KHUYáº¾N MÃƒI Má»šI (ÄÃƒ Sá»¬A Lá»–I THREADING) ===

        private async void BtnChonKhuyenMai_Click(object sender, RoutedEventArgs e)
        {
            if (_isDataLoading) return; // ThÃªm báº£o vá»‡
            _isDataLoading = true;

            // 1. Má»Ÿ cá»­a sá»• dialog
            var dialog = new ChonKhuyenMaiWindow(_idHoaDon, _currentKhuyenMaiId);

            // 2. Kiá»ƒm tra káº¿t quáº£
            if (dialog.ShowDialog() == true)
            {
                // 3. Náº¿u ngÆ°á»i dÃ¹ng nháº¥n "Ãp dá»¥ng"
                int? selectedKmId = dialog.SelectedId;
                if (selectedKmId == 0) selectedKmId = null; // "KhÃ´ng Ã¡p dá»¥ng"

                // 4. Gá»i API (Sá»­a: Bá» Task.Run, gá»i await trá»±c tiáº¿p)
                await ApplyKhuyenMaiApiCallAsync(selectedKmId);
            }

            _isDataLoading = false;
        }

        private async void BtnHuyKhuyenMai_Click(object sender, RoutedEventArgs e)
        {
            if (_isDataLoading) return; // ThÃªm báº£o vá»‡
            _isDataLoading = true;

            // Gá»i API vá»›i null Ä‘á»ƒ gá»¡ bá» KM (Sá»­a: Bá» Task.Run)
            await ApplyKhuyenMaiApiCallAsync(null);

            _isDataLoading = false;
        }

        // HÃ m dÃ¹ng chung Ä‘á»ƒ gá»i API Ã¡p dá»¥ng/há»§y KM
        private async Task ApplyKhuyenMaiApiCallAsync(int? idKhuyenMai)
        {
            // (XÃ³a 'if (_isDataLoading) return;' vÃ¬ Ä‘Ã£ kiá»ƒm tra á»Ÿ hÃ m gá»i)

            var request = new ApplyPromotionRequest
            {
                IdHoaDon = _idHoaDon,
                IdKhuyenMai = idKhuyenMai
            };

            try
            {
                var response = await _httpClient.PutAsJsonAsync("api/app/nhanvien/goimon/apply-promotion", request);

                // Sá»­a: VÃ¬ hÃ m nÃ y Ä‘Ã£ cháº¡y trÃªn UI thread, chÃºng ta khÃ´ng cáº§n Dispatcher
                if (response.IsSuccessStatusCode)
                {
                    var hoaDonInfo = await response.Content.ReadFromJsonAsync<HoaDonInfoDto>();
                    if (hoaDonInfo != null)
                    {
                        // Sá»­a: Pháº£i AWAIT (chá») LoadDataAsync xong
                        await LoadDataAsync();
                        // Sau khi LoadDataAsync cÃ³ KM má»›i, UpdateBillUI má»›i cháº¡y
                        UpdateBillUI(hoaDonInfo);
                    }
                }
                else
                {
                    MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lá»—i Ã¡p dá»¥ng KM");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message, "Lá»—i API");
            }
        }

        // Sá»¬A Láº I HÃ€M NÃ€Y
        private async void BtnThanhToan_Click(object sender, RoutedEventArgs e)
        {
            // YÃŠU Cáº¦U: LÆ°u khuyáº¿n mÃ£i hiá»‡n táº¡i trÆ°á»›c khi chuyá»ƒn trang
            if (_isDataLoading) return;
            _isDataLoading = true;

            var request = new ApplyPromotionRequest
            {
                IdHoaDon = _idHoaDon,
                IdKhuyenMai = _currentKhuyenMaiId
            };

            try
            {
                // 1. LÆ°u KM vÃ o CSDL (báº£ng HoaDon_KhuyenMai)
                var response = await _httpClient.PutAsJsonAsync("api/app/nhanvien/goimon/apply-promotion", request);
                if (!response.IsSuccessStatusCode)
                {
                    MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lá»—i Ã¡p dá»¥ng KM");
                    _isDataLoading = false;
                    return;
                }

                // 2. Äiá»u hÆ°á»›ng Ä‘áº¿n trang ThanhToanView (CHá»ˆ TRUYá»€N ID)
                this.NavigationService?.Navigate(new ThanhToanView(_idHoaDon));
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message, "Lá»—i API");
            }
            _isDataLoading = false;
        }

        private async void BtnHuyDon_Click(object sender, RoutedEventArgs e)
        {
            var result = MessageBox.Show($"Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n Há»¦Y hÃ³a Ä‘Æ¡n nÃ y khÃ´ng?\n(CÃ¡c mÃ³n Ä‘Ã£ thÃªm sáº½ bá»‹ xÃ³a)",
                            "XÃ¡c nháº­n Há»§y", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result != MessageBoxResult.Yes) return;

            try
            {
                // Gá»i API (ÄÃ£ sá»­a á»Ÿ DonHangController)
                var response = await _httpClient.PutAsJsonAsync($"api/app/donhang/update-status/{_idHoaDon}", "Há»§y");
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("ÄÃ£ há»§y hÃ³a Ä‘Æ¡n thÃ nh cÃ´ng!", "ThÃ nh cÃ´ng", MessageBoxButton.OK, MessageBoxImage.Information);
                    if (this.NavigationService.CanGoBack)
                    {
                        this.NavigationService.GoBack();
                    }
                }
                else
                {
                    MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lá»—i Há»§y ÄÆ¡n");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message, "Lá»—i API");
            }
        }

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }

        private void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            MessageBox.Show("ÄÃ£ lÆ°u cÃ¡c thay Ä‘á»•i.", "ÄÃ£ lÆ°u");
        }

        private void BtnInTamTinh_Click(object sender, RoutedEventArgs e)
        {
            MessageBox.Show("Chá»©c nÄƒng 'In Táº¡m TÃ­nh' Ä‘ang Ä‘Æ°á»£c phÃ¡t triá»ƒn.", "ThÃ´ng bÃ¡o");
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\SoDoBanView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\SoDoBanView.xaml
<Page x:Class="AppCafebookApi.View.nhanvien.pages.SoDoBanView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.nhanvien.pages"
      xmlns:sys="clr-namespace:System;assembly=mscorlib"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="SoDoBanView" FontFamily="Segoe UI" Loaded="Page_Loaded">

    <Page.Resources>
        <Geometry x:Key="IconSelectTable">M12,2C8.13,2 5,5.13 5,9C5,14.25 12,22 12,22C12,22 19,14.25 19,9C19,5.13 15.87,2 12,2M12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5Z</Geometry>
        <Geometry x:Key="IconRefresh">M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z</Geometry>
        <Geometry x:Key="IconMenu">M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z</Geometry>

        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#EEEEEE"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="StatusGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="StatusRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="StatusYellowBrush" Color="#FFA726"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="StatusBlueBrush" Color="#42A5F5"/>
        <ExponentialEase x:Key="ExpoEaseOut" EasingMode="EaseOut"/>
        <FontFamily x:Key="FontAwesomeSolid">/Assets/Fonts/Font Awesome 6 Free-Solid-900.otf#Font Awesome 6 Free Solid</FontFamily>

        <Style x:Key="KhuVucToggleStyle" TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Padding" Value="20,14"/>
            <Setter Property="Margin" Value="15,0,15,5"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="border" 
                                Background="{TemplateBinding Background}" 
                                CornerRadius="8">
                            <ContentPresenter HorizontalAlignment="Left" VerticalAlignment="Center" Margin="{TemplateBinding Padding}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource SubtleGrayBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="TableCardStyle" TargetType="Button">
            <Setter Property="Width" Value="150"/>
            <Setter Property="Height" Value="130"/>
            <Setter Property="Margin" Value="15"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderThickness" Value="0,5,0,0"/>
            <Setter Property="BorderBrush" Value="{StaticResource StatusGreenBrush}"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="cardBorder" 
                                Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}" 
                                BorderThickness="{TemplateBinding BorderThickness}" 
                                CornerRadius="8"
                                RenderTransformOrigin="0.5,0.5">
                            <Border.RenderTransform>
                                <ScaleTransform ScaleX="1" ScaleY="1"/>
                            </Border.RenderTransform>
                            <Border.Effect>
                                <DropShadowEffect x:Name="shadow" ShadowDepth="1" Color="#000" Opacity="0.1" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" Margin="5"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <DataTrigger Binding="{Binding TrangThai}" Value="CÃ³ khÃ¡ch">
                    <Setter Property="BorderBrush" Value="{StaticResource StatusRedBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TrangThai}" Value="ÄÃ£ Ä‘áº·t">
                    <Setter Property="BorderBrush" Value="{StaticResource StatusYellowBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TrangThai}" Value="Báº£o trÃ¬">
                    <Setter Property="BorderBrush" Value="{StaticResource TextGrayBrush}"/>
                    <Setter Property="Opacity" Value="0.7"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="ActionButtonStyle" TargetType="Button">
            <Setter Property="Padding" Value="12,20"/>
            <Setter Property="Margin" Value="0,5"/>
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" 
                                CornerRadius="4" 
                                Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid x:Name="MainPanel" Background="{StaticResource LightCreamBrush}">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="220"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="320"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Background="{StaticResource WhiteTextBrush}">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel Margin="0,10">
                    <TextBlock Text="Lá»c Khu Vá»±c" FontWeight="Bold" FontSize="16" Foreground="{StaticResource DarkBrownBrush}" Margin="20,10,0,10"/>
                    <ToggleButton x:Name="btnKhuVucAll" Content="Táº¤T Cáº¢ KHU Vá»°C" Style="{StaticResource KhuVucToggleStyle}" IsChecked="True" Click="BtnKhuVuc_Click"/>
                    <Separator Margin="15,5,15,10"/>
                    <ItemsControl x:Name="icKhuVuc">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <ToggleButton Content="{Binding TenKhuVuc}" Style="{StaticResource KhuVucToggleStyle}" Click="BtnKhuVuc_Click" DataContext="{Binding}"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </ScrollViewer>
        </Border>

        <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
            <StackPanel>
                <WrapPanel Margin="15,15,15,0">
                    <Button Style="{StaticResource TableCardStyle}" 
                            BorderBrush="{StaticResource AccentOrangeBrush}"
                            ToolTip="Táº¡o hÃ³a Ä‘Æ¡n Táº¡i Quáº§y / Mang Vá»"
                            Click="BtnDonMoi_Click">
                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                            <TextBlock Text="&#xf54e;" FontFamily="{StaticResource FontAwesomeSolid}" FontSize="28" Margin="0,0,0,8" HorizontalAlignment="Center" Foreground="{StaticResource AccentOrangeBrush}"/>
                            <TextBlock Text="ÄÆ¡n Má»›i" FontSize="24" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" HorizontalAlignment="Center"/>
                            <TextBlock Text="Táº¡i Quáº§y / Mang Vá»" FontSize="13" Foreground="{StaticResource TextGrayBrush}" HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </WrapPanel>

                <ItemsControl x:Name="icBan" Margin="15,0,15,15">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Button Style="{StaticResource TableCardStyle}" Click="BtnBan_Click">
                                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                                    <TextBlock FontSize="28" Margin="0,0,0,8" HorizontalAlignment="Center">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Text" Value="&#xf00c;"/>
                                                <Setter Property="FontFamily" Value="{StaticResource FontAwesomeSolid}"/>
                                                <Setter Property="Foreground" Value="{StaticResource StatusGreenBrush}"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding TrangThai}" Value="CÃ³ khÃ¡ch">
                                                        <Setter Property="Text" Value="&#xf0c0;"/>
                                                        <Setter Property="Foreground" Value="{StaticResource StatusRedBrush}"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding TrangThai}" Value="ÄÃ£ Ä‘áº·t">
                                                        <Setter Property="Text" Value="&#xf017;"/>
                                                        <Setter Property="Foreground" Value="{StaticResource StatusYellowBrush}"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding TrangThai}" Value="Báº£o trÃ¬">
                                                        <Setter Property="Text" Value="&#xf0ad;"/>
                                                        <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                    <TextBlock Text="{Binding SoBan}" FontSize="24" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" HorizontalAlignment="Center"/>
                                    <TextBlock Text="{Binding TrangThai}" FontSize="13" Foreground="{StaticResource TextGrayBrush}" HorizontalAlignment="Center"/>
                                    <TextBlock Text="{Binding TongTienHienTai, StringFormat={}{0:N0} Ä‘}" FontSize="13" Foreground="{StaticResource StatusRedBrush}" FontWeight="SemiBold" HorizontalAlignment="Center" Margin="0,4,0,0">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding TrangThai}" Value="CÃ³ khÃ¡ch">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </StackPanel>
                            </Button>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </ScrollViewer>

        <Border Grid.Column="2" Background="{StaticResource WhiteTextBrush}">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="2" Direction="270" Color="Black" Opacity="0.05" BlurRadius="20"/>
            </Border.Effect>

            <Grid x:Name="panelThaoTac" Margin="25">

                <StackPanel x:Name="panelChuaChon" VerticalAlignment="Center" HorizontalAlignment="Center" Opacity="0.5">
                    <Path Data="{StaticResource IconSelectTable}" Fill="{StaticResource BorderGrayBrush}" Width="60" Height="60" Stretch="Uniform"/>
                    <TextBlock Text="Chá»n má»™t bÃ n Ä‘á»ƒ báº¯t Ä‘áº§u thao tÃ¡c" FontSize="16" Foreground="{StaticResource TextGrayBrush}" TextWrapping="Wrap" TextAlignment="Center" Margin="0,20,0,0"/>
                </StackPanel>

                <StackPanel x:Name="panelDaChon" Visibility="Collapsed">
                    <TextBlock Text="ThÃ´ng Tin BÃ n" FontSize="22" FontWeight="Bold" Margin="0,0,0,15" Foreground="{StaticResource DarkBrownBrush}"/>
                    <Separator Background="#EEEEEE"/>
                    <TextBlock FontSize="40" FontWeight="Bold" Margin="0,20,0,0" Foreground="{StaticResource PrimaryBrownBrush}">BÃ n <Run x:Name="runSoBan"/></TextBlock>
                    <TextBlock FontSize="16" Margin="0,5,0,0" Foreground="{StaticResource TextGrayBrush}">Tráº¡ng thÃ¡i: <Run x:Name="runTrangThai" FontWeight="SemiBold"/></TextBlock>
                    <TextBlock x:Name="tbGhiChu" FontStyle="Italic" Foreground="{StaticResource TextGrayBrush}" Margin="0,5,0,0" TextWrapping="Wrap" Visibility="Collapsed"/>
                    <TextBlock x:Name="tbTongTienWrapper" FontSize="16" Margin="0,10,0,0" Foreground="{StaticResource DarkBrownBrush}">Tá»•ng tiá»n táº¡m tÃ­nh: <Run x:Name="runTongTien" FontWeight="Bold" Foreground="{StaticResource StatusRedBrush}"/></TextBlock>
                    <StackPanel Margin="0,30,0,0">
                        <Button x:Name="btnGoiMon" Padding="20,18" FontSize="16" FontWeight="Bold" Background="{StaticResource PrimaryBrownBrush}" Foreground="White" Click="BtnGoiMon_Click" Cursor="Hand">
                            <Button.Resources>
                                <Style TargetType="Border">
                                    <Setter Property="CornerRadius" Value="4"/>
                                </Style>
                            </Button.Resources>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Viewbox Grid.Column="0" Width="18" Height="18" Margin="0,0,12,0" VerticalAlignment="Center">
                                    <Path Data="{StaticResource IconMenu}" Fill="White"/>
                                </Viewbox>
                                <TextBlock Grid.Column="1" Text="Gá»i MÃ³n / Thanh ToÃ¡n" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            </Grid>
                        </Button>
                        <Button x:Name="btnChuyenBan" Content="Chuyá»ƒn BÃ n" Style="{StaticResource ActionButtonStyle}" Click="BtnChuyenBan_Click" Background="#F5F5F5" BorderBrush="#E0E0E0" Foreground="{StaticResource DarkBrownBrush}"/>
                        <Button x:Name="btnGopBan" Content="Gá»™p BÃ n" Style="{StaticResource ActionButtonStyle}" Click="BtnGopBan_Click" Background="#F5F5F5" BorderBrush="#E0E0E0" Foreground="{StaticResource DarkBrownBrush}"/>
                        <Button x:Name="btnBaoCaoSuCo" Content="BÃ¡o cÃ¡o Sá»± cá»‘" Style="{StaticResource ActionButtonStyle}" Background="{StaticResource StatusYellowBrush}" BorderBrush="{StaticResource StatusYellowBrush}" Foreground="{StaticResource DarkBrownBrush}" Margin="0,20,0,0" Click="BtnBaoCaoSuCo_Click"/>
                    </StackPanel>
                    <Button x:Name="btnLamMoi" VerticalAlignment="Bottom" HorizontalAlignment="Stretch" Margin="0,50,0,0" Click="BtnLamMoi_Click" Style="{StaticResource ActionButtonStyle}" Background="Transparent" BorderBrush="#E0E0E0" Foreground="{StaticResource TextGrayBrush}" FontWeight="Normal">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="15" Height="15" Margin="0,0,10,0" VerticalAlignment="Center">
                                <Path Data="{StaticResource IconRefresh}" Fill="{StaticResource TextGrayBrush}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="LÃ m má»›i SÆ¡ Ä‘á»“" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                </StackPanel>

                <StackPanel x:Name="panelChonBan" Visibility="Collapsed" VerticalAlignment="Center">
                    <TextBlock x:Name="selectionText" 
                               Text="Vui lÃ²ng chá»n bÃ n..." 
                               Foreground="{StaticResource DarkBrownBrush}" 
                               FontSize="18" 
                               FontWeight="Bold"
                               TextWrapping="Wrap" TextAlignment="Center"/>
                    <TextBlock Text="Click vÃ o bÃ n há»£p lá»‡ trÃªn sÆ¡ Ä‘á»“" 
                               Foreground="{StaticResource TextGrayBrush}" 
                               FontSize="14" 
                               TextAlignment="Center" Margin="0,5,0,0"/>

                    <Button Content="Há»§y Thao TÃ¡c" 
                            x:Name="btnCancelSelect" 
                            Click="BtnCancelSelect_Click"
                            Style="{StaticResource ActionButtonStyle}"
                            Background="{StaticResource StatusRedBrush}"
                            BorderBrush="{StaticResource StatusRedBrush}"
                            Foreground="White"
                            Margin="0,20,0,0"/>

                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\SoDoBanView.xaml.cs
using System;
using System.Collections.Generic;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media;
using AppCafebookApi.Services;
using AppCafebookApi.View.common;
using System.Linq;
using System.Windows.Controls.Primitives;
using CafebookModel.Model.ModelApp.NhanVien;
using CafebookModel.Model.ModelApp;
using System.Text.Json;

namespace AppCafebookApi.View.nhanvien.pages
{
    public partial class SoDoBanView : Page
    {
        // THÃŠM Lá»šP HELPER NÃ€Y VÃ€O BÃŠN TRONG CLASS SoDoBanView
        private class CreateOrderResponseDto
        {
            [System.Text.Json.Serialization.JsonPropertyName("idHoaDon")]
            public int idHoaDon { get; set; }
        }
        private enum SelectionMode { None, ChuyenBan, GopBan }

        private static readonly HttpClient httpClient;
        private BanSoDoDto? _selectedBan = null;
        private List<BanSoDoDto> _allTablesCache = new List<BanSoDoDto>();
        private List<KhuVucDto> _khuVucCache = new List<KhuVucDto>();
        private SelectionMode _currentMode = SelectionMode.None;

        static SoDoBanView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public SoDoBanView()
        {
            InitializeComponent();
            this.DataContext = this;
        }

        #region Táº£i Dá»¯ Liá»‡u vÃ  Lá»c Khu Vá»±c

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            MainPanel.Opacity = 0.5;
            // Táº£i láº¡i toÃ n bá»™ dá»¯ liá»‡u khi trang Ä‘Æ°á»£c táº£i
            await ReloadDataAsync();
            MainPanel.Opacity = 1.0;
        }

        // Äá»•i tÃªn hÃ m Page_Loaded thÃ nh ReloadDataAsync
        private async Task ReloadDataAsync()
        {
            // LÆ°u láº¡i khu vá»±c Ä‘ang chá»n
            var selectedKhuVucBtn = FindCheckedKhuVucButton();
            int? selectedKhuVucId = null;
            if (selectedKhuVucBtn != null && selectedKhuVucBtn != btnKhuVucAll && selectedKhuVucBtn.DataContext is KhuVucDto dto)
            {
                selectedKhuVucId = dto.IdKhuVuc;
            }

            panelChuaChon.Visibility = Visibility.Visible;
            panelDaChon.Visibility = Visibility.Collapsed;

            // === XÃ“A DÃ’NG NÃ€Y ===
            // _selectedBan = null; // <-- DÃ’NG NÃ€Y GÃ‚Y Lá»–I
            // === Káº¾T THÃšC ===

            // Táº£i láº¡i cáº£ hai danh sÃ¡ch
            await Task.WhenAll(LoadKhuVucSidebarAsync(), LoadTablesAsync());

            // Ãp dá»¥ng láº¡i bá»™ lá»c
            ApplyTableFilter(selectedKhuVucId);

            // Chá»n láº¡i nÃºt khu vá»±c
            if (selectedKhuVucBtn != null)
                selectedKhuVucBtn.IsChecked = true;
            else if (btnKhuVucAll != null) // ThÃªm kiá»ƒm tra null
                btnKhuVucAll.IsChecked = true;
        }


        private async Task LoadKhuVucSidebarAsync()
        {
            try
            {
                _khuVucCache = (await httpClient.GetFromJsonAsync<List<KhuVucDto>>("api/app/banquanly/tree"))
                                 ?? new List<KhuVucDto>();
                icKhuVuc.ItemsSource = _khuVucCache;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"KhÃ´ng thá»ƒ táº£i danh sÃ¡ch Khu Vá»±c: {ex.Message}", "Lá»—i API");
            }
        }

        private async Task LoadTablesAsync()
        {
            try
            {
                _allTablesCache = (await httpClient.GetFromJsonAsync<List<BanSoDoDto>>("api/app/sodoban/tables"))
                                      ?? new List<BanSoDoDto>();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"KhÃ´ng thá»ƒ táº£i sÆ¡ Ä‘á»“ bÃ n: {ex.Message}", "Lá»—i API");
            }
        }

        private void BtnKhuVuc_Click(object sender, RoutedEventArgs e)
        {
            var clickedButton = sender as ToggleButton;
            if (clickedButton == null) return;
            UncheckOtherKhuVucButtons(clickedButton);
            int? khuVucId = null;
            if (clickedButton != btnKhuVucAll && clickedButton.DataContext is KhuVucDto selectedKhuVuc)
            {
                khuVucId = selectedKhuVuc.IdKhuVuc;
            }
            ApplyTableFilter(khuVucId);
        }

        private void ApplyTableFilter(int? khuVucId)
        {
            if (khuVucId == null)
            {
                icBan.ItemsSource = _allTablesCache;
            }
            else
            {
                icBan.ItemsSource = _allTablesCache.Where(ban => ban.IdKhuVuc == khuVucId).ToList();
            }
        }

        private void UncheckOtherKhuVucButtons(ToggleButton? exception)
        {
            if (btnKhuVucAll != null && btnKhuVucAll != exception)
            {
                btnKhuVucAll.IsChecked = false;
            }
            foreach (var item in icKhuVuc.Items)
            {
                var container = icKhuVuc.ItemContainerGenerator.ContainerFromItem(item) as FrameworkElement;
                if (container == null) continue;
                var toggleButton = FindVisualChild<ToggleButton>(container);
                if (toggleButton != null && toggleButton != exception)
                {
                    toggleButton.IsChecked = false;
                }
            }
        }

        private T? FindVisualChild<T>(DependencyObject? obj) where T : DependencyObject
        {
            if (obj == null) return null;
            for (int i = 0; i < VisualTreeHelper.GetChildrenCount(obj); i++)
            {
                DependencyObject child = VisualTreeHelper.GetChild(obj, i);
                if (child != null)
                {
                    if (child is T)
                        return (T)child;
                    else
                    {
                        T? childOfChild = FindVisualChild<T>(child);
                        if (childOfChild != null)
                            return childOfChild;
                    }
                }
            }
            return null;
        }

        private ToggleButton? FindCheckedKhuVucButton()
        {
            if (btnKhuVucAll != null && btnKhuVucAll.IsChecked == true) return btnKhuVucAll;
            foreach (var item in icKhuVuc.Items)
            {
                var container = icKhuVuc.ItemContainerGenerator.ContainerFromItem(item) as FrameworkElement;
                if (container == null) continue;
                var toggleButton = FindVisualChild<ToggleButton>(container);
                if (toggleButton != null && toggleButton.IsChecked == true)
                {
                    return toggleButton;
                }
            }
            return btnKhuVucAll; // Máº·c Ä‘á»‹nh
        }

        #endregion

        // === LOGIC Xá»¬ LÃ CHÃNH ===

        private void BtnDonMoi_Click(object sender, RoutedEventArgs e)
        {
            var virtualBan = new BanSoDoDto
            {
                IdBan = -1, // Dáº¥u hiá»‡u "Táº¡i Quáº§y"
                SoBan = "Táº¡i Quáº§y",
                TrangThai = "Trá»‘ng",
                IdKhuVuc = null,
                IdHoaDonHienTai = null,
                TongTienHienTai = 0
            };
            UncheckOtherKhuVucButtons(null);
            _selectedBan = null;
            ShowPanelForBan(virtualBan);
        }

        private async void BtnBan_Click(object sender, RoutedEventArgs e)
        {
            var button = sender as Button;
            var clickedBan = button?.DataContext as BanSoDoDto;
            if (clickedBan == null) return;

            if (_currentMode != SelectionMode.None)
            {
                await HandleTableSelectionAsync(clickedBan);
            }
            else
            {
                UncheckOtherKhuVucButtons(null);
                ShowPanelForBan(clickedBan);
            }
        }

        private void ShowPanelForBan(BanSoDoDto ban)
        {
            _selectedBan = ban;

            panelChuaChon.Visibility = Visibility.Collapsed;
            panelChonBan.Visibility = Visibility.Collapsed;
            panelDaChon.Visibility = Visibility.Visible;

            runSoBan.Text = _selectedBan.SoBan;
            runTrangThai.Text = _selectedBan.TrangThai;

            if (!string.IsNullOrEmpty(_selectedBan.GhiChu))
            {
                tbGhiChu.Text = $"Ghi chÃº: {_selectedBan.GhiChu}";
                tbGhiChu.Visibility = Visibility.Visible;
            }
            else
            {
                tbGhiChu.Visibility = Visibility.Collapsed;
            }

            switch (_selectedBan.TrangThai)
            {
                case "Trá»‘ng":
                    btnGoiMon.Content = "Táº¡o HÃ³a ÄÆ¡n Má»›i";
                    btnGoiMon.IsEnabled = true;
                    btnChuyenBan.IsEnabled = false;
                    btnGopBan.IsEnabled = false;
                    btnBaoCaoSuCo.IsEnabled = (_selectedBan.IdBan > 0);
                    tbTongTienWrapper.Visibility = Visibility.Collapsed;
                    break;
                case "CÃ³ khÃ¡ch":
                    btnGoiMon.Content = "Gá»i MÃ³n / Thanh ToÃ¡n";
                    btnGoiMon.IsEnabled = true;
                    btnChuyenBan.IsEnabled = true;
                    btnGopBan.IsEnabled = true;
                    btnBaoCaoSuCo.IsEnabled = false;
                    tbTongTienWrapper.Visibility = Visibility.Visible;
                    runTongTien.Text = _selectedBan.TongTienHienTai.ToString("N0") + " Ä‘";
                    break;
                case "ÄÃ£ Ä‘áº·t":
                    btnGoiMon.Content = "KhÃ¡ch Ä‘áº·t (Má»Ÿ HÃ³a ÄÆ¡n)";
                    btnGoiMon.IsEnabled = true;
                    btnChuyenBan.IsEnabled = false;
                    btnGopBan.IsEnabled = false;
                    btnBaoCaoSuCo.IsEnabled = true;
                    tbTongTienWrapper.Visibility = Visibility.Collapsed;
                    break;
                case "Báº£o trÃ¬":
                case "Táº¡m ngÆ°ng":
                    btnGoiMon.Content = "BÃ€N ÄANG Báº¢O TRÃŒ";
                    btnGoiMon.IsEnabled = false;
                    btnChuyenBan.IsEnabled = false;
                    btnGopBan.IsEnabled = false;
                    btnBaoCaoSuCo.IsEnabled = false;
                    tbTongTienWrapper.Visibility = Visibility.Collapsed;
                    break;
            }
        }

        // === HÃ€M Bá»Š Lá»–I ===
        private async void BtnGoiMon_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedBan == null) return;

            if (_selectedBan.TrangThai == "CÃ³ khÃ¡ch")
            {
                int? idHoaDon = _selectedBan.IdHoaDonHienTai;
                if (idHoaDon.HasValue)
                {
                    this.NavigationService?.Navigate(new GoiMonView(idHoaDon.Value));
                }
                return;
            }

            // === Sá»¬A Lá»–I NULL REFERENCE ===
            // Di chuyá»ƒn kiá»ƒm tra Auth lÃªn Ä‘áº§u
            if (AuthService.CurrentUser == null)
            {
                MessageBox.Show("Lá»—i: PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.", "Lá»—i PhiÃªn");
                return;
            }

            // GÃ¡n idNhanVien SAU KHI Ä‘Ã£ kiá»ƒm tra
            int idNhanVien = AuthService.CurrentUser.IdNhanVien;
            // === Káº¾T THÃšC Sá»¬A Lá»–I ===

            int? idHoaDonMoi = null;

            try
            {
                HttpResponseMessage response;
                if (_selectedBan.IdBan > 0)
                {
                    response = await httpClient.PostAsJsonAsync($"api/app/sodoban/createorder/{_selectedBan.IdBan}/{idNhanVien}", new { });
                }
                else
                {
                    // Sá»­a "Táº¡i quáº§y" thÃ nh "Táº¡i quÃ¡n" (Sá»­a lá»—i CHECK constraint)
                    string loaiHoaDon = (_selectedBan.IdBan == -1) ? "Táº¡i quÃ¡n" : "Mang vá»";
                    response = await httpClient.PostAsJsonAsync($"api/app/sodoban/createorder-no-table/{idNhanVien}", loaiHoaDon);
                }

                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<CreateOrderResponseDto>();
                    if (result != null && result.idHoaDon > 0)
                    {
                        idHoaDonMoi = result.idHoaDon;
                    }
                    if (_selectedBan.IdBan > 0)
                    {
                        // Sá»­a: Gá»i hÃ m ReloadDataAsync() má»›i
                        await ReloadDataAsync();
                    }
                }
                else
                {
                    MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lá»—i táº¡o hÃ³a Ä‘Æ¡n");
                    return;
                }
            }
            catch (Exception ex) { MessageBox.Show($"Lá»—i API: {ex.Message}", "Lá»—i"); return; }

            if (idHoaDonMoi.HasValue)
            {
                this.NavigationService?.Navigate(new GoiMonView(idHoaDonMoi.Value));

                if (_selectedBan.IdBan <= 0)
                {
                    ResetForm();
                }
            }
        }

        private async void BtnLamMoi_Click(object sender, RoutedEventArgs e)
        {
            MainPanel.Opacity = 0.5;
            await ReloadDataAsync();
            MainPanel.Opacity = 1.0;
        }


        private async void BtnBaoCaoSuCo_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedBan == null) return;
            // ThÃªm kiá»ƒm tra Auth
            if (AuthService.CurrentUser == null)
            {
                MessageBox.Show("Lá»—i: PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n.", "Lá»—i PhiÃªn");
                return;
            }
            int idNhanVien = AuthService.CurrentUser.IdNhanVien;
            var inputDialog = new InputDialogWindow("BÃ¡o cÃ¡o sá»± cá»‘", $"Vui lÃ²ng mÃ´ táº£ sá»± cá»‘ cho bÃ n {_selectedBan.SoBan}:");
            if (inputDialog.ShowDialog() == true)
            {
                string ghiChu = inputDialog.InputText;
                if (string.IsNullOrWhiteSpace(ghiChu)) return;
                try
                {
                    var request = new BaoCaoSuCoRequestDto { GhiChuSuCo = ghiChu };
                    var response = await httpClient.PostAsJsonAsync($"api/app/sodoban/reportproblem/{_selectedBan.IdBan}/{idNhanVien}", request);
                    if (response.IsSuccessStatusCode)
                    {
                        await ReloadDataAsync();
                    }
                    else
                    {
                        MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lá»—i bÃ¡o cÃ¡o");
                    }
                }
                catch (Exception ex) { MessageBox.Show($"Lá»—i API: {ex.Message}", "Lá»—i"); }
            }
        }

        private void StartSelectionMode(SelectionMode mode, string instructionText)
        {
            _currentMode = mode;
            selectionText.Text = instructionText;

            panelChuaChon.Visibility = Visibility.Collapsed;
            panelDaChon.Visibility = Visibility.Collapsed;
            panelChonBan.Visibility = Visibility.Visible;
        }

        private void BtnCancelSelect_Click(object sender, RoutedEventArgs e)
        {
            ResetForm();
        }

        private void BtnChuyenBan_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedBan == null) return;
            StartSelectionMode(SelectionMode.ChuyenBan,
                $"Äang Chuyá»ƒn [BÃ n {_selectedBan.SoBan}]\n" +
                $"Vui lÃ²ng chá»n má»™t [BÃ n Trá»‘ng] lÃ m BÃ n ÄÃ­ch.");
        }

        private void BtnGopBan_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedBan == null) return;
            StartSelectionMode(SelectionMode.GopBan,
                $"Äang Gá»™p [BÃ n {_selectedBan.SoBan}]\n" +
                $"Vui lÃ²ng chá»n má»™t [BÃ n CÃ³ KhÃ¡ch] khÃ¡c lÃ m BÃ n ÄÃ­ch.");
        }

        private async Task HandleTableSelectionAsync(BanSoDoDto targetBan)
        {
            if (_selectedBan == null)
            {
                ResetForm();
                return;
            }
            int? idHoaDonNguon = _selectedBan.IdHoaDonHienTai;
            if (!idHoaDonNguon.HasValue)
            {
                MessageBox.Show("BÃ n nguá»“n khÃ´ng cÃ³ hÃ³a Ä‘Æ¡n Ä‘á»ƒ thao tÃ¡c.", "Lá»—i", MessageBoxButton.OK, MessageBoxImage.Error);
                ResetForm();
                return;
            }

            try
            {
                HttpResponseMessage response;
                BanActionRequestDto request = new BanActionRequestDto
                {
                    IdHoaDonNguon = idHoaDonNguon.Value
                };

                if (_currentMode == SelectionMode.ChuyenBan)
                {
                    if (targetBan.TrangThai != "Trá»‘ng")
                    {
                        MessageBox.Show($"BÃ n Ä‘Ã­ch [{targetBan.SoBan}] pháº£i lÃ  [BÃ n Trá»‘ng].", "Chá»n sai bÃ n", MessageBoxButton.OK, MessageBoxImage.Warning);
                        return;
                    }
                    request.IdBanDich = targetBan.IdBan;
                    response = await httpClient.PostAsJsonAsync("api/app/sodoban/move-table", request);
                }
                else // (mode == SelectionMode.GopBan)
                {
                    if (targetBan.TrangThai != "CÃ³ khÃ¡ch")
                    {
                        MessageBox.Show($"BÃ n Ä‘Ã­ch [{targetBan.SoBan}] pháº£i lÃ  [BÃ n CÃ³ KhÃ¡ch].", "Chá»n sai bÃ n", MessageBoxButton.OK, MessageBoxImage.Warning);
                        return;
                    }
                    if (targetBan.IdBan == _selectedBan.IdBan)
                    {
                        MessageBox.Show("KhÃ´ng thá»ƒ gá»™p bÃ n vÃ o chÃ­nh nÃ³.", "Chá»n sai bÃ n", MessageBoxButton.OK, MessageBoxImage.Warning);
                        return;
                    }
                    request.IdHoaDonDich = targetBan.IdHoaDonHienTai;
                    response = await httpClient.PostAsJsonAsync("api/app/sodoban/merge-table", request);
                }

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show(
                        _currentMode == SelectionMode.ChuyenBan ? "Chuyá»ƒn bÃ n thÃ nh cÃ´ng!" : "Gá»™p bÃ n thÃ nh cÃ´ng!",
                        "ThÃ nh cÃ´ng", MessageBoxButton.OK, MessageBoxImage.Information);

                    await ReloadDataAsync();
                }
                else
                {
                    string error = await response.Content.ReadAsStringAsync();
                    MessageBox.Show($"Thao tÃ¡c tháº¥t báº¡i: {error}", "Lá»—i API", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i há»‡ thá»‘ng: {ex.Message}", "Lá»—i", MessageBoxButton.OK, MessageBoxImage.Error);
            }
            finally
            {
                ResetForm();
            }
        }

        private void ResetForm()
        {
            _selectedBan = null;

            panelDaChon.Visibility = Visibility.Collapsed;
            panelChonBan.Visibility = Visibility.Collapsed;
            panelChuaChon.Visibility = Visibility.Visible;

            _currentMode = SelectionMode.None;

            if (btnKhuVucAll != null) // ThÃªm kiá»ƒm tra null an toÃ n
            {
                btnKhuVucAll.IsChecked = true;
                UncheckOtherKhuVucButtons(btnKhuVucAll);
            }
            ApplyTableFilter(null);
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\ThanhToanView.xaml e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\ThanhToanView.xaml.cs
<Page x:Class="AppCafebookApi.View.nhanvien.pages.ThanhToanView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.nhanvien.pages"
      mc:Ignorable="d" 
      d:DesignHeight="720" d:DesignWidth="1150"
      Title="ThanhToanView" FontFamily="Segoe UI" Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="StatusRedBrush" Color="#EF5350"/>
        <Geometry x:Key="IconArrowRight">M10,6L8.59,7.41L13.17,12L8.59,16.59L10,18L16,12Z</Geometry>
        <Geometry x:Key="IconArrowRightAll">M5.59,7.41L10.18,12L5.59,16.59L7,18L13,12L7,6L5.59,7.41M16,6H18V18H16V6Z</Geometry>
        <Geometry x:Key="IconArrowLeft">M15.41,16.59L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.59Z</Geometry>
        <Geometry x:Key="IconArrowLeftAll">M18.41,16.59L13.82,12L18.41,7.41L17,6L11,12L17,18L18.41,16.59M6,6H8V18H6V6Z</Geometry>
        <Geometry x:Key="IconPrint">M19,8H5C3.34,8 2,9.34 2,11V17H6V21H18V17H22V11C22,9.34 20.66,8 19,8M16,19H8V14H16V19M19,12C18.45,12 18,11.55 18,11C18,10.45 18.45,10 19,10C19.55,10 20,10.45 20,11C20,11.55 19.55,12 19,12M18,3H6V7H18V3Z</Geometry>
        <Geometry x:Key="IconCheck">M9,20.42L2.79,14.21L4.21,12.79L9,17.58L19.79,6.79L21.21,8.21L9,20.42Z</Geometry>
        <Style x:Key="TransferButton" TargetType="Button">
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="Margin" Value="0,5"/>
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" CornerRadius="20">
                            <Path Data="{TemplateBinding Content}" Fill="{StaticResource DarkBrownBrush}" Width="20" Height="20" Stretch="Uniform"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#F5F5F5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="InvoiceExpander" TargetType="Expander">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Expander">
                        <Border BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" Background="{TemplateBinding Background}" CornerRadius="8">
                            <DockPanel>
                                <ToggleButton x:Name="HeaderSite" DockPanel.Dock="Top" IsChecked="{Binding IsExpanded, RelativeSource={RelativeSource TemplatedParent}}" Style="{DynamicResource ExpanderHeaderToggleButton}"/>
                                <ContentPresenter x:Name="ExpandSite" DockPanel.Dock="Bottom" Visibility="Collapsed"/>
                            </DockPanel>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsExpanded" Value="True">
                                <Setter TargetName="ExpandSite" Property="Visibility" Value="Visible"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="ExpanderHeaderToggleButton" TargetType="ToggleButton">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border Padding="12">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <ContentPresenter Grid.Column="0" Content="{Binding Header, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type Expander}}}" TextBlock.FontWeight="SemiBold" TextBlock.FontSize="15"/>
                                <Path x:Name="arrow" Grid.Column="1" Data="M7,10L12,15L17,10H7Z" Fill="{StaticResource TextGrayBrush}" VerticalAlignment="Center"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="arrow" Property="Data" Value="M7,15L12,10L17,15H7Z"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="380"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Padding="20">
            <StackPanel>
                <TextBlock x:Name="lblTieuDeThanhToan" Text="Thanh toÃ¡n cho BÃ n..." FontSize="22" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,20"/>

                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0">
                        <Expander Header="HÃ³a Ä‘Æ¡n gá»‘c (MÃ³n Äƒn)" Style="{StaticResource InvoiceExpander}" IsExpanded="True">
                            <DataGrid x:Name="dgGoc" AutoGenerateColumns="False" IsReadOnly="True" SelectionMode="Extended" CanUserAddRows="False" Background="Transparent" BorderThickness="0,1,0,0">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="TÃªn mÃ³n" Binding="{Binding TenSanPham}" Width="*" FontWeight="SemiBold"/>
                                    <DataGridTextColumn Header="SL" Binding="{Binding SoLuong}" Width="40"/>
                                    <DataGridTextColumn Header="ThÃ nh tiá»n" Binding="{Binding ThanhTien, StringFormat=N0}" Width="80"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Expander>

                        <Expander Header="Phá»¥ thu kháº£ dá»¥ng (TÃ¡ch cÃ¹ng mÃ³n)" Style="{StaticResource InvoiceExpander}" IsExpanded="True">
                            <ListBox x:Name="lbPhuThuKhaDung" SelectionMode="Multiple" Background="Transparent" BorderThickness="0,1,0,0" BorderBrush="{StaticResource BorderGrayBrush}">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <CheckBox Content="{Binding TenPhuThu}" Tag="{Binding IdPhuThu}" Margin="5"/>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Expander>
                    </StackPanel>

                    <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="15,0">
                        <Button x:Name="btnChuyenQua" Content="{StaticResource IconArrowRight}" ToolTip="TÃ¡ch mÃ³n/phá»¥ thu Ä‘Ã£ chá»n" Style="{StaticResource TransferButton}" Click="BtnChuyenQua_Click"/>
                        <Button x:Name="btnChuyenQuaTatCa" Content="{StaticResource IconArrowRightAll}" ToolTip="TÃ¡ch táº¥t cáº£ mÃ³n &amp; phá»¥ thu Ä‘Ã£ chá»n" Style="{StaticResource TransferButton}" Click="BtnChuyenQuaTatCa_Click"/>
                        <Button x:Name="btnChuyenLai" Content="{StaticResource IconArrowLeft}" ToolTip="Tráº£ láº¡i mÃ³n Ä‘Ã£ chá»n" Style="{StaticResource TransferButton}" Click="BtnChuyenLai_Click"/>
                        <Button x:Name="btnChuyenLaiTatCa" Content="{StaticResource IconArrowLeftAll}" ToolTip="Tráº£ láº¡i táº¥t cáº£" Style="{StaticResource TransferButton}" Click="BtnChuyenLaiTatCa_Click"/>
                    </StackPanel>

                    <StackPanel Grid.Column="2">
                        <Expander Header="HÃ³a Ä‘Æ¡n thanh toÃ¡n (MÃ³n Äƒn)" Style="{StaticResource InvoiceExpander}" IsExpanded="True">
                            <DataGrid x:Name="dgTach" AutoGenerateColumns="False" IsReadOnly="True" SelectionMode="Extended" CanUserAddRows="False" Background="Transparent" BorderThickness="0,1,0,0">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="TÃªn mÃ³n" Binding="{Binding TenSanPham}" Width="*" FontWeight="SemiBold"/>
                                    <DataGridTextColumn Header="SL" Binding="{Binding SoLuong}" Width="40"/>
                                    <DataGridTextColumn Header="ThÃ nh tiá»n" Binding="{Binding ThanhTien, StringFormat=N0}" Width="80"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Expander>

                        <Expander Header="Phá»¥ thu (Ãp dá»¥ng)" Style="{StaticResource InvoiceExpander}" IsExpanded="True">
                            <DataGrid x:Name="dgPhuThuTach" AutoGenerateColumns="False" IsReadOnly="True" SelectionMode="Extended" CanUserAddRows="False" Background="Transparent" BorderThickness="0,1,0,0">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="TÃªn Phá»¥ Thu" Binding="{Binding TenPhuThu}" Width="*" FontWeight="SemiBold"/>
                                    <DataGridTextColumn Header="Sá»‘ Tiá»n" Binding="{Binding SoTien, StringFormat=N0}" Width="80"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Expander>
                    </StackPanel>
                </Grid>
            </StackPanel>
        </Border>

        <Border Grid.Column="1" Background="{StaticResource PrimaryBrownBrush}" Padding="25">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto" Margin="0,0,0,10">
                    <StackPanel>
                        <TextBlock Text="Cáº§n thanh toÃ¡n:" FontSize="18" Foreground="{StaticResource WhiteTextBrush}" Opacity="0.8"/>
                        <TextBlock x:Name="lblTienCanThanhToan" Text="0 Ä‘" FontSize="42" FontWeight="Bold" Foreground="{StaticResource WhiteTextBrush}" Margin="0,0,0,15"/>

                        <TextBlock Text="TÃ¬m khÃ¡ch hÃ ng (SÄT/Email/TÃªn):" Foreground="{StaticResource WhiteTextBrush}" Opacity="0.8"/>
                        <ComboBox x:Name="cmbTimKhachHang"
                                  IsEditable="True"
                                  IsTextSearchEnabled="True"
                                  TextBoxBase.TextChanged="CmbTimKhachHang_TextChanged"
                                  SelectionChanged="CmbTimKhachHang_SelectionChanged"
                                  DisplayMemberPath="DisplayText"
                                  SelectedValuePath="IdKhachHang"
                                  Margin="0,5,0,5" Padding="8" FontSize="14"/>

                        <Border x:Name="borderKhachHang" Background="White" Opacity="0.1" CornerRadius="8" Padding="10" Margin="0,5,0,10" Visibility="Collapsed">
                            <StackPanel>
                                <TextBlock x:Name="lblTenKhachHang" Text="KhÃ¡ch vÃ£ng lai" FontWeight="Bold" Foreground="White"/>
                                <TextBlock x:Name="lblDiemHienCo" Text="0 Ä‘iá»ƒm" Foreground="White" Opacity="0.8"/>
                            </StackPanel>
                        </Border>

                        <TextBlock Text="Ãp dá»¥ng khuyáº¿n mÃ£i:" Foreground="{StaticResource WhiteTextBrush}" Opacity="0.8"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Button Grid.Column="0" x:Name="btnChonKhuyenMai" Content="-- Chá»n Khuyáº¿n mÃ£i --" Margin="0,5,5,10" Padding="8" FontSize="14" Click="BtnChonKhuyenMai_Click"/>
                            <Button Grid.Column="1" x:Name="btnHuyKhuyenMai" Content="X" ToolTip="Gá»¡ bá»" Margin="0,5,0,10" Width="30" Background="{StaticResource StatusRedBrush}" Foreground="White" Click="BtnHuyKhuyenMai_Click" Visibility="Collapsed"/>
                        </Grid>

                        <TextBlock Text="Sá»­ dá»¥ng Ä‘iá»ƒm tÃ­ch lÅ©y:" Foreground="{StaticResource WhiteTextBrush}" Opacity="0.8"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox x:Name="txtDiemSuDung" Grid.Column="0" Margin="0,5,5,15" Padding="8" FontSize="14" TextChanged="TxtDiemSuDung_TextChanged" IsEnabled="False"/>
                            <Button x:Name="btnApDungDiem" Grid.Column="1" Content="DÃ¹ng" Margin="0,5,0,15" Width="50" Click="BtnApDungDiem_Click" IsEnabled="False"/>
                        </Grid>

                        <Grid Margin="0,0,0,5">
                            <TextBlock Text="Giáº£m giÃ¡ (KM):" FontSize="15" VerticalAlignment="Center" Foreground="{StaticResource WhiteTextBrush}" Opacity="0.8"/>
                            <TextBlock x:Name="lblTienGiamKM" Text="- 0 Ä‘" FontSize="15" Foreground="#A5D6A7" FontWeight="SemiBold" HorizontalAlignment="Right"/>
                        </Grid>
                        <Grid Margin="0,0,0,15">
                            <TextBlock Text="Giáº£m giÃ¡ (Äiá»ƒm):" FontSize="15" VerticalAlignment="Center" Foreground="{StaticResource WhiteTextBrush}" Opacity="0.8"/>
                            <TextBlock x:Name="lblTienGiamDiem" Text="- 0 Ä‘" FontSize="15" Foreground="#A5D6A7" FontWeight="SemiBold" HorizontalAlignment="Right"/>
                        </Grid>

                        <Separator Background="#FFFFFF" Opacity="0.2"/>
                        <Grid Margin="0,10,0,10">
                            <TextBlock Text="ThÃ nh tiá»n:" FontSize="18" FontWeight="Bold" VerticalAlignment="Center" Foreground="{StaticResource WhiteTextBrush}"/>
                            <TextBlock x:Name="lblThanhTien" Text="0 Ä‘" FontSize="20" FontWeight="Bold" Foreground="{StaticResource WhiteTextBrush}" HorizontalAlignment="Right"/>
                        </Grid>
                    </StackPanel>
                </ScrollViewer>

                <Border Grid.Row="1" Background="#FFFFFF" CornerRadius="8" Padding="15" VerticalAlignment="Top" Margin="0,0,0,10">
                    <StackPanel>
                        <TextBlock Text="PHÆ¯Æ NG THá»¨C THANH TOÃN" FontSize="12" FontWeight="Bold" Foreground="{StaticResource TextGrayBrush}" Margin="0,0,0,10"/>
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <RadioButton x:Name="rbTienMat" Grid.Row="0" Grid.Column="0" Content="Tiá»n máº·t" IsChecked="True" GroupName="PaymentMethod" Checked="PaymentMethod_Changed" Margin="0,0,0,5"/>
                            <RadioButton x:Name="rbChuyenKhoan" Grid.Row="0" Grid.Column="1" Content="Chuyá»ƒn khoáº£n" GroupName="PaymentMethod" Checked="PaymentMethod_Changed" Margin="0,0,0,5"/>
                            <RadioButton x:Name="rbThe" Grid.Row="1" Grid.Column="0" Content="Tháº»" GroupName="PaymentMethod" Checked="PaymentMethod_Changed"/>
                            <RadioButton x:Name="rbViDienTu" Grid.Row="1" Grid.Column="1" Content="VÃ­ Ä‘iá»‡n tá»­" GroupName="PaymentMethod" Checked="PaymentMethod_Changed"/>
                        </Grid>

                        <StackPanel x:Name="panelTienMat" Margin="0,15,0,0">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <Label Grid.Row="0" Grid.Column="0" Content="KhÃ¡ch Ä‘Æ°a:" FontSize="15" VerticalAlignment="Center" Margin="0,0,10,10"/>
                                <TextBox Grid.Row="0" Grid.Column="1" x:Name="txtKhachDua" FontSize="18" FontWeight="SemiBold" TextChanged="TxtKhachDua_TextChanged" TextAlignment="Right" Padding="5"/>
                                <Label Grid.Row="1" Grid.Column="0" Content="Tiá»n thá»«a:" FontSize="15" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                <TextBlock Grid.Row="1" Grid.Column="1" x:Name="lblTienThua" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource ActionBlueBrush}" VerticalAlignment="Center" Text="0 Ä‘" HorizontalAlignment="Right"/>
                            </Grid>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <StackPanel Grid.Row="2" VerticalAlignment="Bottom">
                    <Button x:Name="btnInTamTinh" Padding="12" Margin="0,10,0,0" Background="{StaticResource WhiteTextBrush}" Foreground="{StaticResource DarkBrownBrush}" Click="BtnInTamTinh_Click">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,10,0" VerticalAlignment="Center">
                                <Path Data="{StaticResource IconPrint}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="In Táº¡m tÃ­nh" VerticalAlignment="Center" FontWeight="SemiBold" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>

                    <Button x:Name="btnXacNhanThanhToan" Padding="15" Margin="0,10,0,0" FontSize="16" FontWeight="Bold" Background="{StaticResource ActionGreenBrush}" Foreground="{StaticResource WhiteTextBrush}" Click="BtnXacNhanThanhToan_Click">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,10,0" VerticalAlignment="Center">
                                <Path Data="{StaticResource IconCheck}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="XÃC NHáº¬N THANH TOÃN" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>

                    <Button x:Name="btnQuayLai" Padding="10" Margin="0,20,0,0" Background="Transparent" BorderThickness="0" Foreground="{StaticResource WhiteTextBrush}" Opacity="0.7" Cursor="Hand" Click="BtnQuayLai_Click">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="15" Height="15" Margin="0,0,8,0" VerticalAlignment="Center">
                                <Path Data="{StaticResource IconArrowLeft}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Quay láº¡i Gá»i mÃ³n" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\pages\ThanhToanView.xaml.cs
using CafebookModel.Model.ModelApp.NhanVien;
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Text.Json;
using CafebookModel.Model.Entities; // ThÃªm
using AppCafebookApi.View.common; // ThÃªm
using System.Windows.Media; // Sá»¬A Lá»–I CS0103
using AppCafebookApi.Services; // ThÃªm cho AuthService

namespace AppCafebookApi.View.nhanvien.pages
{
    public partial class ThanhToanView : Page
    {
        private readonly int _idHoaDonGoc;
        private static readonly HttpClient _httpClient;
        private bool _isDataLoading = true;

        // DÃ¹ng 4 Collection Ä‘á»ƒ quáº£n lÃ½
        private ObservableCollection<ChiTietDto> _itemsGoc = new ObservableCollection<ChiTietDto>();
        private ObservableCollection<ChiTietDto> _itemsTach = new ObservableCollection<ChiTietDto>();
        private ObservableCollection<PhuThuDto> _phuThuTach = new ObservableCollection<PhuThuDto>();

        private List<PhuThu> _phuThusKhaDung = new List<PhuThu>();
        private List<KhachHangTimKiemDto> _allKhachHangs = new List<KhachHangTimKiemDto>();

        // Sá»¬A Lá»–I CS0103: ThÃªm danh sÃ¡ch KM
        private List<KhuyenMaiDto> _availableKms = new List<KhuyenMaiDto>();

        // Tráº¡ng thÃ¡i thanh toÃ¡n
        private HoaDonInfoDto _hoaDonInfo = null!;
        private KhachHang? _currentKhachHang = null;
        private int? _currentKhuyenMaiId = null;
        private decimal _currentTienGocTach = 0;
        private decimal _currentTienPhuThuTach = 0;
        private decimal _currentGiamGiaKM = 0;
        private decimal _currentGiamGiaDiem = 0;
        private int _currentDiemSuDung = 0;
        private decimal _currentThanhTienTach = 0;
        private string _currentPhuongThuc = "Tiá»n máº·t";

        // Quy Ä‘á»‹nh Ä‘iá»ƒm
        private decimal _tiLeDoiDiem = 1000m;
        private decimal _tiLeNhanDiem = 10000m;

        // ThÃ´ng tin quÃ¡n
        private string _tenQuan = "", _diaChi = "", _sdt = "", _wifi = "";

        static ThanhToanView()
        {
            _httpClient = new HttpClient { BaseAddress = new Uri("http://localhost:5166") };
        }

        // Sá»¬A: Chá»‰ nháº­n ID HÃ³a Ä‘Æ¡n (theo logic má»›i)
        public ThanhToanView(int idHoaDon)
        {
            InitializeComponent();
            _idHoaDonGoc = idHoaDon;

            dgGoc.ItemsSource = _itemsGoc;
            dgTach.ItemsSource = _itemsTach;
            dgPhuThuTach.ItemsSource = _phuThuTach;
            lbPhuThuKhaDung.ItemsSource = _phuThusKhaDung;
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadDataAsync();
        }

        private async Task LoadDataAsync()
        {
            _isDataLoading = true;
            try
            {
                var response = await _httpClient.GetFromJsonAsync<ThanhToanViewDto>($"api/app/nhanvien/thanhtoan/load/{_idHoaDonGoc}");
                if (response == null)
                {
                    MessageBox.Show("KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u thanh toÃ¡n.");
                    return;
                }

                _hoaDonInfo = response.HoaDonInfo;
                lblTieuDeThanhToan.Text = $"Thanh toÃ¡n cho {response.HoaDonInfo.SoBan} - HÄ #{response.HoaDonInfo.IdHoaDon}";

                _itemsGoc.Clear();
                _itemsTach.Clear();
                response.ChiTietItems.ForEach(item => _itemsGoc.Add(item));

                _phuThuTach.Clear();
                response.PhuThusDaApDung.ForEach(pt => _phuThuTach.Add(pt));

                _phuThusKhaDung = response.PhuThusKhaDung;
                lbPhuThuKhaDung.ItemsSource = _phuThusKhaDung;

                // Sá»¬A Lá»–I CS1061: Táº£i KhÃ¡ch hÃ ng (ComboBox)
                _allKhachHangs = response.KhachHangsList;
                cmbTimKhachHang.ItemsSource = _allKhachHangs;
                _currentKhachHang = response.KhachHang;
                if (_currentKhachHang != null)
                {
                    cmbTimKhachHang.SelectedValue = _currentKhachHang.IdKhachHang;
                }

                _tiLeDoiDiem = response.DiemTichLuy_DoiVND;
                _tiLeNhanDiem = response.DiemTichLuy_NhanVND;

                // LÆ°u thÃ´ng tin quÃ¡n
                _tenQuan = response.TenQuan;
                _diaChi = response.DiaChi;
                _sdt = response.SoDienThoai;
                _wifi = response.WifiMatKhau;

                UpdateKhachHangUI();

                // YÃŠU Cáº¦U: Táº£i KM Ä‘Ã£ lÆ°u
                _currentKhuyenMaiId = response.IdKhuyenMaiDaApDung;
                await UpdateKhuyenMaiUI(); // Táº£i tÃªn KM vÃ  cáº­p nháº­t nÃºt

                txtDiemSuDung.Text = "0";

                UpdateTachTotals();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i dá»¯ liá»‡u: {ex.Message}", "Lá»—i nghiÃªm trá»ng");
            }
            _isDataLoading = false;
        }

        #region Logic TÃ¡ch/Gá»™p

        private void BtnChuyenQua_Click(object sender, RoutedEventArgs e)
        {
            var selectedItems = dgGoc.SelectedItems.Cast<ChiTietDto>().ToList();
            foreach (var selected in selectedItems)
            {
                _itemsGoc.Remove(selected);
                _itemsTach.Add(selected);
            }

            // Chuyá»ƒn Phá»¥ Thu (láº¥y tá»« cÃ¡c CheckBox Ä‘Ã£ chá»n)
            foreach (var item in lbPhuThuKhaDung.SelectedItems)
            {
                var phuThu = item as PhuThu;
                if (phuThu != null && !_phuThuTach.Any(p => p.IdPhuThu == phuThu.IdPhuThu))
                {
                    _phuThuTach.Add(new PhuThuDto
                    {
                        IdPhuThu = phuThu.IdPhuThu,
                        TenPhuThu = phuThu.TenPhuThu,
                        LoaiGiaTri = phuThu.LoaiGiaTri,
                        GiaTri = phuThu.GiaTri
                    });
                }
            }
            lbPhuThuKhaDung.UnselectAll(); // Bá» chá»n sau khi chuyá»ƒn
            UpdateTachTotals();
        }

        // Sá»¬A THEO YÃŠU Cáº¦U
        private void BtnChuyenQuaTatCa_Click(object sender, RoutedEventArgs e)
        {
            // 1. Chuyá»ƒn táº¥t cáº£ mÃ³n
            foreach (var item in _itemsGoc.ToList()) _itemsTach.Add(item);
            _itemsGoc.Clear();

            // 2. Chá»‰ chuyá»ƒn phá»¥ thu ÄÃƒ CHá»ŒN
            foreach (var item in lbPhuThuKhaDung.SelectedItems)
            {
                var phuThu = item as PhuThu;
                if (phuThu != null && !_phuThuTach.Any(p => p.IdPhuThu == phuThu.IdPhuThu))
                {
                    _phuThuTach.Add(new PhuThuDto
                    {
                        IdPhuThu = phuThu.IdPhuThu,
                        TenPhuThu = phuThu.TenPhuThu,
                        LoaiGiaTri = phuThu.LoaiGiaTri,
                        GiaTri = phuThu.GiaTri
                    });
                }
            }
            lbPhuThuKhaDung.UnselectAll(); // Bá» chá»n

            UpdateTachTotals(); // Tá»± Ä‘á»™ng tÃ­nh toÃ¡n láº¡i KM
        }

        private void BtnChuyenLai_Click(object sender, RoutedEventArgs e)
        {
            var selectedItems = dgTach.SelectedItems.Cast<ChiTietDto>().ToList();
            foreach (var selected in selectedItems)
            {
                _itemsTach.Remove(selected);
                _itemsGoc.Add(selected);
            }

            var selectedPhuThus = dgPhuThuTach.SelectedItems.Cast<PhuThuDto>().ToList();
            foreach (var selected in selectedPhuThus)
            {
                _phuThuTach.Remove(selected);
            }
            UpdateTachTotals();
        }

        private void BtnChuyenLaiTatCa_Click(object sender, RoutedEventArgs e)
        {
            foreach (var item in _itemsTach.ToList()) _itemsGoc.Add(item);
            _itemsTach.Clear();
            _phuThuTach.Clear();
            UpdateTachTotals();
        }

        #endregion

        #region Logic TÃ­nh ToÃ¡n Panel Pháº£i

        private void UpdateTachTotals()
        {
            if (_isDataLoading || lblTienCanThanhToan == null) return;

            _currentTienGocTach = _itemsTach.Sum(i => i.ThanhTien);

            _currentTienPhuThuTach = 0;
            foreach (var pt in _phuThuTach)
            {
                if (string.Equals(pt.LoaiGiaTri, "%", StringComparison.OrdinalIgnoreCase) || string.Equals(pt.LoaiGiaTri, "PhanTram", StringComparison.OrdinalIgnoreCase))
                {
                    pt.SoTien = _currentTienGocTach * (pt.GiaTri / 100);
                }
                else
                {
                    pt.SoTien = pt.GiaTri;
                }
                _currentTienPhuThuTach += pt.SoTien;
            }
            dgPhuThuTach.Items.Refresh();

            decimal tongTruocGiam = _currentTienGocTach + _currentTienPhuThuTach;
            lblTienCanThanhToan.Text = tongTruocGiam.ToString("N0") + " Ä‘";

            _currentGiamGiaKM = 0;
            if (_currentKhuyenMaiId.HasValue && _currentKhuyenMaiId > 0)
            {
                try
                {
                    // Sá»¬A Lá»–I CS0103: DÃ¹ng _availableKms
                    var km = _availableKms.FirstOrDefault(k => k.IdKhuyenMai == _currentKhuyenMaiId);
                    if (km != null)
                    {
                        if (string.Equals(km.LoaiGiamGia, "PhanTram", StringComparison.OrdinalIgnoreCase))
                        {
                            _currentGiamGiaKM = _currentTienGocTach * (km.GiaTriGiam / 100);
                        }
                        else
                        {
                            _currentGiamGiaKM = km.GiaTriGiam;
                        }
                    }
                }
                catch { }
            }
            lblTienGiamKM.Text = $"- {_currentGiamGiaKM:N0} Ä‘";

            int.TryParse(txtDiemSuDung.Text, out _currentDiemSuDung);
            _currentGiamGiaDiem = _currentDiemSuDung * _tiLeDoiDiem;
            lblTienGiamDiem.Text = $"- {_currentGiamGiaDiem:N0} Ä‘";

            _currentThanhTienTach = tongTruocGiam - _currentGiamGiaKM - _currentGiamGiaDiem;
            if (_currentThanhTienTach < 0) _currentThanhTienTach = 0;
            lblThanhTien.Text = _currentThanhTienTach.ToString("N0") + " Ä‘";

            UpdateTienThua();
        }

        // Sá»¬A Lá»–I CS1061: ThÃªm hÃ m nÃ y
        private void TxtKhachDua_TextChanged(object sender, TextChangedEventArgs e)
        {
            UpdateTienThua();
        }

        private void UpdateTienThua()
        {
            if (lblTienThua == null) return;

            if (decimal.TryParse(txtKhachDua.Text, out decimal khachDua))
            {
                decimal tienThua = khachDua - _currentThanhTienTach;
                lblTienThua.Text = tienThua.ToString("N0") + " Ä‘";
            }
            else
            {
                lblTienThua.Text = (0 - _currentThanhTienTach).ToString("N0") + " Ä‘";
            }
        }

        // Sá»¬A Lá»–I CS1061: ThÃªm hÃ m nÃ y
        private void TxtDiemSuDung_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (_isDataLoading) return;

            if (int.TryParse(txtDiemSuDung.Text, out int diem) && _currentKhachHang != null)
            {
                if (diem > _currentKhachHang.DiemTichLuy)
                {
                    diem = _currentKhachHang.DiemTichLuy;
                    txtDiemSuDung.Text = diem.ToString();
                }

                decimal giamTuDiem = diem * _tiLeDoiDiem;
                decimal tongTruocDiem = _currentTienGocTach + _currentTienPhuThuTach - _currentGiamGiaKM;

                if (giamTuDiem > tongTruocDiem)
                {
                    int diemToiDa = (int)Math.Floor(tongTruocDiem / _tiLeDoiDiem);
                    txtDiemSuDung.Text = diemToiDa.ToString();
                }
            }
            UpdateTachTotals();
        }

        private void PaymentMethod_Changed(object sender, RoutedEventArgs e)
        {
            // Sá»¬A Lá»–I NullReferenceException
            if (panelTienMat == null || rbTienMat == null || rbChuyenKhoan == null || rbThe == null || rbViDienTu == null)
            {
                return;
            }

            if (rbTienMat.IsChecked == true)
            {
                panelTienMat.Visibility = Visibility.Visible;
                _currentPhuongThuc = "Tiá»n máº·t";
            }
            else
            {
                panelTienMat.Visibility = Visibility.Collapsed;
                if (rbChuyenKhoan.IsChecked == true) _currentPhuongThuc = "Chuyá»ƒn khoáº£n";
                else if (rbThe.IsChecked == true) _currentPhuongThuc = "Tháº»";
                else if (rbViDienTu.IsChecked == true) _currentPhuongThuc = "VÃ­ Ä‘iá»‡n tá»­";
            }
        }

        #endregion

        #region Logic KhÃ¡ch hÃ ng & Äiá»ƒm

        // Sá»¬A Lá»–I CS1061: ThÃªm hÃ m nÃ y
        private void CmbTimKhachHang_TextChanged(object sender, TextChangedEventArgs e)
        {
            // Chá»‰ lá»c khi ngÆ°á»i dÃ¹ng gÃµ, khÃ´ng lá»c khi chá»n
            if (cmbTimKhachHang.IsDropDownOpen)
            {
                string query = cmbTimKhachHang.Text.ToLower();
                if (string.IsNullOrEmpty(query))
                {
                    cmbTimKhachHang.ItemsSource = _allKhachHangs;
                }
                else
                {
                    cmbTimKhachHang.ItemsSource = _allKhachHangs
                        .Where(kh => kh.DisplayText.ToLower().Contains(query))
                        .ToList();
                }
            }
        }

        // Sá»¬A Lá»–I CS1061: ThÃªm hÃ m nÃ y
        private void CmbTimKhachHang_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (cmbTimKhachHang.SelectedItem is KhachHangTimKiemDto selected)
            {
                _currentKhachHang = selected.KhachHangData;
            }
            else
            {
                _currentKhachHang = null;
            }
            UpdateKhachHangUI();
        }

        private void BtnTimKhachHang_Click(object sender, RoutedEventArgs e)
        {
            // (KhÃ´ng cáº§n ná»¯a, ComboBox tá»± xá»­ lÃ½)
        }

        private void UpdateKhachHangUI()
        {
            if (_currentKhachHang != null)
            {
                borderKhachHang.Visibility = Visibility.Visible;
                lblTenKhachHang.Text = _currentKhachHang.HoTen;
                // Sá»¬A Lá»–I HIá»‚N THá»Š ÄIá»‚M
                lblDiemHienCo.Text = $"{_currentKhachHang.DiemTichLuy} Ä‘iá»ƒm (TÆ°Æ¡ng Ä‘Æ°Æ¡ng {_currentKhachHang.DiemTichLuy * _tiLeDoiDiem:N0} Ä‘)";
                txtDiemSuDung.IsEnabled = true;
                btnApDungDiem.IsEnabled = true;
            }
            else
            {
                borderKhachHang.Visibility = Visibility.Collapsed;
                txtDiemSuDung.IsEnabled = false;
                btnApDungDiem.IsEnabled = false;
                txtDiemSuDung.Text = "0";
            }
            UpdateTachTotals();
        }

        private void BtnApDungDiem_Click(object sender, RoutedEventArgs e)
        {
            TxtDiemSuDung_TextChanged(sender, null!);
        }

        #endregion

        #region Logic Khuyáº¿n MÃ£i (Cá»­a sá»• má»›i)

        // Sá»¬A Lá»–I JsonException: Táº£i danh sÃ¡ch KM tá»« API (náº¿u chÆ°a cÃ³)
        private async Task LoadAvailableKms()
        {
            if (_availableKms.Any()) return; // Chá»‰ táº£i 1 láº§n

            try
            {
                // Sá»¬A Lá»–I CS0103: GÃ¡n vÃ o _availableKms
                var kms = await _httpClient.GetFromJsonAsync<List<KhuyenMaiHienThiDto>>($"api/app/nhanvien/khuyenmai/available/{_idHoaDonGoc}");
                _availableKms = kms?.Select(k => new KhuyenMaiDto
                {
                    IdKhuyenMai = k.IdKhuyenMai,
                    TenKhuyenMai = k.TenChuongTrinh,
                    LoaiGiamGia = k.LoaiGiamGia, // Sá»­a: DÃ¹ng LoaiGiamGia (theo DTO)
                    GiaTriGiam = k.GiaTriGiam
                }).ToList() ?? new List<KhuyenMaiDto>();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"KhÃ´ng thá»ƒ táº£i danh sÃ¡ch KM: {ex.Message}");
                _availableKms = new List<KhuyenMaiDto>();
            }
        }

        // Cáº­p nháº­t UI nÃºt KM
        private async Task UpdateKhuyenMaiUI()
        {
            await LoadAvailableKms(); // Äáº£m báº£o danh sÃ¡ch Ä‘Ã£ Ä‘Æ°á»£c táº£i

            if (_currentKhuyenMaiId.HasValue && _currentKhuyenMaiId > 0)
            {
                // Sá»¬A Lá»–I CS0103: DÃ¹ng _availableKms
                var km = _availableKms.FirstOrDefault(k => k.IdKhuyenMai == _currentKhuyenMaiId);
                if (km == null)
                {
                    btnChonKhuyenMai.Content = "KM Ä‘Ã£ lÆ°u (khÃ´ng há»£p lá»‡)";
                }
                else
                {
                    btnChonKhuyenMai.Content = km.TenKhuyenMai;
                }
                btnHuyKhuyenMai.Visibility = Visibility.Visible;
            }
            else
            {
                btnChonKhuyenMai.Content = "-- Chá»n Khuyáº¿n mÃ£i --";
                btnHuyKhuyenMai.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnChonKhuyenMai_Click(object sender, RoutedEventArgs e)
        {
            await LoadAvailableKms();

            var dialog = new ChonKhuyenMaiWindow(_idHoaDonGoc, _currentKhuyenMaiId);
            if (dialog.ShowDialog() == true)
            {
                _currentKhuyenMaiId = dialog.SelectedId;
                if (_currentKhuyenMaiId == 0) _currentKhuyenMaiId = null;

                await UpdateKhuyenMaiUI();
                UpdateTachTotals();
            }
        }

        private void BtnHuyKhuyenMai_Click(object sender, RoutedEventArgs e)
        {
            _currentKhuyenMaiId = null;
            btnChonKhuyenMai.Content = "-- Chá»n Khuyáº¿n mÃ£i --";
            btnHuyKhuyenMai.Visibility = Visibility.Collapsed;
            UpdateTachTotals();
        }

        #endregion

        private async void BtnXacNhanThanhToan_Click(object sender, RoutedEventArgs e)
        {
            if (!_itemsTach.Any())
            {
                MessageBox.Show("Vui lÃ²ng chuyá»ƒn Ã­t nháº¥t 1 mÃ³n qua 'HÃ³a Ä‘Æ¡n thanh toÃ¡n'.", "ChÆ°a chá»n mÃ³n");
                return;
            }

            decimal.TryParse(txtKhachDua.Text, out decimal khachDua);
            if (_currentPhuongThuc == "Tiá»n máº·t" && khachDua < _currentThanhTienTach)
            {
                MessageBox.Show("Tiá»n khÃ¡ch Ä‘Æ°a khÃ´ng Ä‘á»§.", "Thiáº¿u tiá»n", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            var request = new ThanhToanRequestDto
            {
                IdHoaDonGoc = _idHoaDonGoc,
                IdChiTietTach = _itemsTach.Select(i => i.IdChiTietHoaDon).ToList(),
                IdPhuThuTach = _phuThuTach.Select(p => p.IdPhuThu).ToList(),
                IdKhuyenMai = _currentKhuyenMaiId,
                PhuongThucThanhToan = _currentPhuongThuc,
                KhachDua = khachDua,
                DiemSuDung = _currentDiemSuDung,
                IdKhachHang = _currentKhachHang?.IdKhachHang
            };

            btnXacNhanThanhToan.IsEnabled = false;
            try
            {
                var response = await _httpClient.PostAsJsonAsync("api/app/nhanvien/thanhtoan/pay", request);
                if (response.IsSuccessStatusCode)
                {
                    var jsonDoc = JsonDocument.Parse(await response.Content.ReadAsStringAsync());
                    bool isFullPayment = jsonDoc.RootElement.GetProperty("isFullPayment").GetBoolean();

                    MessageBox.Show("Thanh toÃ¡n thÃ nh cÃ´ng!", "ThÃ nh cÃ´ng");

                    // (Logic má»Ÿ cá»­a sá»• In HÃ³a Ä‘Æ¡n cuá»‘i cÃ¹ng (náº¿u cáº§n) cÃ³ thá»ƒ thÃªm á»Ÿ Ä‘Ã¢y)

                    if (isFullPayment)
                    {
                        var mainFrame = FindParentFrame();
                        if (mainFrame != null)
                        {
                            mainFrame.Navigate(new SoDoBanView());
                            while (mainFrame.CanGoBack)
                            {
                                mainFrame.RemoveBackEntry();
                            }
                        }
                    }
                    else
                    {
                        await LoadDataAsync();
                    }
                }
                else
                {
                    MessageBox.Show(await response.Content.ReadAsStringAsync(), "Lá»—i Thanh ToÃ¡n");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message, "Lá»—i API");
            }
            btnXacNhanThanhToan.IsEnabled = true;
        }

        private Frame? FindParentFrame()
        {
            var mainFrame = Application.Current.Windows.OfType<Window>()
                           .FirstOrDefault(w => w.Title == "NhanVienWindow")
                           ?.FindName("MainFrame") as Frame;
            return mainFrame;
        }

        // YÃŠU Cáº¦U: Má»Ÿ HoaDonPreviewWindow
        private void BtnInTamTinh_Click(object sender, RoutedEventArgs e)
        {
            var previewData = new HoaDonPreviewDto
            {
                IsProvisional = true,
                TenQuan = _tenQuan,
                DiaChi = _diaChi,
                SoDienThoai = _sdt,
                WifiMatKhau = _wifi,
                IdHoaDon = _idHoaDonGoc,
                SoBan = _hoaDonInfo.SoBan,
                ThoiGianTao = DateTime.Now,
                TenNhanVien = AuthService.CurrentUser?.HoTen ?? "NhÃ¢n viÃªn",
                TenKhachHang = _currentKhachHang?.HoTen ?? "KhÃ¡ch vÃ£ng lai",
                Items = _itemsTach.ToList(),
                Surcharges = _phuThuTach.ToList(),
                TongTienGoc = _currentTienGocTach,
                TongPhuThu = _currentTienPhuThuTach,
                GiamGiaKM = _currentGiamGiaKM,
                GiamGiaDiem = _currentGiamGiaDiem,
                ThanhTien = _currentThanhTienTach
            };

            var previewWindow = new HoaDonPreviewWindow(previewData);
            previewWindow.ShowDialog();
        }

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }

        // Sá»¬A Lá»–I CS0103: ThÃªm hÃ m FindVisualChild
        private T? FindVisualChild<T>(DependencyObject? obj) where T : DependencyObject
        {
            if (obj == null) return null;
            for (int i = 0; i < VisualTreeHelper.GetChildrenCount(obj); i++)
            {
                DependencyObject child = VisualTreeHelper.GetChild(obj, i);
                if (child != null && child is T)
                    return (T)child;
                else
                {
                    T? childOfChild = FindVisualChild<T>(child);
                    if (childOfChild != null)
                        return childOfChild;
                }
            }
            return null;
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\ManHinhNhanVien.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\ManHinhNhanVien.xaml
<Window x:Class="AppCafebookApi.View.nhanvien.ManHinhNhanVien"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AppCafebookApi.View.nhanvien"
        mc:Ignorable="d"
        Title="Cafebook - Copyright by Â© LÃ¢m Chu Báº£o ToÃ n | Contact:[lamchubaotoan@gmail.com]" Height="800" Width="1440"
        Icon="/Assets/logo.ico"        
        WindowStartupLocation="CenterScreen"
        FontFamily="Segoe UI"
        WindowState="Maximized">

    <Window.Resources>
        <!-- Báº£ng mÃ u thá»‘ng nháº¥t -->
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="SubtleWhiteTextBrush" Color="#BCAAA4"/>
        <SolidColorBrush x:Key="HoverBrownBrush" Color="#8D6E63"/>

        <!-- Bá»™ Icons -->
        <Geometry x:Key="IconDashboard">M13,3V9H21V3M13,21H21V11H13M3,21H11V15H3M3,13H11V3H3V13Z</Geometry>
        <Geometry x:Key="IconBooking">M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1M17,12H12V17H17V12Z</Geometry>
        <Geometry x:Key="IconProfile">M12,12A5,5 0 0,1 7,7A5,5 0 0,1 12,2A5,5 0 0,1 17,7A5,5 0 0,1 12,12M12,14C14.67,14 20,15.33 20,18V20H4V18C4,15.33 9.33,14 12,14Z</Geometry>
        <Geometry x:Key="IconClock">M12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z</Geometry>
        <Geometry x:Key="IconLogout">M16,17V14H9V12H16V9L20,13L16,17M14,2A2,2 0 0,1 16,4V6H14V4H5V20H14V18H16V20A2,2 0 0,1 14,22H5A2,2 0 0,1 3,20V4A2,2 0 0,1 5,2H14Z</Geometry>

        <!-- Style cho cÃ¡c nÃºt Ä‘iá»u hÆ°á»›ng chÃ­nh, giá»‘ng há»‡t ManHinhAdmin -->
        <Style x:Key="NavToggleButton" TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource SubtleWhiteTextBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Padding" Value="20,12"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="border" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" CornerRadius="5" Margin="8,2">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Border x:Name="indicator" Width="4" Height="20" Background="Transparent" CornerRadius="2" VerticalAlignment="Center" Margin="-20,0,10,0"/>
                                <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,15,0">
                                    <Path Data="{Binding Path=Tag, RelativeSource={RelativeSource TemplatedParent}}" Fill="{TemplateBinding Foreground}" Stretch="Uniform" VerticalAlignment="Center"/>
                                </Viewbox>
                                <ContentPresenter Grid.Column="1" HorizontalAlignment="Left" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource HoverBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                                <Setter TargetName="indicator" Property="Background" Value="{StaticResource AccentOrangeBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Style cho cÃ¡c nÃºt á»Ÿ footer, giá»‘ng há»‡t ManHinhAdmin -->
        <Style x:Key="FooterButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource SubtleWhiteTextBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Padding" Value="20,12"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" CornerRadius="5" Margin="8,2">
                            <ContentPresenter/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource HoverBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="250"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Sidebar (Thanh Ä‘iá»u hÆ°á»›ng bÃªn trÃ¡i) -->
        <Border Grid.Column="0" Background="{StaticResource PrimaryBrownBrush}">
            <!-- Sá»­ dá»¥ng Grid 3 hÃ ng giá»‘ng mÃ n hÃ¬nh Admin -->
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <!-- Header: ThÃ´ng tin ngÆ°á»i dÃ¹ng -->
                    <RowDefinition Height="*"/>
                    <!-- Content: Menu Ä‘iá»u hÆ°á»›ng -->
                    <RowDefinition Height="Auto"/>
                    <!-- Footer: NÃºt Ä‘Äƒng xuáº¥t -->
                </Grid.RowDefinitions>

                <!-- Header: ThÃ´ng tin ngÆ°á»i dÃ¹ng -->
                <StackPanel Grid.Row="0" Margin="20">
                    <!-- Avatar Icon -->
                    <Border x:Name="AvatarBorder" 
                            Height="70" Width="70"
                            Background="{StaticResource LightCreamBrush}"
                            CornerRadius="35"
                            Margin="0,0,0,10">
                        <Viewbox Margin="12,10,18,20">
                            <Path Data="{StaticResource IconProfile}" Fill="{StaticResource PrimaryBrownBrush}">
                                <Path.RenderTransform>
                                    <TranslateTransform Y="1.5" />
                                </Path.RenderTransform>
                            </Path>
                        </Viewbox>
                    </Border>
                    <TextBlock x:Name="txtUserName" Text="TÃªn NhÃ¢n ViÃªn" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource WhiteTextBrush}" HorizontalAlignment="Center" TextWrapping="Wrap" TextAlignment="Center"/>
                    <TextBlock x:Name="txtUserRole" Text="NhÃ¢n viÃªn" FontSize="13" Foreground="{StaticResource SubtleWhiteTextBrush}" HorizontalAlignment="Center"/>
                </StackPanel>

                <!-- Content: Menu Ä‘iá»u hÆ°á»›ng trong ScrollViewer -->
                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <ToggleButton x:Name="btnSoDoBan" Content="SÆ¡ Ä‘á»“ bÃ n" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconDashboard}" Click="BtnSoDoBan_Click" IsChecked="True"/>
                        <ToggleButton x:Name="btnDatBanSach" Content="Quáº£n lÃ½ Äáº·t bÃ n" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconBooking}" Click="BtnDatBanSach_Click"/>

                        <Separator Margin="15,20" Background="{StaticResource HoverBrownBrush}"/>

                        <ToggleButton x:Name="btnThongTinCaNhan" Content="ThÃ´ng tin cÃ¡ nhÃ¢n" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconProfile}" Click="BtnThongTinCaNhan_Click"/>
                        <ToggleButton x:Name="btnChamCong" Content="Cháº¥m cÃ´ng" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconClock}" Click="BtnChamCong_Click"/>
                    </StackPanel>
                </ScrollViewer>

                <!-- Footer: NÃºt Ä‘Äƒng xuáº¥t -->
                <StackPanel Grid.Row="2" VerticalAlignment="Bottom" Margin="0,0,0,5">
                    <Separator Margin="15" Background="{StaticResource HoverBrownBrush}"/>
                    <Button x:Name="btnDangXuat" Style="{StaticResource FooterButton}" Click="BtnDangXuat_Click"
                             Background="{StaticResource AccentOrangeBrush}"
                             Foreground="{StaticResource WhiteTextBrush}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,15,0">
                                <Path Data="{StaticResource IconLogout}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="ÄÄƒng xuáº¥t" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Content (Ná»™i dung chÃ­nh) -->
        <Border Grid.Column="1" Background="{StaticResource LightCreamBrush}">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="2" Direction="270" Color="Black" Opacity="0.1" BlurRadius="10"/>
            </Border.Effect>
            <Frame x:Name="MainFrame" NavigationUIVisibility="Hidden"/>
        </Border>
    </Grid>
</Window>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\nhanvien\ManHinhNhanVien.xaml.cs
using AppCafebookApi.Services; // ThÃªm
using AppCafebookApi.View.nhanvien.pages; // <-- THÃŠM USING NÃ€Y
using CafebookModel.Utils; // ThÃªm
using System.Windows;
using System.Windows.Controls;
using System.Windows.Controls.Primitives; // ThÃªm
using System.Windows.Media; // ThÃªm
using System.Windows.Media.Imaging; // ThÃªm

namespace AppCafebookApi.View.nhanvien
{
    public partial class ManHinhNhanVien : Window
    {
        public ManHinhNhanVien()
        {
            InitializeComponent();
            // Sá»± kiá»‡n Loaded cÃ³ thá»ƒ Ä‘Æ°á»£c thÃªm tá»« XAML hoáº·c á»Ÿ Ä‘Ã¢y
            this.Loaded += ManHinhNhanVien_Loaded;
        }

        private void ManHinhNhanVien_Loaded(object sender, RoutedEventArgs e)
        {

            btnSoDoBan.IsChecked = true;
            NavigateToPage(btnSoDoBan, new SoDoBanView());

            var currentUser = AuthService.CurrentUser;
            if (currentUser != null)
            {
                // 1. Cáº­p nháº­t tÃªn vÃ  vai trÃ² (Báº¡n Ä‘Ã£ cÃ³)
                txtUserName.Text = currentUser.HoTen;
                txtUserRole.Text = currentUser.TenVaiTro;

                // 2. Cáº­p nháº­t Avatar (Báº¡n Ä‘Ã£ cÃ³)
                AvatarBorder.Child = null;
                BitmapImage avatarImage = HinhAnhHelper.LoadImage(
                    currentUser.AnhDaiDien,
                    HinhAnhPaths.DefaultAvatar
                );
                AvatarBorder.Background = new ImageBrush(avatarImage)
                {
                    Stretch = Stretch.UniformToFill
                };

                // --- 3. Báº®T Äáº¦U PHÃ‚N QUYá»€N CHá»¨C NÄ‚NG ---

                // Dá»±a trÃªn CSDL, 'Thu ngÃ¢n' vÃ  'Quáº£n lÃ½' cÃ³ quyá»n 'HoaDon.Tao'.
                // 'Pha cháº¿' vÃ  'Phá»¥c vá»¥' (tÃ i khoáº£n 'service') khÃ´ng cÃ³.
                // ChÃºng ta áº©n cÃ¡c nÃºt nghiá»‡p vá»¥ chÃ­nh náº¿u khÃ´ng cÃ³ quyá»n.
                if (!AuthService.CoQuyen("HoaDon.Tao", "HoaDon.ThanhToan"))
                {
                    btnSoDoBan.Visibility = Visibility.Collapsed;
                    btnDatBanSach.Visibility = Visibility.Collapsed;
                }

                // CÃ¡c nÃºt cÃ¡ nhÃ¢n (ThÃ´ng tin, Cháº¥m cÃ´ng) Ä‘Æ°á»£c giá»¯ láº¡i cho má»i ngÆ°á»i
            }


        }
        // --- Sá»¬A Láº I CÃC HÃ€M CLICK ÄIá»€U HÆ¯á»šNG ---

        private void UncheckOtherButtons(ToggleButton? exception)
        {
            var navButtons = new List<ToggleButton>
            {
                btnSoDoBan, btnDatBanSach, btnThongTinCaNhan, btnChamCong
            };

            foreach (var button in navButtons)
            {
                if (button != null && button != exception)
                {
                    button.IsChecked = false;
                }
            }
        }

        // HÃ m nÃ y giá» Ä‘Ã£ há»£p lá»‡ vÃ¬ 'Page' Ä‘Ã£ Ä‘Æ°á»£c 'using'
        private void NavigateToPage(ToggleButton? clickedButton, Page pageInstance)
        {
            if (clickedButton == null) return;
            UncheckOtherButtons(clickedButton);
            clickedButton.IsChecked = true;
            MainFrame.Navigate(pageInstance);
        }

        private void BtnSoDoBan_Click(object sender, RoutedEventArgs e)
        {
            NavigateToPage(sender as ToggleButton, new SoDoBanView());
        }

        private void BtnDatBanSach_Click(object sender, RoutedEventArgs e)
        {
            MessageBox.Show("Chá»©c nÄƒng 'Äáº·t BÃ n SÃ¡ch' Ä‘ang Ä‘Æ°á»£c phÃ¡t triá»ƒn.");

            // Sá»¬A Lá»–I CS8602: ThÃªm kiá»ƒm tra null
            if (sender is ToggleButton btn)
            {
                btn.IsChecked = false;
                btnSoDoBan.IsChecked = true; // Tráº£ vá» trang máº·c Ä‘á»‹nh
            }
        }

        private void BtnThongTinCaNhan_Click(object sender, RoutedEventArgs e)
        {
            MessageBox.Show("Chá»©c nÄƒng 'ThÃ´ng tin cÃ¡ nhÃ¢n' Ä‘ang Ä‘Æ°á»£c phÃ¡t triá»ƒn.");

            // Sá»¬A Lá»–I CS8602: ThÃªm kiá»ƒm tra null
            if (sender is ToggleButton btn)
            {
                btn.IsChecked = false;
                btnSoDoBan.IsChecked = true; // Tráº£ vá» trang máº·c Ä‘á»‹nh
            }
        }

        private void BtnChamCong_Click(object sender, RoutedEventArgs e)
        {
            MessageBox.Show("Chá»©c nÄƒng 'Cháº¥m cÃ´ng' Ä‘ang Ä‘Æ°á»£c phÃ¡t triá»ƒn.");

            // Sá»¬A Lá»–I CS8602: ThÃªm kiá»ƒm tra null
            if (sender is ToggleButton btn)
            {
                btn.IsChecked = false;
                btnSoDoBan.IsChecked = true; // Tráº£ vá» trang máº·c Ä‘á»‹nh
            }
        }

        // ... (HÃ m ÄÄƒng xuáº¥t)
        private void BtnDangXuat_Click(object sender, RoutedEventArgs e)
        {
            var result = MessageBox.Show("Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n Ä‘Äƒng xuáº¥t?",
                                         "XÃ¡c nháº­n Ä‘Äƒng xuáº¥t",
                                         MessageBoxButton.YesNo,
                                         MessageBoxImage.Question);

            if (result == MessageBoxResult.Yes)
            {
                AuthService.Logout();
                ManHinhDangNhap loginWindow = new ManHinhDangNhap();
                loginWindow.Show();
                this.Close();
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\BaoCaoNhanSuView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\BaoCaoNhanSuView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.BaoCaoNhanSuView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      xmlns:lvc="clr-namespace:LiveCharts.Wpf;assembly=LiveCharts.Wpf"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="BÃ¡o CÃ¡o &amp; Thá»‘ng KÃª NhÃ¢n Sá»±"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionOrangeBrush" Color="#FFA726"/>
        <SolidColorBrush x:Key="ActionPurpleBrush" Color="#AB47BC"/>
        <SolidColorBrush x:Key="WhiteText" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="AccentOrange" Color="#FF7043"/>
        <SolidColorBrush x:Key="PrimaryBrown" Color="#6F4E37"/>
        
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>
        <Geometry x:Key="IconGenerate">M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z</Geometry>
        <Geometry x:Key="IconExport">M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrown}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteText}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Height" Value="42"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                CornerRadius="21"
                                Background="{TemplateBinding Background}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="2" Color="#6F4E37" Opacity="0.3" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource AccentOrange}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="TabControl">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
        <Style TargetType="TabItem">
            <Setter Property="Background" Value="#E0E0E0"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border x:Name="border" BorderThickness="0,0,0,3" BorderBrush="Transparent" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" Margin="0,0,5,0">
                            <ContentPresenter ContentSource="Header" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="Background" Value="White"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
                                <Setter TargetName="border" Property="Background" Value="#F5F5F5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="KpiCard" TargetType="Border" BasedOn="{StaticResource CardBorder}">
            <Setter Property="Padding" Value="15"/>
            <Setter Property="Margin" Value="0,0,10,0"/>
        </Style>
        <Style x:Key="KpiValue" TargetType="TextBlock">
            <Setter Property="FontSize" Value="24"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>
        <Style x:Key="KpiTitle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
        </Style>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="BÃ¡o CÃ¡o &amp; Thá»‘ng KÃª NhÃ¢n Sá»±" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Border Grid.Row="1" Margin="10,0,10,10" Padding="15" Background="{StaticResource SubtleGrayBrush}" CornerRadius="4">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="130"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="130"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="200"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="180"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="150"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Text="Tá»« NgÃ y:" VerticalAlignment="Center" Margin="0,0,5,0" FontWeight="SemiBold"/>
                    <DatePicker  Grid.Column="1" x:Name="dpStartDate"/>

                    <TextBlock Grid.Column="2" Text="Äáº¿n NgÃ y:" VerticalAlignment="Center" Margin="10,0,5,0" FontWeight="SemiBold"/>
                    <DatePicker Grid.Column="3" x:Name="dpEndDate"/>

                    <TextBlock Grid.Column="4" Text="NhÃ¢n viÃªn:" VerticalAlignment="Center" Margin="10,0,5,0" FontWeight="SemiBold"/>
                    <ComboBox Grid.Column="5" x:Name="cmbNhanVienFilter" DisplayMemberPath="HoTen" SelectedValuePath="IdNhanVien"/>

                    <TextBlock Grid.Column="6" Text="Vai trÃ²:" VerticalAlignment="Center" Margin="10,0,5,0" FontWeight="SemiBold"/>
                    <ComboBox Grid.Column="7" x:Name="cmbVaiTroFilter" DisplayMemberPath="Ten" SelectedValuePath="Id"/>

                    <TextBlock Grid.Column="8" Text="Tráº¡ng thÃ¡i:" VerticalAlignment="Center" Margin="10,0,5,0" FontWeight="SemiBold"/>
                    <ComboBox Grid.Column="9" x:Name="cmbTrangThaiFilter">
                        <ComboBoxItem Content="Äang lÃ m viá»‡c"/>
                        <ComboBoxItem Content="Nghá»‰ viá»‡c"/>
                        <ComboBoxItem Content="Táº¥t cáº£"/>
                    </ComboBox>

                    <Button Grid.Column="11" x:Name="btnGenerate" Style="{StaticResource PrimaryButton}" 
                            Background="{StaticResource ActionBlueBrush}" Click="BtnGenerate_Click" 
                            HorizontalAlignment="Right">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconGenerate}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Táº¡o BÃ¡o CÃ¡o" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </Grid>
            </Border>

            <Grid Grid.Row="2" Margin="10,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Border Grid.Column="0" Style="{StaticResource KpiCard}">
                    <StackPanel>
                        <TextBlock x:Name="lblSoLuongNhanVien" Text="0" Style="{StaticResource KpiValue}" Foreground="{StaticResource PrimaryBrownBrush}"/>
                        <TextBlock Text="Tá»•ng sá»‘ NhÃ¢n viÃªn (lá»c)" Style="{StaticResource KpiTitle}"/>
                    </StackPanel>
                </Border>
                <Border Grid.Column="1" Style="{StaticResource KpiCard}">
                    <StackPanel>
                        <TextBlock x:Name="lblTongLuongDaTra" Text="0" Style="{StaticResource KpiValue}" Foreground="{StaticResource ActionGreenBrush}"/>
                        <TextBlock Text="Tá»•ng LÆ°Æ¡ng ÄÃ£ Tráº£ (ká»³)" Style="{StaticResource KpiTitle}"/>
                    </StackPanel>
                </Border>
                <Border Grid.Column="2" Style="{StaticResource KpiCard}">
                    <StackPanel>
                        <TextBlock x:Name="lblTongGioLam" Text="0" Style="{StaticResource KpiValue}" Foreground="{StaticResource ActionBlueBrush}"/>
                        <TextBlock Text="Tá»•ng Giá» LÃ m (ká»³)" Style="{StaticResource KpiTitle}"/>
                    </StackPanel>
                </Border>
                <Border Grid.Column="3" Style="{StaticResource KpiCard}" Margin="0">
                    <StackPanel>
                        <TextBlock x:Name="lblTongSoNgayNghi" Text="0" Style="{StaticResource KpiValue}" Foreground="{StaticResource ActionOrangeBrush}"/>
                        <TextBlock Text="Tá»•ng NgÃ y Nghá»‰ (ká»³)" Style="{StaticResource KpiTitle}"/>
                    </StackPanel>
                </Border>
            </Grid>

            <TabControl Grid.Row="3" Margin="10,10,10,0">
                <TabItem Header="BÃ¡o cÃ¡o LÆ°Æ¡ng Chi Tiáº¿t">
                    <DataGrid x:Name="dgLuong" AutoGenerateColumns="False" IsReadOnly="True" 
                              BorderThickness="0" RowHeaderWidth="0" Margin="5">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="NhÃ¢n viÃªn" Binding="{Binding HoTenNhanVien}" Width="2*"/>
                            <DataGridTextColumn Header="Vai trÃ²" Binding="{Binding TenVaiTro}" Width="*"/>
                            <DataGridTextColumn Header="Tá»•ng Giá»" Binding="{Binding TongGioLam, StringFormat=F2}" Width="Auto"/>
                            <DataGridTextColumn Header="LÆ°Æ¡ng Giá»" Binding="{Binding TongLuongCoBan, StringFormat=N0}" Width="Auto"/>
                            <DataGridTextColumn Header="Tá»•ng ThÆ°á»Ÿng" Binding="{Binding TongThuong, StringFormat=N0}" Width="Auto"/>
                            <DataGridTextColumn Header="Tá»•ng Pháº¡t" Binding="{Binding TongPhat, StringFormat=N0}" Width="Auto"/>
                            <DataGridTextColumn Header="Thá»±c LÃ£nh" Binding="{Binding ThucLanh, StringFormat=N0}" Width="*" FontWeight="Bold"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </TabItem>
                <TabItem Header="Thá»‘ng kÃª Nghá»‰ PhÃ©p">
                    <DataGrid x:Name="dgNghiPhep" AutoGenerateColumns="False" IsReadOnly="True" 
                              BorderThickness="0" RowHeaderWidth="0" Margin="5">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="NhÃ¢n viÃªn" Binding="{Binding HoTenNhanVien}" Width="2*"/>
                            <DataGridTextColumn Header="Vai trÃ²" Binding="{Binding TenVaiTro}" Width="*"/>
                            <DataGridTextColumn Header="Sá»‘ ÄÆ¡n Duyá»‡t" Binding="{Binding SoDonDaDuyet}" Width="Auto"/>
                            <DataGridTextColumn Header="Tá»•ng Sá»‘ NgÃ y Nghá»‰" Binding="{Binding TongSoNgayNghi}" Width="*" FontWeight="Bold"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </TabItem>
                <TabItem Header="Biá»ƒu Äá»“ LÆ°Æ¡ng (Theo NgÃ y)">
                    <lvc:CartesianChart Margin="10" Series="{Binding LuongChartSeries}">
                        <lvc:CartesianChart.Resources>
                            <Style TargetType="lvc:LineSeries">
                                <Setter Property="Stroke" Value="{StaticResource ActionGreenBrush}"/>
                                <Setter Property="Fill" Value="#4066BB6A"/>
                                <Setter Property="StrokeThickness" Value="3"/>
                                <Setter Property="PointGeometry" Value="{x:Null}"/>
                            </Style>
                        </lvc:CartesianChart.Resources>
                        <lvc:CartesianChart.AxisX>
                            <lvc:Axis Title="NgÃ y" Labels="{Binding ChartLabels}">
                                <lvc:Axis.Separator>
                                    <lvc:Separator Stroke="#E0E0E0" StrokeThickness="1"/>
                                </lvc:Axis.Separator>
                            </lvc:Axis>
                        </lvc:CartesianChart.AxisX>
                        <lvc:CartesianChart.AxisY>
                            <lvc:Axis Title="Tá»•ng LÆ°Æ¡ng Tráº£" LabelFormatter="{Binding YFormatter}">
                                <lvc:Axis.Separator>
                                    <lvc:Separator Stroke="#E0E0E0" StrokeThickness="1"/>
                                </lvc:Axis.Separator>
                            </lvc:Axis>
                        </lvc:CartesianChart.AxisY>
                    </lvc:CartesianChart>
                </TabItem>
            </TabControl>

            <StackPanel Grid.Row="4" Orientation="Horizontal" Margin="10,10,0,10">
                <Button x:Name="btnQuayLai" 
                        Style="{StaticResource BackButton}"
                        HorizontalAlignment="Left"
                        Click="BtnQuayLai_Click">
                    <StackPanel Orientation="Horizontal">
                        <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                        <TextBlock Text="Quay láº¡i" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <Button x:Name="btnExport" Style="{StaticResource PrimaryButton}" 
                        Background="{StaticResource ActionGreenBrush}" Click="BtnExport_Click" 
                        HorizontalAlignment="Left" Margin="20,0,0,0">
                    <StackPanel Orientation="Horizontal">
                        <Path Data="{StaticResource IconExport}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                        <TextBlock Text="Xuáº¥t Excel" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Äang táº¡o bÃ¡o cÃ¡o..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\BaoCaoNhanSuView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Threading.Tasks;
using LiveCharts;
using LiveCharts.Wpf;
using System.Globalization;

namespace AppCafebookApi.View.quanly.pages
{
    public partial class BaoCaoNhanSuView : Page
    {
        private static readonly HttpClient httpClient;

        // DÃ nh cho Biá»ƒu Ä‘á»“
        public SeriesCollection LuongChartSeries { get; set; }
        public string[] ChartLabels { get; set; }
        public Func<double, string> YFormatter { get; set; }

        static BaoCaoNhanSuView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public BaoCaoNhanSuView()
        {
            InitializeComponent();

            // Khá»Ÿi táº¡o cho Biá»ƒu Ä‘á»“
            LuongChartSeries = new SeriesCollection
            {
                new LineSeries
                {
                    Title = "Tá»•ng LÆ°Æ¡ng",
                    Values = new ChartValues<decimal>(),
                    LineSmoothness = 0
                }
            };
            ChartLabels = Array.Empty<string>();
            YFormatter = value => value.ToString("N0") + " Ä‘";

            DataContext = this;
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadFiltersAsync();

            var now = DateTime.Now;
            dpStartDate.SelectedDate = new DateTime(now.Year, now.Month, 1);
            dpEndDate.SelectedDate = now;
            cmbTrangThaiFilter.SelectedIndex = 0; // Äang lÃ m viá»‡c
        }

        private async Task LoadFiltersAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var filters = await httpClient.GetFromJsonAsync<BaoCaoNhanSu_FiltersDto>("api/app/baocaonhansu/filters");
                if (filters != null)
                {
                    // Lá»c NhÃ¢n viÃªn
                    var nvList = filters.NhanViens;
                    nvList.Insert(0, new NhanVienLookupDto { IdNhanVien = 0, HoTen = "--- Táº¥t cáº£ NhÃ¢n viÃªn ---" });
                    cmbNhanVienFilter.ItemsSource = nvList;
                    cmbNhanVienFilter.SelectedValue = 0;

                    // Lá»c Vai trÃ²
                    var vtList = filters.VaiTros;
                    vtList.Insert(0, new FilterLookupDto { Id = 0, Ten = "--- Táº¥t cáº£ Vai trÃ² ---" });
                    cmbVaiTroFilter.ItemsSource = vtList;
                    cmbVaiTroFilter.SelectedValue = 0;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i bá»™ lá»c: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnGenerate_Click(object sender, RoutedEventArgs e)
        {
            if (dpStartDate.SelectedDate == null || dpEndDate.SelectedDate == null)
            {
                MessageBox.Show("Vui lÃ²ng chá»n Tá»« NgÃ y vÃ  Äáº¿n NgÃ y.", "Thiáº¿u thÃ´ng tin");
                return;
            }

            var request = new BaoCaoNhanSuRequestDto
            {
                StartDate = dpStartDate.SelectedDate.Value,
                EndDate = dpEndDate.SelectedDate.Value,
                IdNhanVien = (int)(cmbNhanVienFilter.SelectedValue ?? 0),
                IdVaiTro = (int)(cmbVaiTroFilter.SelectedValue ?? 0),
                TrangThaiNhanVien = (cmbTrangThaiFilter.SelectedItem as ComboBoxItem)?.Content.ToString() ?? "Táº¥t cáº£"
            };

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/baocaonhansu/report", request);
                if (response.IsSuccessStatusCode)
                {
                    var data = await response.Content.ReadFromJsonAsync<BaoCaoNhanSuDto>();
                    if (data != null)
                    {
                        PopulateReport(data);
                    }
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void PopulateReport(BaoCaoNhanSuDto data)
        {
            var culture = CultureInfo.GetCultureInfo("vi-VN");

            // 1. Cáº­p nháº­t KPIs
            lblSoLuongNhanVien.Text = data.Kpi.SoLuongNhanVien.ToString();
            lblTongLuongDaTra.Text = data.Kpi.TongLuongDaTra.ToString("C0", culture);
            lblTongGioLam.Text = data.Kpi.TongGioLam.ToString("F2");
            lblTongSoNgayNghi.Text = data.Kpi.TongSoNgayNghi.ToString();

            // 2. Cáº­p nháº­t DataGrids
            dgLuong.ItemsSource = data.BangLuongChiTiet;
            dgNghiPhep.ItemsSource = data.ThongKeNghiPhep;

            // 3. Cáº­p nháº­t Biá»ƒu Ä‘á»“
            LuongChartSeries[0].Values.Clear();
            LuongChartSeries[0].Values.AddRange(data.LuongChartData.Select(d => d.TongTien).Cast<object>());
            ChartLabels = data.LuongChartData.Select(d => d.Ngay.ToString("dd/MM")).ToArray();

            // Cáº§n reset DataContext Ä‘á»ƒ Chart cáº­p nháº­t Labels
            DataContext = null;
            DataContext = this;
        }

        private void BtnExport_Click(object sender, RoutedEventArgs e)
        {
            MessageBox.Show("Chá»©c nÄƒng Xuáº¥t Excel Ä‘ang Ä‘Æ°á»£c phÃ¡t triá»ƒn. Dá»¯ liá»‡u sáº½ Ä‘Æ°á»£c láº¥y tá»« cÃ¡c báº£ng vÃ  biá»ƒu Ä‘á»“ hiá»‡n táº¡i.", "ThÃ´ng bÃ¡o");
        }

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
            else
            {
                // Fallback náº¿u khÃ´ng CanGoBack
                this.NavigationService?.Navigate(new QuanLyNhanVienView());
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\CaiDatNhanSuView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\CaiDatNhanSuView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.CaiDatNhanSuView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Cáº¥u HÃ¬nh NhÃ¢n Sá»± &amp; ChÃ­nh SÃ¡ch LÆ°Æ¡ng"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="25"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="15,10"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="MaterialInput" TargetType="TextBox">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="SettingLabel" TargetType="TextBlock">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,15,0,5"/>
        </Style>
        <Style x:Key="SettingDescription" TargetType="TextBlock">
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="FontStyle" Value="Italic"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
            <Setter Property="TextWrapping" Value="Wrap"/>
            <Setter Property="Margin" Value="2,2,0,0"/>
        </Style>
        <Style TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,8"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Cáº¥u HÃ¬nh NhÃ¢n Sá»± &amp; ChÃ­nh SÃ¡ch LÆ°Æ¡ng" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Border Grid.Row="1" Margin="10,0,10,10" Style="{StaticResource CardBorder}" MaxWidth="800" HorizontalAlignment="Left">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel x:Name="formCaiDat">

                        <TextBlock Text="QUY Táº®C GIá»œ LÃ€M &amp; TÄ‚NG CA" FontSize="14" FontWeight="Bold" Margin="0,0,0,10" 
                                    Foreground="{StaticResource PrimaryBrownBrush}" Padding="0,0,0,5"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,10,0">
                                <TextBlock Style="{StaticResource SettingLabel}" Text="Giá» lÃ m chuáº©n / ngÃ y"/>
                                <TextBox x:Name="txtGioLamChuan" Style="{StaticResource MaterialInput}"/>
                                <TextBlock Style="{StaticResource SettingDescription}" Text="Sá»‘ giá» lÃ m viá»‡c chuáº©n má»—i ngÃ y (vÃ­ dá»¥: 8)"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="10,0,0,0">
                                <TextBlock Style="{StaticResource SettingLabel}" Text="Há»‡ sá»‘ lÆ°Æ¡ng OT"/>
                                <TextBox x:Name="txtHeSoOT" Style="{StaticResource MaterialInput}"/>
                                <TextBlock Style="{StaticResource SettingDescription}" Text="Há»‡ sá»‘ lÆ°Æ¡ng khi lÃ m tÄƒng ca (vÃ­ dá»¥: 1.5)"/>
                            </StackPanel>
                        </Grid>

                        <TextBlock Text="QUY Táº®C PHáº T ÄI TRá»„" FontSize="14" FontWeight="Bold" Margin="0,25,0,10" 
                                   Foreground="{StaticResource PrimaryBrownBrush}" Padding="0,0,0,5"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,10,0">
                                <TextBlock Style="{StaticResource SettingLabel}" Text="Sá»‘ phÃºt Ä‘i trá»… cho phÃ©p"/>
                                <TextBox x:Name="txtPhatDiTre_Phut" Style="{StaticResource MaterialInput}"/>
                                <TextBlock Style="{StaticResource SettingDescription}" Text="VÆ°á»£t quÃ¡ ngÆ°á»¡ng nÃ y báº¯t Ä‘áº§u tÃ­nh pháº¡t (vÃ­ dá»¥: 5)"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="10,0,0,0">
                                <TextBlock Style="{StaticResource SettingLabel}" Text="Há»‡ sá»‘ pháº¡t Ä‘i trá»…"/>
                                <TextBox x:Name="txtPhatDiTre_HeSo" Style="{StaticResource MaterialInput}"/>
                                <TextBlock Style="{StaticResource SettingDescription}" Text="Há»‡ sá»‘ pháº¡t (vÃ­ dá»¥: 1.0 = trá»… 1 giá» pháº¡t 1 giá» lÆ°Æ¡ng)"/>
                            </StackPanel>
                        </Grid>

                        <TextBlock Text="QUY Táº®C THÆ¯á»NG CHUYÃŠN Cáº¦N" FontSize="14" FontWeight="Bold" Margin="0,25,0,10" 
                                    Foreground="{StaticResource PrimaryBrownBrush}" Padding="0,0,0,5"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,10,0">
                                <TextBlock Style="{StaticResource SettingLabel}" Text="Sá»‘ ngÃ y cÃ´ng yÃªu cáº§u"/>
                                <TextBox x:Name="txtChuyenCan_SoNgay" Style="{StaticResource MaterialInput}"/>
                                <TextBlock Style="{StaticResource SettingDescription}" Text="Sá»‘ ngÃ y cÃ´ng yÃªu cáº§u Ä‘á»ƒ Ä‘áº¡t thÆ°á»Ÿng (vÃ­ dá»¥: 26)"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="10,0,0,0">
                                <TextBlock Style="{StaticResource SettingLabel}" Text="Tiá»n thÆ°á»Ÿng chuyÃªn cáº§n (VND)"/>
                                <TextBox x:Name="txtChuyenCan_TienThuong" Style="{StaticResource MaterialInput}"/>
                                <TextBlock Style="{StaticResource SettingDescription}" Text="Sá»‘ tiá»n thÆ°á»Ÿng (vÃ­ dá»¥: 500000)"/>
                            </StackPanel>
                        </Grid>

                        <TextBlock Text="CHÃNH SÃCH NGHá»ˆ PHÃ‰P" FontSize="14" FontWeight="Bold" Margin="0,25,0,10" 
                                    Foreground="{StaticResource PrimaryBrownBrush}" Padding="0,0,0,5"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,10,0">
                                <TextBlock Style="{StaticResource SettingLabel}" Text="Sá»‘ ngÃ y phÃ©p máº·c Ä‘á»‹nh / nÄƒm"/>
                                <TextBox x:Name="txtPhepNam_MacDinh" Style="{StaticResource MaterialInput}"/>
                                <TextBlock Style="{StaticResource SettingDescription}" Text="Sá»‘ ngÃ y nghá»‰ phÃ©p cÃ³ lÆ°Æ¡ng máº·c Ä‘á»‹nh (vÃ­ dá»¥: 12)"/>
                            </StackPanel>
                        </Grid>

                    </StackPanel>
                </ScrollViewer>
            </Border>

            <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="10,0,0,10">
                <Button x:Name="btnQuayLai" 
                        Style="{StaticResource BackButton}"
                        HorizontalAlignment="Left"
                        Click="BtnQuayLai_Click">
                    <StackPanel Orientation="Horizontal">
                        <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                        <TextBlock Text="Quay láº¡i" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <Button x:Name="btnLuu" Grid.Column="5" Style="{StaticResource PrimaryButton}" 
                        Background="{StaticResource SuccessBrush}" Click="BtnLuu_Click" 
                        HorizontalAlignment="Left" Margin="20,0,0,0">
                    <StackPanel Orientation="Horizontal">
                        <Path Data="{StaticResource IconSave}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                        <TextBlock Text="LÆ°u Cáº¥u HÃ¬nh" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Äang xá»­ lÃ½..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\CaiDatNhanSuView.xaml.cs
using System;
using System.Globalization;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;

namespace AppCafebookApi.View.quanly.pages
{
    public partial class CaiDatNhanSuView : Page
    {
        private static readonly HttpClient httpClient;
        private CaiDatNhanSuDto _currentSettings = new CaiDatNhanSuDto();

        static CaiDatNhanSuView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public CaiDatNhanSuView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadSettingsAsync();
        }

        private async Task LoadSettingsAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                _currentSettings = await httpClient.GetFromJsonAsync<CaiDatNhanSuDto>("api/app/caidatnhansu/all");
                if (_currentSettings != null)
                {
                    // DÃ¹ng CultureInfo.InvariantCulture Ä‘á»ƒ xá»­ lÃ½ dáº¥u cháº¥m (.)
                    txtGioLamChuan.Text = _currentSettings.GioLamChuan.ToString(CultureInfo.InvariantCulture);
                    txtHeSoOT.Text = _currentSettings.HeSoOT.ToString(CultureInfo.InvariantCulture);
                    txtPhatDiTre_Phut.Text = _currentSettings.PhatDiTre_Phut.ToString();
                    txtPhatDiTre_HeSo.Text = _currentSettings.PhatDiTre_HeSo.ToString(CultureInfo.InvariantCulture);
                    txtChuyenCan_SoNgay.Text = _currentSettings.ChuyenCan_SoNgay.ToString();
                    txtChuyenCan_TienThuong.Text = _currentSettings.ChuyenCan_TienThuong.ToString("F0", CultureInfo.InvariantCulture);
                    txtPhepNam_MacDinh.Text = _currentSettings.PhepNam_MacDinh.ToString();
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i cÃ i Ä‘áº·t: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                // Validate vÃ  Parse
                var dto = new CaiDatNhanSuDto
                {
                    GioLamChuan = decimal.Parse(txtGioLamChuan.Text, CultureInfo.InvariantCulture),
                    HeSoOT = decimal.Parse(txtHeSoOT.Text, CultureInfo.InvariantCulture),
                    PhatDiTre_Phut = int.Parse(txtPhatDiTre_Phut.Text),
                    PhatDiTre_HeSo = decimal.Parse(txtPhatDiTre_HeSo.Text, CultureInfo.InvariantCulture),
                    ChuyenCan_SoNgay = int.Parse(txtChuyenCan_SoNgay.Text),
                    ChuyenCan_TienThuong = decimal.Parse(txtChuyenCan_TienThuong.Text, CultureInfo.InvariantCulture),
                    PhepNam_MacDinh = int.Parse(txtPhepNam_MacDinh.Text)
                };

                // Gá»i API
                var response = await httpClient.PutAsJsonAsync("api/app/caidatnhansu/update", dto);

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("LÆ°u cÃ i Ä‘áº·t thÃ nh cÃ´ng!", "ThÃ nh cÃ´ng");
                    await LoadSettingsAsync(); // Táº£i láº¡i dá»¯ liá»‡u
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (FormatException)
            {
                MessageBox.Show("Dá»¯ liá»‡u nháº­p khÃ´ng há»£p lá»‡. Vui lÃ²ng kiá»ƒm tra cÃ¡c con sá»‘ (dÃ¹ng dáº¥u . cho sá»‘ tháº­p phÃ¢n).", "Lá»—i Äá»‹nh Dáº¡ng");
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            // Quay láº¡i trang QL LÆ°Æ¡ng (Module 6)
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\PhanQuyenView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\PhanQuyenView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.PhanQuyenView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="PhÃ¢n Quyá»n Chá»©c NÄƒng"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>

        <Style TargetType="GroupItem">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="GroupItem">
                        <StackPanel>
                            <TextBlock Text="{Binding Name}" 
                                       FontSize="16" FontWeight="Bold" 
                                       Foreground="{StaticResource PrimaryBrownBrush}" 
                                       Margin="5,15,0,5" />
                            <ItemsPresenter />
                        </StackPanel>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="PhÃ¢n Quyá»n Chá»©c NÄƒng" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Border Grid.Row="1" Style="{StaticResource CardBorder}" Margin="10,0,10,10" Padding="15">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="350"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="300"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" Text="Chá»n Vai TrÃ²:" FontWeight="SemiBold" VerticalAlignment="Center"/>
                    <ComboBox Grid.Column="1" x:Name="cmbVaiTro" Margin="10,0,0,0"
                              DisplayMemberPath="TenVaiTro" SelectedValuePath="IdVaiTro"
                              SelectionChanged="CmbVaiTro_SelectionChanged"/>

                    <TextBlock Grid.Column="2" Text="TÃ¬m chá»©c nÄƒng:" FontWeight="SemiBold" VerticalAlignment="Center" Margin="20,0,0,0"/>
                    <TextBox Grid.Column="3" x:Name="txtSearchQuyen" Margin="10,0,0,0" TextChanged="TxtSearchQuyen_TextChanged"/>

                    <Button Grid.Column="5" x:Name="btnLuu" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionBlueBrush}" 
                            Click="BtnLuu_Click" IsEnabled="False">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconSave}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="LÆ°u PhÃ¢n Quyá»n" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </Grid>
            </Border>

            <Border Grid.Row="2" Margin="10,0,10,10" Style="{StaticResource CardBorder}">
                <ListView x:Name="lvQuyen" BorderThickness="0" Background="Transparent">
                    <ListView.GroupStyle>
                        <GroupStyle HidesIfEmpty="True"/>
                    </ListView.GroupStyle>
                    <ListView.ItemTemplate>


                            <DataTemplate>
                                <CheckBox Content="{Binding TenQuyen}" 
                                      IsChecked="{Binding IsChecked, Mode=TwoWay}"
                                      Margin="5"/>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                </ListView>
            </Border>

            <Button x:Name="btnQuayLai" Grid.Row="3" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" Margin="10,0,0,10"
                    Click="BtnQuayLai_Click">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                    <TextBlock Text="Quay láº¡i" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Äang xá»­ lÃ½..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\PhanQuyenView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data; // Cáº§n cho CollectionViewSource
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Threading.Tasks;
using System.ComponentModel; // Cáº§n cho ICollectionView

namespace AppCafebookApi.View.quanly.pages
{
    /// <summary>
    /// Lá»›p View-Model ná»™i bá»™ Ä‘á»ƒ quáº£n lÃ½ tráº¡ng thÃ¡i CheckBox
    /// </summary>
    public class QuyenViewItem : INotifyPropertyChanged
    {
        public string IdQuyen { get; set; } = string.Empty;
        public string TenQuyen { get; set; } = string.Empty;
        public string NhomQuyen { get; set; } = string.Empty;

        private bool _isChecked;
        public bool IsChecked
        {
            get => _isChecked;
            set
            {
                if (_isChecked != value)
                {
                    _isChecked = value;
                    PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(nameof(IsChecked)));
                }
            }
        }
        public event PropertyChangedEventHandler? PropertyChanged;
    }

    public partial class PhanQuyenView : Page
    {
        private static readonly HttpClient httpClient;

        // Cache dá»¯ liá»‡u
        private List<VaiTroDto> _allVaiTroList = new List<VaiTroDto>();
        private List<QuyenViewItem> _allPermissionsList = new List<QuyenViewItem>();

        static PhanQuyenView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public PhanQuyenView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            await LoadAllVaiTroAsync();
            await LoadAllQuyenAsync();
            ApplyFilter(); // Hiá»ƒn thá»‹ danh sÃ¡ch rá»—ng ban Ä‘áº§u
            LoadingOverlay.Visibility = Visibility.Collapsed;
        }

        /// <summary>
        /// Táº£i danh sÃ¡ch Vai TrÃ² vÃ o ComboBox
        /// </summary>
        private async Task LoadAllVaiTroAsync()
        {
            try
            {
                _allVaiTroList = (await httpClient.GetFromJsonAsync<List<VaiTroDto>>("api/app/vaitro/all")) ?? new List<VaiTroDto>();
                cmbVaiTro.ItemsSource = _allVaiTroList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i danh sÃ¡ch vai trÃ²: {ex.Message}", "Lá»—i API");
            }
        }

        /// <summary>
        /// Táº£i Táº¤T Cáº¢ cÃ¡c quyá»n trong há»‡ thá»‘ng vÃ o Cache
        /// </summary>
        private async Task LoadAllQuyenAsync()
        {
            try
            {
                var quyenDtos = (await httpClient.GetFromJsonAsync<List<QuyenDto>>("api/app/phanquyen/all-permissions")) ?? new List<QuyenDto>();

                _allPermissionsList = quyenDtos.Select(dto => new QuyenViewItem
                {
                    IdQuyen = dto.IdQuyen,
                    TenQuyen = dto.TenQuyen,
                    NhomQuyen = dto.NhomQuyen,
                    IsChecked = false // Máº·c Ä‘á»‹nh lÃ  false
                }).ToList();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i danh sÃ¡ch quyá»n: {ex.Message}", "Lá»—i API");
            }
        }

        /// <summary>
        /// Khi thay Ä‘á»•i Vai trÃ², táº£i cÃ¡c quyá»n tÆ°Æ¡ng á»©ng
        /// </summary>
        private async void CmbVaiTro_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (cmbVaiTro.SelectedItem is not VaiTroDto selectedVaiTro)
            {
                btnLuu.IsEnabled = false;
                // Bá» check táº¥t cáº£
                foreach (var item in _allPermissionsList) { item.IsChecked = false; }
                ApplyFilter();
                return;
            }

            btnLuu.IsEnabled = true;
            LoadingOverlay.Visibility = Visibility.Visible;

            try
            {
                // 1. Táº£i danh sÃ¡ch ID quyá»n Ä‘Ã£ Ä‘Æ°á»£c gÃ¡n
                var assignedIds = (await httpClient.GetFromJsonAsync<List<string>>($"api/app/phanquyen/for-role/{selectedVaiTro.IdVaiTro}")) ?? new List<string>();

                // 2. Cáº­p nháº­t tráº¡ng thÃ¡i CheckBox
                foreach (var item in _allPermissionsList)
                {
                    item.IsChecked = assignedIds.Contains(item.IdQuyen);
                }

                // 3. Ãp dá»¥ng tÃ¬m kiáº¿m vÃ  hiá»ƒn thá»‹
                ApplyFilter();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i phÃ¢n quyá»n cho vai trÃ²: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        /// <summary>
        /// Lá»c danh sÃ¡ch quyá»n theo tá»« khÃ³a tÃ¬m kiáº¿m
        /// </summary>
        private void TxtSearchQuyen_TextChanged(object sender, TextChangedEventArgs e)
        {
            ApplyFilter();
        }

        /// <summary>
        /// (Quan trá»ng) HÃ m lá»c vÃ  nhÃ³m ListView
        /// </summary>
        private void ApplyFilter()
        {
            string searchText = txtSearchQuyen.Text.ToLower().Trim();

            IEnumerable<QuyenViewItem> filteredList = _allPermissionsList;

            if (!string.IsNullOrEmpty(searchText))
            {
                filteredList = _allPermissionsList.Where(p =>
                    p.TenQuyen.ToLower().Contains(searchText) ||
                    p.NhomQuyen.ToLower().Contains(searchText));
            }

            // Táº¡o CollectionViewSource Ä‘á»ƒ Gruping
            var cvs = new CollectionViewSource { Source = filteredList };
            cvs.GroupDescriptions.Add(new PropertyGroupDescription("NhomQuyen"));

            lvQuyen.ItemsSource = cvs.View;
        }

        /// <summary>
        /// LÆ°u thay Ä‘á»•i phÃ¢n quyá»n
        /// </summary>
        private async void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            if (cmbVaiTro.SelectedItem is not VaiTroDto selectedVaiTro)
            {
                MessageBox.Show("Vui lÃ²ng chá»n má»™t vai trÃ² trÆ°á»›c khi lÆ°u.", "ChÆ°a chá»n Vai trÃ²");
                return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;

            try
            {
                // 1. Láº¥y táº¥t cáº£ ID Ä‘Æ°á»£c check tá»« cache
                var checkedIds = _allPermissionsList
                    .Where(p => p.IsChecked)
                    .Select(p => p.IdQuyen)
                    .ToList();

                // 2. Táº¡o DTO
                var dto = new PhanQuyenDto
                {
                    IdVaiTro = selectedVaiTro.IdVaiTro,
                    DanhSachIdQuyen = checkedIds
                };

                // 3. Gá»i API
                var response = await httpClient.PutAsJsonAsync("api/app/phanquyen/update", dto);

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Cáº­p nháº­t phÃ¢n quyá»n thÃ nh cÃ´ng!", "ThÃ nh cÃ´ng");
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyBanView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyBanView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyBanView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      xmlns:dto="clr-namespace:CafebookModel.Model.ModelApp;assembly=CafebookModel"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="QuanLyBanView"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="BackgroundHoverBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="BackgroundSelectedBrush" Color="#EFEBE9"/>

        <Geometry x:Key="IconAddFolder">M20,6H12L10,4H4C2.89,4 2,4.89 2,6V18C2,19.1 2.89,20 4,20H20C21.1,20 22,19.1 22,18V8C22,6.89 21.1,6 20,6M18,14H15V17H13V14H10V12H13V9H15V12H18V14Z</Geometry>
        <Geometry x:Key="IconAddTable">M4,6H20V8H4V6M4,10H20V12H4V10M4,14H11V16H4V14M19,16V19H16V21H14V19H11V16H14V14H16V16H19Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconHistory">M13.5,8H12V13L16.28,15.54L17,14.33L13.5,12.25V8M13,3C8.03,3 4,7.03 4,12C4,16.97 8.03,21 13,21C17.97,21 22,16.97 22,12C22,7.03 17.97,3 13,3M13,19C9.13,19 6,15.87 6,12C6,8.13 9.13,5 13,5C16.87,5 20,8.13 20,12C20,15.87 16.87,19 13,19Z</Geometry>
        <Geometry x:Key="IconClearFilter">M14.12,12.5L19.31,7.31L17.89,5.89L12.71,11.08L7.5,5.89L6.09,7.31L11.28,12.5L6.09,17.69L7.5,19.11L12.71,13.92L17.89,19.11L19.31,17.69L14.12,12.5M3,5H21V3H3V5Z</Geometry>
        <Geometry x:Key="IconCheck">M9,20.42L2.79,14.21L4.21,12.79L9,17.58L19.79,6.79L21.21,8.21L9,20.42Z</Geometry>
        
        <Style x:Key="ActionButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,10"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="4" Padding="{TemplateBinding Padding}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.1" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.8"/>
                                <Setter TargetName="border" Property="Effect" Value="{x:Null}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="DeleteButton" TargetType="Button" BasedOn="{StaticResource ActionButton}">
            <Setter Property="Background" Value="{StaticResource ErrorBrush}"/>
        </Style>

        <Style TargetType="Label">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,15,0,5"/>
        </Style>
        <Style x:Key="MaterialTextBox" TargetType="TextBox">
            <Setter Property="Padding" Value="8,10"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TextBox">
                        <Border x:Name="border" 
                                Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}" 
                                BorderThickness="{TemplateBinding BorderThickness}">
                            <ScrollViewer x:Name="PART_ContentHost" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsKeyboardFocused" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="BorderThickness" Value="0,0,0,2"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="IconButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="20" Padding="{TemplateBinding Padding}">
                            <Path Data="{Binding Content, RelativeSource={RelativeSource TemplatedParent}}" 
                                  Fill="{Binding Foreground, RelativeSource={RelativeSource TemplatedParent}}" 
                                  Width="16" Height="16" Stretch="Uniform"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource BackgroundHoverBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="MaterialComboBox" TargetType="ComboBox">
            <Setter Property="Padding" Value="8,10"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="SearchTextBox" TargetType="TextBox" BasedOn="{StaticResource MaterialTextBox}">
            <Setter Property="Padding" Value="8,8"/>
        </Style>
        <Style x:Key="FilterComboBox" TargetType="ComboBox" BasedOn="{StaticResource MaterialComboBox}">
            <Setter Property="Padding" Value="8,8"/>
        </Style>
        <Style TargetType="TabControl">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
        <Style TargetType="TabItem">
            <Setter Property="Background" Value="#E0E0E0"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border x:Name="border" BorderThickness="0,0,0,3" BorderBrush="Transparent" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" Margin="0,0,5,0">
                            <ContentPresenter ContentSource="Header" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="Background" Value="White"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
                                <Setter TargetName="border" Property="Background" Value="#F5F5F5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>


        <Style x:Key="MaterialIconButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="20">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BackgroundHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="MaterialIconToggleButton" TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="20">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BackgroundHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BackgroundSelectedBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

    </Page.Resources>

    <Grid Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="460"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Background="White" CornerRadius="8" Margin="10">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
            </Border.Effect>

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TabControl Grid.Row="0" Margin="5">

                    <TabItem Header="Táº¥t cáº£ BÃ n">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10,5,10,10">
                                <TextBlock Text="Lá»c Khu vá»±c:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                                <ComboBox x:Name="cmbFilterKhuVuc" 
                                          Width="180" Margin="5"
                                          DisplayMemberPath="TenKhuVuc" 
                                          SelectedValuePath="IdKhuVuc"
                                          Style="{StaticResource FilterComboBox}"
                                          SelectionChanged="CmbFilterKhuVuc_SelectionChanged"/>

                                <TextBlock Text="TÃ¬m kiáº¿m:" VerticalAlignment="Center" Margin="15,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                                <TextBox x:Name="txtSearch" 
                                         Width="200" 
                                         Style="{StaticResource SearchTextBox}"
                                         TextChanged="TxtSearch_TextChanged"/>

                                <Button x:Name="btnClearFilter" ToolTip="XÃ³a Lá»c"
                                        Style="{StaticResource MaterialIconButton}" 
                                        Click="BtnClearFilter_Click" Margin="5,0,0,0">
                                    <Path Data="{StaticResource IconClearFilter}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                                </Button>
                            </StackPanel>

                            <DataGrid Grid.Row="1" x:Name="dgAllBans" AutoGenerateColumns="False" IsReadOnly="True"
                                      SelectionMode="Single" SelectionChanged="DgAllBans_SelectionChanged"
                                      BorderThickness="0" RowHeaderWidth="0" Margin="10,0,10,10">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="ID" Binding="{Binding IdBan}" Width="50"/>
                                    <DataGridTextColumn Header="Sá»‘ BÃ n" Binding="{Binding SoBan}" Width="120"/>
                                    <DataGridTextColumn Header="Khu Vá»±c" Binding="{Binding TenKhuVuc}" Width="120"/>
                                    <DataGridTextColumn Header="Sá»‘ Gháº¿" Binding="{Binding SoGhe}" Width="80"/>
                                    <DataGridTextColumn Header="Tráº¡ng thÃ¡i" Binding="{Binding TrangThai}" Width="120"/>
                                    <DataGridTextColumn Header="Ghi chÃº" Binding="{Binding GhiChu}" Width="*"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </TabItem>

                    <TabItem Header="Quáº£n lÃ½ Khu vá»±c">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10,5,10,10">
                                <TextBlock Text="TÃ¬m kiáº¿m Khu vá»±c:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                                <TextBox x:Name="txtSearchKhuVuc" 
                                         Width="200" 
                                         Style="{StaticResource SearchTextBox}"
                                         TextChanged="TxtSearchKhuVuc_TextChanged"/>
                            </StackPanel>

                            <DataGrid Grid.Row="1" x:Name="dgKhuVuc" AutoGenerateColumns="False" IsReadOnly="True"
                                      SelectionMode="Single" SelectionChanged="DgKhuVuc_SelectionChanged"
                                      BorderThickness="0" RowHeaderWidth="0" Margin="10,0,10,10">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="ID" Binding="{Binding IdKhuVuc}" Width="50"/>
                                    <DataGridTextColumn Header="TÃªn Khu Vá»±c" Binding="{Binding TenKhuVuc}" Width="*"/>
                                    <DataGridTextColumn Header="MÃ´ Táº£" Binding="{Binding MoTa}" Width="2*"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </TabItem>

                    <TabItem Header="Sá»± cá»‘ BÃ n">
                        <Grid Margin="10">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <Grid Grid.Row="0" Margin="0,5,0,10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <TextBlock Grid.Column="0" x:Name="lblSuCoTitle" 
                                           Text="Sá»± cá»‘ BÃ n cáº§n xá»­ lÃ½" 
                                           FontSize="18" FontWeight="Bold" 
                                           Foreground="{StaticResource DarkBrownBrush}"
                                           VerticalAlignment="Center"/>

                                <ToggleButton Grid.Column="1" x:Name="btnToggleSuCoHistory"
                                              Style="{StaticResource MaterialIconToggleButton}"
                                              ToolTip="Xem lá»‹ch sá»­ sá»± cá»‘ Ä‘Ã£ xá»­ lÃ½"
                                              Click="BtnToggleSuCoHistory_Click">
                                    <Path Data="{StaticResource IconHistory}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                                </ToggleButton>
                            </Grid>

                            <ListBox Grid.Row="1" x:Name="lbThongBaoBan" BorderThickness="0" ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Border BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="0,0,0,1" Padding="5,10">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <StackPanel Grid.Column="0">
                                                    <TextBlock Text="{Binding NoiDung}" TextWrapping="Wrap"/>
                                                    <TextBlock FontStyle="Italic" FontSize="11" Foreground="Gray">
                                                        <Run Text="{Binding TenNhanVienTao}"/> - <Run Text="{Binding ThoiGianTao, StringFormat='HH:mm dd/MM'}"/>
                                                    </TextBlock>
                                                </StackPanel>
                                                <Button Grid.Column="1" ToolTip="ÄÃ¡nh dáº¥u Ä‘Ã£ xá»­ lÃ½" Margin="10,0,0,0" x:Name="btnDanhDauDaDoc" 
                                                        Click="BtnDanhDauDaDoc_Click" 
                                                        Style="{StaticResource IconButton}"
                                                        Content="{StaticResource IconCheck}"
                                                        Foreground="{StaticResource SuccessBrush}"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Grid>
                    </TabItem>
                </TabControl>

                <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,10,0,10">
                    <Button x:Name="btnThemKhuVuc" Click="BtnThemKhuVuc_Click" 
                            Style="{StaticResource MaterialIconButton}" 
                            ToolTip="ThÃªm Khu Vá»±c Má»›i" Margin="0,0,10,0">
                        <Path Data="{StaticResource IconAddFolder}" Fill="{StaticResource DarkBrownBrush}" Width="30" Height="25" Stretch="Fill"/>
                    </Button>
                    <Button x:Name="btnThemBan" Click="BtnThemBan_Click" 
                            Style="{StaticResource MaterialIconButton}" 
                            ToolTip="ThÃªm BÃ n Má»›i">
                        <Path Data="{StaticResource IconAddTable}" Fill="{StaticResource DarkBrownBrush}" Width="30" Height="25" Stretch="Fill"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <Border Grid.Column="1" Background="White" CornerRadius="8" Padding="25" Margin="0,10,10,10">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
            </Border.Effect>
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <TextBlock x:Name="lblFormTitle" Text="Chá»n má»™t má»¥c Ä‘á»ƒ xem chi tiáº¿t" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,5,0,15"/>

                    <Grid x:Name="formChiTiet" IsEnabled="False">

                        <StackPanel x:Name="panelKhuVuc">
                            <Label Content="TÃªn Khu Vá»±c"/>
                            <TextBox x:Name="txtTenKhuVuc" Text="{Binding TenKhuVuc, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                     Style="{StaticResource MaterialTextBox}"/>

                            <Label Content="MÃ´ táº£ Khu Vá»±c"/>
                            <TextBox x:Name="txtMoTaKhuVuc" Text="{Binding MoTa, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                     Style="{StaticResource MaterialTextBox}"
                                     Height="80" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"/>
                        </StackPanel>

                        <StackPanel x:Name="panelBan" Visibility="Collapsed">
                            <Label Content="Sá»‘ BÃ n (TÃªn BÃ n)"/>
                            <TextBox x:Name="txtSoBan" Text="{Binding SoBan, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                     Style="{StaticResource MaterialTextBox}"/>

                            <Label Content="Sá»‘ Gháº¿"/>
                            <TextBox x:Name="txtSoGhe" Text="{Binding SoGhe, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                     Style="{StaticResource MaterialTextBox}"/>

                            <Label Content="Thuá»™c Khu Vá»±c"/>
                            <ComboBox x:Name="cmbKhuVuc" DisplayMemberPath="TenKhuVuc" SelectedValuePath="IdKhuVuc"
                                      Style="{StaticResource MaterialComboBox}"/>

                            <Label Content="Tráº¡ng thÃ¡i (KhÃ³a BÃ n)"/>
                            <ComboBox x:Name="cmbTrangThai" SelectedValuePath="Content"
                                      Style="{StaticResource MaterialComboBox}">
                                <ComboBoxItem Content="Trá»‘ng"/>
                                <ComboBoxItem Content="Äang phá»¥c vá»¥"/>
                                <ComboBoxItem Content="Báº£o trÃ¬"/>
                                <ComboBoxItem Content="Táº¡m ngÆ°ng"/>
                            </ComboBox>

                            <Label Content="Ghi chÃº (LÃ½ do sá»± cá»‘)"/>
                            <TextBox x:Name="txtGhiChu" Text="{Binding GhiChu, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                     Style="{StaticResource MaterialTextBox}"
                                     Height="80" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"/>
                        </StackPanel>
                    </Grid>

                    <StackPanel x:Name="panelActions" Orientation="Horizontal" Margin="0,25,0,0">
                        <Button x:Name="btnLuu" Click="BtnLuu_Click" Margin="0,0,10,0" Style="{StaticResource ActionButton}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconSave}" Fill="White" Width="20" Height="20" Margin="0,0,8,0" VerticalAlignment="Center" Stretch="Fill"/>
                                <TextBlock Text="LÆ°u Thay Äá»•i" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>

                        <Button x:Name="btnXoa" Click="BtnXoa_Click" Margin="0,0,10,0" Style="{StaticResource DeleteButton}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconDelete}" Fill="White" Width="23" Height="23" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                <TextBlock Text="XÃ³a" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>

                        <Button x:Name="btnXemLichSu" Visibility="Collapsed" Click="BtnXemLichSu_Click" 
                                Background="#42A5F5" Style="{StaticResource ActionButton}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconHistory}" Fill="White" Width="23" Height="23" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                <TextBlock Text="Xem Lá»‹ch sá»­" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <Border x:Name="LoadingOverlay" Background="#80FFFFFF" Visibility="Collapsed"
                            Grid.RowSpan="2" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                        <TextBlock Text="Äang xá»­ lÃ½..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
                    </Border>
                </StackPanel>
            </ScrollViewer>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyBanView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using System.Windows.Controls.Primitives; // <-- ÄÃ£ thÃªm

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyBanView : Page
    {
        private static readonly HttpClient httpClient;
        private List<KhuVucDto> _khuVucList = new List<KhuVucDto>();
        private object? _selectedItem;
        private bool _isAddingNew = false;
        private int? _navigateToBanId = null;

        // Class ná»™i bá»™
        private class BanGridItem : BanDto
        {
            public string? TenKhuVuc { get; set; }
        }

        private List<BanGridItem> _allBansList = new List<BanGridItem>();
        private List<KhuVucDto> _filterKhuVucList = new List<KhuVucDto>();

        private List<ThongBaoDto> _allThongBaoList = new List<ThongBaoDto>();
        private bool _showSuCoHistory = false;


        static QuanLyBanView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyBanView()
        {
            InitializeComponent();
        }

        public QuanLyBanView(int banIdToNavigate) : this()
        {
            _navigateToBanId = banIdToNavigate;
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadDataAsync();
            await LoadThongBaoSuCoAsync();

            if (_navigateToBanId.HasValue)
            {
                SelectAndShowBan(_navigateToBanId.Value);
                _navigateToBanId = null;
            }
        }

        private async Task LoadDataAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                _khuVucList = (await httpClient.GetFromJsonAsync<List<KhuVucDto>>("api/app/banquanly/tree"))
                                 ?? new List<KhuVucDto>();

                // 1. Náº¡p dá»¯ liá»‡u cho ComboBox (trong Form chi tiáº¿t)
                cmbKhuVuc.ItemsSource = _khuVucList;

                // 2. Náº¡p dá»¯ liá»‡u cho DataGrid Khu Vá»±c (Tab 1)
                dgKhuVuc.ItemsSource = _khuVucList;
                ApplyKhuVucFilter(); // Ãp dá»¥ng filter (náº¿u cÃ³)

                // 3. Táº¡o danh sÃ¡ch pháº³ng (flat list) cho DataGrid BÃ n (Tab 2)
                _allBansList = _khuVucList.SelectMany(kv => kv.Bans.Select(b => new BanGridItem
                {
                    IdBan = b.IdBan,
                    SoBan = b.SoBan,
                    SoGhe = b.SoGhe,
                    TrangThai = b.TrangThai,
                    GhiChu = b.GhiChu,
                    IdKhuVuc = b.IdKhuVuc,
                    TenKhuVuc = kv.TenKhuVuc
                })).OrderBy(b => b.IdBan).ToList();

                // 4. Náº¡p dá»¯ liá»‡u cho DataGrid BÃ n
                dgAllBans.ItemsSource = _allBansList;

                // 5. Náº¡p dá»¯ liá»‡u cho ComboBox Lá»c BÃ n
                _filterKhuVucList = new List<KhuVucDto>(_khuVucList);
                _filterKhuVucList.Insert(0, new KhuVucDto { IdKhuVuc = 0, TenKhuVuc = "--- Táº¥t cáº£ Khu vá»±c ---" });
                cmbFilterKhuVuc.ItemsSource = _filterKhuVucList;
                cmbFilterKhuVuc.SelectedIndex = 0;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i dá»¯ liá»‡u: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
                if (_navigateToBanId == null)
                    ResetForm();
            }
        }

        // --- (LoadThongBaoSuCoAsync, ApplySuCoFilter, BtnToggleSuCoHistory_Click, BtnDanhDauDaDoc_Click giá»¯ nguyÃªn) ---
        #region Sá»± Cá»‘ BÃ n (Tab 3)
        private async Task LoadThongBaoSuCoAsync()
        {
            try
            {
                _allThongBaoList = (await httpClient.GetFromJsonAsync<List<ThongBaoDto>>("api/app/thongbao/all"))
                                       ?? new List<ThongBaoDto>();

                _allThongBaoList = _allThongBaoList.Where(t => t.LoaiThongBao == "SuCoBan").ToList();

                ApplySuCoFilter();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i thÃ´ng bÃ¡o sá»± cá»‘: {ex.Message}");
            }
        }

        private void ApplySuCoFilter()
        {
            if (_showSuCoHistory)
            {
                lblSuCoTitle.Text = "Lá»‹ch sá»­ Sá»± cá»‘ (ÄÃ£ xá»­ lÃ½)";
                lbThongBaoBan.ItemsSource = _allThongBaoList
                    .Where(t => t.DaXem == true)
                    .OrderByDescending(t => t.ThoiGianTao)
                    .ToList();
            }
            else
            {
                lblSuCoTitle.Text = "Sá»± cá»‘ BÃ n cáº§n xá»­ lÃ½";
                lbThongBaoBan.ItemsSource = _allThongBaoList
                    .Where(t => t.DaXem == false)
                    .OrderByDescending(t => t.ThoiGianTao)
                    .ToList();
            }
        }

        private void BtnToggleSuCoHistory_Click(object sender, RoutedEventArgs e)
        {
            _showSuCoHistory = (sender as ToggleButton).IsChecked == true;
            ApplySuCoFilter();
        }

        private async void BtnDanhDauDaDoc_Click(object sender, RoutedEventArgs e)
        {
            var button = sender as Button;
            var thongBao = button?.DataContext as ThongBaoDto;

            if (thongBao != null)
            {
                if (thongBao.DaXem == false)
                {
                    try
                    {
                        var idThongBao = thongBao.IdThongBao;
                        var response = await httpClient.PostAsync($"api/app/thongbao/mark-as-read/{idThongBao}", null);

                        if (response.IsSuccessStatusCode)
                        {
                            var itemInCache = _allThongBaoList.FirstOrDefault(t => t.IdThongBao == idThongBao);
                            if (itemInCache != null)
                            {
                                itemInCache.DaXem = true;
                            }
                            ApplySuCoFilter();
                        }
                        else
                        {
                            MessageBox.Show($"Lá»—i cáº­p nháº­t: {await response.Content.ReadAsStringAsync()}");
                        }
                    }
                    catch (Exception ex)
                    {
                        MessageBox.Show($"Lá»—i cáº­p nháº­t: {ex.Message}");
                    }
                }
                else
                {
                    MessageBox.Show("Sá»± cá»‘ nÃ y Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½ trÆ°á»›c Ä‘Ã³.");
                }
            }
        }
        #endregion

        private void SelectAndShowBan(int banId)
        {
            // (Giá»¯ nguyÃªn)
            var ban = _khuVucList.SelectMany(kv => kv.Bans).FirstOrDefault(b => b.IdBan == banId);
            if (ban != null)
            {
                _selectedItem = ban;
                PopulateForm();
                var gridItem = _allBansList.FirstOrDefault(b => b.IdBan == banId);
                if (gridItem != null)
                {
                    dgAllBans.SelectedItem = gridItem;
                    dgAllBans.ScrollIntoView(gridItem);
                }
            }
        }

        // --- (CÃ¡c hÃ m Lá»c/TÃ¬m kiáº¿m BÃ n giá»¯ nguyÃªn) ---
        #region Lá»c/TÃ¬m kiáº¿m BÃ n (Tab 2)
        private void CmbFilterKhuVuc_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            ApplyFilter();
        }

        private void TxtSearch_TextChanged(object sender, TextChangedEventArgs e)
        {
            ApplyFilter();
        }

        private void BtnClearFilter_Click(object sender, RoutedEventArgs e)
        {
            // Cáº¬P NHáº¬T: XÃ³a luÃ´n filter cá»§a Tab 1
            txtSearchKhuVuc.Text = "";
            ApplyKhuVucFilter();

            if (cmbFilterKhuVuc.SelectedIndex != 0)
                cmbFilterKhuVuc.SelectedIndex = 0;

            if (!string.IsNullOrEmpty(txtSearch.Text))
                txtSearch.Text = "";

            ApplyFilter();
        }

        private void ApplyFilter()
        {
            if (_allBansList == null) return;
            IEnumerable<BanGridItem> filteredView = _allBansList;
            if (cmbFilterKhuVuc.SelectedItem is KhuVucDto selectedKhuVuc && selectedKhuVuc.IdKhuVuc != 0)
            {
                filteredView = filteredView.Where(b => b.IdKhuVuc == selectedKhuVuc.IdKhuVuc);
            }
            string searchText = txtSearch.Text.Trim();
            if (!string.IsNullOrEmpty(searchText))
            {
                filteredView = filteredView.Where(b =>
                    b.SoBan.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                    (b.GhiChu != null && b.GhiChu.Contains(searchText, StringComparison.OrdinalIgnoreCase)) ||
                    b.TrangThai.Contains(searchText, StringComparison.OrdinalIgnoreCase)
                );
            }
            dgAllBans.ItemsSource = filteredView.ToList();
        }
        #endregion

        // --- THÃŠM Má»šI: CÃ¡c hÃ m Lá»c/TÃ¬m kiáº¿m Khu Vá»±c ---
        #region Lá»c/TÃ¬m kiáº¿m Khu Vá»±c (Tab 1)

        private void TxtSearchKhuVuc_TextChanged(object sender, TextChangedEventArgs e)
        {
            ApplyKhuVucFilter();
        }

        private void ApplyKhuVucFilter()
        {
            if (_khuVucList == null) return;

            IEnumerable<KhuVucDto> filteredView = _khuVucList;
            string searchText = txtSearchKhuVuc.Text.Trim();

            if (!string.IsNullOrEmpty(searchText))
            {
                filteredView = filteredView.Where(kv =>
                    kv.TenKhuVuc.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                    (kv.MoTa != null && kv.MoTa.Contains(searchText, StringComparison.OrdinalIgnoreCase))
                );
            }
            dgKhuVuc.ItemsSource = filteredView.ToList();
        }

        #endregion


        // --- Cáº¬P NHáº¬T: CÃ¡c hÃ m chá»n Grid ---
        #region Grid Selection & Form Logic

        private void DgKhuVuc_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgKhuVuc.SelectedItem is KhuVucDto selectedKhuVuc)
            {
                _selectedItem = selectedKhuVuc;
                _isAddingNew = false;

                // Bá» chá»n Grid BÃ n
                dgAllBans.SelectedItem = null;

                PopulateForm();
            }
        }

        private void DgAllBans_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgAllBans.SelectedItem == null)
            {
                return;
            }

            if (dgAllBans.SelectedItem is BanGridItem selectedBan)
            {
                _selectedItem = _khuVucList
                    .SelectMany(kv => kv.Bans)
                    .FirstOrDefault(b => b.IdBan == selectedBan.IdBan);

                _isAddingNew = false;

                // Bá» chá»n Grid Khu Vá»±c
                dgKhuVuc.SelectedItem = null;

                PopulateForm();
            }
        }

        private void PopulateForm()
        {
            // (Giá»¯ nguyÃªn)
            panelKhuVuc.Visibility = Visibility.Collapsed;
            panelBan.Visibility = Visibility.Collapsed;
            formChiTiet.IsEnabled = false;
            btnXemLichSu.Visibility = Visibility.Collapsed;
            formChiTiet.DataContext = null;

            if (_selectedItem == null)
            {
                lblFormTitle.Text = "Chá»n má»™t má»¥c Ä‘á»ƒ xem chi tiáº¿t";
                return;
            }

            formChiTiet.IsEnabled = true;

            if (_selectedItem is KhuVucDto kv)
            {
                lblFormTitle.Text = "Chi tiáº¿t Khu Vá»±c";
                panelKhuVuc.Visibility = Visibility.Visible;
                panelBan.Visibility = Visibility.Collapsed; // áº¨n panel BÃ n
                formChiTiet.DataContext = kv;
            }
            else if (_selectedItem is BanDto ban)
            {
                lblFormTitle.Text = "Chi tiáº¿t BÃ n";
                panelBan.Visibility = Visibility.Visible;
                panelKhuVuc.Visibility = Visibility.Collapsed; // áº¨n panel Khu vá»±c
                formChiTiet.DataContext = ban;

                cmbKhuVuc.SelectedValue = ban.IdKhuVuc;
                cmbTrangThai.Text = ban.TrangThai;
                btnXemLichSu.Visibility = Visibility.Visible;
            }
        }

        private void BtnThemKhuVuc_Click(object sender, RoutedEventArgs e)
        {
            _selectedItem = new KhuVucDto();
            _isAddingNew = true;

            // Cáº¬P NHáº¬T: Bá» chá»n cáº£ 2 Grid
            dgKhuVuc.SelectedItem = null;
            dgAllBans.SelectedItem = null;

            PopulateForm();
            lblFormTitle.Text = "ThÃªm Khu Vá»±c Má»›i";
            formChiTiet.DataContext = _selectedItem;
        }

        private void BtnThemBan_Click(object sender, RoutedEventArgs e)
        {
            int defaultKhuVucId = _khuVucList.FirstOrDefault()?.IdKhuVuc ?? 0;
            _selectedItem = new BanDto { IdKhuVuc = defaultKhuVucId, TrangThai = "Trá»‘ng" };
            _isAddingNew = true;

            // Cáº¬P NHáº¬T: Bá» chá»n cáº£ 2 Grid
            dgKhuVuc.SelectedItem = null;
            dgAllBans.SelectedItem = null;

            PopulateForm();
            lblFormTitle.Text = "ThÃªm BÃ n Má»›i";
            formChiTiet.DataContext = _selectedItem;
        }

        private void ResetForm()
        {
            _selectedItem = null;
            _isAddingNew = false;
            dgAllBans.SelectedItem = null;
            dgKhuVuc.SelectedItem = null; // ThÃªm
            PopulateForm();
        }

        #endregion

        // --- (CÃ¡c hÃ m LÆ°u, XÃ³a, Xem Lá»‹ch sá»­ giá»¯ nguyÃªn, chÃºng Ä‘Ã£ há»— trá»£ KhuVuc) ---
        #region API Calls (LÆ°u, XÃ³a, Lá»‹ch sá»­)
        private async void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedItem == null) return;
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                HttpResponseMessage response;
                if (_selectedItem is KhuVucDto kv)
                {
                    var dto = new KhuVucUpdateRequestDto { TenKhuVuc = txtTenKhuVuc.Text, MoTa = txtMoTaKhuVuc.Text };
                    if (_isAddingNew)
                        response = await httpClient.PostAsJsonAsync("api/app/banquanly/khuvuc", dto);
                    else
                        response = await httpClient.PutAsJsonAsync($"api/app/banquanly/khuvuc/{kv.IdKhuVuc}", dto);
                }
                else if (_selectedItem is BanDto ban)
                {
                    var dto = new BanUpdateRequestDto
                    {
                        SoBan = txtSoBan.Text,
                        SoGhe = int.TryParse(txtSoGhe.Text, out int ghe) ? ghe : 0,
                        IdKhuVuc = (int)cmbKhuVuc.SelectedValue,
                        TrangThai = cmbTrangThai.Text,
                        GhiChu = txtGhiChu.Text
                    };

                    if (_isAddingNew)
                        response = await httpClient.PostAsJsonAsync("api/app/banquanly/ban", dto);
                    else
                        response = await httpClient.PutAsJsonAsync($"api/app/banquanly/ban/{ban.IdBan}", dto);
                }
                else
                {
                    throw new InvalidOperationException("Loáº¡i Ä‘á»‘i tÆ°á»£ng khÃ´ng xÃ¡c Ä‘á»‹nh.");
                }

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("LÆ°u thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadDataAsync();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i: {ex.Message}", "Lá»—i");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXoa_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedItem == null) return;
            string endpoint;
            string tenMuc;

            if (_selectedItem is KhuVucDto kv)
            {
                endpoint = $"api/app/banquanly/khuvuc/{kv.IdKhuVuc}";
                tenMuc = kv.TenKhuVuc;
            }
            else if (_selectedItem is BanDto ban)
            {
                endpoint = $"api/app/banquanly/ban/{ban.IdBan}";
                tenMuc = ban.SoBan;
            }
            else
            {
                return;
            }

            if (MessageBox.Show($"Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a '{tenMuc}' khÃ´ng?", "XÃ¡c nháº­n xÃ³a", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.No)
            {
                return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync(endpoint);

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("XÃ³a thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadDataAsync();
                }
                else if (response.StatusCode == HttpStatusCode.Conflict)
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "KhÃ´ng thá»ƒ xÃ³a");
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {response.ReasonPhrase}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i: {ex.Message}", "Lá»—i");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXemLichSu_Click(object sender, RoutedEventArgs e)
        {
            if (!(_selectedItem is BanDto ban)) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var history = await httpClient.GetFromJsonAsync<BanHistoryDto>($"api/app/banquanly/ban/{ban.IdBan}/history");
                if (history != null)
                {
                    MessageBox.Show(
                        $"Lá»‹ch sá»­ BÃ n: {ban.SoBan}\n\n" +
                        $"- Tá»•ng sá»‘ lÆ°á»£t phá»¥c vá»¥ (HÄ Ä‘Ã£ thanh toÃ¡n): {history.SoLuotPhucVu}\n" +
                        $"- Tá»•ng doanh thu mang láº¡i: {history.TongDoanhThu:N0} VND\n" +
                        $"- Tá»•ng sá»‘ lÆ°á»£t Ä‘áº·t trÆ°á»›c: {history.SoLuotDatTruoc}",
                        "Lá»‹ch sá»­ BÃ n"
                    );
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i lá»‹ch sá»­: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }
        #endregion
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyDonHangView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyDonHangView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyDonHangView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="QuanLyDonHangView" FontFamily="Segoe UI" Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="StatusGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="StatusRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="StatusBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="StatusYellowBrush" Color="#FFF9C4"/>
        <SolidColorBrush x:Key="StatusCanceledBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>

        
        <Geometry x:Key="IconFilter">M14,12V19.88C14.04,20.18 13.94,20.5 13.71,20.71C13.32,21.1 12.69,21.1 12.3,20.71L10.29,18.7C10.06,18.47 9.96,18.16 10,17.87V12H14M15,9H9V4H15V9Z</Geometry>
        <Geometry x:Key="IconFilterOff">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconPrint">M19,8H5C3.34,8 2,9.34 2,11V17H6V21H18V17H22V11C22,9.34 20.66,8 19,8M16,19H8V14H16V19M19,12C18.45,12 18,11.55 18,11C18,10.45 18.45,10 19,10C19.55,10 20,10.45 20,11C20,11.55 19.55,12 19,12M18,3H6V7H18V3Z</Geometry>
        <Geometry x:Key="IconCancel">M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z</Geometry>
        <Geometry x:Key="IconDelivery">M16,11H12.5V8H8V14H10V11H10.5L12.5,13L14.5,11H16M20,8H17V6H10V8H7L3,12V18H5V20H7V18H17V20H19V18H21V12L20,8Z</Geometry>
        <Geometry x:Key="IconExcel">M21.17 3.25Q21.5 3.25 21.76 3.5 22 3.74 22 4.08V19.92Q22 20.26 21.76 20.5 21.5 20.75 21.17 20.75H7.83Q7.5 20.75 7.24 20.5 7 20.26 7 19.92V4.08Q7 3.74 7.24 3.5 7.5 3.25 7.83 3.25H21.17M13.83 18.25V15.7H11.5V14.05L13.72 10.63H11.6V9H16.33V10.65L14.12 14.07H16.25V15.7H13.83V18.25M6.25 15.5Q6.25 15.15 6.04 14.88 5.82 14.6 5.5 14.6H3.5Q3.18 14.6 2.96 14.88 2.75 15.15 2.75 15.5V17.5Q2.75 17.82 2.96 18.1 3.18 18.38 3.5 18.38H5.5Q5.82 18.38 6.04 18.1 6.25 17.82 6.25 17.5V15.5M6.25 9.5Q6.25 9.18 6.04 8.9 5.82 8.62 5.5 8.62H3.5Q3.18 8.62 2.96 8.9 2.75 9.18 2.75 9.5V11.5Q2.75 11.82 2.96 12.1 3.18 12.38 3.5 12.38H5.5Q5.82 12.38 6.04 12.1 6.25 11.82 6.25 11.5V9.5Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="DataGridRowStyle" TargetType="DataGridRow">
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding TrangThai}" Value="ÄÃ£ thanh toÃ¡n">
                    <Setter Property="Background" Value="{StaticResource StatusGreenBrush}"/>
                    <Setter Property="Opacity" Value="0.7"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TrangThai}" Value="ChÆ°a thanh toÃ¡n">
                    <Setter Property="Background" Value="{StaticResource StatusYellowBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding LoaiHoaDon}" Value="Giao hÃ ng">
                    <Setter Property="Background" Value="{StaticResource StatusBlueBrush}"/>
                    <Setter Property="Opacity" Value="0.6"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TrangThai}" Value="ÄÃ£ há»§y">
                    <Setter Property="Background" Value="{StaticResource StatusCanceledBrush}"/>
                    <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="{StaticResource WhiteTextBrush}" CornerRadius="8" Padding="15" Margin="15,15,15,0">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
            </Border.Effect>
            <WrapPanel Orientation="Horizontal">
                <TextBlock Text="Tá»« ngÃ y:" VerticalAlignment="Center" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}" Margin="5"/>
                <DatePicker x:Name="dpTuNgay" Width="130" Margin="5" VerticalContentAlignment="Center"/>
                <TextBlock Text="Äáº¿n ngÃ y:" VerticalAlignment="Center" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}" Margin="10,5,5,5"/>
                <DatePicker x:Name="dpDenNgay" Width="130" Margin="5" VerticalContentAlignment="Center"/>

                <TextBlock Text="Tráº¡ng thÃ¡i:" VerticalAlignment="Center" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}" Margin="10,5,5,5"/>
                <ComboBox x:Name="cmbTrangThai" Width="140" Margin="5" VerticalContentAlignment="Center">
                    <ComboBoxItem Content="Táº¥t cáº£"/>
                    <ComboBoxItem Content="ChÆ°a thanh toÃ¡n"/>
                    <ComboBoxItem Content="ÄÃ£ thanh toÃ¡n"/>
                    <ComboBoxItem Content="ÄÃ£ há»§y"/>
                </ComboBox>

                <TextBlock Text="NhÃ¢n viÃªn:" VerticalAlignment="Center" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}" Margin="10,5,5,5"/>
                <ComboBox x:Name="cmbNhanVien" Width="140" Margin="5" DisplayMemberPath="Ten" SelectedValuePath="Id" VerticalContentAlignment="Center"/>

                <TextBlock Text="TÃ¬m kiáº¿m (MÃ£ HÄ, SÄT):" VerticalAlignment="Center" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}" Margin="10,5,5,5"/>
                <TextBox x:Name="txtSearch" Width="150" Margin="5" VerticalContentAlignment="Center" BorderThickness="0,0,0,1" Background="Transparent"/>

                <Button x:Name="btnLoc" Margin="10,5,5,5" Style="{StaticResource PrimaryButton}" Click="BtnLoc_Click" Width="80">
                    <StackPanel Orientation="Horizontal">
                        <Path Data="{StaticResource IconFilter}" Fill="White" Width="14" Height="14" Margin="0,0,8,0" Stretch="Uniform"/>
                        <TextBlock Text="Lá»c" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
                <Button x:Name="btnXoaLoc" Margin="5" Style="{StaticResource PrimaryButton}" Background="White" Foreground="{StaticResource TextGrayBrush}" BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="1" Click="BtnXoaLoc_Click">
                    <StackPanel Orientation="Horizontal">
                        <Path Data="{StaticResource IconFilterOff}" Fill="{StaticResource TextGrayBrush}" Width="14" Height="14" Margin="0,0,8,0" Stretch="Uniform"/>
                        <TextBlock Text="XÃ³a lá»c" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
            </WrapPanel>
        </Border>

        <Grid Grid.Row="1" Margin="15">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/>
                <ColumnDefinition Width="1*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Background="{StaticResource WhiteTextBrush}" CornerRadius="8">
                <Border.Effect>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Border.Effect>
                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Text="Danh sÃ¡ch ÄÆ¡n hÃ ng" Style="{StaticResource HeaderTextBlock}"/>

                    <DataGrid Grid.Row="1" x:Name="dgDonHang" AutoGenerateColumns="False" IsReadOnly="True" 
                              SelectionMode="Single" SelectionChanged="DgDonHang_SelectionChanged"
                              BorderThickness="0" RowHeaderWidth="0"
                              RowStyle="{StaticResource DataGridRowStyle}">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="MÃ£ HÄ" Binding="{Binding IdHoaDon}" Width="60"/>
                            <DataGridTextColumn Header="Thá»i gian" Binding="{Binding ThoiGianTao, StringFormat='dd/MM HH:mm'}" Width="110"/>
                            <DataGridTextColumn Header="NhÃ¢n viÃªn" Binding="{Binding TenNhanVien}" Width="*"/>
                            <DataGridTextColumn Header="KhÃ¡ch hÃ ng" Binding="{Binding TenKhachHang}" Width="*"/>
                            <DataGridTextColumn Header="BÃ n/Loáº¡i" Binding="{Binding SoBan}" Width="100"/>
                            <DataGridTextColumn Header="ThÃ nh tiá»n" Binding="{Binding ThanhTien, StringFormat=N0}" Width="100"/>
                            <DataGridTextColumn Header="Tráº¡ng thÃ¡i" Binding="{Binding TrangThai}" Width="110"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <Button Grid.Row="2" x:Name="btnExportToExcel" HorizontalAlignment="Left" Margin="0,15,0,0"
                                Style="{StaticResource PrimaryButton}" Background="#00724C"
                                Click="BtnExportToExcel_Click">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconExcel}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Xuáº¥t Excel" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                </Grid>
            </Border>

            <Border Grid.Column="1" Background="{StaticResource WhiteTextBrush}" CornerRadius="8" Margin="15,0,0,0" Padding="20">
                <Border.Effect>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <TextBlock Text="Chi tiáº¿t ÄÆ¡n hÃ ng" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,15"/>
                    <DataGrid Grid.Row="1" x:Name="dgChiTietDonHang" AutoGenerateColumns="False" IsReadOnly="True" Background="Transparent" BorderThickness="0">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Sáº£n pháº©m" Binding="{Binding TenSanPham}" Width="*"/>
                            <DataGridTextColumn Header="SL" Binding="{Binding SoLuong}" Width="40"/>
                            <DataGridTextColumn Header="ThÃ nh tiá»n" Binding="{Binding ThanhTien, StringFormat=N0}" Width="80"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <StackPanel Grid.Row="2" Margin="0,15,0,0">
                        <Button x:Name="btnInLaiHoaDon" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionBlueBrush}" IsEnabled="False" Click="BtnInLaiHoaDon_Click" Height="40">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconPrint}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="In láº¡i HÃ³a Ä‘Æ¡n" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            </StackPanel>
                        </Button>
                        <Button x:Name="btnGiaoHang" Margin="0,8,0,0" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionBlueBrush}" IsEnabled="False" Click="BtnGiaoHang_Click" Height="40">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconDelivery}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="Báº¯t Ä‘áº§u Giao HÃ ng" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            </StackPanel>
                        </Button>
                        <Button x:Name="btnHuyDonHang" Margin="0,8,0,0" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionRedBrush}" IsEnabled="False" Click="BtnHuyDonHang_Click" Height="40">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconCancel}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="Há»§y ÄÆ¡n hÃ ng" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyDonHangView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using Microsoft.Win32; // Cho Excel
using System.IO; // Cho Excel
using OfficeOpenXml; // Cho Excel
using System.Globalization; // Cho Excel

namespace AppCafebookApi.View.quanly.pages
{
    // Äá»•i tÃªn class cho khá»›p (náº¿u file XAML lÃ  QuanLyDonHangView.xaml)
    public partial class QuanLyDonHangView : Page
    {
        private static readonly HttpClient httpClient;
        private List<DonHangDto> _currentOrderList = new List<DonHangDto>();

        static QuanLyDonHangView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyDonHangView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            // Thiáº¿t láº­p ngÃ y máº·c Ä‘á»‹nh (hÃ´m nay)
            dpTuNgay.SelectedDate = DateTime.Today;
            dpDenNgay.SelectedDate = DateTime.Today;
            cmbTrangThai.SelectedIndex = 0; // "Táº¥t cáº£"

            await LoadFiltersAsync();
            await LoadDataGridAsync();
        }

        /// <summary>
        /// Táº£i dá»¯ liá»‡u cho ComboBox NhÃ¢n viÃªn
        /// </summary>
        private async Task LoadFiltersAsync()
        {
            try
            {
                var filters = await httpClient.GetFromJsonAsync<DonHangFiltersDto>("api/app/donhang/filters");
                if (filters != null)
                {
                    filters.NhanViens.Insert(0, new FilterLookupDto { Id = 0, Ten = "Táº¥t cáº£ NhÃ¢n viÃªn" });
                    cmbNhanVien.ItemsSource = filters.NhanViens;
                    cmbNhanVien.SelectedValue = 0;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i bá»™ lá»c: {ex.Message}", "Lá»—i API");
            }
        }

        /// <summary>
        /// Táº£i DataGrid chÃ­nh dá»±a trÃªn bá»™ lá»c
        /// </summary>
        private async Task LoadDataGridAsync()
        {
            if (dpTuNgay.SelectedDate == null || dpDenNgay.SelectedDate == null) return;

            DateTime startDate = dpTuNgay.SelectedDate.Value;
            DateTime endDate = dpDenNgay.SelectedDate.Value;
            string trangThai = (cmbTrangThai.SelectedItem as ComboBoxItem)?.Content.ToString() ?? "Táº¥t cáº£";
            int nhanVienId = (int)(cmbNhanVien.SelectedValue ?? 0);
            string searchText = txtSearch.Text;

            try
            {
                var url = $"api/app/donhang/search?" +
                          $"startDate={startDate:yyyy-MM-dd}" +
                          $"&endDate={endDate:yyyy-MM-dd}" +
                          $"&trangThai={Uri.EscapeDataString(trangThai)}" +
                          $"&nhanVienId={nhanVienId}" +
                          $"&searchText={Uri.EscapeDataString(searchText)}";

                _currentOrderList = (await httpClient.GetFromJsonAsync<List<DonHangDto>>(url)) ?? new List<DonHangDto>();
                dgDonHang.ItemsSource = _currentOrderList;

                // XÃ³a chi tiáº¿t
                dgChiTietDonHang.ItemsSource = null;
                btnInLaiHoaDon.IsEnabled = false;
                btnHuyDonHang.IsEnabled = false;
                btnGiaoHang.IsEnabled = false;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i danh sÃ¡ch Ä‘Æ¡n hÃ ng: {ex.Message}", "Lá»—i API");
            }
        }

        private async void BtnLoc_Click(object sender, RoutedEventArgs e)
        {
            await LoadDataGridAsync();
        }

        private async void BtnXoaLoc_Click(object sender, RoutedEventArgs e)
        {
            dpTuNgay.SelectedDate = DateTime.Today;
            dpDenNgay.SelectedDate = DateTime.Today;
            cmbTrangThai.SelectedIndex = 0;
            cmbNhanVien.SelectedValue = 0;
            txtSearch.Text = "";
            await LoadDataGridAsync();
        }

        /// <summary>
        /// Khi chá»n má»™t Ä‘Æ¡n hÃ ng, táº£i chi tiáº¿t
        /// </summary>
        private async void DgDonHang_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgDonHang.SelectedItem is not DonHangDto selectedOrder)
            {
                dgChiTietDonHang.ItemsSource = null;
                btnInLaiHoaDon.IsEnabled = false;
                btnHuyDonHang.IsEnabled = false;
                btnGiaoHang.IsEnabled = false;
                return;
            }

            try
            {
                var details = await httpClient.GetFromJsonAsync<List<DonHangChiTietDto>>($"api/app/donhang/details/{selectedOrder.IdHoaDon}");
                dgChiTietDonHang.ItemsSource = details;

                // Logic kÃ­ch hoáº¡t nÃºt
                btnInLaiHoaDon.IsEnabled = true; // LuÃ´n cho phÃ©p in

                if (selectedOrder.TrangThai == "ÄÃ£ thanh toÃ¡n" || selectedOrder.TrangThai == "ÄÃ£ há»§y")
                {
                    btnHuyDonHang.IsEnabled = false;
                    btnGiaoHang.IsEnabled = false;
                }
                else
                {
                    // "ChÆ°a thanh toÃ¡n"
                    btnHuyDonHang.IsEnabled = true;
                    if (selectedOrder.LoaiHoaDon == "Giao hÃ ng")
                    {
                        btnGiaoHang.IsEnabled = true;
                    }
                    else
                    {
                        btnGiaoHang.IsEnabled = false;
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i chi tiáº¿t Ä‘Æ¡n hÃ ng: {ex.Message}", "Lá»—i API");
            }
        }

        private void BtnInLaiHoaDon_Click(object sender, RoutedEventArgs e)
        {
            if (dgDonHang.SelectedItem is DonHangDto selectedOrder)
            {
                MessageBox.Show($"Äang chuáº©n bá»‹ in HÄ {selectedOrder.IdHoaDon}...\n(Chá»©c nÄƒng nÃ y cáº§n logic in áº¥n riÃªng).", "ThÃ´ng bÃ¡o");
                // TODO: Gá»i service in áº¥n
            }
        }

        private async void BtnHuyDonHang_Click(object sender, RoutedEventArgs e)
        {
            if (dgDonHang.SelectedItem is DonHangDto selectedOrder)
            {
                var result = MessageBox.Show($"Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n Há»¦Y HÃ³a Ä‘Æ¡n {selectedOrder.IdHoaDon} khÃ´ng?", "XÃ¡c nháº­n Há»§y", MessageBoxButton.YesNo, MessageBoxImage.Warning);
                if (result == MessageBoxResult.No) return;

                await UpdateOrderStatus(selectedOrder.IdHoaDon, "Há»§y");
            }
        }

        private async void BtnGiaoHang_Click(object sender, RoutedEventArgs e)
        {
            if (dgDonHang.SelectedItem is DonHangDto selectedOrder)
            {
                var result = MessageBox.Show($"XÃ¡c nháº­n báº¯t Ä‘áº§u GIAO HÃ€NG cho HÄ {selectedOrder.IdHoaDon}?", "XÃ¡c nháº­n Giao hÃ ng", MessageBoxButton.YesNo, MessageBoxImage.Question);
                if (result == MessageBoxResult.No) return;

                await UpdateOrderStatus(selectedOrder.IdHoaDon, "Äang giao");
            }
        }

        private async Task UpdateOrderStatus(int hoaDonId, string newStatus)
        {
            try
            {
                var response = await httpClient.PutAsJsonAsync($"api/app/donhang/update-status/{hoaDonId}", newStatus);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show($"Cáº­p nháº­t tráº¡ng thÃ¡i thÃ nh '{newStatus}' thÃ nh cÃ´ng.", "ThÃ nh cÃ´ng");
                    await LoadDataGridAsync(); // Táº£i láº¡i danh sÃ¡ch
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
        }

        private void BtnExportToExcel_Click(object sender, RoutedEventArgs e)
        {
            var sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                FileName = $"DSDonHang_{DateTime.Now:yyyyMMdd_HHmm}.xlsx"
            };

            if (sfd.ShowDialog() == true)
            {
                try
                {
                    ExcelPackage.License.SetNonCommercialPersonal("CafeBook");
                    using (var package = new ExcelPackage(new FileInfo(sfd.FileName)))
                    {
                        var ws = package.Workbook.Worksheets.Add("DanhSachDonHang");
                        ws.Cells["A1"].Value = "Danh sÃ¡ch ÄÆ¡n hÃ ng";
                        ws.Cells["A1:D1"].Merge = true;
                        ws.Cells["A1"].Style.Font.Bold = true;
                        ws.Cells["A1"].Style.Font.Size = 16;

                        ws.Cells["A3"].LoadFromCollection(_currentOrderList, true, OfficeOpenXml.Table.TableStyles.Medium9);

                        // Äá»‹nh dáº¡ng cá»™t
                        ws.Column(2).Style.Numberformat.Format = "dd/MM/yyyy HH:mm";
                        ws.Column(6).Style.Numberformat.Format = "#,##0 \"Ä‘\"";
                        ws.Cells[ws.Dimension.Address].AutoFitColumns();

                        package.Save();
                    }
                    MessageBox.Show("Xuáº¥t Excel thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Lá»—i khi xuáº¥t Excel: {ex.Message}", "Lá»—i");
                }
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyDonViChuyenDoiView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyDonViChuyenDoiView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyDonViChuyenDoiView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quáº£n lÃ½ ÄÆ¡n vá»‹ Chuyá»ƒn Ä‘á»•i"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>

        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>


        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Quáº£n lÃ½ ÄÆ¡n vá»‹ Chuyá»ƒn Ä‘á»•i" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="380"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Margin="10,0,15,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Text="Danh sÃ¡ch ÄÆ¡n vá»‹ tÃ­nh" Style="{StaticResource HeaderTextBlock}"/>
                        <DataGrid Grid.Row="1" x:Name="dgDonVi" AutoGenerateColumns="False" IsReadOnly="True" 
                                  SelectionMode="Single" SelectionChanged="DgDonVi_SelectionChanged"
                                  BorderThickness="0" RowHeaderWidth="0">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="TÃªn NguyÃªn Liá»‡u" Binding="{Binding TenNguyenLieu}" Width="*"/>
                                <DataGridTextColumn Header="TÃªn ÄÆ¡n Vá»‹" Binding="{Binding TenDonVi}" Width="100"/>
                                <DataGridTextColumn Header="Há»‡ sá»‘ Quy Ä‘á»•i" Binding="{Binding GiaTriQuyDoi}" Width="100"/>
                                <DataGridCheckBoxColumn Header="ÄV CÆ¡ báº£n?" Binding="{Binding LaDonViCoBan}" Width="80"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>

                <Border Grid.Column="1" Margin="0,0,10,10" Style="{StaticResource CardBorder}">
                    <StackPanel>
                        <TextBlock Text="ThÃ´ng tin ÄÆ¡n vá»‹" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,15"/>

                        <TextBlock Text="Thuá»™c NguyÃªn liá»‡u (*):" Margin="0,0,0,5"/>
                        <ComboBox x:Name="cmbNguyenLieu" DisplayMemberPath="Ten" SelectedValuePath="Id" Margin="0,0,0,10"
                                  IsEditable="True" IsTextSearchEnabled="True"/>

                        <TextBlock Text="TÃªn ÄÆ¡n vá»‹ (vd: gram, ml, gÃ³i) (*):" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtTenDonVi" Margin="0,0,0,10"/>

                        <TextBlock x:Name="lblGiaTriQuyDoi" Text="GiÃ¡ trá»‹ quy Ä‘á»•i (so vá»›i ÄVT cÆ¡ báº£n) (*):" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtGiaTriQuyDoi" Margin="0,0,0,10"/>

                        <CheckBox x:Name="chkLaDonViCoBan" Content="ÄÃ¢y lÃ  ÄÆ¡n vá»‹ cÆ¡ báº£n (Há»‡ sá»‘ = 1)" 
                                  Margin="0,10,0,15" Checked="ChkLaDonViCoBan_Changed" Unchecked="ChkLaDonViCoBan_Changed"/>

                        <Grid Height="40">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Button x:Name="btnLamMoi" Grid.Column="0" ToolTip="LÃ m má»›i" Click="BtnLamMoi_Click" Background="Transparent" BorderThickness="0">
                                <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="22" Height="22"/>
                            </Button>
                            <Button x:Name="btnThem" Grid.Column="1" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionGreenBrush}" Click="BtnThem_Click" Margin="10,0,5,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconAdd}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="ThÃªm" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                            <Button x:Name="btnLuu" Grid.Column="2" Style="{StaticResource PrimaryButton}" Click="BtnLuu_Click" Margin="5,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconSave}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="LÆ°u" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                            <Button x:Name="btnXoa" Grid.Column="3" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionRedBrush}" Click="BtnXoa_Click" Margin="5,0,0,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconDelete}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="XÃ³a" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </Grid>
                    </StackPanel>
                </Border>
            </Grid>

            <Button x:Name="btnQuayLai" Grid.Row="2" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" Margin="10,0,0,10"
                    Click="BtnQuayLai_Click">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                    <TextBlock Text="Quay láº¡i Tá»“n Kho" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Äang táº£i..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyDonViChuyenDoiView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using System.Globalization;

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyDonViChuyenDoiView : Page
    {
        private static readonly HttpClient httpClient;
        private List<DonViChuyenDoiDtoo> _allDonViList = new List<DonViChuyenDoiDtoo>();
        private List<FilterLookupDto> _nguyenLieuList = new List<FilterLookupDto>();
        private DonViChuyenDoiDtoo? _selectedDonVi = null;

        static QuanLyDonViChuyenDoiView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyDonViChuyenDoiView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadNguyenLieuComboBox();
            await LoadDataGridAsync();
            ResetForm();
        }

        /// <summary>
        /// Táº£i danh sÃ¡ch NguyÃªn liá»‡u cho ComboBox
        /// </summary>
        private async Task LoadNguyenLieuComboBox()
        {
            try
            {
                // Táº­n dá»¥ng API 'filters' cá»§a SanPham
                var filters = await httpClient.GetFromJsonAsync<SanPhamFiltersDto>("api/app/sanpham/filters");
                if (filters != null)
                {
                    _nguyenLieuList = filters.NguyenLieus;
                    _nguyenLieuList.Insert(0, new FilterLookupDto { Id = 0, Ten = "-- Chá»n NguyÃªn Liá»‡u --" });
                    cmbNguyenLieu.ItemsSource = _nguyenLieuList;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i danh sÃ¡ch nguyÃªn liá»‡u: {ex.Message}", "Lá»—i API");
            }
        }

        /// <summary>
        /// Táº£i DataGrid
        /// </summary>
        private async Task LoadDataGridAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                _allDonViList = (await httpClient.GetFromJsonAsync<List<DonViChuyenDoiDtoo>>("api/app/donvichuyendoi")) ?? new List<DonViChuyenDoiDtoo>();
                dgDonVi.ItemsSource = _allDonViList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i danh sÃ¡ch Ä‘Æ¡n vá»‹: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        /// <summary>
        /// ÄÆ°a Form vá» tráº¡ng thÃ¡i thÃªm má»›i
        /// </summary>
        private void ResetForm()
        {
            _selectedDonVi = null;
            dgDonVi.SelectedItem = null;
            btnThem.IsEnabled = true;
            btnLuu.IsEnabled = false;
            btnXoa.IsEnabled = false;

            cmbNguyenLieu.SelectedValue = 0;
            txtTenDonVi.Text = "";
            txtGiaTriQuyDoi.Text = "0";
            chkLaDonViCoBan.IsChecked = false;

            // KÃ­ch hoáº¡t láº¡i cÃ¡c trÆ°á»ng
            cmbNguyenLieu.IsEnabled = true;
            txtGiaTriQuyDoi.IsEnabled = true;
            lblGiaTriQuyDoi.Visibility = Visibility.Visible;
            txtGiaTriQuyDoi.Visibility = Visibility.Visible;
        }

        private void DgDonVi_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgDonVi.SelectedItem is not DonViChuyenDoiDtoo selected)
            {
                ResetForm();
                return;
            }

            _selectedDonVi = selected;
            btnThem.IsEnabled = false;
            btnLuu.IsEnabled = true;
            btnXoa.IsEnabled = true;

            cmbNguyenLieu.SelectedValue = selected.IdNguyenLieu;
            txtTenDonVi.Text = selected.TenDonVi;
            txtGiaTriQuyDoi.Text = selected.GiaTriQuyDoi.ToString(CultureInfo.InvariantCulture);
            chkLaDonViCoBan.IsChecked = selected.LaDonViCoBan;

            // KhÃ´ng cho phÃ©p Ä‘á»•i NguyÃªn liá»‡u khi Sá»­a (Ä‘á»ƒ trÃ¡nh lá»—i logic)
            cmbNguyenLieu.IsEnabled = false;
        }

        private void ChkLaDonViCoBan_Changed(object sender, RoutedEventArgs e)
        {
            if (chkLaDonViCoBan.IsChecked == true)
            {
                txtGiaTriQuyDoi.Text = "1";
                txtGiaTriQuyDoi.IsEnabled = false;
                lblGiaTriQuyDoi.Visibility = Visibility.Collapsed;
                txtGiaTriQuyDoi.Visibility = Visibility.Collapsed;
            }
            else
            {
                txtGiaTriQuyDoi.Text = "0";
                txtGiaTriQuyDoi.IsEnabled = true;
                lblGiaTriQuyDoi.Visibility = Visibility.Visible;
                txtGiaTriQuyDoi.Visibility = Visibility.Visible;
            }
        }

        private async void BtnThem_Click(object sender, RoutedEventArgs e)
        {
            await SaveAsync(isCreating: true);
        }

        private async void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            await SaveAsync(isCreating: false);
        }

        private async Task SaveAsync(bool isCreating)
        {
            if ((int)cmbNguyenLieu.SelectedValue == 0)
            {
                MessageBox.Show("Vui lÃ²ng chá»n nguyÃªn liá»‡u.", "Lá»—i"); return;
            }
            if (string.IsNullOrWhiteSpace(txtTenDonVi.Text))
            {
                MessageBox.Show("TÃªn Ä‘Æ¡n vá»‹ khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.", "Lá»—i"); return;
            }
            if (!decimal.TryParse(txtGiaTriQuyDoi.Text, NumberStyles.Any, CultureInfo.InvariantCulture, out decimal giaTri) || giaTri <= 0)
            {
                MessageBox.Show("GiÃ¡ trá»‹ quy Ä‘á»•i pháº£i lÃ  sá»‘ dÆ°Æ¡ng.", "Lá»—i"); return;
            }

            var dto = new DonViChuyenDoiUpdateRequestDto
            {
                IdNguyenLieu = (int)cmbNguyenLieu.SelectedValue,
                TenDonVi = txtTenDonVi.Text,
                GiaTriQuyDoi = giaTri,
                LaDonViCoBan = chkLaDonViCoBan.IsChecked ?? false
            };

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                HttpResponseMessage response;
                if (isCreating)
                {
                    response = await httpClient.PostAsJsonAsync("api/app/donvichuyendoi", dto);
                }
                else
                {
                    response = await httpClient.PutAsJsonAsync($"api/app/donvichuyendoi/{_selectedDonVi?.IdChuyenDoi}", dto);
                }

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("LÆ°u thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadDataGridAsync();
                    ResetForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXoa_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedDonVi == null) return;

            var result = MessageBox.Show($"Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a Ä‘Æ¡n vá»‹ '{_selectedDonVi.TenDonVi}' cá»§a '{_selectedDonVi.TenNguyenLieu}'?", "XÃ¡c nháº­n", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/donvichuyendoi/{_selectedDonVi.IdChuyenDoi}");
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("XÃ³a thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadDataGridAsync();
                    ResetForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "KhÃ´ng thá»ƒ xÃ³a");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnLamMoi_Click(object sender, RoutedEventArgs e)
        {
            ResetForm();
        }

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyDonXinNghiView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyDonXinNghiView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyDonXinNghiView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quáº£n lÃ½ ÄÆ¡n Xin Nghá»‰"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionOrangeBrush" Color="#FFA726"/>
        <SolidColorBrush x:Key="StatusPendingBrush" Color="#FFC107"/>
        <SolidColorBrush x:Key="StatusRejectedBrush" Color="#F44336"/>
        <SolidColorBrush x:Key="StatusApprovedBrush" Color="#4CAF50"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        
        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>
        <Geometry x:Key="IconApprove">M12,2C6.48,2 2,6.48 2,12C2,17.52 6.48,22 12,22C17.52,22 22,17.52 22,12C22,6.48 17.52,2 12,2M10,17L5,12L6.41,10.59L10,14.17L17.59,6.58L19,8L10,17Z</Geometry>
        <Geometry x:Key="IconReject">M12,2C6.48,2 2,6.48 2,12C2,17.52 6.48,22 12,22C17.52,22 22,17.52 22,12C22,6.48 17.52,2 12,2M17,13.41L13.41,17L12,15.59L8.41,19L7,17.59L10.59,14L7,10.41L8.41,9L12,12.59L15.59,9L17,10.41L13.41,14L17,17.59V13.41Z</Geometry>
        <Geometry x:Key="IconReport">M10,17L6,21H18L14,17H10M10,10H14V15H10V10M4,3H20C21.1,3 22,3.9 22,5V17C22,18.1 21.1,19 20,19H4C2.9,19 2,18.1 2,17V5C2,3.9 2.9,3 4,3Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>

        <Style x:Key="StatusTextBlock" TargetType="TextBlock">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="8,3"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Text" Value="{Binding TrangThai}"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding TrangThai}" Value="Chá» duyá»‡t">
                    <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
                    <Setter Property="Background" Value="{StaticResource StatusPendingBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TrangThai}" Value="ÄÃ£ duyá»‡t">
                    <Setter Property="Foreground" Value="White"/>
                    <Setter Property="Background" Value="{StaticResource StatusApprovedBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TrangThai}" Value="ÄÃ£ tá»« chá»‘i">
                    <Setter Property="Foreground" Value="White"/>
                    <Setter Property="Background" Value="{StaticResource StatusRejectedBrush}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Quáº£n lÃ½ ÄÆ¡n Xin Nghá»‰" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="420"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Margin="10,0,15,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                            <TextBlock Text="TÃ¬m kiáº¿m:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                            <TextBox x:Name="txtSearchNhanVien" Width="200" TextChanged="Filters_Changed"/>

                            <TextBlock Text="Tráº¡ng thÃ¡i:" VerticalAlignment="Center" Margin="15,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                            <ComboBox x:Name="cmbTrangThaiFilter" Width="150" SelectionChanged="Filters_Changed">
                                <ComboBoxItem Content="Táº¥t cáº£"/>
                                <ComboBoxItem Content="Chá» duyá»‡t"/>
                                <ComboBoxItem Content="ÄÃ£ duyá»‡t"/>
                                <ComboBoxItem Content="ÄÃ£ tá»« chá»‘i"/>
                            </ComboBox>
                        </StackPanel>

                        <DataGrid Grid.Row="1" x:Name="dgDonXinNghi" AutoGenerateColumns="False" IsReadOnly="True" 
                                  SelectionMode="Single" SelectionChanged="DgDonXinNghi_SelectionChanged"
                                  BorderThickness="0" RowHeaderWidth="0">
                            <DataGrid.Columns>
                                <DataGridTemplateColumn Header="Tráº¡ng thÃ¡i" Width="100">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Border CornerRadius="4" Margin="2">
                                                <TextBlock Style="{StaticResource StatusTextBlock}"/>
                                            </Border>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTextColumn Header="NhÃ¢n viÃªn" Binding="{Binding TenNhanVien}" Width="*"/>
                                <DataGridTextColumn Header="Tá»« NgÃ y" Binding="{Binding NgayBatDau, StringFormat='dd/MM/yyyy'}" Width="100"/>
                                <DataGridTextColumn Header="Äáº¿n NgÃ y" Binding="{Binding NgayKetThuc, StringFormat='dd/MM/yyyy'}" Width="100"/>
                                <DataGridTextColumn Header="LÃ½ do" Binding="{Binding LyDo}" Width="2*"/>
                                <DataGridTextColumn Header="NgÆ°á»i duyá»‡t" Binding="{Binding TenNguoiDuyet}" Width="120"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>

                <Border Grid.Column="1" Margin="0,0,10,10" Style="{StaticResource CardBorder}">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock x:Name="lblFormTitle" Text="Táº¡o ÄÆ¡n Má»›i" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,5,0,15" VerticalAlignment="Center"/>
                                <Button x:Name="btnLamMoi" Grid.Column="1" ToolTip="Táº¡o Ä‘Æ¡n má»›i" Click="BtnLamMoi_Click" Style="{StaticResource PrimaryButton}" Background="Transparent" BorderThickness="0">
                                    <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="22" Height="22"/>
                                </Button>
                            </Grid>

                            <StackPanel x:Name="formTaoDon">
                                <TextBlock Text="NhÃ¢n viÃªn xin nghá»‰:" Margin="0,0,0,5" FontSize="12" FontWeight="SemiBold"/>
                                <ComboBox x:Name="cmbNhanVien" DisplayMemberPath="HoTen" SelectedValuePath="IdNhanVien" Margin="0,0,0,10"/>

                                <TextBlock Text="Loáº¡i Ä‘Æ¡n:" Margin="0,0,0,5" FontSize="12" FontWeight="SemiBold"/>
                                <ComboBox x:Name="cmbLoaiDon" Margin="0,0,0,10">
                                    <ComboBoxItem Content="Nghá»‰ cÃ³ phÃ©p"/>
                                    <ComboBoxItem Content="Nghá»‰ khÃ´ng phÃ©p"/>
                                    <ComboBoxItem Content="Nghá»‰ bá»‡nh"/>
                                </ComboBox>

                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0" Margin="0,0,5,0">
                                        <TextBlock Text="Tá»« NgÃ y:" Margin="0,0,0,5" FontSize="12" FontWeight="SemiBold"/>
                                        <DatePicker x:Name="dpNgayBatDau" Margin="0,0,0,10"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="1" Margin="5,0,0,0">
                                        <TextBlock Text="Äáº¿n NgÃ y:" Margin="0,0,0,5" FontSize="12" FontWeight="SemiBold"/>
                                        <DatePicker x:Name="dpNgayKetThuc" Margin="0,0,0,10"/>
                                    </StackPanel>
                                </Grid>

                                <TextBlock Text="LÃ½ do:" Margin="0,0,0,5" FontSize="12" FontWeight="SemiBold"/>
                                <TextBox x:Name="txtLyDo" Margin="0,0,0,15" Height="80" TextWrapping="Wrap" AcceptsReturn="True"/>

                                <Button x:Name="btnThemDon" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionBlueBrush}" 
                                        Click="BtnThemDon_Click" Padding="12">
                                    <StackPanel Orientation="Horizontal">
                                        <Path Data="{StaticResource IconAdd}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                        <TextBlock Text="Táº¡o ÄÆ¡n Xin Nghá»‰" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>

                            <StackPanel x:Name="formDuyetDon" Visibility="Collapsed">
                                <TextBlock Text="Ghi chÃº phÃª duyá»‡t:" Margin="0,15,0,5" FontSize="12" FontWeight="SemiBold"/>
                                <TextBox x:Name="txtGhiChuPheDuyet" Margin="0,0,0,15" Height="60" TextWrapping="Wrap" AcceptsReturn="True"/>

                                <Grid Height="40" Margin="0,5,0,15">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Button x:Name="btnDuyet" Grid.Column="0" Style="{StaticResource PrimaryButton}" Background="{StaticResource StatusApprovedBrush}" 
                                            Click="BtnDuyet_Click" Margin="0,0,5,0">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconApprove}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                            <TextBlock Text="Duyá»‡t ÄÆ¡n" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                    <Button x:Name="btnTuChoi" Grid.Column="1" Style="{StaticResource PrimaryButton}" Background="{StaticResource StatusRejectedBrush}" 
                                            Click="BtnTuChoi_Click" Margin="5,0,0,0">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconReject}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                            <TextBlock Text="Tá»« Chá»‘i" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                </Grid>

                                <Button x:Name="btnXoa" Style="{StaticResource PrimaryButton}" Background="{StaticResource TextGrayBrush}" 
                                        Click="BtnXoa_Click" Padding="12">
                                    <StackPanel Orientation="Horizontal">
                                        <Path Data="{StaticResource IconDelete}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                        <TextBlock Text="XÃ³a ÄÆ¡n (Há»§y yÃªu cáº§u)" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                            <Button x:Name="btnGoToBaoCao" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionBlueBrush}" 
                                Click="BtnGoToBaoCao_Click" Margin="0,20,0,0">
                                <StackPanel Orientation="Horizontal">
                                    <Path Data="{StaticResource IconReport}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                    <TextBlock Text="Xem BÃ¡o CÃ¡o Nghá»‰ PhÃ©p" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </ScrollViewer>
                </Border>
            </Grid>

            <Button x:Name="btnQuayLai" Grid.Row="2" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" Margin="10,0,0,10"
                    Click="BtnQuayLai_Click">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                    <TextBlock Text="Quay láº¡i" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Äang xá»­ lÃ½..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyDonXinNghiView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Threading.Tasks;
using System.Net;
using AppCafebookApi.Services; // Cáº§n cho AuthService

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyDonXinNghiView : Page
    {
        private static readonly HttpClient httpClient;
        private List<DonXinNghiDto> _allDonNghiList = new List<DonXinNghiDto>();
        private List<NhanVienLookupDto> _allNhanVienList = new List<NhanVienLookupDto>();
        private DonXinNghiDto? _selectedDon = null;

        static QuanLyDonXinNghiView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyDonXinNghiView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            await LoadNhanVienAsync();
            cmbTrangThaiFilter.SelectedIndex = 1; // Máº·c Ä‘á»‹nh lá»c "Chá» duyá»‡t"
            await LoadDataGridAsync();
            ResetForm();
            LoadingOverlay.Visibility = Visibility.Collapsed;
        }

        #region Táº£i Dá»¯ Liá»‡u & Lá»c

        private async Task LoadNhanVienAsync()
        {
            try
            {
                // Táº­n dá»¥ng API cá»§a Module 4
                _allNhanVienList = (await httpClient.GetFromJsonAsync<List<NhanVienLookupDto>>("api/app/lichlamviec/all-nhanvien")) ?? new List<NhanVienLookupDto>();
                cmbNhanVien.ItemsSource = _allNhanVienList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i danh sÃ¡ch nhÃ¢n viÃªn: {ex.Message}", "Lá»—i API");
            }
        }

        private async Task LoadDataGridAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;

            string searchText = txtSearchNhanVien.Text;
            string trangThai = (cmbTrangThaiFilter.SelectedItem as ComboBoxItem)?.Content.ToString() ?? "Táº¥t cáº£";

            try
            {
                var url = $"api/app/donxinnghi/search?searchText={Uri.EscapeDataString(searchText)}&trangThai={Uri.EscapeDataString(trangThai)}";
                _allDonNghiList = (await httpClient.GetFromJsonAsync<List<DonXinNghiDto>>(url)) ?? new List<DonXinNghiDto>();
                dgDonXinNghi.ItemsSource = _allDonNghiList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i danh sÃ¡ch Ä‘Æ¡n nghá»‰: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void Filters_Changed(object sender, RoutedEventArgs e)
        {
            if (this.IsLoaded)
                await LoadDataGridAsync();
        }

        #endregion

        #region Form & CRUD

        private void ResetForm()
        {
            _selectedDon = null;
            dgDonXinNghi.SelectedItem = null;

            lblFormTitle.Text = "Táº¡o ÄÆ¡n Má»›i";
            formTaoDon.Visibility = Visibility.Visible;
            formDuyetDon.Visibility = Visibility.Collapsed;

            cmbNhanVien.SelectedValue = -1;
            cmbLoaiDon.SelectedIndex = 0; // Nghá»‰ cÃ³ phÃ©p
            dpNgayBatDau.SelectedDate = DateTime.Today;
            dpNgayKetThuc.SelectedDate = DateTime.Today;
            txtLyDo.Text = "";
            txtGhiChuPheDuyet.Text = "";

            // GÃ¡n nhÃ¢n viÃªn máº·c Ä‘á»‹nh náº¿u ngÆ°á»i dÃ¹ng lÃ  NV
            if (AuthService.CurrentUser != null && AuthService.CurrentUser.TenVaiTro != "Quáº£n lÃ½" && AuthService.CurrentUser.TenVaiTro != "Quáº£n trá»‹ viÃªn")
            {
                cmbNhanVien.SelectedValue = AuthService.CurrentUser.IdNhanVien;
                cmbNhanVien.IsEnabled = false; // NV khÃ´ng thá»ƒ táº¡o Ä‘Æ¡n cho ngÆ°á»i khÃ¡c
            }
            else
            {
                cmbNhanVien.IsEnabled = true;
            }
        }

        private void DgDonXinNghi_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgDonXinNghi.SelectedItem is not DonXinNghiDto selected)
            {
                ResetForm();
                return;
            }

            _selectedDon = selected;

            lblFormTitle.Text = $"Chi tiáº¿t ÄÆ¡n: {selected.TenNhanVien}";
            formTaoDon.Visibility = Visibility.Visible; // Hiá»ƒn thá»‹ thÃ´ng tin

            // Äiá»n thÃ´ng tin
            cmbNhanVien.SelectedValue = _allNhanVienList.FirstOrDefault(nv => nv.HoTen == selected.TenNhanVien)?.IdNhanVien ?? -1;
            cmbLoaiDon.Text = selected.LoaiDon;
            dpNgayBatDau.SelectedDate = selected.NgayBatDau;
            dpNgayKetThuc.SelectedDate = selected.NgayKetThuc;
            txtLyDo.Text = selected.LyDo;
            txtGhiChuPheDuyet.Text = selected.GhiChuPheDuyet;

            // Kiá»ƒm tra quyá»n (Quáº£n lÃ½ má»›i tháº¥y nÃºt duyá»‡t)
            if (AuthService.CoQuyen("NhanSu.QuanLy")) // Giáº£ sá»­ quyá»n lÃ  "NhanSu.QuanLy"
            {
                if (selected.TrangThai == "Chá» duyá»‡t")
                {
                    formDuyetDon.Visibility = Visibility.Visible;
                    btnXoa.IsEnabled = true; // Cho phÃ©p XÃ³a (Há»§y)
                }
                else
                {
                    formDuyetDon.Visibility = Visibility.Collapsed; // ÄÃ£ xá»­ lÃ½, áº©n nÃºt
                    btnXoa.IsEnabled = false; // KhÃ´ng cho xÃ³a
                }
                // Admin cÃ³ thá»ƒ sá»­a Ä‘Æ¡n chÆ°a duyá»‡t
                formTaoDon.IsEnabled = (selected.TrangThai == "Chá» duyá»‡t");
                btnThemDon.Visibility = Visibility.Collapsed; // áº¨n nÃºt ThÃªm khi Ä‘ang xem
            }
            else // Náº¿u lÃ  nhÃ¢n viÃªn
            {
                formTaoDon.IsEnabled = false; // NV khÃ´ng Ä‘Æ°á»£c sá»­a sau khi táº¡o
                formDuyetDon.Visibility = Visibility.Collapsed; // NV khÃ´ng Ä‘Æ°á»£c duyá»‡t
            }
        }

        private void BtnLamMoi_Click(object sender, RoutedEventArgs e)
        {
            ResetForm();
        }

        private async void BtnThemDon_Click(object sender, RoutedEventArgs e)
        {
            if (cmbNhanVien.SelectedValue == null)
            {
                MessageBox.Show("Vui lÃ²ng chá»n nhÃ¢n viÃªn.", "Lá»—i"); return;
            }
            if (dpNgayBatDau.SelectedDate == null || dpNgayKetThuc.SelectedDate == null)
            {
                MessageBox.Show("Vui lÃ²ng chá»n ngÃ y báº¯t Ä‘áº§u vÃ  káº¿t thÃºc.", "Lá»—i"); return;
            }
            if (dpNgayKetThuc.SelectedDate < dpNgayBatDau.SelectedDate)
            {
                MessageBox.Show("NgÃ y káº¿t thÃºc khÃ´ng thá»ƒ trÆ°á»›c ngÃ y báº¯t Ä‘áº§u.", "Lá»—i"); return;
            }

            var dto = new DonXinNghiCreateDto
            {
                IdNhanVien = (int)cmbNhanVien.SelectedValue,
                LoaiDon = (cmbLoaiDon.SelectedItem as ComboBoxItem)?.Content.ToString() ?? "Nghá»‰ cÃ³ phÃ©p",
                LyDo = txtLyDo.Text,
                NgayBatDau = dpNgayBatDau.SelectedDate.Value,
                NgayKetThuc = dpNgayKetThuc.SelectedDate.Value
            };

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/donxinnghi", dto);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Táº¡o Ä‘Æ¡n thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadDataGridAsync();
                    ResetForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnDuyet_Click(object sender, RoutedEventArgs e)
        {
            await HandleApprovalAsync(isApproving: true);
        }

        private async void BtnTuChoi_Click(object sender, RoutedEventArgs e)
        {
            await HandleApprovalAsync(isApproving: false);
        }

        private async Task HandleApprovalAsync(bool isApproving)
        {
            if (_selectedDon == null) return;
            if (AuthService.CurrentUser == null)
            {
                MessageBox.Show("Lá»—i phiÃªn Ä‘Äƒng nháº­p. KhÃ´ng tÃ¬m tháº¥y ngÆ°á»i duyá»‡t.", "Lá»—i"); return;
            }

            var dto = new DonXinNghiActionDto
            {
                IdNguoiDuyet = AuthService.CurrentUser.IdNhanVien,
                GhiChuPheDuyet = txtGhiChuPheDuyet.Text
            };

            string endpoint = isApproving ? $"api/app/donxinnghi/approve/{_selectedDon.IdDonXinNghi}"
                                          : $"api/app/donxinnghi/reject/{_selectedDon.IdDonXinNghi}";

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PutAsJsonAsync(endpoint, dto);
                var responseString = await response.Content.ReadAsStringAsync();

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show(isApproving ? "Duyá»‡t Ä‘Æ¡n thÃ nh cÃ´ng." : "ÄÃ£ tá»« chá»‘i Ä‘Æ¡n.", "ThÃ´ng bÃ¡o");
                    await LoadDataGridAsync();
                    ResetForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {responseString}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXoa_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedDon == null || _selectedDon.TrangThai != "Chá» duyá»‡t")
            {
                MessageBox.Show("Chá»‰ cÃ³ thá»ƒ xÃ³a Ä‘Æ¡n á»Ÿ tráº¡ng thÃ¡i 'Chá» duyá»‡t'.", "KhÃ´ng thá»ƒ xÃ³a");
                return;
            }

            var result = MessageBox.Show($"Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a Ä‘Æ¡n cá»§a '{_selectedDon.TenNhanVien}'?", "XÃ¡c nháº­n", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/donxinnghi/{_selectedDon.IdDonXinNghi}");
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("XÃ³a Ä‘Æ¡n thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadDataGridAsync();
                    ResetForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "KhÃ´ng thá»ƒ xÃ³a");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion
        private void BtnGoToBaoCao_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new BaoCaoNhanSuView());
        }
        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            // Quay láº¡i trang QL Lá»‹ch (Module 4)
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyKiemKhoView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyKiemKhoView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyKiemKhoView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quáº£n lÃ½ Kiá»ƒm Kho" FontFamily="Segoe UI" Loaded="Page_Loaded"
      Background="#FFF8E1">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Quáº£n lÃ½ Kiá»ƒm Kho" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="2*"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Margin="10,0,15,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Text="Lá»‹ch sá»­ Phiáº¿u Kiá»ƒm Kho" Style="{StaticResource HeaderTextBlock}"/>
                        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,10">
                            <TextBlock Text="Tá»«:" VerticalAlignment="Center"/>
                            <DatePicker x:Name="dpTuNgay_Phieu" Width="120" Margin="5,0,0,0"/>
                            <TextBlock Text="Äáº¿n:" VerticalAlignment="Center" Margin="10,0,5,0"/>
                            <DatePicker x:Name="dpDenNgay_Phieu" Width="120" Margin="0,0,10,0"/>
                            <Button x:Name="btnLocPhieu" Content="Lá»c" Style="{StaticResource PrimaryButton}" Padding="10,5" Click="BtnLocPhieu_Click" Width="50"/>
                        </StackPanel>
                        <DataGrid Grid.Row="2" x:Name="dgPhieuKiemKho" AutoGenerateColumns="False" IsReadOnly="True" 
                                  SelectionMode="Single" SelectionChanged="DgPhieuKiemKho_SelectionChanged" 
                                  BorderThickness="0" RowHeaderWidth="0">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ID" Binding="{Binding IdPhieuKiemKho}" Width="40"/>
                                <DataGridTextColumn Header="NgÃ y Kiá»ƒm" Binding="{Binding NgayKiem, StringFormat='dd/MM/yyyy'}" Width="100"/>
                                <DataGridTextColumn Header="NgÆ°á»i Kiá»ƒm" Binding="{Binding TenNhanVienKiem}" Width="*"/>
                                <DataGridTextColumn Header="Tráº¡ng thÃ¡i" Binding="{Binding TrangThai}" Width="100"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>

                <Border Grid.Column="1" Margin="0,0,10,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <Grid Grid.Row="0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" x:Name="lblChiTietTitle" Text="Chi tiáº¿t Phiáº¿u Kiá»ƒm Kho" Style="{StaticResource HeaderTextBlock}"/>
                            <Button Grid.Column="1" x:Name="btnTaoPhieuMoi" Style="{StaticResource PrimaryButton}" Click="BtnTaoPhieuMoi_Click" Padding="10,8">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconNew}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="Táº¡o Phiáº¿u Kiá»ƒm Má»›i" VerticalAlignment="Center" Margin="0,1,0,0"/>
                                </StackPanel>
                            </Button>
                        </Grid>

                        <Border Grid.Row="1" x:Name="panelNhapChiTiet" Background="{StaticResource LightCreamBrush}" 
                                CornerRadius="4" Padding="15" Margin="0,0,0,15"
                                IsEnabled="False">
                            <StackPanel>
                                <TextBlock x:Name="lblTenNL_ChiTiet" Text="Chá»n má»™t nguyÃªn liá»‡u tá»« lÆ°á»›i bÃªn dÆ°á»›i..." FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}"/>
                                <Grid Margin="0,10,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0" Text="Tá»“n HT:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                    <TextBlock Grid.Column="1" x:Name="lblTonKhoHT_ChiTiet" Text="0" VerticalAlignment="Center" FontWeight="Bold"/>

                                    <TextBlock Grid.Column="2" Text="Tá»“n Thá»±c Táº¿ (*):" VerticalAlignment="Center" Margin="10,0,5,0"/>
                                    <TextBox Grid.Column="3" x:Name="txtTonKhoThucTe" Width="80" HorizontalAlignment="Left"/>
                                </Grid>
                                <Grid Margin="0,10,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="LÃ½ do chÃªnh lá»‡ch:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                    <TextBox Grid.Column="1" x:Name="txtLyDo"/>
                                    <Button Grid.Column="2" x:Name="btnCapNhatDong" Content="Cáº­p nháº­t" Style="{StaticResource PrimaryButton}" Padding="10,5" Margin="10,0,0,0"
                                            Click="BtnCapNhatDong_Click"/>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,0,0,10">
                            <TextBlock Text="TÃ¬m kiáº¿m nguyÃªn liá»‡u:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="{StaticResource TextGrayBrush}"/>
                            <TextBox x:Name="txtSearchKiemKho" Width="300" TextChanged="TxtSearchKiemKho_TextChanged"/>
                        </StackPanel>

                        <DataGrid Grid.Row="3" x:Name="dgChiTietKiemKho" AutoGenerateColumns="False" Margin="0,0,0,10"
                                  IsReadOnly="True" CanUserAddRows="False" CanUserDeleteRows="False"
                                  SelectionChanged="DgChiTietKiemKho_SelectionChanged">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="TÃªn NguyÃªn liá»‡u" Binding="{Binding TenNguyenLieu}" Width="*" IsReadOnly="True"/>
                                <DataGridTextColumn Header="ÄVT" Binding="{Binding DonViTinh}" Width="80" IsReadOnly="True"/>
                                <DataGridTextColumn Header="Tá»“n (Há»‡ thá»‘ng)" Binding="{Binding TonKhoHeThong, StringFormat=N2}" Width="110" IsReadOnly="True"/>
                                <DataGridTextColumn Header="Tá»“n (Thá»±c táº¿)" Binding="{Binding TonKhoThucTe, StringFormat=N2}" Width="110" IsReadOnly="True"/>
                                <DataGridTextColumn Header="ChÃªnh lá»‡ch" Binding="{Binding ChenhLech, StringFormat=N2}" Width="100" IsReadOnly="True"/>
                                <DataGridTextColumn Header="LÃ½ do" Binding="{Binding LyDoChenhLech}" Width="*" IsReadOnly="True"/>
                            </DataGrid.Columns>
                        </DataGrid>

                        <StackPanel Grid.Row="4" Orientation="Horizontal" HorizontalAlignment="Right">
                            <TextBlock Text="Tá»•ng chÃªnh lá»‡ch (GiÃ¡ trá»‹):" VerticalAlignment="Center" Margin="0,0,10,0" FontWeight="SemiBold"/>
                            <TextBlock x:Name="lblTongChenhLech" Text="0 VND" VerticalAlignment="Center" FontSize="16" FontWeight="Bold" Foreground="{StaticResource ActionRedBrush}"/>
                            <Button x:Name="btnLuuPhieuKiem" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionGreenBrush}" Click="BtnLuuPhieuKiem_Click" Margin="20,0,0,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconSave}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="LÆ°u &amp; CÃ¢n Báº±ng Kho" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>

            <Button x:Name="btnQuayLai" Grid.Row="2" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" Margin="10,0,0,10"
                    Click="BtnQuayLai_Click">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="16" Height="16" Margin="0,0,5,0"/>
                    <TextBlock Text="Quay láº¡i Tá»“n Kho" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Äang táº£i..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyKiemKhoView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using System.Collections.ObjectModel;
using System.Globalization;
using AppCafebookApi.Services;

namespace AppCafebookApi.View.quanly.pages
{
    // (DTOs placeholder giá»¯ nguyÃªn - chÃºng nÃªn á»Ÿ trong /Model/ModelApp/KhoDto.cs)
    #region DTOs (Táº¡m thá»i Ä‘á»‹nh nghÄ©a á»Ÿ Ä‘Ã¢y)
    public class PhieuKiemKhoDto
    {
        public int IdPhieuKiemKho { get; set; }
        public DateTime NgayKiem { get; set; }
        public string TenNhanVienKiem { get; set; } = string.Empty;
        public string TrangThai { get; set; } = string.Empty;
    }

    public class ChiTietKiemKhoDto
    {
        public int IdNguyenLieu { get; set; }
        public string TenNguyenLieu { get; set; } = string.Empty;
        public string DonViTinh { get; set; } = string.Empty;
        public decimal TonKhoHeThong { get; set; }
        public decimal TonKhoThucTe { get; set; }
        public decimal ChenhLech => TonKhoThucTe - TonKhoHeThong;
        public string? LyDoChenhLech { get; set; }
        public decimal GiaTriChenhLech { get; set; }
    }

    public class PhieuKiemKhoCreateDto
    {
        public int IdNhanVien { get; set; }
        public DateTime NgayKiem { get; set; }
        public string? GhiChu { get; set; }
        public List<ChiTietKiemKhoDto> ChiTiet { get; set; } = new();
    }
    #endregion

    public partial class QuanLyKiemKhoView : Page
    {
        private static readonly HttpClient httpClient;

        private List<PhieuKiemKhoDto> _phieuKiemKhoList = new List<PhieuKiemKhoDto>();
        private ObservableCollection<ChiTietKiemKhoDto> _fullKiemKhoList = new ObservableCollection<ChiTietKiemKhoDto>();
        private ObservableCollection<ChiTietKiemKhoDto> _chiTietKiemKhoList = new ObservableCollection<ChiTietKiemKhoDto>();

        private PhieuKiemKhoDto? _selectedPhieu;
        private bool _isCreatingPhieu = false;

        static QuanLyKiemKhoView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyKiemKhoView()
        {
            InitializeComponent();
            dpTuNgay_Phieu.SelectedDate = DateTime.Today.AddDays(-30);
            dpDenNgay_Phieu.SelectedDate = DateTime.Today;
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadPhieuKiemKhoAsync();
            ResetForm();
        }

        private async Task LoadPhieuKiemKhoAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            DateTime? start = dpTuNgay_Phieu.SelectedDate;
            DateTime? end = dpDenNgay_Phieu.SelectedDate;

            try
            {
                string url = "api/app/kho/phieukiemkho";
                if (start.HasValue && end.HasValue)
                {
                    url += $"?startDate={start.Value:yyyy-MM-dd}&endDate={end.Value:yyyy-MM-dd}";
                }

                _phieuKiemKhoList = (await httpClient.GetFromJsonAsync<List<PhieuKiemKhoDto>>(url)) ?? new List<PhieuKiemKhoDto>();
                dgPhieuKiemKho.ItemsSource = _phieuKiemKhoList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i phiáº¿u kiá»ƒm kho: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void ResetForm()
        {
            _selectedPhieu = null;
            _isCreatingPhieu = false;
            dgPhieuKiemKho.SelectedItem = null;

            lblChiTietTitle.Text = "Chi tiáº¿t Phiáº¿u Kiá»ƒm Kho";
            lblTongChenhLech.Text = "0 VND";
            txtSearchKiemKho.Text = "";

            _chiTietKiemKhoList.Clear();
            _fullKiemKhoList.Clear();
            dgChiTietKiemKho.ItemsSource = null;
            dgChiTietKiemKho.IsReadOnly = true;
            btnLuuPhieuKiem.IsEnabled = false;

            panelNhapChiTiet.IsEnabled = false; // Táº¯t form nháº­p
            ResetChiTietForm();
        }

        // --- THÃŠM Má»šI: HÃ m reset form nháº­p liá»‡u ---
        private void ResetChiTietForm()
        {
            lblTenNL_ChiTiet.Text = "Chá»n má»™t nguyÃªn liá»‡u tá»« lÆ°á»›i...";
            lblTonKhoHT_ChiTiet.Text = "0";
            txtTonKhoThucTe.Text = "0";
            txtLyDo.Text = "";
            panelNhapChiTiet.IsEnabled = false;
        }

        private async void BtnTaoPhieuMoi_Click(object sender, RoutedEventArgs e)
        {
            ResetForm();
            _isCreatingPhieu = true;
            lblChiTietTitle.Text = "Táº¡o Phiáº¿u Kiá»ƒm Kho Má»›i";
            btnLuuPhieuKiem.IsEnabled = true;
            dgChiTietKiemKho.IsReadOnly = true; // LÆ°á»›i luÃ´n ReadOnly

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var currentStock = (await httpClient.GetFromJsonAsync<List<ChiTietKiemKhoDto>>("api/app/kho/phieukiemkho/taomoi")) ?? new List<ChiTietKiemKhoDto>();

                foreach (var item in currentStock)
                {
                    item.TonKhoThucTe = item.TonKhoHeThong;
                }

                _fullKiemKhoList = new ObservableCollection<ChiTietKiemKhoDto>(currentStock);
                dgChiTietKiemKho.ItemsSource = _fullKiemKhoList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i dá»¯ liá»‡u kho: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnLocPhieu_Click(object sender, RoutedEventArgs e)
        {
            await LoadPhieuKiemKhoAsync();
        }

        private async void DgPhieuKiemKho_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgPhieuKiemKho.SelectedItem is not PhieuKiemKhoDto selected)
            {
                ResetForm();
                return;
            }

            _selectedPhieu = selected;
            _isCreatingPhieu = false;
            btnLuuPhieuKiem.IsEnabled = false;
            dgChiTietKiemKho.IsReadOnly = true;
            txtSearchKiemKho.Text = "";
            ResetChiTietForm(); // Táº¯t form nháº­p

            try
            {
                var details = await httpClient.GetFromJsonAsync<List<ChiTietKiemKhoDto>>($"api/app/kho/phieukiemkho/{selected.IdPhieuKiemKho}");

                _fullKiemKhoList = new ObservableCollection<ChiTietKiemKhoDto>(details ?? new List<ChiTietKiemKhoDto>());
                dgChiTietKiemKho.ItemsSource = _fullKiemKhoList;

                lblChiTietTitle.Text = $"Chi tiáº¿t Phiáº¿u {selected.IdPhieuKiemKho}";
                lblTongChenhLech.Text = _fullKiemKhoList.Sum(ct => ct.GiaTriChenhLech).ToString("N0") + " VND";
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i chi tiáº¿t phiáº¿u: {ex.Message}", "Lá»—i API");
            }
        }

        private void TxtSearchKiemKho_TextChanged(object sender, TextChangedEventArgs e)
        {
            string searchText = txtSearchKiemKho.Text.ToLower();

            if (string.IsNullOrWhiteSpace(searchText))
            {
                dgChiTietKiemKho.ItemsSource = _fullKiemKhoList;
            }
            else
            {
                var filteredList = _fullKiemKhoList
                    .Where(nl => nl.TenNguyenLieu.ToLower().Contains(searchText))
                    .ToList();

                _chiTietKiemKhoList = new ObservableCollection<ChiTietKiemKhoDto>(filteredList);
                dgChiTietKiemKho.ItemsSource = _chiTietKiemKhoList;
            }
        }

        // =================================================================
        // === Sá»¬A Lá»–I HÃ€M NÃ€Y (System.InvalidOperationException) ===
        // =================================================================
        private void DgChiTietKiemKho_CellEditEnding(object sender, DataGridCellEditEndingEventArgs e)
        {
            // Tá»± Ä‘á»™ng tÃ­nh ChÃªnh lá»‡ch

            // XÃ“A: Task.Delay(100).ContinueWith(...

            // THAY Báº°NG:
            // Xáº¿p hÃ ng tÃ¡c vá»¥ Refresh() vÃ o Dispatcher vá»›i má»©c Æ°u tiÃªn tháº¥p (ContextIdle).
            // Äiá»u nÃ y Ä‘áº£m báº£o giao dá»‹ch (edit transaction) káº¿t thÃºc TRÆ¯á»šC KHI Refresh() Ä‘Æ°á»£c gá»i.
            Dispatcher.BeginInvoke(new Action(() =>
            {
                dgChiTietKiemKho.Items.Refresh();
            }), System.Windows.Threading.DispatcherPriority.ContextIdle);
        }
        // =================================================================
        // === Káº¾T THÃšC Sá»¬A Lá»–I ===
        // =================================================================
        // --- XÃ“A HÃ€M DgChiTietKiemKho_CellEditEnding ---
        // private void DgChiTietKiemKho_CellEditEnding(...) { ... }

        // --- THÃŠM Má»šI: Xá»­ lÃ½ chá»n dÃ²ng chi tiáº¿t ---
        private void DgChiTietKiemKho_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgChiTietKiemKho.SelectedItem is ChiTietKiemKhoDto selected && _isCreatingPhieu)
            {
                panelNhapChiTiet.IsEnabled = true;
                lblTenNL_ChiTiet.Text = selected.TenNguyenLieu;
                lblTonKhoHT_ChiTiet.Text = selected.TonKhoHeThong.ToString("N2");
                txtTonKhoThucTe.Text = selected.TonKhoThucTe.ToString("N2");
                txtLyDo.Text = selected.LyDoChenhLech;
                txtTonKhoThucTe.Focus();
            }
            else
            {
                ResetChiTietForm();
            }
        }

        // --- THÃŠM Má»šI: Xá»­ lÃ½ nÃºt "Cáº­p nháº­t dÃ²ng" ---
        private void BtnCapNhatDong_Click(object sender, RoutedEventArgs e)
        {
            if (dgChiTietKiemKho.SelectedItem is not ChiTietKiemKhoDto selectedItem)
            {
                MessageBox.Show("Vui lÃ²ng chá»n má»™t dÃ²ng trong lÆ°á»›i Ä‘á»ƒ cáº­p nháº­t.", "Lá»—i");
                return;
            }

            // TÃ¬m item tÆ°Æ¡ng á»©ng trong danh sÃ¡ch Gá»C
            var itemInFullList = _fullKiemKhoList.FirstOrDefault(i => i.IdNguyenLieu == selectedItem.IdNguyenLieu);
            if (itemInFullList == null) return;

            // Láº¥y dá»¯ liá»‡u tá»« form
            if (!decimal.TryParse(txtTonKhoThucTe.Text, NumberStyles.Any, CultureInfo.InvariantCulture, out var thucTe))
            {
                MessageBox.Show("Sá»‘ lÆ°á»£ng thá»±c táº¿ khÃ´ng há»£p lá»‡.", "Lá»—i");
                return;
            }

            // Cáº­p nháº­t Dá»® LIá»†U Gá»C (trong _fullKiemKhoList)
            itemInFullList.TonKhoThucTe = thucTe;
            itemInFullList.LyDoChenhLech = txtLyDo.Text;

            // Refresh láº¡i DataGrid (an toÃ n, vÃ¬ khÃ´ng á»Ÿ trong CellEditEnding)
            dgChiTietKiemKho.Items.Refresh();

            // Reset form nháº­p
            ResetChiTietForm();
            dgChiTietKiemKho.SelectedItem = null;
        }

        private async void BtnLuuPhieuKiem_Click(object sender, RoutedEventArgs e)
        {
            if (!_isCreatingPhieu || _fullKiemKhoList.Count == 0)
            {
                MessageBox.Show("Vui lÃ²ng 'Táº¡o Phiáº¿u Má»›i' trÆ°á»›c khi lÆ°u.", "Lá»—i");
                return;
            }
            if (AuthService.CurrentUser == null)
            {
                MessageBox.Show("Lá»—i phiÃªn Ä‘Äƒng nháº­p. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.", "Lá»—i");
                return;
            }

            var dto = new PhieuKiemKhoCreateDto
            {
                IdNhanVien = AuthService.CurrentUser.IdNhanVien,
                NgayKiem = DateTime.Now,
                ChiTiet = _fullKiemKhoList.ToList() // LuÃ´n lÆ°u list gá»‘c
            };

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/kho/phieukiemkho", dto);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("LÆ°u phiáº¿u kiá»ƒm kho vÃ  cÃ¢n báº±ng kho thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadPhieuKiemKhoAsync();
                    ResetForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService?.CanGoBack == true)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyKhachHangView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyKhachHangView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyKhachHangView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quáº£n lÃ½ KhÃ¡ch hÃ ng" FontFamily="Segoe UI" Loaded="Page_Loaded"
      Background="#FFF8E1">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="StatusYellowBrush" Color="#FFF9C4"/>
        <SolidColorBrush x:Key="StatusCanceledBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="StatusGreenBrush" Color="#E8F5E9"/>

        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconUpload">M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z</Geometry>
        <Geometry x:Key="IconLock">M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8H17V6A5,5 0 0,0 12,1A5,5 0 0,0 7,6V8H6A2,2 0 0,0 4,10V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V10A2,2 0 0,0 18,8Z</Geometry>
        <Geometry x:Key="IconUnlock">M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8H17V6A5,5 0 0,0 12,1A5,5 0 0,0 7,6H9V8H18V10H20V20H4V10H6V8H7A5,5 0 0,0 12,1Z</Geometry>
        <Geometry x:Key="IconExcel">M21.17 3.25Q21.5 3.25 21.76 3.5 22 3.74 22 4.08V19.92Q22 20.26 21.76 20.5 21.5 20.75 21.17 20.75H7.83Q7.5 20.75 7.24 20.5 7 20.26 7 19.92V4.08Q7 3.74 7.24 3.5 7.5 3.25 7.83 3.25H21.17M13.83 18.25V15.7H11.5V14.05L13.72 10.63H11.6V9H16.33V10.65L14.12 14.07H16.25V15.7H13.83V18.25M6.25 15.5Q6.25 15.15 6.04 14.88 5.82 14.6 5.5 14.6H3.5Q3.18 14.6 2.96 14.88 2.75 15.15 2.75 15.5V17.5Q2.75 17.82 2.96 18.1 3.18 18.38 3.5 18.38H5.5Q5.82 18.38 6.04 18.1 6.25 17.82 6.25 17.5V15.5M6.25 9.5Q6.25 9.18 6.04 8.9 5.82 8.62 5.5 8.62H3.5Q3.18 8.62 2.96 8.9 2.75 9.18 2.75 9.5V11.5Q2.75 11.82 2.96 12.1 3.18 12.38 3.5 12.38H5.5Q5.82 12.38 6.04 12.1 6.25 11.82 6.25 11.5V9.5Z</Geometry>
        <Geometry x:Key="IconPromotion">M12.41,2.58C12.03,2.2 11.53,2 11,2H4C2.9,2 2,2.9 2,4V11C2,11.53 2.2,12.03 2.59,12.41L12.42,22.24C12.81,22.63 13.44,22.63 13.83,22.24L22.24,13.82C22.63,13.43 22.63,12.8 22.24,12.41L12.41,2.58M7,7A1.5,1.5 0 0,1 5.5,8.5A1.5,1.5 0 0,1 4,7A1.5,1.5 0 0,1 5.5,5.5A1.5,1.5 0 0,1 7,7Z</Geometry>
        <Geometry x:Key="IconSettings">M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M12,22C11.6,22 11.2,21.9 10.8,21.7L9.1,20.9C5.1,19.3 2,15.2 2,10.9V5L12,2L22,5V10.9C22,15.2 18.9,19.3 14.9,20.9L13.2,21.7C12.8,21.9 12.4,22 12,22Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>
        <Style x:Key="RightAligned" TargetType="TextBlock">
            <Setter Property="TextAlignment" Value="Right"/>
        </Style>
        <Style x:Key="CustomerDataGridRowStyle" TargetType="DataGridRow">
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding BiKhoa}" Value="True">
                    <Setter Property="Background" Value="#FFEBEE"/>
                    <Setter Property="Foreground" Value="{StaticResource ActionRedBrush}"/>
                    <Setter Property="FontStyle" Value="Italic"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="AvatarImage" TargetType="Image">
            <Setter Property="Width" Value="100"/>
            <Setter Property="Height" Value="100"/>
            <Setter Property="Stretch" Value="UniformToFill"/>
        </Style>

    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <Border Grid.Row="0" Background="{StaticResource WhiteTextBrush}" CornerRadius="8" Padding="15" Margin="0,0,0,15">
                <WrapPanel Orientation="Horizontal">
                    <TextBlock Text="TÃ¬m kiáº¿m (TÃªn, SÄT, Email):" VerticalAlignment="Center" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
                    <TextBox x:Name="txtSearchKhachHang" Width="200" Margin="10,0,0,0" TextChanged="TxtSearchKhachHang_TextChanged"/>
                    <TextBlock Text="Tráº¡ng thÃ¡i:" VerticalAlignment="Center" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}" Margin="20,0,0,0"/>
                    <ComboBox x:Name="cmbFilterTrangThai" Width="150" Margin="10,0,0,0" SelectionChanged="CmbFilterTrangThai_SelectionChanged">
                        <ComboBoxItem Content="Táº¥t cáº£" Tag="{x:Null}"/>
                        <ComboBoxItem Content="Äang hoáº¡t Ä‘á»™ng" Tag="False"/>
                        <ComboBoxItem Content="Bá»‹ khÃ³a" Tag="True"/>
                    </ComboBox>

                    <Button x:Name="btnExportExcel" Margin="20,0,0,0" Style="{StaticResource PrimaryButton}" Background="#00724C" Click="BtnExportExcel_Click" Padding="10,5">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconExcel}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Xuáº¥t Excel" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <Button x:Name="btnGoToKhuyenMai" Margin="10,0,0,0" Style="{StaticResource PrimaryButton}" Background="{StaticResource AccentOrangeBrush}" Click="BtnGoToKhuyenMai_Click" Padding="10,5">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconPromotion}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Quáº£n lÃ½ Khuyáº¿n mÃ£i" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <Button x:Name="btnCaiDatDiem" Margin="10,0,0,0" Style="{StaticResource PrimaryButton}" Background="{StaticResource TextGrayBrush}" Click="BtnCaiDatDiem_Click" Padding="10,5">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconSettings}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="CÃ i Ä‘áº·t Äiá»ƒm" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                </WrapPanel>
            </Border>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="420"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Margin="0,0,15,0" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Text="Danh sÃ¡ch KhÃ¡ch hÃ ng" Style="{StaticResource HeaderTextBlock}"/>
                        <DataGrid Grid.Row="1" x:Name="dgKhachHang" AutoGenerateColumns="False" IsReadOnly="True" 
                                  SelectionMode="Single" SelectionChanged="DgKhachHang_SelectionChanged"
                                  BorderThickness="0" RowHeaderWidth="0"
                                  RowStyle="{StaticResource CustomerDataGridRowStyle}">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ID" Binding="{Binding IdKhachHang}" Width="50"/>
                                <DataGridTextColumn Header="Há» TÃªn" Binding="{Binding HoTen}" Width="*"/>
                                <DataGridTextColumn Header="Sá»‘ Ä‘iá»‡n thoáº¡i" Binding="{Binding SoDienThoai}" Width="120"/>
                                <DataGridTextColumn Header="Email" Binding="{Binding Email}" Width="150"/>
                                <DataGridTextColumn Header="NgÃ y táº¡o" Binding="{Binding NgayTao, StringFormat='dd/MM/yyyy'}" Width="100"/>
                                <DataGridTextColumn Header="Tráº¡ng thÃ¡i" Binding="{Binding TrangThai}" Width="100"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>

                <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <Border Style="{StaticResource CardBorder}">
                            <StackPanel>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock x:Name="lblFormTitle" Text="ThÃ´ng tin KhÃ¡ch hÃ ng" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,15"/>
                                    <Button x:Name="btnLamMoiKH" Grid.Column="1" ToolTip="Táº¡o má»›i" Click="BtnLamMoiKH_Click" 
                                            Background="Transparent" BorderThickness="0" Cursor="Hand" Width="40" Height="40">
                                        <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                                    </Button>
                                </Grid>

                                <Grid Margin="0,0,0,15">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <Border Grid.Column="0" BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="1" Width="100" Height="100" Background="{StaticResource SubtleGrayBrush}" CornerRadius="50">
                                        <Ellipse>
                                            <Ellipse.Fill>
                                                <ImageBrush x:Name="AvatarPreview" Stretch="UniformToFill"/>
                                            </Ellipse.Fill>
                                        </Ellipse>
                                    </Border>

                                    <StackPanel Grid.Column="1" VerticalAlignment="Bottom" Orientation="Horizontal" Margin="15,0,0,0">
                                        <Button x:Name="btnChonAnh" 
                                                Style="{StaticResource PrimaryButton}" Background="#F5F5F5" 
                                                BorderBrush="#E0E0E0" Foreground="{StaticResource DarkBrownBrush}"
                                                Click="BtnChonAnh_Click">
                                            <StackPanel Orientation="Horizontal">
                                                <Path Data="{StaticResource IconUpload}" Fill="{StaticResource DarkBrownBrush}" Width="23" Height="23" Margin="0,0,8,0"/>
                                                <TextBlock Text="Chá»n Avatar" VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </Button>

                                        <Button x:Name="btnXoaAnh" 
                                                Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionRedBrush}" 
                                                Margin="10,0,0,0" 
                                                Click="BtnXoaAnh_Click">
                                            <StackPanel Orientation="Horizontal">
                                                <Path Data="{StaticResource IconDelete}" Fill="White"  Width="23" Height="23" Margin="0,0,8,0"/>
                                                <TextBlock Text="XÃ³a" VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </Button>
                                    </StackPanel>
                                </Grid>

                                <Label Content="Há» tÃªn (*)"/>
                                <TextBox x:Name="txtHoTenKH"/>
                                <Label Content="Sá»‘ Ä‘iá»‡n thoáº¡i (*)"/>
                                <TextBox x:Name="txtSdtKH"/>
                                <Label Content="Email"/>
                                <TextBox x:Name="txtEmailKH"/>
                                <Label Content="TÃªn Ä‘Äƒng nháº­p (Web)"/>
                                <TextBox x:Name="txtTenDangNhapKH"/>
                                <Label Content="Äá»‹a chá»‰"/>
                                <TextBox x:Name="txtDiaChiKH"/>
                                <Label Content="Äiá»ƒm tÃ­ch lÅ©y"/>
                                <TextBox x:Name="txtDiemTichLuy" IsReadOnly="False"/>

                                <WrapPanel Orientation="Horizontal" Margin="0,20,0,0">
                                    <Button x:Name="btnThemKH" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionGreenBrush}" Click="BtnThemKH_Click" Margin="0,0,8,0" Padding="15,10">
                                        <TextBlock Text="ThÃªm Má»›i"/>
                                    </Button>
                                    <Button x:Name="btnLuuKH" Style="{StaticResource PrimaryButton}" Click="BtnLuuKH_Click" Margin="0,0,8,0" Padding="15,10">
                                        <TextBlock Text="LÆ°u Thay Äá»•i"/>
                                    </Button>
                                    <Button x:Name="btnXoaKH" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionRedBrush}" Click="BtnXoaKH_Click" Padding="15,10">
                                        <TextBlock Text="XÃ³a"/>
                                    </Button>
                                </WrapPanel>
                                <WrapPanel Orientation="Horizontal" Margin="0,10,0,0">
                                    <Button x:Name="btnKhoaKH" Style="{StaticResource PrimaryButton}" Background="{StaticResource AccentOrangeBrush}" Click="BtnKhoaKH_Click" Margin="0,0,8,0" Padding="15,10">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconLock}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                            <TextBlock Text="KhÃ³a TÃ i Khoáº£n" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                    <Button x:Name="btnMoKhoaKH" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionBlueBrush}" Click="BtnMoKhoaKH_Click" Padding="15,10">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconUnlock}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                            <TextBlock Text="Má»Ÿ KhÃ³a" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                </WrapPanel>
                            </StackPanel>
                        </Border>

                        <Border Style="{StaticResource CardBorder}" Margin="0,20,0,0">
                            <StackPanel>
                                <TextBlock Text="Lá»‹ch sá»­ Giao dá»‹ch" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,10"/>
                                <TextBlock Text="ÄÆ¡n hÃ ng Ä‘Ã£ mua:" FontWeight="SemiBold" Margin="0,0,0,5"/>
                                <DataGrid x:Name="dgLichSuDonHang" AutoGenerateColumns="False" IsReadOnly="True" MaxHeight="150" RowHeaderWidth="0">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="MÃ£ HÄ" Binding="{Binding IdHoaDon}" Width="60"/>
                                        <DataGridTextColumn Header="NgÃ y" Binding="{Binding ThoiGianTao, StringFormat='dd/MM/yy'}" Width="80"/>
                                        <DataGridTextColumn Header="Tá»•ng tiá»n" Binding="{Binding ThanhTien, StringFormat=N0}" Width="*" ElementStyle="{StaticResource RightAligned}"/>
                                        <DataGridTextColumn Header="Tráº¡ng thÃ¡i" Binding="{Binding TrangThai}" Width="100"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                                <TextBlock Text="SÃ¡ch Ä‘Ã£ thuÃª:" FontWeight="SemiBold" Margin="0,10,0,5"/>
                                <DataGrid x:Name="dgLichSuThueSach" AutoGenerateColumns="False" IsReadOnly="True" MaxHeight="150" RowHeaderWidth="0">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="MÃ£ Phiáº¿u" Binding="{Binding IdPhieuThue}" Width="70"/>
                                        <DataGridTextColumn Header="TÃªn SÃ¡ch" Binding="{Binding TieuDeSach}" Width="*"/>
                                        <DataGridTextColumn Header="NgÃ y ThuÃª" Binding="{Binding NgayThue, StringFormat='dd/MM/yy'}" Width="80"/>
                                        <DataGridTextColumn Header="Tráº¡ng thÃ¡i" Binding="{Binding TrangThai}" Width="100"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Äang táº£i..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyKhachHangView.xaml.cs
// Táº­p tin: AppCafebookApi/View/quanly/pages/QuanLyKhachHangView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using Microsoft.Win32;
using System.IO;
using AppCafebookApi.Services;
using CafebookModel.Utils;
using OfficeOpenXml;
using System.Text.RegularExpressions;
using AppCafebookApi.View.common;
using System.Net.Http.Headers; // <-- THÃŠM

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyKhachHangView : Page
    {
        private static readonly HttpClient httpClient;

        private List<KhachHangDto> _allKhachHangList = new List<KhachHangDto>();

        // Sá»¬A: DÃ¹ng DTO chi tiáº¿t (Detail)
        private KhachHangDetailDto? _selectedKhachHang = null;

        // Sá»¬A: Thay tháº¿ Base64
        private string? _currentAvatarFilePath = null;
        private bool _deleteAvatarRequest = false;

        static QuanLyKhachHangView()
        {
            httpClient = new HttpClient
            {
                // Sá»¬A: DÃ¹ng 127.0.0.1
                BaseAddress = new Uri("http://127.0.0.1:5166")
            };
        }

        public QuanLyKhachHangView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            cmbFilterTrangThai.SelectedIndex = 0; // "Táº¥t cáº£"
            await LoadKhachHangGridAsync();
            ResetKhachHangForm();
        }

        #region TAB 1: KHÃCH HÃ€NG

        // --- Táº£i dá»¯ liá»‡u & Lá»c ---
        private async Task LoadKhachHangGridAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            string searchText = txtSearchKhachHang.Text;
            bool? biKhoa = (cmbFilterTrangThai.SelectedItem as ComboBoxItem)?.Tag as bool?;
            try
            {
                var url = $"api/app/khachhang/search?searchText={Uri.EscapeDataString(searchText)}";
                if (biKhoa.HasValue)
                {
                    url += $"&biKhoa={biKhoa.Value}";
                }
                _allKhachHangList = (await httpClient.GetFromJsonAsync<List<KhachHangDto>>(url)) ?? new List<KhachHangDto>();
                dgKhachHang.ItemsSource = _allKhachHangList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i danh sÃ¡ch khÃ¡ch hÃ ng: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void TxtSearchKhachHang_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (this.IsLoaded)
                await LoadKhachHangGridAsync();
        }

        private async void CmbFilterTrangThai_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (cmbFilterTrangThai.IsLoaded)
            {
                await LoadKhachHangGridAsync();
            }
        }

        // --- Form & CRUD ---

        private void ResetKhachHangForm()
        {
            _selectedKhachHang = null;
            _currentAvatarFilePath = null;
            _deleteAvatarRequest = false;

            dgKhachHang.SelectedItem = null;
            lblFormTitle.Text = "ThÃªm KhÃ¡ch hÃ ng Má»›i";
            btnThemKH.Visibility = Visibility.Visible;
            btnLuuKH.Visibility = Visibility.Collapsed;
            btnXoaKH.Visibility = Visibility.Collapsed;
            btnKhoaKH.Visibility = Visibility.Collapsed;
            btnMoKhoaKH.Visibility = Visibility.Collapsed;
            txtHoTenKH.Text = "";
            txtSdtKH.Text = "";
            txtEmailKH.Text = "";
            txtTenDangNhapKH.Text = "";
            txtDiaChiKH.Text = "";
            txtDiemTichLuy.Text = "0";
            dgLichSuDonHang.ItemsSource = null;
            dgLichSuThueSach.ItemsSource = null;
            AvatarPreview.ImageSource = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultAvatar);
        }

        private async void DgKhachHang_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgKhachHang.SelectedItem is not KhachHangDto selected)
            {
                ResetKhachHangForm();
                return;
            }
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                _selectedKhachHang = await httpClient.GetFromJsonAsync<KhachHangDetailDto>($"api/app/khachhang/details/{selected.IdKhachHang}");
                if (_selectedKhachHang == null)
                {
                    ResetKhachHangForm();
                    return;
                }

                _currentAvatarFilePath = null;
                _deleteAvatarRequest = false;

                lblFormTitle.Text = "Cáº­p nháº­t KhÃ¡ch hÃ ng";
                btnThemKH.Visibility = Visibility.Collapsed;
                btnLuuKH.Visibility = Visibility.Visible;
                btnXoaKH.Visibility = Visibility.Visible;
                btnKhoaKH.Visibility = _selectedKhachHang.BiKhoa ? Visibility.Collapsed : Visibility.Visible;
                btnMoKhoaKH.Visibility = _selectedKhachHang.BiKhoa ? Visibility.Visible : Visibility.Collapsed;
                txtHoTenKH.Text = _selectedKhachHang.HoTen;
                txtSdtKH.Text = _selectedKhachHang.SoDienThoai;
                txtEmailKH.Text = _selectedKhachHang.Email;
                txtTenDangNhapKH.Text = _selectedKhachHang.TenDangNhap;
                txtDiaChiKH.Text = _selectedKhachHang.DiaChi;
                txtDiemTichLuy.Text = _selectedKhachHang.DiemTichLuy.ToString();
                dgLichSuDonHang.ItemsSource = _selectedKhachHang.LichSuDonHang;
                dgLichSuThueSach.ItemsSource = _selectedKhachHang.LichSuThueSach;

                // Sá»¬A: Load áº£nh tá»« URL
                AvatarPreview.ImageSource = HinhAnhHelper.LoadImage(_selectedKhachHang.AnhDaiDienUrl, HinhAnhPaths.DefaultAvatar);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i chi tiáº¿t khÃ¡ch hÃ ng: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnLamMoiKH_Click(object sender, RoutedEventArgs e)
        {
            ResetKhachHangForm();
        }

        private void BtnChonAnh_Click(object sender, RoutedEventArgs e)
        {
            var ofd = new OpenFileDialog { Filter = "Image files|*.png;*.jpg;*.jpeg", Title = "Chá»n Avatar" };
            if (ofd.ShowDialog() == true)
            {
                try
                {
                    // Sá»¬A: Chá»‰ lÆ°u Ä‘Æ°á»ng dáº«n file
                    _currentAvatarFilePath = ofd.FileName;
                    _deleteAvatarRequest = false;
                    AvatarPreview.ImageSource = HinhAnhHelper.LoadImage(_currentAvatarFilePath, HinhAnhPaths.DefaultAvatar);
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Lá»—i Ä‘á»c file áº£nh: {ex.Message}", "Lá»—i File");
                    _currentAvatarFilePath = null;
                    AvatarPreview.ImageSource = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultAvatar);
                }
            }
        }

        // THÃŠM: NÃºt XÃ³a áº¢nh
        private void BtnXoaAnh_Click(object sender, RoutedEventArgs e)
        {
            _currentAvatarFilePath = null;
            _deleteAvatarRequest = true;
            AvatarPreview.ImageSource = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultAvatar);
        }

        // Sá»¬A: TÃ¡ch hÃ m Validate riÃªng
        private bool ValidateKhachHangInput(out MultipartFormDataContent form)
        {
            form = new MultipartFormDataContent();
            if (string.IsNullOrWhiteSpace(txtHoTenKH.Text) || string.IsNullOrWhiteSpace(txtSdtKH.Text))
            {
                MessageBox.Show("Há» tÃªn vÃ  Sá»‘ Ä‘iá»‡n thoáº¡i lÃ  báº¯t buá»™c.", "Thiáº¿u thÃ´ng tin");
                return false;
            }
            if (!string.IsNullOrEmpty(txtEmailKH.Text) && !Regex.IsMatch(txtEmailKH.Text, @"^[^@\s]+@[^@\s]+\.[^@\s]+$"))
            {
                MessageBox.Show("Äá»‹nh dáº¡ng Email khÃ´ng há»£p lá»‡.", "Lá»—i");
                return false;
            }

            // 1. ThÃªm cÃ¡c trÆ°á»ng dá»¯ liá»‡u
            form.Add(new StringContent(txtHoTenKH.Text), "HoTen");
            form.Add(new StringContent(txtSdtKH.Text), "SoDienThoai");
            form.Add(new StringContent(txtEmailKH.Text ?? ""), "Email");
            form.Add(new StringContent(txtTenDangNhapKH.Text ?? ""), "TenDangNhap");
            form.Add(new StringContent(txtDiaChiKH.Text ?? ""), "DiaChi");
            form.Add(new StringContent(int.TryParse(txtDiemTichLuy.Text, out int diem) ? diem.ToString() : "0"), "DiemTichLuy");

            // 2. ThÃªm file
            if (!string.IsNullOrEmpty(_currentAvatarFilePath))
            {
                var fileStream = File.OpenRead(_currentAvatarFilePath);
                var streamContent = new StreamContent(fileStream);
                streamContent.Headers.ContentType = new MediaTypeHeaderValue("image/jpeg");
                form.Add(streamContent, "AnhDaiDienUpload", Path.GetFileName(_currentAvatarFilePath));
            }

            // 3. ThÃªm cá» XÃ³a
            if (_deleteAvatarRequest)
            {
                form.Add(new StringContent("true"), "XoaAnhDaiDien");
            }

            return true;
        }

        private async void BtnThemKH_Click(object sender, RoutedEventArgs e)
        {
            if (!ValidateKhachHangInput(out var form)) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsync("api/app/khachhang", form);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("ThÃªm khÃ¡ch hÃ ng thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadKhachHangGridAsync();
                    ResetKhachHangForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnLuuKH_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedKhachHang == null || !ValidateKhachHangInput(out var form)) return;

            // ThÃªm Id vÃ o form
            form.Add(new StringContent(_selectedKhachHang.IdKhachHang.ToString()), "IdKhachHang");

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PutAsync($"api/app/khachhang/{_selectedKhachHang.IdKhachHang}", form);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Cáº­p nháº­t thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadKhachHangGridAsync();
                    ResetKhachHangForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnKhoaKH_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedKhachHang == null) return;
            await UpdateKhachHangStatus(_selectedKhachHang.IdKhachHang, true);
        }

        private async void BtnMoKhoaKH_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedKhachHang == null) return;
            await UpdateKhachHangStatus(_selectedKhachHang.IdKhachHang, false);
        }

        private async Task UpdateKhachHangStatus(int id, bool biKhoa)
        {
            string action = biKhoa ? "KHÃ“A" : "Má» KHÃ“A";
            if (MessageBox.Show($"Báº¡n cÃ³ cháº¯c muá»‘n {action} tÃ i khoáº£n nÃ y?", "XÃ¡c nháº­n", MessageBoxButton.YesNo) == MessageBoxResult.No)
                return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                // Sá»¬A: Gá»­i JSON object
                var response = await httpClient.PutAsJsonAsync($"api/app/khachhang/update-status/{id}", new { BiKhoa = biKhoa });
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show($"{action} thÃ nh cÃ´ng.", "ThÃ´ng bÃ¡o");
                    await LoadKhachHangGridAsync();
                    ResetKhachHangForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXoaKH_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedKhachHang == null) return;
            var result = MessageBox.Show($"Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n XÃ“A vÄ©nh viá»…n khÃ¡ch hÃ ng '{_selectedKhachHang.HoTen}'?\n(HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c)", "XÃ¡c nháº­n XÃ³a", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/khachhang/{_selectedKhachHang.IdKhachHang}");
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("XÃ³a thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadKhachHangGridAsync();
                    ResetKhachHangForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "KhÃ´ng thá»ƒ xÃ³a");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnExportExcel_Click(object sender, RoutedEventArgs e)
        {
            // (Logic Export giá»¯ nguyÃªn)
        }

        #endregion

        #region KHUYáº¾N MÃƒI (Äiá»u hÆ°á»›ng)
        // (Logic Navigation giá»¯ nguyÃªn)
        private void BtnGoToKhuyenMai_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new QuanLyKhuyenMaiView());
        }
        private void BtnCaiDatDiem_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new CaiDatWindow());
        }

        #endregion
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyKhuyenMaiView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyKhuyenMaiView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyKhuyenMaiView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quáº£n lÃ½ Khuyáº¿n mÃ£i" FontFamily="Segoe UI" Loaded="Page_Loaded"
      Background="#FFF8E1">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="StatusGreenBrush" Color="#E8F5E9"/>
        <SolidColorBrush x:Key="StatusGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="StatusRedBrush" Color="#FFEBEE"/>

        <Geometry x:Key="IconExcel">M21.17 3.25Q21.5 3.25 21.76 3.5 22 3.74 22 4.08V19.92Q22 20.26 21.76 20.5 21.5 20.75 21.17 20.75H7.83Q7.5 20.75 7.24 20.5 7 20.26 7 19.92V4.08Q7 3.74 7.24 3.5 7.5 3.25 7.83 3.25H21.17M13.83 18.25V15.7H11.5V14.05L13.72 10.63H11.6V9H16.33V10.65L14.12 14.07H16.25V15.7H13.83V18.25M6.25 15.5Q6.25 15.15 6.04 14.88 5.82 14.6 5.5 14.6H3.5Q3.18 14.6 2.96 14.88 2.75 15.15 2.75 15.5V17.5Q2.75 17.82 2.96 18.1 3.18 18.38 3.5 18.38H5.5Q5.82 18.38 6.04 18.1 6.25 17.82 6.25 17.5V15.5M6.25 9.5Q6.25 9.18 6.04 8.9 5.82 8.62 5.5 8.62H3.5Q3.18 8.62 2.96 8.9 2.75 9.18 2.75 9.5V11.5Q2.75 11.82 2.96 12.1 3.18 12.38 3.5 12.38H5.5Q5.82 12.38 6.04 12.1 6.25 11.82 6.25 11.5V9.5Z</Geometry>
        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconFilter">M14,12V19.88C14.04,20.18 13.94,20.5 13.71,20.71C13.32,21.1 12.69,21.1 12.3,20.71L10.29,18.7C10.06,18.47 9.96,18.16 10,17.87V12H14M15,9H9V4H15V9Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>


        <Style x:Key="PromotionDataGridRowStyle" TargetType="DataGridRow">
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding TrangThai}" Value="Hoáº¡t Ä‘á»™ng">
                    <Setter Property="Background" Value="{StaticResource StatusGreenBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TrangThai}" Value="Táº¡m dá»«ng">
                    <Setter Property="Background" Value="{StaticResource StatusRedBrush}"/>
                    <Setter Property="Foreground" Value="{StaticResource ActionRedBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TrangThai}" Value="Háº¿t háº¡n">
                    <Setter Property="Background" Value="{StaticResource StatusGrayBrush}"/>
                    <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
                    <Setter Property="FontStyle" Value="Italic"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="450"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Margin="0,0,15,0" Style="{StaticResource CardBorder}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Text="Danh sÃ¡ch Khuyáº¿n mÃ£i" Style="{StaticResource HeaderTextBlock}"/>

                    <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,15">
                        <TextBlock Text="TÃ¬m MÃ£:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                        <TextBox x:Name="txtSearchMaKM" Width="120" TextChanged="Filter_Changed"/>

                        <TextBlock Text="Tráº¡ng thÃ¡i:" VerticalAlignment="Center" Margin="15,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                        <ComboBox x:Name="cmbFilterTrangThai" Width="150" SelectionChanged="Filter_Changed">
                            <ComboBoxItem Content="Táº¥t cáº£"/>
                            <ComboBoxItem Content="Hoáº¡t Ä‘á»™ng"/>
                            <ComboBoxItem Content="Táº¡m dá»«ng"/>
                            <ComboBoxItem Content="Háº¿t háº¡n"/>
                        </ComboBox>
                    </StackPanel>

                    <DataGrid Grid.Row="2" x:Name="dgKhuyenMai" AutoGenerateColumns="False" IsReadOnly="True" 
                              SelectionMode="Single" SelectionChanged="DgKhuyenMai_SelectionChanged"
                              BorderThickness="0" RowHeaderWidth="0"
                              RowStyle="{StaticResource PromotionDataGridRowStyle}">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="MÃ£ KM" Binding="{Binding MaKhuyenMai}" Width="100"/>
                            <DataGridTextColumn Header="TÃªn chÆ°Æ¡ng trÃ¬nh" Binding="{Binding TenKhuyenMai}" Width="*"/>
                            <DataGridTextColumn Header="Giáº£m" Binding="{Binding GiaTriGiam}" Width="80"/>
                            <DataGridTextColumn Header="Tá»‘i Ä‘a" Binding="{Binding GiamToiDa, StringFormat=N0}" Width="80"/>
                            <DataGridTextColumn Header="Báº¯t Ä‘áº§u" Binding="{Binding NgayBatDau, StringFormat='dd/MM/yy'}" Width="80"/>
                            <DataGridTextColumn Header="Káº¿t thÃºc" Binding="{Binding NgayKetThuc, StringFormat='dd/MM/yy'}" Width="80"/>
                            <DataGridTextColumn Header="Tráº¡ng thÃ¡i" Binding="{Binding TrangThai}" Width="100"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="0,15,0,0">
                        <Button x:Name="btnQuayLai" Style="{StaticResource BackButton}"
                                HorizontalAlignment="Left" 
                                Click="BtnQuayLai_Click">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="&lt; Quay láº¡i" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>

                        <Button x:Name="btnExportToExcel" HorizontalAlignment="Left" Margin="20,0,0,0"
                                Style="{StaticResource PrimaryButton}" Background="#00724C"
                                Click="BtnExportToExcel_Click">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconExcel}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="Xuáº¥t Excel" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>

                </Grid>
            </Border>

            <Border Grid.Column="1" Style="{StaticResource CardBorder}">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <TextBlock Text="ThÃ´ng tin ChÆ°Æ¡ng trÃ¬nh Khuyáº¿n mÃ£i" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,15"/>

                        <TextBlock Text="MÃ£ Khuyáº¿n mÃ£i (KhÃ´ng dáº¥u, VIáº¾T LIá»€N):" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtMaKhuyenMai" Margin="0,0,0,10"/>

                        <TextBlock Text="TÃªn chÆ°Æ¡ng trÃ¬nh:" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtTenKM" Margin="0,0,0,10"/>
                        <TextBlock Text="MÃ´ táº£:" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtMoTa" Height="40" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10"/>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,5,0">
                                <TextBlock Text="Loáº¡i giáº£m giÃ¡:" Margin="0,0,0,5"/>
                                <ComboBox x:Name="cmbLoaiGiamGia">
                                    <ComboBoxItem Content="PhanTram" Tag="PhanTram"/>
                                    <ComboBoxItem Content="SoTien" Tag="SoTien"/>
                                </ComboBox>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="5,0,0,0">
                                <TextBlock Text="GiÃ¡ trá»‹ giáº£m (VND hoáº·c %):" Margin="0,0,0,5"/>
                                <TextBox x:Name="txtGiaTriGiam"/>
                            </StackPanel>
                        </Grid>

                        <TextBlock Text="Giáº£m tá»‘i Ä‘a (Náº¿u lÃ  %):" Margin="0,10,0,5"/>
                        <TextBox x:Name="txtGiamToiDa" Margin="0,0,0,10"/>

                        <TextBlock Text="MÃ´ táº£ ÄK (Hiá»ƒn thá»‹ á»Ÿ báº£ng):" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtDieuKienApDung" Margin="0,0,0,10"/>

                        <TextBlock Text="Äiá»u kiá»‡n Ã¡p dá»¥ng (tÃ¹y chá»n):" FontWeight="SemiBold" Margin="0,15,0,5"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,5,0">
                                <TextBlock Text="HÃ³a Ä‘Æ¡n tá»‘i thiá»ƒu (VND):" Margin="0,0,0,5"/>
                                <TextBox x:Name="txtDonHangToiThieu"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="5,0,0,0">
                                <TextBlock Text="Sáº£n pháº©m Ã¡p dá»¥ng:" Margin="0,0,0,5"/>
                                <ComboBox x:Name="cmbSanPhamApDung" DisplayMemberPath="Ten" SelectedValuePath="Id"
                                          IsEditable="True" IsTextSearchEnabled="True"/>
                            </StackPanel>
                        </Grid>

                        <Grid Margin="0,10,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,5,0">
                                <TextBlock Text="NgÃ y Báº¯t Ä‘áº§u:" Margin="0,0,0,5"/>
                                <DatePicker x:Name="dpNgayBatDau"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="5,0,0,0">
                                <TextBlock Text="NgÃ y Káº¿t thÃºc:" Margin="0,0,0,5"/>
                                <DatePicker x:Name="dpNgayKetThuc"/>
                            </StackPanel>
                        </Grid>

                        <Grid Margin="0,10,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,5,0">
                                <TextBlock Text="Thá»© (vd: 2,3,4):" Margin="0,0,0,5"/>
                                <TextBox x:Name="txtDayOfWeek"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="5,0,5,0">
                                <TextBlock Text="Giá» Báº¯t Ä‘áº§u (HH:mm):" Margin="0,0,0,5"/>
                                <TextBox x:Name="txtTimeStart"/>
                            </StackPanel>
                            <StackPanel Grid.Column="2" Margin="5,0,0,0">
                                <TextBlock Text="Giá» Káº¿t thÃºc (HH:mm):" Margin="0,0,0,5"/>
                                <TextBox x:Name="txtTimeEnd"/>
                            </StackPanel>
                        </Grid>

                        <Button x:Name="btnTamDung" Style="{StaticResource PrimaryButton}" Background="{StaticResource AccentOrangeBrush}" Margin="0,15,0,0" Click="BtnTamDung_Click">
                            <TextBlock Text="Táº¡m Dá»«ng / KÃ­ch Hoáº¡t Láº¡i" VerticalAlignment="Center"/>
                        </Button>

                        <Grid Margin="0,20,0,0" Height="41">
                            <Button x:Name="btnLamMoi" ToolTip="LÃ m má»›i" Click="BtnLamMoi_Click" Background="Transparent" BorderThickness="0" Cursor="Hand" Width="41" HorizontalAlignment="Left">
                                <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="22" Height="22"/>
                            </Button>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button x:Name="btnThem" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionGreenBrush}" Click="BtnThem_Click" Margin="0,0,8,0">
                                    <StackPanel Orientation="Horizontal">
                                        <Viewbox Width="23" Height="23" Margin="0,0,8,0">
                                            <Path Data="{StaticResource IconAdd}" Fill="White"/>
                                        </Viewbox>
                                        <TextBlock Text="ThÃªm" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                                <Button x:Name="btnLuu" Style="{StaticResource PrimaryButton}" Margin="0,0,8,0" Click="BtnLuu_Click">
                                    <StackPanel Orientation="Horizontal">
                                        <Viewbox Width="23" Height="23" Margin="0,0,8,0">
                                            <Path Data="{StaticResource IconSave}" Fill="White"/>
                                        </Viewbox>
                                        <TextBlock Text="LÆ°u" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                                <Button x:Name="btnXoa" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionRedBrush}" Click="BtnXoa_Click">
                                    <StackPanel Orientation="Horizontal">
                                        <Viewbox Width="23" Height="23" Margin="0,0,8,0">
                                            <Path Data="{StaticResource IconDelete}" Fill="White"/>
                                        </Viewbox>
                                        <TextBlock Text="XÃ³a" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                        </Grid>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Äang táº£i..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyKhuyenMaiView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
// THÃŠM Má»šI
using Microsoft.Win32;
using System.IO;
using OfficeOpenXml;
using OfficeOpenXml.Table;

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyKhuyenMaiView : Page
    {
        private static readonly HttpClient httpClient;
        private List<KhuyenMaiDto> _allKhuyenMaiList = new List<KhuyenMaiDto>();
        private KhuyenMaiUpdateRequestDto? _selectedKhuyenMai = null;
        private List<FilterLookupDto> _sanPhamList = new List<FilterLookupDto>();

        static QuanLyKhuyenMaiView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyKhuyenMaiView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            cmbFilterTrangThai.SelectedIndex = 0; // "Táº¥t cáº£"
            await LoadKhuyenMaiFiltersAsync();
            await LoadKhuyenMaiGridAsync();
            ResetKhuyenMaiForm();
        }

        private async Task LoadKhuyenMaiFiltersAsync()
        {
            try
            {
                var filters = await httpClient.GetFromJsonAsync<KhuyenMaiFiltersDto>("api/app/khuyenmai/filters");
                if (filters != null)
                {
                    _sanPhamList = filters.SanPhams;
                    _sanPhamList.Insert(0, new FilterLookupDto { Id = 0, Ten = "Táº¥t cáº£ sáº£n pháº©m" });
                    cmbSanPhamApDung.ItemsSource = _sanPhamList;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i bá»™ lá»c khuyáº¿n mÃ£i: {ex.Message}", "Lá»—i API");
            }
        }

        private async Task LoadKhuyenMaiGridAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                string maKhuyenMai = txtSearchMaKM.Text;
                string trangThai = (cmbFilterTrangThai.SelectedItem as ComboBoxItem)?.Content.ToString() ?? "Táº¥t cáº£";

                var url = $"api/app/khuyenmai/search?maKhuyenMai={Uri.EscapeDataString(maKhuyenMai)}&trangThai={Uri.EscapeDataString(trangThai)}";

                _allKhuyenMaiList = (await httpClient.GetFromJsonAsync<List<KhuyenMaiDto>>(url)) ?? new List<KhuyenMaiDto>();
                dgKhuyenMai.ItemsSource = _allKhuyenMaiList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i danh sÃ¡ch khuyáº¿n mÃ£i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        // Sá»° KIá»†N Má»šI: Xá»­ lÃ½ khi thay Ä‘á»•i filter
        private async void Filter_Changed(object sender, RoutedEventArgs e)
        {
            if (this.IsLoaded) // Chá»‰ cháº¡y khi Page Ä‘Ã£ load xong
            {
                await LoadKhuyenMaiGridAsync();
            }
        }

        // (HÃ m Filter_Changed(object sender, SelectionChangedEventArgs e) Ä‘Ã£ Ä‘Æ°á»£c gá»™p chung)

        private void ResetKhuyenMaiForm()
        {
            _selectedKhuyenMai = null;
            dgKhuyenMai.SelectedItem = null;

            btnThem.Visibility = Visibility.Visible;
            btnLuu.Visibility = Visibility.Collapsed;
            btnXoa.Visibility = Visibility.Collapsed;
            btnTamDung.Visibility = Visibility.Collapsed;

            txtMaKhuyenMai.IsEnabled = true;
            txtMaKhuyenMai.Text = "";
            txtTenKM.Text = "";
            txtMoTa.Text = "";
            cmbLoaiGiamGia.SelectedIndex = 0; // PhanTram
            txtGiaTriGiam.Text = "10";
            txtGiamToiDa.Text = "0";
            txtDonHangToiThieu.Text = "0";
            cmbSanPhamApDung.SelectedValue = 0;
            dpNgayBatDau.SelectedDate = DateTime.Today;
            dpNgayKetThuc.SelectedDate = DateTime.Today.AddDays(7);
            txtDayOfWeek.Text = "";
            txtTimeStart.Text = "00:00";
            txtTimeEnd.Text = "23:59";
            txtDieuKienApDung.Text = "";
        }

        private async void DgKhuyenMai_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgKhuyenMai.SelectedItem is not KhuyenMaiDto selected)
            {
                ResetKhuyenMaiForm();
                return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                _selectedKhuyenMai = await httpClient.GetFromJsonAsync<KhuyenMaiUpdateRequestDto>($"api/app/khuyenmai/details/{selected.IdKhuyenMai}");
                if (_selectedKhuyenMai == null)
                {
                    ResetKhuyenMaiForm();
                    return;
                }

                btnThem.Visibility = Visibility.Collapsed;
                btnLuu.Visibility = Visibility.Visible;
                btnXoa.Visibility = Visibility.Visible;

                btnTamDung.Visibility = (_selectedKhuyenMai.TrangThai != "Háº¿t háº¡n") ? Visibility.Visible : Visibility.Collapsed;
                btnTamDung.Content = (_selectedKhuyenMai.TrangThai == "Táº¡m dá»«ng") ? "KÃ­ch Hoáº¡t Láº¡i" : "Táº¡m Dá»«ng";

                txtMaKhuyenMai.Text = _selectedKhuyenMai.MaKhuyenMai;
                txtMaKhuyenMai.IsEnabled = false;

                txtTenKM.Text = _selectedKhuyenMai.TenChuongTrinh;
                txtMoTa.Text = _selectedKhuyenMai.MoTa;
                cmbLoaiGiamGia.Text = _selectedKhuyenMai.LoaiGiamGia;
                txtGiaTriGiam.Text = _selectedKhuyenMai.GiaTriGiam.ToString("F0");
                txtGiamToiDa.Text = _selectedKhuyenMai.GiamToiDa?.ToString("F0") ?? "0";
                txtDonHangToiThieu.Text = _selectedKhuyenMai.HoaDonToiThieu?.ToString("F0") ?? "0";
                cmbSanPhamApDung.SelectedValue = _selectedKhuyenMai.IdSanPhamApDung ?? 0;
                dpNgayBatDau.SelectedDate = _selectedKhuyenMai.NgayBatDau;
                dpNgayKetThuc.SelectedDate = _selectedKhuyenMai.NgayKetThuc;
                txtDayOfWeek.Text = _selectedKhuyenMai.NgayTrongTuan;
                txtTimeStart.Text = _selectedKhuyenMai.GioBatDau ?? "00:00";
                txtTimeEnd.Text = _selectedKhuyenMai.GioKetThuc ?? "23:59";
                txtDieuKienApDung.Text = _selectedKhuyenMai.DieuKienApDung;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i chi tiáº¿t khuyáº¿n mÃ£i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnLamMoi_Click(object sender, RoutedEventArgs e)
        {
            ResetKhuyenMaiForm();
        }

        private async void BtnThem_Click(object sender, RoutedEventArgs e)
        {
            await SaveKhuyenMaiAsync(isCreating: true);
        }

        private async void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            await SaveKhuyenMaiAsync(isCreating: false);
        }

        private async Task SaveKhuyenMaiAsync(bool isCreating)
        {
            if (string.IsNullOrWhiteSpace(txtMaKhuyenMai.Text))
            {
                MessageBox.Show("MÃ£ khuyáº¿n mÃ£i lÃ  báº¯t buá»™c.", "Lá»—i"); return;
            }
            if (dpNgayBatDau.SelectedDate == null || dpNgayKetThuc.SelectedDate == null)
            {
                MessageBox.Show("NgÃ y báº¯t Ä‘áº§u vÃ  káº¿t thÃºc lÃ  báº¯t buá»™c.", "Lá»—i"); return;
            }
            if (dpNgayKetThuc.SelectedDate < dpNgayBatDau.SelectedDate)
            {
                MessageBox.Show("NgÃ y káº¿t thÃºc khÃ´ng thá»ƒ trÆ°á»›c ngÃ y báº¯t Ä‘áº§u.", "Lá»—i"); return;
            }

            var dto = new KhuyenMaiUpdateRequestDto
            {
                MaKhuyenMai = txtMaKhuyenMai.Text,
                TenChuongTrinh = txtTenKM.Text,
                MoTa = txtMoTa.Text,
                LoaiGiamGia = (cmbLoaiGiamGia.SelectedItem as ComboBoxItem)?.Tag.ToString() ?? "SoTien",
                GiaTriGiam = decimal.TryParse(txtGiaTriGiam.Text, out var g) ? g : 0,
                GiamToiDa = decimal.TryParse(txtGiamToiDa.Text, out var gt) ? (decimal?)gt : null,
                HoaDonToiThieu = decimal.TryParse(txtDonHangToiThieu.Text, out var hd) ? (decimal?)hd : null,
                IdSanPhamApDung = (int)cmbSanPhamApDung.SelectedValue > 0 ? (int)cmbSanPhamApDung.SelectedValue : null,
                NgayBatDau = dpNgayBatDau.SelectedDate.Value,
                NgayKetThuc = dpNgayKetThuc.SelectedDate.Value,
                NgayTrongTuan = txtDayOfWeek.Text,
                GioBatDau = txtTimeStart.Text,
                GioKetThuc = txtTimeEnd.Text,
                DieuKienApDung = txtDieuKienApDung.Text,
                TrangThai = _selectedKhuyenMai?.TrangThai ?? "Hoáº¡t Ä‘á»™ng"
            };

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                HttpResponseMessage response;
                if (isCreating)
                {
                    response = await httpClient.PostAsJsonAsync("api/app/khuyenmai", dto);
                }
                else
                {
                    dto.IdKhuyenMai = _selectedKhuyenMai.IdKhuyenMai;
                    response = await httpClient.PutAsJsonAsync($"api/app/khuyenmai/{dto.IdKhuyenMai}", dto);
                }

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("LÆ°u khuyáº¿n mÃ£i thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadKhuyenMaiGridAsync();
                    ResetKhuyenMaiForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXoa_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedKhuyenMai == null) return;
            var result = MessageBox.Show($"Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a '{_selectedKhuyenMai.TenChuongTrinh}'?", "XÃ¡c nháº­n", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/khuyenmai/{_selectedKhuyenMai.IdKhuyenMai}");
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("XÃ³a thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadKhuyenMaiGridAsync();
                    ResetKhuyenMaiForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "KhÃ´ng thá»ƒ xÃ³a");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnTamDung_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedKhuyenMai == null) return;

            string newStatus = (_selectedKhuyenMai.TrangThai == "Hoáº¡t Ä‘á»™ng") ? "Táº¡m dá»«ng" : "Hoáº¡t Ä‘á»™ng";
            _selectedKhuyenMai.TrangThai = newStatus;

            await SaveKhuyenMaiAsync(isCreating: false);
        }

        // --- THÃŠM Má»šI: NÃšT QUAY Láº I ---
        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }

        // --- THÃŠM Má»šI: NÃšT XUáº¤T EXCEL ---
        private void BtnExportToExcel_Click(object sender, RoutedEventArgs e)
        {
            if (_allKhuyenMaiList == null || !_allKhuyenMaiList.Any())
            {
                MessageBox.Show("KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t.", "ThÃ´ng bÃ¡o");
                return;
            }

            var sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                FileName = $"DSKhuyenMai_{DateTime.Now:yyyyMMdd_HHmm}.xlsx"
            };

            if (sfd.ShowDialog() == true)
            {
                try
                {
                    ExcelPackage.License.SetNonCommercialPersonal("CafeBook");
                    using (var package = new ExcelPackage(new FileInfo(sfd.FileName)))
                    {
                        var ws = package.Workbook.Worksheets.Add("DanhSachKhuyenMai");
                        ws.Cells["A1"].Value = "Danh sÃ¡ch Khuyáº¿n mÃ£i";
                        ws.Cells["A1:D1"].Merge = true;
                        ws.Cells["A1"].Style.Font.Bold = true;
                        ws.Cells["A1"].Style.Font.Size = 16;

                        ws.Cells["A3"].LoadFromCollection(_allKhuyenMaiList, true, TableStyles.Medium9);

                        // Äá»‹nh dáº¡ng cá»™t ngÃ y
                        var table = ws.Tables[0];
                        int ngayBatDauCol = table.Columns["NgayBatDau"].Position + table.Address.Start.Column;
                        int ngayKetThucCol = table.Columns["NgayKetThuc"].Position + table.Address.Start.Column;

                        ws.Column(ngayBatDauCol).Style.Numberformat.Format = "dd/MM/yyyy";
                        ws.Column(ngayKetThucCol).Style.Numberformat.Format = "dd/MM/yyyy";

                        ws.Cells[ws.Dimension.Address].AutoFitColumns();
                        package.Save();
                    }
                    MessageBox.Show("Xuáº¥t Excel thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Lá»—i khi xuáº¥t Excel: {ex.Message}\n\nÄáº£m báº£o file khÃ´ng Ä‘ang Ä‘Æ°á»£c má»Ÿ.", "Lá»—i");
                }
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyLichLamViecView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyLichLamViecView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyLichLamViecView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="750" d:DesignWidth="1200"
      Title="Quáº£n lÃ½ Lá»‹ch LÃ m Viá»‡c &amp; Ca LÃ m"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionOrangeBrush" Color="#FFA726"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>
        
        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>
        <Geometry x:Key="IconAssign">M19,3H14V5H19V18L14,12V21H19C20.1,21 21,20.1 21,19V5C21,3.9 20.1,3 19,3M5,3C3.9,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H10V12L5,18V5H10V3H5Z</Geometry>
        <Geometry x:Key="IconLeave">M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.89 20.1,3 19,3M19,19H5V10H19V19M10,14V12H7V14H10M14,14V12H11V14H14M18,14V12H15V14H18Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="GroupItem">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="GroupItem">
                        <StackPanel>
                            <TextBlock Text="{Binding Name}" 
                                       FontSize="16" FontWeight="Bold" 
                                       Foreground="{StaticResource PrimaryBrownBrush}" 
                                       Margin="5,15,0,5" />
                            <ItemsPresenter />
                        </StackPanel>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Quáº£n lÃ½ Lá»‹ch LÃ m Viá»‡c &amp; Ca LÃ m" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="320"/>
                    <ColumnDefinition Width="320"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Margin="10,0,5,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Text="Ca LÃ m Viá»‡c Máº«u" Style="{StaticResource HeaderTextBlock}"/>

                        <StackPanel Grid.Row="1">
                            <TextBlock Text="TÃªn Ca:" Margin="0,0,0,5" FontSize="12" FontWeight="SemiBold"/>
                            <TextBox x:Name="txtTenCa" Margin="0,0,0,10"/>

                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0" Margin="0,0,5,0">
                                    <TextBlock Text="Giá» Báº¯t Äáº§u (HH:mm):" Margin="0,0,0,5" FontSize="12" FontWeight="SemiBold"/>
                                    <TextBox x:Name="txtGioBatDau" Margin="0,0,0,10"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1" Margin="5,0,0,0">
                                    <TextBlock Text="Giá» Káº¿t ThÃºc (HH:mm):" Margin="0,0,0,5" FontSize="12" FontWeight="SemiBold"/>
                                    <TextBox x:Name="txtGioKetThuc" Margin="0,0,0,10"/>
                                </StackPanel>
                            </Grid>

                            <Grid Height="40" Margin="0,5,0,15">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Button x:Name="btnLamMoiCa" Grid.Column="0" ToolTip="LÃ m má»›i Form" Click="BtnLamMoiCa_Click" Background="Transparent" BorderThickness="0">
                                    <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="22" Height="22"/>
                                </Button>
                                <Button x:Name="btnThemCa" Grid.Column="1" Style="{StaticResource PrimaryButton}" Background="{StaticResource SuccessBrush}" Click="BtnThemCa_Click" Margin="10,0,5,0">
                                    <StackPanel Orientation="Horizontal">
                                        <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                            <Path Data="{StaticResource IconAdd}" Fill="White"/>
                                        </Viewbox>
                                        <TextBlock Text="ThÃªm" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                                <Button x:Name="btnLuuCa" Grid.Column="2" Style="{StaticResource PrimaryButton}" Click="BtnLuuCa_Click" Margin="5,0">
                                    <StackPanel Orientation="Horizontal">
                                        <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                            <Path Data="{StaticResource IconSave}" Fill="White"/>
                                        </Viewbox>
                                        <TextBlock Text="LÆ°u" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                                <Button x:Name="btnXoaCa" Grid.Column="3" Style="{StaticResource PrimaryButton}" Background="{StaticResource ErrorBrush}" Click="BtnXoaCa_Click" Margin="5,0,0,0">
                                    <StackPanel Orientation="Horizontal">
                                        <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                            <Path Data="{StaticResource IconDelete}" Fill="White"/>
                                        </Viewbox>
                                        <TextBlock Text="XÃ³a" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                            </Grid>
                        </StackPanel>

                        <DataGrid Grid.Row="2" x:Name="dgCaMau" AutoGenerateColumns="False" IsReadOnly="True" 
                                  SelectionMode="Single" SelectionChanged="DgCaMau_SelectionChanged"
                                  BorderThickness="0" RowHeaderWidth="0">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="TÃªn Ca" Binding="{Binding TenCa}" Width="*"/>
                                <DataGridTextColumn Header="Báº¯t Ä‘áº§u" Binding="{Binding GioBatDau, StringFormat=hh\\:mm}" Width="Auto"/>
                                <DataGridTextColumn Header="Káº¿t thÃºc" Binding="{Binding GioKetThuc, StringFormat=hh\\:mm}" Width="Auto"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>

                <Border Grid.Column="1" Margin="5,0,5,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Text="GÃ¡n Lá»‹ch Má»›i" Style="{StaticResource HeaderTextBlock}"/>

                        <StackPanel Grid.Row="1">
                            <TextBlock Text="GÃ¡n cho ngÃ y:" Margin="0,0,0,5" FontSize="12" FontWeight="SemiBold"/>
                            <DatePicker x:Name="dpNgayGanLich" Margin="0,0,0,10"/>

                            <TextBlock Text="Chá»n ca máº«u:" Margin="0,0,0,5" FontSize="12" FontWeight="SemiBold"/>
                            <ComboBox x:Name="cmbCaDeGan" DisplayMemberPath="TenCa" SelectedValuePath="IdCa" Margin="0,0,0,15"/>
                        </StackPanel>

                        <StackPanel Grid.Row="2">
                            <TextBlock Text="Chá»n nhÃ¢n viÃªn:" Margin="0,0,0,5" FontSize="12" FontWeight="SemiBold"/>
                            <Border BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="1" CornerRadius="4">
                                <ListView x:Name="lbNhanVienDeGan" MaxHeight="300" BorderThickness="0">
                                    <ListView.ItemTemplate>
                                        <DataTemplate>
                                            <CheckBox Content="{Binding HoTen}" 
                                                      IsChecked="{Binding IsChecked, Mode=TwoWay}"
                                                      Margin="5"/>
                                        </DataTemplate>
                                    </ListView.ItemTemplate>
                                </ListView>
                            </Border>
                        </StackPanel>

                        <Button Grid.Row="3" x:Name="btnGanLich" Style="{StaticResource PrimaryButton}" 
                                Background="{StaticResource ActionBlueBrush}" 
                                Click="BtnGanLich_Click" Margin="0,20,0,0" Padding="15">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconAssign}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="GÃ¡n Lá»‹ch LÃ m Viá»‡c" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </Grid>
                </Border>

                <Border Grid.Column="2" Margin="5,0,10,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Text="Xem Lá»‹ch LÃ m Viá»‡c" Style="{StaticResource HeaderTextBlock}"/>

                        <Calendar Grid.Row="1" x:Name="calendarView" 
                                  SelectedDatesChanged="CalendarView_SelectedDatesChanged"
                                  Margin="0,0,0,15"/>

                        <ListView Grid.Row="2" x:Name="lbLichLamViecHomNay" BorderThickness="0" Background="Transparent">
                            <ListView.GroupStyle>
                                <GroupStyle HidesIfEmpty="True"/>
                            </ListView.GroupStyle>

                            <ListView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Width="350">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                            <TextBlock Text="{Binding HoTenNhanVien}" FontWeight="SemiBold"/>

                                            <TextBlock Opacity="0.8">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Text" Value="{Binding LyDoNghi}"/>
                                                        <Setter Property="Foreground" Value="{StaticResource ActionOrangeBrush}"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding LoaiLich}" Value="CaLam">
                                                                <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
                                                                <Setter Property="Text">
                                                                    <Setter.Value>
                                                                        <MultiBinding StringFormat="{}{0:hh\:mm} - {1:hh\:mm}">
                                                                            <Binding Path="GioBatDau"/>
                                                                            <Binding Path="GioKetThuc"/>
                                                                        </MultiBinding>
                                                                    </Setter.Value>
                                                                </Setter>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                        </StackPanel>

                                        <Button x:Name="btnXoaLich" Grid.Column="1" ToolTip="XÃ³a lá»‹ch nÃ y"
                                            Background="Transparent"
                                            Click="BtnXoaLich_Click"
                                            Tag="{Binding IdLich}">
                                            <Path Data="{StaticResource IconDelete}" Fill="{StaticResource ErrorBrush}" Width="23" Height="23"/>

                                            <Button.Style>
                                                <Style TargetType="Button" BasedOn="{StaticResource PrimaryButton}">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding LoaiLich}" Value="NghiPhep">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Button.Style>
                                        </Button>
                                    </Grid>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </Grid>
                </Border>
            </Grid>

            <Button x:Name="btnQuayLai" Grid.Row="2" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" Margin="10,0,0,10"
                    Click="BtnQuayLai_Click">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                    <TextBlock Text="Quay láº¡i" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
            <Button Grid.Row="3" x:Name="btnGoToDonXinNghi" Style="{StaticResource PrimaryButton}" 
                                Background="{StaticResource ActionOrangeBrush}" 
                                Click="BtnGoToDonXinNghi_Click" Margin="0,15,0,0" Width="200" Padding="10" HorizontalAlignment="Right">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconLeave}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                    <TextBlock Text="Quáº£n lÃ½ ÄÆ¡n Xin Nghá»‰" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Äang xá»­ lÃ½..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyLichLamViecView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Threading.Tasks;
using System.ComponentModel; // Cáº§n cho INotifyPropertyChanged
using System.Globalization; // Cáº§n cho TimeSpan.ParseExact
using System.Net;

namespace AppCafebookApi.View.quanly.pages
{
    /// <summary>
    /// View-Model ná»™i bá»™ cho CheckBox NhÃ¢n viÃªn
    /// </summary>
    public class NhanVienCheckItem : INotifyPropertyChanged
    {
        public int IdNhanVien { get; set; }
        public string HoTen { get; set; } = string.Empty;

        private bool _isChecked;
        public bool IsChecked
        {
            get => _isChecked;
            set
            {
                if (_isChecked != value)
                {
                    _isChecked = value;
                    PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(nameof(IsChecked)));
                }
            }
        }
        public event PropertyChangedEventHandler? PropertyChanged;
    }

    public partial class QuanLyLichLamViecView : Page
    {
        private static readonly HttpClient httpClient;
        private List<CaLamViecDto> _allCaMauList = new List<CaLamViecDto>();
        private List<NhanVienCheckItem> _allNhanVienList = new List<NhanVienCheckItem>();
        private CaLamViecDto? _selectedCaMau = null;

        static QuanLyLichLamViecView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyLichLamViecView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            await LoadCaMauAsync();
            await LoadNhanVienAsync();
            ResetCaMauForm();

            calendarView.SelectedDate = DateTime.Today; // Tá»± Ä‘á»™ng chá»n hÃ´m nay
            await LoadLichLamViecByDateAsync(DateTime.Today);

            LoadingOverlay.Visibility = Visibility.Collapsed;
        }

        #region === QUáº¢N LÃ CA MáºªU (Cá»˜T 1) ===

        private async Task LoadCaMauAsync()
        {
            try
            {
                _allCaMauList = (await httpClient.GetFromJsonAsync<List<CaLamViecDto>>("api/app/calamviec/all")) ?? new List<CaLamViecDto>();
                dgCaMau.ItemsSource = _allCaMauList;
                cmbCaDeGan.ItemsSource = _allCaMauList; // Cáº­p nháº­t ComboBox
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i danh sÃ¡ch ca máº«u: {ex.Message}", "Lá»—i API");
            }
        }

        private void ResetCaMauForm()
        {
            _selectedCaMau = null;
            dgCaMau.SelectedItem = null;
            txtTenCa.Text = "";
            txtGioBatDau.Text = "08:00";
            txtGioKetThuc.Text = "16:00";
            btnThemCa.IsEnabled = true;
            btnLuuCa.IsEnabled = false;
            btnXoaCa.IsEnabled = false;
        }

        private void DgCaMau_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgCaMau.SelectedItem is CaLamViecDto selected)
            {
                _selectedCaMau = selected;
                txtTenCa.Text = selected.TenCa;
                txtGioBatDau.Text = selected.GioBatDau.ToString(@"hh\:mm");
                txtGioKetThuc.Text = selected.GioKetThuc.ToString(@"hh\:mm");
                btnThemCa.IsEnabled = false;
                btnLuuCa.IsEnabled = true;
                btnXoaCa.IsEnabled = true;
            }
        }

        private void BtnLamMoiCa_Click(object sender, RoutedEventArgs e)
        {
            ResetCaMauForm();
        }

        private async void BtnThemCa_Click(object sender, RoutedEventArgs e)
        {
            await SaveCaMauAsync(isCreating: true);
        }

        private async void BtnLuuCa_Click(object sender, RoutedEventArgs e)
        {
            await SaveCaMauAsync(isCreating: false);
        }

        private async Task SaveCaMauAsync(bool isCreating)
        {
            if (string.IsNullOrWhiteSpace(txtTenCa.Text))
            {
                MessageBox.Show("TÃªn ca lÃ  báº¯t buá»™c.", "Lá»—i"); return;
            }
            if (!TimeSpan.TryParseExact(txtGioBatDau.Text, @"hh\:mm", CultureInfo.InvariantCulture, out var gioBatDau) ||
                !TimeSpan.TryParseExact(txtGioKetThuc.Text, @"hh\:mm", CultureInfo.InvariantCulture, out var gioKetThuc))
            {
                MessageBox.Show("Giá» báº¯t Ä‘áº§u hoáº·c káº¿t thÃºc khÃ´ng há»£p lá»‡. Vui lÃ²ng dÃ¹ng Ä‘á»‹nh dáº¡ng HH:mm (vÃ­ dá»¥: 08:00 hoáº·c 14:30).", "Lá»—i Ä‘á»‹nh dáº¡ng");
                return;
            }

            var dto = new CaLamViecDto
            {
                TenCa = txtTenCa.Text,
                GioBatDau = gioBatDau,
                GioKetThuc = gioKetThuc
            };

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                HttpResponseMessage response;
                if (isCreating)
                {
                    response = await httpClient.PostAsJsonAsync("api/app/calamviec", dto);
                }
                else
                {
                    dto.IdCa = _selectedCaMau.IdCa;
                    response = await httpClient.PutAsJsonAsync($"api/app/calamviec/{dto.IdCa}", dto);
                }

                if (response.IsSuccessStatusCode)
                {
                    await LoadCaMauAsync();
                    ResetCaMauForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXoaCa_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedCaMau == null) return;

            var result = MessageBox.Show($"Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a ca '{_selectedCaMau.TenCa}'?", "XÃ¡c nháº­n", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/calamviec/{_selectedCaMau.IdCa}");
                if (response.IsSuccessStatusCode)
                {
                    await LoadCaMauAsync();
                    ResetCaMauForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "KhÃ´ng thá»ƒ xÃ³a");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion

        #region === GÃN Lá»ŠCH (Cá»˜T 2) ===

        private async Task LoadNhanVienAsync()
        {
            try
            {
                var dtos = (await httpClient.GetFromJsonAsync<List<NhanVienLookupDto>>("api/app/lichlamviec/all-nhanvien")) ?? new List<NhanVienLookupDto>();
                _allNhanVienList = dtos.Select(d => new NhanVienCheckItem
                {
                    IdNhanVien = d.IdNhanVien,
                    HoTen = d.HoTen,
                    IsChecked = false
                }).ToList();
                lbNhanVienDeGan.ItemsSource = _allNhanVienList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i danh sÃ¡ch nhÃ¢n viÃªn: {ex.Message}", "Lá»—i API");
            }
        }

        private async void BtnGanLich_Click(object sender, RoutedEventArgs e)
        {
            if (dpNgayGanLich.SelectedDate == null)
            {
                MessageBox.Show("Vui lÃ²ng chá»n ngÃ y Ä‘á»ƒ gÃ¡n lá»‹ch.", "Lá»—i"); return;
            }
            if (cmbCaDeGan.SelectedValue == null)
            {
                MessageBox.Show("Vui lÃ²ng chá»n ca lÃ m viá»‡c máº«u.", "Lá»—i"); return;
            }
            var selectedNhanVienIds = _allNhanVienList
                .Where(nv => nv.IsChecked)
                .Select(nv => nv.IdNhanVien)
                .ToList();
            if (!selectedNhanVienIds.Any())
            {
                MessageBox.Show("Vui lÃ²ng chá»n Ã­t nháº¥t má»™t nhÃ¢n viÃªn.", "Lá»—i"); return;
            }

            var dto = new LichLamViecCreateDto
            {
                NgayGanLich = dpNgayGanLich.SelectedDate.Value,
                IdCa = (int)cmbCaDeGan.SelectedValue,
                DanhSachIdNhanVien = selectedNhanVienIds
            };

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/lichlamviec/assign", dto);

                // === Sá»¬A Lá»–I CS1977: DÃ¹ng DTO cá»¥ thá»ƒ ===
                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<LichLamViecAssignResponseDto>();
                    if (result == null) throw new Exception("KhÃ´ng thá»ƒ Ä‘á»c pháº£n há»“i API.");

                    string message = result.Message;
                    var failures = result.Failures;

                    if (failures.Any())
                    {
                        message += "\n\nCÃ¡c lá»—i xáº£y ra:\n- " + string.Join("\n- ", failures);
                        MessageBox.Show(message, "Cáº£nh bÃ¡o", MessageBoxButton.OK, MessageBoxImage.Warning);
                    }
                    else
                    {
                        MessageBox.Show(message, "ThÃ nh cÃ´ng", MessageBoxButton.OK, MessageBoxImage.Information);
                    }
                }
                else
                {
                    MessageBox.Show($"Lá»—i API: {await response.Content.ReadAsStringAsync()}", "Lá»—i");
                }
                // === Káº¾T THÃšC Sá»¬A Lá»–I ===


                // LÃ m má»›i lá»‹ch náº¿u ngÃ y gÃ¡n = ngÃ y Ä‘ang xem
                if (calendarView.SelectedDate == dto.NgayGanLich.Date)
                {
                    await LoadLichLamViecByDateAsync(dto.NgayGanLich.Date);
                }
                // Bá» check táº¥t cáº£ nhÃ¢n viÃªn
                foreach (var nv in _allNhanVienList) { nv.IsChecked = false; }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion

        #region === XEM Lá»ŠCH (Cá»˜T 3) ===

        private async void CalendarView_SelectedDatesChanged(object sender, SelectionChangedEventArgs e)
        {
            if (calendarView.SelectedDate.HasValue)
            {
                await LoadLichLamViecByDateAsync(calendarView.SelectedDate.Value);
            }
        }

        private async Task LoadLichLamViecByDateAsync(DateTime date)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var data = (await httpClient.GetFromJsonAsync<List<LichLamViecDisplayDto>>($"api/app/lichlamviec/by-date?date={date:yyyy-MM-dd}")) ?? new List<LichLamViecDisplayDto>();

                // NhÃ³m theo TÃªn Ca (Ca SÃ¡ng, Ca Chiá»u, Nghá»‰ PhÃ©p)
                var cvs = new CollectionViewSource { Source = data };
                cvs.GroupDescriptions.Add(new PropertyGroupDescription("TenCa", new TenCaToNhomConverter()));

                lbLichLamViecHomNay.ItemsSource = cvs.View;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i lá»‹ch lÃ m viá»‡c: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXoaLich_Click(object sender, RoutedEventArgs e)
        {
            var button = sender as Button;
            if (button?.Tag == null) return;

            int idLichLamViec = (int)button.Tag;

            var result = MessageBox.Show("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a lá»‹ch lÃ m viá»‡c nÃ y?", "XÃ¡c nháº­n", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/lichlamviec/{idLichLamViec}");
                if (response.IsSuccessStatusCode)
                {
                    // Táº£i láº¡i lá»‹ch
                    if (calendarView.SelectedDate.HasValue)
                    {
                        await LoadLichLamViecByDateAsync(calendarView.SelectedDate.Value);
                    }
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "KhÃ´ng thá»ƒ xÃ³a");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            // Quay láº¡i trang QL NhÃ¢n ViÃªn
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
            else
            {
                // Fallback náº¿u khÃ´ng CanGoBack
                this.NavigationService?.Navigate(new QuanLyNhanVienView());
            }
        }

        private void BtnGoToDonXinNghi_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new QuanLyDonXinNghiView());
        }
    }

    /// <summary>
    /// Converter Ä‘á»ƒ nhÃ³m "Nghá»‰ PhÃ©p" vÃ o má»™t nhÃ³m riÃªng
    /// </summary>
    public class TenCaToNhomConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value is string tenCa)
            {
                return string.IsNullOrEmpty(tenCa) ? "Nghá»‰ PhÃ©p / KhÃ¡c" : tenCa;
            }
            return "KhÃ¡c";
        }
        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyLuongView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyLuongView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyLuongView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quáº£n lÃ½ Há»‡ Thá»‘ng LÆ°Æ¡ng"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionOrangeBrush" Color="#FFA726"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="PrimaryBrown" Color="#6F4E37"/>
        <SolidColorBrush x:Key="AccentOrange" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteText" Color="#FFFFFF"/>
        <Geometry x:Key="IconPayment">M17,15V14H19V11H21V14H23V15H21V18H19V15H17M1,3H21C22.1,3 23,3.9 23,5V9H1V5C1,3.9 1.9,3 1,3M3,7H7V11H3V7M3,13H7V17H3V13M9,7H21V11H9V7M9,13H15V17H9V13Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconCalculate">M19,3H5C3.89,3 3,3.89 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.89 20.1,3 19,3M19,19H5V5H19V19M16.25,7.72L15.18,6.65L12,9.83L8.82,6.65L7.75,7.72L10.93,10.9L7.75,14.08L8.82,15.15L12,11.97L15.18,15.15L16.25,14.08L13.07,10.9L16.25,7.72Z</Geometry>
        <Geometry x:Key="IconFinalize">M12,16L19.36,10.27L21,12L12,18L3,12L4.63,10.27L12,16M12,3L3,9L12,15L21,9L12,3Z</Geometry>
        <Geometry x:Key="IconReport">M10,17L6,21H18L14,17H10M10,10H14V15H10V10M4,3H20C21.1,3 22,3.9 22,5V17C22,18.1 21.1,19 20,19H4C2.9,19 2,18.1 2,17V5C2,3.9 2.9,3 4,3Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrown}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteText}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Height" Value="42"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                CornerRadius="21"
                                Background="{TemplateBinding Background}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="2" Color="#6F4E37" Opacity="0.3" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource AccentOrange}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>

        <Style TargetType="TabControl">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
        <Style TargetType="TabItem">
            <Setter Property="Background" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
            <Setter Property="Padding" Value="15,8"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border x:Name="border" BorderThickness="0,0,0,3" BorderBrush="Transparent" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" Margin="0,0,5,0">
                            <ContentPresenter ContentSource="Header" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="Background" Value="White"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Quáº£n lÃ½ LÆ°Æ¡ng &amp; Cháº¥m CÃ´ng" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <TabControl Grid.Row="1" Margin="10,0,10,10">

                <TabItem Header="Báº£ng Cháº¥m CÃ´ng (HÃ ng ngÃ y)">
                    <Grid Background="White" Margin="0,5,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="300"/>
                        </Grid.ColumnDefinitions>

                        <Grid Grid.Column="0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10">
                                <TextBlock Text="Chá»n ngÃ y:" VerticalAlignment="Center" Margin="0,0,5,0" FontWeight="SemiBold"/>
                                <DatePicker x:Name="dpNgayChamCong" Width="150" SelectedDateChanged="DpNgayChamCong_SelectedDateChanged"/>
                            </StackPanel>

                            <DataGrid Grid.Row="1" x:Name="dgChamCong" AutoGenerateColumns="False" IsReadOnly="True" 
                                      SelectionMode="Single" SelectionChanged="DgChamCong_SelectionChanged"
                                      BorderThickness="0" RowHeaderWidth="0" Margin="10,0,10,10">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="NhÃ¢n viÃªn" Binding="{Binding HoTenNhanVien}" Width="*"/>
                                    <DataGridTextColumn Header="Ca" Binding="{Binding TenCa}" Width="Auto"/>
                                    <DataGridTextColumn Header="Giá» Ca" Binding="{Binding GioCaBatDau, StringFormat=hh\\:mm}" Width="Auto"/>
                                    <DataGridTextColumn Header="Giá» VÃ o" Binding="{Binding GioVao, StringFormat=HH:mm:ss}" Width="Auto"/>
                                    <DataGridTextColumn Header="Giá» Ra" Binding="{Binding GioRa, StringFormat=HH:mm:ss}" Width="Auto"/>
                                    <DataGridTextColumn Header="Giá» LÃ m" Binding="{Binding SoGioLam, StringFormat=F2}" Width="Auto"/>
                                    <DataGridTextColumn Header="Tráº¡ng thÃ¡i" Binding="{Binding TrangThai}" Width="Auto"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>

                        <Border Grid.Column="1" Background="{StaticResource SubtleGrayBrush}" Padding="15">
                            <StackPanel x:Name="formChamCong" IsEnabled="False">
                                <TextBlock x:Name="lblChamCongTitle" Text="Äiá»u chá»‰nh Cháº¥m CÃ´ng" FontWeight="Bold" FontSize="16" Margin="0,0,0,10"/>
                                <TextBlock Text="NhÃ¢n viÃªn:" Margin="0,0,0,5" FontSize="12"/>
                                <TextBlock x:Name="lblChamCongNhanVien" Text="[TÃªn NV]" FontWeight="SemiBold" Margin="0,0,0,10"/>

                                <TextBlock Text="Giá» VÃ o (HH:mm):" Margin="0,0,0,5" FontSize="12"/>
                                <TextBox x:Name="txtGioVaoMoi" Margin="0,0,0,10"/>

                                <TextBlock Text="Giá» Ra (HH:mm):" Margin="0,0,0,5" FontSize="12"/>
                                <TextBox x:Name="txtGioRaMoi" Margin="0,0,0,15"/>

                                <Button x:Name="btnLuuChamCong" Style="{StaticResource PrimaryButton}" Click="BtnLuuChamCong_Click">
                                    <StackPanel Orientation="Horizontal">
                                        <Path Data="{StaticResource IconSave}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                        <TextBlock Text="LÆ°u Äiá»u Chá»‰nh" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                        </Border>
                    </Grid>
                </TabItem>

                <TabItem Header="ThÆ°á»Ÿng/Pháº¡t Thá»§ CÃ´ng">
                    <Grid Background="White" Margin="0,5,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="400"/>
                        </Grid.ColumnDefinitions>

                        <Grid Grid.Column="0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10">
                                <TextBlock Text="Chá»n nhÃ¢n viÃªn:" VerticalAlignment="Center" Margin="0,0,5,0" FontWeight="SemiBold"/>
                                <ComboBox x:Name="cmbNhanVienThuongPhat" DisplayMemberPath="HoTen" SelectedValuePath="IdNhanVien" 
                                          Width="250" SelectionChanged="CmbNhanVienThuongPhat_SelectionChanged"/>
                            </StackPanel>

                            <DataGrid Grid.Row="1" x:Name="dgThuongPhat" AutoGenerateColumns="False" IsReadOnly="True" 
                                      BorderThickness="0" RowHeaderWidth="0" Margin="10,0,10,10">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="NgÃ y" Binding="{Binding NgayTao, StringFormat='dd/MM/yyyy'}" Width="Auto"/>
                                    <DataGridTextColumn Header="Sá»‘ Tiá»n" Binding="{Binding SoTien, StringFormat=N0}" Width="100"/>
                                    <DataGridTextColumn Header="LÃ½ do" Binding="{Binding LyDo}" Width="*"/>
                                    <DataGridTextColumn Header="NgÆ°á»i táº¡o" Binding="{Binding TenNguoiTao}" Width="120"/>
                                    <DataGridTemplateColumn Header="XÃ³a" Width="50">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Button x:Name="btnXoaThuongPhat" ToolTip="XÃ³a" Click="BtnXoaThuongPhat_Click" 
                                                        Style="{StaticResource PrimaryButton}" Background="Transparent">
                                                    <Path Data="{StaticResource IconDelete}" Fill="{StaticResource ErrorBrush}" Width="23" Height="23"/>
                                                </Button>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>

                        <Border Grid.Column="1" Background="{StaticResource SubtleGrayBrush}" Padding="15">
                            <StackPanel x:Name="formThuongPhat" IsEnabled="False">
                                <TextBlock Text="ThÃªm ThÆ°á»Ÿng/Pháº¡t" FontWeight="Bold" FontSize="16" Margin="0,0,0,10"/>

                                <TextBlock Text="Sá»‘ Tiá»n (VND):" Margin="0,0,0,5" FontSize="12"/>
                                <TextBox x:Name="txtSoTien" Margin="0,0,0,10" ToolTip="Nháº­p sá»‘ Ã¢m (vÃ­ dá»¥: -50000) náº¿u lÃ  Pháº¡t"/>

                                <TextBlock Text="LÃ½ do:" Margin="0,0,0,5" FontSize="12"/>
                                <TextBox x:Name="txtLyDoThuongPhat" Margin="0,0,0,15" Height="80" TextWrapping="Wrap" AcceptsReturn="True"/>

                                <Button x:Name="btnThemThuongPhat" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionBlueBrush}" 
                                        Click="BtnThemThuongPhat_Click">
                                    <StackPanel Orientation="Horizontal">
                                        <Path Data="{StaticResource IconAdd}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                        <TextBlock Text="ThÃªm Khoáº£n" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                        </Border>
                    </Grid>
                </TabItem>

                <TabItem Header="TÃ­nh &amp; Chá»‘t LÆ°Æ¡ng">
                    <Grid Background="White" Margin="0,5,0,0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <Border Grid.Row="0" Margin="10" Padding="15" Background="{StaticResource SubtleGrayBrush}" CornerRadius="6">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- Tá»« ngÃ y - Äáº¿n ngÃ y -->
                                <StackPanel Orientation="Horizontal" Grid.Column="0" Grid.ColumnSpan="4" VerticalAlignment="Center">
                                    <TextBlock Text="Tá»« NgÃ y:" VerticalAlignment="Center" Margin="0,0,5,0" FontWeight="SemiBold"/>
                                    <DatePicker x:Name="dpNgayBatDauLuong" Width="130"/>

                                    <TextBlock Text="Äáº¿n NgÃ y:" VerticalAlignment="Center" Margin="15,0,5,0" FontWeight="SemiBold"/>
                                    <DatePicker x:Name="dpNgayKetThucLuong" Width="130"/>
                                </StackPanel>

                                <!-- CÃ¡c nÃºt chá»©c nÄƒng -->
                                <StackPanel Grid.Column="4" Orientation="Horizontal" HorizontalAlignment="Right" >
                                    <Button x:Name="btnTinhLuong"
                                            Style="{StaticResource PrimaryButton}" 
                                            Background="{StaticResource ActionOrangeBrush}" 
                                            Click="BtnTinhLuong_Click"
                                            Width="160" Height="36">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconCalculate}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                            <TextBlock Text="TÃ­nh LÆ°Æ¡ng (Táº¡m)" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>

                                    <Button x:Name="btnChotLuong"
                                            Style="{StaticResource PrimaryButton}" 
                                            Background="{StaticResource SuccessBrush}" 
                                            Click="BtnChotLuong_Click"
                                            Width="120" Height="36"
                                            IsEnabled="False">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconFinalize}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                            <TextBlock Text="Chá»‘t LÆ°Æ¡ng" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>

                                    <Button x:Name="btnGoToPhatLuong"
                                            Style="{StaticResource PrimaryButton}" 
                                            Background="{StaticResource PrimaryBrownBrush}" 
                                            Click="BtnGoToPhatLuong_Click"
                                            Width="160" Height="36">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconPayment}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                            <TextBlock Text="PhÃ¡t LÆ°Æ¡ng" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>

                                    <Button x:Name="btnGoToBaoCao"
                                            Style="{StaticResource PrimaryButton}" 
                                            Background="{StaticResource ActionBlueBrush}" 
                                            Click="BtnGoToBaoCao_Click"
                                            Width="130" Height="36">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconReport}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                            <TextBlock Text="BÃ¡o CÃ¡o" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                            </Grid>
                        </Border>


                        <DataGrid Grid.Row="1" x:Name="dgBangKeLuong" AutoGenerateColumns="False" IsReadOnly="True" 
                                  BorderThickness="0" RowHeaderWidth="0" Margin="10,0,10,10">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="NhÃ¢n viÃªn" Binding="{Binding HoTenNhanVien}" Width="*"/>
                                <DataGridTextColumn Header="LÆ°Æ¡ng/Giá»" Binding="{Binding LuongCoBan, StringFormat=N0}" Width="Auto"/>
                                <DataGridTextColumn Header="Giá» LÃ m" Binding="{Binding TongGioLam, StringFormat=F2}" Width="Auto"/>
                                <DataGridTextColumn Header="LÆ°Æ¡ng Giá»" Binding="{Binding TienLuongGio, StringFormat=N0}" Width="Auto"/>
                                <DataGridTextColumn Header="Tá»•ng ThÆ°á»Ÿng" Binding="{Binding TongThuong, StringFormat=N0}" Width="Auto"/>
                                <DataGridTextColumn Header="Tá»•ng Pháº¡t" Binding="{Binding TongPhat, StringFormat=N0}" Width="Auto"/>
                                <DataGridTextColumn Header="THá»°C LÃƒNH" Binding="{Binding ThucLanh, StringFormat=N0}" Width="120" FontWeight="Bold"/>
                                <DataGridTextColumn Header="Chi tiáº¿t" Binding="{Binding ChiTiet}" Width="2*"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </TabItem>
            </TabControl>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Äang xá»­ lÃ½..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyLuongView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Threading.Tasks;
using System.Net;
using AppCafebookApi.Services; // Cáº§n cho AuthService
using System.Globalization;

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyLuongView : Page
    {
        private static readonly HttpClient httpClient;
        private List<NhanVienLookupDto> _allNhanVienList = new List<NhanVienLookupDto>();
        private List<PhieuThuongPhatDto> _currentThuongPhatList = new List<PhieuThuongPhatDto>();
        private List<LuongBangKeDto> _currentBangKeList = new List<LuongBangKeDto>();
        private ChamCongDto? _selectedChamCong = null;

        static QuanLyLuongView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyLuongView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            await LoadNhanVienAsync();

            // Tab 1
            dpNgayChamCong.SelectedDate = DateTime.Today;
            await LoadChamCongAsync(DateTime.Today);

            // Tab 3
            var now = DateTime.Now;
            dpNgayBatDauLuong.SelectedDate = new DateTime(now.Year, now.Month, 1);
            dpNgayKetThucLuong.SelectedDate = dpNgayBatDauLuong.SelectedDate.Value.AddMonths(1).AddDays(-1);

            LoadingOverlay.Visibility = Visibility.Collapsed;
        }

        private async Task LoadNhanVienAsync()
        {
            try
            {
                // Táº­n dá»¥ng API cá»§a Module 4
                _allNhanVienList = (await httpClient.GetFromJsonAsync<List<NhanVienLookupDto>>("api/app/lichlamviec/all-nhanvien")) ?? new List<NhanVienLookupDto>();
                cmbNhanVienThuongPhat.ItemsSource = _allNhanVienList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i danh sÃ¡ch nhÃ¢n viÃªn: {ex.Message}", "Lá»—i API");
            }
        }

        #region === TAB 1: Báº¢NG CHáº¤M CÃ”NG ===

        private async Task LoadChamCongAsync(DateTime date)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            formChamCong.IsEnabled = false;
            _selectedChamCong = null;
            try
            {
                var data = (await httpClient.GetFromJsonAsync<List<ChamCongDto>>($"api/app/luong/chamcong?date={date:yyyy-MM-dd}")) ?? new List<ChamCongDto>();
                dgChamCong.ItemsSource = data;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i báº£ng cháº¥m cÃ´ng: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void DpNgayChamCong_SelectedDateChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dpNgayChamCong.SelectedDate.HasValue)
            {
                await LoadChamCongAsync(dpNgayChamCong.SelectedDate.Value);
            }
        }

        private void DgChamCong_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgChamCong.SelectedItem is ChamCongDto selected)
            {
                _selectedChamCong = selected;
                formChamCong.IsEnabled = true;
                lblChamCongNhanVien.Text = selected.HoTenNhanVien;
                // Hiá»ƒn thá»‹ HH:mm
                txtGioVaoMoi.Text = selected.GioVao?.ToString("HH:mm") ?? "";
                txtGioRaMoi.Text = selected.GioRa?.ToString("HH:mm") ?? "";
            }
            else
            {
                _selectedChamCong = null;
                formChamCong.IsEnabled = false;
                lblChamCongNhanVien.Text = "[Chá»n 1 má»¥c]";
                txtGioVaoMoi.Text = "";
                txtGioRaMoi.Text = "";
            }
        }

        // File: AppCafebookApi/View/quanly/pages/QuanLyLuongView.xaml.cs (Cáº¬P NHáº¬T HÃ€M)

        private async void BtnLuuChamCong_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedChamCong == null) return;

            DateTime ngayLam = _selectedChamCong.NgayLam;
            DateTime? gioVaoMoi = null;
            DateTime? gioRaMoi = null;

            try
            {
                if (!string.IsNullOrWhiteSpace(txtGioVaoMoi.Text))
                {
                    var tsVao = TimeSpan.ParseExact(txtGioVaoMoi.Text, @"hh\:mm", CultureInfo.InvariantCulture);
                    gioVaoMoi = ngayLam.Add(tsVao);
                }
                if (!string.IsNullOrWhiteSpace(txtGioRaMoi.Text))
                {
                    var tsRa = TimeSpan.ParseExact(txtGioRaMoi.Text, @"hh\:mm", CultureInfo.InvariantCulture);
                    gioRaMoi = ngayLam.Add(tsRa);
                    if (gioRaMoi < gioVaoMoi) gioRaMoi = gioRaMoi.Value.AddDays(1);
                }
            }
            catch
            {
                MessageBox.Show("Äá»‹nh dáº¡ng giá» khÃ´ng há»£p lá»‡. Vui lÃ²ng dÃ¹ng HH:mm (vÃ­ dá»¥: 08:00 hoáº·c 17:30).", "Lá»—i Ä‘á»‹nh dáº¡ng");
                return;
            }

            var dto = new ChamCongUpdateDto
            {
                IdChamCong = _selectedChamCong.IdChamCong,
                IdLichLamViec = _selectedChamCong.IdLichLamViec, // <-- THÃŠM DÃ’NG NÃ€Y
                GioVaoMoi = gioVaoMoi,
                GioRaMoi = gioRaMoi
            };

            // ============== XÃ“A Bá» ÄOáº N CODE GÃ‚Y Lá»–I ==============
            // if (dto.IdChamCong == 0)
            // {
            //     MessageBox.Show("Lá»—i: KhÃ´ng thá»ƒ cáº­p nháº­t thá»§ cÃ´ng cho nhÃ¢n viÃªn chÆ°a cháº¥m cÃ´ng láº§n nÃ o. (TÃ­nh nÄƒng nÃ y cáº§n Ä‘Æ°á»£c nÃ¢ng cáº¥p API)", "Lá»—i");
            //     return;
            // }
            // =======================================================

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                // (Logic gá»i API giá»¯ nguyÃªn)
                var response = await httpClient.PutAsJsonAsync($"api/app/luong/chamcong", dto);
                if (response.IsSuccessStatusCode)
                {
                    await LoadChamCongAsync(dpNgayChamCong.SelectedDate.Value);
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion

        #region === TAB 2: THÆ¯á»NG/PHáº T ===

        private async Task LoadThuongPhatAsync(int idNhanVien)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            formThuongPhat.IsEnabled = true;
            try
            {
                _currentThuongPhatList = (await httpClient.GetFromJsonAsync<List<PhieuThuongPhatDto>>($"api/app/thuongphat/pending/{idNhanVien}")) ?? new List<PhieuThuongPhatDto>();
                dgThuongPhat.ItemsSource = _currentThuongPhatList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i danh sÃ¡ch thÆ°á»Ÿng/pháº¡t: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void CmbNhanVienThuongPhat_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (cmbNhanVienThuongPhat.SelectedValue is int idNhanVien)
            {
                await LoadThuongPhatAsync(idNhanVien);
            }
            else
            {
                dgThuongPhat.ItemsSource = null;
                formThuongPhat.IsEnabled = false;
            }
        }

        private async void BtnThemThuongPhat_Click(object sender, RoutedEventArgs e)
        {
            if (cmbNhanVienThuongPhat.SelectedValue == null)
            {
                MessageBox.Show("Vui lÃ²ng chá»n nhÃ¢n viÃªn.", "Lá»—i"); return;
            }
            if (!decimal.TryParse(txtSoTien.Text, out var soTien) || soTien == 0)
            {
                MessageBox.Show("Sá»‘ tiá»n khÃ´ng há»£p lá»‡. DÃ¹ng sá»‘ Ã¢m (-) cho khoáº£n pháº¡t.", "Lá»—i"); return;
            }
            if (string.IsNullOrWhiteSpace(txtLyDoThuongPhat.Text))
            {
                MessageBox.Show("Vui lÃ²ng nháº­p lÃ½ do.", "Lá»—i"); return;
            }

            var dto = new PhieuThuongPhatCreateDto
            {
                IdNhanVien = (int)cmbNhanVienThuongPhat.SelectedValue,
                IdNguoiTao = AuthService.CurrentUser?.IdNhanVien ?? 0,
                SoTien = soTien,
                LyDo = txtLyDoThuongPhat.Text
            };

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/thuongphat", dto);
                if (response.IsSuccessStatusCode)
                {
                    txtSoTien.Text = "";
                    txtLyDoThuongPhat.Text = "";
                    await LoadThuongPhatAsync(dto.IdNhanVien);
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXoaThuongPhat_Click(object sender, RoutedEventArgs e)
        {
            if ((sender as Button)?.DataContext is not PhieuThuongPhatDto item) return;

            var result = MessageBox.Show($"Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a khoáº£n [ {item.SoTien:N0} - {item.LyDo} ] ?", "XÃ¡c nháº­n", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/thuongphat/{item.IdPhieuThuongPhat}");
                if (response.IsSuccessStatusCode)
                {
                    await LoadThuongPhatAsync(item.IdNhanVien);
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "KhÃ´ng thá»ƒ xÃ³a");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion

        #region === TAB 3: TÃNH & CHá»T LÆ¯Æ NG ===

        private async void BtnTinhLuong_Click(object sender, RoutedEventArgs e)
        {
            if (dpNgayBatDauLuong.SelectedDate == null || dpNgayKetThucLuong.SelectedDate == null)
            {
                MessageBox.Show("Vui lÃ²ng chá»n NgÃ y Báº¯t Äáº§u vÃ  Káº¿t ThÃºc.", "Lá»—i"); return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            btnChotLuong.IsEnabled = false;
            try
            {
                var sDate = dpNgayBatDauLuong.SelectedDate.Value;
                var eDate = dpNgayKetThucLuong.SelectedDate.Value;

                var url = $"api/app/luong/calculate?startDate={sDate:yyyy-MM-dd}&endDate={eDate:yyyy-MM-dd}";
                _currentBangKeList = (await httpClient.GetFromJsonAsync<List<LuongBangKeDto>>(url)) ?? new List<LuongBangKeDto>();

                dgBangKeLuong.ItemsSource = _currentBangKeList;
                if (_currentBangKeList.Any())
                {
                    btnChotLuong.IsEnabled = true;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i tÃ­nh lÆ°Æ¡ng: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnChotLuong_Click(object sender, RoutedEventArgs e)
        {
            if (_currentBangKeList == null || !_currentBangKeList.Any())
            {
                MessageBox.Show("KhÃ´ng cÃ³ dá»¯ liá»‡u lÆ°Æ¡ng Ä‘á»ƒ chá»‘t. Vui lÃ²ng nháº¥n 'TÃ­nh LÆ°Æ¡ng' trÆ°á»›c.", "Lá»—i"); return;
            }
            if (dpNgayBatDauLuong.SelectedDate == null)
            {
                MessageBox.Show("NgÃ y báº¯t Ä‘áº§u khÃ´ng há»£p lá»‡.", "Lá»—i"); return;
            }

            int thang = dpNgayBatDauLuong.SelectedDate.Value.Month;
            int nam = dpNgayBatDauLuong.SelectedDate.Value.Year;

            var result = MessageBox.Show($"Báº¡n cÃ³ cháº¯c muá»‘n CHá»T LÆ¯Æ NG cho ThÃ¡ng {thang}/{nam}?\n\nSau khi chá»‘t sáº½ khÃ´ng thá»ƒ hoÃ n tÃ¡c.", "XÃ¡c nháº­n Chá»‘t LÆ°Æ¡ng", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;

            var dto = new LuongFinalizeDto
            {
                Thang = thang,
                Nam = nam,
                IdNguoiChot = AuthService.CurrentUser?.IdNhanVien ?? 0,
                DanhSachBangKe = _currentBangKeList
            };

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/luong/finalize", dto);
                var message = await response.Content.ReadAsStringAsync(); // Äá»c message dÃ¹ thÃ nh cÃ´ng hay tháº¥t báº¡i

                if (response.IsSuccessStatusCode)
                {
                    // Äá»c message thÃ nh cÃ´ng tá»« JSON
                    var successObj = System.Text.Json.JsonSerializer.Deserialize<dynamic>(message);
                    MessageBox.Show(successObj.GetProperty("message").GetString(), "Chá»‘t LÆ°Æ¡ng ThÃ nh CÃ´ng", MessageBoxButton.OK, MessageBoxImage.Information);

                    // Reset
                    _currentBangKeList = new List<LuongBangKeDto>();
                    dgBangKeLuong.ItemsSource = null;
                    btnChotLuong.IsEnabled = false;

                    // Táº£i láº¡i Tab 2 (vÃ¬ cÃ¡c phiáº¿u Ä‘Ã£ Ä‘Æ°á»£c gÃ¡n)
                    if (cmbNhanVienThuongPhat.SelectedValue is int idNhanVien)
                    {
                        await LoadThuongPhatAsync(idNhanVien);
                    }
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {message}", "Lá»—i Chá»‘t LÆ°Æ¡ng");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion
        /*
        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }*/
        private void BtnGoToBaoCao_Click(object sender, RoutedEventArgs e)
        {
                this.NavigationService.Navigate(new BaoCaoNhanSuView());
        }

        private void BtnGoToPhatLuong_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService.Navigate(new QuanLyPhatLuongView());
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyNguyenLieuView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyNguyenLieuView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyNguyenLieuView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quáº£n lÃ½ NguyÃªn Liá»‡u" FontFamily="Segoe UI" Loaded="Page_Loaded"
      Background="#FFF8E1">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>

        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconSettings">M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M12,22C11.6,22 11.2,21.9 10.8,21.7L9.1,20.9C5.1,19.3 2,15.2 2,10.9V5L12,2L22,5V10.9C22,15.2 18.9,19.3 14.9,20.9L13.2,21.7C12.8,21.9 12.4,22 12,22Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Quáº£n lÃ½ NguyÃªn Liá»‡u" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="350"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Margin="10,0,15,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Text="Danh sÃ¡ch NguyÃªn liá»‡u" Style="{StaticResource HeaderTextBlock}"/>
                        <DataGrid Grid.Row="1" x:Name="dgNguyenLieu" AutoGenerateColumns="False" IsReadOnly="True" 
                                  SelectionMode="Single" SelectionChanged="DgNguyenLieu_SelectionChanged" 
                                  BorderThickness="0" RowHeaderWidth="0">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ID" Binding="{Binding IdNguyenLieu}" Width="50"/>
                                <DataGridTextColumn Header="TÃªn NguyÃªn Liá»‡u" Binding="{Binding TenNguyenLieu}" Width="*"/>
                                <DataGridTextColumn Header="ÄVT CÆ¡ báº£n" Binding="{Binding DonViTinh}" Width="100"/>
                                <DataGridTextColumn Header="Tá»“n Kho" Binding="{Binding TonKho, StringFormat=N2}" Width="100"/>
                                <DataGridTextColumn Header="NgÆ°á»¡ng Cáº£nh bÃ¡o" Binding="{Binding TonKhoToiThieu, StringFormat=N2}" Width="120"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>

                <Border Grid.Column="1" Margin="0,0,10,10" Style="{StaticResource CardBorder}">
                    <StackPanel>
                        <TextBlock Text="ThÃ´ng tin NguyÃªn liá»‡u" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,15"/>

                        <TextBlock Text="TÃªn nguyÃªn liá»‡u:" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtTenNL_crud" Margin="0,0,0,10"/>

                        <TextBlock Text="ÄÆ¡n vá»‹ tÃ­nh cÆ¡ báº£n (Ä‘á»ƒ tá»“n kho):" Margin="0,0,0,5"/>
                        <ComboBox x:Name="cmbDonViTinh_crud" Margin="0,0,0,10" IsEditable="True">
                            <ComboBoxItem Content="kg"/>
                            <ComboBoxItem Content="lÃ­t"/>
                            <ComboBoxItem Content="cÃ¡i"/>
                            <ComboBoxItem Content="quáº£"/>
                            <ComboBoxItem Content="chai"/>
                            <ComboBoxItem Content="há»™p"/>
                            <ComboBoxItem Content="gram"/>
                            <ComboBoxItem Content="ml"/>
                        </ComboBox>

                        <TextBlock Text="NgÆ°á»¡ng cáº£nh bÃ¡o háº¿t hÃ ng:" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtNguongCanhBao_crud" Margin="0,0,0,15"/>

                        <Grid Height="40">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Button x:Name="btnLamMoiNL" Grid.Column="0" ToolTip="LÃ m má»›i" Click="BtnLamMoiNL_Click" Background="Transparent" BorderThickness="0">
                                <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="22" Height="22"/>
                            </Button>
                            <Button x:Name="btnThemNL" Grid.Column="1" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionGreenBrush}" Click="BtnThemNL_Click" Margin="10,0,5,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconAdd}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="ThÃªm" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                            <Button x:Name="btnLuuNL" Grid.Column="2" Style="{StaticResource PrimaryButton}" Click="BtnLuuNL_Click" Margin="5,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconSave}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="LÆ°u" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                            <Button x:Name="btnXoaNL" Grid.Column="3" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionRedBrush}" Click="BtnXoaNL_Click" Margin="5,0,0,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconDelete}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="XÃ³a" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </Grid>

                        <Button x:Name="btnQuanLyDVT" 
                                Style="{StaticResource PrimaryButton}" 
                                Background="{StaticResource ActionBlueBrush}" 
                                Click="BtnQuanLyDVT_Click" 
                                Margin="0,15,0,0">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconSettings}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="Quáº£n lÃ½ ÄÆ¡n Vá»‹ TÃ­nh (gram, ml...)" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>

                    </StackPanel>
                </Border>
            </Grid>

            <Button x:Name="btnQuayLai" Grid.Row="2" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" Margin="10,0,0,10"
                    Click="BtnQuayLai_Click">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                    <TextBlock Text="Quay láº¡i Tá»“n Kho" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Äang táº£i..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyNguyenLieuView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using System.Globalization;

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyNguyenLieuView : Page
    {
        private static readonly HttpClient httpClient;
        private List<NguyenLieuCrudDto> _nguyenLieuList = new List<NguyenLieuCrudDto>();

        static QuanLyNguyenLieuView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyNguyenLieuView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadDataGridAsync();
            ResetNguyenLieuForm();
        }

        private async Task LoadDataGridAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                _nguyenLieuList = (await httpClient.GetFromJsonAsync<List<NguyenLieuCrudDto>>("api/app/nguyenlieu/all")) ?? new List<NguyenLieuCrudDto>();
                dgNguyenLieu.ItemsSource = _nguyenLieuList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i nguyÃªn liá»‡u: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void ResetNguyenLieuForm()
        {
            dgNguyenLieu.SelectedItem = null;
            txtTenNL_crud.Text = "";
            cmbDonViTinh_crud.Text = "kg";
            txtNguongCanhBao_crud.Text = "0";
            btnThemNL.IsEnabled = true;
            btnLuuNL.IsEnabled = false;
            btnXoaNL.IsEnabled = false;
        }

        private void DgNguyenLieu_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgNguyenLieu.SelectedItem is NguyenLieuCrudDto selected)
            {
                txtTenNL_crud.Text = selected.TenNguyenLieu;
                cmbDonViTinh_crud.Text = selected.DonViTinh;
                txtNguongCanhBao_crud.Text = selected.TonKhoToiThieu.ToString(CultureInfo.InvariantCulture);
                btnThemNL.IsEnabled = false;
                btnLuuNL.IsEnabled = true;
                btnXoaNL.IsEnabled = true;
            }
            else
            {
                ResetNguyenLieuForm();
            }
        }

        private async void BtnThemNL_Click(object sender, RoutedEventArgs e)
        {
            await SaveNguyenLieuAsync(isCreating: true);
        }

        private async void BtnLuuNL_Click(object sender, RoutedEventArgs e)
        {
            await SaveNguyenLieuAsync(isCreating: false);
        }

        private async Task SaveNguyenLieuAsync(bool isCreating)
        {
            var dto = new NguyenLieuUpdateRequestDto
            {
                TenNguyenLieu = txtTenNL_crud.Text,
                DonViTinh = cmbDonViTinh_crud.Text,
                TonKhoToiThieu = decimal.TryParse(txtNguongCanhBao_crud.Text, NumberStyles.Any, CultureInfo.InvariantCulture, out var n) ? n : 0
            };

            if (string.IsNullOrWhiteSpace(dto.TenNguyenLieu) || string.IsNullOrWhiteSpace(dto.DonViTinh))
            {
                MessageBox.Show("TÃªn vÃ  ÄÆ¡n vá»‹ tÃ­nh lÃ  báº¯t buá»™c.", "Lá»—i"); return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                HttpResponseMessage response;
                if (isCreating)
                {
                    response = await httpClient.PostAsJsonAsync("api/app/nguyenlieu", dto);
                }
                else
                {
                    int id = (dgNguyenLieu.SelectedItem as NguyenLieuCrudDto)?.IdNguyenLieu ?? 0;
                    response = await httpClient.PutAsJsonAsync($"api/app/nguyenlieu/{id}", dto);
                }

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("LÆ°u thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadDataGridAsync();
                    ResetNguyenLieuForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXoaNL_Click(object sender, RoutedEventArgs e)
        {
            if (dgNguyenLieu.SelectedItem is not NguyenLieuCrudDto selected) return;

            if (MessageBox.Show($"Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a '{selected.TenNguyenLieu}'?", "XÃ¡c nháº­n", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.No)
                return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/nguyenlieu/{selected.IdNguyenLieu}");
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("XÃ³a thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadDataGridAsync();
                    ResetNguyenLieuForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "KhÃ´ng thá»ƒ xÃ³a");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnLamMoiNL_Click(object sender, RoutedEventArgs e)
        {
            ResetNguyenLieuForm();
        }

        // NÃºt Ä‘iá»u hÆ°á»›ng
        private void BtnQuanLyDVT_Click(object sender, RoutedEventArgs e)
        {
            // Äiá»u hÆ°á»›ng Ä‘áº¿n trang ÄÆ¡n Vá»‹ Chuyá»ƒn Äá»•i 
            this.NavigationService?.Navigate(new QuanLyDonViChuyenDoiView());
        }

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyNhaCungCapView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyNhaCungCapView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyNhaCungCapView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quáº£n lÃ½ NhÃ  Cung Cáº¥p" FontFamily="Segoe UI" Loaded="Page_Loaded"
      Background="#FFF8E1">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>

        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>

        <Geometry x:Key="IconExcel">M21.17 3.25Q21.5 3.25 21.76 3.5 22 3.74 22 4.08V19.92Q22 20.26 21.76 20.5 21.5 20.75 21.17 20.75H7.83Q7.5 20.75 7.24 20.5 7 20.26 7 19.92V4.08Q7 3.74 7.24 3.5 7.5 3.25 7.83 3.25H21.17M13.83 18.25V15.7H11.5V14.05L13.72 10.63H11.6V9H16.33V10.65L14.12 14.07H16.25V15.7H13.83V18.25M6.25 15.5Q6.25 15.15 6.04 14.88 5.82 14.6 5.5 14.6H3.5Q3.18 14.6 2.96 14.88 2.75 15.15 2.75 15.5V17.5Q2.75 17.82 2.96 18.1 3.18 18.38 3.5 18.38H5.5Q5.82 18.38 6.04 18.1 6.25 17.82 6.25 17.5V15.5M6.25 9.5Q6.25 9.18 6.04 8.9 5.82 8.62 5.5 8.62H3.5Q3.18 8.62 2.96 8.9 2.75 9.18 2.75 9.5V11.5Q2.75 11.82 2.96 12.1 3.18 12.38 3.5 12.38H5.5Q5.82 12.38 6.04 12.1 6.25 11.82 6.25 11.5V9.5Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Quáº£n lÃ½ NhÃ  Cung Cáº¥p" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="350"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Margin="10,0,15,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Text="Danh sÃ¡ch NhÃ  Cung Cáº¥p" Style="{StaticResource HeaderTextBlock}"/>

                        <DataGrid Grid.Row="1" x:Name="dgNhaCungCap" AutoGenerateColumns="False" IsReadOnly="True" 
                                  SelectionMode="Single" SelectionChanged="DgNhaCungCap_SelectionChanged" 
                                  BorderThickness="0" RowHeaderWidth="0">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ID" Binding="{Binding IdNhaCungCap}" Width="50"/>
                                <DataGridTextColumn Header="TÃªn NhÃ  Cung Cáº¥p" Binding="{Binding TenNhaCungCap}" Width="*"/>
                                <DataGridTextColumn Header="Sá»‘ Ä‘iá»‡n thoáº¡i" Binding="{Binding SoDienThoai}" Width="150"/>
                                <DataGridTextColumn Header="Äá»‹a chá»‰" Binding="{Binding DiaChi}" Width="200"/>
                            </DataGrid.Columns>
                        </DataGrid>

                        <Button Grid.Row="2" x:Name="btnExportExcel" HorizontalAlignment="Left" Margin="0,15,0,0"
                                Style="{StaticResource PrimaryButton}" Background="#00724C"
                                Click="BtnExportExcel_Click">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconExcel}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="Xuáº¥t Excel" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </Grid>
                </Border>

                <Border Grid.Column="1" Margin="0,0,10,10" Style="{StaticResource CardBorder}">
                    <StackPanel>
                        <TextBlock Text="ThÃ´ng tin NhÃ  Cung cáº¥p" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,15"/>
                        <TextBlock Text="TÃªn nhÃ  cung cáº¥p:" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtTenNCC" Margin="0,0,0,10"/>
                        <TextBlock Text="Sá»‘ Ä‘iá»‡n thoáº¡i:" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtSdtNCC" Margin="0,0,0,10"/>
                        <TextBlock Text="Äá»‹a chá»‰:" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtDiaChiNCC" Margin="0,0,0,10" Height="60" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"/>
                        <TextBlock Text="Email:" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtEmailNCC" Margin="0,0,0,15"/>
                        <Grid Height="40">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Button x:Name="btnLamMoiNCC" Grid.Column="0" ToolTip="LÃ m má»›i" Click="BtnLamMoiNCC_Click" Background="Transparent" BorderThickness="0">
                                <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="22" Height="22"/>
                            </Button>
                            <Button x:Name="btnThemNCC" Grid.Column="1" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionGreenBrush}" Click="BtnThemNCC_Click" Margin="10,0,5,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconAdd}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="ThÃªm" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                            <Button x:Name="btnLuuNCC" Grid.Column="2" Style="{StaticResource PrimaryButton}" Click="BtnLuuNCC_Click" Margin="5,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconSave}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="LÆ°u" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                            <Button x:Name="btnXoaNCC" Grid.Column="3" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionRedBrush}" Click="BtnXoaNCC_Click" Margin="5,0,0,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconDelete}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="XÃ³a" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </Grid>
                    </StackPanel>
                </Border>
            </Grid>

            <Button x:Name="btnQuayLai" Grid.Row="2" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" Margin="10,0,0,10"
                    Click="BtnQuayLai_Click">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                    <TextBlock Text="Quay láº¡i Tá»“n Kho" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Äang táº£i..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyNhaCungCapView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
// THÃŠM Má»šI: Using cho Excel
using Microsoft.Win32;
using System.IO;
using OfficeOpenXml;
using OfficeOpenXml.Table;

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyNhaCungCapView : Page
    {
        private static readonly HttpClient httpClient;
        private List<NhaCungCapDto> _nhaCungCapList = new List<NhaCungCapDto>();

        static QuanLyNhaCungCapView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyNhaCungCapView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadNhaCungCapAsync();
            ResetNhaCungCapForm();
        }

        private async Task LoadNhaCungCapAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                _nhaCungCapList = (await httpClient.GetFromJsonAsync<List<NhaCungCapDto>>("api/app/kho/nhacungcap")) ?? new List<NhaCungCapDto>();
                dgNhaCungCap.ItemsSource = _nhaCungCapList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i nhÃ  cung cáº¥p: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void ResetNhaCungCapForm()
        {
            dgNhaCungCap.SelectedItem = null;
            txtTenNCC.Text = "";
            txtSdtNCC.Text = "";
            txtDiaChiNCC.Text = "";
            txtEmailNCC.Text = "";
            btnThemNCC.IsEnabled = true;
            btnLuuNCC.IsEnabled = false;
            btnXoaNCC.IsEnabled = false;
        }

        private void DgNhaCungCap_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgNhaCungCap.SelectedItem is NhaCungCapDto selected)
            {
                txtTenNCC.Text = selected.TenNhaCungCap;
                txtSdtNCC.Text = selected.SoDienThoai;
                txtDiaChiNCC.Text = selected.DiaChi;
                txtEmailNCC.Text = selected.Email;
                btnThemNCC.IsEnabled = false;
                btnLuuNCC.IsEnabled = true;
                btnXoaNCC.IsEnabled = true;
            }
            else
            {
                ResetNhaCungCapForm();
            }
        }

        private async void BtnThemNCC_Click(object sender, RoutedEventArgs e)
        {
            await SaveNhaCungCapAsync(isCreating: true);
        }

        private async void BtnLuuNCC_Click(object sender, RoutedEventArgs e)
        {
            await SaveNhaCungCapAsync(isCreating: false);
        }

        private async Task SaveNhaCungCapAsync(bool isCreating)
        {
            if (string.IsNullOrWhiteSpace(txtTenNCC.Text))
            {
                MessageBox.Show("TÃªn nhÃ  cung cáº¥p lÃ  báº¯t buá»™c.", "Lá»—i"); return;
            }

            var dto = new NhaCungCapDto
            {
                TenNhaCungCap = txtTenNCC.Text,
                SoDienThoai = txtSdtNCC.Text,
                DiaChi = txtDiaChiNCC.Text,
                Email = txtEmailNCC.Text
            };

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                HttpResponseMessage response;
                if (isCreating)
                {
                    response = await httpClient.PostAsJsonAsync("api/app/kho/nhacungcap", dto);
                }
                else
                {
                    int id = (dgNhaCungCap.SelectedItem as NhaCungCapDto)?.IdNhaCungCap ?? 0;
                    response = await httpClient.PutAsJsonAsync($"api/app/kho/nhacungcap/{id}", dto);
                }

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("LÆ°u thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadNhaCungCapAsync();
                    ResetNhaCungCapForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXoaNCC_Click(object sender, RoutedEventArgs e)
        {
            if (dgNhaCungCap.SelectedItem is not NhaCungCapDto selected) return;

            if (MessageBox.Show($"Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a '{selected.TenNhaCungCap}'?", "XÃ¡c nháº­n", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.No)
                return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/kho/nhacungcap/{selected.IdNhaCungCap}");
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("XÃ³a thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadNhaCungCapAsync();
                    ResetNhaCungCapForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "KhÃ´ng thá»ƒ xÃ³a");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnLamMoiNCC_Click(object sender, RoutedEventArgs e)
        {
            ResetNhaCungCapForm();
        }

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService?.CanGoBack == true)
            {
                this.NavigationService.GoBack();
            }
        }

        // --- THÃŠM Má»šI: HÃ€M XUáº¤T EXCEL ---
        private void BtnExportExcel_Click(object sender, RoutedEventArgs e)
        {
            if (_nhaCungCapList == null || !_nhaCungCapList.Any())
            {
                MessageBox.Show("KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t.", "ThÃ´ng bÃ¡o");
                return;
            }

            var sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                FileName = $"DSNhaCungCap_{DateTime.Now:yyyyMMdd_HHmm}.xlsx"
            };

            if (sfd.ShowDialog() == true)
            {
                try
                {
                    ExcelPackage.License.SetNonCommercialPersonal("CafeBook");
                    using (var package = new ExcelPackage(new FileInfo(sfd.FileName)))
                    {
                        var ws = package.Workbook.Worksheets.Add("DanhSachNCC");
                        ws.Cells["A1"].Value = "Danh sÃ¡ch NhÃ  Cung Cáº¥p";
                        ws.Cells["A1:D1"].Merge = true;
                        ws.Cells["A1"].Style.Font.Bold = true;
                        ws.Cells["A1"].Style.Font.Size = 16;

                        // Táº£i dá»¯ liá»‡u vÃ o, tá»± Ä‘á»™ng nháº­n Header
                        ws.Cells["A3"].LoadFromCollection(_nhaCungCapList, true, TableStyles.Medium9);
                        ws.Cells[ws.Dimension.Address].AutoFitColumns();

                        package.Save();
                    }
                    MessageBox.Show("Xuáº¥t Excel thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Lá»—i khi xuáº¥t Excel: {ex.Message}\n\nÄáº£m báº£o file khÃ´ng Ä‘ang Ä‘Æ°á»£c má»Ÿ.", "Lá»—i");
                }
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyNhanVienView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyNhanVienView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyNhanVienView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quáº£n lÃ½ NhÃ¢n viÃªn"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="BackgroundHoverBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="StatusRedBrush" Color="#FFEBEE"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="SubtleWhiteTextBrush" Color="#BCAAA4"/>
        <SolidColorBrush x:Key="HoverBrownBrush" Color="#8D6E63"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        
        <Geometry x:Key="IconCalendar">M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconUpload">M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z</Geometry>
        <Geometry x:Key="IconRole">M12,1L9,4H6C4.9,4 4,4.9 4,6V18C4,19.1 4.9,20 6,20H18C19.1,20 20,19.1 20,18V6C20,4.9 19.1,4 18,4H15L12,1M12,6C13.66,6 15,7.34 15,9C15,10.66 13.66,12 12,12C10.34,12 9,10.66 9,9C9,7.34 10.34,6 12,6M16,14C17.67,14 20,15.33 20,17V18H4V17C4,15.33 6.33,14 8,14H16Z</Geometry>
        <Geometry x:Key="IconExcel">M21.17 3.25Q21.5 3.25 21.76 3.5 22 3.74 22 4.08V19.92Q22 20.26 21.76 20.5 21.5 20.75 21.17 20.75H7.83Q7.5 20.75 7.24 20.5 7 20.26 7 19.92V4.08Q7 3.74 7.24 3.5 7.5 3.25 7.83 3.25H21.17M13.83 18.25V15.7H11.5V14.05L13.72 10.63H11.6V9H16.33V10.65L14.12 14.07H16.25V15.7H13.83V18.25M6.25 15.5Q6.25 15.15 6.04 14.88 5.82 14.6 5.5 14.6H3.5Q3.18 14.6 2.96 14.88 2.75 15.15 2.75 15.5V17.5Q2.75 17.82 2.96 18.1 3.18 18.38 3.5 18.38H5.5Q5.82 18.38 6.04 18.1 6.25 17.82 6.25 17.5V15.5M6.25 9.5Q6.25 9.18 6.04 8.9 5.82 8.62 5.5 8.62H3.5Q3.18 8.62 2.96 8.9 2.75 9.18 2.75 9.5V11.5Q2.75 11.82 2.96 12.1 3.18 12.38 3.5 12.38H5.5Q5.82 12.38 6.04 12.1 6.25 11.82 6.25 11.5V9.5Z</Geometry>
        <Geometry x:Key="IconLeave">M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.89 20.1,3 19,3M19,19H5V10H19V19M10,14V12H7V14H10M14,14V12H11V14H14M18,14V12H15V14H18Z</Geometry>
        <Geometry x:Key="IconCustomer">M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5,5.61 6.79,4 9,4C11.21,4 13,5.61 13,8C13,10.39 11.21,12 9,12C6.79,12 5,10.39 5,8M9,13C11.67,13 17,14.34 17,17V20H1V17C1,14.34 6.33,13 9,13M17.75,10.5A3.75,3.75 0 0,0 21.5,6.75A3.75,3.75 0 0,0 17.75,3A3.75,3.75 0 0,0 14,6.75A3.75,3.75 0 0,0 17.75,10.5M14,17.25C14,16.5 15.17,16 16.5,16C17.83,16 19,16.5 19,17.25V18H14V17.25Z</Geometry>
        <Geometry x:Key="IconPromotion">M12.41,2.58C12.03,2.2 11.53,2 11,2H4C2.9,2 2,2.9 2,4V11C2,11.53 2.2,12.03 2.59,12.41L12.42,22.24C12.81,22.63 13.44,22.63 13.83,22.24L22.24,13.82C22.63,13.43 22.63,12.8 22.24,12.41L12.41,2.58M7,7A1.5,1.5 0 0,1 5.5,8.5A1.5,1.5 0 0,1 4,7A1.5,1.5 0 0,1 5.5,5.5A1.5,1.5 0 0,1 7,7Z</Geometry>
        <Geometry x:Key="IconPayroll">M20,6H4V4H20V6M20,10H4V8H20V10M18,14H6V12H18V14M18,18H6V16H18V18M19,20H5C3.89,20 3,19.1 3,18V3C3,1.89 3.89,1 5,1H19C20.1,1 21,1.89 21,3V18C21,19.1 20.1,20 19,20Z</Geometry>
        <Geometry x:Key="IconSettings">M12,15.5C10.07,15.5 8.5,13.93 8.5,12C8.5,10.07 10.07,8.5 12,8.5C13.93,8.5 15.5,10.07 15.5,12C15.5,13.93 13.93,15.5 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z</Geometry>
        <Geometry x:Key="IconReport">M18,17H16V15H18M18,13H16V11H18M18,9H16V7H18M14,17H12V15H14M14,13H12V11H14M14,9H12V7H14M10,17H8V15H10M10,13H8V11H10M10,9H8V7H10M6,17H4V15H6M6,13H4V11H6M6,9H4V7H6M20,19V3H17V1H7V3H4V19C4,20.11 4.9,21 6,21H18C19.1,21 20,20.11 20,19M18,5H6V19H18V5Z</Geometry>
        
        <Style x:Key="ActionButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,10"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="4" Padding="{TemplateBinding Padding}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.1" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.8"/>
                                <Setter TargetName="border" Property="Effect" Value="{x:Null}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="DeleteButton" TargetType="Button" BasedOn="{StaticResource ActionButton}">
            <Setter Property="Background" Value="{StaticResource ErrorBrush}"/>
        </Style>
        <Style x:Key="MaterialIconButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="20">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BackgroundHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="Label">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,15,0,5"/>
        </Style>
        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="PasswordBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>

        <Style x:Key="SearchTextBox" TargetType="TextBox" BasedOn="{StaticResource MaterialInput}">
            <Setter Property="Padding" Value="8,8"/>
        </Style>
        <Style x:Key="FilterComboBox" TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}">
            <Setter Property="Padding" Value="8,8"/>
        </Style>
        <Style x:Key="AvatarImage" TargetType="Image">
            <Setter Property="Width" Value="100"/>
            <Setter Property="Height" Value="100"/>
            <Setter Property="Stretch" Value="UniformToFill"/>
        </Style>

        <Style x:Key="EmployeeDataGridRowStyle" TargetType="DataGridRow">
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding TrangThaiLamViec}" Value="Nghá»‰ viá»‡c">
                    <Setter Property="Background" Value="{StaticResource StatusRedBrush}"/>
                    <Setter Property="Foreground" Value="{StaticResource ErrorBrush}"/>
                    <Setter Property="FontStyle" Value="Italic"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="NavToggleButton" TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource SubtleWhiteTextBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Padding" Value="20,12"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="border" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" CornerRadius="5" Margin="8,2">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Border x:Name="indicator" Width="4" Height="20" Background="Transparent" CornerRadius="2" VerticalAlignment="Center" Margin="-20,0,10,0"/>
                                <Viewbox Grid.Column="0" Width="23" Height="23" Margin="0,0,15,0">
                                    <Path Data="{Binding Path=Tag, RelativeSource={RelativeSource TemplatedParent}}" Fill="{TemplateBinding Foreground}" Stretch="Uniform" VerticalAlignment="Center"/>
                                </Viewbox>
                                <ContentPresenter Grid.Column="1" HorizontalAlignment="Left" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource HoverBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                                <Setter TargetName="indicator" Property="Background" Value="{StaticResource AccentOrangeBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="420"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Background="White" CornerRadius="8" Margin="10">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
            </Border.Effect>

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <WrapPanel Grid.Row="0" Orientation="Horizontal" Margin="10,5,10,10">
                    <TextBlock Text="TÃ¬m kiáº¿m:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                    <TextBox x:Name="txtSearchNhanVien" Width="200" Style="{StaticResource SearchTextBox}" TextChanged="Filter_Changed"/>

                    <TextBlock Text="Vai trÃ²:" VerticalAlignment="Center" Margin="15,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                    <ComboBox x:Name="cmbFilterVaiTro" Width="180" DisplayMemberPath="Ten" SelectedValuePath="Id"
                              Style="{StaticResource FilterComboBox}" SelectionChanged="Filter_Changed"/>

                    <Button x:Name="btnGoToRoles" ToolTip="Quáº£n lÃ½ Vai trÃ² &amp; PhÃ¢n quyá»n" Style="{StaticResource MaterialIconButton}" 
                            Click="BtnGoToRoles_Click" Margin="5,0,0,0">
                        <Path Data="{StaticResource IconRole}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                    </Button>
                    <Button x:Name="btnGoToLichLamViec" ToolTip="Quáº£n lÃ½ Lá»‹ch LÃ m Viá»‡c" Style="{StaticResource MaterialIconButton}" 
                            Click="BtnGoToLichLamViec_Click" Margin="5,0,0,0">
                        <Path Data="{StaticResource IconCalendar}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                    </Button>

                    <Button x:Name="btnGoToDonXinNghi" ToolTip="Quáº£n lÃ½ ÄÆ¡n Nghá»‰" Style="{StaticResource MaterialIconButton}" 
                            Click="BtnGoToDonXinNghi_Click" Margin="5,0,0,0">
                        <Path Data="{StaticResource IconLeave}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                    </Button>
                    <Button x:Name="btnGoToBaoCao" ToolTip="BÃ¡o CÃ¡o NhÃ¢n Sá»±" Style="{StaticResource MaterialIconButton}" 
                            Click="BtnGoToBaoCao_Click" Margin="5,0,0,0">
                        <Path Data="{StaticResource IconReport}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                    </Button>
                    <Button x:Name="btnGoToHieuSuat" ToolTip="BÃ¡o CÃ¡o Hiá»‡u Suáº¥t NhÃ¢n ViÃªn" Style="{StaticResource MaterialIconButton}" 
                            Click="BtnGoToHieuSuat_Click" Margin="5,0,0,0">
                        <Path Data="{StaticResource IconPayroll}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                    </Button>
                    <Button x:Name="btnGoToCaiDat" ToolTip="Cáº¥u HÃ¬nh NhÃ¢n Sá»±" Style="{StaticResource MaterialIconButton}" 
                            Click="BtnGoToCaiDat_Click" Margin="5,0,0,0">
                        <Path Data="{StaticResource IconSettings}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                    </Button>
                </WrapPanel>

                <DataGrid Grid.Row="1" x:Name="dgNhanVien" AutoGenerateColumns="False" IsReadOnly="True"
                          SelectionMode="Single" SelectionChanged="DgNhanVien_SelectionChanged"
                          BorderThickness="0" RowHeaderWidth="0" Margin="10,0,10,10"
                          RowStyle="{StaticResource EmployeeDataGridRowStyle}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="ID" Binding="{Binding IdNhanVien}" Width="50"/>
                        <DataGridTextColumn Header="Há» TÃªn" Binding="{Binding HoTen}" Width="*"/>
                        <DataGridTextColumn Header="Vai TrÃ²" Binding="{Binding TenVaiTro}" Width="120"/>
                        <DataGridTextColumn Header="LÆ°Æ¡ng/Giá»" Binding="{Binding LuongCoBan, StringFormat=N0}" Width="100"/>
                        <DataGridTextColumn Header="Tráº¡ng thÃ¡i" Binding="{Binding TrangThaiLamViec}" Width="100"/>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Border>

        <Border Grid.Column="1" Background="White" CornerRadius="8" Padding="25" Margin="0,10,10,10">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
            </Border.Effect>
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock x:Name="lblFormTitle" Text="ThÃ´ng tin NhÃ¢n viÃªn" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,5,0,15" VerticalAlignment="Center"/>
                        <Button x:Name="btnLamMoiForm" Grid.Column="1" ToolTip="Táº¡o nhÃ¢n viÃªn má»›i" Click="BtnLamMoiForm_Click" 
                                Style="{StaticResource MaterialIconButton}">
                            <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                        </Button>
                    </Grid>

                    <Grid x:Name="formChiTiet" IsEnabled="False">
                        <StackPanel>
                            <Grid Margin="0,0,0,15">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <Border Grid.Column="0" BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="1" Width="100" Height="100" Background="{StaticResource SubtleGrayBrush}" CornerRadius="50">
                                    <Ellipse>
                                        <Ellipse.Fill>
                                            <ImageBrush x:Name="AvatarPreview" Stretch="UniformToFill"/>
                                        </Ellipse.Fill>
                                    </Ellipse>
                                </Border>

                                <StackPanel Grid.Column="1" VerticalAlignment="Bottom" Orientation="Horizontal" Margin="15,0,0,0">
                                    <Button x:Name="btnChonAnh" 
                                            Style="{StaticResource ActionButton}" Background="#F5F5F5" 
                                            BorderBrush="#E0E0E0" Foreground="{StaticResource DarkBrownBrush}"
                                            Click="BtnChonAnh_Click">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconUpload}" Fill="{StaticResource DarkBrownBrush}" Width="20" Height="20" Margin="0,0,8,0"/>
                                            <TextBlock Text="Chá»n áº£nh bÃ¬a" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>

                                    <Button x:Name="btnXoaAnh" 
                                            Style="{StaticResource DeleteButton}" 
                                            Margin="10,0,0,0" 
                                            Click="BtnXoaAnh_Click">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconDelete}" Fill="White" Width="18" Height="18" Margin="0,0,8,0"/>
                                            <TextBlock Text="XÃ³a áº£nh" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                            </Grid>

                            <Label Content="Há» TÃªn (*)"/>
                            <TextBox x:Name="txtHoTen"/>

                            <Label Content="TÃªn ÄÄƒng Nháº­p (*)"/>
                            <TextBox x:Name="txtTenDangNhap"/>

                            <Label x:Name="lblMatKhau" Content="Máº­t Kháº©u (*)"/>
                            <PasswordBox x:Name="txtMatKhau"/>
                            <TextBlock x:Name="lblMatKhauInfo" Text="Bá» trá»‘ng náº¿u khÃ´ng muá»‘n Ä‘á»•i máº­t kháº©u" FontSize="11" FontStyle="Italic" Foreground="Gray" Margin="0,5,0,0" Visibility="Collapsed"/>

                            <Label Content="Vai TrÃ² (*)"/>
                            <ComboBox x:Name="cmbVaiTro" DisplayMemberPath="Ten" SelectedValuePath="Id"/>

                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0" Margin="0,0,10,0">
                                    <Label Content="LÆ°Æ¡ng/Giá» (*)"/>
                                    <TextBox x:Name="txtLuongCoBan"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1" Margin="10,0,0,0">
                                    <Label Content="Tráº¡ng thÃ¡i (*)"/>
                                    <ComboBox x:Name="cmbTrangThai">
                                        <ComboBoxItem Content="Äang lÃ m viá»‡c"/>
                                        <ComboBoxItem Content="Nghá»‰ viá»‡c"/>
                                    </ComboBox>
                                </StackPanel>
                            </Grid>

                            <Label Content="NgÃ y VÃ o LÃ m"/>
                            <DatePicker x:Name="dpNgayVaoLam"/>

                            <Label Content="Sá»‘ Äiá»‡n Thoáº¡i"/>
                            <TextBox x:Name="txtSoDienThoai"/>

                            <Label Content="Email"/>
                            <TextBox x:Name="txtEmail"/>

                            <Label Content="Äá»‹a Chá»‰"/>
                            <TextBox x:Name="txtDiaChi" Height="80" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"/>
                        </StackPanel>
                    </Grid>

                    <StackPanel x:Name="panelActions" Orientation="Horizontal" Margin="0,25,0,0">
                        <Button x:Name="btnThem" Click="BtnThem_Click" Margin="0,0,10,0" Style="{StaticResource ActionButton}" Background="{StaticResource SuccessBrush}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconAdd}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="ThÃªm NhÃ¢n ViÃªn" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        <Button x:Name="btnLuu" Click="BtnLuu_Click" Margin="0,0,10,0" Style="{StaticResource ActionButton}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconSave}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="LÆ°u Thay Äá»•i" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        <Button x:Name="btnXoa" Click="BtnXoa_Click" Margin="0,0,10,0" Style="{StaticResource DeleteButton}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconDelete}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="XÃ³a" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <Border x:Name="LoadingOverlay" Background="#80FFFFFF" Visibility="Collapsed"
                            Grid.RowSpan="2" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                        <TextBlock Text="Äang xá»­ lÃ½..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
                    </Border>
                </StackPanel>
            </ScrollViewer>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyNhanVienView.xaml.cs
// Táº­p tin: AppCafebookApi/View/quanly/pages/QuanLyNhanVienView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using Microsoft.Win32;
using System.IO;
using AppCafebookApi.Services;
using CafebookModel.Utils;
using System.Globalization;
using AppCafebookApi.View.common;
using System.Net.Http.Headers; // <-- THÃŠM

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyNhanVienView : Page
    {
        private static readonly HttpClient httpClient;
        private List<NhanVienGridDto> _allNhanVienList = new List<NhanVienGridDto>();
        private List<FilterLookupDto> _vaiTroList = new List<FilterLookupDto>();

        // Sá»¬A: DÃ¹ng DTO chi tiáº¿t (Detail) Ä‘á»ƒ nháº­n URL
        private NhanVienDetailDto? _selectedNhanVien = null;

        // Sá»¬A: Thay tháº¿ Base64 báº±ng Ä‘Æ°á»ng dáº«n file
        private string? _currentAvatarFilePath = null;
        private bool _deleteAvatarRequest = false;

        static QuanLyNhanVienView()
        {
            httpClient = new HttpClient
            {
                // Sá»¬A: Äá»•i port vá» 5166 (theo launchSettings.json cá»§a báº¡n)
                BaseAddress = new Uri("http://127.0.0.1:5166")
            };
        }

        public QuanLyNhanVienView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadFiltersAsync();
            await LoadDataGridAsync();
            ResetForm();
        }

        #region Táº£i Dá»¯ Liá»‡u & Lá»c

        private async Task LoadFiltersAsync()
        {
            try
            {
                var filters = await httpClient.GetFromJsonAsync<NhanSuFiltersDto>("api/app/nhanvien/filters");
                if (filters != null)
                {
                    _vaiTroList = filters.VaiTros;
                    var filterVaiTro = new List<FilterLookupDto>(_vaiTroList);
                    filterVaiTro.Insert(0, new FilterLookupDto { Id = 0, Ten = "Táº¥t cáº£ Vai trÃ²" });
                    cmbFilterVaiTro.ItemsSource = filterVaiTro;
                    cmbFilterVaiTro.SelectedValue = 0;
                    cmbVaiTro.ItemsSource = _vaiTroList;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i bá»™ lá»c: {ex.Message}", "Lá»—i API");
            }
        }

        private async Task LoadDataGridAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            string searchText = txtSearchNhanVien.Text;
            int vaiTroId = (int)(cmbFilterVaiTro.SelectedValue ?? 0);

            try
            {
                var url = $"api/app/nhanvien/search?searchText={Uri.EscapeDataString(searchText)}&vaiTroId={vaiTroId}";
                _allNhanVienList = (await httpClient.GetFromJsonAsync<List<NhanVienGridDto>>(url)) ?? new List<NhanVienGridDto>();
                dgNhanVien.ItemsSource = _allNhanVienList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i danh sÃ¡ch nhÃ¢n viÃªn: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void Filter_Changed(object sender, RoutedEventArgs e)
        {
            if (this.IsLoaded)
                await LoadDataGridAsync();
        }

        // Sá»¬A: ThÃªm sá»± kiá»‡n cho XAML
        private void Filter_Changed(object sender, TextChangedEventArgs e)
        {
            if (this.IsLoaded)
                _ = LoadDataGridAsync();
        }

        #endregion

        #region Form & CRUD

        private void ResetForm()
        {
            _selectedNhanVien = null;
            _currentAvatarFilePath = null;
            _deleteAvatarRequest = false;

            dgNhanVien.SelectedItem = null;
            formChiTiet.IsEnabled = true;
            panelActions.Visibility = Visibility.Visible;

            btnThem.Visibility = Visibility.Visible;
            btnLuu.Visibility = Visibility.Collapsed;
            btnXoa.Visibility = Visibility.Collapsed;

            lblFormTitle.Text = "ThÃªm NhÃ¢n ViÃªn Má»›i";
            lblMatKhau.Visibility = Visibility.Visible;
            txtMatKhau.Visibility = Visibility.Visible;
            lblMatKhauInfo.Visibility = Visibility.Collapsed;

            txtHoTen.Text = "";
            txtTenDangNhap.Text = "";
            txtMatKhau.Password = "";
            cmbVaiTro.SelectedIndex = -1;
            txtLuongCoBan.Text = "0";
            cmbTrangThai.SelectedIndex = 0;
            dpNgayVaoLam.SelectedDate = DateTime.Today;
            txtSoDienThoai.Text = "";
            txtEmail.Text = "";
            txtDiaChi.Text = "";

            AvatarPreview.ImageSource = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultAvatar);
        }

        private async void DgNhanVien_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgNhanVien.SelectedItem is not NhanVienGridDto selected)
            {
                ResetForm();
                return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                // Sá»¬A: Gá»i NhanVienDetailDto
                _selectedNhanVien = await httpClient.GetFromJsonAsync<NhanVienDetailDto>($"api/app/nhanvien/details/{selected.IdNhanVien}");
                if (_selectedNhanVien == null)
                {
                    ResetForm();
                    return;
                }

                _currentAvatarFilePath = null;
                _deleteAvatarRequest = false;

                formChiTiet.IsEnabled = true;
                panelActions.Visibility = Visibility.Visible;
                btnThem.Visibility = Visibility.Collapsed;
                btnLuu.Visibility = Visibility.Visible;
                btnXoa.Visibility = Visibility.Visible;

                lblFormTitle.Text = "Cáº­p nháº­t NhÃ¢n ViÃªn";
                lblMatKhau.Visibility = Visibility.Collapsed;
                txtMatKhau.Visibility = Visibility.Collapsed;
                lblMatKhauInfo.Visibility = Visibility.Visible;
                txtMatKhau.Password = "";

                txtHoTen.Text = _selectedNhanVien.HoTen;
                txtTenDangNhap.Text = _selectedNhanVien.TenDangNhap;
                cmbVaiTro.SelectedValue = _selectedNhanVien.IdVaiTro;
                txtLuongCoBan.Text = _selectedNhanVien.LuongCoBan.ToString("F0");
                cmbTrangThai.Text = _selectedNhanVien.TrangThaiLamViec;
                dpNgayVaoLam.SelectedDate = _selectedNhanVien.NgayVaoLam;
                txtSoDienThoai.Text = _selectedNhanVien.SoDienThoai;
                txtEmail.Text = _selectedNhanVien.Email;
                txtDiaChi.Text = _selectedNhanVien.DiaChi;

                // Sá»¬A: Load áº£nh tá»« URL
                AvatarPreview.ImageSource = HinhAnhHelper.LoadImage(_selectedNhanVien.AnhDaiDienUrl, HinhAnhPaths.DefaultAvatar);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i chi tiáº¿t: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnLamMoiForm_Click(object sender, RoutedEventArgs e)
        {
            ResetForm();
        }

        private void BtnChonAnh_Click(object sender, RoutedEventArgs e)
        {
            var ofd = new OpenFileDialog { Filter = "Image files|*.png;*.jpg;*.jpeg", Title = "Chá»n Avatar" };
            if (ofd.ShowDialog() == true)
            {
                try
                {
                    // Sá»¬A: Chá»‰ lÆ°u Ä‘Æ°á»ng dáº«n file
                    _currentAvatarFilePath = ofd.FileName;
                    _deleteAvatarRequest = false;
                    AvatarPreview.ImageSource = HinhAnhHelper.LoadImage(_currentAvatarFilePath, HinhAnhPaths.DefaultAvatar);
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Lá»—i Ä‘á»c file áº£nh: {ex.Message}", "Lá»—i File");
                    _currentAvatarFilePath = null;
                    AvatarPreview.ImageSource = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultAvatar);
                }
            }
        }

        // Sá»¬A: ThÃªm hÃ m nÃ y (tá»« XAML cá»§a báº¡n)
        private void BtnXoaAnh_Click(object sender, RoutedEventArgs e)
        {
            _currentAvatarFilePath = null;
            _deleteAvatarRequest = true;
            AvatarPreview.ImageSource = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultAvatar);
        }

        private async void BtnThem_Click(object sender, RoutedEventArgs e)
        {
            await SaveNhanVienAsync(isCreating: true);
        }

        private async void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            await SaveNhanVienAsync(isCreating: false);
        }

        // Sá»¬A: DÃ¹ng MultipartFormDataContent
        private async Task SaveNhanVienAsync(bool isCreating)
        {
            // ... (validation) ...
            if (string.IsNullOrWhiteSpace(txtHoTen.Text) || string.IsNullOrWhiteSpace(txtTenDangNhap.Text))
            {
                MessageBox.Show("Há» tÃªn vÃ  TÃªn Ä‘Äƒng nháº­p lÃ  báº¯t buá»™c.", "Lá»—i"); return;
            }
            if (isCreating && string.IsNullOrWhiteSpace(txtMatKhau.Password))
            {
                MessageBox.Show("Máº­t kháº©u lÃ  báº¯t buá»™c khi táº¡o má»›i.", "Lá»—i"); return;
            }
            if (cmbVaiTro.SelectedValue == null)
            {
                MessageBox.Show("Vui lÃ²ng chá»n Vai trÃ².", "Lá»—i"); return;
            }

            // Sá»¬A: DÃ¹ng MultipartFormDataContent
            using var form = new MultipartFormDataContent();

            // 1. ThÃªm cÃ¡c trÆ°á»ng dá»¯ liá»‡u
            form.Add(new StringContent(txtHoTen.Text), "HoTen");
            form.Add(new StringContent(txtTenDangNhap.Text), "TenDangNhap");
            if (!string.IsNullOrWhiteSpace(txtMatKhau.Password))
                form.Add(new StringContent(txtMatKhau.Password), "MatKhau");

            form.Add(new StringContent(cmbVaiTro.SelectedValue.ToString()), "IdVaiTro");
            form.Add(new StringContent(decimal.TryParse(txtLuongCoBan.Text, out var l) ? l.ToString() : "0"), "LuongCoBan");
            form.Add(new StringContent((cmbTrangThai.SelectedItem as ComboBoxItem)?.Content.ToString() ?? "Äang lÃ m viá»‡c"), "TrangThaiLamViec");
            form.Add(new StringContent((dpNgayVaoLam.SelectedDate ?? DateTime.Today).ToString("o")), "NgayVaoLam"); // Gá»­i ISO 8601
            form.Add(new StringContent(txtSoDienThoai.Text ?? ""), "SoDienThoai");
            form.Add(new StringContent(txtEmail.Text ?? ""), "Email");
            form.Add(new StringContent(txtDiaChi.Text ?? ""), "DiaChi");

            if (!isCreating)
            {
                form.Add(new StringContent(_selectedNhanVien.IdNhanVien.ToString()), "IdNhanVien");
            }

            // 2. ThÃªm file
            if (!string.IsNullOrEmpty(_currentAvatarFilePath))
            {
                var fileStream = File.OpenRead(_currentAvatarFilePath);
                var streamContent = new StreamContent(fileStream);
                streamContent.Headers.ContentType = new MediaTypeHeaderValue("image/jpeg");
                form.Add(streamContent, "AnhDaiDienUpload", Path.GetFileName(_currentAvatarFilePath));
            }

            // 3. ThÃªm cá» XÃ³a
            if (_deleteAvatarRequest)
            {
                form.Add(new StringContent("true"), "XoaAnhDaiDien");
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                HttpResponseMessage response;
                if (isCreating)
                {
                    response = await httpClient.PostAsync("api/app/nhanvien", form);
                }
                else
                {
                    response = await httpClient.PutAsync($"api/app/nhanvien/{_selectedNhanVien.IdNhanVien}", form);
                }

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("LÆ°u thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadDataGridAsync();
                    ResetForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
                _currentAvatarFilePath = null;
                _deleteAvatarRequest = false;
            }
        }

        private async void BtnXoa_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedNhanVien == null) return;

            var result = MessageBox.Show($"Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a nhÃ¢n viÃªn '{_selectedNhanVien.HoTen}'?", "XÃ¡c nháº­n", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/nhanvien/{_selectedNhanVien.IdNhanVien}");
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("XÃ³a thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadDataGridAsync();
                    ResetForm();
                }
                else if (response.StatusCode == HttpStatusCode.Conflict)
                {
                    var error = await response.Content.ReadAsStringAsync();
                    var confirmDeactivate = MessageBox.Show($"{error}\n\nBáº¡n cÃ³ muá»‘n chuyá»ƒn tráº¡ng thÃ¡i nhÃ¢n viÃªn nÃ y thÃ nh 'Nghá»‰ viá»‡c' khÃ´ng?", "KhÃ´ng thá»ƒ xÃ³a", MessageBoxButton.YesNo, MessageBoxImage.Question);

                    if (confirmDeactivate == MessageBoxResult.Yes)
                    {
                        // Sá»¬A: Gá»­i JSON chuáº©n
                        var statusResponse = await httpClient.PutAsJsonAsync($"api/app/nhanvien/update-status/{_selectedNhanVien.IdNhanVien}", new { newStatus = "Nghá»‰ viá»‡c" });
                        if (statusResponse.IsSuccessStatusCode)
                        {
                            MessageBox.Show("ÄÃ£ cáº­p nháº­t tráº¡ng thÃ¡i thÃ nh 'Nghá»‰ viá»‡c'.", "ThÃ nh cÃ´ng");
                            await LoadDataGridAsync();
                            ResetForm();
                        }
                        else
                        {
                            MessageBox.Show("Lá»—i khi cáº­p nháº­t tráº¡ng thÃ¡i.", "Lá»—i API");
                        }
                    }
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion

        #region Navigation
        // ... (ToÃ n bá»™ region Navigation giá»¯ nguyÃªn) ...
        private void BtnGoToRoles_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new QuanLyVaiTroView());
        }
        private void BtnGoToBaoCao_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new BaoCaoNhanSuView());
        }
        private void BtnGoToLichLamViec_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new QuanLyLichLamViecView());
        }
        private void BtnGoToDonXinNghi_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new QuanLyDonXinNghiView());
        }/*
        private void BtnGoToLuong_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new QuanLyLuongView());
        }*/
        private void BtnGoToCaiDat_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new CaiDatNhanSuView());
        }
        private void BtnGoToHieuSuat_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new BaoCaoHieuSuatNhanVientPreviewWindow());
        }
        #endregion
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyNhapKhoView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyNhapKhoView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyNhapKhoView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quáº£n lÃ½ Nháº­p Kho" FontFamily="Segoe UI" Loaded="Page_Loaded"
      Background="#FFF8E1">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>

        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Quáº£n lÃ½ Nháº­p Kho" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*"/>
                    <ColumnDefinition Width="3*"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Margin="10,0,15,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Text="Danh sÃ¡ch Phiáº¿u nháº­p" Style="{StaticResource HeaderTextBlock}"/>

                        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,10">
                            <TextBlock Text="Tá»«:" VerticalAlignment="Center"/>
                            <DatePicker x:Name="dpTuNgay_Phieu" Width="120" Margin="5,0,0,0"/>
                            <TextBlock Text="Äáº¿n:" VerticalAlignment="Center" Margin="10,0,5,0"/>
                            <DatePicker x:Name="dpDenNgay_Phieu" Width="120" Margin="0,0,10,0"/>
                            <Button x:Name="btnLocPhieu" Content="Lá»c" Style="{StaticResource PrimaryButton}" Padding="10,5" Click="BtnLocPhieu_Click" Width="50"/>
                        </StackPanel>

                        <DataGrid Grid.Row="2" x:Name="dgPhieuNhap" AutoGenerateColumns="False" IsReadOnly="True" 
                                  SelectionMode="Single" SelectionChanged="DgPhieuNhap_SelectionChanged" 
                                  BorderThickness="0" RowHeaderWidth="0">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ID" Binding="{Binding IdPhieuNhapKho}" Width="40"/>
                                <DataGridTextColumn Header="NgÃ y" Binding="{Binding NgayNhap, StringFormat='dd/MM/yyyy'}" Width="100"/>
                                <DataGridTextColumn Header="NCC" Binding="{Binding TenNhaCungCap}" Width="*"/>
                                <DataGridTextColumn Header="Tá»•ng tiá»n" Binding="{Binding TongTien, StringFormat=N0}" Width="100"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>

                <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto" Margin="0,0,10,10">
                    <StackPanel>
                        <Border Style="{StaticResource CardBorder}">
                            <StackPanel>
                                <Grid Margin="0,0,0,15">
                                    <TextBlock Text="ThÃ´ng tin Phiáº¿u nháº­p" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" VerticalAlignment="Center" />
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                        <Button x:Name="btnTaoPhieuMoi" Style="{StaticResource PrimaryButton}" Click="BtnTaoPhieuMoi_Click" Padding="10,8">
                                            <StackPanel Orientation="Horizontal">
                                                <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                                    <Path Data="{StaticResource IconNew}" Fill="White"/>
                                                </Viewbox>
                                                <TextBlock Text="Táº¡o Phiáº¿u Má»›i" VerticalAlignment="Center" Margin="0,1,0,0"/>
                                            </StackPanel>
                                        </Button>
                                    </StackPanel>
                                </Grid>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="NgÃ y nháº­p:" VerticalAlignment="Center" Margin="0,5,15,5"/>
                                    <DatePicker Grid.Row="0" Grid.Column="1" x:Name="dpNgayNhap" Margin="0,5"/>
                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="NhÃ  cung cáº¥p:" VerticalAlignment="Center" Margin="0,5,15,5"/>
                                    <ComboBox Grid.Row="1" Grid.Column="1" x:Name="cmbNhaCungCap_PhieuNhap" Margin="0,5" DisplayMemberPath="TenNhaCungCap" SelectedValuePath="IdNhaCungCap"/>
                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Tá»•ng tiá»n:" VerticalAlignment="Center" Margin="0,5,15,5"/>
                                    <TextBlock Grid.Row="2" Grid.Column="1" x:Name="lblTongTien" Margin="0,5" FontSize="16" FontWeight="Bold" Foreground="{StaticResource ActionRedBrush}" Text="0 VND"/>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <Border Style="{StaticResource CardBorder}" Margin="0,15,0,0">
                            <StackPanel>
                                <TextBlock Text="Chi tiáº¿t NguyÃªn liá»‡u" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,10"/>

                                <Grid x:Name="panelNhapChiTiet" Margin="0,0,0,10" IsEnabled="False">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="80"/>
                                        <ColumnDefinition Width="100"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <ComboBox Grid.Column="0" x:Name="cmbNguyenLieu_PhieuNhap" DisplayMemberPath="TenNguyenLieu" SelectedValuePath="IdNguyenLieu" VerticalContentAlignment="Center"
                                              Margin="0,0,10,0" ToolTip="Chá»n NguyÃªn Liá»‡u"/>
                                    <TextBox Grid.Column="1" x:Name="txtSoLuongNL" Margin="0,0,10,0" ToolTip="Sá»‘ lÆ°á»£ng" VerticalContentAlignment="Center"/>
                                    <TextBox Grid.Column="2" x:Name="txtDonGiaNL" Margin="0,0,10,0" ToolTip="ÄÆ¡n giÃ¡ (theo ÄVT cÆ¡ báº£n)" VerticalContentAlignment="Center"/>
                                    <Button Grid.Column="3" x:Name="btnThemVaoPhieu" Style="{StaticResource PrimaryButton}" Click="BtnThemVaoPhieu_Click" Padding="8"
                                            Background="{StaticResource ActionBlueBrush}">
                                        <Viewbox Width="16" Height="16">
                                            <Path Data="{StaticResource IconAdd}" Fill="White"/>
                                        </Viewbox>
                                    </Button>
                                </Grid>

                                <DataGrid x:Name="dgChiTietPhieuNhap" AutoGenerateColumns="False" MaxHeight="250"
                                          CanUserAddRows="False" CanUserDeleteRows="True" IsReadOnly="True"
                                          SelectionChanged="DgChiTietPhieuNhap_SelectionChanged">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="TÃªn NguyÃªn liá»‡u" Binding="{Binding TenNguyenLieu}" Width="*" IsReadOnly="True"/>
                                        <DataGridTextColumn Header="Sá»‘ lÆ°á»£ng" Binding="{Binding SoLuongNhap, StringFormat=N2}" Width="80"/>
                                        <DataGridTextColumn Header="ÄÆ¡n giÃ¡" Binding="{Binding DonGiaNhap, StringFormat=N0}" Width="100"/>
                                        <DataGridTextColumn Header="ThÃ nh tiá»n" Binding="{Binding ThanhTien, StringFormat=N0}" Width="100" IsReadOnly="True"/>
                                    </DataGrid.Columns>
                                </DataGrid>

                                <Button x:Name="btnLuuPhieuNhap" Margin="0,15,0,0" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionGreenBrush}" Click="BtnLuuPhieuNhap_Click">
                                    <StackPanel Orientation="Horizontal">
                                        <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                            <Path Data="{StaticResource IconSave}" Fill="White"/>
                                        </Viewbox>
                                        <TextBlock Text="LÆ°u Phiáº¿u Nháº­p" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </Grid>

            <Button x:Name="btnQuayLai" Grid.Row="2" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" Margin="10,0,0,10"
                    Click="BtnQuayLai_Click">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="16" Height="16" Margin="0,0,5,0"/>
                    <TextBlock Text="Quay láº¡i Tá»“n Kho" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Äang táº£i..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyNhapKhoView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using System.Collections.ObjectModel;
using System.Globalization;
using AppCafebookApi.Services;

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyNhapKhoView : Page
    {
        private static readonly HttpClient httpClient;

        private List<PhieuNhapDto> _phieuNhapList = new List<PhieuNhapDto>();
        // Sá»¬A Äá»”I: DÃ¹ng ChiTietPhieuNhapCreateDto vÃ¬ nÃ³ cÃ³ IdNguyenLieu
        private ObservableCollection<ChiTietPhieuNhapCreateDto> _chiTietPhieuNhapList = new ObservableCollection<ChiTietPhieuNhapCreateDto>();
        private PhieuNhapDto? _selectedPhieuNhap = null;
        private bool _isCreatingPhieuNhap = false;

        private List<NhaCungCapDto> _nhaCungCapList = new List<NhaCungCapDto>();
        private List<NguyenLieuCrudDto> _nguyenLieuList = new List<NguyenLieuCrudDto>();

        static QuanLyNhapKhoView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyNhapKhoView()
        {
            InitializeComponent();
            dpTuNgay_Phieu.SelectedDate = DateTime.Today.AddDays(-30);
            dpDenNgay_Phieu.SelectedDate = DateTime.Today;
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            await LoadNguyenLieuAsync();
            await LoadNhaCungCapAsync();
            await LoadPhieuNhapAsync();
            ResetPhieuNhapForm();
            LoadingOverlay.Visibility = Visibility.Collapsed;
        }

        #region Táº£i Dá»¯ Liá»‡u

        private async Task LoadNguyenLieuAsync()
        {
            try
            {
                _nguyenLieuList = (await httpClient.GetFromJsonAsync<List<NguyenLieuCrudDto>>("api/app/kho/nguyenlieu")) ?? new List<NguyenLieuCrudDto>();

                var nlList = _nguyenLieuList.Select(nl => new { nl.IdNguyenLieu, TenNguyenLieu = $"{nl.TenNguyenLieu} ({nl.DonViTinh})" }).ToList();
                nlList.Insert(0, new { IdNguyenLieu = 0, TenNguyenLieu = "-- Chá»n NguyÃªn Liá»‡u --" });

                // GÃ¡n cho ComboBox trong Form nháº­p
                cmbNguyenLieu_PhieuNhap.ItemsSource = nlList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i nguyÃªn liá»‡u: {ex.Message}", "Lá»—i API");
            }
        }

        private async Task LoadNhaCungCapAsync()
        {
            try
            {
                _nhaCungCapList = (await httpClient.GetFromJsonAsync<List<NhaCungCapDto>>("api/app/kho/nhacungcap")) ?? new List<NhaCungCapDto>();

                var nccList = _nhaCungCapList.Select(ncc => new { ncc.IdNhaCungCap, ncc.TenNhaCungCap }).ToList();
                nccList.Insert(0, new { IdNhaCungCap = 0, TenNhaCungCap = "Nháº­p láº» (KhÃ´ng NCC)" });
                cmbNhaCungCap_PhieuNhap.ItemsSource = nccList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i nhÃ  cung cáº¥p: {ex.Message}", "Lá»—i API");
            }
        }

        private async Task LoadPhieuNhapAsync()
        {
            DateTime? start = dpTuNgay_Phieu.SelectedDate;
            DateTime? end = dpDenNgay_Phieu.SelectedDate;

            try
            {
                string url = "api/app/kho/phieunhap";
                if (start.HasValue && end.HasValue)
                {
                    url += $"?startDate={start.Value:yyyy-MM-dd}&endDate={end.Value:yyyy-MM-dd}";
                }

                _phieuNhapList = (await httpClient.GetFromJsonAsync<List<PhieuNhapDto>>(url)) ?? new List<PhieuNhapDto>();
                dgPhieuNhap.ItemsSource = _phieuNhapList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i phiáº¿u nháº­p: {ex.Message}", "Lá»—i API");
            }
        }

        #endregion

        #region TAB 3: NHáº¬P KHO

        private void ResetPhieuNhapForm()
        {
            _selectedPhieuNhap = null;
            _isCreatingPhieuNhap = false;
            dgPhieuNhap.SelectedItem = null;

            dpNgayNhap.SelectedDate = DateTime.Today;
            cmbNhaCungCap_PhieuNhap.SelectedValue = 0;
            lblTongTien.Text = "0 VND";

            _chiTietPhieuNhapList.Clear();
            dgChiTietPhieuNhap.ItemsSource = null; // XÃ³a ItemsSource

            btnLuuPhieuNhap.IsEnabled = false;
            panelNhapChiTiet.IsEnabled = false; // Táº¯t panel nháº­p
        }

        private void BtnTaoPhieuMoi_Click(object sender, RoutedEventArgs e)
        {
            ResetPhieuNhapForm();
            _isCreatingPhieuNhap = true;
            btnLuuPhieuNhap.IsEnabled = true;
            panelNhapChiTiet.IsEnabled = true; // Báº­t panel nháº­p

            // GÃ¡n ItemsSource lÃ  list rá»—ng
            dgChiTietPhieuNhap.ItemsSource = _chiTietPhieuNhapList;
        }

        private async void BtnLocPhieu_Click(object sender, RoutedEventArgs e)
        {
            await LoadPhieuNhapAsync();
        }

        private async void DgPhieuNhap_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgPhieuNhap.SelectedItem is not PhieuNhapDto selected)
            {
                ResetPhieuNhapForm();
                return;
            }

            _selectedPhieuNhap = selected;
            _isCreatingPhieuNhap = false;
            btnLuuPhieuNhap.IsEnabled = false;
            panelNhapChiTiet.IsEnabled = false; // Táº¯t panel nháº­p

            try
            {
                var details = await httpClient.GetFromJsonAsync<List<ChiTietPhieuNhapDto>>($"api/app/kho/phieunhap/{selected.IdPhieuNhapKho}");

                // Chuyá»ƒn Ä‘á»•i DTO chi tiáº¿t sang DTO táº¡o (Ä‘á»ƒ DataGrid hiá»ƒn thá»‹)
                _chiTietPhieuNhapList = new ObservableCollection<ChiTietPhieuNhapCreateDto>(
                    details?.Select(d => new ChiTietPhieuNhapCreateDto
                    {
                        IdNguyenLieu = d.IdNguyenLieu,
                        SoLuongNhap = d.SoLuongNhap,
                        DonGiaNhap = d.DonGiaNhap
                    }) ?? new List<ChiTietPhieuNhapCreateDto>()
                );

                dgChiTietPhieuNhap.ItemsSource = _chiTietPhieuNhapList;
                CalculateTotal(); // TÃ­nh tá»•ng

                dpNgayNhap.SelectedDate = selected.NgayNhap;
                var ncc = _nhaCungCapList.FirstOrDefault(n => n.TenNhaCungCap == selected.TenNhaCungCap);
                cmbNhaCungCap_PhieuNhap.SelectedValue = ncc?.IdNhaCungCap ?? 0;

                lblTongTien.Text = selected.TongTien.ToString("N0") + " VND";
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i chi tiáº¿t phiáº¿u: {ex.Message}", "Lá»—i API");
            }
        }

        // --- Sá»¬A Lá»–I: Thay tháº¿ BtnThemDong vÃ  CellEditEnding ---

        private void BtnThemVaoPhieu_Click(object sender, RoutedEventArgs e)
        {
            if (!_isCreatingPhieuNhap) return;

            if (cmbNguyenLieu_PhieuNhap.SelectedValue == null || (int)cmbNguyenLieu_PhieuNhap.SelectedValue == 0)
            {
                MessageBox.Show("Vui lÃ²ng chá»n má»™t nguyÃªn liá»‡u.", "Lá»—i"); return;
            }
            if (!decimal.TryParse(txtSoLuongNL.Text, NumberStyles.Any, CultureInfo.InvariantCulture, out decimal soLuong) || soLuong <= 0)
            {
                MessageBox.Show("Sá»‘ lÆ°á»£ng pháº£i lÃ  sá»‘ dÆ°Æ¡ng.", "Lá»—i"); return;
            }
            if (!decimal.TryParse(txtDonGiaNL.Text, NumberStyles.Any, CultureInfo.InvariantCulture, out decimal donGia) || donGia < 0)
            {
                MessageBox.Show("ÄÆ¡n giÃ¡ khÃ´ng há»£p lá»‡.", "Lá»—i"); return;
            }

            int idNguyenLieu = (int)cmbNguyenLieu_PhieuNhap.SelectedValue;

            // Kiá»ƒm tra xem Ä‘Ã£ tá»“n táº¡i chÆ°a
            var existingItem = _chiTietPhieuNhapList.FirstOrDefault(i => i.IdNguyenLieu == idNguyenLieu);
            if (existingItem != null)
            {
                // Cáº­p nháº­t
                existingItem.SoLuongNhap += soLuong;
                existingItem.DonGiaNhap = donGia; // Cáº­p nháº­t Ä‘Æ¡n giÃ¡ má»›i
            }
            else
            {
                // ThÃªm má»›i
                _chiTietPhieuNhapList.Add(new ChiTietPhieuNhapCreateDto
                {
                    IdNguyenLieu = idNguyenLieu,
                    SoLuongNhap = soLuong,
                    DonGiaNhap = donGia
                });
            }

            RefreshDataGrid();
            ResetInputFields();
        }

        private void DgChiTietPhieuNhap_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            // Cho phÃ©p xÃ³a khi Ä‘ang táº¡o phiáº¿u
            if (_isCreatingPhieuNhap && dgChiTietPhieuNhap.SelectedItem is ChiTietPhieuNhapCreateDto selectedItem)
            {
                if (MessageBox.Show($"Báº¡n cÃ³ muá»‘n xÃ³a '{selectedItem.IdNguyenLieu}' khá»i phiáº¿u nháº­p?", "XÃ¡c nháº­n", MessageBoxButton.YesNo) == MessageBoxResult.Yes)
                {
                    _chiTietPhieuNhapList.Remove(selectedItem);
                    RefreshDataGrid();
                }
                dgChiTietPhieuNhap.SelectedItem = null;
            }
        }

        private void DgChiTietPhieuNhap_CellEditEnding(object sender, DataGridCellEditEndingEventArgs e)
        {
            // DÃ¹ng Dispatcher.BeginInvoke Ä‘á»ƒ Refresh SAU KHI edit káº¿t thÃºc
            Dispatcher.BeginInvoke(new Action(() =>
            {
                // TÃ­nh toÃ¡n láº¡i tá»•ng tiá»n tá»« danh sÃ¡ch nguá»“n
                decimal tongTien = 0;
                foreach (var item in _chiTietPhieuNhapList)
                {
                    tongTien += (item.SoLuongNhap * item.DonGiaNhap);
                }
                lblTongTien.Text = tongTien.ToString("N0") + " VND";

                // Náº¡p láº¡i DataGrid (cÃ¡ch an toÃ n nháº¥t)
                RefreshDataGrid();

            }), System.Windows.Threading.DispatcherPriority.ContextIdle);
        }

        private void ResetInputFields()
        {
            cmbNguyenLieu_PhieuNhap.SelectedValue = 0;
            txtSoLuongNL.Text = "";
            txtDonGiaNL.Text = "";
        }

        // HÃ m nÃ y pháº£i tá»“n táº¡i trong QuanLyNhapKhoView.xaml.cs
        private void RefreshDataGrid()
        {
            dgChiTietPhieuNhap.ItemsSource = null;

            // GÃ¡n láº¡i tÃªn (vÃ¬ DTO create khÃ´ng cÃ³ tÃªn)
            var displayList = _chiTietPhieuNhapList.Select(ct => new
            {
                ct.IdNguyenLieu,
                // ThÃªm kiá»ƒm tra null cho _nguyenLieuList
                TenNguyenLieu = _nguyenLieuList?.FirstOrDefault(nl => nl.IdNguyenLieu == ct.IdNguyenLieu)?.TenNguyenLieu ?? "...",
                ct.SoLuongNhap,
                ct.DonGiaNhap,
                ThanhTien = ct.SoLuongNhap * ct.DonGiaNhap
            }).ToList();

            dgChiTietPhieuNhap.ItemsSource = displayList;
            CalculateTotal();
        }

        private void CalculateTotal()
        {
            decimal tongTien = _chiTietPhieuNhapList.Sum(item => item.SoLuongNhap * item.DonGiaNhap);
            lblTongTien.Text = tongTien.ToString("N0") + " VND";
        }

        // --- Háº¾T PHáº¦N Sá»¬A Lá»–I ---


        private async void BtnLuuPhieuNhap_Click(object sender, RoutedEventArgs e)
        {
            if (!_isCreatingPhieuNhap || _chiTietPhieuNhapList.Count == 0)
            {
                MessageBox.Show("Vui lÃ²ng 'Táº¡o Phiáº¿u Má»›i' vÃ  'ThÃªm DÃ²ng' nguyÃªn liá»‡u trÆ°á»›c khi lÆ°u.", "Lá»—i");
                return;
            }
            if (AuthService.CurrentUser == null)
            {
                MessageBox.Show("Lá»—i phiÃªn Ä‘Äƒng nháº­p. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.", "Lá»—i");
                return;
            }

            var dto = new PhieuNhapCreateDto
            {
                IdNhanVien = AuthService.CurrentUser.IdNhanVien,
                IdNhaCungCap = (int)cmbNhaCungCap_PhieuNhap.SelectedValue > 0 ? (int)cmbNhaCungCap_PhieuNhap.SelectedValue : null,
                NgayNhap = dpNgayNhap.SelectedDate ?? DateTime.Today,
                GhiChu = null,
                ChiTiet = _chiTietPhieuNhapList.Where(ct => ct.IdNguyenLieu > 0 && ct.SoLuongNhap > 0)
                                               .Select(ct => new ChiTietPhieuNhapCreateDto
                                               {
                                                   IdNguyenLieu = ct.IdNguyenLieu,
                                                   SoLuongNhap = ct.SoLuongNhap,
                                                   DonGiaNhap = ct.DonGiaNhap
                                               }).ToList()
            };

            if (!dto.ChiTiet.Any())
            {
                MessageBox.Show("Phiáº¿u nháº­p pháº£i cÃ³ Ã­t nháº¥t 1 nguyÃªn liá»‡u há»£p lá»‡.", "Lá»—i");
                return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/kho/phieunhap", dto);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("LÆ°u phiáº¿u nháº­p kho thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadPhieuNhapAsync(); // Táº£i láº¡i lÆ°á»›i phiáº¿u nháº­p
                    ResetPhieuNhapForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService?.CanGoBack == true)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyPhatLuongView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyPhatLuongView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyPhatLuongView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quáº£n lÃ½ PhÃ¡t LÆ°Æ¡ng"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" 
Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionOrangeBrush" Color="#FFA726"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="PrimaryBrown" Color="#6F4E37"/>
        <SolidColorBrush x:Key="AccentOrange" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" 
Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteText" Color="#FFFFFF"/>

        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>
        <Geometry x:Key="IconSearch">M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L21.5,20L20,21.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z</Geometry>
        <Geometry x:Key="IconView">M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" 
Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrown}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteText}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Height" 
Value="42"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                CornerRadius="21"
                                Background="{TemplateBinding 
Background}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="2" Color="#6F4E37" Opacity="0.3" 
BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource 
AccentOrange}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" 
Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                                <Setter TargetName="border" Property="Opacity" Value="0.7"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" 
Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" 
Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>

        <Style x:Key="IconDataGridButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="15">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="{StaticResource SubtleGrayBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
            <TextBlock Text="PhÃ¡t LÆ°Æ¡ng &amp; Phiáº¿u LÆ°Æ¡ng ÄÃ£ Chá»‘t" Style="{StaticResource HeaderTextBlock}" VerticalAlignment="Center" Margin="0,0,0,0"/>
        </StackPanel>

        <Border Grid.Row="1" Style="{StaticResource CardBorder}" Margin="0,0,0,15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <TextBlock Text="Lá»c theo ká»³:" VerticalAlignment="Center" FontWeight="SemiBold" Margin="0,0,15,0"/>

                <TextBlock Grid.Column="1" Text="ThÃ¡ng:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                <ComboBox Grid.Column="2" x:Name="cmbThang" Width="100"/>

                <TextBlock Grid.Column="3" Text="NÄƒm:" VerticalAlignment="Center" Margin="20,0,5,0"/>
                <ComboBox Grid.Column="4" x:Name="cmbNam" Width="100"/>

                <Button Grid.Column="5" x:Name="btnLoc" Style="{StaticResource PrimaryButton}" Click="BtnLoc_Click" HorizontalAlignment="Left" Margin="20,0,0,0" Width="100" Height="38" Padding="0">
                    <StackPanel Orientation="Horizontal">
                        <Path Data="{StaticResource IconSearch}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                        <TextBlock Text="Lá»c" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
            </Grid>
        </Border>

        <Border Grid.Row="2" Style="{StaticResource CardBorder}" Padding="0">
            <DataGrid x:Name="dgPhieuLuong" AutoGenerateColumns="False" IsReadOnly="True" 
                      SelectionMode="Single"
                      BorderThickness="0" RowHeaderWidth="0" 
                      Background="White"
                      RowStyle="{StaticResource {x:Type DataGridRow}}"
                      CellStyle="{StaticResource {x:Type DataGridCell}}"
                      ColumnHeaderStyle="{StaticResource {x:Type DataGridColumnHeader}}">

                <DataGrid.Columns>
                    <DataGridTextColumn Header="NhÃ¢n viÃªn" Binding="{Binding HoTenNhanVien}" Width="2*"/>
                    <DataGridTextColumn Header="Ká»³ LÆ°Æ¡ng" Width="Auto">
                        <DataGridTextColumn.Binding>
                            <MultiBinding StringFormat="{}{0}/{1}">
                                <Binding Path="Thang"/>
                                <Binding Path="Nam"/>
                            </MultiBinding>
                        </DataGridTextColumn.Binding>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="Tá»•ng Giá»" Binding="{Binding TongGioLam, StringFormat=F2}" Width="Auto"/>
                    <DataGridTextColumn Header="Thá»±c LÃ£nh" Binding="{Binding ThucLanh, StringFormat=N0}" Width="1.2*"/>
                    <DataGridTextColumn Header="NgÃ y Chá»‘t" Binding="{Binding NgayChot, StringFormat='dd/MM/yyyy HH:mm'}" Width="1.5*"/>

                    <DataGridTemplateColumn Header="Tráº¡ng ThÃ¡i" Width="1.2*">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding TrangThai}" FontWeight="SemiBold" VerticalAlignment="Center" HorizontalAlignment="Left" Margin="10,0,0,0">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding TrangThai}" Value="ÄÃ£ phÃ¡t">
                                                    <Setter Property="Foreground" Value="{StaticResource SuccessBrush}"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding TrangThai}" Value="ÄÃ£ chá»‘t">
                                                    <Setter Property="Foreground" Value="{StaticResource ActionOrangeBrush}"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTemplateColumn Header="Xem" Width="60">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Button x:Name="btnXemChiTiet" Style="{StaticResource IconDataGridButton}" ToolTip="Xem chi tiáº¿t &amp; PhÃ¡t lÆ°Æ¡ng" 
                                        Click="BtnXemChiTiet_Click">
                                    <Path Data="{StaticResource IconView}" Fill="{StaticResource ActionBlueBrush}" Width="23" Height="23"/>
                                </Button>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </Border>

        <Button x:Name="btnQuayLai" Grid.Row="3" 
                Style="{StaticResource BackButton}"
                HorizontalAlignment="Left" Margin="0,10,0,0"
                Click="BtnQuayLai_Click">
            <StackPanel Orientation="Horizontal">
                <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                <TextBlock Text="Quay láº¡i" VerticalAlignment="Center"/>
            </StackPanel>
        </Button>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Äang táº£i dá»¯ liá»‡u..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyPhatLuongView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using AppCafebookApi.Services; // Cáº§n cho AuthService
using AppCafebookApi.View.Common; // Cáº§n cho PhieuLuongPreviewWindow
using CafebookModel.Model.ModelApp; // Cáº§n cho DTOs

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyPhatLuongView : Page
    {
        private static readonly HttpClient httpClient;

        static QuanLyPhatLuongView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyPhatLuongView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await SetupFiltersAsync();
            await LoadDanhSachPhieuLuongAsync();
        }

        private Task SetupFiltersAsync()
        {
            // Setup ThÃ¡ng
            cmbThang.ItemsSource = Enumerable.Range(1, 12).Select(m => new { Value = m, Display = $"ThÃ¡ng {m}" });
            cmbThang.DisplayMemberPath = "Display";
            cmbThang.SelectedValuePath = "Value";
            cmbThang.SelectedValue = DateTime.Now.Month;

            // Setup NÄƒm
            int currentYear = DateTime.Now.Year;
            cmbNam.ItemsSource = Enumerable.Range(currentYear - 2, 5).Select(y => new { Value = y, Display = $"NÄƒm {y}" });
            cmbNam.DisplayMemberPath = "Display";
            cmbNam.SelectedValuePath = "Value";
            cmbNam.SelectedValue = currentYear;

            return Task.CompletedTask;
        }

        private async Task LoadDanhSachPhieuLuongAsync()
        {
            if (cmbThang.SelectedValue == null || cmbNam.SelectedValue == null)
                return;

            int thang = (int)cmbThang.SelectedValue;
            int nam = (int)cmbNam.SelectedValue;

            LoadingOverlay.Visibility = Visibility.Visible;
            dgPhieuLuong.ItemsSource = null;

            try
            {
                var response = await httpClient.GetAsync($"api/app/phatluong/danhsach?thang={thang}&nam={nam}");

                if (response.IsSuccessStatusCode)
                {
                    var data = await response.Content.ReadFromJsonAsync<List<PhieuLuongDto>>();
                    dgPhieuLuong.ItemsSource = data;
                }
                else
                {
                    MessageBox.Show($"Lá»—i táº£i danh sÃ¡ch: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnLoc_Click(object sender, RoutedEventArgs e)
        {
            await LoadDanhSachPhieuLuongAsync();
        }

        private async void BtnXemChiTiet_Click(object sender, RoutedEventArgs e)
        {
            if ((sender as Button)?.DataContext is not PhieuLuongDto selectedPhieu)
                return;

            // Má»Ÿ Window popup vÃ  truyá»n ID
            var popup = new PhieuLuongPreviewWindow(selectedPhieu.IdPhieuLuong);

            // ShowDialog Ä‘á»ƒ cháº·n tÆ°Æ¡ng tÃ¡c vá»›i cá»­a sá»• chÃ­nh
            // DialogResult sáº½ lÃ  'true' náº¿u ngÆ°á»i dÃ¹ng nháº¥n "XÃ¡c nháº­n PhÃ¡t LÆ°Æ¡ng" thÃ nh cÃ´ng
            bool? result = popup.ShowDialog();

            if (result == true)
            {
                // Náº¿u phÃ¡t lÆ°Æ¡ng thÃ nh cÃ´ng, táº£i láº¡i danh sÃ¡ch Ä‘á»ƒ cáº­p nháº­t tráº¡ng thÃ¡i
                await LoadDanhSachPhieuLuongAsync();
            }
        }

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLySachView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLySachView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLySachView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      xmlns:common="clr-namespace:AppCafebookApi.View.common"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="QuanLySachView"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="BackgroundHoverBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="BackgroundSelectedBrush" Color="#EFEBE9"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>

        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconClearFilter">M14.12,12.5L19.31,7.31L17.89,5.89L12.71,11.08L7.5,5.89L6.09,7.31L11.28,12.5L6.09,17.69L7.5,19.11L12.71,13.92L17.89,19.11L19.31,17.69L14.12,12.5M3,5H21V3H3V5Z</Geometry>
        <Geometry x:Key="IconUpload">M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z</Geometry>
        <Geometry x:Key="IconReport">M10,17L6,21H18L14,17H10M10,10H14V15H10V10M4,3H20C21.1,3 22,3.9 22,5V17C22,18.1 21.1,19 20,19H4C2.9,19 2,18.1 2,17V5C2,3.9 2.9,3 4,3Z</Geometry>
        <Geometry x:Key="IconSettings">M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M12,22C11.6,22 11.2,21.9 10.8,21.7L9.1,20.9C5.1,19.3 2,15.2 2,10.9V5L12,2L22,5V10.9C22,15.2 18.9,19.3 14.9,20.9L13.2,21.7C12.8,21.9 12.4,22 12,22Z</Geometry>
        
        <Style x:Key="ActionButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,10"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="4" Padding="{TemplateBinding Padding}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.1" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.8"/>
                                <Setter TargetName="border" Property="Effect" Value="{x:Null}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="DeleteButton" TargetType="Button" BasedOn="{StaticResource ActionButton}">
            <Setter Property="Background" Value="{StaticResource ErrorBrush}"/>
        </Style>
        <Style x:Key="MaterialIconButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="20">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BackgroundHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="Label">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,15,0,5"/>
        </Style>
        <Style x:Key="MaterialTextBox" TargetType="TextBox">
            <Setter Property="Padding" Value="8,10"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TextBox">
                        <Border x:Name="border" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}">
                            <ScrollViewer x:Name="PART_ContentHost" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsKeyboardFocused" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="BorderThickness" Value="0,0,0,2"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="MaterialComboBox" TargetType="ComboBox">
            <Setter Property="Padding" Value="8,10"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="SearchTextBox" TargetType="TextBox" BasedOn="{StaticResource MaterialTextBox}">
            <Setter Property="Padding" Value="8,8"/>
        </Style>
        <Style x:Key="FilterComboBox" TargetType="ComboBox" BasedOn="{StaticResource MaterialComboBox}">
            <Setter Property="Padding" Value="8,8"/>
        </Style>
        <Style TargetType="TabControl">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
        <Style TargetType="TabItem">
            <Setter Property="Background" Value="#E0E0E0"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border x:Name="border" BorderThickness="0,0,0,3" BorderBrush="Transparent" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" Margin="0,0,5,0">
                            <ContentPresenter ContentSource="Header" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="Background" Value="White"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
                                <Setter TargetName="border" Property="Background" Value="#F5F5F5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BookCoverImage" TargetType="Image">
            <Setter Property="Width" Value="120"/>
            <Setter Property="Height" Value="160"/>
            <Setter Property="Stretch" Value="UniformToFill"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
        </Style>
    </Page.Resources>

    <Grid Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="470"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Background="White" CornerRadius="8" Margin="10">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
            </Border.Effect>

            <TabControl Margin="5">

                <TabItem Header="Quáº£n lÃ½ SÃ¡ch">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10,5,10,10">
                            <TextBlock Text="TÃ¬m kiáº¿m:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                            <TextBox x:Name="txtSearchSach" Width="200" Style="{StaticResource SearchTextBox}" TextChanged="TxtSearchSach_TextChanged"/>
                            <TextBlock Text="Thá»ƒ loáº¡i:" VerticalAlignment="Center" Margin="15,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                            <ComboBox x:Name="cmbFilterTheLoai" Width="180" DisplayMemberPath="Ten" SelectedValuePath="Id" Margin="5"
                                      Style="{StaticResource FilterComboBox}" SelectionChanged="CmbFilterTheLoai_SelectionChanged"/>
                            <Button x:Name="btnClearFilter" ToolTip="XÃ³a Lá»c" Style="{StaticResource MaterialIconButton}" 
                                    Click="BtnClearFilter_Click" Margin="5,0,0,0">
                                <Path Data="{StaticResource IconClearFilter}" Fill="{StaticResource TextGrayBrush}" Width="20" Height="20"/>
                            </Button>
                        </StackPanel>
                        <DataGrid Grid.Row="1" x:Name="dgSach" AutoGenerateColumns="False" IsReadOnly="True"
                                  SelectionMode="Single" SelectionChanged="DgSach_SelectionChanged"
                                  BorderThickness="0" RowHeaderWidth="0" Margin="10,0,10,10">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ID" Binding="{Binding IdSach}" Width="50"/>
                                <DataGridTextColumn Header="TÃªn SÃ¡ch" Binding="{Binding TenSach}" Width="*"/>
                                <DataGridTextColumn Header="TÃ¡c Giáº£" Binding="{Binding TenTacGia}" Width="150"/>
                                <DataGridTextColumn Header="Thá»ƒ Loáº¡i" Binding="{Binding TenTheLoai}" Width="120"/>
                                <DataGridTextColumn Header="Vá»‹ trÃ­" Binding="{Binding ViTri}" Width="80"/>
                                <DataGridTextColumn Header="Tá»•ng SL" Binding="{Binding SoLuongTong}" Width="80"/>
                                <DataGridTextColumn Header="Äang ThuÃª" Binding="{Binding SoLuongDangMuon}" Width="80"/>
                                <DataGridTextColumn Header="CÃ²n Láº¡i" Binding="{Binding SoLuongHienCo}" Width="80"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </TabItem>

                <TabItem Header="Lá»‹ch sá»­ &amp; Trá»… háº¡n">
                    <Grid Margin="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <StackPanel Grid.Row="0" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,0,10">
                            <Button x:Name="btnCaiDatPhiThue"
                                    Style="{StaticResource ActionButton}" Background="{StaticResource TextGrayBrush}"
                                    Click="BtnCaiDatPhiThue_Click" Margin="0,0,10,0">
                                <StackPanel Orientation="Horizontal">
                                    <Path Data="{StaticResource IconSettings}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                    <TextBlock Text="CÃ i Ä‘áº·t PhÃ­ thuÃª" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>

                            <Button x:Name="btnXemBaoCaoSach"
                                    Style="{StaticResource ActionButton}" Background="#42A5F5"
                                    Click="BtnXemBaoCaoSach_Click">
                                <StackPanel Orientation="Horizontal">
                                    <Path Data="{StaticResource IconReport}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                    <TextBlock Text="Xem BÃ¡o CÃ¡o Tá»“n Kho SÃ¡ch" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </StackPanel>

                        <TabControl Grid.Row="1">
                            <TabItem Header="SÃ¡ch QuÃ¡ Háº¡n">
                                <DataGrid x:Name="dgSachQuaHan" AutoGenerateColumns="False" IsReadOnly="True" BorderThickness="0" RowHeaderWidth="0">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="TÃªn SÃ¡ch" Binding="{Binding TenSach}" Width="*"/>
                                        <DataGridTextColumn Header="KhÃ¡ch hÃ ng" Binding="{Binding HoTen}" Width="150"/>
                                        <DataGridTextColumn Header="SÄT" Binding="{Binding SoDienThoai}" Width="100"/>
                                        <DataGridTextColumn Header="NgÃ y Háº¹n Tráº£" Binding="{Binding NgayHenTra, StringFormat='dd/MM/yyyy'}" Width="100"/>
                                        <DataGridTextColumn Header="Tráº¡ng thÃ¡i" Binding="{Binding TinhTrang}" Width="100"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </TabItem>
                            <TabItem Header="Lá»‹ch sá»­ ThuÃª (Má»›i nháº¥t)">
                                <DataGrid x:Name="dgLichSuThue" AutoGenerateColumns="False" IsReadOnly="True" BorderThickness="0" RowHeaderWidth="0">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="TÃªn SÃ¡ch" Binding="{Binding TenSach}" Width="*"/>
                                        <DataGridTextColumn Header="KhÃ¡ch hÃ ng" Binding="{Binding TenKhachHang}" Width="150"/>
                                        <DataGridTextColumn Header="NgÃ y ThuÃª" Binding="{Binding NgayThue, StringFormat='dd/MM/yyyy'}" Width="100"/>
                                        <DataGridTextColumn Header="NgÃ y Tráº£" Binding="{Binding NgayTraThucTe, StringFormat='dd/MM/yyyy'}" Width="100"/>
                                        <DataGridTextColumn Header="Tiá»n Pháº¡t" Binding="{Binding TienPhat, StringFormat=N0}" Width="80"/>
                                        <DataGridTextColumn Header="Tráº¡ng thÃ¡i" Binding="{Binding TrangThai}" Width="100"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </TabItem>
                        </TabControl>
                    </Grid>
                </TabItem>

                <TabItem Header="Quáº£n lÃ½ Danh má»¥c">
                    <Grid Margin="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <Border Grid.Column="0" Margin="0,0,10,0" Padding="15" Background="{StaticResource SubtleGrayBrush}" CornerRadius="8">
                            <StackPanel>
                                <TextBlock Text="TÃ¡c Giáº£" FontSize="16" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,10"/>
                                <ListBox x:Name="lbTacGia" DisplayMemberPath="Ten" SelectedValuePath="Id" Height="250" Margin="0,0,0,10" SelectionChanged="LbTacGia_SelectionChanged"/>
                                <TextBox x:Name="txtTenTacGia" Style="{StaticResource MaterialTextBox}" Margin="0,0,0,10"/>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                    <Button x:Name="btnThemTacGia" Content="ThÃªm" Click="BtnThemTacGia_Click" Style="{StaticResource ActionButton}" Background="{StaticResource SuccessBrush}" Padding="10,5" Margin="0,0,5,0"/>
                                    <Button x:Name="btnLuuTacGia" Content="LÆ°u" Click="BtnLuuTacGia_Click" Style="{StaticResource ActionButton}" Padding="10,5" Margin="0,0,5,0"/>
                                    <Button x:Name="btnXoaTacGia" Content="XÃ³a" Click="BtnXoaTacGia_Click" Style="{StaticResource DeleteButton}" Padding="10,5"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>

                        <Border Grid.Column="1" Margin="5,0,5,0" Padding="15" Background="{StaticResource SubtleGrayBrush}" CornerRadius="8">
                            <StackPanel>
                                <TextBlock Text="Thá»ƒ Loáº¡i" FontSize="16" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,10"/>
                                <ListBox x:Name="lbTheLoai" DisplayMemberPath="Ten" SelectedValuePath="Id" Height="250" Margin="0,0,0,10" SelectionChanged="LbTheLoai_SelectionChanged"/>
                                <TextBox x:Name="txtTenTheLoai" Style="{StaticResource MaterialTextBox}" Margin="0,0,0,10"/>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                    <Button x:Name="btnThemTheLoai" Content="ThÃªm" Click="BtnThemTheLoai_Click" Style="{StaticResource ActionButton}" Background="{StaticResource SuccessBrush}" Padding="10,5" Margin="0,0,5,0"/>
                                    <Button x:Name="btnLuuTheLoai" Content="LÆ°u" Click="BtnLuuTheLoai_Click" Style="{StaticResource ActionButton}" Padding="10,5" Margin="0,0,5,0"/>
                                    <Button x:Name="btnXoaTheLoai" Content="XÃ³a" Click="BtnXoaTheLoai_Click" Style="{StaticResource DeleteButton}" Padding="10,5"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>

                        <Border Grid.Column="2" Margin="10,0,0,0" Padding="15" Background="{StaticResource SubtleGrayBrush}" CornerRadius="8">
                            <StackPanel>
                                <TextBlock Text="NhÃ  Xuáº¥t Báº£n" FontSize="16" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,10"/>
                                <ListBox x:Name="lbNhaXuatBan" DisplayMemberPath="Ten" SelectedValuePath="Id" Height="250" Margin="0,0,0,10" SelectionChanged="LbNhaXuatBan_SelectionChanged"/>
                                <TextBox x:Name="txtTenNhaXuatBan" Style="{StaticResource MaterialTextBox}" Margin="0,0,0,10"/>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                    <Button x:Name="btnThemNXB" Content="ThÃªm" Click="BtnThemNXB_Click" Style="{StaticResource ActionButton}" Background="{StaticResource SuccessBrush}" Padding="10,5" Margin="0,0,5,0"/>
                                    <Button x:Name="btnLuuNXB" Content="LÆ°u" Click="BtnLuuNXB_Click" Style="{StaticResource ActionButton}" Padding="10,5" Margin="0,0,5,0"/>
                                    <Button x:Name="btnXoaNXB" Content="XÃ³a" Click="BtnXoaNXB_Click" Style="{StaticResource DeleteButton}" Padding="10,5"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </Grid>
                </TabItem>

            </TabControl>
        </Border>

        <Border Grid.Column="1" Background="White" CornerRadius="8" Padding="25" Margin="0,10,10,10">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
            </Border.Effect>
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock x:Name="lblFormTitle" Text="ThÃ´ng tin SÃ¡ch" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,5,0,15" VerticalAlignment="Center"/>
                        <Button x:Name="btnLamMoiForm" Grid.Column="1" ToolTip="Táº¡o sÃ¡ch má»›i" Click="BtnLamMoiForm_Click" 
                                Style="{StaticResource MaterialIconButton}">
                            <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="25" Height="25"/>
                        </Button>
                    </Grid>

                    <Grid x:Name="formChiTiet" IsEnabled="False">
                        <StackPanel>
                            <Grid Margin="0,0,0,15">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <Border Grid.Column="0" BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="1" Width="120" Height="160" Background="{StaticResource SubtleGrayBrush}">
                                    <Image x:Name="AnhBiaPreview" Style="{StaticResource BookCoverImage}"/>
                                </Border>

                                <StackPanel Grid.Column="1" VerticalAlignment="Bottom" Orientation="Horizontal" Margin="15,0,0,0">
                                    <Button x:Name="btnChonAnh" 
                                            Style="{StaticResource ActionButton}" Background="#F5F5F5" 
                                            BorderBrush="#E0E0E0" Foreground="{StaticResource DarkBrownBrush}"
                                            Click="BtnChonAnh_Click">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconUpload}" Fill="{StaticResource DarkBrownBrush}" Width="20" Height="20" Margin="0,0,8,0"/>
                                            <TextBlock Text="Chá»n áº£nh bÃ¬a" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>

                                    <Button x:Name="btnXoaAnh" 
                                            Style="{StaticResource DeleteButton}" 
                                            Margin="10,0,0,0" 
                                            Click="BtnXoaAnh_Click">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconDelete}" Fill="White" Width="18" Height="18" Margin="0,0,8,0"/>
                                            <TextBlock Text="XÃ³a áº£nh" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                            </Grid>

                            <Label Content="TÃªn SÃ¡ch (*)"/>
                            <TextBox x:Name="txtTenSach" Style="{StaticResource MaterialTextBox}"/>

                            <Label Content="TÃ¡c Giáº£"/>
                            <ComboBox x:Name="cmbTacGia" DisplayMemberPath="Ten" SelectedValuePath="Id" Style="{StaticResource MaterialComboBox}"
                                      IsEditable="True" IsTextSearchEnabled="True"/>

                            <Label Content="Thá»ƒ Loáº¡i"/>
                            <ComboBox x:Name="cmbTheLoai" DisplayMemberPath="Ten" SelectedValuePath="Id" Style="{StaticResource MaterialComboBox}"
                                      IsEditable="True" IsTextSearchEnabled="True"/>

                            <Label Content="NhÃ  Xuáº¥t Báº£n"/>
                            <ComboBox x:Name="cmbNhaXuatBan" DisplayMemberPath="Ten" SelectedValuePath="Id" Style="{StaticResource MaterialComboBox}"
                                      IsEditable="True" IsTextSearchEnabled="True"/>

                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0" Margin="0,0,10,0">
                                    <Label Content="NÄƒm Xuáº¥t Báº£n"/>
                                    <TextBox x:Name="txtNamXuatBan" Style="{StaticResource MaterialTextBox}"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1" Margin="10,0,0,0">
                                    <Label Content="Tá»•ng Sá»‘ LÆ°á»£ng (*)"/>
                                    <TextBox x:Name="txtSoLuongTong" Style="{StaticResource MaterialTextBox}"/>
                                </StackPanel>
                            </Grid>

                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0" Margin="0,0,10,0">
                                    <Label Content="GiÃ¡ BÃ¬a (Tiá»n cá»c)"/>
                                    <TextBox x:Name="txtGiaBia" Style="{StaticResource MaterialTextBox}"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1" Margin="10,0,0,0">
                                    <Label Content="Vá»‹ trÃ­ (Ká»‡ sÃ¡ch)"/>
                                    <TextBox x:Name="txtViTri" Style="{StaticResource MaterialTextBox}"/>
                                </StackPanel>
                            </Grid>

                            <Label Content="MÃ´ táº£"/>
                            <TextBox x:Name="txtMoTa" Style="{StaticResource MaterialTextBox}"
                                     Height="100" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"/>
                        </StackPanel>
                    </Grid>

                    <StackPanel x:Name="panelActions" Orientation="Horizontal" Margin="0,25,0,0">
                        <Button x:Name="btnLuu" Click="BtnLuu_Click" Margin="0,0,10,0" Style="{StaticResource ActionButton}" Background="{StaticResource SuccessBrush}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconSave}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="LÆ°u SÃ¡ch" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        <Button x:Name="btnXoa" Click="BtnXoa_Click" Margin="0,0,10,0" Style="{StaticResource DeleteButton}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconDelete}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="XÃ³a" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <Border x:Name="LoadingOverlay" Background="#80FFFFFF" Visibility="Collapsed"
                            Grid.RowSpan="2" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                        <TextBlock Text="Äang xá»­ lÃ½..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
                    </Border>
                </StackPanel>
            </ScrollViewer>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLySachView.xaml.cs
// Táº­p tin: AppCafebookApi/View/quanly/pages/QuanLySachView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using Microsoft.Win32;
using System.IO; // <-- THÃŠM
using AppCafebookApi.Services;
using CafebookModel.Utils;
using AppCafebookApi.View.common;
using CafebookModel.Model.Entities;
using System.Net.Http.Headers; // <-- THÃŠM

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLySachView : Page
    {
        private static readonly HttpClient httpClient;
        private List<SachDto> _allSachList = new List<SachDto>();

        private SachDetailDto? _selectedSachDetails = null;

        // Sá»¬A: ÄÃ£ xÃ³a Base64, dÃ¹ng 2 biáº¿n nÃ y Ä‘á»ƒ quáº£n lÃ½ file upload
        private string? _currentAnhBiaFilePath = null; // LÆ°u Ä‘Æ°á»ng dáº«n file cá»¥c bá»™
        private bool _deleteImageRequest = false;     // ÄÃ¡nh dáº¥u yÃªu cáº§u xÃ³a áº£nh

        // Cache
        private List<FilterLookupDto> _theLoaiList = new List<FilterLookupDto>();
        private List<FilterLookupDto> _tacGiaList = new List<FilterLookupDto>();
        private List<FilterLookupDto> _nhaXuatBanList = new List<FilterLookupDto>();

        static QuanLySachView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://127.0.0.1:5166")
            };
        }

        public QuanLySachView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadFiltersAsync();
            await LoadDataGridAsync();
            await LoadRentalsAsync();
            ResetForm();
        }

        // ... (HÃ m LoadFiltersAsync, LoadDataGridAsync, LoadRentalsAsync giá»¯ nguyÃªn) ...
        #region 1. Táº£i Dá»¯ Liá»‡u
        private async Task LoadFiltersAsync()
        {
            try
            {
                var filters = await httpClient.GetFromJsonAsync<SachFiltersDto>("api/app/sach/filters");
                if (filters != null)
                {
                    _theLoaiList = filters.TheLoais;
                    _tacGiaList = filters.TacGias;
                    _nhaXuatBanList = filters.NhaXuatBans;
                    var filterTheLoai = new List<FilterLookupDto>(_theLoaiList);
                    filterTheLoai.Insert(0, new FilterLookupDto { Id = 0, Ten = "Táº¥t cáº£ Thá»ƒ loáº¡i" });
                    cmbFilterTheLoai.ItemsSource = filterTheLoai;
                    if (cmbFilterTheLoai.SelectedValue == null) cmbFilterTheLoai.SelectedValue = 0;
                    var formTheLoai = new List<FilterLookupDto>(_theLoaiList);
                    formTheLoai.Insert(0, new FilterLookupDto { Id = 0, Ten = "-- Chá»n Thá»ƒ loáº¡i --" });
                    cmbTheLoai.ItemsSource = formTheLoai;
                    var formTacGia = new List<FilterLookupDto>(_tacGiaList);
                    formTacGia.Insert(0, new FilterLookupDto { Id = 0, Ten = "-- Chá»n TÃ¡c giáº£ --" });
                    cmbTacGia.ItemsSource = formTacGia;
                    var formNXB = new List<FilterLookupDto>(_nhaXuatBanList);
                    formNXB.Insert(0, new FilterLookupDto { Id = 0, Ten = "-- Chá»n NXB --" });
                    cmbNhaXuatBan.ItemsSource = formNXB;
                    lbTacGia.ItemsSource = _tacGiaList;
                    lbTheLoai.ItemsSource = _theLoaiList;
                    lbNhaXuatBan.ItemsSource = _nhaXuatBanList;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i bá»™ lá»c: {ex.Message}", "Lá»—i API");
            }
        }

        private async Task LoadDataGridAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            string searchText = txtSearchSach.Text;
            int theLoaiId = (int)(cmbFilterTheLoai.SelectedValue ?? 0);
            try
            {
                var url = $"api/app/sach/search?searchText={Uri.EscapeDataString(searchText)}&theLoaiId={theLoaiId}";
                _allSachList = (await httpClient.GetFromJsonAsync<List<SachDto>>(url)) ?? new List<SachDto>();
                dgSach.ItemsSource = _allSachList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i danh sÃ¡ch sÃ¡ch: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async Task LoadRentalsAsync()
        {
            try
            {
                var rentalData = await httpClient.GetFromJsonAsync<SachRentalsDto>("api/app/sach/rentals");
                if (rentalData != null)
                {
                    dgSachQuaHan.ItemsSource = rentalData.SachQuaHan;
                    dgLichSuThue.ItemsSource = rentalData.LichSuThue;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i lá»‹ch sá»­ thuÃª sÃ¡ch: {ex.Message}", "Lá»—i API");
            }
        }
        #endregion

        #region 2. Form Chi Tiáº¿t SÃ¡ch
        private void ResetForm()
        {
            _selectedSachDetails = null;

            // Sá»¬A: Äáº·t láº¡i 2 biáº¿n quáº£n lÃ½ file
            _currentAnhBiaFilePath = null;
            _deleteImageRequest = false;

            dgSach.SelectedItem = null;
            formChiTiet.IsEnabled = true;
            panelActions.Visibility = Visibility.Visible;
            btnXoa.Visibility = Visibility.Collapsed;
            lblFormTitle.Text = "ThÃªm SÃ¡ch Má»›i";
            txtTenSach.Text = "";
            txtNamXuatBan.Text = "";
            txtSoLuongTong.Text = "1";
            txtMoTa.Text = "";
            cmbTacGia.SelectedValue = 0;
            cmbTacGia.Text = string.Empty;
            cmbTheLoai.SelectedValue = 0;
            cmbTheLoai.Text = string.Empty;
            cmbNhaXuatBan.SelectedValue = 0;
            cmbNhaXuatBan.Text = string.Empty;
            txtGiaBia.Text = "0";
            txtViTri.Text = "";

            // Sá»¬A: DÃ¹ng HinhAnhHelper.LoadImage (vá»›i nguá»“n null)
            AnhBiaPreview.Source = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultBookCover);
        }

        private async void DgSach_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgSach.SelectedItem is not SachDto selected)
            {
                ResetForm();
                return;
            }
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                _selectedSachDetails = await httpClient.GetFromJsonAsync<SachDetailDto>($"api/app/sach/details/{selected.IdSach}");

                if (_selectedSachDetails == null)
                {
                    ResetForm();
                    return;
                }
                //MessageBox.Show($"URL nháº­n Ä‘Æ°á»£c tá»« API:\n{_selectedSachDetails.AnhBiaUrl}", "DEBUG URL");
                // Sá»¬A: Äáº·t láº¡i 2 biáº¿n quáº£n lÃ½ file
                _currentAnhBiaFilePath = null;
                _deleteImageRequest = false;

                formChiTiet.IsEnabled = true;
                panelActions.Visibility = Visibility.Visible;
                btnXoa.Visibility = Visibility.Visible;
                lblFormTitle.Text = "Cáº­p nháº­t SÃ¡ch";

                txtTenSach.Text = _selectedSachDetails.TenSach;
                txtNamXuatBan.Text = _selectedSachDetails.NamXuatBan?.ToString() ?? "";
                txtSoLuongTong.Text = _selectedSachDetails.SoLuongTong.ToString();
                txtMoTa.Text = _selectedSachDetails.MoTa;
                cmbTacGia.SelectedValue = _selectedSachDetails.IdTacGia ?? 0;
                cmbTheLoai.SelectedValue = _selectedSachDetails.IdTheLoai ?? 0;
                cmbNhaXuatBan.SelectedValue = _selectedSachDetails.IdNhaXuatBan ?? 0;
                txtGiaBia.Text = _selectedSachDetails.GiaBia?.ToString("F0") ?? "0";
                txtViTri.Text = _selectedSachDetails.ViTri;

                // Sá»¬A: DÃ¹ng HinhAnhHelper.LoadImage vá»›i URL
                AnhBiaPreview.Source = HinhAnhHelper.LoadImage(_selectedSachDetails.AnhBiaUrl, HinhAnhPaths.DefaultBookCover);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i chi tiáº¿t sÃ¡ch: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnChonAnh_Click(object sender, RoutedEventArgs e)
        {
            var ofd = new OpenFileDialog { Filter = "Image files|*.png;*.jpg;*.jpeg", Title = "Chá»n áº£nh bÃ¬a sÃ¡ch" };
            if (ofd.ShowDialog() == true)
            {
                try
                {
                    // Sá»¬A: Chá»‰ lÆ°u Ä‘Æ°á»ng dáº«n file
                    _currentAnhBiaFilePath = ofd.FileName;
                    _deleteImageRequest = false; // ÄÃ£ chá»n file má»›i

                    // Sá»¬A: DÃ¹ng HinhAnhHelper.LoadImage (tá»± nháº­n diá»‡n Ä‘Æ°á»ng dáº«n file)
                    AnhBiaPreview.Source = HinhAnhHelper.LoadImage(_currentAnhBiaFilePath, HinhAnhPaths.DefaultBookCover);
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Lá»—i Ä‘á»c file áº£nh: {ex.Message}", "Lá»—i File");
                    _currentAnhBiaFilePath = null;
                    AnhBiaPreview.Source = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultBookCover);
                }
            }
        }

        // THÃŠM: NÃºt XÃ³a áº¢nh
        private void BtnXoaAnh_Click(object sender, RoutedEventArgs e)
        {
            _currentAnhBiaFilePath = null; // XÃ³a Ä‘Æ°á»ng dáº«n file
            _deleteImageRequest = true;   // ÄÃ¡nh dáº¥u yÃªu cáº§u xÃ³a
            AnhBiaPreview.Source = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultBookCover); // Hiá»ƒn thá»‹ áº£nh máº·c Ä‘á»‹nh
        }
        #endregion

        #region 3. Lá»c / Form
        private async void TxtSearchSach_TextChanged(object sender, TextChangedEventArgs e)
        {
            await LoadDataGridAsync();
        }

        private async void CmbFilterTheLoai_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (cmbFilterTheLoai.IsLoaded)
            {
                await LoadDataGridAsync();
            }
        }

        private async void BtnClearFilter_Click(object sender, RoutedEventArgs e)
        {
            txtSearchSach.Text = "";
            cmbFilterTheLoai.SelectedValue = 0;
            await LoadDataGridAsync();
        }

        private void BtnLamMoiForm_Click(object sender, RoutedEventArgs e)
        {
            ResetForm();
        }
        #endregion

        #region 4. LÆ°u/XÃ³a SÃ¡ch

        // Sá»¬A: VIáº¾T Láº I HOÃ€N TOÃ€N HÃ€M LÆ¯U
        private async void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            // (Validation giá»¯ nguyÃªn)
            if (string.IsNullOrWhiteSpace(txtTenSach.Text))
            {
                MessageBox.Show("TÃªn sÃ¡ch khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.", "Lá»—i"); return;
            }
            if (!int.TryParse(txtSoLuongTong.Text, out int soLuong) || soLuong <= 0)
            {
                MessageBox.Show("Sá»‘ lÆ°á»£ng tá»•ng pháº£i lÃ  sá»‘ dÆ°Æ¡ng.", "Lá»—i"); return;
            }
            if (!decimal.TryParse(txtGiaBia.Text, out _))
            {
                MessageBox.Show("GiÃ¡ bÃ¬a pháº£i lÃ  sá»‘ (hoáº·c Ä‘á»ƒ 0).", "Lá»—i"); return;
            }
            if (!string.IsNullOrEmpty(txtNamXuatBan.Text) && !int.TryParse(txtNamXuatBan.Text, out _))
            {
                MessageBox.Show("NÄƒm xuáº¥t báº£n pháº£i lÃ  sá»‘ (hoáº·c Ä‘á»ƒ trá»‘ng).", "Lá»—i"); return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                // (Helper GetOrCreateLookupIdAsync giá»¯ nguyÃªn)
                int? tacGiaId = await GetOrCreateLookupIdAsync(cmbTacGia.Text, _tacGiaList, "api/app/sach/tacgia");
                int? theLoaiId = await GetOrCreateLookupIdAsync(cmbTheLoai.Text, _theLoaiList, "api/app/sach/theloai");
                int? nhaXuatBanId = await GetOrCreateLookupIdAsync(cmbNhaXuatBan.Text, _nhaXuatBanList, "api/app/sach/nhaxuatban");

                // Sá»¬A: DÃ¹ng MultipartFormDataContent thay vÃ¬ DTO
                using var form = new MultipartFormDataContent();

                // 1. ThÃªm cÃ¡c trÆ°á»ng dá»¯ liá»‡u (tÃªn pháº£i khá»›p vá»›i DTO)
                form.Add(new StringContent(txtTenSach.Text), "TenSach");
                if (theLoaiId.HasValue)
                    form.Add(new StringContent(theLoaiId.Value.ToString()), "IdTheLoai");
                if (tacGiaId.HasValue)
                    form.Add(new StringContent(tacGiaId.Value.ToString()), "IdTacGia");
                if (nhaXuatBanId.HasValue)
                    form.Add(new StringContent(nhaXuatBanId.Value.ToString()), "IdNhaXuatBan");

                if (int.TryParse(txtNamXuatBan.Text, out int nam))
                    form.Add(new StringContent(nam.ToString()), "NamXuatBan");

                form.Add(new StringContent(txtMoTa.Text ?? ""), "MoTa");
                form.Add(new StringContent(soLuong.ToString()), "SoLuongTong");

                if (decimal.TryParse(txtGiaBia.Text, out decimal gia))
                    form.Add(new StringContent(gia.ToString()), "GiaBia");

                form.Add(new StringContent(txtViTri.Text ?? ""), "ViTri");

                bool isCreating = (_selectedSachDetails == null);

                // 2. ThÃªm file (náº¿u cÃ³)
                if (!string.IsNullOrEmpty(_currentAnhBiaFilePath))
                {
                    var fileStream = File.OpenRead(_currentAnhBiaFilePath);
                    var streamContent = new StreamContent(fileStream);
                    streamContent.Headers.ContentType = new MediaTypeHeaderValue("image/jpeg"); // Hoáº·c image/png
                    // TÃªn "AnhBiaUpload" pháº£i khá»›p vá»›i tham sá»‘ á»Ÿ Controller
                    form.Add(streamContent, "AnhBiaUpload", Path.GetFileName(_currentAnhBiaFilePath));
                }

                // 3. ThÃªm cá» XÃ³a áº£nh (náº¿u cÃ³)
                if (_deleteImageRequest)
                {
                    // TÃªn "XoaAnhBia" pháº£i khá»›p vá»›i tham sá»‘ á»Ÿ Controller
                    form.Add(new StringContent("true"), "XoaAnhBia");
                }

                // GÃ¡n Id náº¿u lÃ  Update
                if (!isCreating)
                {
                    form.Add(new StringContent(_selectedSachDetails.IdSach.ToString()), "IdSach");
                }

                HttpResponseMessage response;

                if (isCreating)
                {
                    response = await httpClient.PostAsync("api/app/sach", form);
                }
                else
                {
                    response = await httpClient.PutAsync($"api/app/sach/{_selectedSachDetails.IdSach}", form);
                }

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("LÆ°u thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadFiltersAsync();
                    await LoadDataGridAsync();

                    if (isCreating)
                    {
                        var newSach = await response.Content.ReadFromJsonAsync<SachDetailDto>();
                        var newItemInGrid = _allSachList.FirstOrDefault(s => s.IdSach == newSach.IdSach);
                        dgSach.SelectedItem = newItemInGrid; // Tá»± Ä‘á»™ng chá»n
                    }
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
                // Sá»¬A: Äáº·t láº¡i cache file
                _currentAnhBiaFilePath = null;
                _deleteImageRequest = false;
            }
        }

        // (HÃ m GetOrCreateLookupIdAsync giá»¯ nguyÃªn)
        private async Task<int?> GetOrCreateLookupIdAsync(string tenDaNhap, List<FilterLookupDto> list, string apiEndpoint)
        {
            if (string.IsNullOrWhiteSpace(tenDaNhap) || tenDaNhap.StartsWith("--"))
            {
                return null;
            }
            var item = list.FirstOrDefault(x => x.Ten.Equals(tenDaNhap, StringComparison.OrdinalIgnoreCase));
            if (item != null)
            {
                return item.Id;
            }
            try
            {
                var response = await httpClient.PostAsJsonAsync(apiEndpoint, new FilterLookupDto { Ten = tenDaNhap });
                if (response.IsSuccessStatusCode)
                {
                    var newItem = await response.Content.ReadFromJsonAsync<FilterLookupDto>();
                    return newItem?.Id;
                }
                else
                {
                    MessageBox.Show($"KhÃ´ng thá»ƒ tá»± Ä‘á»™ng thÃªm '{tenDaNhap}': {await response.Content.ReadAsStringAsync()}", "Lá»—i Táº¡o Má»›i");
                    return null;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i API khi táº¡o má»›i: {ex.Message}", "Lá»—i");
                return null;
            }
        }

        // (HÃ m BtnXoa_Click giá»¯ nguyÃªn)
        private async void BtnXoa_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedSachDetails == null) return;
            var result = MessageBox.Show($"Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a sÃ¡ch '{_selectedSachDetails.TenSach}'?",
                                          "XÃ¡c nháº­n xÃ³a", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/sach/{_selectedSachDetails.IdSach}");
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("XÃ³a thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadDataGridAsync();
                    ResetForm();
                }
                else if (response.StatusCode == HttpStatusCode.Conflict)
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "KhÃ´ng thá»ƒ xÃ³a");
                }
                else
                {
                    MessageBox.Show($"Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh: {response.ReasonPhrase}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion

        #region 5. CRUD Danh má»¥c (TÃ¡c giáº£, Thá»ƒ loáº¡i, NXB)
        // (ToÃ n bá»™ cÃ¡c hÃ m trong region nÃ y giá»¯ nguyÃªn)
        private void LbTacGia_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (lbTacGia.SelectedItem is FilterLookupDto selected)
            {
                txtTenTacGia.Text = selected.Ten;
            }
        }
        private async void BtnThemTacGia_Click(object sender, RoutedEventArgs e)
        {
            await CrudLookupAsync("api/app/sach/tacgia", null, txtTenTacGia.Text);
        }
        private async void BtnLuuTacGia_Click(object sender, RoutedEventArgs e)
        {
            if (lbTacGia.SelectedItem is FilterLookupDto selected)
            {
                await CrudLookupAsync($"api/app/sach/tacgia/{selected.Id}", selected.Id, txtTenTacGia.Text);
            }
        }
        private async void BtnXoaTacGia_Click(object sender, RoutedEventArgs e)
        {
            if (lbTacGia.SelectedItem is FilterLookupDto selected)
            {
                await CrudLookupAsync($"api/app/sach/tacgia/{selected.Id}", selected.Id, null, isDelete: true);
            }
        }
        private void LbTheLoai_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (lbTheLoai.SelectedItem is FilterLookupDto selected)
            {
                txtTenTheLoai.Text = selected.Ten;
            }
        }
        private async void BtnThemTheLoai_Click(object sender, RoutedEventArgs e)
        {
            await CrudLookupAsync("api/app/sach/theloai", null, txtTenTheLoai.Text);
        }
        private async void BtnLuuTheLoai_Click(object sender, RoutedEventArgs e)
        {
            if (lbTheLoai.SelectedItem is FilterLookupDto selected)
            {
                await CrudLookupAsync($"api/app/sach/theloai/{selected.Id}", selected.Id, txtTenTheLoai.Text);
            }
        }
        private async void BtnXoaTheLoai_Click(object sender, RoutedEventArgs e)
        {
            if (lbTheLoai.SelectedItem is FilterLookupDto selected)
            {
                await CrudLookupAsync($"api/app/sach/theloai/{selected.Id}", selected.Id, null, isDelete: true);
            }
        }
        private void LbNhaXuatBan_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (lbNhaXuatBan.SelectedItem is FilterLookupDto selected)
            {
                txtTenNhaXuatBan.Text = selected.Ten;
            }
        }
        private async void BtnThemNXB_Click(object sender, RoutedEventArgs e)
        {
            await CrudLookupAsync("api/app/sach/nhaxuatban", null, txtTenNhaXuatBan.Text);
        }
        private async void BtnLuuNXB_Click(object sender, RoutedEventArgs e)
        {
            if (lbNhaXuatBan.SelectedItem is FilterLookupDto selected)
            {
                await CrudLookupAsync($"api/app/sach/nhaxuatban/{selected.Id}", selected.Id, txtTenNhaXuatBan.Text);
            }
        }
        private async void BtnXoaNXB_Click(object sender, RoutedEventArgs e)
        {
            if (lbNhaXuatBan.SelectedItem is FilterLookupDto selected)
            {
                await CrudLookupAsync($"api/app/sach/nhaxuatban/{selected.Id}", selected.Id, null, isDelete: true);
            }
        }
        private async Task CrudLookupAsync(string endpoint, int? id, string? ten, bool isDelete = false)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                HttpResponseMessage response;
                if (isDelete)
                {
                    if (MessageBox.Show("Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a?", "XÃ¡c nháº­n", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.No)
                    {
                        LoadingOverlay.Visibility = Visibility.Collapsed;
                        return;
                    }
                    response = await httpClient.DeleteAsync(endpoint);
                }
                else if (string.IsNullOrWhiteSpace(ten))
                {
                    MessageBox.Show("TÃªn khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.", "Lá»—i");
                    LoadingOverlay.Visibility = Visibility.Collapsed;
                    return;
                }
                else if (id.HasValue) // Update (PUT)
                {
                    response = await httpClient.PutAsJsonAsync(endpoint, new FilterLookupDto { Id = id.Value, Ten = ten ?? "" });
                }
                else // Create (POST)
                {
                    response = await httpClient.PostAsJsonAsync(endpoint, new FilterLookupDto { Ten = ten ?? "" });
                }

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Thao tÃ¡c thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadFiltersAsync(); // Táº£i láº¡i TOÃ€N Bá»˜
                    ResetLookupForms();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }
        private void ResetLookupForms()
        {
            txtTenTacGia.Text = string.Empty;
            lbTacGia.SelectedItem = null;
            txtTenTheLoai.Text = string.Empty;
            lbTheLoai.SelectedItem = null;
            txtTenNhaXuatBan.Text = string.Empty;
            lbNhaXuatBan.SelectedItem = null;
        }
        #endregion

        #region 6. Navigation Buttons
        // (ToÃ n bá»™ cÃ¡c hÃ m trong region nÃ y giá»¯ nguyÃªn)
        private void BtnXemBaoCaoSach_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new BapCaoTonKhoSachPreviewWindow());
        }
        private void BtnCaiDatPhiThue_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new CaiDatWindow());
        }
        #endregion
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLySanPhamView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLySanPhamView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLySanPhamView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="QuanLySanPhamView"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="BackgroundHoverBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="BackgroundSelectedBrush" Color="#EFEBE9"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>

        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconClearFilter">M14.12,12.5L19.31,7.31L17.89,5.89L12.71,11.08L7.5,5.89L6.09,7.31L11.28,12.5L6.09,17.69L7.5,19.11L12.71,13.92L17.89,19.11L19.31,17.69L14.12,12.5M3,5H21V3H3V5Z</Geometry>
        <Geometry x:Key="IconUpload">M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z</Geometry>
        <Geometry x:Key="IconExcel">M21.17 3.25Q21.5 3.25 21.76 3.5 22 3.74 22 4.08V19.92Q22 20.26 21.76 20.5 21.5 20.75 21.17 20.75H7.83Q7.5 20.75 7.24 20.5 7 20.26 7 19.92V4.08Q7 3.74 7.24 3.5 7.5 3.25 7.83 3.25H21.17M13.83 18.25V15.7H11.5V14.05L13.72 10.63H11.6V9H16.33V10.65L14.12 14.07H16.25V15.7H13.83V18.25M6.25 15.5Q6.25 15.15 6.04 14.88 5.82 14.6 5.5 14.6H3.5Q3.18 14.6 2.96 14.88 2.75 15.15 2.75 15.5V17.5Q2.75 17.82 2.96 18.1 3.18 18.38 3.5 18.38H5.5Q5.82 18.38 6.04 18.1 6.25 17.82 6.25 17.5V15.5M6.25 9.5Q6.25 9.18 6.04 8.9 5.82 8.62 5.5 8.62H3.5Q3.18 8.62 2.96 8.9 2.75 9.18 2.75 9.5V11.5Q2.75 11.82 2.96 12.1 3.18 12.38 3.5 12.38H5.5Q5.82 12.38 6.04 12.1 6.25 11.82 6.25 11.5V9.5Z</Geometry>

        <Style x:Key="ActionButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,10"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="4" Padding="{TemplateBinding Padding}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.1" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.8"/>
                                <Setter TargetName="border" Property="Effect" Value="{x:Null}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="DeleteButton" TargetType="Button" BasedOn="{StaticResource ActionButton}">
            <Setter Property="Background" Value="{StaticResource ErrorBrush}"/>
        </Style>
        <Style x:Key="MaterialIconButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="20">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BackgroundHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="Label">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,15,0,5"/>
        </Style>
        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>

        <Style x:Key="SearchTextBox" TargetType="TextBox" BasedOn="{StaticResource MaterialInput}">
            <Setter Property="Padding" Value="8,8"/>
        </Style>
        <Style x:Key="FilterComboBox" TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}">
            <Setter Property="Padding" Value="8,8"/>
        </Style>
        <Style TargetType="TabControl">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
        <Style TargetType="TabItem">
            <Setter Property="Background" Value="#E0E0E0"/>
            <Setter Property="Foreground" Value="{StaticResource TextGrayBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border x:Name="border" BorderThickness="0,0,0,3" BorderBrush="Transparent" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" Margin="0,0,5,0">
                            <ContentPresenter ContentSource="Header" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter TargetName="border" Property="Background" Value="White"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
                                <Setter TargetName="border" Property="Background" Value="#F5F5F5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="ProductImage" TargetType="Image">
            <Setter Property="Width" Value="140"/>
            <Setter Property="Height" Value="140"/>
            <Setter Property="Stretch" Value="Uniform"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
        </Style>
        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

    </Page.Resources>

    <Grid Opacity="1" x:Name="MainGrid">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="420"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Background="White" CornerRadius="8" Margin="10">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
            </Border.Effect>

            <TabControl x:Name="MainTabControl" Margin="5">

                <TabItem Header="Quáº£n lÃ½ Sáº£n pháº©m">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <WrapPanel Grid.Row="0" Orientation="Horizontal" Margin="10,5,10,10">
                            <TextBlock Text="TÃ¬m kiáº¿m:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                            <TextBox x:Name="txtSearchSanPham" Width="200" TextChanged="TxtSearchSanPham_TextChanged"/>
                            <TextBlock Text="Danh má»¥c:" VerticalAlignment="Center" Margin="15,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                            <ComboBox x:Name="cmbFilterDanhMuc" Width="180" DisplayMemberPath="Ten" SelectedValuePath="Id"
                                      SelectionChanged="Filter_SelectionChanged"/>
                            <TextBlock Text="Tráº¡ng thÃ¡i:" VerticalAlignment="Center" Margin="15,0,5,0" Foreground="{StaticResource DarkBrownBrush}"/>
                            <ComboBox x:Name="cmbFilterTrangThai" Width="120" SelectionChanged="Filter_SelectionChanged">
                                <ComboBoxItem Content="Táº¥t cáº£" Tag="{x:Null}"/>
                                <ComboBoxItem Content="Äang bÃ¡n" Tag="True"/>
                                <ComboBoxItem Content="Táº¡m ngÆ°ng" Tag="False"/>
                            </ComboBox>
                            <Button x:Name="btnClearFilter" ToolTip="XÃ³a Lá»c" Style="{StaticResource MaterialIconButton}" 
                                    Click="BtnClearFilter_Click" Margin="5,0,0,0">
                                <Path Data="{StaticResource IconClearFilter}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                            </Button>
                        </WrapPanel>
                        <DataGrid Grid.Row="1" x:Name="dgSanPham" AutoGenerateColumns="False" IsReadOnly="True"
                                  SelectionMode="Single" SelectionChanged="DgSanPham_SelectionChanged"
                                  BorderThickness="0" RowHeaderWidth="0" Margin="10,0,10,10">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ID" Binding="{Binding IdSanPham}" Width="50"/>
                                <DataGridTextColumn Header="TÃªn Sáº£n Pháº©m" Binding="{Binding TenSanPham}" Width="*"/>
                                <DataGridTextColumn Header="ÄÆ¡n GiÃ¡" Binding="{Binding GiaBan, StringFormat=N0}" Width="100"/>
                                <DataGridTextColumn Header="Danh Má»¥c" Binding="{Binding TenDanhMuc}" Width="150"/>
                                <DataGridCheckBoxColumn Header="Äang BÃ¡n" Binding="{Binding TrangThaiKinhDoanh}" Width="80"/>
                            </DataGrid.Columns>
                        </DataGrid>

                        <Button Grid.Row="2" x:Name="btnExportToExcel" HorizontalAlignment="Left" Margin="10,0,0,10"
                                Style="{StaticResource PrimaryButton}" Background="#00724C"
                                Click="BtnExportToExcel_Click">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconExcel}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="Xuáº¥t Excel" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </Grid>
                </TabItem>

                <TabItem Header="Quáº£n lÃ½ Danh má»¥c">
                    <Grid Margin="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="380"/>
                        </Grid.ColumnDefinitions>
                        <Border Grid.Column="0" Margin="0,0,10,0" Padding="15" Background="{StaticResource SubtleGrayBrush}" CornerRadius="8">
                            <StackPanel>
                                <TextBlock Text="Danh Má»¥c (Loáº¡i Sáº£n Pháº©m)" FontSize="16" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,10"/>
                                <ListBox x:Name="lbDanhMuc" DisplayMemberPath="Ten" SelectedValuePath="Id" Height="400" Margin="0,0,0,10" SelectionChanged="LbDanhMuc_SelectionChanged"/>
                            </StackPanel>
                        </Border>
                        <Border Grid.Column="1" Margin="10,0,0,0" Padding="15" Background="{StaticResource SubtleGrayBrush}" CornerRadius="8">
                            <StackPanel>
                                <TextBlock Text="Chi tiáº¿t Danh Má»¥c" FontSize="16" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,10"/>
                                <Label Content="TÃªn Danh Má»¥c"/>
                                <TextBox x:Name="txtTenDanhMuc" Margin="0,0,0,10"/>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                    <Button x:Name="btnThemDanhMuc" Content="ThÃªm Má»›i" Click="BtnThemDanhMuc_Click" Style="{StaticResource PrimaryButton}" Background="{StaticResource SuccessBrush}" Padding="10,5" Margin="0,0,5,0"/>
                                    <Button x:Name="btnLuuDanhMuc" Content="LÆ°u" Click="BtnLuuDanhMuc_Click" Style="{StaticResource PrimaryButton}" Padding="10,5" Margin="0,0,5,0"/>
                                    <Button x:Name="btnXoaDanhMuc" Content="XÃ³a" Click="BtnXoaDanhMuc_Click" Style="{StaticResource DeleteButton}" Padding="10,5"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </Grid>
                </TabItem>

                <TabItem Header="Äá»‹nh lÆ°á»£ng NguyÃªn Liá»‡u">
                    <Grid Margin="10">
                        <TextBlock x:Name="lblDinhLuongInfo" Text="Chá»n má»™t sáº£n pháº©m á»Ÿ Tab 'Quáº£n lÃ½ Sáº£n pháº©m' Ä‘á»ƒ xem vÃ  sá»­a Ä‘á»‹nh lÆ°á»£ng." 
                                   VerticalAlignment="Center" HorizontalAlignment="Center"
                                   Foreground="{StaticResource TextGrayBrush}" FontSize="16" TextWrapping="Wrap" TextAlignment="Center"/>

                        <Grid x:Name="panelDinhLuong" Visibility="Collapsed">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" x:Name="lblDinhLuongTitle" Text="Äá»‹nh lÆ°á»£ng cho: [TÃªn Sáº£n Pháº©m]" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,15"/>

                            <DataGrid Grid.Row="1" x:Name="dgDinhLuong" AutoGenerateColumns="False" IsReadOnly="True" MaxHeight="300" RowHeaderWidth="0"
                                      SelectionChanged="DgDinhLuong_SelectionChanged">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="NguyÃªn liá»‡u" Binding="{Binding TenNguyenLieu}" Width="*"/>
                                    <DataGridTextColumn Header="Sá»‘ LÆ°á»£ng" Binding="{Binding SoLuong}" Width="100"/>
                                    <DataGridTextColumn Header="ÄÆ¡n Vá»‹ TÃ­nh" Binding="{Binding TenDonViSuDung}" Width="100"/>
                                </DataGrid.Columns>
                            </DataGrid>

                            <Grid Grid.Row="2" Margin="0,15,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="100"/>
                                    <ColumnDefinition Width="120"/>
                                </Grid.ColumnDefinitions>

                                <ComboBox Grid.Column="0" x:Name="cmbNguyenLieu" DisplayMemberPath="Ten" SelectedValuePath="Id" Margin="0,0,10,0" VerticalAlignment="Center"
                                          SelectionChanged="CmbNguyenLieu_SelectionChanged"
                                          IsEditable="True" IsTextSearchEnabled="True"/>

                                <TextBox Grid.Column="1" x:Name="txtSoLuongNL" Margin="0,0,10,0" VerticalAlignment="Center"/>

                                <ComboBox Grid.Column="2" x:Name="cmbDonViTinhNL" DisplayMemberPath="Ten" SelectedValuePath="Id" VerticalAlignment="Center"/>
                            </Grid>

                            <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,15,0,0">
                                <Button x:Name="btnLuuDinhLuong" Style="{StaticResource ActionButton}" Content="ThÃªm / Cáº­p nháº­t NL" Click="BtnLuuDinhLuong_Click" Padding="10,5" Margin="0,0,8,0"/>
                                <Button x:Name="btnXoaDinhLuong" Style="{StaticResource DeleteButton}" Content="XÃ³a NL" Click="BtnXoaDinhLuong_Click" Padding="10,5"/>
                            </StackPanel>
                        </Grid>
                    </Grid>
                </TabItem>
            </TabControl>
        </Border>

        <Border Grid.Column="1" Background="White" CornerRadius="8" Padding="25" Margin="0,10,10,10">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="15"/>
            </Border.Effect>
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock x:Name="lblFormTitle" Text="ThÃ´ng tin Sáº£n pháº©m" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,5,0,15" VerticalAlignment="Center"/>
                        <Button x:Name="btnLamMoiForm" Grid.Column="1" ToolTip="Táº¡o sáº£n pháº©m má»›i" Click="BtnLamMoiForm_Click" 
                                Style="{StaticResource MaterialIconButton}">
                            <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="23" Height="23"/>
                        </Button>
                    </Grid>
                    <Grid x:Name="formChiTietSP" IsEnabled="False">
                        <StackPanel>
                            <Grid Margin="0,0,0,15">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <Border Grid.Column="0" BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="1" Width="140" Height="140" Background="{StaticResource SubtleGrayBrush}">
                                    <Image x:Name="AnhSanPhamPreview" Style="{StaticResource ProductImage}"/>
                                </Border>

                                <StackPanel Grid.Column="1" VerticalAlignment="Bottom" Orientation="Horizontal" Margin="15,0,0,0">
                                    <Button x:Name="btnChonAnh" 
                                            Style="{StaticResource ActionButton}" Background="#F5F5F5" 
                                            BorderBrush="#E0E0E0" Foreground="{StaticResource DarkBrownBrush}"
                                            Click="BtnChonAnh_Click">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconUpload}" Fill="{StaticResource DarkBrownBrush}" Width="23" Height="23" Margin="0,0,8,0"/>
                                            <TextBlock Text="Chá»n áº£nh" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>

                                    <Button x:Name="btnXoaAnh" 
                                            Style="{StaticResource DeleteButton}" 
                                            Margin="10,0,0,0" 
                                            Click="BtnXoaAnh_Click">
                                        <StackPanel Orientation="Horizontal">
                                            <Path Data="{StaticResource IconDelete}" Fill="White" Width="20" Height="20" Margin="0,0,8,0"/>
                                            <TextBlock Text="XÃ³a áº£nh" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                            </Grid>

                            <Label Content="TÃªn Sáº£n Pháº©m (*)"/>
                            <TextBox x:Name="txtTenSanPham"/>
                            <Label Content="Danh Má»¥c (*)"/>
                            <ComboBox x:Name="cmbDanhMuc" DisplayMemberPath="Ten" SelectedValuePath="Id" 
                                      IsEditable="True" IsTextSearchEnabled="True"/>
                            <Label Content="ÄÆ¡n GiÃ¡ (*)"/>
                            <TextBox x:Name="txtDonGia"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0" Margin="0,0,10,0">
                                    <Label Content="NhÃ³m In (Bar/Báº¿p)"/>
                                    <ComboBox x:Name="cmbNhomIn" IsEditable="True">
                                        <ComboBoxItem Content="Bar"/>
                                        <ComboBoxItem Content="Báº¿p"/>
                                        <ComboBoxItem Content="KhÃ¡c"/>
                                    </ComboBox>
                                </StackPanel>
                                <StackPanel Grid.Column="1" Margin="10,0,0,0">
                                    <Label Content="Tráº¡ng thÃ¡i"/>
                                    <ComboBox x:Name="cmbTrangThai">
                                        <ComboBoxItem Content="Äang bÃ¡n" Tag="True" IsSelected="True"/>
                                        <ComboBoxItem Content="Táº¡m ngÆ°ng" Tag="False"/>
                                    </ComboBox>
                                </StackPanel>
                            </Grid>
                            <Label Content="MÃ´ táº£"/>
                            <TextBox x:Name="txtMoTa" Height="100" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"/>
                        </StackPanel>
                    </Grid>
                    <StackPanel x:Name="panelActions" Orientation="Horizontal" Margin="0,25,0,0">
                        <Button x:Name="btnLuu" Click="BtnLuu_Click" Margin="0,0,10,0" Style="{StaticResource ActionButton}" Background="{StaticResource SuccessBrush}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconSave}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="LÆ°u Sáº£n Pháº©m" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        <Button x:Name="btnXoa" Click="BtnXoa_Click" Margin="0,0,10,0" Style="{StaticResource DeleteButton}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconDelete}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="XÃ³a" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                    <Border x:Name="LoadingOverlay" Background="#80FFFFFF" Visibility="Collapsed"
                            Grid.RowSpan="2" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                        <TextBlock Text="Äang xá»­ lÃ½..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
                    </Border>
                </StackPanel>
            </ScrollViewer>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLySanPhamView.xaml.cs
// Táº­p tin: AppCafebookApi/View/quanly/pages/QuanLySanPhamView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using Microsoft.Win32;
using System.IO; // <-- ThÃªm
using AppCafebookApi.Services;
using CafebookModel.Utils;
using AppCafebookApi.View.common;
using System.Globalization;
using OfficeOpenXml;
using CafebookModel.Model.Entities;
using System.Net.Http.Headers; // <-- ThÃªm

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLySanPhamView : Page
    {
        private static readonly HttpClient httpClient;
        private List<SanPhamDto> _allSanPhamList = new List<SanPhamDto>();

        private SanPhamDetailDto? _selectedSanPhamDetails = null;

        // Sá»¬A: ÄÃ£ xÃ³a Base64, dÃ¹ng 2 biáº¿n nÃ y Ä‘á»ƒ quáº£n lÃ½ file upload
        private string? _currentAnhBiaFilePath = null; // LÆ°u Ä‘Æ°á»ng dáº«n file cá»¥c bá»™
        private bool _deleteImageRequest = false;     // ÄÃ¡nh dáº¥u yÃªu cáº§u xÃ³a áº£nh

        // Cache (Giá»¯ nguyÃªn)
        private List<FilterLookupDto> _danhMucList = new List<FilterLookupDto>();
        private List<FilterLookupDto> _nguyenLieuList = new List<FilterLookupDto>();
        private List<DonViChuyenDoiDto> _donViTinhList = new List<DonViChuyenDoiDto>();

        static QuanLySanPhamView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://127.0.0.1:5166")
            };
        }

        public QuanLySanPhamView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadFiltersAsync();
            await LoadDataGridAsync();
            ResetForm();
            ResetDanhMucForm();
            ResetDinhLuongForm();
        }

        #region 1. Táº£i Dá»¯ Liá»‡u (Sáº£n Pháº©m, Lá»c, Äá»‹nh LÆ°á»£ng)

        // (HÃ m LoadFiltersAsync giá»¯ nguyÃªn)
        private async Task LoadFiltersAsync()
        {
            try
            {
                var filters = await httpClient.GetFromJsonAsync<SanPhamFiltersDto>("api/app/sanpham/filters");
                if (filters != null)
                {
                    _danhMucList = filters.DanhMucs;
                    _nguyenLieuList = filters.NguyenLieus;
                    _donViTinhList = filters.DonViTinhs;
                    var filterDanhMuc = new List<FilterLookupDto>(_danhMucList);
                    filterDanhMuc.Insert(0, new FilterLookupDto { Id = 0, Ten = "Táº¥t cáº£ Danh má»¥c" });
                    cmbFilterDanhMuc.ItemsSource = filterDanhMuc;
                    if (cmbFilterDanhMuc.SelectedValue == null) cmbFilterDanhMuc.SelectedValue = 0;
                    if (cmbFilterTrangThai.SelectedValue == null) cmbFilterTrangThai.SelectedIndex = 0;
                    lbDanhMuc.ItemsSource = _danhMucList;
                    var nlList = new List<FilterLookupDto>(_nguyenLieuList);
                    nlList.Insert(0, new FilterLookupDto { Id = 0, Ten = "-- Chá»n NguyÃªn Liá»‡u --" });
                    cmbNguyenLieu.ItemsSource = nlList;
                    var formDanhMuc = new List<FilterLookupDto>(_danhMucList);
                    formDanhMuc.Insert(0, new FilterLookupDto { Id = 0, Ten = "-- Chá»n Danh má»¥c --" });
                    cmbDanhMuc.ItemsSource = formDanhMuc;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i bá»™ lá»c: {ex.Message}", "Lá»—i API");
            }
        }

        // (HÃ m LoadDataGridAsync giá»¯ nguyÃªn)
        private async Task LoadDataGridAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            string searchText = txtSearchSanPham.Text;
            int danhMucId = (int)(cmbFilterDanhMuc.SelectedValue ?? 0);
            bool? trangThai = (cmbFilterTrangThai.SelectedItem as ComboBoxItem)?.Tag as bool?;
            try
            {
                var url = $"api/app/sanpham/search?searchText={Uri.EscapeDataString(searchText)}&danhMucId={danhMucId}";
                if (trangThai.HasValue)
                {
                    url += $"&trangThai={trangThai.Value}";
                }
                _allSanPhamList = (await httpClient.GetFromJsonAsync<List<SanPhamDto>>(url)) ?? new List<SanPhamDto>();
                dgSanPham.ItemsSource = _allSanPhamList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i danh sÃ¡ch sáº£n pháº©m: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        // (HÃ m LoadDinhLuongGridAsync giá»¯ nguyÃªn)
        private async Task LoadDinhLuongGridAsync(int idSanPham)
        {
            if (idSanPham == 0)
            {
                panelDinhLuong.Visibility = Visibility.Collapsed;
                lblDinhLuongInfo.Visibility = Visibility.Visible;
                return;
            }
            try
            {
                var data = await httpClient.GetFromJsonAsync<List<DinhLuongDto>>($"api/app/sanpham/{idSanPham}/dinhluong");
                dgDinhLuong.ItemsSource = data;
                lblDinhLuongTitle.Text = $"Äá»‹nh lÆ°á»£ng cho: {_selectedSanPhamDetails?.TenSanPham}";
                panelDinhLuong.Visibility = Visibility.Visible;
                lblDinhLuongInfo.Visibility = Visibility.Collapsed;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i Ä‘á»‹nh lÆ°á»£ng: {ex.Message}", "Lá»—i API");
            }
        }

        #endregion

        #region 2. Form Chi Tiáº¿t (Sáº£n Pháº©m)

        private void ResetForm()
        {
            _selectedSanPhamDetails = null;

            // Sá»¬A: Äáº·t láº¡i 2 biáº¿n quáº£n lÃ½ file
            _currentAnhBiaFilePath = null;
            _deleteImageRequest = false;

            dgSanPham.SelectedItem = null;
            formChiTietSP.IsEnabled = true;
            panelActions.Visibility = Visibility.Visible;
            btnXoa.Visibility = Visibility.Collapsed;
            lblFormTitle.Text = "ThÃªm Sáº£n Pháº©m Má»›i";
            txtTenSanPham.Text = "";
            txtDonGia.Text = "0";
            txtMoTa.Text = "";
            cmbDanhMuc.SelectedValue = 0;
            cmbDanhMuc.Text = string.Empty;
            cmbNhomIn.SelectedIndex = 0; // "Bar"
            cmbTrangThai.SelectedIndex = 0; // "Äang bÃ¡n"

            // Sá»¬A: DÃ¹ng HinhAnhHelper.LoadImage (vá»›i nguá»“n null)
            AnhSanPhamPreview.Source = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultFoodIcon);

            panelDinhLuong.Visibility = Visibility.Collapsed;
            lblDinhLuongInfo.Visibility = Visibility.Visible;
            dgDinhLuong.ItemsSource = null;
        }

        private async void DgSanPham_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgSanPham.SelectedItem is not SanPhamDto selected)
            {
                ResetForm();
                return;
            }
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                _selectedSanPhamDetails = await httpClient.GetFromJsonAsync<SanPhamDetailDto>($"api/app/sanpham/details/{selected.IdSanPham}");

                if (_selectedSanPhamDetails == null)
                {
                    ResetForm();
                    return;
                }

                // Sá»¬A: Äáº·t láº¡i 2 biáº¿n quáº£n lÃ½ file
                _currentAnhBiaFilePath = null;
                _deleteImageRequest = false;

                formChiTietSP.IsEnabled = true;
                panelActions.Visibility = Visibility.Visible;
                btnXoa.Visibility = Visibility.Visible;
                lblFormTitle.Text = $"Cáº­p nháº­t: {_selectedSanPhamDetails.TenSanPham}";
                txtTenSanPham.Text = _selectedSanPhamDetails.TenSanPham;
                txtDonGia.Text = _selectedSanPhamDetails.GiaBan.ToString("F0");
                txtMoTa.Text = _selectedSanPhamDetails.MoTa;
                cmbDanhMuc.SelectedValue = _selectedSanPhamDetails.IdDanhMuc ?? 0;
                cmbNhomIn.Text = _selectedSanPhamDetails.NhomIn;
                cmbTrangThai.SelectedIndex = _selectedSanPhamDetails.TrangThaiKinhDoanh ? 0 : 1;

                // Sá»¬A: DÃ¹ng HinhAnhHelper.LoadImage vá»›i URL
                AnhSanPhamPreview.Source = HinhAnhHelper.LoadImage(_selectedSanPhamDetails.HinhAnhUrl, HinhAnhPaths.DefaultFoodIcon);
                await LoadDinhLuongGridAsync(_selectedSanPhamDetails.IdSanPham);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i chi tiáº¿t sáº£n pháº©m: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnChonAnh_Click(object sender, RoutedEventArgs e)
        {
            var ofd = new OpenFileDialog { Filter = "Image files|*.png;*.jpg;*.jpeg", Title = "Chá»n áº£nh sáº£n pháº©m" };
            if (ofd.ShowDialog() == true)
            {
                try
                {
                    // Sá»¬A: Chá»‰ lÆ°u Ä‘Æ°á»ng dáº«n file vÃ  Ä‘Ã¡nh dáº¥u
                    _currentAnhBiaFilePath = ofd.FileName;
                    _deleteImageRequest = false; // ÄÃ£ chá»n file má»›i, khÃ´ng xÃ³a

                    // Sá»¬A: DÃ¹ng HinhAnhHelper.LoadImage (nÃ³ tá»± nháº­n diá»‡n Ä‘Æ°á»ng dáº«n file)
                    AnhSanPhamPreview.Source = HinhAnhHelper.LoadImage(_currentAnhBiaFilePath, HinhAnhPaths.DefaultFoodIcon);
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Lá»—i Ä‘á»c file áº£nh: {ex.Message}", "Lá»—i File");
                    _currentAnhBiaFilePath = null;
                    AnhSanPhamPreview.Source = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultFoodIcon);
                }
            }
        }

        // THÃŠM: NÃºt XÃ³a áº¢nh
        private void BtnXoaAnh_Click(object sender, RoutedEventArgs e)
        {
            _currentAnhBiaFilePath = null; // XÃ³a Ä‘Æ°á»ng dáº«n file
            _deleteImageRequest = true;   // ÄÃ¡nh dáº¥u yÃªu cáº§u xÃ³a
            AnhSanPhamPreview.Source = HinhAnhHelper.LoadImage(null, HinhAnhPaths.DefaultFoodIcon); // Hiá»ƒn thá»‹ áº£nh máº·c Ä‘á»‹nh
        }

        // Sá»¬A: VIáº¾T Láº I HOÃ€N TOÃ€N HÃ€M LÆ¯U
        private async void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            // (Pháº§n validation giá»¯ nguyÃªn)
            if (string.IsNullOrWhiteSpace(txtTenSanPham.Text))
            {
                MessageBox.Show("TÃªn sáº£n pháº©m khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.", "Lá»—i"); return;
            }
            if (!decimal.TryParse(txtDonGia.Text, out decimal donGia) || donGia < 0)
            {
                MessageBox.Show("ÄÆ¡n giÃ¡ khÃ´ng há»£p lá»‡.", "Lá»—i"); return;
            }
            if (string.IsNullOrWhiteSpace(cmbDanhMuc.Text) || ((int?)cmbDanhMuc.SelectedValue ?? 0) == 0 && !(_danhMucList.Any(d => d.Ten.Equals(cmbDanhMuc.Text, StringComparison.OrdinalIgnoreCase))))
            {
                MessageBox.Show("Vui lÃ²ng chá»n hoáº·c nháº­p má»™t danh má»¥c há»£p lá»‡.", "Lá»—i"); return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                int? danhMucId = await GetOrCreateLookupIdAsync(cmbDanhMuc.Text, _danhMucList, "api/app/sanpham/danhmuc", true);
                if (danhMucId == null)
                {
                    LoadingOverlay.Visibility = Visibility.Collapsed;
                    return;
                }

                // Sá»¬A: DÃ¹ng MultipartFormDataContent thay vÃ¬ DTO
                using var form = new MultipartFormDataContent();

                // 1. ThÃªm cÃ¡c trÆ°á»ng dá»¯ liá»‡u (giá»‘ng tÃªn thuá»™c tÃ­nh DTO)
                form.Add(new StringContent(txtTenSanPham.Text), "TenSanPham");
                if (danhMucId.HasValue)
                    form.Add(new StringContent(danhMucId.Value.ToString()), "IdDanhMuc");
                form.Add(new StringContent(donGia.ToString()), "GiaBan");
                form.Add(new StringContent(txtMoTa.Text ?? ""), "MoTa");
                form.Add(new StringContent((cmbTrangThai.SelectedIndex == 0).ToString()), "TrangThaiKinhDoanh");
                form.Add(new StringContent(cmbNhomIn.Text ?? ""), "NhomIn");

                bool isCreating = (_selectedSanPhamDetails == null);

                // 2. ThÃªm file (náº¿u cÃ³)
                if (!string.IsNullOrEmpty(_currentAnhBiaFilePath))
                {
                    var fileStream = File.OpenRead(_currentAnhBiaFilePath);
                    var streamContent = new StreamContent(fileStream);
                    streamContent.Headers.ContentType = new MediaTypeHeaderValue("image/jpeg"); // Hoáº·c "image/png"
                    form.Add(streamContent, "HinhAnhUpload", Path.GetFileName(_currentAnhBiaFilePath));
                }

                // 3. ThÃªm cá» XÃ³a áº£nh (náº¿u cÃ³)
                if (_deleteImageRequest)
                {
                    form.Add(new StringContent("true"), "XoaHinhAnh");
                }

                // GÃ¡n Id náº¿u lÃ  Update
                if (!isCreating)
                {
                    form.Add(new StringContent(_selectedSanPhamDetails.IdSanPham.ToString()), "IdSanPham");
                }


                HttpResponseMessage response;

                if (isCreating)
                {
                    response = await httpClient.PostAsync("api/app/sanpham", form);
                }
                else
                {
                    response = await httpClient.PutAsync($"api/app/sanpham/{_selectedSanPhamDetails.IdSanPham}", form);
                }

                if (response.IsSuccessStatusCode)
                {
                    await LoadDataGridAsync();
                    await LoadFiltersAsync();

                    if (isCreating)
                    {
                        var newSanPham = await response.Content.ReadFromJsonAsync<SanPhamDetailDto>();
                        MessageBox.Show($"Sáº£n pháº©m '{newSanPham.TenSanPham}' Ä‘Ã£ Ä‘Æ°á»£c táº¡o.\n\nVUI LÃ’NG THÃŠM Äá»ŠNH LÆ¯á»¢NG NGUYÃŠN LIá»†U.", "ThÃªm Äá»‹nh LÆ°á»£ng");

                        var newItemInGrid = _allSanPhamList.FirstOrDefault(s => s.IdSanPham == newSanPham.IdSanPham);
                        dgSanPham.SelectedItem = newItemInGrid;
                        MainTabControl.SelectedIndex = 2;
                    }
                    else // Cáº¬P NHáº¬T
                    {
                        MessageBox.Show("LÆ°u thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    }
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
                // Sá»¬A: Äáº·t láº¡i 2 biáº¿n quáº£n lÃ½ file
                _currentAnhBiaFilePath = null;
                _deleteImageRequest = false;
            }
        }

        private async void BtnXoa_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedSanPhamDetails == null) return;
            var result = MessageBox.Show($"Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a '{_selectedSanPhamDetails.TenSanPham}'?", "XÃ¡c nháº­n", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/sanpham/{_selectedSanPhamDetails.IdSanPham}");
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("XÃ³a thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadDataGridAsync();
                    ResetForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnLamMoiForm_Click(object sender, RoutedEventArgs e)
        {
            ResetForm();
        }
        // ... (BtnXoa_Click, BtnLamMoiForm giá»¯ nguyÃªn) ...
        #endregion

        // ... (ToÃ n bá»™ cÃ¡c Region 3, 4, 5, 6 giá»¯ nguyÃªn) ...
        // (CÃ¡c hÃ m Tab Danh Má»¥c vÃ  Tab Äá»‹nh LÆ°á»£ng giá»¯ nguyÃªn)
        #region 3. Lá»c / TÃ¬m kiáº¿m / Excel
        private async void Filter_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (cmbFilterDanhMuc.IsLoaded && cmbFilterTrangThai.IsLoaded)
            {
                await LoadDataGridAsync();
            }
        }
        private async void TxtSearchSanPham_TextChanged(object sender, TextChangedEventArgs e)
        {
            await LoadDataGridAsync();
        }
        private async void BtnClearFilter_Click(object sender, RoutedEventArgs e)
        {
            txtSearchSanPham.Text = "";
            cmbFilterDanhMuc.SelectedValue = 0;
            cmbFilterTrangThai.SelectedIndex = 0;
            await LoadDataGridAsync();
        }
        private void BtnExportToExcel_Click(object sender, RoutedEventArgs e)
        {
            var sfd = new SaveFileDialog { Filter = "Excel Files (*.xlsx)|*.xlsx", FileName = $"DSSP_{DateTime.Now:yyyyMMdd_HHmm}.xlsx" };
            if (sfd.ShowDialog() == true)
            {
                try
                {
                    ExcelPackage.License.SetNonCommercialPersonal("CafeBook");
                    using (var package = new ExcelPackage(new FileInfo(sfd.FileName)))
                    {
                        var ws = package.Workbook.Worksheets.Add("DanhSachSanPham");
                        ws.Cells["A1"].Value = "Danh sÃ¡ch Sáº£n pháº©m";
                        ws.Cells["A1:D1"].Merge = true;
                        ws.Cells["A1"].Style.Font.Bold = true;
                        ws.Cells["A1"].Style.Font.Size = 16;
                        ws.Cells["A3"].LoadFromCollection(_allSanPhamList, true, OfficeOpenXml.Table.TableStyles.Medium9);
                        ws.Column(3).Style.Numberformat.Format = "#,##0 \"Ä‘\"";
                        ws.Cells[ws.Dimension.Address].AutoFitColumns();
                        package.Save();
                    }
                    MessageBox.Show("Xuáº¥t Excel thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Lá»—i khi xuáº¥t Excel: {ex.Message}", "Lá»—i");
                }
            }
        }
        #endregion
        #region 4. Tab Quáº£n lÃ½ Danh má»¥c (CRUD Danh Má»¥c)
        private void ResetDanhMucForm()
        {
            txtTenDanhMuc.Text = "";
            lbDanhMuc.SelectedItem = null;
        }
        private void LbDanhMuc_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (lbDanhMuc.SelectedItem is FilterLookupDto selected)
            {
                txtTenDanhMuc.Text = selected.Ten;
            }
        }
        private async void BtnThemDanhMuc_Click(object sender, RoutedEventArgs e)
        {
            await CrudLookupAsync("api/app/sanpham/danhmuc", null, txtTenDanhMuc.Text, false, true);
        }
        private async void BtnLuuDanhMuc_Click(object sender, RoutedEventArgs e)
        {
            if (lbDanhMuc.SelectedItem is FilterLookupDto selected)
            {
                await CrudLookupAsync($"api/app/sanpham/danhmuc/{selected.Id}", selected.Id, txtTenDanhMuc.Text, false, true);
            }
        }
        private async void BtnXoaDanhMuc_Click(object sender, RoutedEventArgs e)
        {
            if (lbDanhMuc.SelectedItem is FilterLookupDto selected)
            {
                await CrudLookupAsync($"api/app/sanpham/danhmuc/{selected.Id}", selected.Id, null, true, true);
            }
        }
        #endregion
        #region 5. Tab Äá»‹nh LÆ°á»£ng
        private void ResetDinhLuongForm()
        {
            cmbNguyenLieu.SelectedValue = 0;
            txtSoLuongNL.Text = "0";
            cmbDonViTinhNL.ItemsSource = null;
        }
        private void CmbNguyenLieu_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            int selectedNLId = 0;
            if (cmbNguyenLieu.SelectedItem is FilterLookupDto selectedNL)
            {
                selectedNLId = selectedNL.Id;
            }
            else if (!string.IsNullOrEmpty(cmbNguyenLieu.Text))
            {
                var matchedNL = _nguyenLieuList.FirstOrDefault(nl => nl.Ten.Equals(cmbNguyenLieu.Text, StringComparison.OrdinalIgnoreCase));
                if (matchedNL != null)
                {
                    selectedNLId = matchedNL.Id;
                }
            }
            if (selectedNLId > 0)
            {
                var dvtChoNL = _donViTinhList.Where(d => d.IdNguyenLieu == selectedNLId).ToList();
                cmbDonViTinhNL.ItemsSource = dvtChoNL;
                if (dvtChoNL.Any())
                {
                    cmbDonViTinhNL.SelectedIndex = 0;
                }
            }
            else
            {
                cmbDonViTinhNL.ItemsSource = null;
            }
        }
        private void DgDinhLuong_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgDinhLuong.SelectedItem is DinhLuongDto selected)
            {
                cmbNguyenLieu.SelectedValue = selected.IdNguyenLieu;
                cmbDonViTinhNL.SelectedValue = selected.IdDonViSuDung;
                txtSoLuongNL.Text = selected.SoLuong.ToString(CultureInfo.InvariantCulture);
            }
        }
        private async void BtnLuuDinhLuong_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedSanPhamDetails == null) return;
            if (cmbNguyenLieu.SelectedValue == null || (int)cmbNguyenLieu.SelectedValue == 0)
            {
                MessageBox.Show("Vui lÃ²ng chá»n má»™t nguyÃªn liá»‡u.", "Lá»—i"); return;
            }
            if (cmbDonViTinhNL.SelectedValue == null)
            {
                MessageBox.Show("Vui lÃ²ng chá»n Ä‘Æ¡n vá»‹ tÃ­nh.", "Lá»—i"); return;
            }
            if (!decimal.TryParse(txtSoLuongNL.Text, NumberStyles.Any, CultureInfo.InvariantCulture, out decimal soLuong) || soLuong <= 0)
            {
                MessageBox.Show("Sá»‘ lÆ°á»£ng pháº£i lÃ  sá»‘ dÆ°Æ¡ng.", "Lá»—i"); return;
            }
            var dto = new DinhLuongUpdateRequestDto
            {
                IdSanPham = _selectedSanPhamDetails.IdSanPham,
                IdNguyenLieu = (int)cmbNguyenLieu.SelectedValue,
                IdDonViSuDung = (int)cmbDonViTinhNL.SelectedValue,
                SoLuong = soLuong
            };
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/sanpham/dinhluong", dto);
                if (response.IsSuccessStatusCode)
                {
                    await LoadDinhLuongGridAsync(dto.IdSanPham);
                    ResetDinhLuongForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }
        private async void BtnXoaDinhLuong_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedSanPhamDetails == null) return;
            if (dgDinhLuong.SelectedItem is not DinhLuongDto selected)
            {
                MessageBox.Show("Vui lÃ²ng chá»n má»™t nguyÃªn liá»‡u tá»« danh sÃ¡ch Ä‘á»ƒ xÃ³a.", "Lá»—i"); return;
            }
            var result = MessageBox.Show($"XÃ³a '{selected.TenNguyenLieu}' khá»i cÃ´ng thá»©c?", "XÃ¡c nháº­n", MessageBoxButton.YesNo);
            if (result == MessageBoxResult.No) return;
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/sanpham/dinhluong/{_selectedSanPhamDetails.IdSanPham}/{selected.IdNguyenLieu}");
                if (response.IsSuccessStatusCode)
                {
                    await LoadDinhLuongGridAsync(_selectedSanPhamDetails.IdSanPham);
                    ResetDinhLuongForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }
        #endregion
        #region 6. Helper Functions (Smart ComboBox, CRUD)
        private async Task<int?> GetOrCreateLookupIdAsync(string tenDaNhap, List<FilterLookupDto> list, string apiEndpoint, bool isDanhMuc = false)
        {
            if (string.IsNullOrWhiteSpace(tenDaNhap) || tenDaNhap.StartsWith("--"))
            {
                if (isDanhMuc) return null;
                return null;
            }
            var item = list.FirstOrDefault(x => x.Ten.Equals(tenDaNhap, StringComparison.OrdinalIgnoreCase));
            if (item != null)
            {
                return item.Id;
            }
            try
            {
                var response = await httpClient.PostAsJsonAsync(apiEndpoint, new FilterLookupDto { Ten = tenDaNhap });
                if (response.IsSuccessStatusCode)
                {
                    var newItem = await response.Content.ReadFromJsonAsync<FilterLookupDto>();
                    if (newItem != null)
                    {
                        if (isDanhMuc) _danhMucList.Add(newItem);
                        return newItem.Id;
                    }
                    return null;
                }
                else
                {
                    MessageBox.Show($"KhÃ´ng thá»ƒ tá»± Ä‘á»™ng thÃªm '{tenDaNhap}': {await response.Content.ReadAsStringAsync()}", "Lá»—i Táº¡o Má»›i");
                    return null;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i API khi táº¡o má»›i: {ex.Message}", "Lá»—i");
                return null;
            }
        }
        private async Task CrudLookupAsync(string endpoint, int? id, string? ten, bool isDelete = false, bool isDanhMuc = false)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                HttpResponseMessage response;
                if (isDelete)
                {
                    if (MessageBox.Show("Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a?", "XÃ¡c nháº­n", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.No)
                    {
                        LoadingOverlay.Visibility = Visibility.Collapsed;
                        return;
                    }
                    response = await httpClient.DeleteAsync(endpoint);
                }
                else if (string.IsNullOrWhiteSpace(ten))
                {
                    MessageBox.Show("TÃªn khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.", "Lá»—i");
                    LoadingOverlay.Visibility = Visibility.Collapsed;
                    return;
                }
                else if (id.HasValue && id > 0) // Update (PUT)
                {
                    response = await httpClient.PutAsJsonAsync(endpoint, new FilterLookupDto { Id = id.Value, Ten = ten });
                }
                else // Create (POST)
                {
                    response = await httpClient.PostAsJsonAsync(endpoint, new FilterLookupDto { Ten = ten });
                }

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Thao tÃ¡c thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadFiltersAsync(); // Táº£i láº¡i TOÃ€N Bá»˜
                    if (isDanhMuc) ResetDanhMucForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }
        #endregion
    }
}
    
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyTonKhoView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyTonKhoView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyTonKhoView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quáº£n lÃ½ Tá»“n Kho" FontFamily="Segoe UI" Loaded="Page_Loaded"
      Background="#FFF8E1">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="StatusYellowBrush" Color="#FFF9C4"/>
        <SolidColorBrush x:Key="StatusRedBrush" Color="#FFEBEE"/>

        <Geometry x:Key="IconWarehouse">M12,3L2,8V21H22V8L12,3M19,19H15V13H9V19H5V9.4L12,5.5L19,9.4V19Z</Geometry>
        <Geometry x:Key="IconBoxIn">M16.75 9H15.25V6H9.25V9H7.75L12.25 13.5L16.75 9M19.35 15.04C19.76 14.63 20 14.11 20 13.5V6C20 4.9 19.1 4 18 4H6C4.9 4 4 4.9 4 6V13.5C4 14.11 4.24 14.63 4.65 15.04L9 19.38V22H15V19.38L19.35 15.04Z</Geometry>
        <Geometry x:Key="IconBoxOut">M5.63 15.04C5.22 14.63 5 14.11 5 13.5V6C5 4.9 5.9 4 7 4H17C18.1 4 19 4.9 19 6V13.5C19 14.11 18.78 14.63 18.37 15.04L14 19.38V22H10V19.38L5.63 15.04M8 11H9.5V14H14.5V11H16L12 6.5L8 11Z</Geometry>
        <Geometry x:Key="IconChecklist">M21,17.45V6.5C21,5.4 20.1,4.5 19,4.5H13V6.5H19V17.45L16.73,15.18L15.32,16.59L20,21.27L21.39,19.89L21,19.5V19.5L21,17.45M11,6.5H5V19.5H11V6.5M9,11.5H7V13.5H9V11.5M17,11.5H13V13.5H17V11.5M17,8.5H13V10.5H17V8.5Z</Geometry>
        <Geometry x:Key="IconSupplier">M16,13C17.7,13 21,13.9 21,15.5V17H11V15.5C11,13.9 14.3,13 16,13M8,13C9.7,13 13,13.9 13,15.5V17H3V15.5C3,13.9 6.3,13 8,13M8,11.5A3.5,3.5 0 0,0 11.5,8A3.5,3.5 0 0,0 8,4.5A3.5,3.5 0 0,0 4.5,8A3.5,3.5 0 0,0 8,11.5M16,11.5A3.5,3.5 0 0,0 19.5,8A3.5,3.5 0 0,0 16,4.5A3.5,3.5 0 0,0 12.5,8A3.5,3.5 0 0,0 16,11.5Z</Geometry>
        <Geometry x:Key="IconSettings">M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M12,22C11.6,22 11.2,21.9 10.8,21.7L9.1,20.9C5.1,19.3 2,15.2 2,10.9V5L12,2L22,5V10.9C22,15.2 18.9,19.3 14.9,20.9L13.2,21.7C12.8,21.9 12.4,22 12,22Z</Geometry>

        <Geometry x:Key="IconReport">M10,17L6,21H18L14,17H10M10,10H14V15H10V10M4,3H20C21.1,3 22,3.9 22,5V17C22,18.1 21.1,19 20,19H4C2.9,19 2,18.1 2,17V5C2,3.9 2.9,3 4,3Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="DataGridRow" x:Key="StockDataGridRowStyle">
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding TinhTrang}" Value="Háº¿t hÃ ng">
                    <Setter Property="Background" Value="{StaticResource StatusRedBrush}"/>
                    <Setter Property="Foreground" Value="{StaticResource ActionRedBrush}"/>
                    <Setter Property="FontWeight" Value="Bold"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding TinhTrang}" Value="Sáº¯p háº¿t">
                    <Setter Property="Background" Value="{StaticResource StatusYellowBrush}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <Border Grid.Row="0" Style="{StaticResource CardBorder}" Margin="0,0,0,15">
                <WrapPanel Orientation="Horizontal">
                    <Button x:Name="btnGoToTonKho" Style="{StaticResource PrimaryButton}" Margin="0,0,10,10" IsEnabled="False" Background="{StaticResource DarkBrownBrush}">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconWarehouse}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Tá»“n Kho" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <Button x:Name="btnGoToNguyenLieu" Style="{StaticResource PrimaryButton}" Margin="0,0,10,10" Click="BtnGoToNguyenLieu_Click">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconSettings}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Quáº£n lÃ½ NguyÃªn Liá»‡u" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <Button x:Name="btnGoToNhapKho" Style="{StaticResource PrimaryButton}" Margin="0,0,10,10" Click="BtnGoToNhapKho_Click">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconBoxIn}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Quáº£n lÃ½ Nháº­p Kho" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <Button x:Name="btnGoToXuatHuy" Style="{StaticResource PrimaryButton}" Margin="0,0,10,10" Click="BtnGoToXuatHuy_Click">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconBoxOut}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Quáº£n lÃ½ Xuáº¥t Há»§y" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <Button x:Name="btnGoToKiemKho" Style="{StaticResource PrimaryButton}" Margin="0,0,10,10" Click="BtnGoToKiemKho_Click">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconChecklist}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Quáº£n lÃ½ Kiá»ƒm Kho" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <Button x:Name="btnGoToNCC" Style="{StaticResource PrimaryButton}" Margin="0,0,10,10" Click="BtnGoToNCC_Click">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconSupplier}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="NhÃ  Cung Cáº¥p" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <Button x:Name="btnGoToBaoCaoKho" Style="{StaticResource PrimaryButton}" Margin="0,0,10,10" Click="BtnGoToBaoCaoKho_Click" Background="#00724C">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconReport}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                            <TextBlock Text="Xem BÃ¡o CÃ¡o Kho" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </WrapPanel>
            </Border>

            <Border Grid.Row="1" Style="{StaticResource CardBorder}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <TextBlock Grid.Row="0" Text="Táº¥t cáº£ NguyÃªn liá»‡u trong kho" Style="{StaticResource HeaderTextBlock}"/>
                    <DataGrid Grid.Row="1" x:Name="dgTonKho" AutoGenerateColumns="False" IsReadOnly="True" 
                              BorderThickness="0" RowHeaderWidth="0">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="ID" Binding="{Binding IdNguyenLieu}" Width="50"/>
                            <DataGridTextColumn Header="TÃªn NguyÃªn liá»‡u" Binding="{Binding TenNguyenLieu}" Width="*"/>
                            <DataGridTextColumn Header="Sá»‘ lÆ°á»£ng tá»“n" Binding="{Binding TonKho, StringFormat=N2}" Width="150"/>
                            <DataGridTextColumn Header="ÄÆ¡n vá»‹ tÃ­nh" Binding="{Binding DonViTinh}" Width="150"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Border>

            <GridSplitter Grid.Row="2" Height="5" HorizontalAlignment="Stretch" Background="Transparent" ResizeBehavior="PreviousAndNext"/>

            <Border Grid.Row="3" Style="{StaticResource CardBorder}" Margin="0,5,0,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <TextBlock Grid.Row="0" Text="Cáº£nh bÃ¡o Tá»“n kho tháº¥p (Tá»± Ä‘á»™ng)" Style="{StaticResource HeaderTextBlock}" Foreground="{StaticResource ActionRedBrush}"/>
                    <DataGrid Grid.Row="1" x:Name="dgCanhBao" AutoGenerateColumns="False" IsReadOnly="True" 
                              BorderThickness="0" RowHeaderWidth="0"
                              RowStyle="{StaticResource StockDataGridRowStyle}">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="ID" Binding="{Binding IdNguyenLieu}" Width="50"/>
                            <DataGridTextColumn Header="TÃªn NguyÃªn liá»‡u" Binding="{Binding TenNguyenLieu}" Width="*"/>
                            <DataGridTextColumn Header="SL Tá»“n" Binding="{Binding TonKho, StringFormat=N2}" Width="100"/>
                            <DataGridTextColumn Header="ÄVT" Binding="{Binding DonViTinh}" Width="80"/>
                            <DataGridTextColumn Header="NgÆ°á»¡ng" Binding="{Binding TonKhoToiThieu, StringFormat=N2}" Width="100"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Border>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Äang táº£i..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyTonKhoView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using AppCafebookApi.View.common; // <-- THÃŠM Má»šI

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyTonKhoView : Page
    {
        private static readonly HttpClient httpClient;
        private List<NguyenLieuTonKhoDto> _tonKhoList = new List<NguyenLieuTonKhoDto>();

        static QuanLyTonKhoView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyTonKhoView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadTonKhoAsync();
        }

        private async Task LoadTonKhoAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                _tonKhoList = (await httpClient.GetFromJsonAsync<List<NguyenLieuTonKhoDto>>("api/app/kho/tonkho")) ?? new List<NguyenLieuTonKhoDto>();

                dgTonKho.ItemsSource = _tonKhoList.Where(nl => nl.TinhTrang == "Äá»§ dÃ¹ng").ToList();
                dgCanhBao.ItemsSource = _tonKhoList.Where(nl => nl.TinhTrang == "Sáº¯p háº¿t" || nl.TinhTrang == "Háº¿t hÃ ng").ToList();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i tá»“n kho: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #region Navigation

        private void BtnGoToNguyenLieu_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new QuanLyNguyenLieuView());
        }

        private void BtnGoToNhapKho_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new QuanLyNhapKhoView());
        }

        private void BtnGoToXuatHuy_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new QuanLyXuatHuyView());
        }

        private void BtnGoToKiemKho_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new QuanLyKiemKhoView());
        }

        private void BtnGoToNCC_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new QuanLyNhaCungCapView());
        }

        // --- THÃŠM Má»šI: Xá»­ lÃ½ nÃºt BÃ¡o CÃ¡o ---
        private void BtnGoToBaoCaoKho_Click(object sender, RoutedEventArgs e)
        {
            this.NavigationService?.Navigate(new BaoCaoTonKhoNguyenLieuPreviewWindow());
        }

        #endregion
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyVaiTroView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyVaiTroView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyVaiTroView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quáº£n lÃ½ Vai trÃ²"
      FontFamily="Segoe UI"
      Background="#FFF8E1"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ErrorBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>
        
        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconDelete">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4M6,19C6,20.1 6.9,21 8,21H16C17.1,21 18,20.1 18,19V7H6V19Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>
        <Geometry x:Key="IconPermissions">M12,3L1,9L12,15L23,9L12,3M19,9.3L19,16.6C19,17.2 18.7,17.8 18.2,18.1L12,22L5.8,18.1C5.3,17.8 5,17.2 5,16.6V9.3L12,13.2L19,9.3Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10">
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Quáº£n lÃ½ Vai TrÃ² &amp; PhÃ¢n Quyá»n" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="350"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Margin="10,0,15,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Text="Danh sÃ¡ch Vai trÃ²" Style="{StaticResource HeaderTextBlock}"/>
                        <DataGrid Grid.Row="1" x:Name="dgVaiTro" AutoGenerateColumns="False" IsReadOnly="True" 
                                  SelectionMode="Single" SelectionChanged="DgVaiTro_SelectionChanged"
                                  BorderThickness="0" RowHeaderWidth="0">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ID" Binding="{Binding IdVaiTro}" Width="50"/>
                                <DataGridTextColumn Header="TÃªn Vai TrÃ²" Binding="{Binding TenVaiTro}" Width="*"/>
                                <DataGridTextColumn Header="MÃ´ Táº£" Binding="{Binding MoTa}" Width="2*"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>

                <Border Grid.Column="1" Margin="0,0,10,10" Style="{StaticResource CardBorder}">
                    <StackPanel>
                        <TextBlock Text="ThÃ´ng tin Vai trÃ²" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,15"/>

                        <TextBlock Text="TÃªn Vai TrÃ²:" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtTenVaiTro" Margin="0,0,0,10"/>

                        <TextBlock Text="MÃ´ táº£:" Margin="0,0,0,5"/>
                        <TextBox x:Name="txtMoTa" Margin="0,0,0,15" Height="80" TextWrapping="Wrap" AcceptsReturn="True"/>

                        <Grid Height="40">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Button x:Name="btnLamMoi" Grid.Column="0" ToolTip="LÃ m má»›i" Click="BtnLamMoi_Click" Background="Transparent" BorderThickness="0">
                                <Path Data="{StaticResource IconNew}" Fill="{StaticResource TextGrayBrush}" Width="22" Height="22"/>
                            </Button>
                            <Button x:Name="btnThem" Grid.Column="1" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionGreenBrush}" Click="BtnThem_Click" Margin="10,0,5,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconAdd}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="ThÃªm" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                            <Button x:Name="btnLuu" Grid.Column="2" Style="{StaticResource PrimaryButton}" Click="BtnLuu_Click" Margin="5,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconSave}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="LÆ°u" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                            <Button x:Name="btnXoa" Grid.Column="3" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionRedBrush}" Click="BtnXoa_Click" Margin="5,0,0,0">
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                        <Path Data="{StaticResource IconDelete}" Fill="White"/>
                                    </Viewbox>
                                    <TextBlock Text="XÃ³a" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </Grid>

                        <Button x:Name="btnGoToPhanQuyen" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionBlueBrush}" 
                                Click="BtnGoToPhanQuyen_Click" Margin="0,20,0,0">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconPermissions}" Fill="White" Width="23" Height="23" Margin="0,0,8,0"/>
                                <TextBlock Text="PhÃ¢n Quyá»n Chá»©c NÄƒng (ChÆ°a cÃ³)" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Border>
            </Grid>

            <Button x:Name="btnQuayLai" Grid.Row="2" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" Margin="10,0,0,10"
                    Click="BtnQuayLai_Click">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                    <TextBlock Text="Quay láº¡i" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Äang táº£i..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyVaiTroView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyVaiTroView : Page
    {
        private static readonly HttpClient httpClient;
        private List<VaiTroDto> _allVaiTroList = new List<VaiTroDto>();
        private VaiTroDto? _selectedVaiTro = null;

        static QuanLyVaiTroView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyVaiTroView()
        {
            InitializeComponent();
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadDataGridAsync();
            ResetForm();
        }

        private async Task LoadDataGridAsync()
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                _allVaiTroList = (await httpClient.GetFromJsonAsync<List<VaiTroDto>>("api/app/vaitro/all")) ?? new List<VaiTroDto>();
                dgVaiTro.ItemsSource = _allVaiTroList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i danh sÃ¡ch vai trÃ²: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void ResetForm()
        {
            _selectedVaiTro = null;
            dgVaiTro.SelectedItem = null;
            txtTenVaiTro.Text = "";
            txtMoTa.Text = "";
            btnThem.IsEnabled = true;
            btnLuu.IsEnabled = false;
            btnXoa.IsEnabled = false;
        }

        private void DgVaiTro_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgVaiTro.SelectedItem is VaiTroDto selected)
            {
                _selectedVaiTro = selected;
                txtTenVaiTro.Text = selected.TenVaiTro;
                txtMoTa.Text = selected.MoTa;
                btnThem.IsEnabled = false;
                btnLuu.IsEnabled = true;
                btnXoa.IsEnabled = true;
            }
            else
            {
                ResetForm();
            }
        }

        private async void BtnThem_Click(object sender, RoutedEventArgs e)
        {
            await SaveAsync(isCreating: true);
        }

        private async void BtnLuu_Click(object sender, RoutedEventArgs e)
        {
            await SaveAsync(isCreating: false);
        }

        private async Task SaveAsync(bool isCreating)
        {
            if (string.IsNullOrWhiteSpace(txtTenVaiTro.Text))
            {
                MessageBox.Show("TÃªn vai trÃ² lÃ  báº¯t buá»™c.", "Lá»—i"); return;
            }

            var dto = new VaiTroDto
            {
                TenVaiTro = txtTenVaiTro.Text,
                MoTa = txtMoTa.Text
            };

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                HttpResponseMessage response;
                if (isCreating)
                {
                    response = await httpClient.PostAsJsonAsync("api/app/vaitro", dto);
                }
                else
                {
                    dto.IdVaiTro = _selectedVaiTro.IdVaiTro;
                    response = await httpClient.PutAsJsonAsync($"api/app/vaitro/{dto.IdVaiTro}", dto);
                }

                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("LÆ°u thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadDataGridAsync();
                    ResetForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private async void BtnXoa_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedVaiTro == null) return;

            var result = MessageBox.Show($"Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a vai trÃ² '{_selectedVaiTro.TenVaiTro}'?", "XÃ¡c nháº­n", MessageBoxButton.YesNo, MessageBoxImage.Warning);
            if (result == MessageBoxResult.No) return;

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.DeleteAsync($"api/app/vaitro/{_selectedVaiTro.IdVaiTro}");
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("XÃ³a thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadDataGridAsync();
                    ResetForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "KhÃ´ng thá»ƒ xÃ³a");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnLamMoi_Click(object sender, RoutedEventArgs e)
        {
            ResetForm();
        }

        private void BtnGoToPhanQuyen_Click(object sender, RoutedEventArgs e)
        {
            // Chuyá»ƒn sang trang PhÃ¢n Quyá»n
            this.NavigationService?.Navigate(new PhanQuyenView());
        }

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService != null && this.NavigationService.CanGoBack)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyXuatHuyView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyXuatHuyView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.QuanLyXuatHuyView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="Quáº£n lÃ½ Xuáº¥t Há»§y" FontFamily="Segoe UI" Loaded="Page_Loaded"
      Background="#FFF8E1">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionRedBrush" Color="#EF5350"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>

        <Geometry x:Key="IconNew">M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z</Geometry>
        <Geometry x:Key="IconAdd">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</Geometry>
        <Geometry x:Key="IconSave">M17,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V7L17,3M15,9H5V5H15V9M12,19C10.34,19 9,17.66 9,16C9,14.34 10.34,13 12,13C13.66,13 15,14.34 15,16C15,17.66 13.66,19 12,19Z</Geometry>
        <Geometry x:Key="IconBack">M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z</Geometry>

        <Style x:Key="HeaderTextBlock" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="BackButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrownBrush}"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style x:Key="MaterialInput" TargetType="Control">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="8,5"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrownBrush}"/>
                    <Setter Property="BorderThickness" Value="0,0,0,2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialInput}"/>
        <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialInput}"/>
    </Page.Resources>

    <Grid Background="{StaticResource LightCreamBrush}" x:Name="MainPanel" Margin="10" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
        </Grid.Triggers>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Quáº£n lÃ½ Xuáº¥t Há»§y NguyÃªn Liá»‡u" Style="{StaticResource HeaderTextBlock}" Margin="10,10,0,0"/>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*"/>
                    <ColumnDefinition Width="3*"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Margin="10,0,15,10" Style="{StaticResource CardBorder}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Text="Lá»‹ch sá»­ Phiáº¿u Xuáº¥t Há»§y" Style="{StaticResource HeaderTextBlock}"/>

                        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,10">
                            <TextBlock Text="Tá»«:" VerticalAlignment="Center"/>
                            <DatePicker x:Name="dpTuNgay_Phieu" Width="120" Margin="5,0,0,0"/>
                            <TextBlock Text="Äáº¿n:" VerticalAlignment="Center" Margin="10,0,5,0"/>
                            <DatePicker x:Name="dpDenNgay_Phieu" Width="120" Margin="0,0,10,0"/>
                            <Button x:Name="btnLocPhieu" Content="Lá»c" Style="{StaticResource PrimaryButton}" Padding="10,5" Width="50" Click="BtnLocPhieu_Click"/>
                        </StackPanel>

                        <DataGrid Grid.Row="2" x:Name="dgPhieuXuatHuy" AutoGenerateColumns="False" IsReadOnly="True" 
                                  SelectionMode="Single" SelectionChanged="DgPhieuXuatHuy_SelectionChanged" 
                                  BorderThickness="0" RowHeaderWidth="0">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ID" Binding="{Binding IdPhieuXuatHuy}" Width="40"/>
                                <DataGridTextColumn Header="NgÃ y Há»§y" Binding="{Binding NgayXuatHuy, StringFormat='dd/MM/yyyy'}" Width="100"/>
                                <DataGridTextColumn Header="NgÆ°á»i Láº­p" Binding="{Binding TenNhanVien}" Width="*"/>
                                <DataGridTextColumn Header="GiÃ¡ Trá»‹ Há»§y" Binding="{Binding TongGiaTriHuy, StringFormat=N0}" Width="100"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>

                <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto" Margin="0,0,10,10">
                    <StackPanel>
                        <Border Style="{StaticResource CardBorder}">
                            <StackPanel>
                                <Grid Margin="0,0,0,15">
                                    <TextBlock Text="ThÃ´ng tin Phiáº¿u Há»§y" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" VerticalAlignment="Center" />
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                        <Button x:Name="btnTaoPhieuMoi" Style="{StaticResource PrimaryButton}" Click="BtnTaoPhieuMoi_Click" Padding="10,8">
                                            <StackPanel Orientation="Horizontal">
                                                <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                                    <Path Data="{StaticResource IconNew}" Fill="White"/>
                                                </Viewbox>
                                                <TextBlock Text="Táº¡o Phiáº¿u Má»›i" VerticalAlignment="Center" Margin="0,1,0,0"/>
                                            </StackPanel>
                                        </Button>
                                    </StackPanel>
                                </Grid>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="NgÃ y há»§y:" VerticalAlignment="Center" Margin="0,5,15,5"/>
                                    <DatePicker Grid.Row="0" Grid.Column="1" x:Name="dpNgayHuy" Margin="0,5"/>
                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="LÃ½ do há»§y (*):" VerticalAlignment="Top" Margin="0,10,15,5"/>
                                    <TextBox Grid.Row="1" Grid.Column="1" x:Name="txtLyDoHuy" Margin="0,5" Height="60" TextWrapping="Wrap" AcceptsReturn="True"/>
                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Tá»•ng giÃ¡ trá»‹:" VerticalAlignment="Center" Margin="0,5,15,5"/>
                                    <TextBlock Grid.Row="2" Grid.Column="1" x:Name="lblTongGiaTriHuy" Margin="0,5" FontSize="16" FontWeight="Bold" Foreground="{StaticResource ActionRedBrush}" Text="0 VND"/>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <Border Style="{StaticResource CardBorder}" Margin="0,15,0,0">
                            <StackPanel>
                                <TextBlock Text="Chi tiáº¿t NguyÃªn liá»‡u Há»§y" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,0,0,10"/>
                                <DataGrid x:Name="dgChiTietPhieuHuy" AutoGenerateColumns="False" MaxHeight="250"
                                          CanUserAddRows="False" CanUserDeleteRows="True"
                                          CellEditEnding="DgChiTietPhieuHuy_CellEditEnding">
                                    <DataGrid.Columns>
                                        <DataGridComboBoxColumn Header="TÃªn NguyÃªn liá»‡u" x:Name="colNguyenLieu" 
                                                                SelectedValueBinding="{Binding IdNguyenLieu}" 
                                                                SelectedValuePath="IdNguyenLieu" 
                                                                DisplayMemberPath="TenNguyenLieu" Width="*"/>
                                        <DataGridTextColumn Header="Sá»‘ lÆ°á»£ng Há»§y" Binding="{Binding SoLuong}" Width="100"/>
                                        <DataGridTextColumn Header="GiÃ¡ trá»‹ Há»§y" Binding="{Binding ThanhTien, StringFormat=N0}" Width="120" IsReadOnly="True"/>
                                    </DataGrid.Columns>
                                </DataGrid>

                                <Button x:Name="btnThemDong" Style="{StaticResource PrimaryButton}" Margin="0,10,0,0" Padding="10,5" HorizontalAlignment="Left"
                                        Click="BtnThemDong_Click" Background="{StaticResource ActionBlueBrush}">
                                    <StackPanel Orientation="Horizontal">
                                        <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                            <Path Data="{StaticResource IconAdd}" Fill="White"/>
                                        </Viewbox>
                                        <TextBlock Text="ThÃªm DÃ²ng" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>

                                <Button x:Name="btnLuuPhieuHuy" Margin="0,15,0,0" Style="{StaticResource PrimaryButton}" Background="{StaticResource ActionGreenBrush}" Click="BtnLuuPhieuHuy_Click">
                                    <StackPanel Orientation="Horizontal">
                                        <Viewbox Width="14" Height="14" Margin="0,0,8,0">
                                            <Path Data="{StaticResource IconSave}" Fill="White"/>
                                        </Viewbox>
                                        <TextBlock Text="LÆ°u Phiáº¿u Há»§y" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </Grid>

            <Button x:Name="btnQuayLai" Grid.Row="2" 
                    Style="{StaticResource BackButton}"
                    HorizontalAlignment="Left" Margin="10,0,0,10"
                    Click="BtnQuayLai_Click">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconBack}" Fill="{StaticResource PrimaryBrownBrush}" Width="23" Height="23" Margin="0,0,5,0"/>
                    <TextBlock Text="Quay láº¡i Tá»“n Kho" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <Border x:Name="LoadingOverlay" Grid.Row="0" Grid.RowSpan="99" Background="#80FFFFFF" Visibility="Collapsed" Panel.ZIndex="100">
            <TextBlock Text="Äang táº£i..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>
        </Border>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\QuanLyXuatHuyView.xaml.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using CafebookModel.Model.ModelApp;
using System.Net;
using System.Threading.Tasks;
using System.Collections.ObjectModel;
using System.Globalization;
using AppCafebookApi.Services;

namespace AppCafebookApi.View.quanly.pages
{
    public partial class QuanLyXuatHuyView : Page
    {
        private static readonly HttpClient httpClient;

        private List<PhieuXuatHuyDto> _phieuXuatHuyList = new List<PhieuXuatHuyDto>();
        private ObservableCollection<ChiTietPhieuXuatHuyDto> _chiTietPhieuHuyList = new ObservableCollection<ChiTietPhieuXuatHuyDto>();
        private bool _isCreatingPhieuHuy = false;

        // Cache
        private List<NguyenLieuCrudDto> _nguyenLieuList = new List<NguyenLieuCrudDto>(); // DÃ¹ng cho ComboBox

        static QuanLyXuatHuyView()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public QuanLyXuatHuyView()
        {
            InitializeComponent();
            dpTuNgay_Phieu.SelectedDate = DateTime.Today.AddDays(-30);
            dpDenNgay_Phieu.SelectedDate = DateTime.Today;
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            await LoadNguyenLieuAsync();
            await LoadPhieuHuyAsync();
            ResetPhieuHuyForm();
            LoadingOverlay.Visibility = Visibility.Collapsed;
        }

        #region Táº£i Dá»¯ Liá»‡u

        private async Task LoadNguyenLieuAsync()
        {
            try
            {
                _nguyenLieuList = (await httpClient.GetFromJsonAsync<List<NguyenLieuCrudDto>>("api/app/kho/nguyenlieu")) ?? new List<NguyenLieuCrudDto>();

                var nlList = _nguyenLieuList.Select(nl => new { nl.IdNguyenLieu, TenNguyenLieu = $"{nl.TenNguyenLieu} (Tá»“n: {nl.TonKho:N2} {nl.DonViTinh})" }).ToList();
                nlList.Insert(0, new { IdNguyenLieu = 0, TenNguyenLieu = "-- Chá»n NguyÃªn Liá»‡u --" });
                colNguyenLieu.ItemsSource = nlList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i nguyÃªn liá»‡u: {ex.Message}", "Lá»—i API");
            }
        }

        private async Task LoadPhieuHuyAsync()
        {
            DateTime? start = dpTuNgay_Phieu.SelectedDate;
            DateTime? end = dpDenNgay_Phieu.SelectedDate;

            try
            {
                string url = "api/app/kho/phieuxuathuy";
                if (start.HasValue && end.HasValue)
                {
                    url += $"?startDate={start.Value:yyyy-MM-dd}&endDate={end.Value:yyyy-MM-dd}";
                }

                _phieuXuatHuyList = (await httpClient.GetFromJsonAsync<List<PhieuXuatHuyDto>>(url)) ?? new List<PhieuXuatHuyDto>();
                dgPhieuXuatHuy.ItemsSource = _phieuXuatHuyList;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i phiáº¿u há»§y: {ex.Message}", "Lá»—i API");
            }
        }

        #endregion

        #region Xá»­ lÃ½ Form

        private void ResetPhieuHuyForm()
        {
            _isCreatingPhieuHuy = false;
            dgPhieuXuatHuy.SelectedItem = null;

            dpNgayHuy.SelectedDate = DateTime.Today;
            txtLyDoHuy.Text = "";
            lblTongGiaTriHuy.Text = "0 VND";

            _chiTietPhieuHuyList.Clear();
            dgChiTietPhieuHuy.ItemsSource = _chiTietPhieuHuyList;

            btnLuuPhieuHuy.IsEnabled = false;
            btnThemDong.IsEnabled = false;
            dgChiTietPhieuHuy.IsReadOnly = true;
        }

        private void BtnTaoPhieuMoi_Click(object sender, RoutedEventArgs e)
        {
            ResetPhieuHuyForm();
            _isCreatingPhieuHuy = true;
            btnLuuPhieuHuy.IsEnabled = true;
            btnThemDong.IsEnabled = true;
            dgChiTietPhieuHuy.IsReadOnly = false;
        }

        private async void BtnLocPhieu_Click(object sender, RoutedEventArgs e)
        {
            await LoadPhieuHuyAsync();
        }

        private async void DgPhieuXuatHuy_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (dgPhieuXuatHuy.SelectedItem is not PhieuXuatHuyDto selected)
            {
                ResetPhieuHuyForm();
                return;
            }

            _isCreatingPhieuHuy = false;
            btnLuuPhieuHuy.IsEnabled = false;
            btnThemDong.IsEnabled = false;
            dgChiTietPhieuHuy.IsReadOnly = true;

            try
            {
                var details = await httpClient.GetFromJsonAsync<List<ChiTietPhieuXuatHuyDto>>($"api/app/kho/phieuxuathuy/{selected.IdPhieuXuatHuy}");
                _chiTietPhieuHuyList = new ObservableCollection<ChiTietPhieuXuatHuyDto>(details ?? new List<ChiTietPhieuXuatHuyDto>());
                dgChiTietPhieuHuy.ItemsSource = _chiTietPhieuHuyList;

                dpNgayHuy.SelectedDate = selected.NgayXuatHuy;
                txtLyDoHuy.Text = selected.LyDoXuatHuy;
                lblTongGiaTriHuy.Text = selected.TongGiaTriHuy.ToString("N0") + " VND";
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i táº£i chi tiáº¿t phiáº¿u há»§y: {ex.Message}", "Lá»—i API");
            }
        }

        private void BtnThemDong_Click(object sender, RoutedEventArgs e)
        {
            _chiTietPhieuHuyList.Add(new ChiTietPhieuXuatHuyDto { SoLuong = 1 });
            dgChiTietPhieuHuy.ItemsSource = _chiTietPhieuHuyList;
        }

        private void DgChiTietPhieuHuy_CellEditEnding(object sender, DataGridCellEditEndingEventArgs e)
        {
            // KhÃ´ng cáº§n tÃ­nh tá»•ng, API sáº½ tá»± tÃ­nh
        }

        private async void BtnLuuPhieuHuy_Click(object sender, RoutedEventArgs e)
        {
            if (!_isCreatingPhieuHuy || _chiTietPhieuHuyList.Count == 0)
            {
                MessageBox.Show("Vui lÃ²ng 'Táº¡o Phiáº¿u Má»›i' vÃ  'ThÃªm DÃ²ng' nguyÃªn liá»‡u trÆ°á»›c khi lÆ°u.", "Lá»—i");
                return;
            }
            if (AuthService.CurrentUser == null)
            {
                MessageBox.Show("Lá»—i phiÃªn Ä‘Äƒng nháº­p. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.", "Lá»—i");
                return;
            }
            if (string.IsNullOrWhiteSpace(txtLyDoHuy.Text))
            {
                MessageBox.Show("LÃ½ do há»§y lÃ  báº¯t buá»™c.", "Lá»—i");
                return;
            }

            var dto = new PhieuXuatHuyCreateDto
            {
                IdNhanVien = AuthService.CurrentUser.IdNhanVien,
                NgayXuatHuy = dpNgayHuy.SelectedDate ?? DateTime.Today,
                LyDoXuatHuy = txtLyDoHuy.Text,
                ChiTiet = _chiTietPhieuHuyList.Where(ct => ct.IdNguyenLieu > 0 && ct.SoLuong > 0)
                                              .Select(ct => new ChiTietPhieuXuatHuyCreateDto
                                              {
                                                  IdNguyenLieu = ct.IdNguyenLieu,
                                                  SoLuong = ct.SoLuong
                                              }).ToList()
            };

            if (!dto.ChiTiet.Any())
            {
                MessageBox.Show("Phiáº¿u há»§y pháº£i cÃ³ Ã­t nháº¥t 1 nguyÃªn liá»‡u há»£p lá»‡.", "Lá»—i");
                return;
            }

            LoadingOverlay.Visibility = Visibility.Visible;
            try
            {
                var response = await httpClient.PostAsJsonAsync("api/app/kho/phieuxuathuy", dto);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("LÆ°u phiáº¿u xuáº¥t há»§y thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o");
                    await LoadPhieuHuyAsync();
                    ResetPhieuHuyForm();
                }
                else
                {
                    MessageBox.Show($"Lá»—i: {await response.Content.ReadAsStringAsync()}", "Lá»—i API");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Lá»—i káº¿t ná»‘i: {ex.Message}", "Lá»—i API");
            }
            finally
            {
                LoadingOverlay.Visibility = Visibility.Collapsed;
            }
        }

        #endregion

        private void BtnQuayLai_Click(object sender, RoutedEventArgs e)
        {
            if (this.NavigationService?.CanGoBack == true)
            {
                this.NavigationService.GoBack();
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\TongQuanView.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\pages\TongQuanView.xaml
<Page x:Class="AppCafebookApi.View.quanly.pages.TongQuanView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:AppCafebookApi.View.quanly.pages"
      
      xmlns:lvc="clr-namespace:LiveCharts.Wpf;assembly=LiveCharts.Wpf"
      
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1100"
      Title="DashboardView"
      FontFamily="Segoe UI"
      Loaded="Page_Loaded">

    <Page.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextGrayBrush" Color="#757575"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="SubtleGrayBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="ActionGreenBrush" Color="#66BB6A"/>
        <SolidColorBrush x:Key="ActionBlueBrush" Color="#42A5F5"/>
        <SolidColorBrush x:Key="ActionOrangeBrush" Color="#FFA726"/>

        <Geometry x:Key="IconRevenue">M11.8,10.9C11.4,11.2 10.8,11.5 10,11.5C8.6,11.5 7.5,10.4 7.5,9C7.5,7.6 8.6,6.5 10,6.5C10.8,6.5 11.4,6.8 11.8,7.1L12.9,6C12,5.2 11,4.5 10,4.5C7.2,4.5 5,6.7 5,9.5C5,12.3 7.2,14.5 10,14.5C11,14.5 12,13.8 12.9,13L11.8,10.9M12,3H1V1H12V3M12,21H1V19H12V21M17.5,12.5A1.5,1.5 0 0,1 16,11A1.5,1.5 0 0,1 17.5,9.5A1.5,1.5 0 0,1 19,11A1.5,1.5 0 0,1 17.5,12.5M15.5,17H19.5V15H15.5V17Z</Geometry>
        <Geometry x:Key="IconOrder">M17,17H7V15H17M17,13H7V11H17M17,9H7V7H17M19,3H5C3.9,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.9 20.1,3 19,3Z</Geometry>
        <Geometry x:Key="IconStar">M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z</Geometry>
        <Geometry x:Key="IconDownload">M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z</Geometry>
        <Geometry x:Key="IconSettings">M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M12,22C11.6,22 11.2,21.9 10.8,21.7L9.1,20.9C5.1,19.3 2,15.2 2,10.9V5L12,2L22,5V10.9C22,15.2 18.9,19.3 14.9,20.9L13.2,21.7C12.8,21.9 12.4,22 12,22Z</Geometry>

        <Style x:Key="KpiCard" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WhiteTextBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Margin" Value="0,0,20,0"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" Color="#000" Opacity="0.08" BlurRadius="20"/>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="ReportButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource SubtleGrayBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource DarkBrownBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="12"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Margin" Value="0,0,0,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="6">
                            <ContentPresenter Margin="{TemplateBinding Padding}" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource BorderGrayBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid x:Name="MainPanel" Background="{StaticResource LightCreamBrush}" Margin="10" >
        <Grid.RenderTransform>
            <TranslateTransform Y="20"/>
        </Grid.RenderTransform>
        <Grid.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.5">
                            <DoubleAnimation.EasingFunction>
                                <BackEase EasingMode="EaseOut" Amplitude="0.2"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Grid.Triggers>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Text="Tá»•ng quan HÃ´m nay" FontSize="28" FontWeight="Bold" Foreground="{StaticResource DarkBrownBrush}" Margin="0,10,0,20"/>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Style="{StaticResource KpiCard}">
                <Grid>
                    <Path Data="{StaticResource IconRevenue}" Fill="{StaticResource ActionGreenBrush}" Width="48" Height="48" Stretch="Uniform" HorizontalAlignment="Right" VerticalAlignment="Top" Opacity="0.1"/>
                    <StackPanel>
                        <TextBlock x:Name="lblDoanhThu" Text="0 VND" FontSize="26" FontWeight="Bold" Foreground="{StaticResource ActionGreenBrush}"/>
                        <TextBlock Text="DOANH THU" FontSize="14" Foreground="{StaticResource TextGrayBrush}" Margin="0,5,0,0"/>
                    </StackPanel>
                </Grid>
            </Border>
            <Border Grid.Column="1" Style="{StaticResource KpiCard}">
                <Grid>
                    <Path Data="{StaticResource IconOrder}" Fill="{StaticResource ActionBlueBrush}" Width="48" Height="48" Stretch="Uniform" HorizontalAlignment="Right" VerticalAlignment="Top" Opacity="0.1"/>
                    <StackPanel>
                        <TextBlock x:Name="lblDonHang" Text="0" FontSize="26" FontWeight="Bold" Foreground="{StaticResource ActionBlueBrush}"/>
                        <TextBlock Text="ÄÆ N HÃ€NG" FontSize="14" Foreground="{StaticResource TextGrayBrush}" Margin="0,5,0,0"/>
                    </StackPanel>
                </Grid>
            </Border>
            <Border Grid.Column="2" Style="{StaticResource KpiCard}" Margin="0">
                <Grid>
                    <Path Data="{StaticResource IconStar}" Fill="{StaticResource ActionOrangeBrush}" Width="48" Height="48" Stretch="Uniform" HorizontalAlignment="Right" VerticalAlignment="Top" Opacity="0.1"/>
                    <StackPanel>
                        <TextBlock x:Name="lblSanPhamBanChay" Text="ChÆ°a cÃ³" FontSize="22" FontWeight="Bold" Foreground="{StaticResource ActionOrangeBrush}" TextTrimming="CharacterEllipsis"/>
                        <TextBlock Text="Sáº¢N PHáº¨M BÃN CHáº Y" FontSize="14" Foreground="{StaticResource TextGrayBrush}" Margin="0,5,0,0"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>

        <Grid Grid.Row="2" Margin="0,20,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="3*"/>
                <ColumnDefinition Width="1*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Style="{StaticResource KpiCard}" Margin="0,0,20,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <TextBlock Grid.Row="0" Text="Doanh thu 30 ngÃ y qua" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource DarkBrownBrush}"/>

                    <lvc:CartesianChart Grid.Row="1" Margin="0,15,0,0" Series="{Binding SeriesCollection}">
                        <lvc:CartesianChart.Resources>
                            <Style TargetType="lvc:LineSeries">
                                <Setter Property="Stroke" Value="{StaticResource PrimaryBrownBrush}"/>
                                <Setter Property="Fill" Value="#406F4E37"/>
                                <Setter Property="StrokeThickness" Value="3"/>
                                <Setter Property="PointGeometry" Value="{x:Null}"/>
                            </Style>
                            <Style TargetType="lvc:DefaultTooltip">
                                <Setter Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                                <Setter Property="CornerRadius" Value="4"/>
                            </Style>
                        </lvc:CartesianChart.Resources>
                        <lvc:CartesianChart.AxisX>
                            <lvc:Axis Title="NgÃ y" Labels="{Binding Labels}">
                                <lvc:Axis.Separator>
                                    <lvc:Separator Stroke="#E0E0E0" StrokeThickness="1"/>
                                </lvc:Axis.Separator>
                            </lvc:Axis>
                        </lvc:CartesianChart.AxisX>
                        <lvc:CartesianChart.AxisY>
                            <lvc:Axis Title="Doanh thu" LabelFormatter="{Binding YFormatter}">
                                <lvc:Axis.Separator>
                                    <lvc:Separator Stroke="#E0E0E0" StrokeThickness="1"/>
                                </lvc:Axis.Separator>
                            </lvc:Axis>
                        </lvc:CartesianChart.AxisY>
                    </lvc:CartesianChart>

                </Grid>
            </Border>

            <Border Grid.Column="1" Style="{StaticResource KpiCard}" Margin="0">
                <StackPanel>
                    <TextBlock Text="BÃ¡o cÃ¡o &amp; TÃ¡c vá»¥" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,15" Foreground="{StaticResource DarkBrownBrush}"/>
                    <Button x:Name="btnExportRevenue" Style="{StaticResource ReportButton}" Click="BtnExportRevenue_Click">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,10,0">
                                <Path Data="{StaticResource IconDownload}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Xuáº¥t BÃ¡o cÃ¡o Doanh thu" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                    <Button x:Name="btnExportTonKhoSach" Style="{StaticResource ReportButton}" Click="BtnExportTonKhoSach_Click">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,10,0">
                                <Path Data="{StaticResource IconDownload}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Xuáº¥t Tá»“n kho SÃ¡ch" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                    <Button x:Name="btnExportNguyenLieu" Style="{StaticResource ReportButton}" Click="BtnExportNguyenLieu_Click">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,10,0">
                                <Path Data="{StaticResource IconDownload}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Xuáº¥t Tá»“n kho NguyÃªn liá»‡u" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                    <Button x:Name="btnExportPerformance" Style="{StaticResource ReportButton}" Click="BtnExportPerformance_Click">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,10,0">
                                <Path Data="{StaticResource IconDownload}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="Xuáº¥t Hiá»‡u suáº¥t NV" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                    <Button x:Name="btnCaiDat" Style="{StaticResource ReportButton}" Margin="0,20,0,0" Click="BtnCaiDat_Click">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,10,0">
                                <Path Data="{StaticResource IconSettings}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="CÃ i Ä‘áº·t thÃ´ng tin hiá»ƒn thá»‹" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</Page>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\ManHinhQuanly.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\ManHinhQuanly.xaml
<Window x:Class="AppCafebookApi.View.quanly.ManHinhQuanly"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AppCafebookApi.View.quanly"
        mc:Ignorable="d" 
        Title="Cafebook - Copyright by Â© LÃ¢m Chu Báº£o ToÃ n | Contact: [lamchubaotoan@gmail.com]" Height="800" Width="1440"
        WindowStartupLocation="CenterScreen"
        FontFamily="Segoe UI"
        WindowState="Maximized"
        Loaded="Window_Loaded">

    <Window.Resources>
        <SolidColorBrush x:Key="PrimaryBrownBrush" Color="#6F4E37"/>
        <SolidColorBrush x:Key="DarkBrownBrush" Color="#4E342E"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCreamBrush" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="WhiteTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="SubtleWhiteTextBrush" Color="#BCAAA4"/>
        <SolidColorBrush x:Key="HoverBrownBrush" Color="#8D6E63"/>

        <Geometry x:Key="IconDashboard">M13,3V9H21V3M13,21H21V11H13M3,21H11V15H3M3,13H11V3H3V13Z</Geometry>
        <Geometry x:Key="IconCoffee">M16,5H14V3H12V5H10A3,3 0 0,0 7,8V14H18V8A3,3 0 0,0 15,5M20,19H4V17H20V19Z</Geometry>
        <Geometry x:Key="IconTable">M4,6H20V8H4V6M4,10H20V12H4V10M4,14H20V16H4V14M4,18H20V20H4V18Z</Geometry>
        <Geometry x:Key="IconWarehouse">M12,3L2,8V21H22V8L12,3M19,19H15V13H9V19H5V9.4L12,5.5L19,9.4V19Z</Geometry>
        <Geometry x:Key="IconOrder">M17,17H7V15H17M17,13H7V11H17M17,9H7V7H17M19,3H5C3.9,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.9 20.1,3 19,3Z</Geometry>
        <Geometry x:Key="IconBook">M18,2H6C4.9,2 4,2.9 4,4V20C4,21.1 4.9,22 6,22H18C19.1,22 20,21.1 20,20V4C20,2.9 19.1,2 18,2M11,4H13V12L11,10.8L9,12V4H11Z</Geometry>
        <Geometry x:Key="IconUsers">M16,13C17.7,13 21,13.9 21,15.5V17H11V15.5C11,13.9 14.3,13 16,13M8,13C9.7,13 13,13.9 13,15.5V17H3V15.5C3,13.9 6.3,13 8,13M8,11.5A3.5,3.5 0 0,0 11.5,8A3.5,3.5 0 0,0 8,4.5A3.5,3.5 0 0,0 4.5,8A3.5,3.5 0 0,0 8,11.5M16,11.5A3.5,3.5 0 0,0 19.5,8A3.5,3.5 0 0,0 16,4.5A3.5,3.5 0 0,0 12.5,8A3.5,3.5 0 0,0 16,11.5Z</Geometry>
        <Geometry x:Key="IconCustomer">M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5,5.61 6.79,4 9,4C11.21,4 13,5.61 13,8C13,10.39 11.21,12 9,12C6.79,12 5,10.39 5,8M9,13C11.67,13 17,14.34 17,17V20H1V17C1,14.34 6.33,13 9,13M17.75,10.5A3.75,3.75 0 0,0 21.5,6.75A3.75,3.75 0 0,0 17.75,3A3.75,3.75 0 0,0 14,6.75A3.75,3.75 0 0,0 17.75,10.5M14,17.25C14,16.5 15.17,16 16.5,16C17.83,16 19,16.5 19,17.25V18H14V17.25Z</Geometry>
        <Geometry x:Key="IconNotification">M12,22C13.1,22 14,21.1 14,20H10C10,21.1 10.9,22 12,22M18,16V11C18,7.93 16.36,5.36 13.5,4.68V4C13.5,3.17 12.83,2.5 12,2.5C11.17,2.5 10.5,3.17 10.5,4V4.68C7.63,5.36 6,7.93 6,11V16L4,18V19H20V18L18,16Z</Geometry>
        <Geometry x:Key="IconLogout">M16,17V14H9V12H16V9L20,13L16,17M14,2A2,2 0 0,1 16,4V6H14V4H5V20H14V18H16V20A2,2 0 0,1 14,22H5A2,2 0 0,1 3,20V4A2,2 0 0,1 5,2H14Z</Geometry>
        <Geometry x:Key="IconPromotion">M12.41,2.58C12.03,2.2 11.53,2 11,2H4C2.9,2 2,2.9 2,4V11C2,11.53 2.2,12.03 2.59,12.41L12.42,22.24C12.81,22.63 13.44,22.63 13.83,22.24L22.24,13.82C22.63,13.43 22.63,12.8 22.24,12.41L12.41,2.58M7,7A1.5,1.5 0 0,1 5.5,8.5A1.5,1.5 0 0,1 4,7A1.5,1.5 0 0,1 5.5,5.5A1.5,1.5 0 0,1 7,7Z</Geometry>
        <Geometry x:Key="IconProfile">M12,12A5,5 0 0,1 7,7A5,5 0 0,1 12,2A5,5 0 0,1 17,7A5,5 0 0,1 12,12M12,14C14.67,14 20,15.33 20,18V20H4V18C4,15.33 9.33,14 12,14Z</Geometry>
        <Geometry x:Key="IconLeave">M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.89 20.1,3 19,3M19,19H5V10H19V19M10,14V12H7V14H10M14,14V12H11V14H14M18,14V12H15V14H18Z</Geometry>
        <Geometry x:Key="IconPayroll">M20,6H4V4H20V6M20,10H4V8H20V10M18,14H6V12H18V14M18,18H6V16H18V18M19,20H5C3.89,20 3,19.1 3,18V3C3,1.89 3.89,1 5,1H19C20.1,1 21,1.89 21,3V18C21,19.1 20.1,20 19,20Z</Geometry>
        
        <Style x:Key="NavToggleButton" TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource SubtleWhiteTextBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Padding" Value="20,12"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="border" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" CornerRadius="5" Margin="8,2">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Border x:Name="indicator" Width="4" Height="20" Background="Transparent" CornerRadius="2" VerticalAlignment="Center" Margin="-20,0,10,0"/>
                                <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,15,0">
                                    <Path Data="{Binding Path=Tag, RelativeSource={RelativeSource TemplatedParent}}" Fill="{TemplateBinding Foreground}" Stretch="Uniform" VerticalAlignment="Center"/>
                                </Viewbox>
                                <ContentPresenter Grid.Column="1" HorizontalAlignment="Left" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource HoverBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource DarkBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                                <Setter TargetName="indicator" Property="Background" Value="{StaticResource AccentOrangeBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="FooterButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource SubtleWhiteTextBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Padding" Value="20,12"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" CornerRadius="5" Margin="8,2">
                            <ContentPresenter/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource HoverBrownBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource WhiteTextBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="250"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" Background="{StaticResource PrimaryBrownBrush}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <StackPanel Grid.Row="0" Margin="20">
                    <!-- Avatar Icon -->
                    <Border x:Name="AvatarBorder"
                            Height="70" Width="70"
                            Background="{StaticResource LightCreamBrush}"
                            CornerRadius="35"
                            Margin="0,0,0,10">
                        <Viewbox Margin="12,10,18,20">
                            <Path Data="{StaticResource IconProfile}" Fill="{StaticResource PrimaryBrownBrush}">
                                <Path.RenderTransform>
                                    <TranslateTransform Y="1.5" />
                                </Path.RenderTransform>
                            </Path>
                        </Viewbox>
                    </Border>
                    <TextBlock x:Name="txtAdminName" Text="Admin" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource WhiteTextBrush}" HorizontalAlignment="Center"/>
                    <TextBlock x:Name="txtUserRole" Text="Quáº£n trá»‹ viÃªn" FontSize="13" Foreground="{StaticResource SubtleWhiteTextBrush}" HorizontalAlignment="Center"/>
                </StackPanel>

                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <ToggleButton x:Name="btnTongQuan" Content="Tá»•ng quan &amp; BÃ¡o cÃ¡o" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconDashboard}" Click="NavButton_Click" IsChecked="True"/>
                        <ToggleButton x:Name="btnBan" Content="Quáº£n lÃ½ BÃ n" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconTable}" Click="NavButton_Click"/>
                        <ToggleButton x:Name="btnSanPham" Content="Quáº£n lÃ½ Sáº£n pháº©m" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconCoffee}" Click="NavButton_Click"/>
                        <ToggleButton x:Name="btnKho" Content="Quáº£n lÃ½ Kho" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconWarehouse}" Click="NavButton_Click"/>
                        <ToggleButton x:Name="btnDonHang" Content="Quáº£n lÃ½ ÄÆ¡n hÃ ng" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconOrder}" Click="NavButton_Click"/>
                        <ToggleButton x:Name="btnSach" Content="Quáº£n lÃ½ SÃ¡ch" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconBook}" Click="NavButton_Click"/>
                        <ToggleButton x:Name="btnLuong" Content="Quáº£n lÃ½ LÆ°Æ¡ng" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconPayroll}" Click="NavButton_Click"/>
                        <ToggleButton x:Name="btnNhanSu" Content="Quáº£n lÃ½ NhÃ¢n sá»±" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconUsers}" Click="NavButton_Click"/>
                        <ToggleButton x:Name="btnKhachHang" Content="Quáº£n lÃ½ KH &amp; KM" Style="{StaticResource NavToggleButton}" Tag="{StaticResource IconPromotion}" Click="NavButton_Click"/>
                    </StackPanel>
                </ScrollViewer>

                <StackPanel Grid.Row="2" VerticalAlignment="Bottom" Margin="0,0,0,5">
                    <Separator Margin="15" Background="{StaticResource HoverBrownBrush}"/>
                    <Button x:Name="btnThongBao" Style="{StaticResource FooterButton}" Click="BtnThongBao_Click" ToolTip="Xem thÃ´ng bÃ¡o má»›i">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,15,0">
                                <Path Data="{StaticResource IconNotification}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" />
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="ThÃ´ng bÃ¡o" VerticalAlignment="Center" Margin="0,1,0,0"/>
                            <Border Grid.Column="2" x:Name="BadgeThongBao" Background="Red" CornerRadius="10" Padding="5,1" MinWidth="20" Visibility="Collapsed" VerticalAlignment="Center">
                                <TextBlock x:Name="lblSoThongBao" Text="0" Foreground="White" FontSize="10" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                        </Grid>
                    </Button>
                    <Button x:Name="btnDangXuat" Style="{StaticResource FooterButton}" Click="BtnDangXuat_Click"
                             Background="{StaticResource AccentOrangeBrush}"
                             Foreground="{StaticResource WhiteTextBrush}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Viewbox Grid.Column="0" Width="16" Height="16" Margin="0,0,15,0">
                                <Path Data="{StaticResource IconLogout}" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/>
                            </Viewbox>
                            <TextBlock Grid.Column="1" Text="ÄÄƒng xuáº¥t" VerticalAlignment="Center" Margin="0,1,0,0"/>
                        </Grid>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <Border Grid.Column="1" Background="{StaticResource LightCreamBrush}">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="2" Direction="270" Color="Black" Opacity="0.1" BlurRadius="10"/>
            </Border.Effect>
            <Frame x:Name="MainFrame" NavigationUIVisibility="Hidden"/>
        </Border>

        <Popup x:Name="PopupThongBao" IsOpen="False" StaysOpen="False" PlacementTarget="{Binding ElementName=btnThongBao}"
               Placement="Top" AllowsTransparency="True" PopupAnimation="Fade"
               Panel.ZIndex="1" Margin="5,0,0,0">
            <Border Background="White" BorderBrush="#DDD" BorderThickness="1" CornerRadius="8"
                    Width="350" MaxHeight="400">
                <Border.Effect>
                    <DropShadowEffect ShadowDepth="2" Color="#CCC" Opacity="0.5" BlurRadius="10"/>
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <TextBlock Text="ThÃ´ng bÃ¡o má»›i" Grid.Row="0" FontWeight="Bold" FontSize="16" Margin="15" Foreground="{StaticResource DarkBrownBrush}"/>
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <ItemsControl x:Name="icThongBaoPopup">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border BorderBrush="#EEE" BorderThickness="0,0,0,1" Padding="15,10"
                                            x:Name="ThongBaoItemBorder" MouseLeftButtonUp="ThongBaoItem_MouseLeftButtonUp"
                                            Background="Transparent" Cursor="Hand">
                                        <StackPanel>
                                            <TextBlock Text="{Binding NoiDung}" TextWrapping="Wrap"/>
                                            <TextBlock FontStyle="Italic" FontSize="11" Foreground="Gray" Margin="0,5,0,0">
                                                <Run Text="{Binding TenNhanVien}"/> - <Run Text="{Binding ThoiGianTao, StringFormat='HH:mm dd/MM'}"/>
                                            </TextBlock>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Popup>
    </Grid>
</Window>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\quanly\ManHinhQuanly.xaml.cs
using AppCafebookApi.Services;
using AppCafebookApi.View;
using AppCafebookApi.View.common;
using AppCafebookApi.View.quanly.pages;
using CafebookModel.Model.Data;
using CafebookModel.Model.ModelApp;
using CafebookModel.Utils;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq; // <-- Äáº£m báº£o báº¡n Ä‘Ã£ using Linq
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Controls.Primitives;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Threading;

namespace AppCafebookApi.View.quanly
{
    public partial class ManHinhQuanly : Window
    {
        private ToggleButton? currentNavButton;
        private NhanVienDto? currentUser;
        private DispatcherTimer _notificationTimer;
        private static readonly HttpClient httpClient;

        static ManHinhQuanly()
        {
            httpClient = new HttpClient
            {
                BaseAddress = new Uri("http://localhost:5166")
            };
        }

        public ManHinhQuanly()
        {
            InitializeComponent();
            _notificationTimer = new DispatcherTimer();
            _notificationTimer.Interval = TimeSpan.FromSeconds(30);
            _notificationTimer.Tick += _notificationTimer_Tick;
        }

        private async void Window_Loaded(object sender, RoutedEventArgs e)
        {
            currentUser = AuthService.CurrentUser;
            if (currentUser != null)
            {
                // ... (Code cáº­p nháº­t Avatar, TÃªn, PhÃ¢n quyá»n giá»¯ nguyÃªn) ...
                txtAdminName.Text = currentUser.HoTen;
                txtUserRole.Text = currentUser.TenVaiTro;
                AvatarBorder.Child = null;
                BitmapImage avatarImage = HinhAnhHelper.LoadImage(
                    currentUser.AnhDaiDien,
                    HinhAnhPaths.DefaultAvatar
                );
                AvatarBorder.Background = new ImageBrush(avatarImage)
                {
                    Stretch = Stretch.UniformToFill
                };

                btnTongQuan.Visibility = Visibility.Collapsed;
                btnSanPham.Visibility = Visibility.Collapsed;
                btnBan.Visibility = Visibility.Collapsed;
                btnKho.Visibility = Visibility.Collapsed;
                btnDonHang.Visibility = Visibility.Collapsed;
                btnSach.Visibility = Visibility.Collapsed;
                btnNhanSu.Visibility = Visibility.Collapsed;
                btnKhachHang.Visibility = Visibility.Collapsed;

                if (AuthService.CoQuyen("Dashboard.Xem"))
                    btnTongQuan.Visibility = Visibility.Visible;
                if (AuthService.CoQuyen("SanPham.QuanLy"))
                {
                    btnSanPham.Visibility = Visibility.Visible;
                    btnBan.Visibility = Visibility.Visible;
                    btnSach.Visibility = Visibility.Visible;
                }
                if (AuthService.CoQuyen("Kho.Nhap", "Kho.KiemKe"))
                    btnKho.Visibility = Visibility.Visible;
                if (AuthService.CoQuyen("HoaDon.Tao", "HoaDon.ThanhToan", "HoaDon.Huy"))
                    btnDonHang.Visibility = Visibility.Visible;
                if (AuthService.CoQuyen("NhanSu.QuanLy", "NhanSu.TinhLuong"))
                    btnNhanSu.Visibility = Visibility.Visible;
                if (AuthService.CoQuyen("NhanSu.QuanLy"))
                    btnKhachHang.Visibility = Visibility.Visible;
            }

            if (btnTongQuan.Visibility == Visibility.Visible)
            {
                UpdateSelectedButton(btnTongQuan);
                MainFrame.Navigate(new TongQuanView());
            }

            await CheckNotificationsAsync();
            _notificationTimer.Start();
        }

        private async void _notificationTimer_Tick(object? sender, EventArgs e)
        {
            await CheckNotificationsAsync();
        }

        private async Task CheckNotificationsAsync()
        {
            try
            {
                var result = await httpClient.GetFromJsonAsync<ThongBaoCountDto>("api/app/thongbao/unread-count");
                if (result != null && result.UnreadCount > 0)
                {
                    lblSoThongBao.Text = result.UnreadCount.ToString();
                    BadgeThongBao.Visibility = Visibility.Visible;
                }
                else
                {
                    BadgeThongBao.Visibility = Visibility.Collapsed;
                }
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"Lá»—i kiá»ƒm tra thÃ´ng bÃ¡o: {ex.Message}");
            }
        }

        /// <summary>
        /// HÃ m Click chÃ­nh, Ä‘Ã£ Ä‘Æ°á»£c sá»­a láº¡i
        /// </summary>
        private void NavButton_Click(object sender, RoutedEventArgs e)
        {
            var clickedButton = sender as ToggleButton;
            if (clickedButton == null || clickedButton == currentNavButton)
            {
                if (clickedButton != null) clickedButton.IsChecked = true;
                return;
            }
            Page? pageToNavigate = null;

            if (clickedButton == btnTongQuan)
            {
                pageToNavigate = new TongQuanView();
            }
            else if (clickedButton == btnBan)
            {
                pageToNavigate = new QuanLyBanView();
            }
            else if (clickedButton == btnSanPham)
            {
                // Giáº£ sá»­ báº¡n Ä‘Ã£ táº¡o page nÃ y
                pageToNavigate = new QuanLySanPhamView(); 
            }
            else if (clickedButton == btnDonHang)
            {
                // Giáº£ sá»­ báº¡n Ä‘Ã£ táº¡o page nÃ y
                pageToNavigate = new QuanLyDonHangView();
            }
            else if (clickedButton == btnKhachHang)
            {
                // Giáº£ sá»­ báº¡n Ä‘Ã£ táº¡o page nÃ y
                pageToNavigate = new QuanLyKhachHangView();
            }
            else if (clickedButton == btnSach)
            {
                // Giáº£ sá»­ báº¡n Ä‘Ã£ táº¡o page nÃ y
                pageToNavigate = new QuanLySachView();
            }
            else if (clickedButton == btnNhanSu)
            {
                pageToNavigate = new QuanLyNhanVienView();
            }
            else if (clickedButton == btnLuong)
            {
                pageToNavigate = new QuanLyLuongView();
            }
            // === Sá»¬A Lá»–I CÃš PHÃP Táº I ÄÃ‚Y ===
            // XÃ³a dáº¥u ; á»Ÿ dÃ²ng 144 vÃ  thÃªm { }
            else if (clickedButton == btnKho)
            {
                pageToNavigate = new QuanLyTonKhoView();
            }
            // === Bá»” SUNG LOGIC Tá»ª CÃC MODULE TRÆ¯á»šC ===
            else if (clickedButton.Name == "btnLichLamViec") // DÃ¹ng .Name an toÃ n
            {
                pageToNavigate = new QuanLyLichLamViecView();
            }
            else if (clickedButton.Name == "btnDonXinNghi")
            {
                pageToNavigate = new QuanLyDonXinNghiView();
            }
            else if (clickedButton.Name == "btnCaiDatNhanSu")
            {
                pageToNavigate = new CaiDatNhanSuView();
            }
            else if (clickedButton.Name == "btnBaoCaoNhanSu")
            {
                pageToNavigate = new BaoCaoNhanSuView();
            }
            // === Káº¾T THÃšC Bá»” SUNG ===

            if (pageToNavigate != null)
            {
                UpdateSelectedButton(clickedButton);
                MainFrame.Navigate(pageToNavigate);
            }
            else
            {
                MessageBox.Show($"Chá»©c nÄƒng '{clickedButton.Content}' Ä‘ang Ä‘Æ°á»£c phÃ¡t triá»ƒn!", "ThÃ´ng bÃ¡o");
                clickedButton.IsChecked = false;
                if (currentNavButton != null)
                {
                    currentNavButton.IsChecked = true;
                }
            }
        }

        private void UpdateSelectedButton(ToggleButton newButton)
        {
            if (currentNavButton != null && currentNavButton != newButton)
            {
                currentNavButton.IsChecked = false;
            }
            currentNavButton = newButton;
            currentNavButton.IsChecked = true;
        }

        private async void BtnThongBao_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                // 1. Váº«n gá»i API 'all' Ä‘á»ƒ láº¥y táº¥t cáº£ thÃ´ng bÃ¡o
                var allNotifications = await httpClient.GetFromJsonAsync<List<ThongBaoDto>>("api/app/thongbao/all");

                if (allNotifications != null)
                {
                    // 2. Lá»c ra danh sÃ¡ch CHÆ¯A Äá»ŒC (DaXem == false)
                    var unreadNotifications = allNotifications
                        .Where(t => t.DaXem == false)
                        .ToList();

                    // 3. GÃ¡n danh sÃ¡ch Ä‘Ã£ lá»c vÃ o Popup
                    icThongBaoPopup.ItemsSource = unreadNotifications;
                }
                else
                {
                    icThongBaoPopup.ItemsSource = null;
                }

                PopupThongBao.IsOpen = true;

                // 4. Cáº­p nháº­t láº¡i sá»‘ lÆ°á»£ng trÃªn badge (vÃ¬ cÃ³ thá»ƒ Ä‘Ã£ Ä‘á»c á»Ÿ Ä‘Ã¢u Ä‘Ã³)
                await CheckNotificationsAsync();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"KhÃ´ng thá»ƒ táº£i thÃ´ng bÃ¡o: {ex.Message}", "Lá»—i API");
            }
        }

        private async void ThongBaoItem_MouseLeftButtonUp(object sender, System.Windows.Input.MouseButtonEventArgs e)
        {
            if (sender is FrameworkElement element && element.DataContext is ThongBaoDto thongBao)
            {
                PopupThongBao.IsOpen = false;

                // Gá»i API Ä‘á»ƒ Ä‘Ã¡nh dáº¥u lÃ  Ä‘Ã£ Ä‘á»c (khÃ´ng cáº§n Ä‘á»£i)
                _ = httpClient.PostAsync($"api/app/thongbao/mark-as-read/{thongBao.IdThongBao}", null); 

                // === LOGIC ÄIá»€U HÆ¯á»šNG Má»šI ===

                if (thongBao.LoaiThongBao == "SuCoBan" && thongBao.IdLienQuan.HasValue) 
                {
                    int idBanCanDen = thongBao.IdLienQuan.Value;
                    UpdateSelectedButton(btnBan);
                    MainFrame.Navigate(new QuanLyBanView(idBanCanDen));
                }
                else if (thongBao.LoaiThongBao == "HetHang")
                {
                    // (Giáº£ sá»­ btnKho vÃ  QuanLyTonKhoView Ä‘Ã£ tá»“n táº¡i)
                    UpdateSelectedButton(btnKho);
                    MainFrame.Navigate(new QuanLyTonKhoView());
                }
                else if (thongBao.LoaiThongBao == "DonXinNghi")
                {
                    // TÃ¬m nÃºt btnDonXinNghi (náº¿u chÆ°a cÃ³, dÃ¹ng btnNhanSu)
                    ToggleButton? targetButton = FindName("btnDonXinNghi") as ToggleButton ?? btnNhanSu; 
                    UpdateSelectedButton(targetButton);
                    MainFrame.Navigate(new QuanLyDonXinNghiView());
                }

                // === Káº¾T THÃšC LOGIC Má»šI ===

                // Cáº­p nháº­t láº¡i badge (sá»‘ thÃ´ng bÃ¡o sáº½ giáº£m)
                await CheckNotificationsAsync();
            }
        }

        private void BtnDangXuat_Click(object sender, RoutedEventArgs e)
        {
            var result = MessageBox.Show("Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n Ä‘Äƒng xuáº¥t?",
                                        "XÃ¡c nháº­n Ä‘Äƒng xuáº¥t",
                                        MessageBoxButton.YesNo,
                                        MessageBoxImage.Question);

            if (result == MessageBoxResult.Yes)
            {
                AuthService.Logout();
                ManHinhDangNhap loginWindow = new ManHinhDangNhap();
                loginWindow.Show();
                this.Close();
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\ManHinhDangNhap.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\ManHinhDangNhap.xaml
<Window x:Class="AppCafebookApi.View.ManHinhDangNhap"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AppCafebookApi.View"
        mc:Ignorable="d"
        Title="ÄÄƒng nháº­p há»‡ thá»‘ng CafeBook" Height="500" Width="850"
        WindowStartupLocation="CenterScreen"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent"
        ResizeMode="NoResize"
        FontFamily="Segoe UI"
        Loaded="Window_Loaded"
        KeyDown="Window_KeyDown">

    <Window.Resources>
        <SolidColorBrush x:Key="PrimaryBrown" Color="#6F4E37"/>
        <SolidColorBrush x:Key="AccentOrange" Color="#D27D2D"/>
        <SolidColorBrush x:Key="LightCream" Color="#FFF8E1"/>
        <SolidColorBrush x:Key="DarkText" Color="#4E342E"/>
        <SolidColorBrush x:Key="SubtleGray" Color="#BDBDBD"/>
        <SolidColorBrush x:Key="WhiteText" Color="#FFFFFF"/>

        <Geometry x:Key="UserIcon">M12,12A5,5 0 0,1 7,7A5,5 0 0,1 12,2A5,5 0 0,1 17,7A5,5 0 0,1 12,12M12,14C14.67,14 20,15.33 20,18V20H4V18C4,15.33 9.33,14 12,14Z</Geometry>
        <Geometry x:Key="LockIcon">M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8H17V6A5,5 0 0,0 12,1A5,5 0 0,0 7,6V8H6A2,2 0 0,0 4,10V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V10A2,2 0 0,0 18,8Z</Geometry>
        <Geometry x:Key="LogoIcon">M16,5H14V3H12V5H10A3,3 0 0,0 7,8V14H18V8A3,3 0 0,0 15,5M20,19H4V17H20V19Z</Geometry>

        <Style TargetType="TextBox">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="{StaticResource SubtleGray}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="Foreground" Value="{StaticResource DarkText}"/>
            <Setter Property="Padding" Value="35,8,8,8"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TextBox">
                        <Border x:Name="border"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                SnapsToDevicePixels="True">
                            <ScrollViewer x:Name="PART_ContentHost" Focusable="False" HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Hidden"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsKeyboardFocused" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource AccentOrange}"/>
                                <Setter TargetName="border" Property="BorderThickness" Value="0,0,0,2"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrown}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="PasswordBox">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="{StaticResource SubtleGray}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="Foreground" Value="{StaticResource DarkText}"/>
            <Setter Property="Padding" Value="35,8,8,8"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="PasswordBox">
                        <Border x:Name="border"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                SnapsToDevicePixels="True">

                            <ScrollViewer x:Name="PART_ContentHost" Focusable="False" HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Hidden"/>

                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsKeyboardFocused" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource AccentOrange}"/>
                                <Setter TargetName="border" Property="BorderThickness" Value="0,0,0,2"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrown}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrown}"/>
            <Setter Property="Foreground" Value="{StaticResource WhiteText}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Height" Value="42"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                CornerRadius="21"
                                Background="{TemplateBinding Background}">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="2" Color="#6F4E37" Opacity="0.3" BlurRadius="10"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource AccentOrange}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="TextButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrown}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Height" Value="42"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Foreground" Value="{StaticResource AccentOrange}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

    </Window.Resources>

    <Border CornerRadius="12" Background="{StaticResource LightCream}">
        <Border.Effect>
            <DropShadowEffect Color="#000000" Opacity="0.15" BlurRadius="30" ShadowDepth="0"/>
        </Border.Effect>
        <Grid x:Name="MainGrid">
            <Grid.Triggers>
                <EventTrigger RoutedEvent="Loaded">
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation Storyboard.TargetName="MainGrid" Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
            </Grid.Triggers>

            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="320"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Background="{StaticResource PrimaryBrown}" CornerRadius="12,0,0,12">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <Ellipse Width="100" Height="100" Margin="0,0,0,20">
                        <Ellipse.Effect>
                            <DropShadowEffect ShadowDepth="1" BlurRadius="15" Opacity="0.2"/>
                        </Ellipse.Effect>
                        <Ellipse.Fill>
                            <!-- Thay Ä‘á»•i "/Assets/logo.png" thÃ nh Ä‘Æ°á»ng dáº«n chÃ­nh xÃ¡c tá»›i file cá»§a báº¡n -->
                            <ImageBrush ImageSource="/Assets/logo.png"/>
                        </Ellipse.Fill>
                    </Ellipse>
                    <TextBlock Text="CafeBook" FontSize="36" FontWeight="Bold" Foreground="{StaticResource WhiteText}" HorizontalAlignment="Center"/>
                    <TextBlock Text="Awaken your senses" Opacity="0.8" FontSize="14" Foreground="{StaticResource WhiteText}" HorizontalAlignment="Center" Margin="0,5,0,0"/>
                </StackPanel>
            </Border>

            <Grid Grid.Column="1" Margin="50,40">
                <StackPanel VerticalAlignment="Center">
                    <TextBlock Text="ÄÄƒng Nháº­p"
                               FontSize="28"
                               FontWeight="Bold"
                               Foreground="{StaticResource DarkText}"
                               Margin="0,0,0,10"/>
                    <TextBlock Text="ChÃ o má»«ng trá»Ÿ láº¡i! Vui lÃ²ng nháº­p thÃ´ng tin cá»§a báº¡n."
                               FontSize="14"
                               Foreground="{StaticResource DarkText}"
                               Opacity="0.7"
                               TextWrapping="Wrap"
                               Margin="0,0,0,30"/>

                    <Grid Margin="0,10,0,0">
                        <TextBlock Text="TÃªn Ä‘Äƒng nháº­p" Foreground="{StaticResource PrimaryBrown}" VerticalAlignment="Top" Margin="0,-8,0,0" FontSize="12"/>
                        <Path Data="{StaticResource UserIcon}" Fill="{StaticResource SubtleGray}" Width="18" Height="18" Stretch="Uniform" VerticalAlignment="Center" HorizontalAlignment="Left" Margin="5,0,0,0"/>
                        <TextBox x:Name="txtUsername"/>
                    </Grid>

                    <Grid Margin="0,25,0,0">
                        <TextBlock Text="Máº­t kháº©u" Foreground="{StaticResource PrimaryBrown}" VerticalAlignment="Top" Margin="0,-8,0,0" FontSize="12"/>
                        <Path Data="{StaticResource LockIcon}" Fill="{StaticResource SubtleGray}" Width="18" Height="18" Stretch="Uniform" VerticalAlignment="Center" HorizontalAlignment="Left" Margin="5,0,0,0"/>
                        <TextBox x:Name="txtVisiblePassword" Visibility="Collapsed" TextChanged="TxtVisiblePassword_TextChanged"/>
                        <PasswordBox x:Name="txtPassword" PasswordChanged="TxtPassword_PasswordChanged"/>
                    </Grid>

                    <CheckBox x:Name="chkShowPassword"
                              Content="Hiá»ƒn thá»‹ máº­t kháº©u"
                              FontSize="12"
                              Foreground="{StaticResource DarkText}"
                              HorizontalAlignment="Right"
                              Margin="0,15,0,0"
                              Checked="ChkShowPassword_Checked" Unchecked="ChkShowPassword_Unchecked"/>

                    <Button x:Name="btnLogin" Content="ÄÄ‚NG NHáº¬P" Style="{StaticResource PrimaryButton}" Margin="0,30,0,0" Click="BtnLogin_Click"/>
                    <Button x:Name="btnExit" Content="ThoÃ¡t chÆ°Æ¡ng trÃ¬nh" Style="{StaticResource TextButton}" Margin="0,10,0,0" Click="BtnExit_Click"/>
                </StackPanel>
            </Grid>
        </Grid>
    </Border>
</Window>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\View\ManHinhDangNhap.xaml.cs
using System.Windows;
using System.Windows.Input;
using AppCafebookApi.Services;
using CafebookModel.Model.ModelApi;
using CafebookModel.Model.Data;
using AppCafebookApi.View.Common;
using AppCafebookApi.View.quanly;
using AppCafebookApi.View.nhanvien;
using System.Windows.Controls;
using System.Threading.Tasks; // <-- ThÃªm using nÃ y

namespace AppCafebookApi.View
{
    public partial class ManHinhDangNhap : Window
    {
        public ManHinhDangNhap()
        {
            InitializeComponent();
        }

        private void Window_Loaded(object sender, RoutedEventArgs e)
        {
            txtUsername.Focus();
        }

        private async void BtnLogin_Click(object sender, RoutedEventArgs e)
        {
            var loginRequest = new LoginRequestModel
            {
                TenDangNhap = txtUsername.Text,
                MatKhau = chkShowPassword.IsChecked == true ? txtVisiblePassword.Text : txtPassword.Password
            };

            btnLogin.IsEnabled = false;
            btnLogin.Content = "ÄANG KIá»‚M TRA...";

            LoginResponseModel response = AuthService.LoginBackdoor(loginRequest);

            if (!response.Success)
            {
                response = await AuthService.LoginAsync(loginRequest);
            }

            if (response.Success && response.UserData != null)
            {
                // === Báº®T Äáº¦U Sá»¬A LUá»’NG (FLOW) ===

                // 1. áº¨n mÃ n hÃ¬nh Ä‘Äƒng nháº­p ngay láº­p tá»©c
                this.Hide();

                // 2. Hiá»ƒn thá»‹ mÃ n hÃ¬nh chÃ o má»«ng (ShowDialog Ä‘á»ƒ cháº·n tÆ°Æ¡ng tÃ¡c)
                HienThiManHinhChao(response.UserData);

                // 3. (Sau khi mÃ n hÃ¬nh chÃ o má»«ng Ä‘Ã³ng) PhÃ¢n quyá»n vÃ  má»Ÿ mÃ n hÃ¬nh chÃ­nh
                PhanQuyenVaChuyenHuong(response.UserData.TenVaiTro ?? string.Empty);

                // 4. ÄÃ³ng háº³n mÃ n hÃ¬nh Ä‘Äƒng nháº­p
                this.Close();

                // === Káº¾T THÃšC Sá»¬A LUá»’NG ===
            }
            else
            {
                // ÄÄƒng nháº­p tháº¥t báº¡i, hiá»‡n láº¡i nÃºt
                btnLogin.IsEnabled = true;
                btnLogin.Content = "ÄÄ‚NG NHáº¬P";
                MessageBox.Show(response.Message, "ÄÄƒng nháº­p tháº¥t báº¡i", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void HienThiManHinhChao(NhanVienDto user)
        {
            var welcomeWindow = new WelcomeWindow(user);
            // KhÃ´ng cáº§n gÃ¡n Owner ná»¯a vÃ¬ mÃ n hÃ¬nh Ä‘Äƒng nháº­p Ä‘Ã£ Hide()
            welcomeWindow.ShowDialog();
        }

        private void PhanQuyenVaChuyenHuong(string tenVaiTro)
        {
            if (tenVaiTro == "Quáº£n trá»‹ viÃªn" || tenVaiTro == "Quáº£n lÃ½")
            {
                ManHinhQuanly adminWindow = new ManHinhQuanly();
                adminWindow.Show();
            }
            else
            {
                ManHinhNhanVien employeeWindow = new ManHinhNhanVien();
                employeeWindow.Show();
            }

            // this.Close(); // ÄÃ£ chuyá»ƒn lÃªn hÃ m BtnLogin_Click
        }

        private void BtnExit_Click(object sender, RoutedEventArgs e)
        {
            Application.Current.Shutdown();
        }

        private async void Window_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.Key == Key.Enter && btnLogin.IsEnabled) // Chá»‰ cháº¡y náº¿u nÃºt Ä‘ang báº­t
            {
                BtnLogin_Click(sender, e);
                e.Handled = true;
            }
        }

        // --- Logic Hiá»ƒn thá»‹ Máº­t kháº©u ---

        private void ChkShowPassword_Checked(object sender, RoutedEventArgs e)
        {
            txtVisiblePassword.Text = txtPassword.Password;
            txtVisiblePassword.Visibility = Visibility.Visible;
            txtPassword.Visibility = Visibility.Collapsed;
        }

        private void ChkShowPassword_Unchecked(object sender, RoutedEventArgs e)
        {
            txtPassword.Password = txtVisiblePassword.Text;
            txtVisiblePassword.Visibility = Visibility.Collapsed;
            txtPassword.Visibility = Visibility.Visible;
        }

        private void TxtPassword_PasswordChanged(object sender, RoutedEventArgs e)
        {
            if (chkShowPassword.IsChecked == true)
            {
                txtVisiblePassword.Text = txtPassword.Password;
            }
        }

        private void TxtVisiblePassword_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (chkShowPassword.IsChecked == false)
            {
                txtPassword.Password = txtVisiblePassword.Text;
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\App.xaml.cs e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\App.xaml
<Application x:Class="AppCafebookApi.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:AppCafebookApi"
             StartupUri="View/ManHinhDangNhap.xaml">
    <Application.Resources>
         
    </Application.Resources>
</Application>
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\AppCafebookApi\AppCafebookApi\logo.ico
