=== MÃ NGUỒN DỰ ÁN: CafebookApi ===

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\appsettings.Development.json
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\appsettings.json
================================================================================
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "CafeBookConnectionString": "Server=localhost\\SQLEXPRESS;Database=CAFEBOOKDB_v2;Integrated Security=True;Encrypt=False;"
  },
  "SmtpSettings": {
    "Host": "smtp.gmail.com",
    "Port": 587,
    "Username": "cafebook.hotro@gmail.com",
    "Password": "raja nenx mxhk vtvn",
    "EnableSsl": true,
    "FromName": "Cafebook Hỗ Trợ"
  },
  "Jwt": {
    "Key": "b3a9f8c1d7e0a5b2f6c8d1e3a9b7f2d5e8c1a0b3f6d8e2a4c7b1f9d0e5a2c6b8",
    "Issuer": "http://127.0.0.1:5166",
    "Audience": "http://127.0.0.1:5166"
  }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\CafebookApi.csproj
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\CafebookApi.csproj.user
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Program.cs
================================================================================
﻿using CafebookApi.Data;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.EntityFrameworkCore;
using Microsoft.IdentityModel.Tokens;
using System.Text;

var builder = WebApplication.CreateBuilder(args);

// 1️⃣ Kết nối SQL Server
var connectionString = builder.Configuration.GetConnectionString("CafeBookConnectionString");
builder.Services.AddDbContext<CafebookDbContext>(options =>
    options.UseSqlServer(connectionString));

// === THÊM KHỐI NÀY ĐỂ SỬA LỖI 401 ===
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAll",
        policy =>
        {
            policy.AllowAnyOrigin() // Cho phép bất kỳ nguồn nào
                  .AllowAnyMethod() // Cho phép bất kỳ phương thức nào (GET, POST, PUT, v.v.)
                  .AllowAnyHeader(); // Cho phép bất kỳ header nào
        });
});
// =====================================

// 2️⃣ Cấu hình controller, Swagger
builder.Services.AddControllers();
builder.Services.AddHttpClient();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

// 3️⃣ Cấu hình xác thực JWT
builder.Services.AddAuthentication(options =>
{
    options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
})
.AddJwtBearer(options =>
{
    options.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuer = true,
        ValidateAudience = true,
        ValidateLifetime = true,
        ValidateIssuerSigningKey = true,
        ValidIssuer = builder.Configuration["Jwt:Issuer"]!,
        ValidAudience = builder.Configuration["Jwt:Audience"]!,
        IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(builder.Configuration["Jwt:Key"]!))
    };
});
var app = builder.Build();

// 4️⃣ Swagger (chỉ bật khi dev)
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

// 5️⃣ Cho phép truy cập file tĩnh (wwwroot)
app.UseStaticFiles();
app.UseCors("AllowAll"); // <-- Dòng này bây giờ đã hợp lệ

// 6️⃣ Hỗ trợ HTTPS redirect
//app.UseHttpsRedirection();

app.UseRouting();
app.UseAuthentication(); // Phải trước UseAuthorization
app.UseAuthorization();

// 7️⃣ Map controllers
app.MapControllers();

app.Run();
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\BackgroundJobController.cs
================================================================================
﻿// Tệp: CafebookApi/Controllers/App/BackgroundJobController.cs
// (*** TẠO TỆP MỚI NÀY ***)

using CafebookApi.Data;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/background")]
    [ApiController]
    public class BackgroundJobController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public BackgroundJobController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API CHUYÊN DỤNG: Tự động huỷ các phiếu đặt trễ 15 phút
        /// (Được gọi bởi SoDoBanController và DatBanController)
        /// </summary>
        [HttpPost("auto-cancel-late")]
        public async Task<IActionResult> AutoCancelLateReservationsAsync()
        {
            var now = DateTime.Now;
            // Mốc thời gian (bất kỳ phiếu nào trước 15 phút)
            var timeLimit = now.AddMinutes(-15);

            try
            {
                var lateReservations = await _context.PhieuDatBans
                    .Include(p => p.Ban)
                    .Where(p => (p.TrangThai == "Đã đặt" || p.TrangThai == "Chờ xác nhận") &&
                                p.ThoiGianDat < timeLimit)
                    .ToListAsync();

                if (lateReservations.Any())
                {
                    foreach (var phieu in lateReservations)
                    {
                        phieu.TrangThai = "Đã hủy";
                        phieu.GhiChu = (phieu.GhiChu ?? "") + " (Tự động hủy do trễ 15 phút)";

                        // Chỉ reset bàn nếu bàn đang ở trạng thái "Đã đặt"
                        if (phieu.Ban != null && phieu.Ban.TrangThai == "Đã đặt")
                        {
                            phieu.Ban.TrangThai = "Trống";
                        }
                    }
                    await _context.SaveChangesAsync();
                    return Ok(new { message = $"Đã tự động hủy {lateReservations.Count} phiếu bị trễ." });
                }
                return Ok(new { message = "Không có phiếu nào bị trễ." });
            }
            catch (Exception ex)
            {
                // Ghi lại lỗi nếu có sự cố
                Console.WriteLine($"[AutoCancelLateReservationsAsync Error]: {ex.Message}");
                return StatusCode(500, "Lỗi máy chủ khi xử lý hủy phiếu tự động.");
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\BanQuanLyController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using CafebookModel.Model.Entities;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/banquanly")]
    [ApiController]
    public class BanQuanLyController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public BanQuanLyController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// Lấy toàn bộ cây Khu Vực và Bàn
        /// </summary>
        [HttpGet("tree")]
        public async Task<IActionResult> GetKhuVucTree()
        {
            var data = await _context.KhuVucs
                .AsNoTracking()
                .Select(kv => new KhuVucDto // Chuyển đổi sang DTO
                {
                    IdKhuVuc = kv.IdKhuVuc,
                    TenKhuVuc = kv.TenKhuVuc,
                    MoTa = kv.MoTa,
                    Bans = kv.Bans.Select(b => new BanDto
                    {
                        IdBan = b.IdBan,
                        SoBan = b.SoBan,
                        SoGhe = b.SoGhe,
                        TrangThai = b.TrangThai,
                        GhiChu = b.GhiChu,
                        IdKhuVuc = b.IdKhuVuc ?? 0
                    }).ToList()
                })
                .ToListAsync();

            return Ok(data);
        }

        // --- API CHO KHU VỰC ---

        [HttpPost("khuvuc")]
        public async Task<IActionResult> CreateKhuVuc([FromBody] KhuVucUpdateRequestDto dto)
        {
            var khuVuc = new KhuVuc
            {
                TenKhuVuc = dto.TenKhuVuc,
                MoTa = dto.MoTa
            };
            _context.KhuVucs.Add(khuVuc);
            await _context.SaveChangesAsync();
            return Ok(khuVuc); // Trả về đối tượng đã tạo
        }

        [HttpPut("khuvuc/{id}")]
        public async Task<IActionResult> UpdateKhuVuc(int id, [FromBody] KhuVucUpdateRequestDto dto)
        {
            var khuVuc = await _context.KhuVucs.FindAsync(id);
            if (khuVuc == null) return NotFound();

            khuVuc.TenKhuVuc = dto.TenKhuVuc;
            khuVuc.MoTa = dto.MoTa;
            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpDelete("khuvuc/{id}")]
        public async Task<IActionResult> DeleteKhuVuc(int id)
        {
            // Kiểm tra ràng buộc (còn bàn không)
            if (await _context.Bans.AnyAsync(b => b.IdKhuVuc == id))
            {
                return Conflict("Không thể xóa khu vực đang chứa bàn. Vui lòng di chuyển hoặc xóa các bàn trước.");
            }

            var khuVuc = await _context.KhuVucs.FindAsync(id);
            if (khuVuc == null) return NotFound();

            _context.KhuVucs.Remove(khuVuc);
            await _context.SaveChangesAsync();
            return Ok();
        }

        // --- API CHO BÀN ---

        [HttpPost("ban")]
        public async Task<IActionResult> CreateBan([FromBody] BanUpdateRequestDto dto)
        {
            var ban = new Ban
            {
                SoBan = dto.SoBan,
                SoGhe = dto.SoGhe,
                IdKhuVuc = dto.IdKhuVuc,
                TrangThai = "Trống", // Mặc định khi thêm mới
                GhiChu = dto.GhiChu
            };
            _context.Bans.Add(ban);
            await _context.SaveChangesAsync();
            return Ok(ban);
        }

        [HttpPut("ban/{id}")]
        public async Task<IActionResult> UpdateBan(int id, [FromBody] BanUpdateRequestDto dto)
        {
            var ban = await _context.Bans.FindAsync(id);
            if (ban == null) return NotFound();

            ban.SoBan = dto.SoBan;
            ban.SoGhe = dto.SoGhe;
            ban.IdKhuVuc = dto.IdKhuVuc;   // Cho phép di chuyển bàn
            ban.TrangThai = dto.TrangThai; // Cho phép khóa bàn
            ban.GhiChu = dto.GhiChu;

            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpDelete("ban/{id}")]
        public async Task<IActionResult> DeleteBan(int id)
        {
            // Kiểm tra ràng buộc theo yêu cầu
            if (await _context.HoaDons.AnyAsync(h => h.IdBan == id && h.TrangThai != "Đã thanh toán"))
            {
                return Conflict("Không thể xóa. Bàn đang có hóa đơn CHƯA thanh toán.");
            }
            if (await _context.PhieuDatBans.AnyAsync(p => p.IdBan == id && p.ThoiGianDat > DateTime.Now))
            {
                return Conflict("Không thể xóa. Bàn đang có phiếu đặt trước CHƯA diễn ra.");
            }

            var ban = await _context.Bans.FindAsync(id);
            if (ban == null) return NotFound();

            _context.Bans.Remove(ban);
            await _context.SaveChangesAsync();
            return Ok();
        }

        // --- API NÂNG CAO ---

        [HttpGet("ban/{id}/history")]
        public async Task<IActionResult> GetBanHistory(int id)
        {
            var history = new BanHistoryDto
            {
                SoLuotPhucVu = await _context.HoaDons.CountAsync(h => h.IdBan == id && h.TrangThai == "Đã thanh toán"),
                TongDoanhThu = await _context.HoaDons
                                    .Where(h => h.IdBan == id && h.TrangThai == "Đã thanh toán")
                                    .SumAsync(h => h.ThanhTien),
                SoLuotDatTruoc = await _context.PhieuDatBans.CountAsync(p => p.IdBan == id)
            };
            return Ok(history);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\BaoCaoController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/baocao")]
    [ApiController]
    public class BaoCaoController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public BaoCaoController(CafebookDbContext context)
        {
            _context = context;
        }

        [HttpPost("doanhthu")]
        public async Task<IActionResult> GetDoanhThuReport([FromBody] BaoCaoRequestDto request)
        {
            var startDate = request.StartDate.Date;
            var endDate = request.EndDate.Date.AddDays(1);

            // 1. TÍNH DOANH THU (Code này đã đúng)
            var chiTietDoanhThu = (await _context.Database.SqlQuery<BaoCaoChiTietDoanhThuDto>($@"
                    SELECT
                        ISNULL(SUM(tongTienGoc), 0) AS TongDoanhThuGoc,
                        ISNULL(SUM(giamGia), 0) AS TongGiamGia,
                        ISNULL(SUM(TongPhuThu), 0) AS TongPhuThu,
                        ISNULL(SUM(thanhTien), 0) AS DoanhThuRong,
                        ISNULL(COUNT(idHoaDon), 0) AS SoLuongHoaDon,
                        ISNULL(AVG(thanhTien), 0) AS GiaTriTrungBinhHD
                    FROM dbo.HoaDon
                    WHERE trangThai = N'Đã thanh toán'
                    AND thoiGianThanhToan >= {startDate} AND thoiGianThanhToan < {endDate};
                ").ToListAsync()).FirstOrDefault() ?? new BaoCaoChiTietDoanhThuDto();

            // 2. TÍNH GIÁ VỐN (COGS) (Sửa lỗi CS1503 tại đây)
            // Xóa 'var cogsSql = ...' và truyền chuỗi nội suy TRỰC TIẾP
            var cogsResult = await _context.Database.SqlQuery<decimal>($@"
                WITH GiaVonNguyenLieu AS (
                    SELECT idNguyenLieu, AVG(donGiaNhap) AS GiaVonTrungBinh
                    FROM dbo.ChiTietNhapKho GROUP BY idNguyenLieu
                ),
                SanPhamDaBan AS (
                    SELECT cthd.idSanPham, SUM(cthd.soLuong) AS TongSoLuongBan
                    FROM dbo.ChiTietHoaDon cthd
                    JOIN dbo.HoaDon hd ON cthd.idHoaDon = hd.idHoaDon
                    WHERE hd.trangThai = N'Đã thanh toán'
                    AND hd.thoiGianThanhToan >= {startDate} AND hd.thoiGianThanhToan < {endDate}
                    GROUP BY cthd.idSanPham
                )
                SELECT ISNULL(SUM(spb.TongSoLuongBan * dl.SoLuongSuDung * gv.GiaVonTrungBinh), 0)
                FROM SanPhamDaBan spb
                JOIN dbo.DinhLuong dl ON spb.idSanPham = dl.idSanPham
                JOIN GiaVonNguyenLieu gv ON dl.idNguyenLieu = gv.idNguyenLieu;
            ").ToListAsync(); // Lỗi CS1503 đã được sửa

            decimal tongGiaVon_COGS = cogsResult.FirstOrDefault();

            // 3. TÍNH CHI PHÍ VẬN HÀNH (OPEX) (Code này đã đúng)
            var opexResult = (await _context.Database.SqlQuery<OpexDto>($@"
                    SELECT 
                    ISNULL((SELECT SUM(thucLanh) 
                        FROM dbo.PhieuLuong
                        WHERE trangThai = N'Đã thanh toán'
                        AND ngayTao >= {startDate} AND ngayTao < {endDate}
                    ), 0) AS TongChiPhiLuong,
                    
                    ISNULL((SELECT SUM(TongGiaTriHuy) 
                        FROM dbo.PhieuXuatHuy
                        WHERE NgayXuatHuy >= {startDate} AND NgayXuatHuy < {endDate}
                    ), 0) AS TongChiPhiHuyHang;
                ").ToListAsync()).FirstOrDefault() ?? new OpexDto();

            // 4. TOP SẢN PHẨM (Code này đã đúng)
            var topSanPham = await _context.Database.SqlQuery<TopSanPhamDto>($@"
                    SELECT TOP 10
                        sp.tenSanPham,
                        SUM(cthd.soLuong) AS TongSoLuongBan,
                        SUM(cthd.thanhTien) AS TongDoanhThu
                    FROM dbo.ChiTietHoaDon cthd
                    JOIN dbo.SanPham sp ON cthd.idSanPham = sp.idSanPham
                    JOIN dbo.HoaDon hd ON cthd.idHoaDon = hd.idHoaDon
                    WHERE hd.trangThai = N'Đã thanh toán'
                    AND hd.thoiGianThanhToan >= {startDate} AND hd.thoiGianThanhToan < {endDate}
                    GROUP BY sp.tenSanPham
                    ORDER BY TongSoLuongBan DESC;
                ").ToListAsync();

            // 5. TỔNG HỢP KẾT QUẢ (Code này đã đúng)
            var dto = new BaoCaoTongHopDto
            {
                ChiTietDoanhThu = chiTietDoanhThu,
                ChiTietChiPhi = new BaoCaoChiPhiDto
                {
                    TongGiaVon_COGS = tongGiaVon_COGS,
                    TongChiPhiLuong = opexResult.TongChiPhiLuong,
                    TongChiPhiHuyHang = opexResult.TongChiPhiHuyHang
                },
                TopSanPham = topSanPham,
                Kpi = new BaoCaoKpiDto() // Tính toán KPI
            };

            // Tính toán KPI cuối cùng
            dto.Kpi.DoanhThuRong = dto.ChiTietDoanhThu.DoanhThuRong;
            dto.Kpi.TongGiaVon = dto.ChiTietChiPhi.TongGiaVon_COGS;
            dto.Kpi.LoiNhuanGop = dto.Kpi.DoanhThuRong - dto.Kpi.TongGiaVon;
            dto.Kpi.ChiPhiOpex = dto.ChiTietChiPhi.TongChiPhiLuong + dto.ChiTietChiPhi.TongChiPhiHuyHang;
            dto.Kpi.LoiNhuanRong = dto.Kpi.LoiNhuanGop - dto.Kpi.ChiPhiOpex;

            return Ok(dto);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\BaoCaoHieuSuatController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Data.SqlClient;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;
using System;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/baocaohieusuat")]
    [ApiController]
    public class BaoCaoHieuSuatController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public BaoCaoHieuSuatController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API để lấy dữ liệu cho ComboBox Vai Trò
        /// </summary>
        [HttpGet("filters")]
        public async Task<IActionResult> GetFilterData()
        {
            var vaiTros = await _context.VaiTros
                .Select(t => new FilterLookupDto { Id = t.IdVaiTro, Ten = t.TenVaiTro })
                .OrderBy(t => t.Ten)
                .ToListAsync();

            return Ok(new { vaiTros });
        }

        /// <summary>
        /// API tạo báo cáo chính
        /// </summary>
        [HttpPost("report")]
        public async Task<IActionResult> GetHieuSuatReport([FromBody] BaoCaoHieuSuatRequestDto request)
        {
            var startDate = request.StartDate.Date;
            var endDate = request.EndDate.Date.AddDays(1);

            // Tham số hóa
            object pSearchTextValue = string.IsNullOrEmpty(request.SearchText) ? DBNull.Value : $"%{request.SearchText}%";
            var pStartDate = new SqlParameter("@StartDate", startDate);
            var pEndDate = new SqlParameter("@EndDate", endDate);
            var pVaiTroId = new SqlParameter("@VaiTroId", (object)request.VaiTroId ?? DBNull.Value);
            var pSearchText = new SqlParameter("@SearchText", string.IsNullOrEmpty(request.SearchText) ? (object)DBNull.Value : $"%{request.SearchText}%");

            // 1. TÍNH KPIs
            var kpi = (await _context.Database.SqlQuery<BaoCaoHieuSuatKpiDto>($@"
                SELECT
                    ISNULL(SUM(hd.thanhTien), 0) AS TongDoanhThu,
                    ISNULL(SUM(bc.soGioLam), 0) AS TongGioLam,
                    ISNULL(COUNT(bc.idChamCong), 0) AS TongSoCaLam,
                    ISNULL(COUNT(nkhm.idNhatKy), 0) AS TongLanHuyMon
                FROM dbo.NhanVien nv
                LEFT JOIN dbo.HoaDon hd ON nv.idNhanVien = hd.idNhanVien 
                    AND hd.trangThai = N'Đã thanh toán' AND hd.thoiGianThanhToan >= {pStartDate} AND hd.thoiGianThanhToan < {pEndDate}
                LEFT JOIN dbo.LichLamViec llv ON nv.idNhanVien = llv.idNhanVien 
                    AND llv.ngayLam >= {pStartDate} AND llv.ngayLam < {pEndDate}
                LEFT JOIN dbo.BangChamCong bc ON llv.idLichLamViec = bc.idLichLamViec
                LEFT JOIN dbo.NhatKyHuyMon nkhm ON nv.idNhanVien = nkhm.idNhanVienHuy 
                    AND nkhm.ThoiGianHuy >= {pStartDate} AND nkhm.ThoiGianHuy < {pEndDate}
                WHERE (nv.hoTen LIKE {pSearchText} OR {pSearchText} IS NULL)
                  AND (nv.idVaiTro = {pVaiTroId} OR {pVaiTroId} IS NULL);
            ").ToListAsync()).FirstOrDefault() ?? new BaoCaoHieuSuatKpiDto();
            
            // 2. TAB 1: HIỆU SUẤT BÁN HÀNG
            var salesPerformance = await _context.Database.SqlQuery<BaoCaoSalesDto>($@"
                SELECT
                    nv.hoTen,
                    vt.tenVaiTro,
                    ISNULL(SUM(hd.thanhTien), 0) AS TongDoanhThu,
                    ISNULL(COUNT(DISTINCT hd.idHoaDon), 0) AS SoHoaDon,
                    ISNULL(AVG(hd.thanhTien), 0) AS DoanhThuTrungBinh,
                    (SELECT COUNT(nkhm.idNhatKy) 
                     FROM dbo.NhatKyHuyMon nkhm 
                     WHERE nkhm.idNhanVienHuy = nv.idNhanVien 
                     AND nkhm.ThoiGianHuy >= {pStartDate} AND nkhm.ThoiGianHuy < {pEndDate}) AS SoLanHuyMon
                FROM dbo.NhanVien nv
                JOIN dbo.VaiTro vt ON nv.idVaiTro = vt.idVaiTro
                LEFT JOIN dbo.HoaDon hd ON nv.idNhanVien = hd.idNhanVien 
                    AND hd.trangThai = N'Đã thanh toán' 
                    AND hd.thoiGianThanhToan >= {pStartDate} AND hd.thoiGianThanhToan < {pEndDate}
                WHERE
                    (vt.tenVaiTro IN (N'Thu ngân', N'Phục vụ', N'Quản lý', N'Quản trị viên'))
                    AND (nv.hoTen LIKE {pSearchText} OR {pSearchText} IS NULL)
                    AND (nv.idVaiTro = {pVaiTroId} OR {pVaiTroId} IS NULL)
                GROUP BY nv.idNhanVien, nv.hoTen, vt.tenVaiTro
                ORDER BY TongDoanhThu DESC;
            ").ToListAsync();
            
            // 3. TAB 2: HIỆU SUẤT VẬN HÀNH
            var operationalPerformance = await _context.Database.SqlQuery<BaoCaoOperationsDto>($@"
                SELECT
                    nv.hoTen,
                    vt.tenVaiTro,
                    (SELECT COUNT(idPhieuNhapKho) FROM PhieuNhapKho WHERE idNhanVien = nv.idNhanVien AND ngayNhap >= {pStartDate} AND ngayNhap < {pEndDate}) AS PhieuNhap,
                    (SELECT COUNT(idPhieuKiemKho) FROM PhieuKiemKho WHERE idNhanVienKiem = nv.idNhanVien AND NgayKiem >= {pStartDate} AND NgayKiem < {pEndDate}) AS PhieuKiem,
                    (SELECT COUNT(idPhieuXuatHuy) FROM PhieuXuatHuy WHERE idNhanVienXuat = nv.idNhanVien AND NgayXuatHuy >= {pStartDate} AND NgayXuatHuy < {pEndDate}) AS PhieuHuy,
                    (SELECT COUNT(idDonXinNghi) FROM DonXinNghi WHERE idNguoiDuyet = nv.idNhanVien AND NgayDuyet >= {pStartDate} AND NgayDuyet < {pEndDate}) AS DonDuyet
                FROM dbo.NhanVien nv
                JOIN dbo.VaiTro vt ON nv.idVaiTro = vt.idVaiTro
                WHERE
                    (vt.tenVaiTro IN (N'Quản lý', N'Quản trị viên', N'Pha chế'))
                    AND (nv.hoTen LIKE {pSearchText} OR {pSearchText} IS NULL)
                    AND (nv.idVaiTro = {pVaiTroId} OR {pVaiTroId} IS NULL)
                GROUP BY nv.idNhanVien, nv.hoTen, vt.tenVaiTro;
            ").ToListAsync();

            // 4. TAB 3: CHUYÊN CẦN
            var attendance = await _context.Database.SqlQuery<BaoCaoAttendanceDto>($@"
                SELECT
                    nv.hoTen,
                    ISNULL(COUNT(llv.idLichLamViec), 0) AS TongSoCaLam,
                    ISNULL(SUM(bc.soGioLam), 0) AS TongGioLam,
                    (SELECT COUNT(idDonXinNghi) FROM DonXinNghi WHERE idNhanVien = nv.idNhanVien AND NgayBatDau >= {pStartDate} AND NgayKetThuc < {pEndDate}) AS SoDonXinNghi,
                    (SELECT COUNT(idDonXinNghi) FROM DonXinNghi WHERE idNhanVien = nv.idNhanVien AND TrangThai = N'Đã duyệt' AND NgayBatDau >= {pStartDate} AND NgayKetThuc < {pEndDate}) AS SoDonDaDuyet,
                    (SELECT COUNT(idDonXinNghi) FROM DonXinNghi WHERE idNhanVien = nv.idNhanVien AND TrangThai = N'Chờ duyệt' AND NgayBatDau >= {pStartDate} AND NgayKetThuc < {pEndDate}) AS SoDonChoDuyet
                FROM dbo.NhanVien nv
                LEFT JOIN dbo.LichLamViec llv ON nv.idNhanVien = llv.idNhanVien
                    AND llv.ngayLam >= {pStartDate} AND llv.ngayLam < {pEndDate}
                LEFT JOIN dbo.BangChamCong bc ON llv.idLichLamViec = bc.idLichLamViec
                WHERE (nv.hoTen LIKE {pSearchText} OR {pSearchText} IS NULL)
                  AND (nv.idVaiTro = {pVaiTroId} OR {pVaiTroId} IS NULL)
                GROUP BY nv.idNhanVien, nv.hoTen;
            ").ToListAsync();

            // 5. TỔNG HỢP KẾT QUẢ
            var dto = new BaoCaoHieuSuatTongHopDto
            {
                Kpi = kpi,
                SalesPerformance = salesPerformance,
                OperationalPerformance = operationalPerformance,
                Attendance = attendance
            };

            return Ok(dto);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\BaoCaoNhanSuController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/baocaonhansu")]
    [ApiController]
    public class BaoCaoNhanSuController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public BaoCaoNhanSuController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API Lấy các bộ lọc (Nhân viên, Vai trò)
        /// </summary>
        [HttpGet("filters")]
        public async Task<IActionResult> GetFilters()
        {
            var dto = new BaoCaoNhanSu_FiltersDto
            {
                // Lấy tất cả NV (cả nghỉ việc)
                NhanViens = await _context.NhanViens
                    .OrderBy(nv => nv.HoTen)
                    .Select(nv => new NhanVienLookupDto { IdNhanVien = nv.IdNhanVien, HoTen = nv.HoTen })
                    .ToListAsync(),

                VaiTros = await _context.VaiTros
                    .OrderBy(v => v.TenVaiTro)
                    .Select(v => new FilterLookupDto { Id = v.IdVaiTro, Ten = v.TenVaiTro })
                    .ToListAsync()
            };
            return Ok(dto);
        }

        /// <summary>
        /// API Tạo Báo Cáo Tổng Hợp (Đã sửa lỗi LINQ)
        /// </summary>
        [HttpPost("report")]
        public async Task<IActionResult> GetHrReport([FromBody] BaoCaoNhanSuRequestDto filters)
        {
            var report = new BaoCaoNhanSuDto();

            // 1. Lọc danh sách nhân viên cơ sở (base query)
            var nhanVienQuery = _context.NhanViens
                .Include(nv => nv.VaiTro)
                .AsQueryable();

            if (filters.IdNhanVien > 0)
                nhanVienQuery = nhanVienQuery.Where(nv => nv.IdNhanVien == filters.IdNhanVien);
            if (filters.IdVaiTro > 0)
                nhanVienQuery = nhanVienQuery.Where(nv => nv.IdVaiTro == filters.IdVaiTro);
            if (filters.TrangThaiNhanVien != "Tất cả")
                nhanVienQuery = nhanVienQuery.Where(nv => nv.TrangThaiLamViec == filters.TrangThaiNhanVien);

            var nhanVienIds = await nhanVienQuery.Select(nv => nv.IdNhanVien).ToListAsync();
            report.Kpi.SoLuongNhanVien = nhanVienIds.Count;

            // Lấy danh sách nhân viên (đã lọc) để join ở client
            var nhanVienDaLoc = await nhanVienQuery.ToDictionaryAsync(nv => nv.IdNhanVien);

            // 2. Lấy dữ liệu Phiếu Lương (Tab 1, Chart, và KPI Lương/Giờ)
            var phieuLuongQuery = _context.PhieuLuongs
                .Where(p => nhanVienIds.Contains(p.IdNhanVien) &&
                            p.NgayTao >= filters.StartDate &&
                            p.NgayTao <= filters.EndDate);

            report.Kpi.TongLuongDaTra = await phieuLuongQuery.SumAsync(p => p.ThucLanh);
            report.Kpi.TongGioLam = await phieuLuongQuery.SumAsync(p => p.TongGioLam); // Sửa: Gỡ (decimal)

            // Dùng ToList() để thực thi truy vấn SQL
            var bangLuongData = await phieuLuongQuery
                .GroupBy(p => p.IdNhanVien) // Group theo ID
                .Select(g => new
                {
                    IdNhanVien = g.Key,
                    TongGioLam = g.Sum(p => p.TongGioLam),
                    TongLuongCoBan = g.Sum(p => p.LuongCoBan * p.TongGioLam), // Tính tổng trước

                    // === SỬA LỖI CS0266 TẠI ĐÂY ===
                    TongThuong = g.Sum(p => p.TienThuong) ?? 0m,
                    TongPhat = g.Sum(p => p.KhauTru) ?? 0m,
                    // === KẾT THÚC SỬA LỖI ===

                    ThucLanh = g.Sum(p => p.ThucLanh)
                })
                .ToListAsync(); // <-- THỰC THI TRUY VẤN TẠI ĐÂY

            // Join ở client-side
            report.BangLuongChiTiet = bangLuongData
                .Where(bl => nhanVienDaLoc.ContainsKey(bl.IdNhanVien)) // Đảm bảo nhân viên vẫn còn trong bộ lọc
                .Select(bl => new BaoCaoNhanSu_BangLuongDto
                {
                    IdNhanVien = bl.IdNhanVien,
                    HoTenNhanVien = nhanVienDaLoc[bl.IdNhanVien].HoTen,
                    TenVaiTro = nhanVienDaLoc[bl.IdNhanVien].VaiTro.TenVaiTro,
                    TongGioLam = bl.TongGioLam,
                    TongLuongCoBan = bl.TongLuongCoBan,
                    TongThuong = bl.TongThuong, // Đã là decimal (không phải decimal?)
                    TongPhat = bl.TongPhat,   // Đã là decimal (không phải decimal?)
                    ThucLanh = bl.ThucLanh
                })
                .OrderByDescending(x => x.ThucLanh)
                .ToList();


            // 3. Lấy dữ liệu Nghỉ Phép (Tab 2 và KPI Nghỉ)
            var donNghiQuery = _context.DonXinNghis
                .Where(d => nhanVienIds.Contains(d.IdNhanVien) &&
                            d.TrangThai == "Đã duyệt" &&
                            d.NgayBatDau >= filters.StartDate &&
                            d.NgayKetThuc <= filters.EndDate);

            // Bước 1: Tải dữ liệu thô về RAM
            var donNghiData = await donNghiQuery
                .Select(d => new
                {
                    d.IdNhanVien,
                    d.NgayBatDau,
                    d.NgayKetThuc
                })
                .ToListAsync(); // <-- THỰC THI TRUY VẤN

            // Bước 2: Group và Tính toán ở client-side (trong RAM)
            var nghiPhepData = donNghiData
                .GroupBy(d => d.IdNhanVien)
                .Select(g => new
                {
                    IdNhanVien = g.Key,
                    SoDonDaDuyet = g.Count(),
                    // Tính tổng số ngày nghỉ (giờ đã ở client-side)
                    TongSoNgayNghi = g.Sum(d => (d.NgayKetThuc.Date - d.NgayBatDau.Date).Days + 1)
                })
                .ToList();

            // Bước 3: Join với thông tin nhân viên
            report.ThongKeNghiPhep = nghiPhepData
                .Where(np => nhanVienDaLoc.ContainsKey(np.IdNhanVien)) // Đảm bảo nhân viên vẫn còn trong bộ lọc
                .Select(x => new BaoCaoNhanSu_NghiPhepDto
                {
                    IdNhanVien = x.IdNhanVien,
                    HoTenNhanVien = nhanVienDaLoc[x.IdNhanVien].HoTen,
                    TenVaiTro = nhanVienDaLoc[x.IdNhanVien].VaiTro.TenVaiTro,
                    SoDonDaDuyet = x.SoDonDaDuyet,
                    TongSoNgayNghi = x.TongSoNgayNghi
                })
                .OrderByDescending(x => x.TongSoNgayNghi)
                .ToList();

            report.Kpi.TongSoNgayNghi = report.ThongKeNghiPhep.Sum(x => x.TongSoNgayNghi);

            // 4. Lấy dữ liệu Biểu đồ (Tổng lương trả theo ngày)
            report.LuongChartData = await phieuLuongQuery
                .GroupBy(p => p.NgayTao.Date)
                .Select(g => new ChartDataPoint
                {
                    Ngay = g.Key,
                    TongTien = g.Sum(p => p.ThucLanh)
                })
                .OrderBy(c => c.Ngay)
                .ToListAsync();

            return Ok(report);
        }
    }

    // (Lưu ý: Bạn không cần class DbFunctions ở đây vì chúng ta đã chuyển
    // logic tính toán ra ngoài SQL (sau khi ToListAsync))
    // Bạn có thể xóa class DbFunctions nếu nó chỉ dùng cho việc này.

    // (Nếu bạn vẫn dùng DbFunctions ở nơi khác, hãy giữ nó lại)
    public static class DbFunctions
    {
        [DbFunction(Name = "DATEDIFF", IsBuiltIn = true)]
        public static int DateDiffDay(DateTime startDate, DateTime endDate)
        {
            throw new NotSupportedException();
        }
    }
}

================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\BaoCaoSachController.cs
================================================================================
﻿// Tập tin: CafebookApi/Controllers/App/BaoCaoSachController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;
using System;
using System.Collections.Generic; // Thêm

namespace CafebookApi.Controllers.App
{
    [Route("api/app/baocaosach")]
    [ApiController]
    public class BaoCaoSachController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public BaoCaoSachController(CafebookDbContext context)
        {
            _context = context;
        }

        [HttpGet("filters")]
        public async Task<IActionResult> GetFilterData()
        {
            var theLoais = await _context.TheLoais
                .Select(t => new FilterLookupDto { Id = t.IdTheLoai, Ten = t.TenTheLoai, MoTa = t.MoTa })
                .OrderBy(t => t.Ten)
                .ToListAsync();

            var tacGias = await _context.TacGias
                .Select(t => new FilterLookupDto { Id = t.IdTacGia, Ten = t.TenTacGia, MoTa = t.GioiThieu })
                .OrderBy(t => t.Ten)
                .ToListAsync();

            return Ok(new { theLoais, tacGias });
        }

        [HttpPost("report")]
        public async Task<IActionResult> GetSachReport([FromBody] BaoCaoSachRequestDto request)
        {
            // SỬA LỖI: Chuyển sang biến đơn giản để EF Core tự tham số hóa
            string? pSearchText = string.IsNullOrEmpty(request.SearchText) ? null : $"%{request.SearchText}%";
            int? pTheLoaiId = request.TheLoaiId == 0 ? null : request.TheLoaiId;
            int? pTacGiaId = request.TacGiaId == 0 ? null : request.TacGiaId;

            // 1. TÍNH KPIs (Không đổi)
            var kpi = (await _context.Database.SqlQuery<BaoCaoSachKpiDto>($@"
                SELECT
                    ISNULL(COUNT(DISTINCT idSach), 0) AS TongDauSach,
                    ISNULL(SUM(soLuongTong), 0) AS TongSoLuong,
                    (SELECT ISNULL(COUNT(idSach), 0) FROM dbo.ChiTietPhieuThue WHERE ngayTraThucTe IS NULL) AS DangChoThue,
                    (ISNULL(SUM(soLuongTong), 0) - (SELECT ISNULL(COUNT(idSach), 0) FROM dbo.ChiTietPhieuThue WHERE ngayTraThucTe IS NULL)) AS SanSang
                FROM dbo.Sach;
            ").ToListAsync()).FirstOrDefault() ?? new BaoCaoSachKpiDto();

            // 2. TAB 1: TỒN KHO CHI TIẾT (VIẾT LẠI HOÀN TOÀN)
            var chiTietTonKho = await _context.Database.SqlQuery<BaoCaoSachChiTietDto>($@"
                WITH SachDangThue AS (
                    SELECT idSach, COUNT(idSach) AS SoLuongDangMuon
                    FROM dbo.ChiTietPhieuThue
                    WHERE ngayTraThucTe IS NULL
                    GROUP BY idSach
                ),
                SachTacGiasAgg AS (
                    SELECT
                        stg.idSach,
                        STRING_AGG(tg.tenTacGia, ', ') AS tenTacGia
                    FROM dbo.Sach_TacGia stg
                    JOIN dbo.TacGia tg ON stg.idTacGia = tg.idTacGia
                    GROUP BY stg.idSach
                ),
                SachTheLoaisAgg AS (
                    SELECT
                        stl.idSach,
                        STRING_AGG(tl.tenTheLoai, ', ') AS tenTheLoai
                    FROM dbo.Sach_TheLoai stl
                    JOIN dbo.TheLoai tl ON stl.idTheLoai = tl.idTheLoai
                    GROUP BY stl.idSach
                )
                SELECT
                    s.tenSach,
                    ISNULL(stg_agg.tenTacGia, 'N/A') AS tenTacGia,
                    ISNULL(stl_agg.tenTheLoai, 'N/A') AS tenTheLoai,
                    s.soLuongTong,
                    ISNULL(sdt.SoLuongDangMuon, 0) AS SoLuongDangMuon,
                    (s.soLuongTong - ISNULL(sdt.SoLuongDangMuon, 0)) AS SoLuongConLai
                FROM dbo.Sach s
                LEFT JOIN SachTheLoaisAgg stl_agg ON s.idSach = stl_agg.idSach
                LEFT JOIN SachTacGiasAgg stg_agg ON s.idSach = stg_agg.idSach
                LEFT JOIN SachDangThue sdt ON s.idSach = sdt.idSach
                WHERE
                    (s.tenSach LIKE {pSearchText} OR stg_agg.tenTacGia LIKE {pSearchText} OR {pSearchText} IS NULL)
                    AND (EXISTS(SELECT 1 FROM dbo.Sach_TheLoai stl WHERE stl.idSach = s.idSach AND stl.idTheLoai = {pTheLoaiId}) OR {pTheLoaiId} IS NULL)
                    AND (EXISTS(SELECT 1 FROM dbo.Sach_TacGia stg WHERE stg.idSach = s.idSach AND stg.idTacGia = {pTacGiaId}) OR {pTacGiaId} IS NULL)
                ORDER BY SoLuongConLai ASC, s.tenSach;
            ").ToListAsync();

            // 3. TAB 2: SÁCH TRỄ HẠN (Không đổi)
            var sachTreHan = await _context.Database.SqlQuery<BaoCaoSachTreHanDto>($@"
                SELECT
                    s.tenSach,
                    kh.hoTen,
                    kh.soDienThoai,
                    pts.ngayThue,
                    ctpt.ngayHenTra,
                    CASE
                        WHEN ctpt.ngayHenTra < GETDATE() 
                        THEN N'Trễ ' + CAST(DATEDIFF(DAY, ctpt.ngayHenTra, GETDATE()) AS NVARCHAR) + N' ngày'
                        ELSE N'Đang thuê'
                    END AS TinhTrang
                FROM dbo.ChiTietPhieuThue ctpt
                JOIN dbo.PhieuThueSach pts ON ctpt.idPhieuThueSach = pts.idPhieuThueSach
                JOIN dbo.Sach s ON ctpt.idSach = s.idSach
                JOIN dbo.KhachHang kh ON pts.idKhachHang = kh.idKhachHang
                WHERE ctpt.ngayTraThucTe IS NULL
                ORDER BY ctpt.ngayHenTra ASC;
            ").ToListAsync();

            // 4. TAB 3: TOP SÁCH THUÊ (VIẾT LẠI)
            var topSachThue = await _context.Database.SqlQuery<TopSachDuocThueDto>($@"
                WITH SachTacGiasAgg AS (
                    SELECT
                        stg.idSach,
                        STRING_AGG(tg.tenTacGia, ', ') AS tenTacGia
                    FROM dbo.Sach_TacGia stg
                    JOIN dbo.TacGia tg ON stg.idTacGia = tg.idTacGia
                    GROUP BY stg.idSach
                )
                SELECT TOP 10
                    s.tenSach,
                    ISNULL(stg_agg.tenTacGia, 'N/A') AS tenTacGia,
                    COUNT(ctpt.idSach) AS TongLuotThue
                FROM dbo.ChiTietPhieuThue ctpt
                JOIN dbo.Sach s ON ctpt.idSach = s.idSach
                LEFT JOIN SachTacGiasAgg stg_agg ON s.idSach = stg_agg.idSach
                GROUP BY s.tenSach, stg_agg.tenTacGia
                ORDER BY TongLuotThue DESC;
            ").ToListAsync();

            // 5. TỔNG HỢP KẾT QUẢ (Không đổi)
            var dto = new BaoCaoSachTongHopDto
            {
                Kpi = kpi,
                ChiTietTonKho = chiTietTonKho,
                SachTreHan = sachTreHan,
                TopSachThue = topSachThue
            };

            return Ok(dto);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\BaoCaoTonKhoController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Data.SqlClient;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;
using System;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/baocaokho")]
    [ApiController]
    public class BaoCaoTonKhoController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public BaoCaoTonKhoController(CafebookDbContext context)
        {
            _context = context;
        }

        [HttpGet("filters")]
        public async Task<IActionResult> GetFilterData()
        {
            var nhaCungCaps = await _context.NhaCungCaps
                .Select(t => new FilterLookupDto { Id = t.IdNhaCungCap, Ten = t.TenNhaCungCap })
                .OrderBy(t => t.Ten)
                .ToListAsync();

            return Ok(new { nhaCungCaps });
        }

        [HttpPost("report")]
        public async Task<IActionResult> GetKhoReport([FromBody] BaoCaoTonKhoRequestDto request)
        {
            // --- 1. TÍNH KPIs ---

            // KPI a: Tổng giá trị tồn kho (ĐÃ XÓA CÁC THẺ [cite] GÂY LỖI)
            var kpiGiaTriKho = await _context.Database.SqlQuery<decimal>($@"
                WITH GiaVonNguyenLieu AS (
                    SELECT idNguyenLieu, AVG(donGiaNhap) AS GiaVonTrungBinh
                    FROM dbo.ChiTietNhapKho
                    GROUP BY idNguyenLieu
                )
                SELECT ISNULL(SUM(nl.tonKho * ISNULL(gv.GiaVonTrungBinh, 0)), 0)
                FROM dbo.NguyenLieu nl
                LEFT JOIN GiaVonNguyenLieu gv ON nl.idNguyenLieu = gv.idNguyenLieu;
            ").ToListAsync();

            // KPI b: Số lượng SP sắp hết
            var kpiSapHet = await _context.Database.SqlQuery<int>($@"
                SELECT ISNULL(COUNT(idNguyenLieu), 0) FROM NguyenLieu WHERE tonKho <= TonKhoToiThieu;
            ").ToListAsync();

            // KPI c: Tổng giá trị đã hủy (trong kỳ, giả sử 30 ngày)
            var kpiHuyHang = await _context.Database.SqlQuery<decimal>($@"
                SELECT ISNULL(SUM(TongGiaTriHuy), 0) FROM PhieuXuatHuy
                WHERE NgayXuatHuy >= DATEADD(day, -30, GETDATE());
            ").ToListAsync();

            var kpi = new BaoCaoTonKhoKpiDto
            {
                TongGiaTriTonKho = kpiGiaTriKho.FirstOrDefault(),
                SoLuongSPSapHet = kpiSapHet.FirstOrDefault(),
                TongGiaTriDaHuy = kpiHuyHang.FirstOrDefault()
            };

            // --- 2. TAB 1: TỒN KHO CHI TIẾT ---
            var pSearchText = new SqlParameter("@SearchText", string.IsNullOrEmpty(request.SearchText) ? (object)DBNull.Value : $"%{request.SearchText}%");
            var pShowLowStockOnly = new SqlParameter("@ShowLowStockOnly", request.ShowLowStockOnly);
            // (Lưu ý: Lọc theo NCC bị bỏ qua vì logic phức tạp, không có trong thiết kế SQL)

            var chiTietTonKho = await _context.Database.SqlQuery<BaoCaoTonKhoChiTietDto>($@"
                SELECT
                    tenNguyenLieu,
                    donViTinh,
                    tonKho,
                    TonKhoToiThieu,
                    CASE
                        WHEN tonKho = 0 THEN N'Hết hàng'
                        WHEN tonKho <= TonKhoToiThieu THEN N'Sắp hết'
                        ELSE N'Đủ dùng'
                    END AS TinhTrang
                FROM dbo.NguyenLieu
                WHERE
                    (tenNguyenLieu LIKE {pSearchText} OR {pSearchText} IS NULL)
                    AND ({pShowLowStockOnly} = 0 OR tonKho <= TonKhoToiThieu)
                ORDER BY
                    tonKho ASC;
            ").ToListAsync();

            // --- 3. TAB 2: LỊCH SỬ KIỂM KÊ ---
            var lichSuKiemKe = await _context.Database.SqlQuery<BaoCaoKiemKeDto>($@"
                SELECT
                    pkk.NgayKiem,
                    nl.tenNguyenLieu,
                    ctkk.TonKhoHeThong,
                    ctkk.TonKhoThucTe,
                    ctkk.ChenhLech,
                    ctkk.LyDoChenhLech
                FROM dbo.ChiTietKiemKho ctkk
                JOIN dbo.PhieuKiemKho pkk ON ctkk.idPhieuKiemKho = pkk.idPhieuKiemKho
                JOIN dbo.NguyenLieu nl ON ctkk.idNguyenLieu = nl.idNguyenLieu
                WHERE
                    ctkk.ChenhLech != 0
                ORDER BY
                    pkk.NgayKiem DESC;
            ").ToListAsync();

            // --- 4. TAB 3: LỊCH SỬ HỦY HÀNG ---
            var lichSuHuyHang = await _context.Database.SqlQuery<BaoCaoHuyHangDto>($@"
                SELECT
                    pxh.NgayXuatHuy AS NgayHuy,
                    nl.tenNguyenLieu,
                    ctxh.SoLuong AS SoLuongHuy,
                    ctxh.ThanhTien AS GiaTriHuy,
                    pxh.LyDoXuatHuy AS LyDoHuy
                FROM dbo.ChiTietXuatHuy ctxh
                JOIN dbo.PhieuXuatHuy pxh ON ctxh.idPhieuXuatHuy = pxh.idPhieuXuatHuy
                JOIN dbo.NguyenLieu nl ON ctxh.idNguyenLieu = nl.idNguyenLieu
                ORDER BY
                    pxh.NgayXuatHuy DESC;
            ").ToListAsync();

            // --- 5. TỔNG HỢP KẾT QUẢ ---
            var dto = new BaoCaoTonKhoTongHopDto
            {
                Kpi = kpi,
                ChiTietTonKho = chiTietTonKho,
                LichSuKiemKe = lichSuKiemKe,
                LichSuHuyHang = lichSuHuyHang
            };

            return Ok(dto);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\CaiDatController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using CafebookModel.Model.Entities; // Thêm
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq; // Cần thêm
using System.Threading.Tasks; // Cần thêm

namespace CafebookApi.Controllers.App
{
    [Route("api/app/caidat")]
    [ApiController]
    public class CaiDatController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public CaiDatController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API để lấy tất cả cài đặt
        /// </summary>
        [HttpGet("all")]
        public async Task<IActionResult> GetAllSettings()
        {
            var settings = await _context.CaiDats
                .Select(c => new CaiDatDto
                {
                    TenCaiDat = c.TenCaiDat,
                    GiaTri = c.GiaTri,
                    MoTa = c.MoTa
                })
                .ToListAsync();

            return Ok(settings);
        }

        /// <summary>
        /// API để cập nhật MỘT cài đặt (lưu từng cái một)
        /// </summary>
        [HttpPut("update-single")]
        public async Task<IActionResult> UpdateSingleSetting([FromBody] CaiDatDto settingToSave)
        {
            if (settingToSave == null)
            {
                return BadRequest("Dữ liệu không hợp lệ.");
            }

            try
            {
                var settingInDb = await _context.CaiDats.FindAsync(settingToSave.TenCaiDat);

                if (settingInDb != null)
                {
                    settingInDb.GiaTri = settingToSave.GiaTri; // Chỉ cập nhật giá trị
                    await _context.SaveChangesAsync();
                    return Ok(new { message = "Cập nhật thành công!" });
                }

                return NotFound("Không tìm thấy cài đặt.");
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Lỗi máy chủ: {ex.Message}");
            }
        }

        /// <summary>
        /// API mới: Lấy thông tin cơ bản của cửa hàng
        /// </summary>
        [HttpGet("thong-tin-cua-hang")]
        public async Task<IActionResult> GetThongTinCuaHang()
        {
            var settings = await _context.CaiDats
                                    .Where(c => c.TenCaiDat == "TenQuan" ||
                                                c.TenCaiDat == "DiaChi" ||
                                                c.TenCaiDat == "SoDienThoai")
                                    .ToListAsync();

            var dto = new CaiDatThongTinCuaHangDto
            {
                TenQuan = settings.FirstOrDefault(c => c.TenCaiDat == "TenQuan")?.GiaTri ?? "Cafe Sách",
                DiaChi = settings.FirstOrDefault(c => c.TenCaiDat == "DiaChi")?.GiaTri ?? "N/A",
                SoDienThoai = settings.FirstOrDefault(c => c.TenCaiDat == "SoDienThoai")?.GiaTri ?? "N/A"
            };

            return Ok(dto);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\CaiDatNhanSuController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/caidatnhansu")]
    [ApiController]
    public class CaiDatNhanSuController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public CaiDatNhanSuController(CafebookDbContext context)
        {
            _context = context;
        }

        // Hàm helper để đọc Cài đặt an toàn
        private string GetSetting(List<CaiDat> settings, string key, string defaultValue)
        {
            return settings.FirstOrDefault(c => c.TenCaiDat == key)?.GiaTri ?? defaultValue;
        }

        /// <summary>
        /// API Lấy tất cả Cài đặt Nhân sự
        /// </summary>
        [HttpGet("all")]
        public async Task<IActionResult> GetAllHrSettings()
        {
            var allSettings = await _context.CaiDats
                .Where(c => c.TenCaiDat.StartsWith("HR_"))
                .ToListAsync();

            // Dùng CultureInfo.InvariantCulture để đảm bảo dấu chấm (.) là dấu thập phân
            var dto = new CaiDatNhanSuDto
            {
                GioLamChuan = decimal.Parse(GetSetting(allSettings, "HR_GioLamChuan", "8"), CultureInfo.InvariantCulture),
                HeSoOT = decimal.Parse(GetSetting(allSettings, "HR_HeSoOT", "1.5"), CultureInfo.InvariantCulture),
                PhatDiTre_Phut = int.Parse(GetSetting(allSettings, "HR_PhatDiTre_Phut", "5")),
                PhatDiTre_HeSo = decimal.Parse(GetSetting(allSettings, "HR_PhatDiTre_HeSo", "1.0"), CultureInfo.InvariantCulture),
                ChuyenCan_SoNgay = int.Parse(GetSetting(allSettings, "HR_ChuyenCan_SoNgay", "26")),
                ChuyenCan_TienThuong = decimal.Parse(GetSetting(allSettings, "HR_ChuyenCan_TienThuong", "0"), CultureInfo.InvariantCulture),
                PhepNam_MacDinh = int.Parse(GetSetting(allSettings, "HR_PhepNam_MacDinh", "12"))
            };

            return Ok(dto);
        }

        /// <summary>
        /// API Cập nhật (Lưu) tất cả Cài đặt Nhân sự
        /// </summary>
        [HttpPut("update")]
        public async Task<IActionResult> UpdateHrSettings([FromBody] CaiDatNhanSuDto dto)
        {
            if (dto == null) return BadRequest("Dữ liệu không hợp lệ.");

            // Dùng Transaction để đảm bảo lưu tất cả hoặc không lưu gì cả
            using (var transaction = await _context.Database.BeginTransactionAsync())
            {
                try
                {
                    // Hàm helper để cập nhật Cài đặt
                    async Task UpdateSetting(string key, string value)
                    {
                        var setting = await _context.CaiDats.FindAsync(key);
                        if (setting != null)
                        {
                            setting.GiaTri = value;
                        }
                        // Nếu không tìm thấy (do SQL script chưa chạy), thì tạo mới
                        else
                        {
                            _context.CaiDats.Add(new CaiDat { TenCaiDat = key, GiaTri = value, MoTa = "Auto-generated HR Setting" });
                        }
                    }

                    // Dùng CultureInfo.InvariantCulture để lưu dấu chấm (.)
                    await UpdateSetting("HR_GioLamChuan", dto.GioLamChuan.ToString(CultureInfo.InvariantCulture));
                    await UpdateSetting("HR_HeSoOT", dto.HeSoOT.ToString(CultureInfo.InvariantCulture));
                    await UpdateSetting("HR_PhatDiTre_Phut", dto.PhatDiTre_Phut.ToString());
                    await UpdateSetting("HR_PhatDiTre_HeSo", dto.PhatDiTre_HeSo.ToString(CultureInfo.InvariantCulture));
                    await UpdateSetting("HR_ChuyenCan_SoNgay", dto.ChuyenCan_SoNgay.ToString());
                    await UpdateSetting("HR_ChuyenCan_TienThuong", dto.ChuyenCan_TienThuong.ToString(CultureInfo.InvariantCulture));
                    await UpdateSetting("HR_PhepNam_MacDinh", dto.PhepNam_MacDinh.ToString());

                    await _context.SaveChangesAsync();
                    await transaction.CommitAsync();

                    return Ok(new { message = "Lưu cài đặt nhân sự thành công!" });
                }
                catch (Exception ex)
                {
                    await transaction.RollbackAsync();
                    return StatusCode(500, $"Lỗi khi lưu cài đặt: {ex.Message}");
                }
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\CaLamViecController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/calamviec")]
    [ApiController]
    public class CaLamViecController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public CaLamViecController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API Lấy tất cả Ca Làm Việc (Mẫu)
        /// </summary>
        [HttpGet("all")]
        public async Task<IActionResult> GetAll()
        {
            var data = await _context.CaLamViecs
                .Select(c => new CaLamViecDto
                {
                    IdCa = c.IdCa,
                    TenCa = c.TenCa,
                    GioBatDau = c.GioBatDau,
                    GioKetThuc = c.GioKetThuc
                })
                .OrderBy(c => c.GioBatDau)
                .ToListAsync();
            return Ok(data);
        }

        /// <summary>
        /// API Thêm mới Ca Mẫu
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> Create([FromBody] CaLamViecDto dto)
        {
            var entity = new CaLamViec
            {
                TenCa = dto.TenCa,
                GioBatDau = dto.GioBatDau,
                GioKetThuc = dto.GioKetThuc
            };
            _context.CaLamViecs.Add(entity);
            await _context.SaveChangesAsync();
            return Ok(entity);
        }

        /// <summary>
        /// API Cập nhật Ca Mẫu
        /// </summary>
        [HttpPut("{id}")]
        public async Task<IActionResult> Update(int id, [FromBody] CaLamViecDto dto)
        {
            var entity = await _context.CaLamViecs.FindAsync(id);
            if (entity == null) return NotFound();

            entity.TenCa = dto.TenCa;
            entity.GioBatDau = dto.GioBatDau;
            entity.GioKetThuc = dto.GioKetThuc;

            await _context.SaveChangesAsync();
            return Ok();
        }

        /// <summary>
        /// API Xóa Ca Mẫu
        /// </summary>
        [HttpDelete("{id}")]
        public async Task<IActionResult> Delete(int id)
        {
            // Kiểm tra ràng buộc
            if (await _context.LichLamViecs.AnyAsync(l => l.IdCa == id))
            {
                return Conflict("Không thể xóa. Ca làm việc này đang được sử dụng trong Lịch Làm Việc.");
            }

            var entity = await _context.CaLamViecs.FindAsync(id);
            if (entity == null) return NotFound();

            _context.CaLamViecs.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\DashboardController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/dashboard")]
    [ApiController]
    public class DashboardController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public DashboardController(CafebookDbContext context)
        {
            _context = context;
        }

        [HttpGet("summary")]
        public async Task<IActionResult> GetDashboardSummary()
        {
            var dto = new DashboardSummaryDto();

            DateTime today = DateTime.Today;
            DateTime tomorrow = today.AddDays(1);
            DateTime startDate30Days = today.AddDays(-29);

            // 1. Lấy các hóa đơn đã thanh toán hôm nay
            var hoaDonsHomNay = _context.HoaDons
                .Where(h => h.ThoiGianThanhToan >= today &&
                            h.ThoiGianThanhToan < tomorrow &&
                            h.TrangThai == "Đã thanh toán");

            // 2. Tính KPI Thẻ
            dto.TongDoanhThuHomNay = await hoaDonsHomNay.SumAsync(h => h.ThanhTien);
            dto.TongDonHangHomNay = await hoaDonsHomNay.CountAsync();

            // 3. Lấy sản phẩm bán chạy hôm nay
            var spBanChayQuery = await _context.ChiTietHoaDons
                .Where(ct => ct.HoaDon.ThoiGianThanhToan >= today && ct.HoaDon.ThoiGianThanhToan < tomorrow && ct.HoaDon.TrangThai == "Đã thanh toán")
                .GroupBy(ct => ct.IdSanPham)
                .Select(g => new {
                    Id = g.Key,
                    SoLuong = g.Sum(ct => ct.SoLuong)
                })
                .OrderByDescending(x => x.SoLuong)
                .FirstOrDefaultAsync();

            if (spBanChayQuery != null)
            {
                var sanPham = await _context.SanPhams.FindAsync(spBanChayQuery.Id);
                dto.SanPhamBanChayHomNay = sanPham?.TenSanPham ?? "Không rõ";
            }

            // 4. Lấy dữ liệu biểu đồ 30 ngày
            var doanhThuQuery = await _context.HoaDons
                .Where(h => h.ThoiGianThanhToan >= startDate30Days && h.TrangThai == "Đã thanh toán")
                .GroupBy(h => h.ThoiGianThanhToan!.Value.Date) // Group by ngày
                .Select(g => new ChartDataPoint
                {
                    Ngay = g.Key,
                    TongTien = g.Sum(h => h.ThanhTien)
                })
                .OrderBy(dp => dp.Ngay)
                .ToListAsync();

            // Điền vào các ngày bị thiếu (nếu không có doanh thu)
            dto.DoanhThu30Ngay = Enumerable.Range(0, 30)
                .Select(i => startDate30Days.AddDays(i))
                .GroupJoin(doanhThuQuery, // Left join
                           ngay => ngay,
                           data => data.Ngay,
                           (ngay, data) => data.SingleOrDefault(new ChartDataPoint { Ngay = ngay, TongTien = 0 }))
                .ToList();

            return Ok(dto);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\DonHangController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using CafebookModel.Model.Entities;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Linq;
using System.Threading.Tasks;
using System.Collections.Generic; // <-- THÊM
using CafebookModel.Model.ModelApp.NhanVien; // <-- THÊM

namespace CafebookApi.Controllers.App
{
    [Route("api/app/donhang")]
    [ApiController]
    public class DonHangController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        // THÊM: Cần cho việc In lại
        private Dictionary<string, string> _settings = new Dictionary<string, string>();

        public DonHangController(CafebookDbContext context)
        {
            _context = context;
        }

        // ### THÊM MỚI: Helper (Copy từ ThanhToanController) ###
        private async Task LoadCaiDat()
        {
            _settings = await _context.CaiDats
                .Where(c =>
                    c.TenCaiDat == "TenQuan" ||
                    c.TenCaiDat == "DiaChi" ||
                    c.TenCaiDat == "SoDienThoai" ||
                    c.TenCaiDat == "Wifi_MatKhau")
                .AsNoTracking()
                .ToDictionaryAsync(c => c.TenCaiDat, c => c.GiaTri);
        }

        /// <summary>
        /// API lấy dữ liệu cho các ComboBox lọc
        /// </summary>
        [HttpGet("filters")]
        public async Task<IActionResult> GetDonHangFilters()
        {
            var dto = new DonHangFiltersDto
            {
                NhanViens = await _context.NhanViens
                    .Select(nv => new FilterLookupDto { Id = nv.IdNhanVien, Ten = nv.HoTen })
                    .OrderBy(nv => nv.Ten)
                    .ToListAsync(),
                KhachHangs = await _context.KhachHangs
                    .Select(kh => new FilterLookupDto { Id = kh.IdKhachHang, Ten = kh.HoTen })
                    .OrderBy(kh => kh.Ten)
                    .ToListAsync()
            };
            return Ok(dto);
        }

        /// <summary>
        /// API Lấy danh sách Đơn hàng (có lọc)
        /// </summary>
        [HttpGet("search")]
        public async Task<IActionResult> SearchDonHang(
            [FromQuery] DateTime startDate,
            [FromQuery] DateTime endDate,
            [FromQuery] string? trangThai,
            [FromQuery] int? nhanVienId,
            [FromQuery] string? searchText)
        {
            var query = _context.HoaDons
                .Include(h => h.NhanVien)
                .Include(h => h.KhachHang)
                .Include(h => h.Ban)
                .Where(h => h.ThoiGianTao >= startDate && h.ThoiGianTao < endDate.AddDays(1))
                .AsQueryable();

            if (!string.IsNullOrEmpty(trangThai) && trangThai != "Tất cả")
            {
                query = query.Where(h => h.TrangThai == trangThai);
            }

            if (nhanVienId.HasValue && nhanVienId > 0)
            {
                query = query.Where(h => h.IdNhanVien == nhanVienId);
            }

            if (!string.IsNullOrEmpty(searchText))
            {
                string searchLower = searchText.ToLower();
                query = query.Where(h =>
                    h.IdHoaDon.ToString().Contains(searchLower) ||
                    (h.KhachHang != null && h.KhachHang.HoTen.ToLower().Contains(searchLower)) ||
                    (h.KhachHang != null && h.KhachHang.SoDienThoai != null && h.KhachHang.SoDienThoai.Contains(searchLower))
                );
            }

            var results = await query
                .OrderByDescending(h => h.ThoiGianTao)
                .Select(h => new DonHangDto
                {
                    IdHoaDon = h.IdHoaDon,
                    ThoiGianTao = h.ThoiGianTao,
                    TenNhanVien = h.NhanVien.HoTen,
                    TenKhachHang = h.KhachHang != null ? h.KhachHang.HoTen : "Khách vãng lai",
                    SoBan = h.Ban != null ? h.Ban.SoBan : "Mang về/Giao",
                    ThanhTien = h.ThanhTien,
                    TrangThai = h.TrangThai,
                    LoaiHoaDon = h.LoaiHoaDon
                })
                .ToListAsync();

            return Ok(results);
        }

        /// <summary>
        /// API Lấy chi tiết một Đơn hàng (Món + Phụ thu)
        /// </summary>
        // ### SỬA: Thay đổi hàm này ###
        [HttpGet("details/{id}")]
        public async Task<IActionResult> GetDonHangDetails(int id)
        {
            var items = await _context.ChiTietHoaDons
                .Where(ct => ct.IdHoaDon == id)
                .Include(ct => ct.SanPham)
                .Select(ct => new DonHangChiTietDto
                {
                    TenSanPham = ct.SanPham.TenSanPham,
                    SoLuong = ct.SoLuong,
                    ThanhTien = ct.ThanhTien
                })
                .ToListAsync();

            var surcharges = await _context.ChiTietPhuThuHoaDons
                .Where(pt => pt.IdHoaDon == id)
                .Include(pt => pt.PhuThu)
                .Select(pt => new PhuThuDto
                {
                    IdPhuThu = pt.IdPhuThu,
                    TenPhuThu = pt.PhuThu.TenPhuThu,
                    SoTien = pt.SoTien,
                    GiaTri = pt.PhuThu.GiaTri,
                    LoaiGiaTri = pt.PhuThu.LoaiGiaTri
                })
                .ToListAsync();

            return Ok(new DonHangFullDetailsDto
            {
                Items = items,
                Surcharges = surcharges
            });
        }

        // ### THÊM MỚI: API Lấy dữ liệu In lại ###
        [HttpGet("reprint-data/{id}")]
        public async Task<IActionResult> GetReprintData(int id)
        {
            await LoadCaiDat();

            var hoaDon = await _context.HoaDons
                .Include(h => h.Ban)
                .Include(h => h.NhanVien)
                .Include(h => h.KhachHang)
                .AsNoTracking()
                .FirstOrDefaultAsync(h => h.IdHoaDon == id);

            if (hoaDon == null) return NotFound("Không tìm thấy hóa đơn.");

            var items = await _context.ChiTietHoaDons
                .Where(ct => ct.IdHoaDon == id)
                .AsNoTracking()
                .Select(c => new ChiTietDto
                {
                    IdChiTietHoaDon = c.IdChiTietHoaDon,
                    IdSanPham = c.IdSanPham,
                    TenSanPham = c.SanPham.TenSanPham,
                    SoLuong = c.SoLuong,
                    DonGia = c.DonGia,
                    ThanhTien = c.ThanhTien
                }).ToListAsync();

            var surcharges = await _context.ChiTietPhuThuHoaDons
                .Where(pt => pt.IdHoaDon == id)
                .AsNoTracking()
                .Select(pt => new PhuThuDto
                {
                    IdPhuThu = pt.IdPhuThu,
                    TenPhuThu = pt.PhuThu.TenPhuThu,
                    SoTien = pt.SoTien,
                    GiaTri = pt.PhuThu.GiaTri,
                    LoaiGiaTri = pt.PhuThu.LoaiGiaTri
                }).ToListAsync();

            // Lấy giao dịch thanh toán (để lấy tiền khách đưa)
            var payment = await _context.GiaoDichThanhToans
                .AsNoTracking()
                .FirstOrDefaultAsync(g => g.IdHoaDon == id);

            decimal khachDua = (payment?.CongThanhToan == "Tiền mặt") ? payment.SoTien : hoaDon.ThanhTien;

            var previewData = new HoaDonPreviewDto
            {
                IsProvisional = false, // Luôn là hóa đơn cuối cùng
                TenQuan = _settings.GetValueOrDefault("TenQuan", "CafeBook"),
                DiaChi = _settings.GetValueOrDefault("DiaChi", "N/A"),
                SoDienThoai = _settings.GetValueOrDefault("SoDienThoai", "N/A"),
                WifiMatKhau = _settings.GetValueOrDefault("Wifi_MatKhau", "N/A"),

                IdHoaDon = hoaDon.IdHoaDon,
                SoBan = hoaDon.Ban?.SoBan ?? hoaDon.LoaiHoaDon,
                ThoiGianTao = hoaDon.ThoiGianTao,
                TenNhanVien = hoaDon.NhanVien?.HoTen ?? "N/A",
                TenKhachHang = hoaDon.KhachHang?.HoTen ?? "Khách vãng lai",

                Items = items,
                Surcharges = surcharges,

                TongTienGoc = hoaDon.TongTienGoc,
                TongPhuThu = hoaDon.TongPhuThu,
                // Gộp tất cả giảm giá vào KM (vì không biết cái nào là điểm)
                GiamGiaKM = hoaDon.GiamGia,
                GiamGiaDiem = 0,
                ThanhTien = hoaDon.ThanhTien,

                PhuongThucThanhToan = hoaDon.PhuongThucThanhToan ?? "N/A",
                KhachDua = khachDua,
                TienThoi = khachDua - hoaDon.ThanhTien
            };

            return Ok(previewData);
        }


        /// <summary>
        /// API Cập nhật trạng thái (Hủy, Giao hàng)
        /// </summary>
        [HttpPut("update-status/{id}")]
        public async Task<IActionResult> UpdateOrderStatus(int id, [FromBody] string newStatus)
        {
            var hoaDon = await _context.HoaDons
                .Include(h => h.Ban) // Giữ nguyên
                .FirstOrDefaultAsync(h => h.IdHoaDon == id);

            if (hoaDon == null) return NotFound();

            if (hoaDon.TrangThai == "Đã thanh toán")
            {
                return Conflict("Không thể cập nhật trạng thái cho hóa đơn đã thanh toán.");
            }

            if (newStatus == "Hủy")
            {
                hoaDon.TrangThai = "Đã hủy";

                if (hoaDon.Ban != null)
                {
                    hoaDon.Ban.TrangThai = "Trống";
                }
            }
            else if (newStatus == "Đang giao")
            {
                if (hoaDon.LoaiHoaDon != "Giao hàng")
                {
                    return BadRequest("Chỉ có thể giao hàng cho 'Đơn Giao Hàng'.");
                }
                if (string.IsNullOrEmpty(hoaDon.DiaChiGiaoHang) || string.IsNullOrEmpty(hoaDon.SoDienThoaiGiaoHang))
                {
                    return BadRequest("Không thể giao hàng. Thiếu địa chỉ hoặc SĐT.");
                }
                hoaDon.TrangThaiGiaoHang = "Đang giao";
            }
            else
            {
                return BadRequest("Trạng thái mới không hợp lệ.");
            }

            await _context.SaveChangesAsync();
            return Ok();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\DonViChuyenDoiController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/donvichuyendoi")]
    [ApiController]
    public class DonViChuyenDoiController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public DonViChuyenDoiController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API Lấy tất cả Đơn vị chuyển đổi
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> GetAll()
        {
            var data = await _context.DonViChuyenDois
                .Include(d => d.NguyenLieu)
                .Select(d => new DonViChuyenDoiDtoo
                {
                    IdChuyenDoi = d.IdChuyenDoi,
                    IdNguyenLieu = d.IdNguyenLieu,
                    TenNguyenLieu = d.NguyenLieu.TenNguyenLieu,
                    TenDonVi = d.TenDonVi,
                    GiaTriQuyDoi = d.GiaTriQuyDoi,
                    LaDonViCoBan = d.LaDonViCoBan
                })
                .OrderBy(d => d.TenNguyenLieu)
                .ThenBy(d => d.LaDonViCoBan ? 0 : 1) // Đơn vị cơ bản lên đầu
                .ThenBy(d => d.TenDonVi)
                .ToListAsync();
            return Ok(data);
        }

        /// <summary>
        /// API Thêm mới Đơn vị chuyển đổi
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> Create([FromBody] DonViChuyenDoiUpdateRequestDto dto)
        {
            if (dto.IdNguyenLieu == 0) return BadRequest("Vui lòng chọn nguyên liệu.");

            // Logic: Một nguyên liệu chỉ có 1 ĐVT Cơ bản
            if (dto.LaDonViCoBan)
            {
                if (await _context.DonViChuyenDois.AnyAsync(d => d.IdNguyenLieu == dto.IdNguyenLieu && d.LaDonViCoBan))
                {
                    return Conflict("Nguyên liệu này đã có Đơn vị cơ bản. Không thể thêm.");
                }
                dto.GiaTriQuyDoi = 1; // ĐVT cơ bản luôn có hệ số 1
            }

            var entity = new DonViChuyenDoi
            {
                IdNguyenLieu = dto.IdNguyenLieu,
                TenDonVi = dto.TenDonVi,
                GiaTriQuyDoi = dto.GiaTriQuyDoi,
                LaDonViCoBan = dto.LaDonViCoBan
            };
            _context.DonViChuyenDois.Add(entity);
            await _context.SaveChangesAsync();
            return Ok(entity);
        }

        /// <summary>
        /// API Cập nhật Đơn vị chuyển đổi
        /// </summary>
        [HttpPut("{id}")]
        public async Task<IActionResult> Update(int id, [FromBody] DonViChuyenDoiUpdateRequestDto dto)
        {
            var entity = await _context.DonViChuyenDois.FindAsync(id);
            if (entity == null) return NotFound();

            if (dto.LaDonViCoBan)
            {
                if (await _context.DonViChuyenDois.AnyAsync(d => d.IdNguyenLieu == dto.IdNguyenLieu && d.LaDonViCoBan && d.IdChuyenDoi != id))
                {
                    return Conflict("Nguyên liệu này đã có Đơn vị cơ bản. Không thể cập nhật.");
                }
                dto.GiaTriQuyDoi = 1;
            }

            entity.IdNguyenLieu = dto.IdNguyenLieu;
            entity.TenDonVi = dto.TenDonVi;
            entity.GiaTriQuyDoi = dto.GiaTriQuyDoi;
            entity.LaDonViCoBan = dto.LaDonViCoBan;

            await _context.SaveChangesAsync();
            return Ok();
        }

        /// <summary>
        /// API Xóa Đơn vị chuyển đổi
        /// </summary>
        [HttpDelete("{id}")]
        public async Task<IActionResult> Delete(int id)
        {
            if (await _context.DinhLuongs.AnyAsync(d => d.IdDonViSuDung == id))
            {
                return Conflict("Không thể xóa. Đơn vị này đang được sử dụng trong Định lượng sản phẩm.");
            }
            var entity = await _context.DonViChuyenDois.FindAsync(id);
            if (entity == null) return NotFound();

            _context.DonViChuyenDois.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\DonXinNghiController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/donxinnghi")]
    [ApiController]
    public class DonXinNghiController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public DonXinNghiController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API Lấy danh sách Đơn Xin Nghỉ (có lọc/tìm kiếm)
        /// </summary>
        [HttpGet("search")]
        public async Task<IActionResult> Search(
            [FromQuery] string? searchText,
            [FromQuery] string? trangThai)
        {
            var query = _context.DonXinNghis
                .Include(d => d.NhanVien)
                .Include(d => d.NguoiDuyet)
                .AsQueryable();

            if (!string.IsNullOrEmpty(trangThai) && trangThai != "Tất cả")
            {
                query = query.Where(d => d.TrangThai == trangThai);
            }

            if (!string.IsNullOrEmpty(searchText))
            {
                string searchLower = searchText.ToLower();
                query = query.Where(d =>
                    d.NhanVien.HoTen.ToLower().Contains(searchLower) ||
                    d.LyDo.ToLower().Contains(searchLower)
                );
            }

            var results = await query
                .OrderByDescending(d => d.NgayBatDau)
                .Select(d => new DonXinNghiDto
                {
                    IdDonXinNghi = d.IdDonXinNghi,
                    TenNhanVien = d.NhanVien.HoTen,
                    LoaiDon = d.LoaiDon,
                    NgayBatDau = d.NgayBatDau,
                    NgayKetThuc = d.NgayKetThuc,
                    LyDo = d.LyDo,
                    TrangThai = d.TrangThai,
                    TenNguoiDuyet = d.NguoiDuyet != null ? d.NguoiDuyet.HoTen : null,
                    NgayDuyet = d.NgayDuyet,
                    GhiChuPheDuyet = d.GhiChuPheDuyet
                })
                .ToListAsync();

            return Ok(results);
        }

        /// <summary>
        /// API Thêm mới Đơn Xin Nghỉ
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> CreateDonXinNghi([FromBody] DonXinNghiCreateDto dto)
        {
            var entity = new DonXinNghi
            {
                IdNhanVien = dto.IdNhanVien,
                LoaiDon = dto.LoaiDon,
                LyDo = dto.LyDo,
                NgayBatDau = dto.NgayBatDau.Date,
                NgayKetThuc = dto.NgayKetThuc.Date,
                TrangThai = "Chờ duyệt", // Mặc định
                NgayDuyet = null
            };

            _context.DonXinNghis.Add(entity);
            await _context.SaveChangesAsync();
            return Ok(entity);
        }

        /// <summary>
        /// API Duyệt đơn
        /// </summary>
        [HttpPut("approve/{idDon}")]
        public async Task<IActionResult> ApproveDon(int idDon, [FromBody] DonXinNghiActionDto dto)
        {
            var don = await _context.DonXinNghis.FindAsync(idDon);
            if (don == null) return NotFound("Không tìm thấy đơn.");
            if (don.TrangThai != "Chờ duyệt") return Conflict("Đơn này đã được xử lý trước đó.");

            // Cập nhật trạng thái đơn
            don.TrangThai = "Đã duyệt";
            don.IdNguoiDuyet = dto.IdNguoiDuyet;
            don.GhiChuPheDuyet = dto.GhiChuPheDuyet;
            don.NgayDuyet = DateTime.Now;

            // TỰ ĐỘNG CẬP NHẬT LỊCH LÀM VIỆC (Yêu cầu #4)
            var conflictingSchedules = await _context.LichLamViecs
                .Where(l => l.IdNhanVien == don.IdNhanVien &&
                            l.NgayLam >= don.NgayBatDau.Date &&
                            l.NgayLam <= don.NgayKetThuc.Date)
                .ToListAsync();

            // Kiểm tra xem có lịch nào đã chấm công chưa
            foreach (var lich in conflictingSchedules)
            {
                if (await _context.BangChamCongs.AnyAsync(c => c.IdLichLamViec == lich.IdLichLamViec))
                {
                    // Nếu đã chấm công, không thể duyệt -> Rollback
                    return Conflict($"Không thể duyệt. Nhân viên đã chấm công ngày {lich.NgayLam:dd/MM/yyyy}.");
                }
            }

            // Nếu không có xung đột -> Xóa các lịch làm việc
            if (conflictingSchedules.Any())
            {
                _context.LichLamViecs.RemoveRange(conflictingSchedules);
            }

            await _context.SaveChangesAsync();
            return Ok(new { message = "Duyệt đơn thành công và đã cập nhật lịch làm việc." });
        }

        /// <summary>
        /// API Từ chối đơn
        /// </summary>
        [HttpPut("reject/{idDon}")]
        public async Task<IActionResult> RejectDon(int idDon, [FromBody] DonXinNghiActionDto dto)
        {
            var don = await _context.DonXinNghis.FindAsync(idDon);
            if (don == null) return NotFound("Không tìm thấy đơn.");
            if (don.TrangThai != "Chờ duyệt") return Conflict("Đơn này đã được xử lý trước đó.");

            don.TrangThai = "Đã từ chối";
            don.IdNguoiDuyet = dto.IdNguoiDuyet;
            don.GhiChuPheDuyet = dto.GhiChuPheDuyet;
            don.NgayDuyet = DateTime.Now;

            await _context.SaveChangesAsync();
            return Ok(new { message = "Từ chối đơn thành công." });
        }

        /// <summary>
        /// API Xóa đơn (chỉ khi chưa duyệt)
        /// </summary>
        [HttpDelete("{idDon}")]
        public async Task<IActionResult> DeleteDon(int idDon)
        {
            var don = await _context.DonXinNghis.FindAsync(idDon);
            if (don == null) return NotFound();

            if (don.TrangThai != "Chờ duyệt")
            {
                return Conflict("Không thể xóa. Đơn này đã được xử lý.");
            }

            _context.DonXinNghis.Remove(don);
            await _context.SaveChangesAsync();
            return Ok();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\KhachHangController.cs
================================================================================
﻿// Tập tin: CafebookApi/Controllers/App/KhachHangController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using CafebookModel.Utils;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using System.IO;
using Microsoft.AspNetCore.Http;
using System;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/khachhang")]
    [ApiController]
    public class KhachHangController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private readonly IWebHostEnvironment _env;
        private readonly string _baseUrl;

        public KhachHangController(CafebookDbContext context, IWebHostEnvironment env, IConfiguration config)
        {
            _context = context;

            _env = env;
            if (string.IsNullOrEmpty(_env.WebRootPath))
            {
                _env.WebRootPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot");
                if (!Directory.Exists(_env.WebRootPath))
                {
                    Directory.CreateDirectory(_env.WebRootPath);
                }
            }
            _baseUrl = config.GetValue<string>("Kestrel:Endpoints:Http:Url")
                       ?? "http://127.0.0.1:5166";
        }

        // === 5 HÀM HELPER XỬ LÝ FILE ===
        [ApiExplorerSettings(IgnoreApi = true)]
        private string? GetFullImageUrl(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath))
                return null;
            return $"{_baseUrl}{relativePath.Replace(Path.DirectorySeparatorChar, '/')}";
        }
        [ApiExplorerSettings(IgnoreApi = true)]
        private string GenerateFileName(int id, string ten)
        {
            string slug = SlugifyUtil.GenerateSlug(ten);
            return $"{id}_{slug}.jpg";
        }
        [ApiExplorerSettings(IgnoreApi = true)]
        private void DeleteOldImage(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath)) return;
            var fileName = relativePath.TrimStart('/');
            var fullPath = Path.Combine(_env.WebRootPath, fileName.Replace('/', Path.DirectorySeparatorChar));
            if (System.IO.File.Exists(fullPath))
            {
                System.IO.File.Delete(fullPath);
            }
        }
        [ApiExplorerSettings(IgnoreApi = true)]
        private void RenameImage(string oldRelativePath, string newRelativePath)
        {
            if (string.IsNullOrEmpty(oldRelativePath) || string.IsNullOrEmpty(newRelativePath) || oldRelativePath == newRelativePath)
                return;
            var oldFullPath = Path.Combine(_env.WebRootPath, oldRelativePath.TrimStart('/').Replace('/', Path.DirectorySeparatorChar));
            var newFullPath = Path.Combine(_env.WebRootPath, newRelativePath.TrimStart('/').Replace('/', Path.DirectorySeparatorChar));
            if (System.IO.File.Exists(oldFullPath))
            {
                System.IO.File.Move(oldFullPath, newFullPath);
            }
        }
        [ApiExplorerSettings(IgnoreApi = true)]
        private async Task<string> SaveImageFromFile(IFormFile file, string fileName, string relativeDir)
        {
            var saveDir = Path.Combine(_env.WebRootPath, relativeDir);
            if (!Directory.Exists(saveDir))
            {
                Directory.CreateDirectory(saveDir);
            }
            var fullSavePath = Path.Combine(saveDir, fileName);
            await using (var stream = new FileStream(fullSavePath, FileMode.Create))
            {
                await file.CopyToAsync(stream);
            }
            return $"/{relativeDir.Replace(Path.DirectorySeparatorChar, '/')}/{fileName}";
        }
        // ===================================

        /// <summary>
        /// API Lấy danh sách Khách hàng
        /// </summary>
        [HttpGet("search")]
        public async Task<IActionResult> SearchKhachHang(
            [FromQuery] string? searchText,
            [FromQuery] bool? biKhoa)
        {
            var query = _context.KhachHangs.AsQueryable();

            if (biKhoa.HasValue)
            {
                query = query.Where(kh => kh.BiKhoa == biKhoa.Value);
            }

            if (!string.IsNullOrEmpty(searchText))
            {
                string searchLower = searchText.ToLower();
                query = query.Where(kh =>
                    kh.HoTen.ToLower().Contains(searchLower) ||
                    (kh.SoDienThoai != null && kh.SoDienThoai.Contains(searchLower)) ||
                    (kh.Email != null && kh.Email.ToLower().Contains(searchLower))
                );
            }

            var results = await query
                .Select(kh => new KhachHangDto
                {
                    IdKhachHang = kh.IdKhachHang,
                    HoTen = kh.HoTen,
                    SoDienThoai = kh.SoDienThoai,
                    Email = kh.Email,
                    NgayTao = kh.NgayTao,
                    BiKhoa = kh.BiKhoa
                })
                .OrderBy(kh => kh.HoTen)
                .ToListAsync();

            return Ok(results);
        }

        /// <summary>
        /// SỬA: API Lấy chi tiết và lịch sử
        /// </summary>
        [HttpGet("details/{id}")]
        public async Task<IActionResult> GetKhachHangDetails(int id)
        {
            var kh = await _context.KhachHangs.FindAsync(id);
            if (kh == null) return NotFound();

            var dto = new KhachHangDetailDto
            {
                IdKhachHang = kh.IdKhachHang,
                HoTen = kh.HoTen,
                SoDienThoai = kh.SoDienThoai,
                Email = kh.Email,
                DiaChi = kh.DiaChi,
                DiemTichLuy = kh.DiemTichLuy,
                TenDangNhap = kh.TenDangNhap,
                BiKhoa = kh.BiKhoa,
                AnhDaiDienUrl = GetFullImageUrl(kh.AnhDaiDien), // <-- SỬA

                LichSuDonHang = await _context.HoaDons
                    .Where(h => h.IdKhachHang == id)
                    .OrderByDescending(h => h.ThoiGianTao)
                    .Select(h => new LichSuDonHangDto
                    {
                        IdHoaDon = h.IdHoaDon,
                        ThoiGianTao = h.ThoiGianTao,
                        ThanhTien = h.ThanhTien,
                        TrangThai = h.TrangThai
                    }).ToListAsync(),

                LichSuThueSach = await _context.PhieuThueSachs
                    .Where(p => p.IdKhachHang == id)
                    .Include(p => p.ChiTietPhieuThues)
                        .ThenInclude(ct => ct.Sach)
                    .OrderByDescending(p => p.NgayThue)
                    .SelectMany(p => p.ChiTietPhieuThues.Select(ct => new LichSuThueSachDto
                    {
                        IdPhieuThue = p.IdPhieuThueSach,
                        TieuDeSach = ct.Sach.TenSach,
                        NgayThue = p.NgayThue,
                        TrangThai = p.TrangThai
                    }))
                    .Take(20)
                    .ToListAsync()
            };
            return Ok(dto);
        }

        /// <summary>
        /// SỬA: API Thêm khách hàng mới
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> CreateKhachHang([FromForm] KhachHangUpdateRequestDto dto) // <-- SỬA [FromForm]
        {
            if (string.IsNullOrEmpty(dto.HoTen) || string.IsNullOrEmpty(dto.SoDienThoai))
            {
                return BadRequest("Họ tên và SĐT là bắt buộc.");
            }
            if (await _context.KhachHangs.AnyAsync(kh => kh.SoDienThoai == dto.SoDienThoai))
            {
                return Conflict("Số điện thoại này đã tồn tại.");
            }
            if (!string.IsNullOrEmpty(dto.Email) && await _context.KhachHangs.AnyAsync(kh => kh.Email == dto.Email))
            {
                return Conflict("Email này đã tồn tại.");
            }

            var khachHang = new KhachHang
            {
                HoTen = dto.HoTen,
                SoDienThoai = dto.SoDienThoai,
                Email = dto.Email,
                DiaChi = dto.DiaChi,
                TenDangNhap = dto.TenDangNhap,
                DiemTichLuy = 0,
                NgayTao = DateTime.Now,
                BiKhoa = false,
                AnhDaiDien = null // SỬA: Tạm thời null
            };
            _context.KhachHangs.Add(khachHang);
            await _context.SaveChangesAsync(); // Lưu lần 1 để lấy ID

            // SỬA: Thêm logic lưu file
            if (dto.AnhDaiDienUpload != null)
            {
                try
                {
                    string fileName = GenerateFileName(khachHang.IdKhachHang, khachHang.HoTen);
                    string relativePath = await SaveImageFromFile(dto.AnhDaiDienUpload, fileName, HinhAnhPaths.UrlAvatarKH.TrimStart('/'));
                    khachHang.AnhDaiDien = relativePath;
                    await _context.SaveChangesAsync();
                }
                catch (Exception ex)
                {
                    _context.KhachHangs.Remove(khachHang);
                    await _context.SaveChangesAsync();
                    return StatusCode(500, $"Lỗi khi lưu ảnh: {ex.Message}");
                }
            }

            return Ok(khachHang);
        }

        /// <summary>
        /// SỬA: API Cập nhật khách hàng
        /// </summary>
        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateKhachHang(int id, [FromForm] KhachHangUpdateRequestDto dto) // <-- SỬA [FromForm]
        {
            var kh = await _context.KhachHangs.FindAsync(id);
            if (kh == null) return NotFound();

            if (await _context.KhachHangs.AnyAsync(k => k.SoDienThoai == dto.SoDienThoai && k.IdKhachHang != id))
            {
                return Conflict("Số điện thoại này đã tồn tại.");
            }
            if (!string.IsNullOrEmpty(dto.Email) && await _context.KhachHangs.AnyAsync(k => k.Email == dto.Email && k.IdKhachHang != id))
            {
                return Conflict("Email này đã tồn tại.");
            }

            // SỬA: Logic xử lý file
            var oldImagePath = kh.AnhDaiDien;
            var oldTen = kh.HoTen;
            bool isImageUpload = dto.AnhDaiDienUpload != null;
            bool isNameChange = dto.HoTen != oldTen;

            // Cập nhật text
            kh.HoTen = dto.HoTen;
            kh.SoDienThoai = dto.SoDienThoai;
            kh.Email = dto.Email;
            kh.DiaChi = dto.DiaChi;
            kh.TenDangNhap = dto.TenDangNhap;
            kh.DiemTichLuy = dto.DiemTichLuy;

            // Xử lý file
            string newFileName = GenerateFileName(kh.IdKhachHang, kh.HoTen);
            string newRelativePath = $"/{HinhAnhPaths.UrlAvatarKH.TrimStart('/')}/{newFileName}";

            if (isImageUpload)
            {
                DeleteOldImage(oldImagePath);
                // === SỬA LỖI CS8604 (Dòng 282) ===
                // Thêm '!' vì logic 'isImageUpload' đã đảm bảo file không null
                kh.AnhDaiDien = await SaveImageFromFile(dto.AnhDaiDienUpload!, newFileName, HinhAnhPaths.UrlAvatarKH.TrimStart('/'));
            }
            else if (dto.XoaAnhDaiDien)
            {
                DeleteOldImage(oldImagePath);
                kh.AnhDaiDien = null;
            }
            else if (isNameChange && !string.IsNullOrEmpty(oldImagePath))
            {
                RenameImage(oldImagePath, newRelativePath);
                kh.AnhDaiDien = newRelativePath;
            }

            await _context.SaveChangesAsync();
            return Ok();
        }

        // Helper class cho API UpdateStatus
        public class UpdateStatusRequest
        {
            public bool BiKhoa { get; set; }
        }

        /// <summary>
        /// SỬA: API Khóa/Mở khóa tài khoản
        /// </summary>
        [HttpPut("update-status/{id}")]
        public async Task<IActionResult> UpdateKhachHangStatus(int id, [FromBody] UpdateStatusRequest request) // <-- SỬA: Nhận Object
        {
            var kh = await _context.KhachHangs.FindAsync(id);
            if (kh == null) return NotFound();

            kh.BiKhoa = request.BiKhoa; // <-- SỬA: Lấy từ object
            await _context.SaveChangesAsync();
            return Ok();
        }

        /// <summary>
        /// SỬA: API Xóa khách hàng
        /// </summary>
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteKhachHang(int id)
        {
            // Kiểm tra ràng buộc
            if (await _context.HoaDons.AnyAsync(h => h.IdKhachHang == id))
            {
                return Conflict("Không thể xóa. Khách hàng này đã có lịch sử Hóa đơn.");
            }
            if (await _context.PhieuThueSachs.AnyAsync(p => p.IdKhachHang == id))
            {
                return Conflict("Không thể xóa. Khách hàng này đã có lịch sử Thuê sách.");
            }

            var kh = await _context.KhachHangs.FindAsync(id);
            if (kh == null) return NotFound();

            // SỬA: Thêm xóa file
            DeleteOldImage(kh.AnhDaiDien);

            _context.KhachHangs.Remove(kh);
            await _context.SaveChangesAsync();
            return Ok();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\KhoController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/kho")]
    [ApiController]
    public class KhoController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public KhoController(CafebookDbContext context)
        {
            _context = context;
        }

        // --- TAB 1: TỒN KHO ---
        [HttpGet("tonkho")]
        public async Task<IActionResult> GetTonKho()
        {
            var tonKho = await _context.NguyenLieus
                .Select(nl => new NguyenLieuTonKhoDto
                {
                    IdNguyenLieu = nl.IdNguyenLieu,
                    TenNguyenLieu = nl.TenNguyenLieu,
                    TonKho = nl.TonKho,
                    DonViTinh = nl.DonViTinh,
                    TonKhoToiThieu = nl.TonKhoToiThieu,
                    TinhTrang = (nl.TonKho <= 0) ? "Hết hàng" : (nl.TonKho <= nl.TonKhoToiThieu ? "Sắp hết" : "Đủ dùng")
                })
                .OrderBy(nl => nl.TinhTrang)
                .ThenBy(nl => nl.TenNguyenLieu)
                .ToListAsync();
            return Ok(tonKho);
        }

        // --- TAB 2: QUẢN LÝ NGUYÊN LIỆU (CRUD) ---
        #region API Nguyên Liệu
        [HttpGet("nguyenlieu")]
        public async Task<IActionResult> GetAllNguyenLieu()
        {
            var data = await _context.NguyenLieus
                .Select(nl => new NguyenLieuCrudDto
                {
                    IdNguyenLieu = nl.IdNguyenLieu,
                    TenNguyenLieu = nl.TenNguyenLieu,
                    DonViTinh = nl.DonViTinh,
                    TonKhoToiThieu = nl.TonKhoToiThieu,
                    TonKho = nl.TonKho // Sửa lỗi CS0117
                })
                .OrderBy(nl => nl.TenNguyenLieu)
                .ToListAsync();
            return Ok(data);
        }

        [HttpPost("nguyenlieu")]
        public async Task<IActionResult> CreateNguyenLieu([FromBody] NguyenLieuUpdateRequestDto dto)
        {
            if (await _context.NguyenLieus.AnyAsync(nl => nl.TenNguyenLieu.ToLower() == dto.TenNguyenLieu.ToLower()))
            {
                return Conflict("Tên nguyên liệu đã tồn tại.");
            }
            var entity = new NguyenLieu
            {
                TenNguyenLieu = dto.TenNguyenLieu,
                DonViTinh = dto.DonViTinh,
                TonKhoToiThieu = dto.TonKhoToiThieu,
                TonKho = 0
            };
            _context.NguyenLieus.Add(entity);
            await _context.SaveChangesAsync();
            return Ok(entity);
        }

        [HttpPut("nguyenlieu/{id}")]
        public async Task<IActionResult> UpdateNguyenLieu(int id, [FromBody] NguyenLieuUpdateRequestDto dto)
        {
            var entity = await _context.NguyenLieus.FindAsync(id);
            if (entity == null) return NotFound();

            if (await _context.NguyenLieus.AnyAsync(nl => nl.TenNguyenLieu.ToLower() == dto.TenNguyenLieu.ToLower() && nl.IdNguyenLieu != id))
            {
                return Conflict("Tên nguyên liệu đã tồn tại.");
            }

            entity.TenNguyenLieu = dto.TenNguyenLieu;
            entity.DonViTinh = dto.DonViTinh;
            entity.TonKhoToiThieu = dto.TonKhoToiThieu;
            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpDelete("nguyenlieu/{id}")]
        public async Task<IActionResult> DeleteNguyenLieu(int id)
        {
            if (await _context.DinhLuongs.AnyAsync(d => d.IdNguyenLieu == id) ||
                await _context.ChiTietNhapKhos.AnyAsync(d => d.IdNguyenLieu == id))
            {
                return Conflict("Không thể xóa. Nguyên liệu này đã được sử dụng trong Định lượng hoặc Phiếu nhập kho.");
            }
            var entity = await _context.NguyenLieus.FindAsync(id);
            if (entity == null) return NotFound();
            _context.NguyenLieus.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }
        #endregion

        // --- TAB 3: QUẢN LÝ NHẬP KHO ---
        #region API Nhập Kho
        [HttpGet("phieunhap")]
        public async Task<IActionResult> GetPhieuNhap([FromQuery] DateTime? startDate, [FromQuery] DateTime? endDate)
        {
            var query = _context.PhieuNhapKhos
                .Include(p => p.NhaCungCap)
                .Include(p => p.NhanVien)
                .OrderByDescending(p => p.NgayNhap)
                .AsQueryable();

            if (startDate.HasValue)
                query = query.Where(p => p.NgayNhap.Date >= startDate.Value.Date);
            if (endDate.HasValue)
                query = query.Where(p => p.NgayNhap.Date <= endDate.Value.Date);

            var data = await query.Select(p => new PhieuNhapDto
            {
                IdPhieuNhapKho = p.IdPhieuNhapKho,
                NgayNhap = p.NgayNhap,
                TenNhaCungCap = p.NhaCungCap != null ? p.NhaCungCap.TenNhaCungCap : "Nhập lẻ",
                TenNhanVien = p.NhanVien.HoTen,
                TongTien = p.TongTien,
                TrangThai = p.TrangThai
            }).ToListAsync();
            return Ok(data);
        }

        [HttpGet("phieunhap/{id}")]
        public async Task<IActionResult> GetChiTietPhieuNhap(int id)
        {
            var data = await _context.ChiTietNhapKhos
                .Where(ct => ct.IdPhieuNhapKho == id)
                .Include(ct => ct.NguyenLieu)
                .Select(ct => new ChiTietPhieuNhapDto
                {
                    IdNguyenLieu = ct.IdNguyenLieu,
                    TenNguyenLieu = ct.NguyenLieu.TenNguyenLieu,
                    SoLuongNhap = ct.SoLuongNhap,
                    DonGiaNhap = ct.DonGiaNhap,
                    ThanhTien = ct.ThanhTien
                }).ToListAsync();
            return Ok(data);
        }

        [HttpPost("phieunhap")]
        public async Task<IActionResult> CreatePhieuNhap([FromBody] PhieuNhapCreateDto dto)
        {
            using var transaction = await _context.Database.BeginTransactionAsync();
            try
            {
                var phieuNhap = new PhieuNhapKho
                {
                    IdNhanVien = dto.IdNhanVien,
                    IdNhaCungCap = dto.IdNhaCungCap,
                    NgayNhap = dto.NgayNhap,
                    GhiChu = dto.GhiChu,
                    TrangThai = "Đã nhập",
                    TongTien = dto.ChiTiet.Sum(ct => ct.SoLuongNhap * ct.DonGiaNhap)
                };
                _context.PhieuNhapKhos.Add(phieuNhap);
                await _context.SaveChangesAsync();

                foreach (var ctDto in dto.ChiTiet)
                {
                    var chiTiet = new ChiTietNhapKho
                    {
                        IdPhieuNhapKho = phieuNhap.IdPhieuNhapKho,
                        IdNguyenLieu = ctDto.IdNguyenLieu,
                        SoLuongNhap = ctDto.SoLuongNhap,
                        DonGiaNhap = ctDto.DonGiaNhap
                    };
                    _context.ChiTietNhapKhos.Add(chiTiet);

                    var nguyenLieu = await _context.NguyenLieus.FindAsync(ctDto.IdNguyenLieu);
                    if (nguyenLieu != null)
                    {
                        nguyenLieu.TonKho += ctDto.SoLuongNhap;
                    }
                }
                await _context.SaveChangesAsync();

                await transaction.CommitAsync();
                return Ok(new { IdPhieuNhapKho = phieuNhap.IdPhieuNhapKho });
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                return StatusCode(500, $"Lỗi máy chủ: {ex.Message}");
            }
        }
        #endregion

        // --- TAB 4: QUẢN LÝ NHÀ CUNG CẤP (CRUD) ---
        #region API Nhà Cung Cấp
        [HttpGet("nhacungcap")]
        public async Task<IActionResult> GetAllNhaCungCap()
        {
            var data = await _context.NhaCungCaps
                .Select(ncc => new NhaCungCapDto
                {
                    IdNhaCungCap = ncc.IdNhaCungCap,
                    TenNhaCungCap = ncc.TenNhaCungCap,
                    SoDienThoai = ncc.SoDienThoai,
                    DiaChi = ncc.DiaChi,
                    Email = ncc.Email
                })
                .OrderBy(ncc => ncc.TenNhaCungCap)
                .ToListAsync();
            return Ok(data);
        }

        [HttpPost("nhacungcap")]
        public async Task<IActionResult> CreateNhaCungCap([FromBody] NhaCungCapDto dto)
        {
            var entity = new NhaCungCap
            {
                TenNhaCungCap = dto.TenNhaCungCap,
                SoDienThoai = dto.SoDienThoai,
                DiaChi = dto.DiaChi,
                Email = dto.Email
            };
            _context.NhaCungCaps.Add(entity);
            await _context.SaveChangesAsync();
            return Ok(entity);
        }

        [HttpPut("nhacungcap/{id}")]
        public async Task<IActionResult> UpdateNhaCungCap(int id, [FromBody] NhaCungCapDto dto)
        {
            var entity = await _context.NhaCungCaps.FindAsync(id);
            if (entity == null) return NotFound();

            entity.TenNhaCungCap = dto.TenNhaCungCap;
            entity.SoDienThoai = dto.SoDienThoai;
            entity.DiaChi = dto.DiaChi;
            entity.Email = dto.Email;

            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpDelete("nhacungcap/{id}")]
        public async Task<IActionResult> DeleteNhaCungCap(int id)
        {
            if (await _context.PhieuNhapKhos.AnyAsync(p => p.IdNhaCungCap == id))
            {
                return Conflict("Không thể xóa. Nhà cung cấp này đã có lịch sử nhập hàng.");
            }
            var entity = await _context.NhaCungCaps.FindAsync(id);
            if (entity == null) return NotFound();
            _context.NhaCungCaps.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }
        #endregion

        // --- THÊM MỚI: API CHO XUẤT HỦY KHO ---
        #region API Xuất Hủy Kho

        [HttpGet("phieuxuathuy")]
        public async Task<IActionResult> GetPhieuXuatHuy([FromQuery] DateTime? startDate, [FromQuery] DateTime? endDate)
        {
            var query = _context.PhieuXuatHuys
                .Include(p => p.NhanVienXuat)
                .OrderByDescending(p => p.NgayXuatHuy)
                .AsQueryable();

            if (startDate.HasValue)
                query = query.Where(p => p.NgayXuatHuy.Date >= startDate.Value.Date);
            if (endDate.HasValue)
                query = query.Where(p => p.NgayXuatHuy.Date <= endDate.Value.Date);

            var data = await query.Select(p => new PhieuXuatHuyDto
            {
                IdPhieuXuatHuy = p.IdPhieuXuatHuy,
                NgayXuatHuy = p.NgayXuatHuy,
                TenNhanVien = p.NhanVienXuat.HoTen,
                LyDoXuatHuy = p.LyDoXuatHuy,
                TongGiaTriHuy = p.TongGiaTriHuy
            }).ToListAsync();
            return Ok(data);
        }

        [HttpGet("phieuxuathuy/{id}")]
        public async Task<IActionResult> GetChiTietPhieuXuatHuy(int id)
        {
            var data = await _context.ChiTietXuatHuys
                .Where(ct => ct.IdPhieuXuatHuy == id)
                .Include(ct => ct.NguyenLieu)
                .Select(ct => new ChiTietPhieuXuatHuyDto
                {
                    IdNguyenLieu = ct.IdNguyenLieu,
                    TenNguyenLieu = ct.NguyenLieu.TenNguyenLieu,
                    SoLuong = ct.SoLuong,
                    DonGiaVon = ct.DonGiaVon,
                    ThanhTien = ct.ThanhTien
                }).ToListAsync();
            return Ok(data);
        }

        [HttpPost("phieuxuathuy")]
        public async Task<IActionResult> CreatePhieuXuatHuy([FromBody] PhieuXuatHuyCreateDto dto)
        {
            using var transaction = await _context.Database.BeginTransactionAsync();
            try
            {
                var phieuHuy = new PhieuXuatHuy
                {
                    IdNhanVienXuat = dto.IdNhanVien,
                    NgayXuatHuy = dto.NgayXuatHuy,
                    LyDoXuatHuy = dto.LyDoXuatHuy,
                    TongGiaTriHuy = 0 // Sẽ tính toán bên dưới
                };
                _context.PhieuXuatHuys.Add(phieuHuy);
                await _context.SaveChangesAsync(); // Lưu để lấy ID

                decimal tongGiaTri = 0;

                foreach (var ctDto in dto.ChiTiet)
                {
                    var nguyenLieu = await _context.NguyenLieus.FindAsync(ctDto.IdNguyenLieu);
                    if (nguyenLieu == null) continue;

                    // Lấy giá vốn trung bình (đơn giản)
                    var giaVon = await _context.ChiTietNhapKhos
                        .Where(ct => ct.IdNguyenLieu == ctDto.IdNguyenLieu && ct.DonGiaNhap > 0)
                        .Select(ct => (decimal?)ct.DonGiaNhap)
                        .AverageAsync() ?? 0;

                    var chiTiet = new ChiTietXuatHuy
                    {
                        IdPhieuXuatHuy = phieuHuy.IdPhieuXuatHuy,
                        IdNguyenLieu = ctDto.IdNguyenLieu,
                        SoLuong = ctDto.SoLuong,
                        DonGiaVon = giaVon,
                        // ThanhTien sẽ được tính tự động bởi CSDL (Computed Column)
                    };
                    _context.ChiTietXuatHuys.Add(chiTiet);

                    // Trừ tồn kho
                    nguyenLieu.TonKho -= ctDto.SoLuong;
                    tongGiaTri += (ctDto.SoLuong * giaVon);
                }

                phieuHuy.TongGiaTriHuy = tongGiaTri; // Cập nhật tổng tiền
                await _context.SaveChangesAsync();

                await transaction.CommitAsync();
                return Ok(new { idPhieuXuatHuy = phieuHuy.IdPhieuXuatHuy });
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                return StatusCode(500, $"Lỗi máy chủ: {ex.Message}");
            }
        }

        #endregion

        // --- THÊM MỚI: API CHO KIỂM KHO (SỬA LỖI 404) ---
        #region API Kiểm Kho

        [HttpGet("phieukiemkho")]
        public async Task<IActionResult> GetPhieuKiemKho([FromQuery] DateTime? startDate, [FromQuery] DateTime? endDate)
        {
            var query = _context.PhieuKiemKhos
                .Include(p => p.NhanVienKiem)
                .OrderByDescending(p => p.NgayKiem)
                .AsQueryable();

            if (startDate.HasValue)
                query = query.Where(p => p.NgayKiem.Date >= startDate.Value.Date);
            if (endDate.HasValue)
                query = query.Where(p => p.NgayKiem.Date <= endDate.Value.Date);

            var data = await query.Select(p => new PhieuKiemKhoDto
            {
                IdPhieuKiemKho = p.IdPhieuKiemKho,
                NgayKiem = p.NgayKiem,
                TenNhanVienKiem = p.NhanVienKiem.HoTen,
                TrangThai = p.TrangThai
            }).ToListAsync();
            return Ok(data);
        }

        [HttpGet("phieukiemkho/{id}")]
        public async Task<IActionResult> GetChiTietPhieuKiemKho(int id)
        {
            var data = await _context.ChiTietKiemKhos
                .Where(ct => ct.IdPhieuKiemKho == id)
                .Include(ct => ct.NguyenLieu)
                .Select(ct => new ChiTietKiemKhoDto
                {
                    IdNguyenLieu = ct.IdNguyenLieu,
                    TenNguyenLieu = ct.NguyenLieu.TenNguyenLieu,
                    DonViTinh = ct.NguyenLieu.DonViTinh,
                    TonKhoHeThong = ct.TonKhoHeThong,
                    TonKhoThucTe = ct.TonKhoThucTe,
                    LyDoChenhLech = ct.LyDoChenhLech,
                    GiaTriChenhLech = ct.ChenhLech * (_context.ChiTietNhapKhos
                                                        .Where(c => c.IdNguyenLieu == ct.IdNguyenLieu)
                                                        .Select(c => (decimal?)c.DonGiaNhap).Average() ?? 0)
                }).ToListAsync();
            return Ok(data);
        }

        /// <summary>
        /// API đặc biệt: Lấy toàn bộ tồn kho hiện tại để bắt đầu kiểm kê
        /// </summary>
        [HttpGet("phieukiemkho/taomoi")]
        public async Task<IActionResult> GetCurrentStockForAudit()
        {
            var data = await _context.NguyenLieus
                .OrderBy(nl => nl.TenNguyenLieu)
                .Select(nl => new ChiTietKiemKhoDto
                {
                    IdNguyenLieu = nl.IdNguyenLieu,
                    TenNguyenLieu = nl.TenNguyenLieu,
                    DonViTinh = nl.DonViTinh,
                    TonKhoHeThong = nl.TonKho,
                    TonKhoThucTe = nl.TonKho, // Mặc định bằng nhau
                    LyDoChenhLech = ""
                })
                .ToListAsync();
            return Ok(data);
        }

        [HttpPost("phieukiemkho")]
        public async Task<IActionResult> CreatePhieuKiemKho([FromBody] PhieuKiemKhoCreateDto dto)
        {
            using var transaction = await _context.Database.BeginTransactionAsync();
            try
            {
                var phieuKiem = new PhieuKiemKho
                {
                    IdNhanVienKiem = dto.IdNhanVien,
                    NgayKiem = dto.NgayKiem,
                    GhiChu = dto.GhiChu,
                    TrangThai = "Hoàn thành"
                };
                _context.PhieuKiemKhos.Add(phieuKiem);
                await _context.SaveChangesAsync(); // Lưu để lấy ID

                foreach (var ctDto in dto.ChiTiet)
                {
                    var chiTiet = new ChiTietKiemKho
                    {
                        IdPhieuKiemKho = phieuKiem.IdPhieuKiemKho,
                        IdNguyenLieu = ctDto.IdNguyenLieu,
                        TonKhoHeThong = ctDto.TonKhoHeThong,
                        TonKhoThucTe = ctDto.TonKhoThucTe,
                        LyDoChenhLech = ctDto.LyDoChenhLech
                        // ChenhLech được tính tự động
                    };
                    _context.ChiTietKiemKhos.Add(chiTiet);

                    // Cân bằng kho: Cập nhật Tồn Kho thực tế
                    if (ctDto.ChenhLech != 0)
                    {
                        var nguyenLieu = await _context.NguyenLieus.FindAsync(ctDto.IdNguyenLieu);
                        if (nguyenLieu != null)
                        {
                            nguyenLieu.TonKho = ctDto.TonKhoThucTe;
                        }
                    }
                }
                await _context.SaveChangesAsync();

                await transaction.CommitAsync();
                return Ok(new { idPhieuKiemKho = phieuKiem.IdPhieuKiemKho });
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                return StatusCode(500, $"Lỗi máy chủ: {ex.Message}");
            }
        }

        #endregion
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\KhuyenMaiController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Globalization;
using System.Linq;
using System.Threading.Tasks;
using System.Collections.Generic; // <-- THÊM

namespace CafebookApi.Controllers.App
{
    [Route("api/app/khuyenmai")]
    [ApiController]
    public class KhuyenMaiController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public KhuyenMaiController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// THÊM MỚI: API để tải danh sách sản phẩm cho ComboBox
        /// </summary>
        [HttpGet("filters")]
        public async Task<IActionResult> GetKhuyenMaiFilters()
        {
            var sanPhams = await _context.SanPhams
                .Where(sp => sp.TrangThaiKinhDoanh == true)
                .OrderBy(sp => sp.TenSanPham)
                .Select(sp => new FilterLookupDto { Id = sp.IdSanPham, Ten = sp.TenSanPham })
                .ToListAsync();

            return Ok(sanPhams);
        }

        /// <summary>
        /// SỬA: Cập nhật logic tìm kiếm
        /// </summary>
        [HttpGet("search")]
        public async Task<IActionResult> SearchKhuyenMai(
            [FromQuery] string? maKhuyenMai,
            [FromQuery] string? trangThai)
        {
            var now = DateTime.Now;
            var today = now.Date;

            // 1. Tự động cập nhật các mã hết hạn
            var hetHan = await _context.KhuyenMais
                .Where(km => km.TrangThai != "Hết hạn" && km.NgayKetThuc < today)
                .ToListAsync();

            foreach (var km in hetHan)
            {
                km.TrangThai = "Hết hạn";
            }
            await _context.SaveChangesAsync();

            // 2. Bắt đầu truy vấn
            var query = _context.KhuyenMais.AsQueryable();

            if (!string.IsNullOrEmpty(maKhuyenMai))
            {
                query = query.Where(km => km.MaKhuyenMai.Contains(maKhuyenMai));
            }
            if (!string.IsNullOrEmpty(trangThai) && trangThai != "Tất cả")
            {
                query = query.Where(km => km.TrangThai == trangThai);
            }

            // 3. Select DTO
            var result = await query
                .OrderByDescending(km => km.IdKhuyenMai)
                .Select(km => new KhuyenMaiDto
                {
                    IdKhuyenMai = km.IdKhuyenMai,
                    MaKhuyenMai = km.MaKhuyenMai,
                    TenKhuyenMai = km.TenChuongTrinh,
                    GiaTriGiam = km.LoaiGiamGia == "PhanTram" ? $"{km.GiaTriGiam}%" : $"{km.GiaTriGiam:N0}đ",
                    GiamToiDa = km.GiamToiDa,
                    DieuKienApDung = km.DieuKienApDung, // <-- SỬA: Thêm
                    NgayBatDau = km.NgayBatDau,
                    NgayKetThuc = km.NgayKetThuc,
                    TrangThai = km.TrangThai,
                    SoLuongConLai = km.SoLuongConLai // <-- SỬA: Thêm
                })
                .ToListAsync();

            return Ok(result);
        }

        /// <summary>
        /// SỬA: Trả về đầy đủ các trường
        /// </summary>
        [HttpGet("{id}")]
        public async Task<IActionResult> GetKhuyenMaiById(int id)
        {
            var km = await _context.KhuyenMais.FindAsync(id);
            if (km == null) return NotFound();

            var dto = new KhuyenMaiUpdateRequestDto
            {
                IdKhuyenMai = km.IdKhuyenMai,
                MaKhuyenMai = km.MaKhuyenMai,
                TenChuongTrinh = km.TenChuongTrinh,
                MoTa = km.MoTa,
                LoaiGiamGia = km.LoaiGiamGia,
                GiaTriGiam = km.GiaTriGiam,
                GiamToiDa = km.GiamToiDa,
                HoaDonToiThieu = km.HoaDonToiThieu,
                IdSanPhamApDung = km.IdSanPhamApDung,
                NgayBatDau = km.NgayBatDau,
                NgayKetThuc = km.NgayKetThuc,
                NgayTrongTuan = km.NgayTrongTuan,
                GioBatDau = km.GioBatDau.HasValue ? km.GioBatDau.Value.ToString(@"hh\:mm") : null,
                GioKetThuc = km.GioKetThuc.HasValue ? km.GioKetThuc.Value.ToString(@"hh\:mm") : null,
                SoLuongConLai = km.SoLuongConLai,
                TrangThai = km.TrangThai,
                DieuKienApDung = km.DieuKienApDung
            };
            return Ok(dto);
        }

        /// <summary>
        /// SỬA: Xử lý đầy đủ các trường khi Tạo mới
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> CreateKhuyenMai([FromBody] KhuyenMaiUpdateRequestDto dto)
        {
            if (await _context.KhuyenMais.AnyAsync(km => km.MaKhuyenMai == dto.MaKhuyenMai))
            {
                return BadRequest($"Mã khuyến mãi '{dto.MaKhuyenMai}' đã tồn tại.");
            }

            var km = new KhuyenMai
            {
                MaKhuyenMai = dto.MaKhuyenMai,
                TenChuongTrinh = dto.TenChuongTrinh,
                MoTa = dto.MoTa,
                LoaiGiamGia = dto.LoaiGiamGia,
                GiaTriGiam = dto.GiaTriGiam,
                GiamToiDa = (dto.LoaiGiamGia == "PhanTram" && dto.GiamToiDa > 0) ? dto.GiamToiDa : null,
                HoaDonToiThieu = (dto.HoaDonToiThieu > 0) ? dto.HoaDonToiThieu : null,
                IdSanPhamApDung = (dto.IdSanPhamApDung > 0) ? dto.IdSanPhamApDung : null,
                NgayBatDau = dto.NgayBatDau.Date,
                NgayKetThuc = dto.NgayKetThuc.Date,
                NgayTrongTuan = string.IsNullOrWhiteSpace(dto.NgayTrongTuan) ? null : dto.NgayTrongTuan,
                GioBatDau = TimeSpan.TryParse(dto.GioBatDau, out var tsStart) ? tsStart : null,
                GioKetThuc = TimeSpan.TryParse(dto.GioKetThuc, out var tsEnd) ? tsEnd : null,
                SoLuongConLai = (dto.SoLuongConLai > 0) ? dto.SoLuongConLai : null,
                TrangThai = dto.TrangThai, // Thường là "Hoạt động"
                DieuKienApDung = dto.DieuKienApDung
            };

            _context.KhuyenMais.Add(km);
            await _context.SaveChangesAsync();
            return CreatedAtAction(nameof(GetKhuyenMaiById), new { id = km.IdKhuyenMai }, km);
        }

        /// <summary>
        /// SỬA: Xử lý đầy đủ các trường khi Cập nhật
        /// </summary>
        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateKhuyenMai(int id, [FromBody] KhuyenMaiUpdateRequestDto dto)
        {
            if (id != dto.IdKhuyenMai) return BadRequest("ID không khớp.");

            var km = await _context.KhuyenMais.FindAsync(id);
            if (km == null) return NotFound();

            // Kiểm tra mã trùng lặp (nếu đổi mã)
            if (km.MaKhuyenMai != dto.MaKhuyenMai && await _context.KhuyenMais.AnyAsync(k => k.MaKhuyenMai == dto.MaKhuyenMai))
            {
                return BadRequest($"Mã khuyến mãi '{dto.MaKhuyenMai}' đã tồn tại.");
            }

            // Map tất cả các trường
            km.MaKhuyenMai = dto.MaKhuyenMai;
            km.TenChuongTrinh = dto.TenChuongTrinh;
            km.MoTa = dto.MoTa;
            km.LoaiGiamGia = dto.LoaiGiamGia;
            km.GiaTriGiam = dto.GiaTriGiam;
            km.GiamToiDa = (dto.LoaiGiamGia == "PhanTram" && dto.GiamToiDa > 0) ? dto.GiamToiDa : null;
            km.HoaDonToiThieu = (dto.HoaDonToiThieu > 0) ? dto.HoaDonToiThieu : null;
            km.IdSanPhamApDung = (dto.IdSanPhamApDung > 0) ? dto.IdSanPhamApDung : null;
            km.NgayBatDau = dto.NgayBatDau.Date;
            km.NgayKetThuc = dto.NgayKetThuc.Date;
            km.NgayTrongTuan = string.IsNullOrWhiteSpace(dto.NgayTrongTuan) ? null : dto.NgayTrongTuan;
            km.GioBatDau = TimeSpan.TryParse(dto.GioBatDau, out var tsStart) ? tsStart : null;
            km.GioKetThuc = TimeSpan.TryParse(dto.GioKetThuc, out var tsEnd) ? tsEnd : null;
            km.SoLuongConLai = (dto.SoLuongConLai > 0) ? dto.SoLuongConLai : null;
            km.DieuKienApDung = dto.DieuKienApDung;

            // Chỉ cập nhật trạng thái nếu nó không phải là "Hết hạn"
            if (km.TrangThai != "Hết hạn")
            {
                km.TrangThai = dto.TrangThai;
            }

            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteKhuyenMai(int id)
        {
            if (await _context.HoaDonKhuyenMais.AnyAsync(hkm => hkm.IdKhuyenMai == id))
            {
                return BadRequest("Không thể xóa khuyến mãi đã được áp dụng cho hóa đơn.");
            }

            var km = await _context.KhuyenMais.FindAsync(id);
            if (km == null) return NotFound();

            _context.KhuyenMais.Remove(km);
            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpPatch("togglestatus/{id}")]
        public async Task<IActionResult> ToggleKhuyenMaiStatus(int id)
        {
            var km = await _context.KhuyenMais.FindAsync(id);
            if (km == null) return NotFound();

            if (km.TrangThai == "Hết hạn")
            {
                return BadRequest("Không thể kích hoạt khuyến mãi đã hết hạn.");
            }

            km.TrangThai = (km.TrangThai == "Hoạt động") ? "Tạm dừng" : "Hoạt động";
            await _context.SaveChangesAsync();
            return Ok(km.TrangThai);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\LichLamViecController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/lichlamviec")]
    [ApiController]
    public class LichLamViecController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public LichLamViecController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API Lấy danh sách Nhân viên (còn làm việc) để gán lịch
        /// </summary>
        [HttpGet("all-nhanvien")]
        public async Task<IActionResult> GetAllNhanVienLookup()
        {
            var data = await _context.NhanViens
                .Where(nv => nv.TrangThaiLamViec == "Đang làm việc")
                .Select(nv => new NhanVienLookupDto
                {
                    IdNhanVien = nv.IdNhanVien,
                    HoTen = nv.HoTen
                })
                .OrderBy(nv => nv.HoTen)
                .ToListAsync();
            return Ok(data);
        }

        /// <summary>
        /// API Lấy lịch làm việc VÀ lịch nghỉ trong 1 ngày
        /// </summary>
        [HttpGet("by-date")]
        public async Task<IActionResult> GetScheduleByDate([FromQuery] DateTime date)
        {
            var targetDate = date.Date;

            // 1. Lấy Lịch Đi Làm
            var caLamList = await _context.LichLamViecs
                .Include(l => l.NhanVien)
                .Include(l => l.CaLamViec)
                .Where(l => l.NgayLam == targetDate)
                .Select(l => new LichLamViecDisplayDto
                {
                    IdLich = l.IdLichLamViec,
                    IdNhanVien = l.IdNhanVien,
                    HoTenNhanVien = l.NhanVien.HoTen,
                    Ngay = l.NgayLam,
                    LoaiLich = "CaLam",
                    TenCa = l.CaLamViec.TenCa,
                    GioBatDau = l.CaLamViec.GioBatDau,
                    GioKetThuc = l.CaLamViec.GioKetThuc
                })
                .ToListAsync();

            // 2. Lấy Lịch Đã Duyệt Nghỉ (Yêu cầu #5)
            var donNghiList = await _context.DonXinNghis
                .Include(d => d.NhanVien)
                .Where(d => d.TrangThai == "Đã duyệt" &&
                            targetDate >= d.NgayBatDau.Date &&
                            targetDate <= d.NgayKetThuc.Date)
                .Select(d => new LichLamViecDisplayDto
                {
                    IdLich = d.IdDonXinNghi,
                    IdNhanVien = d.IdNhanVien,
                    HoTenNhanVien = d.NhanVien.HoTen,
                    Ngay = targetDate,
                    LoaiLich = "NghiPhep",
                    LyDoNghi = d.LyDo
                })
                .ToListAsync();

            // 3. Gộp 2 danh sách
            var combinedList = caLamList.Concat(donNghiList)
                .OrderBy(l => l.HoTenNhanVien)
                .ToList();

            return Ok(combinedList);
        }

        /// <summary>
        /// API Gán lịch làm việc cho nhiều nhân viên
        /// </summary>
        [HttpPost("assign")]
        public async Task<IActionResult> AssignSchedule([FromBody] LichLamViecCreateDto dto)
        {
            if (dto == null || !dto.DanhSachIdNhanVien.Any())
                return BadRequest("Dữ liệu không hợp lệ.");

            var ngay = dto.NgayGanLich.Date;
            int successCount = 0;
            var errors = new List<string>();

            // Lấy danh sách lịch đã tồn tại
            var existingSchedules = await _context.LichLamViecs
                .Where(l => l.NgayLam == ngay && dto.DanhSachIdNhanVien.Contains(l.IdNhanVien))
                .Select(l => l.IdNhanVien)
                .ToListAsync();

            // Lấy danh sách nghỉ đã tồn tại
            var existingNghiPhep = await _context.DonXinNghis
                .Where(d => dto.DanhSachIdNhanVien.Contains(d.IdNhanVien) &&
                            d.TrangThai == "Đã duyệt" &&
                            ngay >= d.NgayBatDau.Date &&
                            ngay <= d.NgayKetThuc.Date)
                .Select(d => d.IdNhanVien)
                .ToListAsync();

            var newEntries = new List<LichLamViec>();
            foreach (var idNhanVien in dto.DanhSachIdNhanVien)
            {
                if (existingSchedules.Contains(idNhanVien))
                {
                    errors.Add($"ID {idNhanVien}: Đã có lịch làm hôm đó.");
                }
                else if (existingNghiPhep.Contains(idNhanVien))
                {
                    errors.Add($"ID {idNhanVien}: Đang trong thời gian nghỉ phép.");
                }
                else
                {
                    newEntries.Add(new LichLamViec
                    {
                        IdNhanVien = idNhanVien,
                        IdCa = dto.IdCa,
                        NgayLam = ngay
                    });
                    successCount++;
                }
            }

            if (newEntries.Any())
            {
                _context.LichLamViecs.AddRange(newEntries);
                await _context.SaveChangesAsync();
            }

            return Ok(new LichLamViecAssignResponseDto
            {
                Message = $"Gán lịch thành công cho {successCount} nhân viên.",
                Failures = errors
            });
        }

        /// <summary>
        /// API Xóa 1 lịch làm việc cụ thể
        /// </summary>
        [HttpDelete("{idLichLamViec}")]
        public async Task<IActionResult> DeleteSchedule(int idLichLamViec)
        {
            var entity = await _context.LichLamViecs.FindAsync(idLichLamViec);
            if (entity == null) return NotFound();

            // Kiểm tra xem đã chấm công chưa (Yêu cầu #6)
            if (await _context.BangChamCongs.AnyAsync(c => c.IdLichLamViec == idLichLamViec))
            {
                return Conflict("Không thể xóa. Lịch làm việc này đã có dữ liệu chấm công.");
            }

            _context.LichLamViecs.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\LuongController.cs
================================================================================
﻿// Tệp: CafebookApi/Controllers/App/LuongController.cs
// (*** THAY THẾ TOÀN BỘ TỆP NÀY ***)

using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/luong")]
    [ApiController]
    public class LuongController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public LuongController(CafebookDbContext context)
        {
            _context = context;
        }

        #region === Helpers ===
        private async Task<CaiDatNhanSuDto> LoadHrSettingsAsync()
        {
            var settings = await _context.CaiDats
                .Where(c => c.TenCaiDat.StartsWith("HR_"))
                .ToListAsync();

            T GetSettingValue<T>(string key, T defaultValue)
            {
                var setting = settings.FirstOrDefault(s => s.TenCaiDat == key)?.GiaTri;
                if (string.IsNullOrEmpty(setting)) return defaultValue;
                try
                {
                    return (T)Convert.ChangeType(setting, typeof(T), CultureInfo.InvariantCulture);
                }
                catch
                {
                    return defaultValue;
                }
            }

            return new CaiDatNhanSuDto
            {
                GioLamChuan = GetSettingValue("HR_GioLamChuan", 8.0m),
                HeSoOT = GetSettingValue("HR_HeSoOT", 1.5m),
                PhatDiTre_Phut = GetSettingValue("HR_PhatDiTre_Phut", 5),
                PhatDiTre_HeSo = GetSettingValue("HR_PhatDiTre_HeSo", 1.0m),
                ChuyenCan_SoNgay = GetSettingValue("HR_ChuyenCan_SoNgay", 26),
                ChuyenCan_TienThuong = GetSettingValue("HR_ChuyenCan_TienThuong", 500000m),
                PhepNam_MacDinh = GetSettingValue("HR_PhepNam_MacDinh", 12)
            };
        }
        #endregion

        #region Module 6.1: Bảng Chấm Công
        [HttpGet("chamcong")]
        public async Task<IActionResult> GetChamCongByDate([FromQuery] DateTime date)
        {
            var hrSettings = await LoadHrSettingsAsync();
            var targetDate = date.Date;

            var query = _context.LichLamViecs
                .Include(l => l.NhanVien)
                .Include(l => l.CaLamViec)
                .Include(l => l.BangChamCongs)
                .Where(l => l.NgayLam == targetDate);

            var results = (await query.ToListAsync())
                .Select(l =>
                {
                    var chamCong = l.BangChamCongs.FirstOrDefault();
                    var gioVao = chamCong?.GioVao;
                    var gioRa = chamCong?.GioRa;
                    var soGioLam = chamCong?.SoGioLam ?? 0m;
                    string trangThai = "Chưa chấm công";

                    if (gioVao.HasValue)
                    {
                        var gioCaVao = l.NgayLam.Add(l.CaLamViec.GioBatDau);
                        trangThai = (gioVao.Value > gioCaVao.AddMinutes(hrSettings.PhatDiTre_Phut)) ? "Đi trễ" : "Đúng giờ";
                    }

                    return new ChamCongDto
                    {
                        IdChamCong = chamCong?.IdChamCong ?? 0,
                        IdLichLamViec = l.IdLichLamViec,
                        HoTenNhanVien = l.NhanVien.HoTen,
                        TenCa = l.CaLamViec.TenCa,
                        NgayLam = l.NgayLam,
                        GioCaBatDau = l.CaLamViec.GioBatDau,
                        GioCaKetThuc = l.CaLamViec.GioKetThuc,
                        GioVao = gioVao,
                        GioRa = gioRa,
                        SoGioLam = soGioLam,
                        TrangThai = trangThai
                    };
                })
                .OrderBy(c => c.TenCa)
                .ThenBy(c => c.HoTenNhanVien)
                .ToList();

            return Ok(results);
        }

        [HttpPut("chamcong")]
        public async Task<IActionResult> UpdateChamCong([FromBody] ChamCongUpdateDto dto)
        {
            BangChamCong? chamCong;

            if (dto.IdChamCong == 0)
            {
                var lich = await _context.LichLamViecs.FindAsync(dto.IdLichLamViec);
                if (lich == null)
                {
                    return BadRequest("Không tìm thấy lịch làm việc tương ứng để tạo chấm công.");
                }
                chamCong = new BangChamCong
                {
                    IdLichLamViec = dto.IdLichLamViec
                };
                _context.BangChamCongs.Add(chamCong);
            }
            else
            {
                chamCong = await _context.BangChamCongs.FindAsync(dto.IdChamCong);
                if (chamCong == null) return NotFound("Không tìm thấy dữ liệu chấm công.");
            }

            chamCong.GioVao = dto.GioVaoMoi;
            chamCong.GioRa = dto.GioRaMoi;

            await _context.SaveChangesAsync();
            return Ok();
        }

        #endregion

        #region Module 6.3 & 6.4: Tính & Chốt Lương

        [HttpGet("calculate")]
        public async Task<IActionResult> CalculatePayroll([FromQuery] DateTime startDate, [FromQuery] DateTime endDate)
        {
            var bangKeList = new List<LuongBangKeDto>();
            var nhanViens = await _context.NhanViens
                .Where(nv => nv.TrangThaiLamViec == "Đang làm việc")
                .ToListAsync();

            var hrSettings = await LoadHrSettingsAsync();

            decimal HE_SO_OT = hrSettings.HeSoOT;
            decimal PHAT_DI_TRE_MOI_GIO = hrSettings.PhatDiTre_HeSo;
            int SO_PHUT_TRE_CHO_PHEP = hrSettings.PhatDiTre_Phut;

            foreach (var nv in nhanViens)
            {
                var ke = new LuongBangKeDto
                {
                    IdNhanVien = nv.IdNhanVien,
                    HoTenNhanVien = nv.HoTen,
                    LuongCoBan = nv.LuongCoBan,
                    ChiTiet = ""
                };

                var lichLamViecList = await _context.LichLamViecs
                    .Include(l => l.CaLamViec)
                    .Include(l => l.BangChamCongs)
                    .Where(l => l.IdNhanVien == nv.IdNhanVien &&
                                l.NgayLam >= startDate.Date &&
                                l.NgayLam <= endDate.Date)
                    .ToListAsync();

                ke.TongGioLam = lichLamViecList.SelectMany(l => l.BangChamCongs).Sum(c => c.SoGioLam ?? 0m);
                ke.TienLuongGio = ke.TongGioLam * ke.LuongCoBan;
                ke.ChiTiet += $"Giờ: {ke.TongGioLam:F2}h. Lương: {ke.TienLuongGio:N0}. ";

                decimal tongPhatTuDong = 0;
                var diTreList = lichLamViecList
                    .Select(l => new {
                        GioCaVao = l.NgayLam.Add(l.CaLamViec.GioBatDau),
                        GioVao = l.BangChamCongs.FirstOrDefault()?.GioVao
                    })
                    .Where(x => x.GioVao.HasValue && x.GioVao.Value > x.GioCaVao.AddMinutes(SO_PHUT_TRE_CHO_PHEP))
                    .ToList();

                foreach (var tre in diTreList)
                {
                    var phutTre = (tre.GioVao!.Value - tre.GioCaVao).TotalMinutes;
                    tongPhatTuDong += (decimal)(phutTre / 60.0) * ke.LuongCoBan * PHAT_DI_TRE_MOI_GIO;
                }
                if (tongPhatTuDong > 0) ke.ChiTiet += $"Phạt trễ: {tongPhatTuDong:N0}. ";

                decimal tongThuongTuDong = 0;
                var otList = lichLamViecList
                    .Select(l => new {
                        GioCaRa = l.NgayLam.Add(l.CaLamViec.GioKetThuc),
                        GioRa = l.BangChamCongs.FirstOrDefault()?.GioRa
                    })
                    .Where(x => x.GioRa.HasValue && x.GioRa.Value > x.GioCaRa)
                    .ToList();

                foreach (var ot in otList)
                {
                    var phutOT = (ot.GioRa!.Value - ot.GioCaRa).TotalMinutes;
                    tongThuongTuDong += (decimal)(phutOT / 60.0) * ke.LuongCoBan * HE_SO_OT;
                }
                if (tongThuongTuDong > 0) ke.ChiTiet += $"Thưởng OT: {tongThuongTuDong:N0}. ";

                int soNgayLamViec = lichLamViecList
                                        .Count(l => l.BangChamCongs.Any(cc => (cc.SoGioLam ?? 0m) > 0));

                if (soNgayLamViec >= hrSettings.ChuyenCan_SoNgay)
                {
                    tongThuongTuDong += hrSettings.ChuyenCan_TienThuong;
                    ke.ChiTiet += $"Thưởng CC: {hrSettings.ChuyenCan_TienThuong:N0}. ";
                }

                // *** SỬA LỖI (Gây ra CS0103 'NhanVienIdNhanVien') ***
                // Thay vì tải toàn bộ PhieuThuongPhat, chỉ Select cột SoTien
                var thuongPhatManualTien = await _context.PhieuThuongPhats
                    .Where(p => p.IdNhanVien == nv.IdNhanVien && p.IdPhieuLuong == null)
                    .Select(p => p.SoTien) // Chỉ lấy số tiền
                    .ToListAsync();

                decimal tongThuongManual = thuongPhatManualTien.Where(soTien => soTien > 0).Sum();
                decimal tongPhatManual = thuongPhatManualTien.Where(soTien => soTien < 0).Sum() * -1; // Sum() sẽ là số âm
                // *** KẾT THÚC SỬA LỖI ***

                if (tongThuongManual > 0) ke.ChiTiet += $"Thưởng khác: {tongThuongManual:N0}. ";
                if (tongPhatManual > 0) ke.ChiTiet += $"Phạt khác: {tongPhatManual:N0}. ";

                ke.TongThuong = tongThuongTuDong + tongThuongManual;
                ke.TongPhat = tongPhatTuDong + tongPhatManual;
                ke.ThucLanh = ke.TienLuongGio + ke.TongThuong - ke.TongPhat;

                bangKeList.Add(ke);
            }

            return Ok(bangKeList);
        }


        [HttpPost("finalize")]
        public async Task<IActionResult> FinalizePayroll([FromBody] LuongFinalizeDto dto)
        {
            if (dto == null || !dto.DanhSachBangKe.Any())
                return BadRequest("Dữ liệu chốt lương không hợp lệ.");

            var existing = await _context.PhieuLuongs
                .AnyAsync(p => p.Thang == dto.Thang && p.Nam == dto.Nam);
            if (existing)
                return Conflict($"Lương Tháng {dto.Thang}/{dto.Nam} đã được chốt trước đó.");

            var newPhieuLuongs = new List<PhieuLuong>();

            using (var transaction = await _context.Database.BeginTransactionAsync())
            {
                try
                {
                    foreach (var ke in dto.DanhSachBangKe)
                    {
                        var phieuLuong = new PhieuLuong
                        {
                            IdNhanVien = ke.IdNhanVien,
                            Thang = dto.Thang,
                            Nam = dto.Nam,
                            LuongCoBan = ke.LuongCoBan,
                            TongGioLam = ke.TongGioLam,
                            TienThuong = ke.TongThuong,
                            KhauTru = ke.TongPhat,
                            ThucLanh = ke.ThucLanh,
                            NgayTao = DateTime.Now,
                            TrangThai = "Đã chốt"
                        };
                        newPhieuLuongs.Add(phieuLuong);
                    }
                    _context.PhieuLuongs.AddRange(newPhieuLuongs);
                    await _context.SaveChangesAsync();

                    for (int i = 0; i < newPhieuLuongs.Count; i++)
                    {
                        var phieuLuongMoi = newPhieuLuongs[i];
                        var keTuongUng = dto.DanhSachBangKe[i];

                        var phieuThuongPhats = await _context.PhieuThuongPhats
                            .Where(p => p.IdNhanVien == keTuongUng.IdNhanVien && p.IdPhieuLuong == null)
                            .ToListAsync();

                        foreach (var p in phieuThuongPhats)
                        {
                            p.IdPhieuLuong = phieuLuongMoi.IdPhieuLuong;
                        }
                    }
                    await _context.SaveChangesAsync();

                    await transaction.CommitAsync();
                    return Ok(new { message = $"Chốt lương Tháng {dto.Thang}/{dto.Nam} thành công cho {newPhieuLuongs.Count} nhân viên." });
                }
                catch (Exception ex)
                {
                    await transaction.RollbackAsync();
                    return StatusCode(500, $"Lỗi nghiêm trọng khi chốt lương: {ex.Message}");
                }
            }
        }
        #endregion
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\NguyenLieuController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/nguyenlieu")]
    [ApiController]
    public class NguyenLieuController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public NguyenLieuController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API Lấy tất cả Nguyên Liệu (kèm tồn kho)
        /// </summary>
        [HttpGet("all")]
        public async Task<IActionResult> GetAllNguyenLieu()
        {
            var data = await _context.NguyenLieus
                .Select(nl => new NguyenLieuCrudDto
                {
                    IdNguyenLieu = nl.IdNguyenLieu,
                    TenNguyenLieu = nl.TenNguyenLieu,
                    DonViTinh = nl.DonViTinh,
                    TonKhoToiThieu = nl.TonKhoToiThieu,
                    TonKho = nl.TonKho // Lấy số lượng tồn
                })
                .OrderBy(nl => nl.TenNguyenLieu)
                .ToListAsync();
            return Ok(data);
        }

        /// <summary>
        /// API Thêm mới Nguyên Liệu
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> CreateNguyenLieu([FromBody] NguyenLieuUpdateRequestDto dto)
        {
            if (string.IsNullOrWhiteSpace(dto.TenNguyenLieu) || string.IsNullOrWhiteSpace(dto.DonViTinh))
            {
                return BadRequest("Tên và Đơn vị tính là bắt buộc.");
            }

            if (await _context.NguyenLieus.AnyAsync(nl => nl.TenNguyenLieu.ToLower() == dto.TenNguyenLieu.ToLower()))
            {
                return Conflict("Tên nguyên liệu đã tồn tại.");
            }

            var entity = new NguyenLieu
            {
                TenNguyenLieu = dto.TenNguyenLieu,
                DonViTinh = dto.DonViTinh,
                TonKhoToiThieu = dto.TonKhoToiThieu,
                TonKho = 0 // Mới tạo
            };

            _context.NguyenLieus.Add(entity);
            await _context.SaveChangesAsync();
            return Ok(entity);
        }

        /// <summary>
        /// API Cập nhật Nguyên Liệu
        /// </summary>
        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateNguyenLieu(int id, [FromBody] NguyenLieuUpdateRequestDto dto)
        {
            var entity = await _context.NguyenLieus.FindAsync(id);
            if (entity == null) return NotFound();

            if (await _context.NguyenLieus.AnyAsync(nl => nl.TenNguyenLieu.ToLower() == dto.TenNguyenLieu.ToLower() && nl.IdNguyenLieu != id))
            {
                return Conflict("Tên nguyên liệu đã tồn tại.");
            }

            entity.TenNguyenLieu = dto.TenNguyenLieu;
            entity.DonViTinh = dto.DonViTinh;
            entity.TonKhoToiThieu = dto.TonKhoToiThieu;

            await _context.SaveChangesAsync();
            return Ok();
        }

        /// <summary>
        /// API Xóa Nguyên Liệu
        /// </summary>
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteNguyenLieu(int id)
        {
            // Kiểm tra ràng buộc
            if (await _context.DinhLuongs.AnyAsync(d => d.IdNguyenLieu == id))
            {
                return Conflict("Không thể xóa. Nguyên liệu này đang được sử dụng trong Định lượng sản phẩm.");
            }
            if (await _context.ChiTietNhapKhos.AnyAsync(d => d.IdNguyenLieu == id))
            {
                return Conflict("Không thể xóa. Nguyên liệu này đã có trong lịch sử Nhập kho.");
            }

            var entity = await _context.NguyenLieus.FindAsync(id);
            if (entity == null) return NotFound();

            _context.NguyenLieus.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\NhanVienController.cs
================================================================================
﻿// Tập tin: CafebookApi/Controllers/App/NhanVienController.cs

using CafebookApi.Data;
using CafebookModel.Model.Entities; // Giữ nguyên using này
using CafebookModel.Model.ModelApp;
using CafebookModel.Utils;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using Microsoft.AspNetCore.Http;

// THÊM ALIAS NÀY ĐỂ TRÁNH XUNG ĐỘT
using NhanVienEntity = CafebookModel.Model.Entities.NhanVien;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/nhanvien")]
    [ApiController]
    public class NhanVienController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private readonly IWebHostEnvironment _env;
        private readonly string _baseUrl;

        public NhanVienController(CafebookDbContext context, IWebHostEnvironment env, IConfiguration config)
        {
            _context = context;
            _env = env;
            if (string.IsNullOrEmpty(_env.WebRootPath))
            {
                _env.WebRootPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot");
                if (!Directory.Exists(_env.WebRootPath))
                {
                    Directory.CreateDirectory(_env.WebRootPath);
                }
            }
            _baseUrl = config.GetValue<string>("Kestrel:Endpoints:Http:Url")
                       ?? "http://127.0.0.1:5166";
        }

        // (Các hàm Helper xử lý file giữ nguyên)
        #region File Helpers
        [ApiExplorerSettings(IgnoreApi = true)]
        private string? GetFullImageUrl(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath))
                return null;
            return $"{_baseUrl}{relativePath.Replace(Path.DirectorySeparatorChar, '/')}";
        }
        [ApiExplorerSettings(IgnoreApi = true)]
        private string GenerateFileName(int id, string ten)
        {
            string slug = SlugifyUtil.GenerateSlug(ten);
            return $"{id}_{slug}.jpg";
        }
        [ApiExplorerSettings(IgnoreApi = true)]
        private void DeleteOldImage(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath)) return;
            var fileName = relativePath.TrimStart('/');
            var fullPath = Path.Combine(_env.WebRootPath, fileName.Replace('/', Path.DirectorySeparatorChar));
            if (System.IO.File.Exists(fullPath))
            {
                System.IO.File.Delete(fullPath);
            }
        }
        [ApiExplorerSettings(IgnoreApi = true)]
        private void RenameImage(string oldRelativePath, string newRelativePath)
        {
            if (string.IsNullOrEmpty(oldRelativePath) || string.IsNullOrEmpty(newRelativePath) || oldRelativePath == newRelativePath)
                return;
            var oldFullPath = Path.Combine(_env.WebRootPath, oldRelativePath.TrimStart('/').Replace('/', Path.DirectorySeparatorChar));
            var newFullPath = Path.Combine(_env.WebRootPath, newRelativePath.TrimStart('/').Replace('/', Path.DirectorySeparatorChar));
            if (System.IO.File.Exists(oldFullPath))
            {
                System.IO.File.Move(oldFullPath, newFullPath);
            }
        }
        [ApiExplorerSettings(IgnoreApi = true)]
        private async Task<string> SaveImageFromFile(IFormFile file, string fileName, string relativeDir)
        {
            var saveDir = Path.Combine(_env.WebRootPath, relativeDir);
            if (!Directory.Exists(saveDir))
            {
                Directory.CreateDirectory(saveDir);
            }
            var fullSavePath = Path.Combine(saveDir, fileName);
            await using (var stream = new FileStream(fullSavePath, FileMode.Create))
            {
                await file.CopyToAsync(stream);
            }
            return $"/{relativeDir.Replace(Path.DirectorySeparatorChar, '/')}/{fileName}";
        }
        #endregion

        [HttpGet("filters")]
        public async Task<IActionResult> GetFilters()
        {
            var filters = new NhanSuFiltersDto
            {
                VaiTros = await _context.VaiTros
                    .Select(v => new FilterLookupDto { Id = v.IdVaiTro, Ten = v.TenVaiTro })
                    .OrderBy(v => v.Ten)
                    .ToListAsync()
            };
            return Ok(filters);
        }

        [HttpGet("search")]
        public async Task<IActionResult> SearchNhanVien(
            [FromQuery] string? searchText,
            [FromQuery] int? vaiTroId)
        {
            // SỬA LỖI: Dùng NhanVienEntity
            var query = _context.NhanViens
                .Include(nv => nv.VaiTro)
                .AsQueryable();

            if (vaiTroId.HasValue && vaiTroId > 0)
            {
                query = query.Where(nv => nv.IdVaiTro == vaiTroId);
            }

            if (!string.IsNullOrEmpty(searchText))
            {
                string searchLower = searchText.ToLower();
                query = query.Where(nv =>
                    nv.HoTen.ToLower().Contains(searchLower) ||
                    nv.TenDangNhap.ToLower().Contains(searchLower)
                );
            }

            var results = await query
                .Select(nv => new NhanVienGridDto
                {
                    IdNhanVien = nv.IdNhanVien,
                    HoTen = nv.HoTen,
                    TenVaiTro = nv.VaiTro.TenVaiTro,
                    LuongCoBan = nv.LuongCoBan,
                    TrangThaiLamViec = nv.TrangThaiLamViec
                })
                .OrderBy(nv => nv.HoTen)
                .ToListAsync();

            return Ok(results);
        }

        [HttpGet("details/{id}")]
        public async Task<IActionResult> GetDetails(int id)
        {
            // SỬA LỖI: Dùng NhanVienEntity
            var nv = await _context.NhanViens.FindAsync(id);
            if (nv == null) return NotFound();

            var dto = new NhanVienDetailDto
            {
                IdNhanVien = nv.IdNhanVien,
                HoTen = nv.HoTen,
                TenDangNhap = nv.TenDangNhap,
                IdVaiTro = nv.IdVaiTro,
                LuongCoBan = nv.LuongCoBan,
                TrangThaiLamViec = nv.TrangThaiLamViec,
                SoDienThoai = nv.SoDienThoai,
                Email = nv.Email,
                DiaChi = nv.DiaChi,
                NgayVaoLam = nv.NgayVaoLam,
                AnhDaiDienUrl = GetFullImageUrl(nv.AnhDaiDien)
            };
            return Ok(dto);
        }

        [HttpPost]
        public async Task<IActionResult> CreateNhanVien([FromForm] NhanVienUpdateRequestDto dto)
        {
            if (string.IsNullOrWhiteSpace(dto.TenDangNhap) || string.IsNullOrWhiteSpace(dto.MatKhau))
            {
                return BadRequest("Tên đăng nhập và Mật khẩu là bắt buộc khi tạo mới.");
            }

            // SỬA LỖI: Dùng NhanVienEntity
            if (await _context.NhanViens.AnyAsync(nv => nv.TenDangNhap.ToLower() == dto.TenDangNhap.ToLower()))
            {
                return Conflict("Tên đăng nhập đã tồn tại.");
            }

            // SỬA LỖI: Dùng NhanVienEntity
            var entity = new NhanVienEntity
            {
                HoTen = dto.HoTen,
                TenDangNhap = dto.TenDangNhap,
                MatKhau = dto.MatKhau,
                IdVaiTro = dto.IdVaiTro,
                LuongCoBan = dto.LuongCoBan,
                TrangThaiLamViec = dto.TrangThaiLamViec,
                SoDienThoai = dto.SoDienThoai,
                Email = dto.Email,
                DiaChi = dto.DiaChi,
                NgayVaoLam = dto.NgayVaoLam,
                AnhDaiDien = null
            };

            // SỬA LỖI: Dùng NhanVienEntity
            _context.NhanViens.Add(entity);
            await _context.SaveChangesAsync();

            if (dto.AnhDaiDienUpload != null)
            {
                try
                {
                    string fileName = GenerateFileName(entity.IdNhanVien, entity.HoTen);
                    string relativePath = await SaveImageFromFile(dto.AnhDaiDienUpload, fileName, HinhAnhPaths.UrlAvatarNV.TrimStart('/'));
                    entity.AnhDaiDien = relativePath;
                    await _context.SaveChangesAsync();
                }
                catch (Exception ex)
                {
                    return StatusCode(500, $"Lỗi khi lưu ảnh: {ex.Message}");
                }
            }

            return Ok(entity);
        }

        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateNhanVien(int id, [FromForm] NhanVienUpdateRequestDto dto)
        {
            // SỬA LỖI: Dùng NhanVienEntity
            var entity = await _context.NhanViens.FindAsync(id);
            if (entity == null) return NotFound();

            // SỬA LỖI: Dùng NhanVienEntity
            if (await _context.NhanViens.AnyAsync(nv => nv.TenDangNhap.ToLower() == dto.TenDangNhap.ToLower() && nv.IdNhanVien != id))
            {
                return Conflict("Tên đăng nhập đã tồn tại.");
            }

            // (Phần logic cập nhật file và thuộc tính giữ nguyên)
            var oldImagePath = entity.AnhDaiDien;
            var oldTen = entity.HoTen;
            bool isImageUpload = dto.AnhDaiDienUpload != null;
            bool isNameChange = dto.HoTen != oldTen;

            entity.HoTen = dto.HoTen;
            entity.TenDangNhap = dto.TenDangNhap;
            entity.IdVaiTro = dto.IdVaiTro;
            entity.LuongCoBan = dto.LuongCoBan;
            entity.TrangThaiLamViec = dto.TrangThaiLamViec;
            entity.SoDienThoai = dto.SoDienThoai;
            entity.Email = dto.Email;
            entity.DiaChi = dto.DiaChi;
            entity.NgayVaoLam = dto.NgayVaoLam;
            if (!string.IsNullOrWhiteSpace(dto.MatKhau))
            {
                entity.MatKhau = dto.MatKhau;
            }

            string newFileName = GenerateFileName(entity.IdNhanVien, entity.HoTen);
            string newRelativePath = $"/{HinhAnhPaths.UrlAvatarNV.TrimStart('/')}/{newFileName}";

            if (isImageUpload)
            {
                DeleteOldImage(oldImagePath);
                entity.AnhDaiDien = await SaveImageFromFile(dto.AnhDaiDienUpload, newFileName, HinhAnhPaths.UrlAvatarNV.TrimStart('/'));
            }
            else if (dto.XoaAnhDaiDien)
            {
                DeleteOldImage(oldImagePath);
                entity.AnhDaiDien = null;
            }
            else if (isNameChange && !string.IsNullOrEmpty(oldImagePath))
            {
                RenameImage(oldImagePath, newRelativePath);
                entity.AnhDaiDien = newRelativePath;
            }

            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpPut("update-status/{id}")]
        public async Task<IActionResult> UpdateStatus(int id, [FromBody] string newStatus)
        {
            // SỬA LỖI: Dùng NhanVienEntity
            var entity = await _context.NhanViens.FindAsync(id);
            if (entity == null) return NotFound();

            entity.TrangThaiLamViec = newStatus;
            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteNhanVien(int id)
        {
            // (Logic kiểm tra ràng buộc giữ nguyên)
            if (await _context.LichLamViecs.AnyAsync(l => l.IdNhanVien == id) ||
                await _context.PhieuLuongs.AnyAsync(p => p.IdNhanVien == id) ||
                await _context.HoaDons.AnyAsync(h => h.IdNhanVien == id))
            {
                return Conflict("Không thể xóa. Nhân viên này đã có dữ liệu Lịch làm việc, Lương hoặc Hóa đơn. Vui lòng chọn 'Nghỉ việc'.");
            }

            // SỬA LỖI: Dùng NhanVienEntity
            var entity = await _context.NhanViens.FindAsync(id);
            if (entity == null) return NotFound();

            DeleteOldImage(entity.AnhDaiDien);

            // SỬA LỖI: Dùng NhanVienEntity
            _context.NhanViens.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\PhanQuyenController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/phanquyen")]
    [ApiController]
    public class PhanQuyenController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public PhanQuyenController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API Lấy TẤT CẢ các Quyền có trong hệ thống
        /// </summary>
        [HttpGet("all-permissions")]
        public async Task<IActionResult> GetAllPermissions()
        {
            var data = await _context.Quyens
                .AsNoTracking()
                .Select(q => new QuyenDto
                {
                    IdQuyen = q.IdQuyen,
                    TenQuyen = q.TenQuyen,
                    NhomQuyen = q.NhomQuyen
                })
                .OrderBy(q => q.NhomQuyen)
                .ThenBy(q => q.TenQuyen)
                .ToListAsync();
            return Ok(data);
        }

        /// <summary>
        /// API Lấy danh sách IdQuyen đã được gán cho một VaiTrò
        /// </summary>
        [HttpGet("for-role/{idVaiTro}")]
        public async Task<IActionResult> GetPermissionsForRole(int idVaiTro)
        {
            var data = await _context.VaiTroQuyens
                .Where(vtq => vtq.IdVaiTro == idVaiTro)
                .Select(vtq => vtq.IdQuyen)
                .ToListAsync();
            return Ok(data);
        }

        /// <summary>
        /// API Cập nhật (Sync) toàn bộ quyền cho một Vai Trò
        /// </summary>
        [HttpPut("update")]
        public async Task<IActionResult> UpdatePermissions([FromBody] PhanQuyenDto dto)
        {
            if (dto == null) return BadRequest("Dữ liệu không hợp lệ.");

            // 1. Lấy các quyền hiện tại
            var currentPermissions = await _context.VaiTroQuyens
                .Where(vtq => vtq.IdVaiTro == dto.IdVaiTro)
                .ToListAsync();

            var currentIdList = currentPermissions.Select(p => p.IdQuyen).ToList();
            var newIdList = dto.DanhSachIdQuyen;

            // 2. Tìm các quyền cần XÓA
            var toDelete = currentPermissions
                .Where(p => !newIdList.Contains(p.IdQuyen))
                .ToList();

            // 3. Tìm các quyền cần THÊM
            var toAddIds = newIdList
                .Where(id => !currentIdList.Contains(id))
                .ToList();

            // 4. Thực thi
            if (toDelete.Any())
            {
                _context.VaiTroQuyens.RemoveRange(toDelete);
            }

            if (toAddIds.Any())
            {
                var toAddEntities = toAddIds.Select(id => new VaiTro_Quyen
                {
                    IdVaiTro = dto.IdVaiTro,
                    IdQuyen = id
                });
                await _context.VaiTroQuyens.AddRangeAsync(toAddEntities);
            }

            await _context.SaveChangesAsync();
            return Ok(new { message = "Cập nhật phân quyền thành công!" });
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\PhatLuongController.cs
================================================================================
﻿// Tệp: CafebookApi/Controllers/App/PhatLuongController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/phatluong")]
    [ApiController]
    public class PhatLuongController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public PhatLuongController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// Lấy danh sách các phiếu lương đã chốt hoặc đã phát theo kỳ
        /// </summary>
        [HttpGet("danhsach")]
        public async Task<IActionResult> GetDanhSachPhieuLuong([FromQuery] int thang, [FromQuery] int nam)
        {
            var query = _context.PhieuLuongs
                .Include(p => p.NhanVien)
                .Where(p => p.Thang == thang && p.Nam == nam &&
                             (p.TrangThai == "Đã chốt" || p.TrangThai == "Đã phát"))
                .OrderByDescending(p => p.TrangThai)
                .ThenBy(p => p.NhanVien.HoTen);

            var result = await query.Select(p => new PhieuLuongDto
            {
                IdPhieuLuong = p.IdPhieuLuong,
                IdNhanVien = p.IdNhanVien,
                HoTenNhanVien = p.NhanVien.HoTen,
                Thang = p.Thang,
                Nam = p.Nam,
                TongGioLam = p.TongGioLam,
                ThucLanh = p.ThucLanh,
                NgayChot = p.NgayTao,
                TrangThai = p.TrangThai
            }).ToListAsync();

            return Ok(result);
        }

        /// <summary>
        /// Lấy chi tiết 1 phiếu lương để xem hoặc in
        /// </summary>
        [HttpGet("chitiet/{id}")]
        public async Task<IActionResult> GetChiTietPhieuLuong(int id)
        {
            // *** SỬA LỖI: Sử dụng đúng DTO và xóa logic thừa ***
            // Dùng DTO của ModelApp (Quản lý)
            var phieu = await _context.PhieuLuongs
                .Include(p => p.NhanVien)
                .Include(p => p.NguoiPhat)
                .Where(p => p.IdPhieuLuong == id)
                .Select(p => new CafebookModel.Model.ModelApp.PhieuLuongChiTietDto // Chỉ định rõ DTO để hết lỗi CS0104
                {
                    IdPhieuLuong = p.IdPhieuLuong,
                    HoTenNhanVien = p.NhanVien.HoTen,
                    Thang = p.Thang,
                    Nam = p.Nam,
                    LuongCoBan = p.LuongCoBan,
                    TongGioLam = p.TongGioLam,
                    TienThuong = p.TienThuong ?? 0,
                    KhauTru = p.KhauTru ?? 0,
                    ThucLanh = p.ThucLanh,
                    TrangThai = p.TrangThai,
                    NgayPhat = p.NgayPhatLuong,
                    TenNguoiPhat = p.NguoiPhat != null ? p.NguoiPhat.HoTen : null
                })
                .FirstOrDefaultAsync();
            // *** KẾT THÚC SỬA LỖI ***

            if (phieu == null)
            {
                return NotFound("Không tìm thấy phiếu lương.");
            }

            // (Đã xóa logic truy vấn PhieuThuongPhats vì không cần thiết cho màn hình này)

            return Ok(phieu);
        }

        /// <summary>
        /// Xác nhận đã phát lương cho 1 phiếu lương
        /// </summary>
        [HttpPut("xacnhan/{id}")]
        public async Task<IActionResult> XacNhanPhatLuong(int id, [FromBody] PhatLuongXacNhanDto dto)
        {
            var phieu = await _context.PhieuLuongs.FindAsync(id);

            if (phieu == null)
            {
                return NotFound("Không tìm thấy phiếu lương.");
            }

            if (phieu.TrangThai == "Đã phát")
            {
                return BadRequest("Phiếu lương này đã được xác nhận phát trước đó.");
            }

            phieu.TrangThai = "Đã phát";
            phieu.NgayPhatLuong = DateTime.Now;
            phieu.IdNguoiPhat = dto.IdNguoiPhat;

            await _context.SaveChangesAsync();

            return Ok(new { message = "Xác nhận phát lương thành công." });
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\PhuThuController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.Entities;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App.QuanLy
{
    [Route("api/app/quanly/phuthu")]
    [ApiController]
    public class PhuThuController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public PhuThuController(CafebookDbContext context)
        {
            _context = context;
        }

        // GET: api/app/quanly/phuthu
        [HttpGet]
        public async Task<IActionResult> GetAllPhuThu()
        {
            var phuThus = await _context.PhuThus.AsNoTracking().ToListAsync();
            return Ok(phuThus);
        }

        // GET: api/app/quanly/phuthu/5
        [HttpGet("{id}")]
        public async Task<IActionResult> GetPhuThuById(int id)
        {
            var phuThu = await _context.PhuThus.FindAsync(id);
            if (phuThu == null)
            {
                return NotFound();
            }
            return Ok(phuThu);
        }

        // POST: api/app/quanly/phuthu
        [HttpPost]
        public async Task<IActionResult> CreatePhuThu([FromBody] PhuThu phuThu)
        {
            if (!ModelState.IsValid)
            {
                return BadRequest(ModelState);
            }

            _context.PhuThus.Add(phuThu);
            await _context.SaveChangesAsync();

            return CreatedAtAction(nameof(GetPhuThuById), new { id = phuThu.IdPhuThu }, phuThu);
        }

        // PUT: api/app/quanly/phuthu/5
        [HttpPut("{id}")]
        public async Task<IActionResult> UpdatePhuThu(int id, [FromBody] PhuThu phuThu)
        {
            if (id != phuThu.IdPhuThu)
            {
                return BadRequest("ID không khớp.");
            }

            if (!ModelState.IsValid)
            {
                return BadRequest(ModelState);
            }

            _context.Entry(phuThu).State = EntityState.Modified;

            try
            {
                await _context.SaveChangesAsync();
            }
            catch (DbUpdateConcurrencyException)
            {
                if (!_context.PhuThus.Any(e => e.IdPhuThu == id))
                {
                    return NotFound();
                }
                else
                {
                    throw;
                }
            }
            return NoContent();
        }

        // DELETE: api/app/quanly/phuthu/5
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeletePhuThu(int id)
        {
            var phuThu = await _context.PhuThus.FindAsync(id);
            if (phuThu == null)
            {
                return NotFound();
            }

            // KIỂM TRA QUAN TRỌNG: Không cho xóa nếu phụ thu đã được dùng
            var isInUse = await _context.ChiTietPhuThuHoaDons.AnyAsync(ct => ct.IdPhuThu == id);
            if (isInUse)
            {
                return Conflict("Không thể xóa phụ thu này vì đã được sử dụng trong các hóa đơn cũ.");
            }

            _context.PhuThus.Remove(phuThu);
            await _context.SaveChangesAsync();

            return NoContent();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\SachController.cs
================================================================================
﻿// Tập tin: CafebookApi/Controllers/App/SachController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using CafebookModel.Utils;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Data.SqlClient;
using Microsoft.EntityFrameworkCore;
using System;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using Microsoft.AspNetCore.Http;
using System.Collections.Generic; // THÊM

namespace CafebookApi.Controllers.App
{
    [Route("api/app/sach")]
    [ApiController]
    public class SachController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private readonly IWebHostEnvironment _env;
        private readonly string _baseUrl;

        public SachController(CafebookDbContext context, IWebHostEnvironment env, IConfiguration config)
        {
            _context = context;
            _env = env;

            if (string.IsNullOrEmpty(_env.WebRootPath))
            {
                _env.WebRootPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot");
                if (!Directory.Exists(_env.WebRootPath))
                {
                    Directory.CreateDirectory(_env.WebRootPath);
                }
            }
            _baseUrl = config.GetValue<string>("Kestrel:Endpoints:Http:Url") ?? "http://127.0.0.1:5166";
        }

        // === 5 HÀM HELPER XỬ LÝ FILE (Giữ nguyên) ===
        private string? GetFullImageUrl(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath))
                return null;
            return $"{_baseUrl}{relativePath.Replace(Path.DirectorySeparatorChar, '/')}";
        }
        private string GenerateFileName(int id, string ten)
        {
            string slug = SlugifyUtil.GenerateSlug(ten);
            return $"{id}_{slug}.jpg";
        }
        private void DeleteOldImage(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath)) return;
            var fileName = relativePath.TrimStart('/');
            var fullPath = Path.Combine(_env.WebRootPath, fileName.Replace('/', Path.DirectorySeparatorChar));
            if (System.IO.File.Exists(fullPath))
            {
                System.IO.File.Delete(fullPath);
            }
        }
        private void RenameImage(string oldRelativePath, string newRelativePath)
        {
            if (string.IsNullOrEmpty(oldRelativePath) || string.IsNullOrEmpty(newRelativePath) || oldRelativePath == newRelativePath)
                return;
            var oldFileName = oldRelativePath.TrimStart('/');
            var oldFullPath = Path.Combine(_env.WebRootPath, oldFileName.Replace('/', Path.DirectorySeparatorChar));
            var newFileName = newRelativePath.TrimStart('/');
            var newFullPath = Path.Combine(_env.WebRootPath, newFileName.Replace('/', Path.DirectorySeparatorChar));
            if (System.IO.File.Exists(oldFullPath))
            {
                System.IO.File.Move(oldFullPath, newFullPath);
            }
        }
        private async Task<string> SaveImageFromFile(IFormFile file, string fileName, string relativeDir)
        {
            var saveDir = Path.Combine(_env.WebRootPath, relativeDir);
            if (!Directory.Exists(saveDir))
            {
                Directory.CreateDirectory(saveDir);
            }
            var fullSavePath = Path.Combine(saveDir, fileName);
            await using (var stream = new FileStream(fullSavePath, FileMode.Create))
            {
                await file.CopyToAsync(stream);
            }
            return $"/{relativeDir.Replace(Path.DirectorySeparatorChar, '/')}/{fileName}";
        }
        // =============================

        // SỬA: GetSachFilters (thêm MoTa/GioiThieu)
        [HttpGet("filters")]
        public async Task<IActionResult> GetSachFilters()
        {
            var theLoais = await _context.TheLoais
                .Select(t => new FilterLookupDto { Id = t.IdTheLoai, Ten = t.TenTheLoai, MoTa = t.MoTa })
                .OrderBy(t => t.Ten)
                .ToListAsync();

            var tacGias = await _context.TacGias
                .Select(t => new FilterLookupDto { Id = t.IdTacGia, Ten = t.TenTacGia, MoTa = t.GioiThieu })
                .OrderBy(t => t.Ten)
                .ToListAsync();

            var nhaXuatBans = await _context.NhaXuatBans
                .Select(t => new FilterLookupDto { Id = t.IdNhaXuatBan, Ten = t.TenNhaXuatBan, MoTa = t.MoTa })
                .OrderBy(t => t.Ten)
                .ToListAsync();

            var dto = new SachFiltersDto
            {
                TheLoais = theLoais,
                TacGias = tacGias,
                NhaXuatBans = nhaXuatBans
            };
            return Ok(dto);
        }

        #region API Sách (Sửa đổi cho Many-to-Many)

        // SỬA: SearchSach (dùng LINQ join chuỗi và lọc 'Any')
        [HttpGet("search")]
        public async Task<IActionResult> SearchSach(
            [FromQuery] string? searchText,
            [FromQuery] int? theLoaiId)
        {
            var query = _context.Sachs.AsQueryable();

            if (theLoaiId.HasValue && theLoaiId > 0)
            {
                // Lọc theo bảng nối
                query = query.Where(s => s.SachTheLoais.Any(stl => stl.IdTheLoai == theLoaiId));
            }
            if (!string.IsNullOrEmpty(searchText))
            {
                string searchLower = searchText.ToLower();
                query = query.Where(s =>
                    s.TenSach.ToLower().Contains(searchLower) ||
                    // Lọc Tác giả theo bảng nối
                    s.SachTacGias.Any(stg => stg.TacGia.TenTacGia.ToLower().Contains(searchLower))
                );
            }

            var rawResults = await query
                .Select(s => new
                {
                    s.IdSach,
                    s.TenSach,
                    // Nối chuỗi Tác giả
                    TenTacGia = string.Join(", ", s.SachTacGias.Select(stg => stg.TacGia.TenTacGia)),
                    // Nối chuỗi Thể loại
                    TenTheLoai = string.Join(", ", s.SachTheLoais.Select(stl => stl.TheLoai.TenTheLoai)),
                    s.ViTri,
                    s.SoLuongTong,
                    s.SoLuongHienCo,
                    s.AnhBia
                })
                .OrderBy(s => s.TenSach)
                .ToListAsync();

            var results = rawResults.Select(s => new SachDto
            {
                IdSach = s.IdSach,
                TenSach = s.TenSach,
                TenTacGia = string.IsNullOrEmpty(s.TenTacGia) ? "N/A" : s.TenTacGia,
                TenTheLoai = string.IsNullOrEmpty(s.TenTheLoai) ? "N/A" : s.TenTheLoai,
                ViTri = s.ViTri,
                SoLuongTong = s.SoLuongTong,
                SoLuongHienCo = s.SoLuongHienCo,
                AnhBiaUrl = GetFullImageUrl(s.AnhBia)
            }).ToList();

            return Ok(results);
        }

        // SỬA: GetSachDetails (lấy List<int> từ các bảng nối)
        [HttpGet("details/{id}")]
        public async Task<IActionResult> GetSachDetails(int id)
        {
            var sach = await _context.Sachs.FindAsync(id);
            if (sach == null) return NotFound();

            var dto = new SachDetailDto
            {
                IdSach = sach.IdSach,
                TenSach = sach.TenSach,
                // Lấy List<int> từ các bảng nối
                IdTheLoais = await _context.SachTheLoais.Where(st => st.IdSach == id).Select(st => st.IdTheLoai).ToListAsync(),
                IdTacGias = await _context.SachTacGias.Where(st => st.IdSach == id).Select(st => st.IdTacGia).ToListAsync(),
                IdNhaXuatBans = await _context.SachNhaXuatBans.Where(sn => sn.IdSach == id).Select(sn => sn.IdNhaXuatBan).ToListAsync(),
                NamXuatBan = sach.NamXuatBan,
                MoTa = sach.MoTa,
                SoLuongTong = sach.SoLuongTong,
                AnhBiaUrl = GetFullImageUrl(sach.AnhBia),
                GiaBia = sach.GiaBia,
                ViTri = sach.ViTri
            };
            return Ok(dto);
        }

        // SỬA: CreateSach (dùng Transaction, lưu vào bảng nối)
        [HttpPost]
        public async Task<IActionResult> CreateSach(
                    [FromForm] SachUpdateRequestDto dto)
        {
            // Dùng Transaction để đảm bảo an toàn dữ liệu
            await using var transaction = await _context.Database.BeginTransactionAsync();
            try
            {
                var sach = new Sach
                {
                    TenSach = dto.TenSach,
                    NamXuatBan = dto.NamXuatBan,
                    MoTa = dto.MoTa,
                    SoLuongTong = dto.SoLuongTong,
                    SoLuongHienCo = dto.SoLuongTong,
                    GiaBia = dto.GiaBia,
                    ViTri = dto.ViTri,
                    AnhBia = null
                };
                _context.Sachs.Add(sach);
                await _context.SaveChangesAsync(); // Lưu để lấy IdSach mới

                // Xử lý ảnh (nếu có)
                if (dto.AnhBiaUpload != null)
                {
                    string fileName = GenerateFileName(sach.IdSach, sach.TenSach);
                    string relativePath = await SaveImageFromFile(dto.AnhBiaUpload, fileName, HinhAnhPaths.UrlBooks.TrimStart('/'));
                    sach.AnhBia = relativePath;
                    // (Lưu thay đổi ảnh sẽ ở cuối transaction)
                }

                // SỬA: Thêm vào các bảng nối
                foreach (var id in dto.IdTacGias)
                {
                    _context.SachTacGias.Add(new SachTacGia { IdSach = sach.IdSach, IdTacGia = id });
                }
                foreach (var id in dto.IdTheLoais)
                {
                    _context.SachTheLoais.Add(new SachTheLoai { IdSach = sach.IdSach, IdTheLoai = id });
                }
                foreach (var id in dto.IdNhaXuatBans)
                {
                    _context.SachNhaXuatBans.Add(new SachNhaXuatBan { IdSach = sach.IdSach, IdNhaXuatBan = id });
                }

                await _context.SaveChangesAsync(); // Lưu bảng nối và ảnh
                await transaction.CommitAsync(); // Hoàn tất

                var detailDto = new SachDetailDto
                {
                    IdSach = sach.IdSach,
                    TenSach = sach.TenSach,
                    AnhBiaUrl = GetFullImageUrl(sach.AnhBia)
                };
                return Ok(detailDto);
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync(); // Hoàn tác nếu lỗi
                return StatusCode(500, $"Lỗi khi tạo sách: {ex.Message}");
            }
        }

        // SỬA: UpdateSach (dùng Transaction, xóa liên kết cũ, thêm liên kết mới)
        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateSach(int id,
                    [FromForm] SachUpdateRequestDto dto)
        {
            var sach = await _context.Sachs.FindAsync(id);
            if (sach == null) return NotFound();

            // Dùng Transaction
            await using var transaction = await _context.Database.BeginTransactionAsync();
            try
            {
                int soLuongDangMuon = sach.SoLuongTong - sach.SoLuongHienCo;
                if (dto.SoLuongTong < soLuongDangMuon)
                {
                    return Conflict($"Số lượng tổng ({dto.SoLuongTong}) không thể nhỏ hơn số lượng đang cho thuê ({soLuongDangMuon}).");
                }

                var oldImagePath = sach.AnhBia;
                var oldTenSach = sach.TenSach;

                bool isImageUpload = dto.AnhBiaUpload != null;
                bool isNameChange = dto.TenSach != oldTenSach;

                // Cập nhật các trường đơn giản
                sach.TenSach = dto.TenSach;
                sach.NamXuatBan = dto.NamXuatBan;
                sach.MoTa = dto.MoTa;
                sach.SoLuongTong = dto.SoLuongTong;
                sach.SoLuongHienCo = dto.SoLuongTong - soLuongDangMuon;
                sach.GiaBia = dto.GiaBia;
                sach.ViTri = dto.ViTri;

                // Xử lý ảnh
                string newFileName = GenerateFileName(sach.IdSach, sach.TenSach);
                string newRelativePath = $"/{HinhAnhPaths.UrlBooks.TrimStart('/')}/{newFileName}";

                if (isImageUpload)
                {
                    DeleteOldImage(oldImagePath);
                    sach.AnhBia = await SaveImageFromFile(dto.AnhBiaUpload!, newFileName, HinhAnhPaths.UrlBooks.TrimStart('/'));
                }
                else if (dto.XoaAnhBia)
                {
                    DeleteOldImage(oldImagePath);
                    sach.AnhBia = null;
                }
                else if (isNameChange && !string.IsNullOrEmpty(oldImagePath))
                {
                    RenameImage(oldImagePath, newRelativePath);
                    sach.AnhBia = newRelativePath;
                }

                // SỬA: Cập nhật các bảng nối (Xóa cũ, thêm mới)
                // 1. Xóa liên kết cũ
                _context.SachTacGias.RemoveRange(_context.SachTacGias.Where(st => st.IdSach == id));
                _context.SachTheLoais.RemoveRange(_context.SachTheLoais.Where(st => st.IdSach == id));
                _context.SachNhaXuatBans.RemoveRange(_context.SachNhaXuatBans.Where(sn => sn.IdSach == id));

                // 2. Thêm liên kết mới
                foreach (var tacGiaId in dto.IdTacGias)
                {
                    _context.SachTacGias.Add(new SachTacGia { IdSach = id, IdTacGia = tacGiaId });
                }
                foreach (var theLoaiId in dto.IdTheLoais)
                {
                    _context.SachTheLoais.Add(new SachTheLoai { IdSach = id, IdTheLoai = theLoaiId });
                }
                foreach (var nxbId in dto.IdNhaXuatBans)
                {
                    _context.SachNhaXuatBans.Add(new SachNhaXuatBan { IdSach = id, IdNhaXuatBan = nxbId });
                }

                await _context.SaveChangesAsync(); // Lưu tất cả thay đổi (sách, ảnh, bảng nối)
                await transaction.CommitAsync(); // Hoàn tất

                return Ok();
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                return StatusCode(500, $"Lỗi khi cập nhật sách: {ex.Message}");
            }
        }

        // SỬA: DeleteSach (phải xóa các liên kết trong bảng nối TRƯỚC KHI xóa sách)
        // (Nếu CSDL của bạn đã thiết lập ON DELETE CASCADE thì không cần,
        // nhưng làm tường minh sẽ an toàn hơn)
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteSach(int id)
        {
            if (await _context.ChiTietPhieuThues.AnyAsync(ct => ct.IdSach == id && ct.NgayTraThucTe == null))
            {
                return Conflict("Không thể xóa sách. Sách này đang được khách hàng thuê.");
            }

            var sach = await _context.Sachs.FindAsync(id);
            if (sach == null) return NotFound();

            // Dùng Transaction
            await using var transaction = await _context.Database.BeginTransactionAsync();
            try
            {
                DeleteOldImage(sach.AnhBia); // Xóa file ảnh

                // Xóa các liên kết (Không cần nếu có ON DELETE CASCADE)
                _context.SachTacGias.RemoveRange(_context.SachTacGias.Where(st => st.IdSach == id));
                _context.SachTheLoais.RemoveRange(_context.SachTheLoais.Where(st => st.IdSach == id));
                _context.SachNhaXuatBans.RemoveRange(_context.SachNhaXuatBans.Where(sn => sn.IdSach == id));

                // Xóa sách
                _context.Sachs.Remove(sach);

                await _context.SaveChangesAsync();
                await transaction.CommitAsync();

                return Ok();
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                return StatusCode(500, $"Lỗi khi xóa sách: {ex.Message}");
            }
        }

        #endregion

        #region API Lịch sử & CRUD Danh mục (Đã sửa)

        // SỬA: GetRentalData (Thêm lọc ngày)
        [HttpGet("rentals")]
        public async Task<IActionResult> GetRentalData(
            [FromQuery] DateTime? fromDate,
            [FromQuery] DateTime? toDate)
        {
            var toDateEnd = toDate?.AddDays(1);
            var sqlParams = new List<SqlParameter>();

            // 1. SQL cho Sách Quá Hạn (không lọc ngày)
            string sqlQuaHan = @"
                SELECT
                    s.tenSach AS TenSach, kh.hoTen AS HoTen, kh.soDienThoai AS SoDienThoai,
                    pts.ngayThue AS NgayThue, ctpt.ngayHenTra AS NgayHenTra,
                    N'Trễ ' + CAST(DATEDIFF(DAY, ctpt.ngayHenTra, GETDATE()) AS NVARCHAR) + N' ngày' AS TinhTrang
                FROM dbo.ChiTietPhieuThue ctpt
                JOIN dbo.PhieuThueSach pts ON ctpt.idPhieuThueSach = pts.idPhieuThueSach
                JOIN dbo.Sach s ON ctpt.idSach = s.idSach
                JOIN dbo.KhachHang kh ON pts.idKhachHang = kh.idKhachHang
                WHERE ctpt.ngayTraThucTe IS NULL AND ctpt.ngayHenTra < GETDATE()
                ORDER BY ctpt.ngayHenTra ASC;";

            // 2. SQL cho Lịch sử (có lọc ngày)
            var whereClauses = new List<string>();
            if (fromDate.HasValue)
            {
                whereClauses.Add("pts.ngayThue >= @fromDate");
                sqlParams.Add(new SqlParameter("@fromDate", fromDate.Value));
            }
            if (toDateEnd.HasValue)
            {
                whereClauses.Add("pts.ngayThue < @toDateEnd");
                sqlParams.Add(new SqlParameter("@toDateEnd", toDateEnd.Value));
            }
            string whereSqlLichSu = whereClauses.Count > 0 ? "WHERE " + string.Join(" AND ", whereClauses) : "";

            string sqlLichSu = $@"
                SELECT TOP 50
                    s.tenSach AS TenSach, kh.hoTen AS TenKhachHang, pts.ngayThue AS NgayThue,
                    ctpt.ngayHenTra AS NgayHenTra, ctpt.ngayTraThucTe AS NgayTraThucTe,
                    ISNULL(ctpt.TienPhatTraTre, 0) AS TienPhat,
                    pts.trangThai AS TrangThai
                FROM dbo.ChiTietPhieuThue ctpt
                JOIN dbo.PhieuThueSach pts ON ctpt.idPhieuThueSach = pts.idPhieuThueSach
                JOIN dbo.Sach s ON ctpt.idSach = s.idSach
                JOIN dbo.KhachHang kh ON pts.idKhachHang = kh.idKhachHang
                {whereSqlLichSu}
                ORDER BY pts.ngayThue DESC;";

            var dto = new SachRentalsDto
            {
                SachQuaHan = await _context.Database.SqlQueryRaw<BaoCaoSachTreHanDto>(sqlQuaHan).ToListAsync(),
                LichSuThue = await _context.Database.SqlQueryRaw<LichSuThueDto>(sqlLichSu, sqlParams.ToArray()).ToListAsync()
            };
            return Ok(dto);
        }

        // SỬA: CRUD Tác Giả (Thêm GioiThieu)
        [HttpPost("tacgia")]
        public async Task<IActionResult> CreateTacGia([FromBody] FilterLookupDto dto)
        {
            if (string.IsNullOrEmpty(dto.Ten)) return BadRequest("Tên không được rỗng.");
            var existing = await _context.TacGias.FirstOrDefaultAsync(t => t.TenTacGia.ToLower() == dto.Ten.ToLower());
            if (existing != null)
            {
                return Conflict("Tên tác giả đã tồn tại.");
            }
            var newEntity = new TacGia
            {
                TenTacGia = dto.Ten,
                GioiThieu = dto.MoTa // <-- SỬA
            };
            _context.TacGias.Add(newEntity);
            await _context.SaveChangesAsync();
            return Ok(new FilterLookupDto { Id = newEntity.IdTacGia, Ten = newEntity.TenTacGia, MoTa = newEntity.GioiThieu });
        }

        [HttpPut("tacgia/{id}")]
        public async Task<IActionResult> UpdateTacGia(int id, [FromBody] FilterLookupDto dto)
        {
            var entity = await _context.TacGias.FindAsync(id);
            if (entity == null) return NotFound();
            entity.TenTacGia = dto.Ten;
            entity.GioiThieu = dto.MoTa; // <-- SỬA
            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpDelete("tacgia/{id}")]
        public async Task<IActionResult> DeleteTacGia(int id)
        {
            // SỬA: Kiểm tra bảng nối
            if (await _context.SachTacGias.AnyAsync(s => s.IdTacGia == id))
            {
                return Conflict("Không thể xóa. Tác giả này đã được gán cho sách.");
            }
            var entity = await _context.TacGias.FindAsync(id);
            if (entity == null) return NotFound();
            _context.TacGias.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }

        // SỬA: CRUD Thể Loại (Thêm MoTa)
        [HttpPost("theloai")]
        public async Task<IActionResult> CreateTheLoai([FromBody] FilterLookupDto dto)
        {
            if (string.IsNullOrEmpty(dto.Ten)) return BadRequest("Tên không được rỗng.");
            var existing = await _context.TheLoais.FirstOrDefaultAsync(t => t.TenTheLoai.ToLower() == dto.Ten.ToLower());
            if (existing != null)
            {
                return Conflict("Tên thể loại đã tồn tại.");
            }

            var newEntity = new TheLoai
            {
                TenTheLoai = dto.Ten,
                MoTa = dto.MoTa // <-- SỬA
            };
            _context.TheLoais.Add(newEntity);
            await _context.SaveChangesAsync();
            return Ok(new FilterLookupDto { Id = newEntity.IdTheLoai, Ten = newEntity.TenTheLoai, MoTa = newEntity.MoTa });
        }

        [HttpPut("theloai/{id}")]
        public async Task<IActionResult> UpdateTheLoai(int id, [FromBody] FilterLookupDto dto)
        {
            var entity = await _context.TheLoais.FindAsync(id);
            if (entity == null) return NotFound();
            entity.TenTheLoai = dto.Ten;
            entity.MoTa = dto.MoTa; // <-- SỬA
            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpDelete("theloai/{id}")]
        public async Task<IActionResult> DeleteTheLoai(int id)
        {
            // SỬA: Kiểm tra bảng nối
            if (await _context.SachTheLoais.AnyAsync(s => s.IdTheLoai == id))
            {
                return Conflict("Không thể xóa. Thể loại này đã được gán cho sách.");
            }
            var entity = await _context.TheLoais.FindAsync(id);
            if (entity == null) return NotFound();
            _context.TheLoais.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }

        // SỬA: CRUD Nhà Xuất Bản (Thêm MoTa)
        [HttpPost("nhaxuatban")]
        public async Task<IActionResult> CreateNhaXuatBan([FromBody] FilterLookupDto dto)
        {
            if (string.IsNullOrEmpty(dto.Ten)) return BadRequest("Tên không được rỗng.");
            var existing = await _context.NhaXuatBans.FirstOrDefaultAsync(t => t.TenNhaXuatBan.ToLower() == dto.Ten.ToLower());
            if (existing != null)
            {
                return Conflict("Tên NXB đã tồn tại.");
            }

            var newEntity = new NhaXuatBan
            {
                TenNhaXuatBan = dto.Ten,
                MoTa = dto.MoTa // <-- SỬA
            };
            _context.NhaXuatBans.Add(newEntity);
            await _context.SaveChangesAsync();
            return Ok(new FilterLookupDto { Id = newEntity.IdNhaXuatBan, Ten = newEntity.TenNhaXuatBan, MoTa = newEntity.MoTa });
        }

        [HttpPut("nhaxuatban/{id}")]
        public async Task<IActionResult> UpdateNhaXuatBan(int id, [FromBody] FilterLookupDto dto)
        {
            var entity = await _context.NhaXuatBans.FindAsync(id);
            if (entity == null) return NotFound();
            entity.TenNhaXuatBan = dto.Ten;
            entity.MoTa = dto.MoTa; // <-- SỬA
            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpDelete("nhaxuatban/{id}")]
        public async Task<IActionResult> DeleteNhaXuatBan(int id)
        {
            // SỬA: Kiểm tra bảng nối
            if (await _context.SachNhaXuatBans.AnyAsync(s => s.IdNhaXuatBan == id))
            {
                return Conflict("Không thể xóa. NXB này đã được gán cho sách.");
            }
            var entity = await _context.NhaXuatBans.FindAsync(id);
            if (entity == null) return NotFound();
            _context.NhaXuatBans.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }

        #endregion
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\SanPhamController.cs
================================================================================
﻿// Tập tin: CafebookApi/Controllers/App/SanPhamController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using CafebookModel.Utils;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using Microsoft.AspNetCore.Http; // <-- Thêm

namespace CafebookApi.Controllers.App
{
    [Route("api/app/sanpham")]
    [ApiController]
    public class SanPhamController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private readonly IWebHostEnvironment _env;
        private readonly string _baseUrl;

        public SanPhamController(CafebookDbContext context, IWebHostEnvironment env, IConfiguration config)
        {
            _context = context;
            _env = env;

            if (string.IsNullOrEmpty(_env.WebRootPath))
            {
                _env.WebRootPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot");
                if (!Directory.Exists(_env.WebRootPath))
                {
                    Directory.CreateDirectory(_env.WebRootPath);
                }
            }

            _baseUrl = config.GetValue<string>("Kestrel:Endpoints:Http:Url") ?? "http://127.0.0.1:5166";
        }

        // === HELPER 1: TẠO URL TUYỆT ĐỐI === (Giữ nguyên)
        private string? GetFullImageUrl(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath))
                return null;
            return $"{_baseUrl}{relativePath.Replace(Path.DirectorySeparatorChar, '/')}";
        }

        // === HELPER 2: TẠO TÊN FILE === (Giữ nguyên)
        private string GenerateFileName(int id, string ten)
        {
            string slug = SlugifyUtil.GenerateSlug(ten);
            return $"{id}_{slug}.jpg"; // Luôn lưu là .jpg
        }

        // === HELPER 3: XÓA FILE CŨ === (Giữ nguyên)
        private void DeleteOldImage(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath)) return;
            var fileName = relativePath.TrimStart('/');
            var fullPath = Path.Combine(_env.WebRootPath, fileName.Replace('/', Path.DirectorySeparatorChar));
            if (System.IO.File.Exists(fullPath))
            {
                System.IO.File.Delete(fullPath);
            }
        }

        // === HELPER 4 (MỚI): ĐỔI TÊN FILE === (Giữ nguyên)
        private void RenameImage(string oldRelativePath, string newRelativePath)
        {
            if (string.IsNullOrEmpty(oldRelativePath) || string.IsNullOrEmpty(newRelativePath) || oldRelativePath == newRelativePath)
                return;

            var oldFileName = oldRelativePath.TrimStart('/');
            var oldFullPath = Path.Combine(_env.WebRootPath, oldFileName.Replace('/', Path.DirectorySeparatorChar));

            var newFileName = newRelativePath.TrimStart('/');
            var newFullPath = Path.Combine(_env.WebRootPath, newFileName.Replace('/', Path.DirectorySeparatorChar));

            if (System.IO.File.Exists(oldFullPath))
            {
                System.IO.File.Move(oldFullPath, newFullPath);
            }
        }

        // === HELPER 5 (SỬA): LƯU FILE TỪ IFormFile ===
        // (Đã xóa SaveImageFromBase64)
        private async Task<string> SaveImageFromFile(IFormFile file, string fileName, string relativeDir)
        {
            var saveDir = Path.Combine(_env.WebRootPath, relativeDir);
            if (!Directory.Exists(saveDir))
            {
                Directory.CreateDirectory(saveDir);
            }
            var fullSavePath = Path.Combine(saveDir, fileName);

            // Dùng stream để copy file
            await using (var stream = new FileStream(fullSavePath, FileMode.Create))
            {
                await file.CopyToAsync(stream);
            }

            return $"/{relativeDir.Replace(Path.DirectorySeparatorChar, '/')}/{fileName}";
        }

        #region API Sản Phẩm (Đã sửa)

        // ... (Hàm SearchSanPham, GetSanPhamDetails giữ nguyên) ...
        [HttpGet("search")]
        public async Task<IActionResult> SearchSanPham([FromQuery] string? searchText, [FromQuery] int? danhMucId, [FromQuery] bool? trangThai)
        {
            // ... (Logic không đổi)
            var query = _context.SanPhams.Include(s => s.DanhMuc).AsQueryable();

            if (danhMucId.HasValue && danhMucId > 0)
                query = query.Where(s => s.IdDanhMuc == danhMucId);
            if (trangThai.HasValue)
                query = query.Where(s => s.TrangThaiKinhDoanh == trangThai.Value);
            if (!string.IsNullOrEmpty(searchText))
            {
                string searchLower = searchText.ToLower();
                query = query.Where(s => s.TenSanPham.ToLower().Contains(searchLower));
            }

            var rawResults = await query.Select(s => new
            {
                s.IdSanPham,
                s.TenSanPham,
                s.GiaBan,
                TenDanhMuc = s.DanhMuc != null ? s.DanhMuc.TenDanhMuc : "N/A",
                s.TrangThaiKinhDoanh,
                s.HinhAnh
            })
            .OrderBy(s => s.TenSanPham)
            .ToListAsync();

            var results = rawResults.Select(s => new SanPhamDto
            {
                IdSanPham = s.IdSanPham,
                TenSanPham = s.TenSanPham,
                GiaBan = s.GiaBan,
                TenDanhMuc = s.TenDanhMuc,
                TrangThaiKinhDoanh = s.TrangThaiKinhDoanh,
                HinhAnhUrl = GetFullImageUrl(s.HinhAnh)
            }).ToList();

            return Ok(results);
        }

        [HttpGet("details/{id}")]
        public async Task<IActionResult> GetSanPhamDetails(int id)
        {
            // ... (Logic không đổi)
            var sp = await _context.SanPhams.FindAsync(id);
            if (sp == null) return NotFound();

            var dto = new SanPhamDetailDto
            {
                IdSanPham = sp.IdSanPham,
                TenSanPham = sp.TenSanPham,
                IdDanhMuc = sp.IdDanhMuc,
                GiaBan = sp.GiaBan,
                MoTa = sp.MoTa,
                TrangThaiKinhDoanh = sp.TrangThaiKinhDoanh,
                NhomIn = sp.NhomIn,
                HinhAnhUrl = GetFullImageUrl(sp.HinhAnh) // <-- Dùng Helper
            };
            return Ok(dto);
        }


        // SỬA: Dùng [FromForm]
        [HttpPost]
        public async Task<IActionResult> CreateSanPham(
                    [FromForm] SanPhamUpdateRequestDto dto)
        {
            if (await _context.SanPhams.AnyAsync(s => s.TenSanPham.ToLower() == dto.TenSanPham.ToLower() && s.IdDanhMuc == dto.IdDanhMuc))
            {
                return Conflict("Tên sản phẩm này đã tồn tại trong danh mục đã chọn.");
            }

            var sanPham = new SanPham
            {
                TenSanPham = dto.TenSanPham,
                IdDanhMuc = dto.IdDanhMuc ?? 0,
                GiaBan = dto.GiaBan,
                MoTa = dto.MoTa,
                TrangThaiKinhDoanh = dto.TrangThaiKinhDoanh,
                NhomIn = dto.NhomIn,
                HinhAnh = null
            };
            _context.SanPhams.Add(sanPham);
            await _context.SaveChangesAsync(); // Lưu lần 1 (Lấy ID)

            // SỬA: Lấy file từ dto.HinhAnhUpload
            if (dto.HinhAnhUpload != null)
            {
                try
                {
                    string fileName = GenerateFileName(sanPham.IdSanPham, sanPham.TenSanPham);
                    string relativePath = await SaveImageFromFile(dto.HinhAnhUpload, fileName, HinhAnhPaths.UrlFoods.TrimStart('/'));
                    sanPham.HinhAnh = relativePath;
                    await _context.SaveChangesAsync(); // Lưu lần 2 (Cập nhật ảnh)
                }
                catch (Exception ex)
                {
                    _context.SanPhams.Remove(sanPham);
                    await _context.SaveChangesAsync();
                    return StatusCode(500, $"Lỗi khi lưu ảnh: {ex.Message}");
                }
            }

            var detailDto = new SanPhamDetailDto
            {
                IdSanPham = sanPham.IdSanPham,
                TenSanPham = sanPham.TenSanPham,
                HinhAnhUrl = GetFullImageUrl(sanPham.HinhAnh)
            };

            return Ok(detailDto);
        }

        // SỬA: Dùng [FromForm]
        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateSanPham(int id,
                    [FromForm] SanPhamUpdateRequestDto dto)
        {
            var sp = await _context.SanPhams.FindAsync(id);
            if (sp == null) return NotFound();

            if (await _context.SanPhams.AnyAsync(s => s.TenSanPham.ToLower() == dto.TenSanPham.ToLower() && s.IdDanhMuc == dto.IdDanhMuc && s.IdSanPham != id))
            {
                return Conflict("Tên sản phẩm này đã tồn tại trong danh mục đã chọn.");
            }

            var oldImagePath = sp.HinhAnh;
            var oldTenSanPham = sp.TenSanPham;

            // SỬA: Lấy file và cờ Xóa từ DTO
            bool isImageUpload = dto.HinhAnhUpload != null;
            bool isNameChange = dto.TenSanPham != oldTenSanPham;

            sp.TenSanPham = dto.TenSanPham;
            sp.IdDanhMuc = dto.IdDanhMuc ?? 0;
            sp.GiaBan = dto.GiaBan;
            sp.MoTa = dto.MoTa;
            sp.TrangThaiKinhDoanh = dto.TrangThaiKinhDoanh;
            sp.NhomIn = dto.NhomIn;

            string newFileName = GenerateFileName(sp.IdSanPham, sp.TenSanPham);
            string newRelativePath = $"/{HinhAnhPaths.UrlFoods.TrimStart('/')}/{newFileName}";

            if (isImageUpload)
            {
                DeleteOldImage(oldImagePath);
                // === SỬA LỖI CS8604 (Dòng 258) ===
                // Thêm '!' vì logic 'isImageUpload' đã đảm bảo file không null
                sp.HinhAnh = await SaveImageFromFile(dto.HinhAnhUpload!, newFileName, HinhAnhPaths.UrlFoods.TrimStart('/'));
            }
            // SỬA: Lấy cờ Xóa từ DTO
            else if (dto.XoaHinhAnh)
            {
                DeleteOldImage(oldImagePath);
                sp.HinhAnh = null;
            }
            else if (isNameChange && !string.IsNullOrEmpty(oldImagePath))
            {
                RenameImage(oldImagePath, newRelativePath);
                sp.HinhAnh = newRelativePath;
            }

            await _context.SaveChangesAsync();
            return Ok();
        }

        // ... (DeleteSanPham giữ nguyên, logic DeleteOldImage đã có) ...
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteSanPham(int id)
        {
            if (await _context.ChiTietHoaDons.AnyAsync(ct => ct.IdSanPham == id))
            {
                return Conflict("Không thể xóa. Sản phẩm này đã tồn tại trong lịch sử hóa đơn.");
            }
            var sp = await _context.SanPhams.FindAsync(id);
            if (sp == null) return NotFound();

            DeleteOldImage(sp.HinhAnh); // <-- Logic xóa ảnh

            var dinhLuong = await _context.DinhLuongs.Where(d => d.IdSanPham == id).ToListAsync();
            if (dinhLuong.Any())
            {
                _context.DinhLuongs.RemoveRange(dinhLuong);
            }
            _context.SanPhams.Remove(sp);
            await _context.SaveChangesAsync();
            return Ok();
        }

        #endregion

        #region API Danh Mục
        [HttpGet("filters")] // <-- PHẢI LÀ [HttpGet]
        public async Task<IActionResult> GetSanPhamFilters()
        {
            var danhMucs = await _context.DanhMucs
                .Select(t => new FilterLookupDto { Id = t.IdDanhMuc, Ten = t.TenDanhMuc })
                .OrderBy(t => t.Ten)
                .ToListAsync();
            var nguyenLieus = (await _context.NguyenLieus
                .Select(nl => new { nl.IdNguyenLieu, nl.TenNguyenLieu, nl.DonViTinh })
                .ToListAsync())
                .Select(nl => new FilterLookupDto
                {
                    Id = nl.IdNguyenLieu,
                    Ten = nl.TenNguyenLieu + $" ({nl.DonViTinh})"
                })
                .OrderBy(nl => nl.Ten)
                .ToList();
            var donViTinhs = await _context.DonViChuyenDois
                .Select(d => new DonViChuyenDoiDto
                {
                    Id = d.IdChuyenDoi,
                    IdNguyenLieu = d.IdNguyenLieu,
                    Ten = d.TenDonVi
                })
                .ToListAsync();
            var dto = new SanPhamFiltersDto
            {
                DanhMucs = danhMucs,
                NguyenLieus = nguyenLieus,
                DonViTinhs = donViTinhs
            };
            return Ok(dto);
        }

        [HttpPost("danhmuc")]
        public async Task<IActionResult> CreateDanhMuc([FromBody] FilterLookupDto dto)
        {
            if (string.IsNullOrEmpty(dto.Ten)) return BadRequest("Tên không được rỗng.");
            var existing = await _context.DanhMucs.FirstOrDefaultAsync(t => t.TenDanhMuc.ToLower() == dto.Ten.ToLower());
            if (existing != null) return Conflict("Tên danh mục đã tồn tại.");
            var newEntity = new DanhMuc { TenDanhMuc = dto.Ten };
            _context.DanhMucs.Add(newEntity);
            await _context.SaveChangesAsync();
            return Ok(new FilterLookupDto { Id = newEntity.IdDanhMuc, Ten = newEntity.TenDanhMuc });
        }

        [HttpPut("danhmuc/{id}")]
        public async Task<IActionResult> UpdateDanhMuc(int id, [FromBody] FilterLookupDto dto)
        {
            var entity = await _context.DanhMucs.FindAsync(id);
            if (entity == null) return NotFound();
            entity.TenDanhMuc = dto.Ten;
            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpDelete("danhmuc/{id}")]
        public async Task<IActionResult> DeleteDanhMuc(int id)
        {
            if (await _context.SanPhams.AnyAsync(s => s.IdDanhMuc == id))
            {
                return Conflict("Không thể xóa. Danh mục này đã được gán cho sản phẩm.");
            }
            if (await _context.DanhMucs.AnyAsync(d => d.IdDanhMucCha == id))
            {
                return Conflict("Không thể xóa. Danh mục này đang là cha của danh mục khác.");
            }
            var entity = await _context.DanhMucs.FindAsync(id);
            if (entity == null) return NotFound();
            _context.DanhMucs.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }
        #endregion

        #region API Định Lượng
        [HttpGet("{idSanPham}/dinhluong")]
        public async Task<IActionResult> GetDinhLuong(int idSanPham)
        {
            var data = await _context.DinhLuongs
                .Where(d => d.IdSanPham == idSanPham)
                .Include(d => d.NguyenLieu)
                .Include(d => d.DonViSuDung)
                .Select(d => new DinhLuongDto
                {
                    IdNguyenLieu = d.IdNguyenLieu,
                    TenNguyenLieu = d.NguyenLieu.TenNguyenLieu,
                    SoLuong = d.SoLuongSuDung,
                    IdDonViSuDung = d.IdDonViSuDung,
                    TenDonViSuDung = d.DonViSuDung.TenDonVi
                })
                .ToListAsync();
            return Ok(data);
        }

        [HttpPost("dinhluong")]
        public async Task<IActionResult> UpdateDinhLuong([FromBody] DinhLuongUpdateRequestDto dto)
        {
            var existing = await _context.DinhLuongs.FindAsync(dto.IdSanPham, dto.IdNguyenLieu);
            if (existing != null)
            {
                existing.SoLuongSuDung = dto.SoLuong;
                existing.IdDonViSuDung = dto.IdDonViSuDung;
            }
            else
            {
                var newDinhLuong = new DinhLuong
                {
                    IdSanPham = dto.IdSanPham,
                    IdNguyenLieu = dto.IdNguyenLieu,
                    SoLuongSuDung = dto.SoLuong,
                    IdDonViSuDung = dto.IdDonViSuDung
                };
                _context.DinhLuongs.Add(newDinhLuong);
            }
            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpDelete("dinhluong/{idSanPham}/{idNguyenLieu}")]
        public async Task<IActionResult> DeleteDinhLuong(int idSanPham, int idNguyenLieu)
        {
            var existing = await _context.DinhLuongs.FindAsync(idSanPham, idNguyenLieu);
            if (existing != null)
            {
                _context.DinhLuongs.Remove(existing);
                await _context.SaveChangesAsync();
            }
            return Ok();
        }
        #endregion
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\TaiKhoanController.cs
================================================================================
﻿// Tập tin: CafebookApi/Controllers/App/TaiKhoanController.cs
using CafebookApi.Data;
using CafebookModel.Model.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApi;
using CafebookModel.Utils;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using System.IO;
using Microsoft.IdentityModel.Tokens;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;
using System;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/taikhoan")]
    [ApiController]
    public class TaiKhoanController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private readonly IWebHostEnvironment _env;
        private readonly string _baseUrl;
        private readonly IConfiguration _config;

        public TaiKhoanController(CafebookDbContext context, IWebHostEnvironment env, IConfiguration config)
        {
            _context = context;
            _env = env;
            _config = config;
            _baseUrl = _config["Jwt:Issuer"] ?? "http://127.0.0.1:5166";

            if (string.IsNullOrEmpty(_env.WebRootPath))
            {
                _env.WebRootPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot");
                if (!Directory.Exists(_env.WebRootPath))
                {
                    Directory.CreateDirectory(_env.WebRootPath);
                }
            }
        }

        [ApiExplorerSettings(IgnoreApi = true)]
        private string? GetFullImageUrl(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath))
                return null;
            return $"{_baseUrl}{relativePath.Replace(Path.DirectorySeparatorChar, '/')}";
        }


        [HttpPost("login")]
        public async Task<IActionResult> Login([FromBody] LoginRequestModel model)
        {
            var userInput = model.TenDangNhap.Trim();
            var passInput = model.MatKhau.Trim();

            var nhanVien = await _context.NhanViens
              .Include(nv => nv.VaiTro)
                .ThenInclude(vt => vt.VaiTroQuyens)
                .ThenInclude(vtq => vtq.Quyen)
              .FirstOrDefaultAsync(nv =>
                (nv.TenDangNhap == userInput || nv.SoDienThoai == userInput || nv.Email == userInput) &&
                (nv.MatKhau == passInput)
              );

            if (nhanVien == null)
            {
                return Ok(new LoginResponseModel { Success = false, Message = "Sai tên đăng nhập hoặc mật khẩu." });
            }

            if (nhanVien.VaiTro == null)
            {
                return Ok(new LoginResponseModel { Success = false, Message = "Tài khoản không có vai trò." });
            }

            var userDto = new NhanVienDto
            {
                IdNhanVien = nhanVien.IdNhanVien,
                HoTen = nhanVien.HoTen,
                AnhDaiDien = GetFullImageUrl(nhanVien.AnhDaiDien),
                // Sửa cảnh báo CS8602 (bằng cách kiểm tra null ở trên)
                TenVaiTro = nhanVien.VaiTro.TenVaiTro,
                DanhSachQuyen = nhanVien.VaiTro.VaiTroQuyens
                  .Select(vtq => vtq.IdQuyen)
                  .ToList()
            };

            // SỬA LỖI CS1503 (Lỗi dây chuyền):
            string token = GenerateJwtToken(nhanVien);

            return Ok(new LoginResponseModel
            {
                Success = true,
                Message = "Đăng nhập thành công!",
                Token = token,
                UserData = userDto
            });
        }

        [ApiExplorerSettings(IgnoreApi = true)]
        // SỬA LỖI CS0118: Ghi rõ đầy đủ (fully qualify) tên class
        private string GenerateJwtToken(CafebookModel.Model.Entities.NhanVien nhanVien)
        {
            var tokenHandler = new JwtSecurityTokenHandler();
            var key = Encoding.ASCII.GetBytes(_config["Jwt:Key"]!);

            var claims = new List<Claim>
            {
                new Claim("IdNhanVien", nhanVien.IdNhanVien.ToString()),
                new Claim(JwtRegisteredClaimNames.Name, nhanVien.HoTen),
                new Claim(JwtRegisteredClaimNames.Email, nhanVien.Email ?? ""),
                new Claim(JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString())
            };

            var tokenDescriptor = new SecurityTokenDescriptor
            {
                Subject = new ClaimsIdentity(claims),
                Expires = DateTime.UtcNow.AddDays(7),
                // Lỗi CS1503 (BinaryReader) tự biến mất khi sửa lỗi CS0118
                Issuer = _config["Jwt:Issuer"],
                Audience = _config["Jwt:Audience"],
                SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Signature)
            };

            var token = tokenHandler.CreateToken(tokenDescriptor);
            return tokenHandler.WriteToken(token);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\ThongBaoController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/thongbao")]
    [ApiController]
    public class ThongBaoController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public ThongBaoController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API đếm số thông báo chưa đọc
        /// </summary>
        [HttpGet("unread-count")]
        public async Task<IActionResult> GetUnreadCount()
        {
            var count = await _context.ThongBaos.CountAsync(t => !t.DaXem);
            return Ok(new ThongBaoCountDto { UnreadCount = count });
        }

        /// <summary>
        /// API lấy tất cả thông báo (mới nhất trước)
        /// </summary>
        [HttpGet("all")]
        public async Task<IActionResult> GetAllNotifications()
        {
            var notifications = await _context.ThongBaos
                .Include(t => t.NhanVienTao) // Join để lấy tên NV
                .OrderByDescending(t => t.ThoiGianTao)
                .Take(20) // Chỉ lấy 20 thông báo mới nhất
                .Select(t => new ThongBaoDto
                {
                    IdThongBao = t.IdThongBao,
                    NoiDung = t.NoiDung,
                    ThoiGianTao = t.ThoiGianTao,
                    LoaiThongBao = t.LoaiThongBao,
                    IdLienQuan = t.IdLienQuan,
                    DaXem = t.DaXem,
                    TenNhanVienTao = t.NhanVienTao != null ? t.NhanVienTao.HoTen : "Hệ thống"
                })
                .ToListAsync();

            return Ok(notifications);
        }

        /// <summary>
        /// API đánh dấu 1 thông báo là đã đọc
        /// </summary>
        [HttpPost("mark-as-read/{id}")]
        public async Task<IActionResult> MarkAsRead(int id)
        {
            var thongBao = await _context.ThongBaos.FindAsync(id);
            if (thongBao == null) return NotFound();

            if (!thongBao.DaXem)
            {
                thongBao.DaXem = true;
                await _context.SaveChangesAsync();
            }
            return Ok();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\ThuongPhatController.cs
================================================================================
﻿// Tệp: CafebookApi/Controllers/App/ThuongPhatController.cs
// (*** THAY THẾ TOÀN BỘ TỆP NÀY ***)

using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/thuongphat")]
    [ApiController]
    public class ThuongPhatController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public ThuongPhatController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API Lấy danh sách Thưởng/Phạt (chưa chốt lương)
        /// </summary>
        [HttpGet("pending/{idNhanVien}")]
        public async Task<IActionResult> GetPending(int idNhanVien)
        {
            // *** SỬA LỖI: Dùng Select thủ công thay vì Include ***
            var data = await _context.PhieuThuongPhats
                .Where(p => p.IdNhanVien == idNhanVien && p.IdPhieuLuong == null) // Chỉ lấy phiếu chưa chốt
                .OrderByDescending(p => p.NgayTao)
                .Select(p => new PhieuThuongPhatDto
                {
                    IdPhieuThuongPhat = p.IdPhieuThuongPhat,
                    IdNhanVien = p.IdNhanVien,
                    // Dùng truy vấn con (subquery)
                    HoTenNhanVien = _context.NhanViens.Where(nv => nv.IdNhanVien == p.IdNhanVien).Select(nv => nv.HoTen).FirstOrDefault() ?? "N/A",
                    NgayTao = p.NgayTao,
                    SoTien = p.SoTien,
                    LyDo = p.LyDo,
                    // Dùng truy vấn con (subquery)
                    TenNguoiTao = _context.NhanViens.Where(nv => nv.IdNhanVien == p.IdNguoiTao).Select(nv => nv.HoTen).FirstOrDefault() ?? "N/A"
                })
                .ToListAsync();
            // *** KẾT THÚC SỬA LỖI ***

            return Ok(data);
        }

        /// <summary>
        /// API Thêm mới Thưởng/Phạt
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> Create([FromBody] PhieuThuongPhatCreateDto dto)
        {
            var entity = new PhieuThuongPhat
            {
                IdNhanVien = dto.IdNhanVien,
                IdNguoiTao = dto.IdNguoiTao,
                NgayTao = DateTime.Now,
                SoTien = dto.SoTien,
                LyDo = dto.LyDo,
                IdPhieuLuong = null // Chưa chốt
            };

            _context.PhieuThuongPhats.Add(entity);
            await _context.SaveChangesAsync();
            return Ok(entity);
        }

        /// <summary>
        /// API Xóa Thưởng/Phạt (chỉ khi chưa chốt)
        /// </summary>
        [HttpDelete("{id}")]
        public async Task<IActionResult> Delete(int id)
        {
            var entity = await _context.PhieuThuongPhats.FindAsync(id);
            if (entity == null) return NotFound();

            if (entity.IdPhieuLuong != null)
            {
                return Conflict("Không thể xóa. Khoản này đã được chốt trong phiếu lương.");
            }

            _context.PhieuThuongPhats.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\VaiTroController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/vaitro")]
    [ApiController]
    public class VaiTroController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public VaiTroController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API Lấy tất cả Vai Trò
        /// </summary>
        [HttpGet("all")]
        public async Task<IActionResult> GetAll()
        {
            var data = await _context.VaiTros
                .Select(v => new VaiTroDto
                {
                    IdVaiTro = v.IdVaiTro,
                    TenVaiTro = v.TenVaiTro,
                    MoTa = v.MoTa
                })
                .OrderBy(v => v.TenVaiTro)
                .ToListAsync();
            return Ok(data);
        }

        /// <summary>
        /// API Thêm mới Vai Trò
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> Create([FromBody] VaiTroDto dto)
        {
            if (await _context.VaiTros.AnyAsync(v => v.TenVaiTro.ToLower() == dto.TenVaiTro.ToLower()))
            {
                return Conflict("Tên vai trò đã tồn tại.");
            }
            var entity = new VaiTro
            {
                TenVaiTro = dto.TenVaiTro,
                MoTa = dto.MoTa
            };
            _context.VaiTros.Add(entity);
            await _context.SaveChangesAsync();
            return Ok(entity);
        }

        /// <summary>
        /// API Cập nhật Vai Trò
        /// </summary>
        [HttpPut("{id}")]
        public async Task<IActionResult> Update(int id, [FromBody] VaiTroDto dto)
        {
            var entity = await _context.VaiTros.FindAsync(id);
            if (entity == null) return NotFound();

            if (await _context.VaiTros.AnyAsync(v => v.TenVaiTro.ToLower() == dto.TenVaiTro.ToLower() && v.IdVaiTro != id))
            {
                return Conflict("Tên vai trò đã tồn tại.");
            }

            entity.TenVaiTro = dto.TenVaiTro;
            entity.MoTa = dto.MoTa;
            await _context.SaveChangesAsync();
            return Ok();
        }

        /// <summary>
        /// API Xóa Vai Trò
        /// </summary>
        [HttpDelete("{id}")]
        public async Task<IActionResult> Delete(int id)
        {
            if (await _context.NhanViens.AnyAsync(nv => nv.IdVaiTro == id))
            {
                return Conflict("Không thể xóa. Vai trò này đang được gán cho nhân viên.");
            }

            var entity = await _context.VaiTros.FindAsync(id);
            if (entity == null) return NotFound();

            _context.VaiTros.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\NhanVien\ChamCongController.cs
================================================================================
﻿// Tệp: CafebookApi/Controllers/App/NhanVien/ChamCongController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp.NhanVien;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore; // Đảm bảo có using này
using System;
using System.Linq;
using System.Security.Claims;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App.NhanVien
{
    [Route("api/app/chamcong")]
    [ApiController]
    [Authorize]
    public class ChamCongController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public ChamCongController(CafebookDbContext context)
        {
            _context = context;
        }

        [HttpGet("status")]
        public async Task<IActionResult> GetChamCongStatus()
        {
            try
            {
                int idNhanVien = GetCurrentUserId();
                if (idNhanVien == 0) return Unauthorized("Token không hợp lệ hoặc thiếu IdNhanVien.");

                var dto = await GetDashboardDto(idNhanVien);
                return Ok(dto);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[GetChamCongStatus Error]: {ex.Message}\n{ex.StackTrace}");
                return StatusCode(500, $"Lỗi máy chủ: {ex.Message}");
            }
        }

        [HttpPost("clock-in")]
        public async Task<IActionResult> ClockIn()
        {
            int idNhanVien = GetCurrentUserId();
            var homNay = DateTime.Today;

            var lichLamViec = await _context.LichLamViecs
                .FirstOrDefaultAsync(l => l.IdNhanVien == idNhanVien && l.NgayLam == homNay);

            if (lichLamViec == null)
            {
                return BadRequest("Bạn không có ca làm việc được đăng ký hôm nay.");
            }

            var donNghi = await _context.DonXinNghis.AsNoTracking()
                .FirstOrDefaultAsync(d => d.IdNhanVien == idNhanVien &&
                                          d.TrangThai == "Đã duyệt" &&
                                          d.NgayBatDau.Date <= homNay &&
                                          d.NgayKetThuc.Date >= homNay);
            if (donNghi != null)
            {
                return BadRequest("Bạn không thể chấm công. Đơn xin nghỉ của bạn đã được duyệt hôm nay.");
            }

            var chamCongHienTai = await _context.BangChamCongs
                .FirstOrDefaultAsync(c => c.IdLichLamViec == lichLamViec.IdLichLamViec);

            if (chamCongHienTai != null && chamCongHienTai.GioVao != null)
            {
                return BadRequest("Bạn đã chấm công vào ca này rồi.");
            }

            if (chamCongHienTai == null)
            {
                chamCongHienTai = new BangChamCong
                {
                    IdLichLamViec = lichLamViec.IdLichLamViec,
                    GioVao = DateTime.Now
                };
                _context.BangChamCongs.Add(chamCongHienTai);
            }
            else
            {
                chamCongHienTai.GioVao = DateTime.Now;
            }

            await _context.SaveChangesAsync();

            var dto = await GetDashboardDto(idNhanVien);
            return Ok(dto);
        }

        [HttpPost("clock-out")]
        public async Task<IActionResult> ClockOut()
        {
            int idNhanVien = GetCurrentUserId();
            var homNay = DateTime.Today;

            var chamCong = await _context.BangChamCongs
                .Include(c => c.LichLamViec)
                .FirstOrDefaultAsync(c =>
                    c.LichLamViec != null &&
                    c.LichLamViec.IdNhanVien == idNhanVien &&
                    c.LichLamViec.NgayLam == homNay &&
                    c.GioVao != null &&
                    c.GioRa == null);

            if (chamCong == null)
            {
                return BadRequest("Bạn chưa chấm công vào hoặc đã trả ca rồi.");
            }

            chamCong.GioRa = DateTime.Now;
            await _context.SaveChangesAsync();
            await _context.Entry(chamCong).ReloadAsync();

            var dto = await GetDashboardDto(idNhanVien);
            return Ok(dto);
        }

        [HttpGet("lich-su")]
        public async Task<IActionResult> GetLichSuChamCong([FromQuery] int thang, [FromQuery] int nam)
        {
            int idNhanVien = GetCurrentUserId();
            var ngayDauThang = new DateTime(nam, thang, 1);
            var ngayCuoiThang = ngayDauThang.AddMonths(1).AddDays(-1);

            // 1. Lấy lịch sử chấm công (Đã sửa Include)
            var lichSu = await _context.BangChamCongs
                .Include(c => c.LichLamViec)
                    .ThenInclude(l => l.CaLamViec)
                .Where(c => c.LichLamViec != null &&
                            c.LichLamViec.IdNhanVien == idNhanVien &&
                            c.LichLamViec.NgayLam >= ngayDauThang &&
                            c.LichLamViec.NgayLam <= ngayCuoiThang)
                .OrderBy(c => c.LichLamViec.NgayLam)
                .AsNoTracking()
                .ToListAsync();

            var lichSuDto = lichSu.Select(c =>
            {
                var thoiGianTre = (c.GioVao.HasValue && c.LichLamViec!.CaLamViec != null && c.GioVao.Value.TimeOfDay > c.LichLamViec.CaLamViec.GioBatDau)
                    ? c.GioVao.Value.TimeOfDay - c.LichLamViec.CaLamViec.GioBatDau
                    : TimeSpan.Zero;

                return new LichSuItemDto
                {
                    Ngay = c.LichLamViec!.NgayLam.ToString("dd/MM (ddd)"),
                    CaLamViec = c.LichLamViec.CaLamViec?.TenCa ?? "N/A",
                    GioVao = c.GioVao?.ToString("HH:mm") ?? "--",
                    GioRa = c.GioRa?.ToString("HH:mm") ?? "--",
                    DiTre = (thoiGianTre.TotalMinutes > 5) ? $"{thoiGianTre.TotalMinutes:N0} phút" : "",
                    SoGioLam = c.SoGioLam ?? 0
                };
            }).ToList();

            // 2. Lấy đơn xin nghỉ
            var donNghi = await _context.DonXinNghis
                .Where(d => d.IdNhanVien == idNhanVien &&
                            (d.NgayBatDau.Month == thang && d.NgayBatDau.Year == nam))
                .OrderByDescending(d => d.NgayBatDau)
                .AsNoTracking()
                .ToListAsync();

            var donNghiDto = donNghi.Select(d => new DonNghiItemDto
            {
                IdDonXinNghi = d.IdDonXinNghi,
                LoaiDon = d.LoaiDon,
                ThoiGian = $"{d.NgayBatDau:dd/MM} - {d.NgayKetThuc:dd/MM}",
                LyDo = d.LyDo,
                TrangThai = d.TrangThai,
                PheDuyet = d.GhiChuPheDuyet
            }).ToList();

            // 3. Thống kê
            int soNgayNghiPhep = await _context.DonXinNghis
                .Where(d => d.IdNhanVien == idNhanVien &&
                            d.TrangThai == "Đã duyệt" &&
                            d.NgayBatDau.Month == thang && d.NgayBatDau.Year == nam)
                .CountAsync();

            var thongKe = new ThongKeChamCongDto
            {
                TongGioLam = lichSuDto.Sum(l => l.SoGioLam),
                SoLanDiTre = lichSuDto.Count(l => !string.IsNullOrEmpty(l.DiTre)),
                SoNgayNghiPhep = soNgayNghiPhep
            };

            return Ok(new LichSuChamCongPageDto
            {
                LichSuChamCong = lichSuDto,
                DanhSachDonNghi = donNghiDto,
                ThongKe = thongKe
            });
        }

        [HttpPost("submit-leave")]
        public async Task<IActionResult> SubmitLeaveRequest([FromBody] DonXinNghiRequestDto req)
        {
            if (req.NgayKetThuc < req.NgayBatDau)
                return BadRequest("Ngày kết thúc không thể trước ngày bắt đầu.");

            var idNhanVien = GetCurrentUserId();
            var nhanVien = await _context.NhanViens
                .AsNoTracking()
                .Select(nv => new { nv.IdNhanVien, nv.HoTen })
                .FirstOrDefaultAsync(nv => nv.IdNhanVien == idNhanVien);

            if (nhanVien == null)
            {
                return NotFound("Không tìm thấy nhân viên.");
            }

            var don = new DonXinNghi
            {
                IdNhanVien = idNhanVien,
                LoaiDon = req.LoaiDon,
                LyDo = req.LyDo,
                NgayBatDau = req.NgayBatDau,
                NgayKetThuc = req.NgayKetThuc,
                TrangThai = "Chờ duyệt",
            };

            _context.DonXinNghis.Add(don);
            await _context.SaveChangesAsync();

            var thongBao = new ThongBao
            {
                IdNhanVienTao = idNhanVien,
                NoiDung = $"Đơn nghỉ mới từ {nhanVien.HoTen}",
                ThoiGianTao = DateTime.Now,
                LoaiThongBao = "DonXinNghi",
                IdLienQuan = don.IdDonXinNghi,
                DaXem = false
            };

            _context.ThongBaos.Add(thongBao);
            await _context.SaveChangesAsync();

            return Ok(new { message = "Gửi đơn xin nghỉ và tạo thông báo thành công!" });
        }

        // === HÀM HELPER ===
        private int GetCurrentUserId()
        {
            // Lấy đúng Claim "IdNhanVien"
            var idClaim = User.Claims.FirstOrDefault(c => c.Type == "IdNhanVien");

            if (idClaim != null && int.TryParse(idClaim.Value, out int idNhanVien))
            {
                return idNhanVien;
            }
            return 0;
        }

        private async Task<ChamCongDashboardDto> GetDashboardDto(int idNhanVien)
        {
            var homNay = DateTime.Today;
            var dauThangNay = new DateTime(homNay.Year, homNay.Month, 1);
            var nhanVien = await _context.NhanViens.FindAsync(idNhanVien);

            var dto = new ChamCongDashboardDto
            {
                TenNhanVien = nhanVien?.HoTen ?? "N/A"
            };

            // 1. Kiểm tra đơn xin nghỉ
            var donNghi = await _context.DonXinNghis.AsNoTracking()
                .FirstOrDefaultAsync(d => d.IdNhanVien == idNhanVien &&
                                          d.NgayBatDau.Date <= homNay &&
                                          d.NgayKetThuc.Date >= homNay);
            if (donNghi != null)
            {
                dto.TrangThaiDonNghi = donNghi.TrangThai;
                if (donNghi.TrangThai == "Đã duyệt")
                {
                    dto.TrangThai = "NghiPhep";
                    dto.TenCa = "Nghỉ phép";
                }
            }

            // 2. Kiểm tra lịch làm (chỉ khi không nghỉ phép)
            if (dto.TrangThai != "NghiPhep")
            {
                var lichLamViec = await _context.LichLamViecs
                    .Include(l => l.CaLamViec)
                    .AsNoTracking()
                    .FirstOrDefaultAsync(l => l.IdNhanVien == idNhanVien && l.NgayLam == homNay);

                if (lichLamViec == null)
                {
                    dto.TrangThai = "KhongCoCa";
                    dto.TenCa = "Không có lịch làm";
                }
                else
                {
                    if (lichLamViec.CaLamViec == null)
                    {
                        dto.TrangThai = "KhongCoCa";
                        dto.TenCa = "Lỗi: Ca làm việc không hợp lệ";
                    }
                    else
                    {
                        dto.TenCa = lichLamViec.CaLamViec.TenCa;
                        dto.GioBatDauCa = lichLamViec.CaLamViec.GioBatDau;
                        dto.GioKetThucCa = lichLamViec.CaLamViec.GioKetThuc;

                        var chamCong = await _context.BangChamCongs
                            .AsNoTracking()
                            .FirstOrDefaultAsync(c => c.IdLichLamViec == lichLamViec.IdLichLamViec);

                        if (chamCong == null || chamCong.GioVao == null)
                        {
                            dto.TrangThai = "ChuaChamCong";
                        }
                        else if (chamCong.GioRa == null)
                        {
                            dto.TrangThai = "DaChamCong";
                            dto.GioVao = chamCong.GioVao;
                        }
                        else
                        {
                            dto.TrangThai = "DaTraCa";
                            dto.GioVao = chamCong.GioVao;
                            dto.GioRa = chamCong.GioRa;
                            dto.SoGioLam = chamCong.SoGioLam;
                        }
                    }
                }
            }

            // 4. Tính số lần đi trễ
            // *** SỬA LỖI: Dùng EF.Functions.DateDiffMinute ***
            int soPhutTreChoPhep = 5;
            var soLanDiTre = await _context.BangChamCongs
                .Include(c => c.LichLamViec)
                    .ThenInclude(l => l.CaLamViec)
                .AsNoTracking()
                .CountAsync(c =>
                    c.LichLamViec != null &&
                    c.LichLamViec.IdNhanVien == idNhanVien &&
                    c.LichLamViec.NgayLam >= dauThangNay &&
                    c.LichLamViec.NgayLam <= homNay &&
                    c.GioVao != null &&
                    c.LichLamViec.CaLamViec != null &&
                    // Sử dụng DateDiffMinute để EF Core dịch sang SQL
                    EF.Functions.DateDiffMinute(c.LichLamViec.CaLamViec.GioBatDau, c.GioVao.Value.TimeOfDay) > soPhutTreChoPhep
                );

            dto.SoLanDiTreThangNay = soLanDiTre;

            return dto;
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\NhanVien\CheBienController.cs
================================================================================
﻿// Tệp: CafebookApi/Controllers/App/NhanVien/CheBienController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelApp.NhanVien;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App.NhanVien
{
    [Route("api/app/nhanvien/chebien")]
    [ApiController]
    public class CheBienController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        public CheBienController(CafebookDbContext context)
        {
            _context = context;
        }

        // ... (Hàm LoadCheBienItems và StartItem giữ nguyên) ...
        [HttpGet("load")]
        public async Task<IActionResult> LoadCheBienItems()
        {
            var items = await _context.TrangThaiCheBiens
                .Where(cb => cb.TrangThai == "Chờ làm" || cb.TrangThai == "Đang làm")
                .OrderBy(cb => cb.ThoiGianGoi)
                .Select(cb => new CheBienItemDto
                {
                    IdTrangThaiCheBien = cb.IdTrangThaiCheBien,
                    IdSanPham = cb.IdSanPham,
                    TenMon = cb.TenMon,
                    SoLuong = cb.SoLuong,
                    SoBan = cb.SoBan,
                    GhiChu = cb.GhiChu,
                    TrangThai = cb.TrangThai,
                    ThoiGianGoi = cb.ThoiGianGoi,
                    NhomIn = cb.NhomIn ?? "Bếp"
                })
                 .ToListAsync();

            return Ok(items);
        }

        [HttpPost("start/{idTrangThaiCheBien}")]
        public async Task<IActionResult> StartItem(int idTrangThaiCheBien)
        {
            var item = await _context.TrangThaiCheBiens.FindAsync(idTrangThaiCheBien);
            if (item == null) return NotFound("Không tìm thấy món.");

            if (item.TrangThai == "Chờ làm")
            {
                item.TrangThai = "Đang làm";
                item.ThoiGianBatDau = DateTime.Now;
                await _context.SaveChangesAsync();
                return Ok(new { message = "Đã bắt đầu làm món." });
            }
            return Conflict("Món đã được làm hoặc đã hoàn thành.");
        }

        /// <summary>
        /// Hoàn thành chế biến một món (ĐÃ NÂNG CẤP)
        /// </summary>
        [HttpPost("complete/{idTrangThaiCheBien}")]
        public async Task<IActionResult> CompleteItem(int idTrangThaiCheBien)
        {
            var item = await _context.TrangThaiCheBiens.FindAsync(idTrangThaiCheBien);
            if (item == null) return NotFound("Không tìm thấy món.");

            if (item.TrangThai == "Đang làm")
            {
                item.TrangThai = "Hoàn thành";
                item.ThoiGianHoanThanh = DateTime.Now;
                await _context.SaveChangesAsync();

                // =======================================
                // === CẬP NHẬT TRẠNG THÁI GIAO HÀNG ===
                // =======================================
                await UpdateGiaoHangStatusIfCompleted(item.IdHoaDon);

                return Ok(new { message = "Đã hoàn thành món." });
            }
            return Conflict("Món này chưa được bắt đầu làm.");
        }

        // =======================================
        // === HÀM HELPER (ĐÃ SỬA THEO YÊU CẦU 1) ===
        // =======================================
        private async Task UpdateGiaoHangStatusIfCompleted(int idHoaDon)
        {
            try
            {
                // 1. Kiểm tra xem còn món nào CHƯA hoàn thành không
                bool allDone = !await _context.TrangThaiCheBiens
                    .AnyAsync(cb => cb.IdHoaDon == idHoaDon && cb.TrangThai != "Hoàn thành");

                if (allDone)
                {
                    var hoaDon = await _context.HoaDons.FindAsync(idHoaDon);

                    // 2. Chỉ cập nhật nếu là đơn "Giao hàng" VÀ đang ở "Đang chuẩn bị"
                    if (hoaDon != null &&
                        hoaDon.LoaiHoaDon == "Giao hàng" &&
                        hoaDon.TrangThaiGiaoHang == "Đang chuẩn bị")
                    {
                        // SỬA: Chuyển thành "Chờ lấy hàng"
                        hoaDon.TrangThaiGiaoHang = "Chờ lấy hàng";
                        await _context.SaveChangesAsync();
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[UpdateGiaoHangStatusIfCompleted Error]: {ex.Message}");
            }
        }

        /// <summary>
        /// Lấy công thức cho một món ăn (Giữ nguyên)
        /// </summary>
        [HttpGet("congthuc/{idSanPham}")]
        public async Task<IActionResult> GetCongThuc(int idSanPham)
        {
            var items = await _context.DinhLuongs
                .Where(d => d.IdSanPham == idSanPham)
                 .Include(d => d.NguyenLieu)
                 .Include(d => d.DonViSuDung)
                 .Select(d => new CongThucItemDto
                 {
                     TenNguyenLieu = d.NguyenLieu.TenNguyenLieu,
                     SoLuongSuDung = d.SoLuongSuDung,
                     TenDonVi = d.DonViSuDung.TenDonVi
                 })
                .ToListAsync();
            return Ok(items);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\NhanVien\DatBanController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp.NhanVien.DatBan;
using MailKit.Net.Smtp;
using MailKit.Security;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using MimeKit;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using Microsoft.Data.SqlClient;
using System.Net.Http; // <-- THÊM MỚI

namespace AppCafebookApi.Controllers.app.NhanVien
{
    [Route("api/app/datban")]
    [ApiController]
    public class DatBanController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private readonly IConfiguration _config;
        private readonly IHttpClientFactory _clientFactory; // <-- THÊM MỚI

        private const int ReservationSlotHours = 2;
        private const int ReservationBufferMinutes = 5;

        private class OpeningHours
        {
            public TimeSpan Open { get; set; } = new TimeSpan(6, 0, 0);
            public TimeSpan Close { get; set; } = new TimeSpan(23, 0, 0);
            public bool IsValid { get; set; } = false;
        }

        // SỬA HÀM KHỞI TẠO
        public DatBanController(CafebookDbContext context, IConfiguration config, IHttpClientFactory clientFactory)
        {
            _context = context;
            _config = config;
            _clientFactory = clientFactory; // <-- THÊM MỚI
        }

        // *** SỬA: XÓA HOÀN TOÀN HÀM AutoCancelLateReservationsAsync() KHỎI ĐÂY ***

        #region GET Endpoints
        [HttpGet("list")]
        public async Task<ActionResult<IEnumerable<PhieuDatBanDto>>> GetDatBanList()
        {
            // === SỬA: GỌI API DỌN DẸP TRƯỚC KHI TẢI LIST ===
            try
            {
                var client = _clientFactory.CreateClient();
                var request = new HttpRequestMessage(HttpMethod.Post, "http://localhost:5166/api/app/background/auto-cancel-late");
                await client.SendAsync(request);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Loi khi goi auto-cancel API: {ex.Message}");
            }
            // === KẾT THÚC SỬA ===

            var list = await _context.PhieuDatBans
                .Include(p => p.KhachHang)
                .Include(p => p.Ban).ThenInclude(b => b.KhuVuc)
                .OrderByDescending(p => p.ThoiGianDat)
                .Select(p => new PhieuDatBanDto
                {
                    IdPhieuDatBan = p.IdPhieuDatBan,
                    TenKhachHang = p.KhachHang != null ? p.KhachHang.HoTen : p.HoTenKhach,
                    SoDienThoai = p.KhachHang != null ? p.KhachHang.SoDienThoai : p.SdtKhach,
                    Email = p.KhachHang != null ? p.KhachHang.Email : null,
                    IdBan = p.IdBan,
                    SoBan = p.Ban.SoBan,
                    TenKhuVuc = p.Ban.KhuVuc != null ? p.Ban.KhuVuc.TenKhuVuc : "N/A",
                    ThoiGianDat = p.ThoiGianDat,
                    SoLuongKhach = p.SoLuongKhach,
                    TrangThai = p.TrangThai,
                    GhiChu = p.GhiChu,
                    IdKhachHang = p.IdKhachHang
                }).ToListAsync();
            return Ok(list);
        }

        [HttpGet("available-bans")]
        public async Task<ActionResult<IEnumerable<BanDatBanDto>>> GetAvailableBans()
        {
            var bans = await _context.Bans
                .Include(b => b.KhuVuc)
                .Where(b => b.TrangThai == "Trống" || b.TrangThai == "Đã đặt")
                .Select(b => new BanDatBanDto
                {
                    IdBan = b.IdBan,
                    SoBan = b.SoBan,
                    TenKhuVuc = b.KhuVuc != null ? b.KhuVuc.TenKhuVuc : "N/A",
                    SoGhe = b.SoGhe,
                    IdKhuVuc = b.IdKhuVuc
                }).ToListAsync();
            return Ok(bans);
        }

        [HttpGet("search-customer")]
        public async Task<ActionResult<IEnumerable<KhachHangLookupDto>>> SearchCustomer([FromQuery] string query)
        {
            // SỬA DÒNG NÀY:
            if (string.IsNullOrEmpty(query)) //
            // THAY VÌ DÒNG CŨ: if (string.IsNullOrEmpty(query) || query.Length < 3)
            {
                return Ok(new List<KhachHangLookupDto>());
            }
            var queryLower = query.ToLower(); // Sửa: Thêm .ToLower()
            var results = await _context.KhachHangs
                .Where(kh => (kh.SoDienThoai != null && kh.SoDienThoai.Contains(query)) ||
                             (kh.Email != null && kh.Email.ToLower().Contains(queryLower)) || // Sửa: Thêm .ToLower()
                             kh.HoTen.ToLower().Contains(queryLower)) // Sửa: Thêm .ToLower()
                .Select(kh => new KhachHangLookupDto
                {
                    IdKhachHang = kh.IdKhachHang,
                    HoTen = kh.HoTen,
                    SoDienThoai = kh.SoDienThoai ?? "",
                    Email = kh.Email
                })
                .Take(10).ToListAsync();
            return Ok(results);
        }

        [HttpGet("opening-hours")]
        public async Task<ActionResult<string>> GetOpeningHours()
        {
            var setting = await _context.CaiDats
                .FirstOrDefaultAsync(cd => cd.TenCaiDat == "LienHe_GioMoCua");
            if (setting == null || string.IsNullOrEmpty(setting.GiaTri))
            {
                return Ok("06:00 - 23:00");
            }
            var match = Regex.Match(setting.GiaTri, @"(\d{2}:\d{2})\s*-\s*(\d{2}:\d{2})");
            if (match.Success)
            {
                return Ok(match.Value);
            }
            return Ok("06:00 - 23:00");
        }
        #endregion

        #region POST/PUT Endpoints (Logic chính)

        [HttpPost("create-staff")]
        public async Task<IActionResult> CreateDatBanStaff(PhieuDatBanCreateUpdateDto dto)
        {
            KhachHang khachHang = null;

            // SỬA ĐỔI: Thay thế hoàn toàn logic IsKhachVangLai
            await using var transaction = await _context.Database.BeginTransactionAsync();
            try
            {
                // 1. XỬ LÝ KHÁCH HÀNG (Logic "Tìm hoặc Tạo")
                if (string.IsNullOrWhiteSpace(dto.TenKhachHang) || string.IsNullOrWhiteSpace(dto.SoDienThoai))
                {
                    return BadRequest("Tên khách hàng và Số điện thoại là bắt buộc.");
                }

                string? sdt = dto.SoDienThoai;
                string? email = dto.Email;

                if (!string.IsNullOrWhiteSpace(sdt))
                {
                    khachHang = await _context.KhachHangs.FirstOrDefaultAsync(k => k.SoDienThoai == sdt);
                }
                if (khachHang == null && !string.IsNullOrWhiteSpace(email))
                {
                    khachHang = await _context.KhachHangs.FirstOrDefaultAsync(k => k.Email == email);
                }

                if (khachHang == null) // Tạo mới
                {
                    if (!string.IsNullOrWhiteSpace(sdt) && await _context.KhachHangs.AnyAsync(k => k.SoDienThoai == sdt))
                    {
                        return Conflict("Số điện thoại này đã tồn tại.");
                    }
                    if (!string.IsNullOrWhiteSpace(email) && await _context.KhachHangs.AnyAsync(k => k.Email == email))
                    {
                        return Conflict("Email này đã tồn tại.");
                    }

                    string tenDangNhap;
                    if (!string.IsNullOrWhiteSpace(sdt)) { tenDangNhap = sdt; }
                    else if (!string.IsNullOrWhiteSpace(email)) { tenDangNhap = email; }
                    else { tenDangNhap = $"temp_{Guid.NewGuid().ToString("N")[..12]}"; }

                    var newKH = new KhachHang
                    {
                        HoTen = dto.TenKhachHang,
                        SoDienThoai = sdt,
                        Email = email,
                        NgayTao = DateTime.Now,
                        DiemTichLuy = 0,
                        BiKhoa = false,
                        TenDangNhap = tenDangNhap,
                        MatKhau = "123456", // Mật khẩu mặc định
                        TaiKhoanTam = true
                    };
                    _context.KhachHangs.Add(newKH);
                    await _context.SaveChangesAsync(); // Lưu KH để lấy ID
                    khachHang = newKH;
                }
                else // Cập nhật khách tìm thấy
                {
                    khachHang.HoTen = dto.TenKhachHang;
                    khachHang.Email = email; // Cập nhật Email nếu có
                }

                // 2. XỬ LÝ ĐẶT BÀN (Giữ nguyên)
                var ban = await _context.Bans.FindAsync(dto.IdBan);
                if (ban == null) return BadRequest("Bàn không tồn tại.");
                if (ban.TrangThai == "Có khách") return BadRequest("Bàn đang có khách, không thể đặt.");

                var openingHours = await GetAndParseOpeningHours();
                if (!IsTimeValid(dto.ThoiGianDat, openingHours))
                {
                    return BadRequest($"Giờ đặt ({dto.ThoiGianDat:HH:mm}) nằm ngoài giờ mở cửa ({openingHours.Open:hh\\:mm} - {openingHours.Close:hh\\:mm}).");
                }
                if (dto.SoLuongKhach > ban.SoGhe)
                {
                    return BadRequest($"Số lượng khách ({dto.SoLuongKhach}) vượt quá số ghế của bàn ({ban.SoGhe}).");
                }

                // Logic kiểm tra xung đột (chồng chéo slot + 5 phút đệm)
                DateTime newSlotStart = dto.ThoiGianDat;
                DateTime newSlotEnd = dto.ThoiGianDat.AddHours(ReservationSlotHours);

                var conflict = await _context.PhieuDatBans
                    .Where(p => p.IdBan == dto.IdBan &&
                                (p.TrangThai == "Đã xác nhận" || p.TrangThai == "Chờ xác nhận"))
                    .ToListAsync();

                foreach (var p in conflict)
                {
                    DateTime existingSlotStart = p.ThoiGianDat.AddMinutes(-ReservationBufferMinutes);
                    DateTime existingSlotEnd = p.ThoiGianDat.AddHours(ReservationSlotHours).AddMinutes(ReservationBufferMinutes);

                    if (newSlotStart < existingSlotEnd && existingSlotStart < newSlotEnd)
                    {
                        return Conflict($"Xung đột! Bàn này đã có phiếu đặt lúc {p.ThoiGianDat:HH:mm} (có 5 phút đệm).");
                    }
                }

                // 3. TẠO PHIẾU
                var phieu = new PhieuDatBan
                {
                    IdKhachHang = khachHang?.IdKhachHang, // Gán ID khách hàng đã tìm/tạo
                    IdBan = dto.IdBan,
                    HoTenKhach = dto.TenKhachHang, // Luôn lưu tên/SĐT từ form (Snapshot)
                    SdtKhach = dto.SoDienThoai,
                    ThoiGianDat = dto.ThoiGianDat,
                    SoLuongKhach = dto.SoLuongKhach,
                    GhiChu = dto.GhiChu,
                    TrangThai = dto.TrangThai
                };
                _context.PhieuDatBans.Add(phieu);
               //ban.TrangThai = "Đã đặt";

                await _context.SaveChangesAsync();
                await transaction.CommitAsync();

                // Gửi email
                var emailNguoiNhan = khachHang?.Email ?? dto.Email;
                if (!string.IsNullOrEmpty(emailNguoiNhan))
                {
                    var khachInfo = new KhachHang { HoTen = dto.TenKhachHang, Email = emailNguoiNhan };
                    _ = SendConfirmationEmailAsync(phieu, khachInfo, ban.SoBan);
                }
                return Ok(new { idPhieuDatBan = phieu.IdPhieuDatBan });
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                return StatusCode(500, $"Lỗi nội bộ: {ex.Message} \nChi tiết: {ex.InnerException?.Message}");
            }
        }

        [HttpPut("update/{id}")]
        public async Task<IActionResult> UpdateDatBan(int id, PhieuDatBanCreateUpdateDto dto)
        {
            await using var transaction = await _context.Database.BeginTransactionAsync();
            try
            {
                var phieu = await _context.PhieuDatBans
                    .Include(p => p.KhachHang)
                    .Include(p => p.Ban)
                    .FirstOrDefaultAsync(p => p.IdPhieuDatBan == id);

                if (phieu == null) return NotFound("Không tìm thấy phiếu đặt.");

                var openingHours = await GetAndParseOpeningHours();
                if (!IsTimeValid(dto.ThoiGianDat, openingHours))
                {
                    return BadRequest($"Giờ đặt ({dto.ThoiGianDat:HH:mm}) nằm ngoài giờ mở cửa ({openingHours.Open:hh\\:mm} - {openingHours.Close:hh\\:mm}).");
                }

                string oldTrangThai = phieu.TrangThai;

                // SỬA ĐỔI: Logic "Find or Create" tương tự như Create
                KhachHang khachHang = null;
                if (string.IsNullOrWhiteSpace(dto.TenKhachHang) || string.IsNullOrWhiteSpace(dto.SoDienThoai))
                {
                    return BadRequest("Tên khách hàng và Số điện thoại là bắt buộc.");
                }
                string? sdt = dto.SoDienThoai;
                string? email = dto.Email;

                if (!string.IsNullOrWhiteSpace(sdt)) { khachHang = await _context.KhachHangs.FirstOrDefaultAsync(k => k.SoDienThoai == sdt); }
                if (khachHang == null && !string.IsNullOrWhiteSpace(email)) { khachHang = await _context.KhachHangs.FirstOrDefaultAsync(k => k.Email == email); }

                if (khachHang == null) // Tạo mới
                {
                    if (!string.IsNullOrWhiteSpace(sdt) && await _context.KhachHangs.AnyAsync(k => k.SoDienThoai == sdt)) { return Conflict("Số điện thoại này đã tồn tại."); }
                    if (!string.IsNullOrWhiteSpace(email) && await _context.KhachHangs.AnyAsync(k => k.Email == email)) { return Conflict("Email này đã tồn tại."); }

                    string tenDangNhap;
                    if (!string.IsNullOrWhiteSpace(sdt)) { tenDangNhap = sdt; }
                    else if (!string.IsNullOrWhiteSpace(email)) { tenDangNhap = email; }
                    else { tenDangNhap = $"temp_{Guid.NewGuid().ToString("N")[..12]}"; }

                    var newKH = new KhachHang
                    {
                        HoTen = dto.TenKhachHang,
                        SoDienThoai = sdt,
                        Email = email,
                        NgayTao = DateTime.Now,
                        DiemTichLuy = 0,
                        BiKhoa = false,
                        TenDangNhap = tenDangNhap,
                        MatKhau = "123456",
                        TaiKhoanTam = true
                    };
                    _context.KhachHangs.Add(newKH);
                    await _context.SaveChangesAsync();
                    khachHang = newKH;
                }
                else // Cập nhật
                {
                    khachHang.HoTen = dto.TenKhachHang;
                    khachHang.Email = email;
                }
                // Kết thúc SỬA ĐỔI

                phieu.IdKhachHang = khachHang?.IdKhachHang;
                phieu.HoTenKhach = dto.TenKhachHang;
                phieu.SdtKhach = dto.SoDienThoai;

                if (phieu.IdBan != dto.IdBan)
                {
                    var oldBan = await _context.Bans.FindAsync(phieu.IdBan);
                    if (oldBan != null) oldBan.TrangThai = "Trống";
                    var newBan = await _context.Bans.FindAsync(dto.IdBan);
                    if (newBan == null) return BadRequest("Bàn mới không tồn tại.");
                    if (newBan.TrangThai == "Có khách") return BadRequest("Bàn mới đang có khách.");
                    if (dto.SoLuongKhach > newBan.SoGhe)
                    {
                        return BadRequest($"Số lượng khách ({dto.SoLuongKhach}) vượt quá số ghế của bàn mới ({newBan.SoGhe}).");
                    }
                    //newBan.TrangThai = "Đã đặt";
                    phieu.IdBan = dto.IdBan;
                }

                // Kiểm tra xung đột khi Sửa
                DateTime newSlotStart = dto.ThoiGianDat;
                DateTime newSlotEnd = dto.ThoiGianDat.AddHours(ReservationSlotHours);
                var conflict = await _context.PhieuDatBans
                    .Where(p => p.IdBan == dto.IdBan &&
                                p.IdPhieuDatBan != id && // Loại trừ chính nó
                                (p.TrangThai == "Đã xác nhận" || p.TrangThai == "Chờ xác nhận"))
                    .ToListAsync();

                foreach (var p in conflict)
                {
                    DateTime existingSlotStart = p.ThoiGianDat.AddMinutes(-ReservationBufferMinutes);
                    DateTime existingSlotEnd = p.ThoiGianDat.AddHours(ReservationSlotHours).AddMinutes(ReservationBufferMinutes);
                    if (newSlotStart < existingSlotEnd && existingSlotStart < newSlotEnd)
                    {
                        return Conflict($"Xung đột! Bàn này đã có phiếu đặt lúc {p.ThoiGianDat:HH:mm} (có 5 phút đệm).");
                    }
                }

                phieu.ThoiGianDat = dto.ThoiGianDat;
                phieu.SoLuongKhach = dto.SoLuongKhach;
                phieu.GhiChu = dto.GhiChu;
                phieu.TrangThai = dto.TrangThai;

                // Lưu tất cả thay đổi
                await _context.SaveChangesAsync();
                await transaction.CommitAsync();

                // Gửi email
                if (oldTrangThai == "Chờ xác nhận" && dto.TrangThai == "Đã xác nhận")
                {
                    var emailNguoiNhan = khachHang?.Email ?? dto.Email;
                    if (!string.IsNullOrEmpty(emailNguoiNhan) && phieu.Ban != null)
                    {
                        var khachInfo = new KhachHang { HoTen = dto.TenKhachHang, Email = emailNguoiNhan };
                        _ = SendConfirmationEmailAsync(phieu, khachInfo, phieu.Ban.SoBan);
                    }
                }
                return Ok();
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                return StatusCode(500, $"Lỗi nội bộ: {ex.Message} \nChi tiết: {ex.InnerException?.Message}");
            }
        }

        [HttpPost("xacnhan-den")]
        public async Task<ActionResult<XacNhanKhachDenResponseDto>> XacNhanKhachDen(XacNhanKhachDenRequestDto dto)
        {
            var phieu = await _context.PhieuDatBans
                .Include(p => p.Ban)
                .FirstOrDefaultAsync(p => p.IdPhieuDatBan == dto.IdPhieuDatBan);

            if (phieu == null) return NotFound("Phiếu đặt không tồn tại.");
            if (phieu.Ban == null) return BadRequest("Bàn không hợp lệ.");
            var ban = phieu.Ban;
            if (ban.TrangThai == "Có khách")
            {
                return BadRequest($"Bàn {ban.SoBan} đã có khách. Vui lòng kiểm tra lại.");
            }
            var hoaDon = new HoaDon
            {
                IdBan = phieu.IdBan,
                IdNhanVien = dto.IdNhanVien,
                IdKhachHang = phieu.IdKhachHang,
                ThoiGianTao = DateTime.Now,
                TrangThai = "Chưa thanh toán",
                LoaiHoaDon = "Tại quán",
                TongTienGoc = 0,
                GiamGia = 0,
                TongPhuThu = 0
            };
            _context.HoaDons.Add(hoaDon);
            await _context.SaveChangesAsync();
            phieu.TrangThai = "Khách đã đến";
            ban.TrangThai = "Có khách";
            await _context.SaveChangesAsync();
            return Ok(new XacNhanKhachDenResponseDto { IdHoaDon = hoaDon.IdHoaDon });
        }

        [HttpPost("huy/{id}")]
        public async Task<IActionResult> HuyDatBan(int id)
        {
            var phieu = await _context.PhieuDatBans.Include(p => p.Ban)
                        .FirstOrDefaultAsync(p => p.IdPhieuDatBan == id);
            if (phieu == null) return NotFound("Phiếu đặt không tồn tại.");
            if (phieu.TrangThai == "Đã hủy" || phieu.TrangThai == "Khách đã đến")
            {
                return BadRequest("Không thể hủy phiếu ở trạng thái này.");
            }
            phieu.TrangThai = "Đã hủy";
            if (phieu.Ban != null)
            {
                phieu.Ban.TrangThai = "Trống";
            }
            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpPost("create-web")]
        public async Task<IActionResult> CreateDatBanWeb(PhieuDatBanWebCreateDto dto)
        {
            // Người dùng web luôn được coi là khách hàng thật (không vãng lai)
            KhachHang khachHang = null;
            try
            {
                // Dùng helper cũ vì logic web khác
                khachHang = await FindOrCreateKhachHangWeb(dto.TenKhachHang, dto.SoDienThoai, dto.Email);
            }
            catch (Exception ex)
            {
                return BadRequest(ex.Message);
            }

            var ban = await _context.Bans.FindAsync(dto.IdBan);
            if (ban == null) return BadRequest("Bàn không tồn tại.");
            if (ban.TrangThai != "Trống") return BadRequest("Bàn đã có người đặt hoặc đang có khách.");

            var openingHours = await GetAndParseOpeningHours();
            if (!IsTimeValid(dto.ThoiGianDat, openingHours))
            {
                return BadRequest($"Giờ đặt ({dto.ThoiGianDat:HH:mm}) nằm ngoài giờ mở cửa ({openingHours.Open:hh\\:mm} - {openingHours.Close:hh\\:mm}).");
            }
            if (dto.SoLuongKhach > ban.SoGhe)
            {
                return BadRequest($"Số lượng khách ({dto.SoLuongKhach}) vượt quá số ghế của bàn ({ban.SoGhe}).");
            }

            DateTime newSlotStart = dto.ThoiGianDat;
            DateTime newSlotEnd = dto.ThoiGianDat.AddHours(ReservationSlotHours);
            var conflict = await _context.PhieuDatBans
                .Where(p => p.IdBan == dto.IdBan &&
                            (p.TrangThai == "Đã xác nhận" || p.TrangThai == "Chờ xác nhận"))
                .ToListAsync();
            foreach (var p in conflict)
            {
                DateTime existingSlotStart = p.ThoiGianDat.AddMinutes(-ReservationBufferMinutes);
                DateTime existingSlotEnd = p.ThoiGianDat.AddHours(ReservationSlotHours).AddMinutes(ReservationBufferMinutes);
                if (newSlotStart < existingSlotEnd && existingSlotStart < newSlotEnd)
                {
                    return Conflict($"Xung đột! Bàn này đã có phiếu đặt lúc {p.ThoiGianDat:HH:mm} (có 5 phút đệm).");
                }
            }

            var phieu = new PhieuDatBan
            {
                IdKhachHang = khachHang?.IdKhachHang, // Gán IdKhachHang
                IdBan = dto.IdBan,
                HoTenKhach = dto.TenKhachHang,
                SdtKhach = dto.SoDienThoai,
                ThoiGianDat = dto.ThoiGianDat,
                SoLuongKhach = dto.SoLuongKhach,
                GhiChu = dto.GhiChu,
                TrangThai = "Chờ xác nhận"
            };
            _context.PhieuDatBans.Add(phieu);
            //ban.TrangThai = "Đã đặt";

            // Lưu lần 1 (Phiếu, Bàn, Khách hàng (nếu có))
            await _context.SaveChangesAsync();

            var noiDungTB = $"Phiếu đặt bàn #{phieu.IdPhieuDatBan} ({khachHang.HoTen}) đang chờ xác nhận.";
            var thongBao = new ThongBao
            {
                IdNhanVienTao = null,
                NoiDung = noiDungTB,
                LoaiThongBao = "DatBan",
                IdLienQuan = phieu.IdPhieuDatBan,
                DaXem = false,
                ThoiGianTao = DateTime.Now
            };
            _context.ThongBaos.Add(thongBao);

            // Lưu lần 2 (Thông báo)
            await _context.SaveChangesAsync();
            return Ok(new { idPhieuDatBan = phieu.IdPhieuDatBan });
        }
        #endregion

        #region Helpers (Khách hàng, Email, Giờ)

        // SỬA ĐỔI: Đổi tên helper này thành Web để tránh nhầm lẫn
        private async Task<KhachHang> FindOrCreateKhachHangWeb(string ten, string sdt, string? email)
        {
            if (string.IsNullOrWhiteSpace(sdt) || sdt == "N/A")
            {
                return null;
            }

            var khachHang = await _context.KhachHangs
                .FirstOrDefaultAsync(k => k.SoDienThoai == sdt);

            if (khachHang == null)
            {
                khachHang = new KhachHang
                {
                    HoTen = ten,
                    SoDienThoai = sdt,
                    Email = email,
                    DiemTichLuy = 0,
                    NgayTao = DateTime.Now,
                    BiKhoa = false
                    // Logic TenDangNhap/MatKhau của Web/App khách có thể khác
                };
                _context.KhachHangs.Add(khachHang);
                try
                {
                    await _context.SaveChangesAsync();
                }
                catch (DbUpdateException ex) when (ex.InnerException is SqlException sqlEx && (sqlEx.Number == 2627 || sqlEx.Number == 2601))
                {
                    throw new Exception($"Lỗi CSDL: Không thể tạo khách hàng. SĐT hoặc Email có thể đã tồn tại. (Mã lỗi: {sqlEx.Number})");
                }
            }
            else
            {
                khachHang.HoTen = ten;
                khachHang.Email = string.IsNullOrEmpty(email) ? khachHang.Email : email;
                await _context.SaveChangesAsync();
            }
            return khachHang;
        }

        private async Task SendConfirmationEmailAsync(PhieuDatBan phieu, KhachHang khach, string soBan)
        {
            if (khach.Email == null)
            {
                Console.WriteLine("Bỏ qua gửi email: Email khách hàng là null.");
                return;
            }
            try
            {
                var smtpSettings = _config.GetSection("SmtpSettings");
                var email = new MimeMessage();
                email.From.Add(new MailboxAddress(smtpSettings["FromName"] ?? "Notify", smtpSettings["Username"]));
                email.To.Add(new MailboxAddress(khach.HoTen, khach.Email));
                email.Subject = "[Cafebook] Xác nhận đặt bàn thành công";
                string body = $@"<p>Xin chào {khach.HoTen},</p>
                    <p>Cảm ơn bạn đã đặt bàn tại Cafebook.</p>
                    <p><strong>Thông tin đặt bàn:</strong></p>
                    <ul>
                        <li><strong>Bàn:</strong> {soBan}</li>
                        <li><strong>Thời gian:</strong> {phieu.ThoiGianDat:HH:mm} ngày {phieu.ThoiGianDat:dd/MM/yyyy}</li>
                        <li><strong>Số khách:</strong> {phieu.SoLuongKhach}</li>
                        <li><strong>Ghi chú:</strong> {phieu.GhiChu ?? "Không có"}</li>
                        <li><strong>Trạng thái:</strong> {phieu.TrangThai}</li>
                    </ul>
                    <p>Rất mong được đón tiếp bạn!</p>
                    <p>Trân trọng,<br>Đội ngũ Cafebook</p>";
                email.Body = new TextPart(MimeKit.Text.TextFormat.Html) { Text = body };
                using var smtp = new SmtpClient();
                await smtp.ConnectAsync(smtpSettings["Host"], int.Parse(smtpSettings["Port"] ?? "0"), SecureSocketOptions.StartTls);
                await smtp.AuthenticateAsync(smtpSettings["Username"], smtpSettings["Password"]);
                await smtp.SendAsync(email);
                await smtp.DisconnectAsync(true);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Lỗi gửi email (chạy ngầm): {ex.Message}");
            }
        }

        private async Task<OpeningHours> GetAndParseOpeningHours()
        {
            var setting = await _context.CaiDats
                .FirstOrDefaultAsync(cd => cd.TenCaiDat == "LienHe_GioMoCua");
            string settingValue = (setting != null && !string.IsNullOrEmpty(setting.GiaTri)) ? setting.GiaTri : "06:00 - 23:00";
            return ParseOpeningHours(settingValue);
        }

        private OpeningHours ParseOpeningHours(string settingValue)
        {
            var hours = new OpeningHours();
            try
            {
                var match = Regex.Match(settingValue, @"(\d{2}:\d{2})\s*-\s*(\d{2}:\d{2})");
                if (match.Success)
                {
                    if (TimeSpan.TryParse(match.Groups[1].Value, out TimeSpan open)) hours.Open = open;
                    if (TimeSpan.TryParse(match.Groups[2].Value, out TimeSpan close)) hours.Close = close;
                    hours.IsValid = true;
                }
            }
            catch { }
            return hours;
        }

        private bool IsTimeValid(DateTime thoiGianDat, OpeningHours hours)
        {
            var timeOfDay = thoiGianDat.TimeOfDay;
            return timeOfDay >= hours.Open && timeOfDay <= hours.Close;
        }
        #endregion
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\NhanVien\GiaoHangController.cs
================================================================================
﻿// Tệp: CafebookApi/Controllers/App/NhanVien/GiaoHangController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp.NhanVien;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Linq;
using System.Security.Claims;
using System.Threading.Tasks;
using System.Collections.Generic;
using Microsoft.Extensions.Configuration;
using System.IO;

namespace CafebookApi.Controllers.App.NhanVien
{
    [Route("api/app/nhanvien/giaohang")]
    [ApiController]
    [Authorize]
    public class GiaoHangController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private Dictionary<string, string> _settings = new Dictionary<string, string>();
        private readonly string _baseUrl;

        public GiaoHangController(CafebookDbContext context, IConfiguration config)
        {
            _context = context;
            _baseUrl = config.GetValue<string>("Kestrel:Endpoints:Http:Url") ?? "http://127.0.0.1:5166";
        }

        private async Task LoadCaiDat()
        {
            _settings = await _context.CaiDats
                .Where(c =>
                    c.TenCaiDat == "TenQuan" ||
                    c.TenCaiDat == "DiaChi" ||
                    c.TenCaiDat == "SoDienThoai")
                .AsNoTracking()
                .ToDictionaryAsync(c => c.TenCaiDat, c => c.GiaTri);
        }

        private int GetCurrentUserId()
        {
            var idClaim = User.Claims.FirstOrDefault(c => c.Type == "IdNhanVien");
            if (idClaim != null && int.TryParse(idClaim.Value, out int idNhanVien))
            {
                return idNhanVien;
            }
            return 0;
        }

        /// <summary>
        /// Tải danh sách đơn giao hàng (ĐÃ SỬA LỖI HIỂN THỊ TÊN)
        /// </summary>
        [HttpGet("load")]
        public async Task<IActionResult> LoadGiaoHangData([FromQuery] string? search, [FromQuery] string? status)
        {
            try
            {
                var query = _context.HoaDons
                    .Where(h => h.LoaiHoaDon == "Giao hàng")
                    .Include(h => h.KhachHang)
                    .Include(h => h.NguoiGiaoHang)
                    .OrderByDescending(h => h.ThoiGianTao)
                    .AsQueryable();

                if (!string.IsNullOrEmpty(status) && status != "Tất cả")
                {
                    if (status == "Đã Hủy")
                    {
                        query = query.Where(h => h.TrangThai == "Đã hủy");
                    }
                    else
                    {
                        query = query.Where(h => h.TrangThaiGiaoHang == status);
                    }
                }

                if (!string.IsNullOrEmpty(search))
                {
                    var searchLower = search.ToLower();
                    int.TryParse(search, out int idSearch);

                    query = query.Where(h =>
                        (h.KhachHang != null && h.KhachHang.HoTen.ToLower().Contains(searchLower)) ||
                        (h.SoDienThoaiGiaoHang != null && h.SoDienThoaiGiaoHang.Contains(search)) ||
                        (h.KhachHang != null && h.KhachHang.SoDienThoai != null && h.KhachHang.SoDienThoai.Contains(search)) ||
                        h.IdHoaDon == idSearch
                    );
                }

                var donGiaoHang = await query.Select(h => new GiaoHangItemDto
                {
                    IdHoaDon = h.IdHoaDon,
                    ThoiGianTao = h.ThoiGianTao,

                    // =======================================
                    // === SỬA LỖI HIỂN THỊ TÊN (YÊU CẦU 1) ===
                    // =======================================
                    TenKhachHang = h.KhachHang.HoTen ?? h.DiaChiGiaoHang ?? "Khách giao hàng",
                    SoDienThoaiGiaoHang = h.SoDienThoaiGiaoHang ?? h.KhachHang.SoDienThoai,
                    DiaChiGiaoHang = h.DiaChiGiaoHang ?? h.KhachHang.DiaChi,
                    // =======================================

                    ThanhTien = h.ThanhTien,
                    TrangThaiThanhToan = h.TrangThai,
                    TrangThaiGiaoHang = h.TrangThaiGiaoHang,
                    IdNguoiGiaoHang = h.IdNguoiGiaoHang,
                    TenNguoiGiaoHang = h.NguoiGiaoHang.TenNguoiGiaoHang
                })
                    .ToListAsync();

                var nguoiGiaoHang = await _context.NguoiGiaoHangs
                    .Where(n => n.TrangThai == "Sẵn sàng")
                    .Select(n => new NguoiGiaoHangDto
                    {
                        IdNguoiGiaoHang = n.IdNguoiGiaoHang,
                        TenNguoiGiaoHang = n.TenNguoiGiaoHang
                    })
                    .ToListAsync();

                var dto = new GiaoHangViewDto
                {
                    DonGiaoHang = donGiaoHang,
                    NguoiGiaoHangSanSang = nguoiGiaoHang
                };

                return Ok(dto);
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Lỗi máy chủ: {ex.Message}");
            }
        }

        // ... (Các hàm UpdateGiaoHang, ConfirmAllPendingOrders, GetPrintData, CreateOrUpdateCheBienItems giữ nguyên) ...

        [HttpPost("update/{idHoaDon}")]
        public async Task<IActionResult> UpdateGiaoHang(int idHoaDon, [FromBody] GiaoHangUpdateRequestDto dto)
        {
            try
            {
                int idNhanVien = GetCurrentUserId();
                var hoaDon = await _context.HoaDons.FirstOrDefaultAsync(h => h.IdHoaDon == idHoaDon);

                if (hoaDon == null) return NotFound("Không tìm thấy hóa đơn.");
                if (hoaDon.LoaiHoaDon != "Giao hàng") return BadRequest("Đây không phải là hóa đơn giao hàng.");

                string? trangThaiCu = hoaDon.TrangThaiGiaoHang;

                hoaDon.TrangThaiGiaoHang = dto.TrangThaiGiaoHang;
                hoaDon.IdNguoiGiaoHang = dto.IdNguoiGiaoHang;

                if (dto.IdNguoiGiaoHang.HasValue && string.IsNullOrEmpty(dto.TrangThaiGiaoHang))
                {
                    hoaDon.TrangThaiGiaoHang = "Chờ lấy hàng"; // Sửa: Chờ lấy hàng
                }

                if (dto.TrangThaiGiaoHang == "Hủy")
                {
                    hoaDon.TrangThai = "Đã hủy";
                }

                if (dto.TrangThaiGiaoHang == "Hoàn thành" && hoaDon.TrangThai != "Đã thanh toán")
                {
                    hoaDon.TrangThai = "Đã thanh toán";
                    hoaDon.ThoiGianThanhToan = DateTime.Now;
                    hoaDon.PhuongThucThanhToan = "COD";
                }

                if (dto.TrangThaiGiaoHang == "Đang chuẩn bị" && (trangThaiCu == "Chờ xác nhận" || trangThaiCu == null))
                {
                    await CreateOrUpdateCheBienItems(idHoaDon, idNhanVien);
                }

                await _context.SaveChangesAsync();
                return Ok(new { message = "Cập nhật thành công." });
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Lỗi máy chủ: {ex.Message}");
            }
        }

        [HttpPost("confirm-all-pending")]
        public async Task<IActionResult> ConfirmAllPendingOrders()
        {
            var idNhanVien = GetCurrentUserId();
            if (idNhanVien == 0) return Unauthorized();

            try
            {
                var donHangCho = await _context.HoaDons
                    .Where(h => h.LoaiHoaDon == "Giao hàng" &&
                                (h.TrangThaiGiaoHang == "Chờ xác nhận" || h.TrangThaiGiaoHang == null))
                    .ToListAsync();

                if (!donHangCho.Any())
                {
                    return Ok(new { message = "Không có đơn nào 'Chờ xác nhận'." });
                }

                int count = 0;
                foreach (var hoaDon in donHangCho)
                {
                    hoaDon.TrangThaiGiaoHang = "Đang chuẩn bị";
                    await CreateOrUpdateCheBienItems(hoaDon.IdHoaDon, idNhanVien);
                    count++;
                }

                await _context.SaveChangesAsync();
                return Ok(new { message = $"Đã chuyển {count} đơn hàng sang Bếp thành công." });
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Lỗi máy chủ: {ex.Message}");
            }
        }

        [HttpGet("print-data/{idHoaDon}")]
        public async Task<IActionResult> GetPrintData(int idHoaDon)
        {
            await LoadCaiDat();
            var hoaDon = await _context.HoaDons
                 .Include(h => h.Ban)
                 .Include(h => h.NhanVien)
                 .Include(h => h.KhachHang)
                 .Include(h => h.ChiTietHoaDons).ThenInclude(ct => ct.SanPham)
                 .AsNoTracking()
                 .FirstOrDefaultAsync(h => h.IdHoaDon == idHoaDon);

            if (hoaDon == null) return NotFound();

            var dto = new PhieuGoiMonPrintDto
            {
                IdPhieu = $"HD{hoaDon.IdHoaDon:D6}",
                TenQuan = _settings.GetValueOrDefault("TenQuan", "Cafebook"),
                DiaChiQuan = _settings.GetValueOrDefault("DiaChi", "N/A"),
                SdtQuan = _settings.GetValueOrDefault("SoDienThoai", "N/A"),
                NgayTao = hoaDon.ThoiGianTao,
                TenNhanVien = hoaDon.NhanVien?.HoTen ?? "Web",
                SoBan = hoaDon.LoaiHoaDon,
                GhiChu = $"KH: {hoaDon.KhachHang?.HoTen ?? "N/A"}\nSĐT: {hoaDon.SoDienThoaiGiaoHang}\nĐịa chỉ: {hoaDon.DiaChiGiaoHang}\nGhi chú: {hoaDon.GhiChu}",

                ChiTiet = hoaDon.ChiTietHoaDons.Select(ct => new ChiTietDto
                {
                    TenSanPham = ct.SanPham.TenSanPham,
                    SoLuong = ct.SoLuong,
                    DonGia = ct.DonGia,
                    ThanhTien = ct.ThanhTien
                }).ToList(),

                TongTienGoc = hoaDon.TongTienGoc,
                GiamGia = hoaDon.GiamGia,
                ThanhTien = hoaDon.ThanhTien
            };

            return Ok(dto);
        }

        private async Task<int> CreateOrUpdateCheBienItems(int idHoaDon, int idNhanVien)
        {
            var hoaDon = await _context.HoaDons
                 .Include(h => h.Ban)
                 .FirstOrDefaultAsync(h => h.IdHoaDon == idHoaDon);

            if (hoaDon == null) return 0;

            var chiTietItems = await _context.ChiTietHoaDons
                .Include(c => c.SanPham)
                .Where(c => c.IdHoaDon == idHoaDon)
                .ToListAsync();

            string soBan = hoaDon.LoaiHoaDon;
            int itemsAdded = 0;
            var now = DateTime.Now;

            foreach (var item in chiTietItems)
            {
                bool daTonTai = await _context.TrangThaiCheBiens
                    .AnyAsync(cb => cb.IdChiTietHoaDon == item.IdChiTietHoaDon);

                if (!daTonTai)
                {
                    var newItem = new TrangThaiCheBien
                    {
                        IdChiTietHoaDon = item.IdChiTietHoaDon,
                        IdHoaDon = item.IdHoaDon,
                        IdSanPham = item.IdSanPham,
                        TenMon = item.SanPham.TenSanPham,
                        SoBan = soBan,
                        SoLuong = item.SoLuong,
                        GhiChu = item.GhiChu,
                        NhomIn = item.SanPham.NhomIn,
                        TrangThai = "Chờ làm",
                        ThoiGianGoi = now
                    };
                    _context.TrangThaiCheBiens.Add(newItem);
                    itemsAdded++;
                }
            }

            if (itemsAdded > 0)
            {
                var thongBao = new ThongBao
                {
                    IdNhanVienTao = idNhanVien,
                    NoiDung = $"Đơn Giao Hàng #{idHoaDon} cần chuẩn bị.",
                    ThoiGianTao = DateTime.Now,
                    LoaiThongBao = "PhieuGoiMon",
                    IdLienQuan = idHoaDon,
                    DaXem = false
                };
                _context.ThongBaos.Add(thongBao);
                await _context.SaveChangesAsync();
            }
            return itemsAdded;
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\NhanVien\GoiMonController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp.NhanVien;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;
using System;
using System.Collections.Generic;
using Microsoft.Extensions.Configuration;
using System.IO;

namespace CafebookApi.Controllers.App.NhanVien
{
    // DTO này đã có trong file GoiMonDto.cs
    // public class ApplyPromotionRequest { ... } 

    [Route("api/app/nhanvien/goimon")]
    [ApiController]
    public class GoiMonController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private readonly string _baseUrl;

        public GoiMonController(CafebookDbContext context, IConfiguration config)
        {
            _context = context;
            _baseUrl = config.GetValue<string>("Kestrel:Endpoints:Http:Url")
                       ?? "http://127.0.0.1:5166";
        }

        private string GetFullImageUrl(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath))
            {
                return $"{_baseUrl}/images/default-food-icon.png";
            }
            return $"{_baseUrl}{relativePath.Replace(Path.DirectorySeparatorChar, '/')}";
        }

        [HttpGet("load/{idHoaDon}")]
        public async Task<IActionResult> LoadGoiMonData(int idHoaDon)
        {
            var hoaDon = await _context.HoaDons
                .Include(h => h.Ban)
                .FirstOrDefaultAsync(h => h.IdHoaDon == idHoaDon);

            if (hoaDon == null) return NotFound("Không tìm thấy hóa đơn.");

            var currentPromotion = await _context.HoaDonKhuyenMais
                .FirstOrDefaultAsync(hk => hk.IdHoaDon == idHoaDon);

            var hoaDonInfo = new HoaDonInfoDto
            {
                IdHoaDon = hoaDon.IdHoaDon,
                SoBan = hoaDon.Ban?.SoBan ?? hoaDon.LoaiHoaDon,
                LoaiHoaDon = hoaDon.LoaiHoaDon,
                TongTienGoc = hoaDon.TongTienGoc,
                GiamGia = hoaDon.GiamGia,
                ThanhTien = hoaDon.ThanhTien,
                IdKhuyenMai = currentPromotion?.IdKhuyenMai
            };

            var chiTietItems = await _context.ChiTietHoaDons
                .Where(c => c.IdHoaDon == idHoaDon)
                .Select(c => new ChiTietDto
                {
                    IdChiTietHoaDon = c.IdChiTietHoaDon,
                    IdSanPham = c.IdSanPham,
                    TenSanPham = c.SanPham.TenSanPham,
                    SoLuong = c.SoLuong,
                    DonGia = c.DonGia,
                    ThanhTien = c.ThanhTien
                }).ToListAsync();

            var rawSanPhams = await _context.SanPhams
                .Where(s => s.TrangThaiKinhDoanh == true)
                .Select(s => new { s.IdSanPham, s.TenSanPham, s.GiaBan, s.HinhAnh, s.IdDanhMuc })
                .ToListAsync();

            var sanPhams = rawSanPhams
                .Select(s => new SanPhamDto
                {
                    IdSanPham = s.IdSanPham,
                    TenSanPham = s.TenSanPham,
                    DonGia = s.GiaBan,
                    HinhAnh = GetFullImageUrl(s.HinhAnh),
                    IdDanhMuc = s.IdDanhMuc
                }).ToList();

            var danhMucs = await _context.DanhMucs
                .OrderBy(d => d.TenDanhMuc)
                .Select(d => new DanhMucDto { IdDanhMuc = d.IdDanhMuc, TenLoaiSP = d.TenDanhMuc })
                .ToListAsync();

            // === SỬA LỖI LỌC KHUYẾN MÃI (THEO YÊU CẦU CỦA BẠN) ===
            var now = DateTime.Now;

            // 1. Tải về bộ nhớ
            var allKms = await _context.KhuyenMais.ToListAsync();

            // 2. Dùng C# (LINQ to Objects) để lọc
            var khuyenMais = allKms
                .Where(k =>
                    string.Equals(k.TrangThai, "Hoạt động", StringComparison.OrdinalIgnoreCase) &&
                    k.NgayBatDau <= now &&
                    k.NgayKetThuc >= now &&
                    (k.SoLuongConLai == null || k.SoLuongConLai > 0) &&
                    (k.HoaDonToiThieu == null || k.HoaDonToiThieu == 0 || hoaDon.TongTienGoc >= k.HoaDonToiThieu) &&
                    (k.GioBatDau == null || k.GioKetThuc == null || (now.TimeOfDay >= k.GioBatDau && now.TimeOfDay <= k.GioKetThuc))
                )
                .Select(k => new KhuyenMaiDto
                {
                    IdKhuyenMai = k.IdKhuyenMai,
                    TenKhuyenMai = k.TenChuongTrinh,
                    LoaiGiamGia = k.LoaiGiamGia,
                    GiaTriGiam = k.GiaTriGiam
                }).ToList();
            // === KẾT THÚC SỬA LỖI ===

            khuyenMais.Insert(0, new KhuyenMaiDto { IdKhuyenMai = 0, TenKhuyenMai = "-- Không áp dụng --" });

            var dto = new GoiMonViewDto
            {
                HoaDonInfo = hoaDonInfo,
                ChiTietItems = chiTietItems,
                SanPhams = sanPhams,
                DanhMucs = danhMucs,
                KhuyenMais = khuyenMais
            };

            return Ok(dto);
        }

        // HÀM HELPER MỚI: Cập nhật TongTienGoc
        private async Task UpdateHoaDonTotals(HoaDon hoaDon)
        {
            if (hoaDon != null)
            {
                // Tính tổng tiền từ các chi tiết (ChiTietHoaDon.ThanhTien là cột computed)
                var tongGocMoi = await _context.ChiTietHoaDons
                    .Where(c => c.IdHoaDon == hoaDon.IdHoaDon)
                    .SumAsync(c => c.ThanhTien);

                hoaDon.TongTienGoc = tongGocMoi;
                // Không lưu ở đây, để hàm gọi tự lưu
            }
        }

        // HÀM HELPER MỚI: Tính toán lại giảm giá (quan trọng)
        private async Task ReApplyPromotion(HoaDon hoaDon)
        {
            var currentPromoLink = await _context.HoaDonKhuyenMais
                .FirstOrDefaultAsync(hk => hk.IdHoaDon == hoaDon.IdHoaDon);

            if (currentPromoLink == null)
            {
                hoaDon.GiamGia = 0; // Không có KM
                return;
            }

            var km = await _context.KhuyenMais.FindAsync(currentPromoLink.IdKhuyenMai);
            if (km == null)
            {
                hoaDon.GiamGia = 0;
                _context.HoaDonKhuyenMais.Remove(currentPromoLink); // Xóa link hỏng
                return;
            }

            // === TÍNH TOÁN LẠI GIẢM GIÁ ===

            // 1. Kiểm tra điều kiện tối thiểu
            if (km.HoaDonToiThieu.HasValue && hoaDon.TongTienGoc < km.HoaDonToiThieu.Value)
            {
                hoaDon.GiamGia = 0;
                _context.HoaDonKhuyenMais.Remove(currentPromoLink); // Hủy KM vì không đủ ĐK
                return;
            }

            // 2. Tính toán lại
            decimal tongTienGocChoKM = hoaDon.TongTienGoc;
            // 2a. Nếu KM chỉ áp dụng cho 1 SP
            if (km.IdSanPhamApDung.HasValue)
            {
                tongTienGocChoKM = await _context.ChiTietHoaDons
                    .Where(c => c.IdHoaDon == hoaDon.IdHoaDon && c.IdSanPham == km.IdSanPhamApDung)
                    .SumAsync(c => c.ThanhTien);
            }

            // 3. Áp dụng giảm giá (SỬA LỖI 10% = 10đ)
            if (string.Equals(km.LoaiGiamGia, "PhanTram", StringComparison.OrdinalIgnoreCase))
            {
                decimal giamGia = tongTienGocChoKM * (km.GiaTriGiam / 100);
                if (km.GiamToiDa.HasValue && giamGia > km.GiamToiDa.Value)
                {
                    giamGia = km.GiamToiDa.Value;
                }
                hoaDon.GiamGia = giamGia;
            }
            else // "SoTien"
            {
                hoaDon.GiamGia = km.GiaTriGiam;
            }
        }


        [HttpPost("add-item")]
        public async Task<IActionResult> AddItem([FromBody] AddItemRequest req)
        {
            var hoaDon = await _context.HoaDons.FindAsync(req.IdHoaDon);
            if (hoaDon == null) return NotFound("Hóa đơn không tồn tại.");
            if (hoaDon.TrangThai == "Đã thanh toán") return Conflict("Hóa đơn đã thanh toán.");
            var sanPham = await _context.SanPhams.FindAsync(req.IdSanPham);
            if (sanPham == null) return NotFound("Sản phẩm không tồn tại.");

            // === NÂNG CẤP: KIỂM TRA TỒN KHO ===
            var dinhLuongList = await _context.DinhLuongs
                .Include(d => d.NguyenLieu)
                .Include(d => d.DonViSuDung)
                .Where(d => d.IdSanPham == req.IdSanPham)
                .ToListAsync();

            if (dinhLuongList.Any())
            {
                var existingItemQty = (await _context.ChiTietHoaDons.FirstOrDefaultAsync(c => c.IdHoaDon == req.IdHoaDon && c.IdSanPham == req.IdSanPham))?.SoLuong ?? 0;

                foreach (var dl in dinhLuongList)
                {
                    decimal luongCanDungMotSP = dl.SoLuongSuDung * dl.DonViSuDung.GiaTriQuyDoi;
                    decimal luongCanDungTong = luongCanDungMotSP * (existingItemQty + req.SoLuong); // SL mới + SL cũ

                    if (dl.NguyenLieu.TonKho < luongCanDungTong)
                    {
                        var thongBao = new ThongBao
                        {
                            IdNhanVienTao = hoaDon.IdNhanVien,
                            NoiDung = $"Nguyên liệu '{dl.NguyenLieu.TenNguyenLieu}' đã hết hàng khi cố gắng bán món '{sanPham.TenSanPham}'. Chỉ còn {dl.NguyenLieu.TonKho:N2} {dl.NguyenLieu.DonViTinh}.",
                            ThoiGianTao = DateTime.Now,
                            LoaiThongBao = "HetHang",
                            IdLienQuan = dl.IdNguyenLieu,
                            DaXem = false
                        };
                        _context.ThongBaos.Add(thongBao);
                        await _context.SaveChangesAsync();

                        return Conflict($"Hết hàng: '{dl.NguyenLieu.TenNguyenLieu}'. Không thể thêm món.");
                    }
                }
            }
            // === KẾT THÚC NÂNG CẤP ===

            ChiTietDto resultDto;
            var existingItemDb = await _context.ChiTietHoaDons.FirstOrDefaultAsync(c => c.IdHoaDon == req.IdHoaDon && c.IdSanPham == req.IdSanPham);

            if (existingItemDb != null)
            {
                existingItemDb.SoLuong += req.SoLuong;
                await _context.SaveChangesAsync();
                resultDto = new ChiTietDto { IdChiTietHoaDon = existingItemDb.IdChiTietHoaDon, IdSanPham = existingItemDb.IdSanPham, TenSanPham = sanPham.TenSanPham, SoLuong = existingItemDb.SoLuong, DonGia = existingItemDb.DonGia, ThanhTien = existingItemDb.SoLuong * existingItemDb.DonGia };
            }
            else
            {
                var newItem = new ChiTietHoaDon { IdHoaDon = req.IdHoaDon, IdSanPham = req.IdSanPham, SoLuong = req.SoLuong, DonGia = sanPham.GiaBan };
                _context.ChiTietHoaDons.Add(newItem);
                await _context.SaveChangesAsync();
                resultDto = new ChiTietDto { IdChiTietHoaDon = newItem.IdChiTietHoaDon, IdSanPham = newItem.IdSanPham, TenSanPham = sanPham.TenSanPham, SoLuong = newItem.SoLuong, DonGia = newItem.DonGia, ThanhTien = newItem.SoLuong * newItem.DonGia };
            }

            // SỬA LỖI TÍNH TOÁN: Cập nhật tổng và khuyến mãi
            await UpdateHoaDonTotals(hoaDon);
            await ReApplyPromotion(hoaDon);
            await _context.SaveChangesAsync(); // Lưu Hóa đơn

            var updatedHoaDonInfo = await GetHoaDonInfo(req.IdHoaDon);
            return Ok(new { updatedHoaDonInfo, newItem = resultDto });
        }

        [HttpPut("update-quantity")]
        public async Task<IActionResult> UpdateQuantity([FromBody] UpdateSoLuongRequest req)
        {
            var item = await _context.ChiTietHoaDons.Include(c => c.HoaDon).FirstOrDefaultAsync(c => c.IdChiTietHoaDon == req.IdChiTietHoaDon);
            if (item == null) return NotFound("Không tìm thấy món.");
            var hoaDon = item.HoaDon;
            if (hoaDon.TrangThai == "Đã thanh toán") return Conflict("Hóa đơn đã thanh toán.");

            if (req.SoLuongMoi <= 0)
                _context.ChiTietHoaDons.Remove(item);
            else
                item.SoLuong = req.SoLuongMoi;

            await _context.SaveChangesAsync();

            // SỬA LỖI TÍNH TOÁN: Cập nhật tổng và khuyến mãi
            await UpdateHoaDonTotals(hoaDon);
            await ReApplyPromotion(hoaDon);
            await _context.SaveChangesAsync(); // Lưu Hóa đơn

            var updatedHoaDonInfo = await GetHoaDonInfo(hoaDon.IdHoaDon);
            return Ok(updatedHoaDonInfo);
        }

        [HttpDelete("delete-item/{idChiTiet}")]
        public async Task<IActionResult> DeleteItem(int idChiTiet)
        {
            var item = await _context.ChiTietHoaDons.Include(c => c.HoaDon).FirstOrDefaultAsync(c => c.IdChiTietHoaDon == idChiTiet);
            if (item == null) return NotFound("Không tìm thấy món.");
            var hoaDon = item.HoaDon;
            if (hoaDon.TrangThai == "Đã thanh toán") return Conflict("Hóa đơn đã thanh toán.");

            int idHoaDon = item.IdHoaDon;
            _context.ChiTietHoaDons.Remove(item);
            await _context.SaveChangesAsync();

            // SỬA LỖI TÍNH TOÁN: Cập nhật tổng và khuyến mãi
            await UpdateHoaDonTotals(hoaDon);
            await ReApplyPromotion(hoaDon);
            await _context.SaveChangesAsync(); // Lưu Hóa đơn

            var updatedHoaDonInfo = await GetHoaDonInfo(idHoaDon);
            return Ok(updatedHoaDonInfo);
        }

        [HttpPut("apply-promotion")]
        public async Task<IActionResult> ApplyPromotion([FromBody] ApplyPromotionRequest req)
        {
            var hoaDon = await _context.HoaDons.FindAsync(req.IdHoaDon);
            if (hoaDon == null) return NotFound("Hóa đơn không tồn tại.");

            var existingPromos = _context.HoaDonKhuyenMais.Where(hk => hk.IdHoaDon == req.IdHoaDon);
            _context.HoaDonKhuyenMais.RemoveRange(existingPromos);

            if (req.IdKhuyenMai == null || req.IdKhuyenMai == 0)
            {
                hoaDon.GiamGia = 0;
            }
            else
            {
                var km = await _context.KhuyenMais.FindAsync(req.IdKhuyenMai);
                if (km == null) return NotFound("Khuyến mãi không tồn tại.");

                _context.HoaDonKhuyenMais.Add(new HoaDon_KhuyenMai
                {
                    IdHoaDon = req.IdHoaDon,
                    IdKhuyenMai = km.IdKhuyenMai
                });

                // === SỬA LỖI 10% = 10đ ===
                if (string.Equals(km.LoaiGiamGia, "PhanTram", StringComparison.OrdinalIgnoreCase))
                {
                    decimal tongTienGocChoKM = hoaDon.TongTienGoc;
                    if (km.IdSanPhamApDung.HasValue)
                    {
                        tongTienGocChoKM = await _context.ChiTietHoaDons
                            .Where(c => c.IdHoaDon == req.IdHoaDon && c.IdSanPham == km.IdSanPhamApDung)
                            .SumAsync(c => c.ThanhTien);
                    }

                    decimal giamGia = tongTienGocChoKM * (km.GiaTriGiam / 100);
                    if (km.GiamToiDa.HasValue && giamGia > km.GiamToiDa.Value)
                    {
                        giamGia = km.GiamToiDa.Value;
                    }
                    hoaDon.GiamGia = giamGia;
                }
                else // "SoTien"
                {
                    hoaDon.GiamGia = km.GiaTriGiam;
                }
            }

            await _context.SaveChangesAsync();
            var updatedHoaDonInfo = await GetHoaDonInfo(req.IdHoaDon);
            return Ok(updatedHoaDonInfo);
        }

        // (Hàm ThanhToan đã bị comment out trong file gốc, giữ nguyên)
        /*
        [HttpPost("thanh-toan")]
        public async Task<IActionResult> ThanhToan([FromBody] ThanhToanRequest req)
        { ... }
        */

        private async Task<HoaDonInfoDto> GetHoaDonInfo(int idHoaDon)
        {
            var updatedHoaDon = await _context.HoaDons
                .Include(h => h.Ban)
                .AsNoTracking()
                .FirstOrDefaultAsync(h => h.IdHoaDon == idHoaDon);

            if (updatedHoaDon == null)
                throw new Exception("Không thể tìm thấy hóa đơn sau khi cập nhật.");

            var currentPromotion = await _context.HoaDonKhuyenMais
                .AsNoTracking()
                .FirstOrDefaultAsync(hk => hk.IdHoaDon == idHoaDon);

            return new HoaDonInfoDto
            {
                IdHoaDon = updatedHoaDon.IdHoaDon,
                SoBan = updatedHoaDon.Ban?.SoBan ?? updatedHoaDon.LoaiHoaDon,
                LoaiHoaDon = updatedHoaDon.LoaiHoaDon,
                TongTienGoc = updatedHoaDon.TongTienGoc,
                GiamGia = updatedHoaDon.GiamGia,
                ThanhTien = updatedHoaDon.ThanhTien,
                IdKhuyenMai = currentPromotion?.IdKhuyenMai
            };
        }

        // === API MỚI CHO LOGIC BẾP (YÊU CẦU MỚI) ===

        /// <summary>
        /// Helper: Tìm các món trong CTHD và đẩy vào Bảng Chế Biến
        /// </summary>
        private async Task<int> CreateOrUpdateCheBienItems(int idHoaDon)
        {
            var hoaDon = await _context.HoaDons
                .Include(h => h.Ban)
                .FirstOrDefaultAsync(h => h.IdHoaDon == idHoaDon);

            if (hoaDon == null) return 0;

            var chiTietItems = await _context.ChiTietHoaDons
                .Include(c => c.SanPham)
                .Where(c => c.IdHoaDon == idHoaDon)
                .ToListAsync();

            string soBan = hoaDon.Ban?.SoBan ?? hoaDon.LoaiHoaDon;
            int itemsAdded = 0;
            var now = DateTime.Now;

            foreach (var item in chiTietItems)
            {
                // Kiểm tra xem món này đã được gửi bếp chưa
                bool daTonTai = await _context.TrangThaiCheBiens
                    .AnyAsync(cb => cb.IdChiTietHoaDon == item.IdChiTietHoaDon);

                if (!daTonTai)
                {
                    // Tạo một bản ghi chờ chế biến
                    var newItem = new TrangThaiCheBien
                    {
                        IdChiTietHoaDon = item.IdChiTietHoaDon,
                        IdHoaDon = item.IdHoaDon,
                        IdSanPham = item.IdSanPham,
                        TenMon = item.SanPham.TenSanPham,
                        SoBan = soBan,
                        SoLuong = item.SoLuong,
                        GhiChu = item.GhiChu,
                        NhomIn = item.SanPham.NhomIn,
                        TrangThai = "Chờ làm", // Trạng thái mặc định
                        ThoiGianGoi = now
                    };
                    _context.TrangThaiCheBiens.Add(newItem);
                    itemsAdded++;
                }
            }

            if (itemsAdded > 0)
            {
                await _context.SaveChangesAsync();
            }
            return itemsAdded;
        }

        /// <summary>
        /// API cho nút "Lưu" (Chỉ gửi bếp)
        /// </summary>
        [HttpPost("send-to-kitchen/{idHoaDon}")]
        public async Task<IActionResult> SendToKitchen(int idHoaDon)
        {
            try
            {
                int itemsAdded = await CreateOrUpdateCheBienItems(idHoaDon);
                return Ok(new { message = $"Đã gửi {itemsAdded} món mới vào bếp." });
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Lỗi khi gửi bếp: {ex.Message}");
            }
        }

        /// <summary>
        /// API cho nút "In Phiếu Gọi Món" (Gửi bếp + Tạo thông báo)
        /// </summary>
        [HttpPost("print-and-notify-kitchen/{idHoaDon}/{idNhanVien}")]
        public async Task<IActionResult> PrintAndNotifyKitchen(int idHoaDon, int idNhanVien)
        {
            try
            {
                // 1. Gửi các món mới vào bếp
                await CreateOrUpdateCheBienItems(idHoaDon);

                // 2. Tạo thông báo
                var hoaDon = await _context.HoaDons.Include(h => h.Ban).FirstOrDefaultAsync(h => h.IdHoaDon == idHoaDon);
                string soBan = hoaDon?.Ban?.SoBan ?? hoaDon?.LoaiHoaDon ?? "Hóa đơn";

                var thongBao = new ThongBao
                {
                    IdNhanVienTao = idNhanVien,
                    NoiDung = $"Phiếu gọi món mới cho [{soBan}].",
                    ThoiGianTao = DateTime.Now,
                    LoaiThongBao = "PhieuGoiMon", // Theo yêu cầu
                    IdLienQuan = idHoaDon,
                    DaXem = false
                };
                _context.ThongBaos.Add(thongBao);

                await _context.SaveChangesAsync();

                return Ok(new { message = "Đã gửi phiếu gọi món và thông báo cho bếp." });
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Lỗi khi in và gửi bếp: {ex.Message}");
            }
        }

        /// <summary>
        /// API MỚI: Lấy dữ liệu cho cửa sổ In Tạm Tính
        /// </summary>
        [HttpGet("print-data/{idHoaDon}")]
        public async Task<IActionResult> GetPrintData(int idHoaDon)
        {
            var hoaDon = await _context.HoaDons
                .Include(h => h.Ban)
                .Include(h => h.NhanVien)
                .Include(h => h.ChiTietHoaDons).ThenInclude(ct => ct.SanPham)
                .AsNoTracking()
                .FirstOrDefaultAsync(h => h.IdHoaDon == idHoaDon);

            if (hoaDon == null) return NotFound();

            var settings = await _context.CaiDats.ToListAsync();

            var dto = new PhieuGoiMonPrintDto
            {
                IdPhieu = $"HD{hoaDon.IdHoaDon:D6}",
                TenQuan = settings.FirstOrDefault(c => c.TenCaiDat == "TenQuan")?.GiaTri ?? "Cafebook",
                DiaChiQuan = settings.FirstOrDefault(c => c.TenCaiDat == "DiaChi")?.GiaTri ?? "N/A",
                SdtQuan = settings.FirstOrDefault(c => c.TenCaiDat == "SoDienThoai")?.GiaTri ?? "N/A",
                NgayTao = hoaDon.ThoiGianTao,
                TenNhanVien = hoaDon.NhanVien.HoTen,
                SoBan = hoaDon.Ban?.SoBan ?? hoaDon.LoaiHoaDon,
                ChiTiet = hoaDon.ChiTietHoaDons.Select(ct => new ChiTietDto
                {
                    TenSanPham = ct.SanPham.TenSanPham,
                    SoLuong = ct.SoLuong,
                    DonGia = ct.DonGia,
                    ThanhTien = ct.ThanhTien
                }).ToList(),
                TongTienGoc = hoaDon.TongTienGoc,
                GiamGia = hoaDon.GiamGia,
                ThanhTien = hoaDon.ThanhTien
            };

            return Ok(dto);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\NhanVien\KhuyenMaiController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp.NhanVien;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App.NhanVien
{
    [Route("api/app/nhanvien/khuyenmai")]
    [ApiController]
    public class KhuyenMaiController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public KhuyenMaiController(CafebookDbContext context)
        {
            _context = context;
        }

        [HttpGet("available/{idHoaDon}")]
        public async Task<IActionResult> GetAvailablePromotions(int idHoaDon)
        {
            var hoaDon = await _context.HoaDons
                .Include(h => h.ChiTietHoaDons)
                .FirstOrDefaultAsync(h => h.IdHoaDon == idHoaDon);

            if (hoaDon == null) return NotFound("Không tìm thấy hóa đơn.");

            var now = DateTime.Now;

            // === SỬA LỖI TRANSLATE ===
            // 1. Tải toàn bộ KM về bộ nhớ (Client Evaluation)
            var allKms = await _context.KhuyenMais.ToListAsync();

            var resultList = new List<KhuyenMaiHienThiDto>();

            // 2. Dùng C# để lọc (Where) thay vì SQL
            foreach (var km in allKms)
            {
                // YÊU CẦU: "các khuyến mãi Tạm dừng , Hết hạn sẽ không hiển thị"
                if (!string.Equals(km.TrangThai, "Hoạt động", StringComparison.OrdinalIgnoreCase) ||
                    km.NgayBatDau > now ||
                    km.NgayKetThuc < now)
                {
                    continue; // Bỏ qua nếu không hợp lệ về trạng thái/ngày
                }

                var (isEligible, reason, discountValue) = CheckEligibility(km, hoaDon, now);

                var dto = new KhuyenMaiHienThiDto
                {
                    IdKhuyenMai = km.IdKhuyenMai,
                    MaKhuyenMai = km.MaKhuyenMai,
                    TenChuongTrinh = km.TenChuongTrinh,
                    DieuKienApDung = string.IsNullOrEmpty(km.DieuKienApDung) ? km.MoTa : km.DieuKienApDung,
                    LoaiGiamGia = km.LoaiGiamGia,
                    GiaTriGiam = km.GiaTriGiam,
                    GiamToiDa = km.GiamToiDa,

                    IsEligible = isEligible,
                    IneligibilityReason = reason,
                    CalculatedDiscount = discountValue
                };
                resultList.Add(dto);
            }
            // === KẾT THÚC SỬA LỖI ===

            return Ok(resultList
                .OrderByDescending(k => k.IsEligible)
                .ThenByDescending(k => k.CalculatedDiscount)
                .ThenBy(k => k.TenChuongTrinh));
        }

        // Sửa: Hàm kiểm tra trả về 3 giá trị
        private (bool IsEligible, string? Reason, decimal CalculatedDiscount) CheckEligibility(KhuyenMai km, HoaDon hoaDon, DateTime now)
        {
            decimal calculatedDiscount = 0m;

            // Logic dựa trên mô tả của bạn
            if (!string.Equals(km.TrangThai, "Hoạt động", StringComparison.OrdinalIgnoreCase))
                return (false, "Khuyến mãi đã bị tạm ngưng.", 0);
            if (km.NgayBatDau > now)
                return (false, $"Chưa tới ngày (Bắt đầu từ {km.NgayBatDau:dd/MM}).", 0);
            if (km.NgayKetThuc < now)
                return (false, $"Đã hết hạn (Kết thúc lúc {km.NgayKetThuc:dd/MM}).", 0);
            if (km.SoLuongConLai.HasValue && km.SoLuongConLai <= 0)
                return (false, "Đã hết lượt sử dụng.", 0);
            if (km.HoaDonToiThieu.HasValue && km.HoaDonToiThieu > 0 && hoaDon.TongTienGoc < km.HoaDonToiThieu.Value)
                return (false, $"Cần hóa đơn tối thiểu {km.HoaDonToiThieu.Value:N0} đ.", 0);
            if (km.GioBatDau.HasValue && km.GioKetThuc.HasValue && (now.TimeOfDay < km.GioBatDau || now.TimeOfDay > km.GioKetThuc))
                return (false, $"Chỉ áp dụng trong khung giờ {km.GioBatDau} - {km.GioKetThuc}.", 0);

            if (!string.IsNullOrWhiteSpace(km.NgayTrongTuan))
            {
                string homNay = "";
                switch (now.DayOfWeek)
                {
                    case DayOfWeek.Monday: homNay = "Thứ 2"; break;
                    case DayOfWeek.Tuesday: homNay = "Thứ 3"; break;
                    case DayOfWeek.Wednesday: homNay = "Thứ 4"; break;
                    case DayOfWeek.Thursday: homNay = "Thứ 5"; break;
                    case DayOfWeek.Friday: homNay = "Thứ 6"; break;
                    case DayOfWeek.Saturday: homNay = "Thứ 7"; break;
                    case DayOfWeek.Sunday: homNay = "Chủ nhật"; break;
                }
                var ngayHopLe = km.NgayTrongTuan.Split(new[] { ',', ';' }, StringSplitOptions.RemoveEmptyEntries).Select(d => d.Trim());
                if (!ngayHopLe.Contains(homNay, StringComparer.OrdinalIgnoreCase))
                {
                    return (false, $"Chỉ áp dụng vào {km.NgayTrongTuan}.", 0);
                }
            }

            // Tính toán giá trị giảm
            decimal tongTienGocChoKM = hoaDon.TongTienGoc;
            if (km.IdSanPhamApDung.HasValue)
            {
                if (!hoaDon.ChiTietHoaDons.Any(c => c.IdSanPham == km.IdSanPhamApDung.Value))
                {
                    var sp = _context.SanPhams.Find(km.IdSanPhamApDung.Value);
                    return (false, $"Chỉ áp dụng cho sản phẩm '{sp?.TenSanPham}'.", 0);
                }
                // Nếu có, chỉ tính tiền các SP đó
                tongTienGocChoKM = hoaDon.ChiTietHoaDons
                    .Where(c => c.IdSanPham == km.IdSanPhamApDung.Value)
                    .Sum(c => c.ThanhTien);
            }

            // Tính toán
            if (string.Equals(km.LoaiGiamGia, "PhanTram", StringComparison.OrdinalIgnoreCase))
            {
                calculatedDiscount = tongTienGocChoKM * (km.GiaTriGiam / 100);
                if (km.GiamToiDa.HasValue && calculatedDiscount > km.GiamToiDa.Value)
                {
                    calculatedDiscount = km.GiamToiDa.Value;
                }
            }
            else // SoTien
            {
                calculatedDiscount = km.GiaTriGiam;
            }

            return (true, null, calculatedDiscount); // Hợp lệ
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\NhanVien\LichLamViecController.cs
================================================================================
﻿// Tệp: CafebookApi/Controllers/App/NhanVien/LichLamViecController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelApp.NhanVien;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Security.Claims;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App.NhanVien
{
    [Route("api/app/nhanvien/lichlamviec")]
    [ApiController]
    [Authorize]
    public class LichLamViecController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public LichLamViecController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// Lấy lịch làm việc cho 1 tuần (hoặc 1 ngày)
        /// </summary>
        [HttpGet("tuan")]
        public async Task<IActionResult> GetLichLamViecTuan([FromQuery] DateTime ngayTrongTuan)
        {
            try
            {
                int idNhanVien = GetCurrentUserId();
                if (idNhanVien == 0) return Unauthorized();

                // 1. Tính toán ngày (Thứ 2 - Chủ Nhật)
                int diff = (7 + (int)ngayTrongTuan.DayOfWeek - (int)DayOfWeek.Monday) % 7;
                var startOfWeek = ngayTrongTuan.AddDays(-1 * diff).Date;
                var endOfWeek = startOfWeek.AddDays(6).Date;

                // 2. Truy vấn Lịch Làm Việc (Ca làm)
                var lichLamViec = await _context.LichLamViecs
                    .Include(l => l.CaLamViec)
                    .Where(l => l.IdNhanVien == idNhanVien &&
                                l.NgayLam >= startOfWeek &&
                                l.NgayLam <= endOfWeek &&
                                l.CaLamViec != null)
                    .Select(l => new LichLamViecItemDto
                    {
                        IdLichLamViec = l.IdLichLamViec,
                        TenCa = l.CaLamViec.TenCa,
                        NgayLam = l.NgayLam,
                        GioBatDau = l.CaLamViec.GioBatDau,
                        GioKetThuc = l.CaLamViec.GioKetThuc
                    })
                    .ToListAsync();

                // 3. Truy vấn Đơn Xin Nghỉ (Đã duyệt)
                var donNghi = await _context.DonXinNghis
                    .Where(d => d.IdNhanVien == idNhanVien &&
                                d.TrangThai == "Đã duyệt" &&
                                d.NgayBatDau <= endOfWeek &&
                                d.NgayKetThuc >= startOfWeek)
                    .Select(d => new LichNghiItemDto
                    {
                        LoaiDon = d.LoaiDon,
                        NgayBatDau = d.NgayBatDau,
                        NgayKetThuc = d.NgayKetThuc
                    })
                    .ToListAsync();

                // 4. Tạo DTO trả về
                var responseDto = new LichLamViecViewDto
                {
                    NgayBatDauTuan = startOfWeek,
                    NgayKetThucTuan = endOfWeek,
                    LichLamViecTrongTuan = lichLamViec,
                    DonNghiTrongTuan = donNghi
                };

                return Ok(responseDto);
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Lỗi máy chủ: {ex.Message}");
            }
        }

        /// <summary>
        /// THÊM MỚI: Lấy lịch làm việc cho 1 tháng
        /// </summary>
        [HttpGet("thang")]
        public async Task<IActionResult> GetLichLamViecThang([FromQuery] DateTime ngayTrongThang)
        {
            try
            {
                int idNhanVien = GetCurrentUserId();
                if (idNhanVien == 0) return Unauthorized();

                var startOfMonth = new DateTime(ngayTrongThang.Year, ngayTrongThang.Month, 1);
                var endOfMonth = startOfMonth.AddMonths(1).AddDays(-1);

                // 1. Lấy ca làm
                var caLam = await _context.LichLamViecs
                    .Include(l => l.CaLamViec)
                    .Where(l => l.IdNhanVien == idNhanVien &&
                                l.NgayLam >= startOfMonth &&
                                l.NgayLam <= endOfMonth &&
                                l.CaLamViec != null)
                    .Select(l => new
                    {
                        l.NgayLam,
                        SuKien = $"{l.CaLamViec.TenCa} ({l.CaLamViec.GioBatDau:hh\\:mm}-{l.CaLamViec.GioKetThuc:hh\\:mm})"
                    })
                    .ToListAsync();

                // 2. Lấy đơn nghỉ
                var donNghi = await _context.DonXinNghis
                    .Where(d => d.IdNhanVien == idNhanVien &&
                                d.TrangThai == "Đã duyệt" &&
                                d.NgayBatDau <= endOfMonth &&
                                d.NgayKetThuc >= startOfMonth)
                    .ToListAsync();

                // 3. Tổng hợp 2 danh sách
                var allEvents = new List<dynamic>();
                allEvents.AddRange(caLam);

                // Mở rộng đơn nghỉ thành các ngày riêng lẻ
                foreach (var nghi in donNghi)
                {
                    for (DateTime day = nghi.NgayBatDau.Date; day <= nghi.NgayKetThuc.Date; day = day.AddDays(1))
                    {
                        if (day >= startOfMonth && day <= endOfMonth)
                        {
                            allEvents.Add(new { NgayLam = day, SuKien = nghi.LoaiDon });
                        }
                    }
                }

                // 4. Nhóm theo ngày
                var groupedEvents = allEvents
                    .GroupBy(e => e.NgayLam)
                    .Select(g => new LichLamViecNgayDto
                    {
                        Ngay = g.Key,
                        SuKien = g.Select(ev => (string)ev.SuKien).ToList()
                    })
                    .ToList();

                return Ok(new LichLamViecThangDto { NgayCoSuKien = groupedEvents });
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Lỗi máy chủ: {ex.Message}");
            }
        }


        // === HÀM HELPER ===
        private int GetCurrentUserId()
        {
            var idClaim = User.Claims.FirstOrDefault(c => c.Type == "IdNhanVien");
            if (idClaim != null && int.TryParse(idClaim.Value, out int idNhanVien))
            {
                return idNhanVien;
            }
            return 0;
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\NhanVien\PhieuLuongController.cs
================================================================================
﻿// Tệp: CafebookApi/Controllers/App/NhanVien/PhieuLuongController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelApp.NhanVien;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Linq;
using System.Security.Claims;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App.NhanVien
{
    [Route("api/app/nhanvien/phieuluong")]
    [ApiController]
    [Authorize]
    public class PhieuLuongController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public PhieuLuongController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// Lấy danh sách các phiếu lương đã chốt/đã phát của nhân viên
        /// </summary>
        [HttpGet("list")]
        public async Task<IActionResult> GetDanhSachPhieuLuong()
        {
            try
            {
                int idNhanVien = GetCurrentUserId();
                if (idNhanVien == 0) return Unauthorized();

                var list = await _context.PhieuLuongs
                    .Where(pl => pl.IdNhanVien == idNhanVien &&
                                 (pl.TrangThai == "Đã phát" || pl.TrangThai == "Đã chốt"))
                    .OrderByDescending(pl => pl.Nam)
                    .ThenByDescending(pl => pl.Thang)
                    .Select(pl => new PhieuLuongItemDto
                    {
                        IdPhieuLuong = pl.IdPhieuLuong,
                        Thang = pl.Thang,
                        Nam = pl.Nam,
                        ThucLanh = pl.ThucLanh,
                        TrangThai = pl.TrangThai
                    })
                    .ToListAsync();

                return Ok(new PhieuLuongViewDto { DanhSachPhieuLuong = list });
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Lỗi máy chủ: {ex.Message}");
            }
        }

        /// <summary>
        /// Lấy chi tiết một phiếu lương
        /// </summary>
        [HttpGet("detail/{idPhieuLuong}")]
        public async Task<IActionResult> GetChiTietPhieuLuong(int idPhieuLuong)
        {
            try
            {
                int idNhanVien = GetCurrentUserId();
                if (idNhanVien == 0) return Unauthorized();

                var phieuLuong = await _context.PhieuLuongs
                    .Include(pl => pl.NguoiPhat)
                    .AsNoTracking()
                    .FirstOrDefaultAsync(pl => pl.IdPhieuLuong == idPhieuLuong && pl.IdNhanVien == idNhanVien);

                if (phieuLuong == null)
                {
                    return NotFound("Không tìm thấy phiếu lương hoặc bạn không có quyền xem.");
                }

                // *** SỬA LỖI: Thêm .Select() tường minh ***
                // Thay vì tải toàn bộ đối tượng PhieuThuongPhat (gây lỗi),
                // chúng ta chỉ chọn các trường cần thiết vào DTO.
                var chiTietThuongPhat = await _context.PhieuThuongPhats
                    .Where(ptp => ptp.IdPhieuLuong == idPhieuLuong)
                    .AsNoTracking()
                    .Select(ptp => new PhieuThuongPhatItemDto // Chọn thẳng ra DTO
                    {
                        NgayTao = ptp.NgayTao,
                        SoTien = ptp.SoTien,
                        LyDo = ptp.LyDo,
                        TenNguoiTao = ptp.NguoiTao.HoTen // EF sẽ tự động join
                    })
                    .ToListAsync();
                // *** KẾT THÚC SỬA LỖI ***

                // Xây dựng DTO trả về
                var chiTietDto = new PhieuLuongChiTietDto
                {
                    IdPhieuLuong = phieuLuong.IdPhieuLuong,
                    Thang = phieuLuong.Thang,
                    Nam = phieuLuong.Nam,
                    LuongCoBan = phieuLuong.LuongCoBan,
                    TongGioLam = phieuLuong.TongGioLam,
                    TienLuongTheoGio = phieuLuong.LuongCoBan * phieuLuong.TongGioLam,
                    TongTienThuong = phieuLuong.TienThuong ?? 0,
                    TongKhauTru = phieuLuong.KhauTru ?? 0,
                    ThucLanh = phieuLuong.ThucLanh,
                    TrangThai = phieuLuong.TrangThai,
                    NgayPhatLuong = phieuLuong.NgayPhatLuong,
                    TenNguoiPhat = phieuLuong.NguoiPhat?.HoTen,

                    // SỬA: Dùng danh sách DTO đã được tạo ở trên
                    DanhSachThuong = chiTietThuongPhat
                        .Where(ptp => ptp.SoTien > 0)
                        .ToList(),

                    DanhSachPhat = chiTietThuongPhat
                        .Where(ptp => ptp.SoTien < 0)
                        .ToList()
                };

                return Ok(chiTietDto);
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Lỗi máy chủ: {ex.Message}");
            }
        }

        // === HÀM HELPER ===
        private int GetCurrentUserId()
        {
            var idClaim = User.Claims.FirstOrDefault(c => c.Type == "IdNhanVien");
            if (idClaim != null && int.TryParse(idClaim.Value, out int idNhanVien))
            {
                return idNhanVien;
            }
            return 0;
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\NhanVien\SoDoBanController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.Entities;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;
using System;
using CafebookModel.Model.ModelApp.NhanVien;
using System.Collections.Generic; // Thêm
using System.Net.Http; // <-- THÊM MỚI

namespace CafebookApi.Controllers.App.NhanVien
{


    [Route("api/app/sodoban")]
    [ApiController]
    public class SoDoBanController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private readonly IHttpClientFactory _clientFactory;
        public SoDoBanController(CafebookDbContext context, IHttpClientFactory clientFactory) // <-- SỬA HÀM KHỞI TẠO
        {
            _context = context;
            _clientFactory = clientFactory; // <-- THÊM MỚI
        }

        // === HÀM ĐÃ ĐƯỢC NÂNG CẤP (10 PHÚT) ===
        [HttpGet("tables")]
        public async Task<IActionResult> GetSoDoBan()
        {
            // === SỬA BƯỚC NÀY ===
            // Chạy logic tự động huỷ TRƯỚC KHI lấy sơ đồ bàn
            // Bằng cách gọi API chuyên dụng của BackgroundJobController
            try
            {
                var client = _clientFactory.CreateClient();
                var request = new HttpRequestMessage(HttpMethod.Post, "http://localhost:5166/api/app/background/auto-cancel-late");
                await client.SendAsync(request);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Loi khi goi auto-cancel API: {ex.Message}");
            }
            // === KẾT THÚC SỬA ===

            var now = DateTime.Now;
            // SỬA: Đổi mốc thời gian thành 10 phút
            var nowPlus10Minutes = now.AddMinutes(10); // Mốc thời gian 10 phút

            var data = await _context.Bans
               .AsNoTracking()
               .Select(b => new
               {
                   // 1. Lấy thông tin bàn
                   Ban = b,

                   // 2. Lấy Hóa đơn hiện tại (nếu có)
                   HoaDonHienTai = _context.HoaDons
                       .Where(h => h.IdBan == b.IdBan && h.TrangThai == "Chưa thanh toán")
                       .Select(h => new { h.IdHoaDon, h.ThanhTien })
                       .FirstOrDefault(),

                   // 3. Lấy Phiếu đặt sắp tới GẦN NHẤT
                   PhieuDatSapToi = _context.PhieuDatBans
                       .Where(p => p.IdBan == b.IdBan &&
                                   p.ThoiGianDat > now && // Logic này vẫn đúng, chỉ tìm phiếu tương lai
                                   (p.TrangThai == "Đã xác nhận" || p.TrangThai == "Chờ xác nhận"))
                       .OrderBy(p => p.ThoiGianDat)
                       .FirstOrDefault()
               })
               // 4. Giờ mới tạo DTO
               .Select(data => new BanSoDoDto
               {
                   IdBan = data.Ban.IdBan,
                   SoBan = data.Ban.SoBan,

                   // === LOGIC TRẠNG THÁI MỚI (10 PHÚT) ===
                   TrangThai = (data.Ban.TrangThai == "Trống" &&
                                data.PhieuDatSapToi != null &&
                                // SỬA: Dùng mốc 10 phút
                                data.PhieuDatSapToi.ThoiGianDat <= nowPlus10Minutes)
                               ? "Đã đặt" // Tự động đổi "Trống" -> "Đã đặt" (Gần giờ)
                               : data.Ban.TrangThai, // Giữ nguyên (Trống, Có khách, Bảo trì)

                   GhiChu = data.Ban.GhiChu,
                   IdKhuVuc = data.Ban.IdKhuVuc,

                   // Gán từ HoaDonHienTai
                   IdHoaDonHienTai = data.HoaDonHienTai != null ? (int?)data.HoaDonHienTai.IdHoaDon : null,
                   TongTienHienTai = data.HoaDonHienTai != null ? data.HoaDonHienTai.ThanhTien : 0,

                   // === LOGIC THÔNG TIN ĐẶT BÀN MỚI ===
                   ThongTinDatBan = (data.Ban.TrangThai == "Trống" && data.PhieuDatSapToi != null)
                                    ? $"Đặt lúc: {data.PhieuDatSapToi.ThoiGianDat:HH:mm}" // Luôn hiển thị nếu có phiếu
                                    : null
               })
               .OrderBy(b => b.SoBan)
               .ToListAsync();

            return Ok(data);
        }

        // (Các hàm còn lại giữ nguyên)

        [HttpPost("createorder/{idBan}/{idNhanVien}")]
        public async Task<IActionResult> CreateOrder(int idBan, int idNhanVien)
        {
            var ban = await _context.Bans.FindAsync(idBan);
            if (ban == null) return NotFound("Không tìm thấy bàn.");
            if (ban.TrangThai != "Trống" && ban.TrangThai != "Đã đặt")
                return Conflict("Bàn này đang bận hoặc đang bảo trì.");
            var nhanVien = await _context.NhanViens.FindAsync(idNhanVien);
            if (nhanVien == null) return NotFound("Nhân viên không hợp lệ.");
            var hoaDon = new HoaDon
            {
                IdBan = idBan,
                IdNhanVien = idNhanVien,
                TrangThai = "Chưa thanh toán",
                LoaiHoaDon = "Tại quán",
                ThoiGianTao = DateTime.Now
            };
            _context.HoaDons.Add(hoaDon);
            ban.TrangThai = "Có khách";
            await _context.SaveChangesAsync();
            return Ok(new { idHoaDon = hoaDon.IdHoaDon });
        }

        [HttpPost("reportproblem/{idBan}/{idNhanVien}")]
        public async Task<IActionResult> BaoCaoSuCo(int idBan, int idNhanVien, [FromBody] BaoCaoSuCoRequestDto request)
        {
            var ban = await _context.Bans.FindAsync(idBan);
            if (ban == null) return NotFound("Không tìm thấy bàn.");
            if (ban.TrangThai == "Có khách")
                return Conflict("Không thể báo cáo sự cố bàn đang có khách.");
            ban.TrangThai = "Bảo trì";
            ban.GhiChu = $"[Sự cố NV báo]: {request.GhiChuSuCo}";
            var thongBao = new ThongBao
            {
                IdNhanVienTao = idNhanVien,
                NoiDung = $"Bàn {ban.SoBan} vừa được báo cáo sự cố: {request.GhiChuSuCo}",
                LoaiThongBao = "SuCoBan",
                IdLienQuan = idBan,
                ThoiGianTao = DateTime.Now,
                DaXem = false
            };
            _context.ThongBaos.Add(thongBao);
            await _context.SaveChangesAsync();
            return Ok(new { message = "Báo cáo sự cố thành công. Bàn đã được khóa." });
        }

        [HttpPost("createorder-no-table/{idNhanVien}")]
        public async Task<IActionResult> CreateOrderNoTable(int idNhanVien, [FromBody] string loaiHoaDon)
        {
            if (loaiHoaDon != "Mang về" && loaiHoaDon != "Tại quán")
                return BadRequest("Loại hóa đơn không hợp lệ.");

            var nhanVien = await _context.NhanViens.FindAsync(idNhanVien);
            if (nhanVien == null) return NotFound("Nhân viên không hợp lệ.");
            var hoaDon = new HoaDon
            {
                IdBan = null,
                IdNhanVien = idNhanVien,
                TrangThai = "Chưa thanh toán",
                LoaiHoaDon = loaiHoaDon,
                ThoiGianTao = DateTime.Now
            };
            _context.HoaDons.Add(hoaDon);
            await _context.SaveChangesAsync();
            return Ok(new { idHoaDon = hoaDon.IdHoaDon });
        }

        [HttpPost("move-table")]
        public async Task<IActionResult> MoveTable([FromBody] BanActionRequestDto dto)
        {
            var hoaDon = await _context.HoaDons.Include(h => h.Ban).FirstOrDefaultAsync(h => h.IdHoaDon == dto.IdHoaDonNguon);
            if (hoaDon == null) return NotFound("Không tìm thấy hóa đơn nguồn.");
            var banDich = await _context.Bans.FindAsync(dto.IdBanDich);
            if (banDich == null) return NotFound("Không tìm thấy bàn đích.");
            if (banDich.TrangThai != "Trống") return Conflict("Bàn đích đang bận, không thể chuyển đến.");
            if (hoaDon.Ban != null) hoaDon.Ban.TrangThai = "Trống";
            banDich.TrangThai = "Có khách";
            hoaDon.IdBan = dto.IdBanDich;
            await _context.SaveChangesAsync();
            return Ok(new { message = "Chuyển bàn thành công." });
        }


        [HttpPost("merge-table")]
        public async Task<IActionResult> MergeTable([FromBody] BanActionRequestDto dto)
        {
            if (dto.IdHoaDonNguon == dto.IdHoaDonDich)
                return BadRequest("Không thể gộp bàn vào chính nó.");

            var chiTietNguon = await _context.ChiTietHoaDons
                .Where(c => c.IdHoaDon == dto.IdHoaDonNguon)
                .ToListAsync();

            if (!chiTietNguon.Any())
                return BadRequest("Bàn nguồn không có sản phẩm để gộp.");

            var hoaDonNguon = await _context.HoaDons
                .Include(h => h.Ban)
                .FirstOrDefaultAsync(h => h.IdHoaDon == dto.IdHoaDonNguon);

            if (hoaDonNguon == null) return NotFound("Không tìm thấy hóa đơn nguồn.");

            if (!dto.IdHoaDonDich.HasValue ||
                !await _context.HoaDons.AnyAsync(h => h.IdHoaDon == dto.IdHoaDonDich.Value))
            {
                return NotFound("Không tìm thấy hóa đơn đích.");
            }

            foreach (var ct in chiTietNguon)
            {
                ct.IdHoaDon = dto.IdHoaDonDich.Value;
            }

            if (hoaDonNguon.Ban != null)
            {
                hoaDonNguon.Ban.TrangThai = "Trống";
            }

            _context.HoaDons.Remove(hoaDonNguon);

            await _context.SaveChangesAsync();
            return Ok(new { message = "Gộp bàn thành công." });
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\NhanVien\ThanhToanController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp.NhanVien;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Mail; // THÊM MỚI để kiểm tra email
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App.NhanVien
{
    [Route("api/app/nhanvien/thanhtoan")]
    [ApiController]
    public class ThanhToanController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private decimal _tiLeDoiDiem = 1000m;
        private decimal _tiLeNhanDiem = 10000m;
        private Dictionary<string, string> _settings = new Dictionary<string, string>();

        public ThanhToanController(CafebookDbContext context)
        {
            _context = context;
        }

        // Hàm helper tải cài đặt
        private async Task LoadCaiDat()
        {
            _settings = await _context.CaiDats
                .Where(c =>
                    c.TenCaiDat == "DiemTichLuy_DoiVND" ||
                    c.TenCaiDat == "DiemTichLuy_NhanVND" ||
                    c.TenCaiDat == "TenQuan" ||
                    c.TenCaiDat == "DiaChi" ||
                    c.TenCaiDat == "SoDienThoai" ||
                    c.TenCaiDat == "Wifi_MatKhau")
                .AsNoTracking()
                .ToDictionaryAsync(c => c.TenCaiDat, c => c.GiaTri);

            decimal.TryParse(_settings.GetValueOrDefault("DiemTichLuy_DoiVND", "1000"), out _tiLeDoiDiem);
            decimal.TryParse(_settings.GetValueOrDefault("DiemTichLuy_NhanVND", "10000"), out _tiLeNhanDiem);
            if (_tiLeNhanDiem == 0) _tiLeNhanDiem = 10000;
            if (_tiLeDoiDiem == 0) _tiLeDoiDiem = 1000;
        }

        /// <summary>
        /// Tải dữ liệu cho màn hình ThanhToanView
        /// </summary>
        [HttpGet("load/{idHoaDon}")]
        public async Task<IActionResult> LoadThanhToanData(int idHoaDon)
        {
            await LoadCaiDat(); // Tải cài đặt

            var hoaDon = await _context.HoaDons
                .Include(h => h.Ban)
                .AsNoTracking()
                .FirstOrDefaultAsync(h => h.IdHoaDon == idHoaDon);

            if (hoaDon == null) return NotFound("Không tìm thấy hóa đơn.");

            var hoaDonInfo = new HoaDonInfoDto
            {
                IdHoaDon = hoaDon.IdHoaDon,
                SoBan = hoaDon.Ban?.SoBan ?? hoaDon.LoaiHoaDon,
                LoaiHoaDon = hoaDon.LoaiHoaDon,
                TongTienGoc = hoaDon.TongTienGoc,
                GiamGia = hoaDon.GiamGia,
                ThanhTien = hoaDon.ThanhTien,
            };

            var chiTietItems = await _context.ChiTietHoaDons
                .Where(c => c.IdHoaDon == idHoaDon)
                .AsNoTracking()
                .Select(c => new ChiTietDto
                {
                    IdChiTietHoaDon = c.IdChiTietHoaDon,
                    IdSanPham = c.IdSanPham,
                    TenSanPham = c.SanPham.TenSanPham,
                    SoLuong = c.SoLuong,
                    DonGia = c.DonGia,
                    ThanhTien = c.ThanhTien
                }).ToListAsync();

            var phuThusDaApDung = await _context.ChiTietPhuThuHoaDons
                .Where(pt => pt.IdHoaDon == idHoaDon)
                .AsNoTracking()
                .Select(pt => new PhuThuDto
                {
                    IdPhuThu = pt.IdPhuThu,
                    TenPhuThu = pt.PhuThu.TenPhuThu,
                    SoTien = pt.SoTien,
                    LoaiGiaTri = pt.PhuThu.LoaiGiaTri,
                    GiaTri = pt.PhuThu.GiaTri
                }).ToListAsync();

            var idPhuThuDaApDung = phuThusDaApDung.Select(p => p.IdPhuThu);
            var phuThusKhaDung = await _context.PhuThus
                .Where(p => !idPhuThuDaApDung.Contains(p.IdPhuThu))
                .AsNoTracking()
                .ToListAsync();

            var khuyenMaiLink = await _context.HoaDonKhuyenMais
                .AsNoTracking()
                .FirstOrDefaultAsync(hkm => hkm.IdHoaDon == idHoaDon);

            KhachHang? khachHang = null;
            if (hoaDon.IdKhachHang.HasValue)
            {
                khachHang = await _context.KhachHangs.AsNoTracking().FirstOrDefaultAsync(kh => kh.IdKhachHang == hoaDon.IdKhachHang.Value);
            }

            var khachHangsList = await _context.KhachHangs
                .AsNoTracking()
                .Select(kh => new KhachHangTimKiemDto
                {
                    IdKhachHang = kh.IdKhachHang,
                    // SỬA: Chỉ dùng HoTen và SoDienThoai
                    DisplayText = kh.HoTen + (kh.SoDienThoai != null ? $" - {kh.SoDienThoai}" : ""),
                    KhachHangData = kh
                }).ToListAsync();

            return Ok(new ThanhToanViewDto
            {
                HoaDonInfo = hoaDonInfo,
                ChiTietItems = chiTietItems,
                IdKhuyenMaiDaApDung = khuyenMaiLink?.IdKhuyenMai, // Trả về ID
                PhuThusDaApDung = phuThusDaApDung,
                PhuThusKhaDung = phuThusKhaDung,
                KhachHang = khachHang,
                KhachHangsList = khachHangsList, // Trả về DS Khách hàng
                DiemTichLuy_DoiVND = _tiLeDoiDiem,
                DiemTichLuy_NhanVND = _tiLeNhanDiem,

                TenQuan = _settings.GetValueOrDefault("TenQuan", "CafeBook"),
                DiaChi = _settings.GetValueOrDefault("DiaChi", "N/A"),
                SoDienThoai = _settings.GetValueOrDefault("SoDienThoai", "N/A"),
                WifiMatKhau = _settings.GetValueOrDefault("Wifi_MatKhau", "N/A")
            });
        }

        // Trong file: ThanhToanController.cs
        // THAY THẾ HÀM CŨ BẰNG HÀM NÀY:

        [HttpPost("find-or-create-customer")]
        public async Task<IActionResult> FindOrCreateCustomer([FromBody] string query)
        {
            if (string.IsNullOrWhiteSpace(query))
            {
                return Ok(null); // Không nhập -> Khách vãng lai
            }

            // 1. Chỉ tìm kiếm theo SĐT
            var khachHang = await _context.KhachHangs
                .FirstOrDefaultAsync(kh => kh.SoDienThoai == query);

            if (khachHang != null)
            {
                // 1.1. Nếu tìm thấy, trả về
                var khDto = new KhachHangTimKiemDto
                {
                    IdKhachHang = khachHang.IdKhachHang,
                    DisplayText = khachHang.HoTen + $" - {khachHang.SoDienThoai}",
                    KhachHangData = khachHang,
                    IsNew = false
                };
                return Ok(khDto);
            }

            // 2. Không tìm thấy -> Kiểm tra xem có phải SĐT hợp lệ không
            if (IsValidPhone(query))
            {
                // 2.1. Nếu là SĐT hợp lệ -> Tạo tài khoản mới
                var newKhachHang = new KhachHang
                {
                    HoTen = $"Khách SĐT {query}",
                    SoDienThoai = query,

                    // === SỬA LỖI DATABASE (UNIQUE KEY) ===
                    // Cung cấp giá trị mặc định duy nhất thay vì NULL
                    Email = $"{query}@temp.cafebook.com",
                    TenDangNhap = query,
                    // === KẾT THÚC SỬA LỖI ===
                    MatKhau = "123456", // Mật khẩu tạm thời
                    TaiKhoanTam = true,
                    NgayTao = DateTime.Now,
                    DiemTichLuy = 0,
                    BiKhoa = false
                };

                _context.KhachHangs.Add(newKhachHang);
                await _context.SaveChangesAsync(); // Dòng 185 (dòng gây lỗi) giờ sẽ chạy được

                // 3. Đóng gói DTO cho khách hàng vừa tạo
                var newKhachHangDto = new KhachHangTimKiemDto
                {
                    IdKhachHang = newKhachHang.IdKhachHang,
                    DisplayText = newKhachHang.HoTen + $" - {newKhachHang.SoDienThoai}",
                    KhachHangData = newKhachHang,
                    IsNew = true
                };
                return Ok(newKhachHangDto);
            }
            else
            {
                // 2.3. Nếu là Tên hoặc Email -> KHÔNG TẠO, coi như khách vãng lai
                return Ok(null);
            }
        }

        [HttpPost("pay")]
        public async Task<IActionResult> ProcessPayment([FromBody] ThanhToanRequestDto req)
        {
            await LoadCaiDat();

            var hoaDonGoc = await _context.HoaDons
                .Include(h => h.Ban)
                .Include(h => h.ChiTietHoaDons)
                .Include(h => h.ChiTietPhuThuHoaDons)
                .FirstOrDefaultAsync(h => h.IdHoaDon == req.IdHoaDonGoc);

            if (hoaDonGoc == null) return NotFound("Không tìm thấy hóa đơn gốc.");
            if (hoaDonGoc.TrangThai != "Chưa thanh toán") return Conflict("Hóa đơn này đã được xử lý.");

            var allItemsGocIds = hoaDonGoc.ChiTietHoaDons.Select(c => c.IdChiTietHoaDon).ToList();
            bool isFullPayment = allItemsGocIds.Count == req.IdChiTietTach.Count && allItemsGocIds.All(req.IdChiTietTach.Contains);

            HoaDon hoaDonThanhToan;

            var chiTietTach = hoaDonGoc.ChiTietHoaDons
                .Where(c => req.IdChiTietTach.Contains(c.IdChiTietHoaDon)).ToList();

            var phuThuDaApDungGoc = hoaDonGoc.ChiTietPhuThuHoaDons
                .Where(pt => req.IdPhuThuTach.Contains(pt.IdPhuThu)).ToList();
            var idPhuThuMoi = req.IdPhuThuTach.Where(id => !phuThuDaApDungGoc.Any(pt => pt.IdPhuThu == id)).ToList();
            var phuThuMoi = await _context.PhuThus.Where(p => idPhuThuMoi.Contains(p.IdPhuThu)).ToListAsync();

            if (isFullPayment)
            {
                hoaDonThanhToan = hoaDonGoc;
                if (req.IdKhachHang.HasValue)
                    hoaDonThanhToan.IdKhachHang = req.IdKhachHang;

                decimal tongTienGocMoi = chiTietTach.Sum(c => c.ThanhTien);
                hoaDonThanhToan.TongTienGoc = tongTienGocMoi;

                decimal tongPhuThuMoi = 0;

                foreach (var phuThu in phuThuDaApDungGoc)
                {
                    tongPhuThuMoi += phuThu.SoTien;
                }

                foreach (var ptMoi in phuThuMoi)
                {
                    decimal soTienPT = string.Equals(ptMoi.LoaiGiaTri, "%", StringComparison.OrdinalIgnoreCase)
                        ? (tongTienGocMoi * (ptMoi.GiaTri / 100))
                        : ptMoi.GiaTri;

                    _context.ChiTietPhuThuHoaDons.Add(new ChiTietPhuThuHoaDon
                    {
                        IdHoaDon = hoaDonThanhToan.IdHoaDon,
                        IdPhuThu = ptMoi.IdPhuThu,
                        SoTien = soTienPT
                    });
                    tongPhuThuMoi += soTienPT;
                }

                hoaDonThanhToan.TongPhuThu = tongPhuThuMoi;
            }
            else
            {
                hoaDonThanhToan = new HoaDon
                {
                    IdBan = hoaDonGoc.IdBan,
                    IdNhanVien = hoaDonGoc.IdNhanVien,
                    IdKhachHang = req.IdKhachHang,
                    ThoiGianTao = hoaDonGoc.ThoiGianTao,
                    LoaiHoaDon = hoaDonGoc.LoaiHoaDon,
                    GhiChu = $"Tách từ HĐ #{hoaDonGoc.IdHoaDon}"
                };
                _context.HoaDons.Add(hoaDonThanhToan);
                await _context.SaveChangesAsync();

                decimal tongTienTach = 0;
                foreach (var chiTiet in chiTietTach)
                {
                    chiTiet.IdHoaDon = hoaDonThanhToan.IdHoaDon;
                    tongTienTach += chiTiet.ThanhTien;
                    hoaDonGoc.ChiTietHoaDons.Remove(chiTiet);
                }
                hoaDonThanhToan.TongTienGoc = tongTienTach;

                decimal tongPhuThuTach = 0;
                foreach (var phuThu in phuThuDaApDungGoc)
                {
                    phuThu.IdHoaDon = hoaDonThanhToan.IdHoaDon;
                    tongPhuThuTach += phuThu.SoTien;
                    hoaDonGoc.ChiTietPhuThuHoaDons.Remove(phuThu);
                }
                foreach (var ptMoi in phuThuMoi)
                {
                    decimal soTienPT = string.Equals(ptMoi.LoaiGiaTri, "%", StringComparison.OrdinalIgnoreCase)
                        ? (tongTienTach * (ptMoi.GiaTri / 100))
                        : ptMoi.GiaTri;
                    _context.ChiTietPhuThuHoaDons.Add(new ChiTietPhuThuHoaDon
                    {
                        IdHoaDon = hoaDonThanhToan.IdHoaDon,
                        IdPhuThu = ptMoi.IdPhuThu,
                        SoTien = soTienPT
                    });
                    tongPhuThuTach += soTienPT;
                }
                hoaDonThanhToan.TongPhuThu = tongPhuThuTach;

                hoaDonGoc.TongTienGoc = hoaDonGoc.ChiTietHoaDons.Sum(c => c.ThanhTien);
                hoaDonGoc.TongPhuThu = hoaDonGoc.ChiTietPhuThuHoaDons.Sum(pt => pt.SoTien);
            }

            decimal giamGiaKM = 0;
            decimal giamGiaDiem = 0;

            if (req.IdKhuyenMai.HasValue && req.IdKhuyenMai > 0)
            {
                var km = await _context.KhuyenMais.FindAsync(req.IdKhuyenMai.Value);
                if (km != null)
                {
                    giamGiaKM = await CalculateDiscount(km, hoaDonThanhToan.TongTienGoc, chiTietTach);

                    var existingLink = await _context.HoaDonKhuyenMais
                        .AsNoTracking()
                        .FirstOrDefaultAsync(hkm => hkm.IdHoaDon == hoaDonThanhToan.IdHoaDon && hkm.IdKhuyenMai == km.IdKhuyenMai);

                    if (existingLink == null)
                    {
                        _context.HoaDonKhuyenMais.Add(new HoaDon_KhuyenMai { IdHoaDon = hoaDonThanhToan.IdHoaDon, IdKhuyenMai = km.IdKhuyenMai });
                        if (km.SoLuongConLai.HasValue && km.SoLuongConLai > 0) km.SoLuongConLai -= 1;
                    }
                }
            }

            KhachHang? khachHang = null;
            if (req.IdKhachHang.HasValue)
            {
                khachHang = await _context.KhachHangs.FindAsync(req.IdKhachHang.Value);
            }

            if (khachHang != null && req.DiemSuDung > 0)
            {
                if (khachHang.DiemTichLuy < req.DiemSuDung)
                    return BadRequest("Khách hàng không đủ điểm tích lũy.");

                giamGiaDiem = req.DiemSuDung * _tiLeDoiDiem;

                decimal tongTruocDiem = hoaDonThanhToan.TongTienGoc + hoaDonThanhToan.TongPhuThu - giamGiaKM;

                if (giamGiaDiem > tongTruocDiem)
                {
                    giamGiaDiem = tongTruocDiem;
                    req.DiemSuDung = (int)Math.Ceiling(giamGiaDiem / _tiLeDoiDiem);
                }

                khachHang.DiemTichLuy -= req.DiemSuDung;
                hoaDonThanhToan.IdKhachHang = khachHang.IdKhachHang;
            }

            hoaDonThanhToan.GiamGia = giamGiaKM + giamGiaDiem;

            if (hoaDonThanhToan.IdNhanVien.HasValue)
            {
                await TruKho(hoaDonThanhToan.IdNhanVien.Value, chiTietTach);
            }
            else
            {
                // Trường hợp này không nên xảy ra ở App WPF,
                // nhưng chúng ta vẫn nên ghi log hoặc báo lỗi
                throw new InvalidOperationException("Không thể trừ kho vì hoá đơn thiếu IdNhanVien.");
            }

            hoaDonThanhToan.TrangThai = "Đã thanh toán";
            hoaDonThanhToan.ThoiGianThanhToan = DateTime.Now;
            hoaDonThanhToan.PhuongThucThanhToan = req.PhuongThucThanhToan;

            await _context.SaveChangesAsync();

            _context.GiaoDichThanhToans.Add(new GiaoDichThanhToan
            {
                IdHoaDon = hoaDonThanhToan.IdHoaDon,
                MaGiaoDichNgoai = $"HD_{hoaDonThanhToan.IdHoaDon}_{DateTime.Now:HHmmss}",
                CongThanhToan = req.PhuongThucThanhToan,
                SoTien = hoaDonThanhToan.ThanhTien,
                ThoiGianGiaoDich = (DateTime)hoaDonThanhToan.ThoiGianThanhToan,
                TrangThai = "Thành công"
            });

            if (khachHang != null && _tiLeNhanDiem > 0)
            {
                if (req.DiemSuDung == 0)
                {
                    int diemMoi = (int)Math.Floor(hoaDonThanhToan.ThanhTien / _tiLeNhanDiem);
                    if (diemMoi > 0)
                    {
                        khachHang.DiemTichLuy += diemMoi;
                    }
                }
            }

            bool hoaDonGocDaThanhToanHet = false;

            if (isFullPayment || (hoaDonGoc.TongTienGoc == 0 && hoaDonGoc.TongPhuThu == 0))
            {
                hoaDonGocDaThanhToanHet = true;
                if (hoaDonGoc.Ban != null)
                {
                    hoaDonGoc.Ban.TrangThai = "Trống";
                }
                if (!isFullPayment)
                {
                    hoaDonGoc.TrangThai = "Đã hủy";
                }
            }

            await _context.SaveChangesAsync();
            return Ok(new
            {
                message = "Thanh toán thành công!",
                isFullPayment = hoaDonGocDaThanhToanHet, // Trả về cờ này
                idHoaDonDaThanhToan = hoaDonThanhToan.IdHoaDon
            });
        }

        #region Hàm Helper (Trừ kho, Tính KM, Validate)

        private async Task TruKho(int idNhanVien, ICollection<ChiTietHoaDon> chiTietList)
        {
            foreach (var chiTiet in chiTietList)
            {
                var dinhLuongList = await _context.DinhLuongs
                    .Include(d => d.NguyenLieu)
                    .Include(d => d.DonViSuDung)
                    .Where(d => d.IdSanPham == chiTiet.IdSanPham)
                    .ToListAsync();

                foreach (var dl in dinhLuongList)
                {
                    if (dl.NguyenLieu != null && dl.DonViSuDung != null)
                    {
                        var nguyenLieu = dl.NguyenLieu;
                        decimal luongCanTru = (dl.SoLuongSuDung * dl.DonViSuDung.GiaTriQuyDoi) * chiTiet.SoLuong;
                        nguyenLieu.TonKho -= luongCanTru;

                        if (nguyenLieu.TonKho <= nguyenLieu.TonKhoToiThieu)
                        {
                            _context.ThongBaos.Add(new ThongBao
                            {
                                IdNhanVienTao = idNhanVien,
                                NoiDung = $"Cảnh báo: Tồn kho '{nguyenLieu.TenNguyenLieu}' chỉ còn {nguyenLieu.TonKho:N2} {nguyenLieu.DonViTinh}.",
                                ThoiGianTao = DateTime.Now,
                                LoaiThongBao = "CanhBaoKho",
                                IdLienQuan = nguyenLieu.IdNguyenLieu
                            });
                        }
                    }
                }
            }
        }

        private async Task<decimal> CalculateDiscount(KhuyenMai km, decimal tongTienGoc, ICollection<ChiTietHoaDon> chiTietList)
        {
            decimal tongTienGocChoKM = tongTienGoc;
            if (km.IdSanPhamApDung.HasValue)
            {
                tongTienGocChoKM = chiTietList
                    .Where(c => c.IdSanPham == km.IdSanPhamApDung.Value)
                    .Sum(c => c.ThanhTien);
            }

            decimal giamGia = 0;
            if (string.Equals(km.LoaiGiamGia, "PhanTram", StringComparison.OrdinalIgnoreCase))
            {
                giamGia = tongTienGocChoKM * (km.GiaTriGiam / 100);
                if (km.GiamToiDa.HasValue && giamGia > km.GiamToiDa.Value)
                {
                    giamGia = km.GiamToiDa.Value;
                }
            }
            else // SoTien
            {
                giamGia = km.GiaTriGiam;
            }
            return await Task.FromResult(giamGia);
        }

        // --- HÀM HELPER MỚI ---
        private bool IsValidEmail(string email)
        {
            try
            {
                var addr = new MailAddress(email);
                return addr.Address == email;
            }
            catch
            {
                return false;
            }
        }

        private bool IsValidPhone(string phone)
        {
            return phone.All(char.IsDigit) && phone.Length >= 9 && phone.Length <= 11;
        }

        #endregion
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\NhanVien\ThongTinCaNhanController.cs
================================================================================
﻿// File: ThongTinCaNhanController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp.NhanVien;
using CafebookModel.Utils;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.IO;
using System.Linq;
using System.Security.Claims;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App.NhanVien
{
    [Route("api/app/nhanvien/thongtincanhan")]
    [ApiController]
    [Authorize]
    public class ThongTinCaNhanController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private readonly IWebHostEnvironment _env;
        private readonly string _apiBaseUrl;

        public ThongTinCaNhanController(CafebookDbContext context, IWebHostEnvironment env, IConfiguration config)
        {
            _context = context;
            _env = env;
            _apiBaseUrl = config["Jwt:Issuer"] ?? "http://127.0.0.1:5166";
        }

        private int GetIdNhanVienFromToken()
        {
            var idClaim = User.Claims.FirstOrDefault(c => c.Type == "IdNhanVien");
            if (idClaim != null && int.TryParse(idClaim.Value, out int id)) return id;
            throw new UnauthorizedAccessException("Không thể xác thực nhân viên.");
        }

        [HttpGet("me")]
        public async Task<IActionResult> GetMyInfo()
        {
            // (Hàm này giữ nguyên)
            var idNhanVien = GetIdNhanVienFromToken();
            var nhanVien = await _context.NhanViens
                .AsNoTracking()
                .FirstOrDefaultAsync(nv => nv.IdNhanVien == idNhanVien);
            if (nhanVien == null) return NotFound("Không tìm thấy nhân viên.");
            var homNay = DateTime.Today;
            var lichHomNay = await _context.LichLamViecs
                .Include(l => l.CaLamViec)
                .AsNoTracking()
                .FirstOrDefaultAsync(l => l.IdNhanVien == idNhanVien && l.NgayLam.Date == homNay);
            var dauThang = new DateTime(homNay.Year, homNay.Month, 1);
            var cuoiThang = dauThang.AddMonths(1).AddDays(-1);
            var soLanNghi = await _context.DonXinNghis
                .Where(d => d.IdNhanVien == idNhanVien &&
                            (d.NgayBatDau >= dauThang && d.NgayBatDau <= cuoiThang))
                .CountAsync();
            var lichLamViec = await _context.LichLamViecs
                .Include(l => l.CaLamViec)
                .Where(l => l.IdNhanVien == idNhanVien &&
                            l.NgayLam >= dauThang && l.NgayLam <= cuoiThang)
                .OrderBy(l => l.NgayLam)
                .Select(l => new LichLamViecChiTietDto
                {
                    NgayLam = l.NgayLam,
                    TenCa = l.CaLamViec.TenCa,
                    GioBatDau = l.CaLamViec.GioBatDau,
                    GioKetThuc = l.CaLamViec.GioKetThuc
                })
                .ToListAsync();
            var response = new ThongTinCaNhanViewDto
            {
                NhanVien = new NhanVienInfoDto
                {
                    IdNhanVien = nhanVien.IdNhanVien,
                    HoTen = nhanVien.HoTen,
                    SoDienThoai = nhanVien.SoDienThoai,
                    Email = nhanVien.Email,
                    DiaChi = nhanVien.DiaChi,
                    AnhDaiDien = string.IsNullOrEmpty(nhanVien.AnhDaiDien) ? null : $"{_apiBaseUrl}{nhanVien.AnhDaiDien}"
                },
                LichLamViecHomNay = lichHomNay == null ? null : new LichLamViecDto
                {
                    TenCa = lichHomNay.CaLamViec.TenCa,
                    GioBatDau = lichHomNay.CaLamViec.GioBatDau,
                    GioKetThuc = lichHomNay.CaLamViec.GioKetThuc
                },
                SoLanXinNghiThangNay = soLanNghi,
                LichLamViecThangNay = lichLamViec
            };
            return Ok(response);
        }

        [HttpPut("update-info")]
        public async Task<IActionResult> UpdateInfo([FromForm] CapNhatThongTinDto req, IFormFile? avatarFile)
        {
            // (Hàm này giữ nguyên)
            var idNhanVien = GetIdNhanVienFromToken();
            var nhanVien = await _context.NhanViens.FindAsync(idNhanVien);
            if (nhanVien == null) return NotFound();
            nhanVien.HoTen = req.HoTen;
            nhanVien.SoDienThoai = req.SoDienThoai;
            nhanVien.Email = req.Email;
            nhanVien.DiaChi = req.DiaChi;
            if (avatarFile != null && avatarFile.Length > 0)
            {
                if (!string.IsNullOrEmpty(nhanVien.AnhDaiDien))
                {
                    var oldPhysicalPath = Path.Combine(_env.WebRootPath, nhanVien.AnhDaiDien.TrimStart('/'));
                    if (System.IO.File.Exists(oldPhysicalPath)) System.IO.File.Delete(oldPhysicalPath);
                }
                var fileExt = Path.GetExtension(avatarFile.FileName);
                var newFileName = $"{nhanVien.IdNhanVien}_{DateTime.Now:yyyyMMddHHmmss}{fileExt}";
                var relativeUrl = $"{HinhAnhPaths.UrlAvatarNV}/{newFileName}";
                var physicalPath = Path.Combine(_env.WebRootPath, relativeUrl.TrimStart('/'));
                var directory = Path.GetDirectoryName(physicalPath);
                if (directory != null)
                {
                    Directory.CreateDirectory(directory);
                }
                else
                {
                    return BadRequest("Đường dẫn lưu file không hợp lệ.");
                }
                await using (var stream = new FileStream(physicalPath, FileMode.Create))
                {
                    await avatarFile.CopyToAsync(stream);
                }
                nhanVien.AnhDaiDien = relativeUrl;
            }
            await _context.SaveChangesAsync();
            return Ok(new { message = "Cập nhật thông tin thành công!" });
        }

        [HttpPost("change-password")]
        public async Task<IActionResult> ChangePassword([FromBody] DoiMatKhauRequestDto req)
        {
            // (Hàm này giữ nguyên)
            if (string.IsNullOrEmpty(req.MatKhauCu) || string.IsNullOrEmpty(req.MatKhauMoi))
                return BadRequest("Mật khẩu cũ và mới không được để trống.");
            var idNhanVien = GetIdNhanVienFromToken();
            var nhanVien = await _context.NhanViens.FindAsync(idNhanVien);
            if (nhanVien == null) return NotFound();
            if (nhanVien.MatKhau != req.MatKhauCu)
                return BadRequest("Mật khẩu cũ không chính xác.");
            nhanVien.MatKhau = req.MatKhauMoi;
            await _context.SaveChangesAsync();
            return Ok(new { message = "Đổi mật khẩu thành công!" });
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\NhanVien\ThueSachController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp.NhanVien;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.Extensions.Configuration; // THÊM MỚI
using System.Net.Mail; // THÊM MỚI
using System.Net; // THÊM MỚI

namespace CafebookApi.Controllers.App.NhanVien
{
    [Route("api/app/nhanvien/thuesach")]
    [ApiController]
    public class ThueSachController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private readonly IConfiguration _configuration; // SỬA LỖI CS0103

        public ThueSachController(CafebookDbContext context, IConfiguration configuration) // SỬA LỖI CS0103
        {
            _context = context;
            _configuration = configuration; // SỬA LỖI CS0103
        }

        // Tải các cài đặt chung
        [HttpGet("settings")]
        public async Task<IActionResult> GetSettings()
        {
            var settings = await _context.CaiDats
                .Where(c => c.TenCaiDat.StartsWith("Sach_") || c.TenCaiDat.StartsWith("DiemTichLuy_"))
                .ToListAsync();

            var dto = new CaiDatThueSachDto
            {
                PhiThue = decimal.Parse(settings.FirstOrDefault(c => c.TenCaiDat == "Sach_PhiThue")?.GiaTri ?? "5000"),
                PhiTraTreMoiNgay = decimal.Parse(settings.FirstOrDefault(c => c.TenCaiDat == "Sach_PhiTraTreMoiNgay")?.GiaTri ?? "2000"),
                SoNgayMuonToiDa = int.Parse(settings.FirstOrDefault(c => c.TenCaiDat == "Sach_SoNgayMuonToiDa")?.GiaTri ?? "7"),
                DiemPhieuThue = int.Parse(settings.FirstOrDefault(c => c.TenCaiDat == "Sach_DiemPhieuThue")?.GiaTri ?? "1"),
                PointToVND = decimal.Parse(settings.FirstOrDefault(c => c.TenCaiDat == "DiemTichLuy_DoiVND")?.GiaTri ?? "1000")
            };
            return Ok(dto);
        }

        /// <summary>
        /// CẢI TIẾN (F3): Cải tiến tìm kiếm phiếu
        /// </summary>
        [HttpGet("phieuthue")]
        public async Task<IActionResult> GetPhieuThue([FromQuery] string? search, [FromQuery] string status = "Đang Thuê")
        {
            var query = _context.PhieuThueSachs.AsQueryable();
            if (status == "Đang Thuê" || status == "Đã Trả") { query = query.Where(p => p.TrangThai == status); }
            if (!string.IsNullOrEmpty(search))
            {
                var searchLower = search.ToLower();
                int.TryParse(search, out int phieuId);
                query = query.Where(p => p.IdPhieuThueSach == phieuId || p.KhachHang.HoTen.ToLower().Contains(searchLower) || (p.KhachHang.SoDienThoai != null && p.KhachHang.SoDienThoai.Contains(search)));
            }
            var phieus = await query.Include(p => p.KhachHang).Include(p => p.ChiTietPhieuThues).OrderByDescending(p => p.NgayThue).ToListAsync();
            var dtos = phieus.Select(p => new PhieuThueGridDto
            {
                IdPhieuThueSach = p.IdPhieuThueSach,
                HoTenKH = p.KhachHang.HoTen,
                SoDienThoaiKH = p.KhachHang.SoDienThoai,
                NgayThue = p.NgayThue,
                NgayHenTra = p.ChiTietPhieuThues.Where(ct => ct.NgayTraThucTe == null).Select(ct => (DateTime?)ct.NgayHenTra).Min() ?? p.NgayThue,
                SoLuongSach = p.ChiTietPhieuThues.Count(ct => ct.NgayTraThucTe == null),
                TongTienCoc = p.TongTienCoc,
                TrangThai = p.TrangThai,
                TinhTrang = (p.TrangThai == "Đã Trả") ? "Hoàn tất" : (p.ChiTietPhieuThues.Any(ct => ct.NgayTraThucTe == null && ct.NgayHenTra < DateTime.Today) ? "Trễ Hạn" : "Đúng Hạn")
            }).ToList();
            return Ok(dtos);
        }

        // Lấy chi tiết 1 phiếu
        [HttpGet("chitiet/{idPhieu}")]
        public async Task<IActionResult> GetChiTietPhieu(int idPhieu)
        {
            var phieu = await _context.PhieuThueSachs.Include(p => p.KhachHang).Include(p => p.ChiTietPhieuThues).ThenInclude(ct => ct.Sach).FirstOrDefaultAsync(p => p.IdPhieuThueSach == idPhieu);
            if (phieu == null) return NotFound();
            var settings = await GetSettingsInternal();
            var now = DateTime.Now;
            var dto = new PhieuThueChiTietDto
            {
                IdPhieuThueSach = phieu.IdPhieuThueSach,
                HoTenKH = phieu.KhachHang.HoTen,
                SoDienThoaiKH = phieu.KhachHang.SoDienThoai,
                EmailKH = phieu.KhachHang.Email,
                DiemTichLuyKH = phieu.KhachHang.DiemTichLuy,
                NgayThue = phieu.NgayThue,
                TrangThaiPhieu = phieu.TrangThai,
                SachDaThue = phieu.ChiTietPhieuThues.Select(ct => {
                    bool treHan = ct.NgayTraThucTe == null && ct.NgayHenTra < now.Date;
                    int daysLate = treHan ? (int)(now.Date - ct.NgayHenTra).TotalDays : 0;
                    return new ChiTietSachThueDto
                    {
                        IdPhieuThueSach = ct.IdPhieuThueSach,
                        IdSach = ct.IdSach,
                        TenSach = ct.Sach.TenSach,
                        NgayHenTra = ct.NgayHenTra,
                        TienCoc = ct.TienCoc,
                        TienPhat = daysLate * settings.PhiTraTreMoiNgay,
                        TinhTrang = ct.NgayTraThucTe != null ? "Đã Trả" : (treHan ? $"Trễ {daysLate} ngày" : "Đang Thuê")
                    };
                }).ToList()
            };
            return Ok(dto);
        }

        /// <summary>
        /// SỬA LỖI (dynamic): Dùng DTO an toàn
        /// </summary>
        [HttpGet("search-khachhang")]
        public async Task<IActionResult> SearchKhachHang([FromQuery] string query)
        {
            var queryLower = query.ToLower();
            var khachHangs = await _context.KhachHangs
                .Where(kh => kh.HoTen.ToLower().Contains(queryLower) || (kh.SoDienThoai != null && kh.SoDienThoai.Contains(query)))
                .Take(10)
                .Select(kh => new KhachHangSearchDto
                {
                    IdKhachHang = kh.IdKhachHang,
                    HoTen = kh.HoTen,
                    SoDienThoai = kh.SoDienThoai,
                    DiemTichLuy = kh.DiemTichLuy,
                    Email = kh.Email // SỬA: Thêm Email
                })
                .ToListAsync();
            return Ok(khachHangs);
        }

        /// <summary>
        /// CẢI TIẾN (F1): Tìm theo ID Sách
        /// </summary>
        [HttpGet("search-sach")]
        public async Task<IActionResult> SearchSach([FromQuery] string query)
        {
            var queryLower = query.ToLower();
            int.TryParse(query, out int sachId);

            var sachs = await _context.Sachs
                .Where(s => s.SoLuongHienCo > 0 &&
                            (s.TenSach.ToLower().Contains(queryLower) || s.IdSach == sachId))
                .Include(s => s.SachTacGias).ThenInclude(stg => stg.TacGia)
                .Take(10)
                .Select(s => new SachTimKiemDto
                {
                    IdSach = s.IdSach,
                    TenSach = s.TenSach,
                    TacGia = string.Join(", ", s.SachTacGias.Select(stg => stg.TacGia.TenTacGia)),
                    SoLuongHienCo = s.SoLuongHienCo,
                    GiaBia = s.GiaBia ?? 0
                })
                .ToListAsync();
            return Ok(sachs);
        }

        /// <summary>
        /// SỬA LỖI (CSDL) & CẢI TIẾN LOGIC (Tự động Tìm/Tạo Khách)
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> CreatePhieuThue([FromBody] PhieuThueRequestDto dto)
        {
            await using var transaction = await _context.Database.BeginTransactionAsync();
            try
            {
                var settings = await GetSettingsInternal();
                int khachHangId;

                // 1. XỬ LÝ KHÁCH HÀNG (Logic "Tìm hoặc Tạo")
                if (dto.KhachHangInfo == null || string.IsNullOrWhiteSpace(dto.KhachHangInfo.HoTen))
                {
                    return BadRequest("Tên khách hàng là bắt buộc.");
                }
                KhachHang? khach = null;
                string? sdt = dto.KhachHangInfo.SoDienThoai;
                string? email = dto.KhachHangInfo.Email;
                if (!string.IsNullOrWhiteSpace(sdt))
                {
                    khach = await _context.KhachHangs.FirstOrDefaultAsync(k => k.SoDienThoai == sdt);
                }
                if (khach == null && !string.IsNullOrWhiteSpace(email))
                {
                    khach = await _context.KhachHangs.FirstOrDefaultAsync(k => k.Email == email);
                }
                if (khach == null)
                {
                    if (!string.IsNullOrWhiteSpace(sdt) && await _context.KhachHangs.AnyAsync(k => k.SoDienThoai == sdt || k.TenDangNhap == sdt))
                    {
                        return Conflict("Số điện thoại này đã tồn tại.");
                    }
                    if (!string.IsNullOrWhiteSpace(email) && await _context.KhachHangs.AnyAsync(k => k.Email == email))
                    {
                        return Conflict("Email này đã tồn tại.");
                    }
                    string tenDangNhap;
                    if (!string.IsNullOrWhiteSpace(sdt)) { tenDangNhap = sdt; }
                    else if (!string.IsNullOrWhiteSpace(email)) { tenDangNhap = email; }
                    else { tenDangNhap = $"temp_{Guid.NewGuid().ToString("N")[..12]}"; }

                    var newKH = new KhachHang
                    {
                        HoTen = dto.KhachHangInfo.HoTen,
                        SoDienThoai = sdt,
                        Email = email,
                        NgayTao = DateTime.Now,
                        DiemTichLuy = 0,
                        BiKhoa = false,
                        TenDangNhap = tenDangNhap,
                        MatKhau = "123456",
                        TaiKhoanTam = true
                    };
                    _context.KhachHangs.Add(newKH);
                    await _context.SaveChangesAsync();
                    khachHangId = newKH.IdKhachHang;
                }
                else
                {
                    khachHangId = khach.IdKhachHang;
                }

                // 2. Tạo Phiếu Thuê
                decimal tongCoc = dto.SachCanThue.Sum(s => s.TienCoc);
                var phieuThue = new PhieuThueSach
                {
                    IdKhachHang = khachHangId,
                    IdNhanVien = dto.IdNhanVien,
                    NgayThue = DateTime.Now,
                    TrangThai = "Đang Thuê",
                    TongTienCoc = tongCoc
                };
                _context.PhieuThueSachs.Add(phieuThue);
                await _context.SaveChangesAsync();

                // 3. Xử lý Chi Tiết Phiếu Thuê và Sách
                foreach (var sachThue in dto.SachCanThue)
                {
                    var sach = await _context.Sachs.FindAsync(sachThue.IdSach);
                    if (sach == null || sach.SoLuongHienCo <= 0)
                    {
                        await transaction.RollbackAsync();
                        return Conflict($"Sách '{sach?.TenSach ?? "ID: " + sachThue.IdSach}' đã hết hàng.");
                    }
                    sach.SoLuongHienCo--;
                    var chiTiet = new ChiTietPhieuThue
                    {
                        IdPhieuThueSach = phieuThue.IdPhieuThueSach,
                        IdSach = sachThue.IdSach,
                        NgayHenTra = dto.NgayHenTra,
                        TienCoc = sachThue.TienCoc,
                        TienPhatTraTre = null,
                        NgayTraThucTe = null
                    };
                    _context.ChiTietPhieuThues.Add(chiTiet);
                }

                // 4. SỬA LỖI LOGIC: Xóa tích điểm khi tạo phiếu

                await _context.SaveChangesAsync();
                await transaction.CommitAsync();

                return Ok(new { IdPhieuThueSach = phieuThue.IdPhieuThueSach, TongTienCoc = tongCoc });
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                return StatusCode(500, $"Lỗi nội bộ: {ex.Message} \nChi tiết: {ex.InnerException?.Message}");
            }
        }

        /// <summary>
        /// CẢI TIẾN (F2) & SỬA LỖI LOGIC (Tích điểm)
        /// </summary>
        [HttpPost("return")]
        public async Task<IActionResult> ReturnSach([FromBody] TraSachRequestDto dto)
        {
            await using var transaction = await _context.Database.BeginTransactionAsync();
            try
            {
                var settings = await GetSettingsInternal();
                var phieu = await _context.PhieuThueSachs
                    .Include(p => p.ChiTietPhieuThues)
                    .FirstOrDefaultAsync(p => p.IdPhieuThueSach == dto.IdPhieuThueSach);

                if (phieu == null) return NotFound("Không tìm thấy phiếu thuê.");
                var khach = await _context.KhachHangs.FindAsync(phieu.IdKhachHang);
                if (khach == null) return NotFound("Không tìm thấy khách hàng.");

                decimal totalPhat = 0;
                decimal totalCoc = 0;
                decimal totalPhiThue = 0;
                int sachDaTra = 0;
                var now = DateTime.Now;

                var phieuTra = new PhieuTraSach
                {
                    IdPhieuThueSach = phieu.IdPhieuThueSach,
                    IdNhanVien = dto.IdNhanVien,
                    NgayTra = now,
                    ChiTietPhieuTras = new List<ChiTietPhieuTra>()
                };

                foreach (int idSach in dto.IdSachs)
                {
                    var ct = phieu.ChiTietPhieuThues.FirstOrDefault(c => c.IdSach == idSach && c.NgayTraThucTe == null);
                    if (ct == null) continue;

                    var sach = await _context.Sachs.FindAsync(idSach);
                    if (sach != null) sach.SoLuongHienCo++;

                    ct.NgayTraThucTe = now;

                    decimal tienPhat = 0;
                    if (ct.NgayHenTra < now.Date)
                    {
                        int daysLate = (int)(now.Date - ct.NgayHenTra).TotalDays;
                        tienPhat = daysLate * settings.PhiTraTreMoiNgay;
                    }
                    ct.TienPhatTraTre = tienPhat;

                    totalPhat += tienPhat;
                    totalCoc += ct.TienCoc;
                    totalPhiThue += settings.PhiThue;
                    sachDaTra++;

                    phieuTra.ChiTietPhieuTras.Add(new ChiTietPhieuTra
                    {
                        IdSach = idSach,
                        TienPhat = tienPhat
                    });
                }

                if (sachDaTra == 0)
                {
                    await transaction.RollbackAsync();
                    return BadRequest("Không có sách nào hợp lệ để trả.");
                }

                if (!phieu.ChiTietPhieuThues.Any(ct => ct.NgayTraThucTe == null))
                {
                    phieu.TrangThai = "Đã Trả";
                }

                // SỬA LỖI LOGIC TÍCH ĐIỂM
                // Chỉ cộng điểm khi phiếu được trả (toàn bộ hoặc một phần)
                int diem = settings.DiemPhieuThue;
                khach.DiemTichLuy += diem;

                phieuTra.TongPhiThue = totalPhiThue;
                phieuTra.TongTienPhat = totalPhat;
                phieuTra.TongTienCocHoan = totalCoc;
                phieuTra.DiemTichLuy = diem; // Lưu lại số điểm đã cộng
                _context.PhieuTraSachs.Add(phieuTra);

                await _context.SaveChangesAsync();
                await transaction.CommitAsync();

                var response = new TraSachResponseDto
                {
                    IdPhieuTra = phieuTra.IdPhieuTra,
                    SoSachDaTra = sachDaTra,
                    TongPhiThue = totalPhiThue,
                    TongTienPhat = totalPhat,
                    TongTienCoc = totalCoc,
                    TongHoanTra = totalCoc - totalPhiThue - totalPhat, // Sửa: Cọc - (Phí + Phạt)
                    DiemTichLuy = diem
                };

                return Ok(response);
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                return StatusCode(500, $"Lỗi nội bộ: {ex.Message} \nChi tiết: {ex.InnerException?.Message}");
            }
        }


        /// <summary>
        /// CẢI TIẾN (F7): Tìm kiếm Lịch sử trả
        /// </summary>
        [HttpGet("phieutra")]
        public async Task<IActionResult> GetPhieuTra([FromQuery] string? search)
        {
            var query = _context.PhieuTraSachs.Include(pt => pt.NhanVien).AsQueryable();

            if (!string.IsNullOrEmpty(search))
            {
                int.TryParse(search, out int phieuId);
                query = query.Where(pt =>
                    pt.IdPhieuTra == phieuId ||
                    pt.IdPhieuThueSach == phieuId
                );
            }

            var phieuTra = await query
                .OrderByDescending(pt => pt.NgayTra)
                .Take(100)
                .Select(pt => new PhieuTraGridDto
                {
                    IdPhieuTra = pt.IdPhieuTra,
                    IdPhieuThueSach = pt.IdPhieuThueSach,
                    NgayTra = pt.NgayTra,
                    TenNhanVien = pt.NhanVien.HoTen,
                    TongHoanTra = pt.TongTienCocHoan - pt.TongTienPhat - pt.TongPhiThue
                })
                .ToListAsync();

            return Ok(phieuTra);
        }


        /// <summary>
        /// CẢI TIẾN (F-Email): Chỉ gửi Mail (Hành động chủ động)
        /// </summary>
        [HttpPost("send-reminder/{idPhieu}")]
        public async Task<IActionResult> SendReminder(int idPhieu)
        {
            var phieu = await _context.PhieuThueSachs
                .Include(p => p.KhachHang)
                .Include(p => p.ChiTietPhieuThues)
                .FirstOrDefaultAsync(p => p.IdPhieuThueSach == idPhieu);

            if (phieu == null) return NotFound();

            var khach = phieu.KhachHang;
            if (string.IsNullOrEmpty(khach.Email))
                return BadRequest("Khách hàng này không có Email.");

            var sachChuaTra = phieu.ChiTietPhieuThues
                .Where(ct => ct.NgayTraThucTe == null && ct.NgayHenTra < DateTime.Now.AddDays(2))
                .ToList();

            if (!sachChuaTra.Any())
                return BadRequest("Khách hàng không có sách nào sắp trễ hạn.");

            var ngayHenTra = sachChuaTra.Min(s => s.NgayHenTra);
            var noiDung = $"Xin chào {khach.HoTen},<br><br>Cafebook trân trọng thông báo bạn có {sachChuaTra.Count} cuốn sách sắp/đã trễ hạn (hạn trả: {ngayHenTra:dd/MM/yyyy}). Vui lòng kiểm tra và trả sách sớm. <br><br>Cảm ơn bạn.";
            var subject = $"[Cafebook] Thông báo trễ hạn thuê sách (Phiếu PT{idPhieu})";

            try
            {
                // 1. Gửi Email (Viết trực tiếp)
                var smtpSettings = _configuration.GetSection("SmtpSettings");
                var mailMessage = new MailMessage
                {
                    From = new MailAddress(smtpSettings["Username"], smtpSettings["FromName"]),
                    Subject = subject,
                    Body = noiDung,
                    IsBodyHtml = true,
                };
                mailMessage.To.Add(khach.Email);

                using var smtpClient = new SmtpClient(smtpSettings["Host"], int.Parse(smtpSettings["Port"]))
                {
                    Credentials = new NetworkCredential(smtpSettings["Username"], smtpSettings["Password"]),
                    EnableSsl = bool.Parse(smtpSettings["EnableSsl"])
                };
                await smtpClient.SendMailAsync(mailMessage);

                // 2. XÓA LOGIC TẠO THÔNG BÁO (Theo yêu cầu)

                return Ok(new { Message = $"Đã gửi email nhắc nhở đến {khach.Email}." });
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Lỗi khi gửi email: {ex.Message}");
            }
        }

        /// <summary>
        /// CẢI TIẾN (F-Email): Gửi email hàng loạt (Hành động chủ động)
        /// </summary>
        [HttpPost("send-all-reminders")]
        public async Task<IActionResult> SendAllReminders()
        {
            var phieuSapTre = await _context.ChiTietPhieuThues
                .Where(ct => ct.NgayTraThucTe == null && ct.NgayHenTra.Date == DateTime.Today.AddDays(1))
                .Include(ct => ct.PhieuThueSach.KhachHang)
                .GroupBy(ct => ct.PhieuThueSach) // Nhóm theo Phiếu Thuê
                .ToListAsync();

            if (!phieuSapTre.Any())
            {
                return Ok(new { Message = "Không có khách hàng nào sắp trễ hạn vào ngày mai." });
            }

            // Lấy cài đặt SMTP
            var smtpSettings = _configuration.GetSection("SmtpSettings");
            using var smtpClient = new SmtpClient(smtpSettings["Host"], int.Parse(smtpSettings["Port"]))
            {
                Credentials = new NetworkCredential(smtpSettings["Username"], smtpSettings["Password"]),
                EnableSsl = bool.Parse(smtpSettings["EnableSsl"])
            };

            int count = 0;
            foreach (var group in phieuSapTre)
            {
                var khach = group.Key.KhachHang;
                var sachList = group.ToList();
                var ngayHenTra = sachList.Min(s => s.NgayHenTra);

                if (!string.IsNullOrEmpty(khach.Email))
                {
                    try
                    {
                        // 1. Gửi Email
                        var noiDung = $"Xin chào {khach.HoTen},<br><br>Cafebook trân trọng thông báo bạn có {sachList.Count} cuốn sách sẽ đến hạn trả vào ngày mai ({ngayHenTra:dd/MM/yyyy}). Vui lòng kiểm tra và trả sách đúng hạn.<br><br>Cảm ơn bạn.";
                        var subject = "[Cafebook] Thông báo nhắc hạn trả sách";

                        var mailMessage = new MailMessage
                        {
                            From = new MailAddress(smtpSettings["Username"], smtpSettings["FromName"]),
                            Subject = subject,
                            Body = noiDung,
                            IsBodyHtml = true,
                        };
                        mailMessage.To.Add(khach.Email);

                        await smtpClient.SendMailAsync(mailMessage);
                        count++;
                    }
                    catch (Exception ex)
                    {
                        // Ghi log lỗi nhưng vẫn tiếp tục
                        Console.WriteLine($"Lỗi gửi mail cho {khach.Email}: {ex.Message}");
                    }
                }
            }

            // 2. XÓA LOGIC TẠO THÔNG BÁO (Theo yêu cầu)

            return Ok(new { Message = $"Đã gửi {count} email nhắc nhở hàng loạt." });
        }

        // Lấy dữ liệu cho phiếu in (Thuê)
        [HttpGet("print-data/{idPhieu}")]
        public async Task<IActionResult> GetPrintData(int idPhieu)
        {
            var phieu = await _context.PhieuThueSachs
                .Include(p => p.KhachHang)
                .Include(p => p.NhanVien)
                .Include(p => p.ChiTietPhieuThues).ThenInclude(ct => ct.Sach)
                .FirstOrDefaultAsync(p => p.IdPhieuThueSach == idPhieu);

            if (phieu == null) return NotFound();

            var settings = await _context.CaiDats.ToListAsync();
            var settingsThue = await GetSettingsInternal();

            var dto = new PhieuThuePrintDto
            {
                IdPhieu = $"PT{phieu.IdPhieuThueSach:D6}",
                TenQuan = settings.FirstOrDefault(c => c.TenCaiDat == "TenQuan")?.GiaTri ?? "Cafebook",
                DiaChiQuan = settings.FirstOrDefault(c => c.TenCaiDat == "DiaChi")?.GiaTri ?? "N/A",
                SdtQuan = settings.FirstOrDefault(c => c.TenCaiDat == "SoDienThoai")?.GiaTri ?? "N/A",
                NgayTao = phieu.NgayThue,
                TenNhanVien = phieu.NhanVien.HoTen,
                TenKhachHang = phieu.KhachHang.HoTen,
                SdtKhachHang = phieu.KhachHang.SoDienThoai ?? "N/A",
                NgayHenTra = phieu.ChiTietPhieuThues.Min(ct => ct.NgayHenTra),
                ChiTiet = phieu.ChiTietPhieuThues.Select(ct => new ChiTietPrintDto
                {
                    TenSach = ct.Sach.TenSach,
                    TienCoc = ct.TienCoc
                }).ToList(),
                TongTienCoc = phieu.TongTienCoc,
                TongPhiThue = phieu.ChiTietPhieuThues.Count * settingsThue.PhiThue
            };

            return Ok(dto);
        }

        /// <summary>
        /// SỬA LỖI (EF Core): Sửa lỗi 'Walking back include tree'
        /// </summary>
        [HttpGet("print-data/tra/{idPhieuTra}")]
        public async Task<IActionResult> GetPrintDataTra(int idPhieuTra)
        {
            // SỬA LỖI: Đơn giản hóa Include
            var phieuTra = await _context.PhieuTraSachs
                .Include(pt => pt.NhanVien)
                .Include(pt => pt.PhieuThueSach.KhachHang)
                // THÊM Include ChiTietPhieuThues ở đây
                .Include(pt => pt.PhieuThueSach.ChiTietPhieuThues)
                .Include(pt => pt.ChiTietPhieuTras).ThenInclude(ct => ct.Sach)
                // XÓA dòng Include bị lỗi
                // .Include(pt => pt.ChiTietPhieuTras).ThenInclude(ct => ct.PhieuTraSach.PhieuThueSach.ChiTietPhieuThues) 
                .FirstOrDefaultAsync(pt => pt.IdPhieuTra == idPhieuTra);

            if (phieuTra == null) return NotFound();

            var settings = await _context.CaiDats.ToListAsync();
            var khach = phieuTra.PhieuThueSach.KhachHang;

            var dto = new PhieuTraPrintDto
            {
                IdPhieuTra = $"PTR{phieuTra.IdPhieuTra:D6}",
                IdPhieuThue = $"PT{phieuTra.IdPhieuThueSach:D6}",
                TenQuan = settings.FirstOrDefault(c => c.TenCaiDat == "TenQuan")?.GiaTri ?? "Cafebook",
                DiaChiQuan = settings.FirstOrDefault(c => c.TenCaiDat == "DiaChi")?.GiaTri ?? "N/A",
                SdtQuan = settings.FirstOrDefault(c => c.TenCaiDat == "SoDienThoai")?.GiaTri ?? "N/A",
                NgayTra = phieuTra.NgayTra,
                TenNhanVien = phieuTra.NhanVien.HoTen,
                TenKhachHang = khach.HoTen,
                SdtKhachHang = khach.SoDienThoai ?? "N/A",
                DiemTichLuy = phieuTra.DiemTichLuy,

                ChiTiet = phieuTra.ChiTietPhieuTras.Select(ct => new ChiTietTraPrintDto
                {
                    TenSach = ct.Sach.TenSach,
                    TienPhat = ct.TienPhat,
                    // Logic Select này giờ sẽ hoạt động
                    TienCoc = phieuTra.PhieuThueSach.ChiTietPhieuThues
                                .FirstOrDefault(cts => cts.IdSach == ct.IdSach)?.TienCoc ?? 0
                }).ToList(),

                TongTienCoc = phieuTra.TongTienCocHoan,
                TongPhiThue = phieuTra.TongPhiThue,
                TongTienPhat = phieuTra.TongTienPhat,
                TongHoanTra = phieuTra.TongTienCocHoan - phieuTra.TongPhiThue - phieuTra.TongTienPhat
            };

            return Ok(dto);
        }

        // (GetSettingsInternal giữ nguyên)
        private async Task<CaiDatThueSachDto> GetSettingsInternal()
        {
            var settings = await _context.CaiDats
                .Where(c => c.TenCaiDat.StartsWith("Sach_") || c.TenCaiDat.StartsWith("DiemTichLuy_"))
                .ToListAsync();

            return new CaiDatThueSachDto
            {
                PhiThue = decimal.Parse(settings.FirstOrDefault(c => c.TenCaiDat == "Sach_PhiThue")?.GiaTri ?? "5000"),
                PhiTraTreMoiNgay = decimal.Parse(settings.FirstOrDefault(c => c.TenCaiDat == "Sach_PhiTraTreMoiNgay")?.GiaTri ?? "2000"),
                SoNgayMuonToiDa = int.Parse(settings.FirstOrDefault(c => c.TenCaiDat == "Sach_SoNgayMuonToiDa")?.GiaTri ?? "7"),
                DiemPhieuThue = int.Parse(settings.FirstOrDefault(c => c.TenCaiDat == "Sach_DiemPhieuThue")?.GiaTri ?? "1"),
                PointToVND = decimal.Parse(settings.FirstOrDefault(c => c.TenCaiDat == "DiemTichLuy_DoiVND")?.GiaTri ?? "1000")
            };
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\Web\ChinhSachController.cs
================================================================================
﻿// Tập tin: CafebookApi/Controllers/Web/ChinhSachController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.Web
{
    [Route("api/web/chinhsach")]
    [ApiController]
    public class ChinhSachController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public ChinhSachController(CafebookDbContext context)
        {
            _context = context;
        }

        // Hàm helper để đọc và chuyển đổi Cài đặt an toàn
        private decimal GetSettingValue(List<CafebookModel.Model.Entities.CaiDat> settings, string key, decimal defaultValue)
        {
            var valueString = settings.FirstOrDefault(c => c.TenCaiDat == key)?.GiaTri;
            if (decimal.TryParse(valueString, NumberStyles.Any, CultureInfo.InvariantCulture, out var value))
            {
                return value;
            }
            return defaultValue;
        }

        /// <summary>
        /// API lấy dữ liệu động cho trang Chính sách
        /// </summary>
        [HttpGet("data")]
        public async Task<IActionResult> GetChinhSachData()
        {
            var keysToFetch = new[] {
                "Sach_PhiThue",
                "Sach_PhiTraTreMoiNgay",
                "DiemTichLuy_NhanVND",
                "DiemTichLuy_DoiVND"
            };

            var settings = await _context.CaiDats
                .Where(c => keysToFetch.Contains(c.TenCaiDat))
                .ToListAsync();

            var dto = new ChinhSachDto
            {
                PhiThue = GetSettingValue(settings, "Sach_PhiThue", 15000),
                PhiTraTreMoiNgay = GetSettingValue(settings, "Sach_PhiTraTreMoiNgay", 5000),
                DiemNhanVND = GetSettingValue(settings, "DiemTichLuy_NhanVND", 10000),
                DiemDoiVND = GetSettingValue(settings, "DiemTichLuy_DoiVND", 1000)
            };

            return Ok(dto);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\Web\DatBanWebController.cs
================================================================================
﻿/* KHÔNG THAY ĐỔI */
/* File này đã có logic backend tốt, không cần sửa. */

using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Security.Claims;
using System.Text.RegularExpressions;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.Web
{
    [Route("api/web/datban")]
    [ApiController]
    public class DatBanWebController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private const int SlotDurationHours = 2; // Yêu cầu 2 giờ

        private class OpeningHours
        {
            public TimeSpan Open { get; set; } = new TimeSpan(6, 0, 0);
            public TimeSpan Close { get; set; } = new TimeSpan(23, 0, 0);
            public bool IsValid { get; set; } = false;
        }

        public DatBanWebController(CafebookDbContext context)
        {
            _context = context;
        }

        [HttpGet("get-all-tables-by-area")]
        public async Task<IActionResult> GetAllTablesByArea()
        {
            var khuVucList = await _context.KhuVucs
                .Include(k => k.Bans)
                .Where(k => k.Bans.Any(b => b.TrangThai != "Tạm ngưng" && b.TrangThai != "Bảo trì"))
                .OrderBy(k => k.IdKhuVuc)
                .Select(k => new KhuVucBanDto
                {
                    IdKhuVuc = k.IdKhuVuc,
                    TenKhuVuc = k.TenKhuVuc,
                    BanList = k.Bans
                                .Where(b => b.TrangThai != "Tạm ngưng" && b.TrangThai != "Bảo trì")
                                .OrderBy(b => b.SoBan)
                                .Select(b => new BanTrongDto
                                {
                                    IdBan = b.IdBan,
                                    SoBan = b.SoBan,
                                    SoGhe = b.SoGhe,
                                    KhuVuc = k.TenKhuVuc,
                                    MoTa = b.GhiChu
                                }).ToList()
                })
                .ToListAsync();

            return Ok(khuVucList);
        }

        [HttpGet("get-opening-hours")]
        public async Task<ActionResult<OpeningHoursDto>> GetOpeningHours()
        {
            var hours = await GetAndParseOpeningHours();
            return Ok(new OpeningHoursDto { Open = hours.Open, Close = hours.Close });
        }


        [HttpPost("tim-ban")]
        public async Task<IActionResult> TimBanTrong([FromBody] TimBanRequestDto req)
        {
            DateTime requestedStart = req.NgayDat.Date.Add(req.GioDat);
            DateTime requestedEnd = requestedStart.AddHours(SlotDurationHours);
            var openingHours = await GetAndParseOpeningHours();

            if (requestedStart < DateTime.Now.AddMinutes(10))
            {
                return BadRequest("Vui lòng đặt bàn trước ít nhất 10 phút.");
            }

            if (!IsTimeValid(requestedStart, openingHours))
            {
                return BadRequest($"Giờ đặt ({requestedStart:HH:mm}) nằm ngoài giờ mở cửa ({openingHours.Open:hh\\:mm} - {openingHours.Close:hh\\:mm}).");
            }

            var suitableTables = await _context.Bans
                .Include(b => b.KhuVuc)
                .Where(b => b.SoGhe >= req.SoNguoi && b.TrangThai != "Bảo trì" && b.TrangThai != "Tạm ngưng")
                .ToListAsync();

            var existingBookings = await _context.PhieuDatBans
                .Where(p => p.ThoiGianDat.Date == req.NgayDat.Date &&
                            (p.TrangThai == "Đã xác nhận" ||
                             p.TrangThai == "Chờ xác nhận" ||
                             p.TrangThai == "Khách đã đến"))
                .ToListAsync();

            var availableTables = new List<BanTrongDto>();

            foreach (var table in suitableTables)
            {
                bool isBusy = existingBookings.Any(booking =>
                {
                    if (booking.IdBan != table.IdBan) return false;
                    DateTime bookingStart = booking.ThoiGianDat;
                    DateTime bookingEnd = bookingStart.AddHours(SlotDurationHours);
                    return requestedStart < bookingEnd && bookingStart < requestedEnd;
                });

                if (!isBusy)
                {
                    availableTables.Add(new BanTrongDto
                    {
                        IdBan = table.IdBan,
                        SoBan = table.SoBan,
                        SoGhe = table.SoGhe,
                        KhuVuc = table.KhuVuc?.TenKhuVuc ?? "Chung",
                        MoTa = table.GhiChu
                    });
                }
            }

            return Ok(availableTables.OrderBy(t => t.SoGhe).ThenBy(t => t.SoBan));
        }

        [HttpPost("tao-yeu-cau")]
        public async Task<IActionResult> TaoYeuCauDatBan([FromBody] DatBanWebRequestDto req)
        {
            int? idKhachHang = null;
            KhachHang khachHang = null;

            if (string.IsNullOrWhiteSpace(req.HoTen) || string.IsNullOrWhiteSpace(req.SoDienThoai) || string.IsNullOrWhiteSpace(req.Email))
            {
                return BadRequest("Vui lòng cung cấp đủ Họ tên, Số điện thoại và Email liên hệ.");
            }
            if (string.IsNullOrWhiteSpace(req.SoDienThoai)) return BadRequest("Số điện thoại không được để trống.");
            if (string.IsNullOrWhiteSpace(req.Email)) return BadRequest("Email không được để trống.");

            // Bước 1: Kiểm tra người dùng đã đăng nhập và không phải đặt hộ
            if (User.Identity?.IsAuthenticated == true)
            {
                var claimId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
                if (int.TryParse(claimId, out int id))
                {
                    var user = await _context.KhachHangs.FindAsync(id);
                    if (user != null && user.SoDienThoai == req.SoDienThoai && user.Email == req.Email)
                    {
                        khachHang = user;
                    }
                }
            }

            // Bước 2: Nếu là KVL hoặc Đặt hộ (khachHang vẫn null)
            if (khachHang == null)
            {
                var khachTheoSDT = await _context.KhachHangs.FirstOrDefaultAsync(k => k.SoDienThoai == req.SoDienThoai);
                var khachTheoEmail = await _context.KhachHangs.FirstOrDefaultAsync(k => k.Email == req.Email);

                if (khachTheoSDT != null && khachTheoEmail != null)
                {
                    if (khachTheoSDT.IdKhachHang != khachTheoEmail.IdKhachHang)
                    {
                        return Conflict("SĐT và Email này thuộc về 2 tài khoản khác nhau. Vui lòng kiểm tra lại.");
                    }
                    else
                    {
                        khachHang = khachTheoSDT;
                        khachHang.HoTen = req.HoTen;
                        _context.KhachHangs.Update(khachHang);
                    }
                }
                else if (khachTheoSDT != null)
                {
                    khachHang = khachTheoSDT;
                    khachHang.HoTen = req.HoTen;
                    khachHang.Email = req.Email;
                    _context.KhachHangs.Update(khachHang);
                }
                else if (khachTheoEmail != null)
                {
                    khachHang = khachTheoEmail;
                    khachHang.HoTen = req.HoTen;
                    khachHang.SoDienThoai = req.SoDienThoai;
                    _context.KhachHangs.Update(khachHang);
                }
                else
                {
                    if (await _context.KhachHangs.AnyAsync(k => k.TenDangNhap == req.SoDienThoai))
                    {
                        return Conflict("Tên đăng nhập (SĐT) này đã được sử dụng.");
                    }

                    khachHang = new KhachHang
                    {
                        HoTen = req.HoTen,
                        SoDienThoai = req.SoDienThoai,
                        Email = req.Email,
                        NgayTao = DateTime.Now,
                        DiemTichLuy = 0,
                        BiKhoa = false,
                        TenDangNhap = req.SoDienThoai,
                        MatKhau = Guid.NewGuid().ToString("N")[..8],
                        TaiKhoanTam = true
                    };
                    _context.KhachHangs.Add(khachHang);
                }
            }

            try
            {
                await _context.SaveChangesAsync(); // Lưu (hoặc tạo) KhachHang
                idKhachHang = khachHang.IdKhachHang;
            }
            catch (DbUpdateException ex)
            {
                return Conflict($"Lỗi CSDL khi cập nhật/tạo khách hàng: {ex.InnerException?.Message ?? ex.Message}");
            }


            // 2. Kiểm tra tình trạng bàn VÀ THỜI GIAN
            DateTime requestedStart = req.NgayDat.Date.Add(req.GioDat);
            var openingHours = await GetAndParseOpeningHours();

            if (requestedStart < DateTime.Now.AddMinutes(10))
            {
                return Conflict("Giờ đặt quá gần. Vui lòng chọn thời gian sau 10 phút nữa.");
            }
            if (!IsTimeValid(requestedStart, openingHours))
            {
                return BadRequest($"Giờ đặt ({requestedStart:HH:mm}) nằm ngoài giờ mở cửa ({openingHours.Open:hh\\:mm} - {openingHours.Close:hh\\:mm}).");
            }

            bool isConflict = await _context.PhieuDatBans.AnyAsync(p =>
                p.IdBan == req.IdBan &&
                (p.TrangThai == "Đã xác nhận" || p.TrangThai == "Chờ xác nhận" || p.TrangThai == "Khách đã đến") &&
                requestedStart < p.ThoiGianDat.AddHours(SlotDurationHours) &&
                p.ThoiGianDat < requestedStart.AddHours(SlotDurationHours)
            );

            if (isConflict)
            {
                return Conflict("Rất tiếc, bàn này vừa có người đặt vào khung giờ bạn chọn. Vui lòng chọn bàn khác.");
            }

            // 3. Tạo phiếu đặt bàn
            var phieuMoi = new PhieuDatBan
            {
                IdBan = req.IdBan,
                IdKhachHang = idKhachHang,
                HoTenKhach = req.HoTen,
                SdtKhach = req.SoDienThoai,
                ThoiGianDat = requestedStart,
                SoLuongKhach = req.SoLuongKhach,
                GhiChu = req.GhiChu,
                TrangThai = "Chờ xác nhận"
            };
            _context.PhieuDatBans.Add(phieuMoi);

            // 4. Tạo thông báo cho nhân viên
            var banInfo = await _context.Bans.FindAsync(req.IdBan);
            var thongBao = new ThongBao
            {
                NoiDung = $"Đơn đặt bàn mới: {req.HoTen} - Bàn {banInfo?.SoBan} lúc {requestedStart:HH:mm dd/MM}",
                LoaiThongBao = "DatBan",
                IdLienQuan = phieuMoi.IdPhieuDatBan,
                ThoiGianTao = DateTime.Now,
                DaXem = false,
                IdNhanVienTao = null
            };
            _context.ThongBaos.Add(thongBao);

            await _context.SaveChangesAsync();

            return Ok(new { success = true, message = "Yêu cầu đặt bàn của bạn đã được gửi. Chúng tôi sẽ sớm xác nhận!", idPhieu = phieuMoi.IdPhieuDatBan });
        }

        // ***** NÂNG CẤP MỚI: API TỰ ĐỘNG ĐIỀN SĐT *****
        [HttpGet("get-customer-info")]
        public async Task<IActionResult> GetCustomerInfoByPhone([FromQuery] string phone)
        {
            if (string.IsNullOrWhiteSpace(phone))
            {
                return BadRequest();
            }

            var khachHang = await _context.KhachHangs
                // Chỉ tìm SĐT của khách hàng chính thức (không phải tài khoản tạm)
                .Where(k => k.SoDienThoai == phone && k.TaiKhoanTam == false)
                .Select(k => new { k.HoTen, k.Email }) // Chỉ trả về 2 trường cần thiết
                .FirstOrDefaultAsync();

            if (khachHang == null)
            {
                return NotFound();
            }

            return Ok(khachHang);
        }
        // ***** HẾT PHẦN NÂNG CẤP *****


        // --- HELPER XỬ LÝ GIỜ ---
        private async Task<OpeningHours> GetAndParseOpeningHours()
        {
            var setting = await _context.CaiDats
                .FirstOrDefaultAsync(cd => cd.TenCaiDat == "LienHe_GioMoCua");
            string settingValue = (setting != null && !string.IsNullOrEmpty(setting.GiaTri)) ? setting.GiaTri : "06:00 - 23:00";
            return ParseOpeningHours(settingValue);
        }

        private OpeningHours ParseOpeningHours(string settingValue)
        {
            var hours = new OpeningHours();
            try
            {
                var match = Regex.Match(settingValue, @"(\d{2}:\d{2})\s*-\s*(\d{2}:\d{2})");
                if (match.Success)
                {
                    if (TimeSpan.TryParse(match.Groups[1].Value, out TimeSpan open)) hours.Open = open;
                    if (TimeSpan.TryParse(match.Groups[2].Value, out TimeSpan close)) hours.Close = close;
                    hours.IsValid = true;
                }
            }
            catch { }
            return hours;
        }

        private bool IsTimeValid(DateTime thoiGianDat, OpeningHours hours)
        {
            var timeOfDay = thoiGianDat.TimeOfDay;
            return timeOfDay >= hours.Open && timeOfDay < hours.Close;
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\Web\KhachHangProfileController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelWeb;
using CafebookModel.Utils;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Security.Claims;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.Web
{
    [Route("api/web/profile")]
    [ApiController]
    //[Authorize(Roles = "KhachHang")] // <-- BẢO MẬT: Yêu cầu đăng nhập cho tất cả
    public class KhachHangProfileController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private readonly IWebHostEnvironment _env;
        private readonly string _baseUrl;

        public KhachHangProfileController(CafebookDbContext context, IWebHostEnvironment env, IConfiguration config)
        {
            _context = context;
            _env = env;
            if (string.IsNullOrEmpty(_env.WebRootPath))
            {
                _env.WebRootPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot");
            }
            _baseUrl = config.GetValue<string>("Kestrel:Endpoints:Http:Url") ?? "http://127.0.0.1:5166";
        }

        private int GetCurrentUserId()
        {
            var idClaim = User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier);
            int.TryParse(idClaim?.Value, out int id);
            return id;
        }

        [ApiExplorerSettings(IgnoreApi = true)]
        private string? GetFullImageUrl(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath)) return null;
            return $"{_baseUrl}{relativePath.Replace(Path.DirectorySeparatorChar, '/')}";
        }

        [ApiExplorerSettings(IgnoreApi = true)]
        private async Task<string?> SaveImageAsync(IFormFile imageFile, string subFolder, string baseFileNameSlug, int userId)
        {
            if (imageFile == null || imageFile.Length == 0) return null;
            var uploadPath = Path.Combine(_env.WebRootPath, "images", subFolder);
            if (!Directory.Exists(uploadPath)) Directory.CreateDirectory(uploadPath);

            var fileExtension = Path.GetExtension(imageFile.FileName);
            var uniqueFileName = $"{userId}_{baseFileNameSlug}{fileExtension}";
            var filePath = Path.Combine(uploadPath, uniqueFileName);

            using (var stream = new FileStream(filePath, FileMode.Create))
            {
                await imageFile.CopyToAsync(stream);
            }

            return $"/images/{subFolder}/{uniqueFileName}".Replace(Path.DirectorySeparatorChar, '/');
        }

        [ApiExplorerSettings(IgnoreApi = true)]
        private void DeleteImage(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath)) return;
            var fullPath = Path.Combine(_env.WebRootPath, relativePath.TrimStart('/'));
            if (System.IO.File.Exists(fullPath))
            {
                System.IO.File.Delete(fullPath);
            }
        }

        [HttpGet("overview/{id}")]
        public async Task<IActionResult> GetOverview(int id)
        {
            var kh = await _context.KhachHangs.FindAsync(id);
            if (kh == null) return NotFound();

            var hoaDons = await _context.HoaDons
                .Where(hd => hd.IdKhachHang == id && hd.TrangThai == "Đã thanh toán")
                .ToListAsync();

            var dto = new KhachHangTongQuanDto
            {
                DiemTichLuy = kh.DiemTichLuy,
                NgayTao = kh.NgayTao,
                TongHoaDon = hoaDons.Count,
                TongChiTieu = hoaDons.Sum(hd => hd.ThanhTien) // Sửa: Dùng ThanhTien
            };
            return Ok(dto);
        }

        [HttpGet("{id}")]
        public async Task<IActionResult> GetProfile(int id)
        {
            var kh = await _context.KhachHangs.FindAsync(id);
            if (kh == null) return NotFound();

            var dto = new KhachHangProfileDto
            {
                IdKhachHang = kh.IdKhachHang,
                HoTen = kh.HoTen,
                SoDienThoai = kh.SoDienThoai,
                Email = kh.Email,
                DiaChi = kh.DiaChi,
                TenDangNhap = kh.TenDangNhap,
                AnhDaiDienUrl = GetFullImageUrl(kh.AnhDaiDien)
            };
            return Ok(dto);
        }

        [HttpPut("update-info/{id}")]
        public async Task<IActionResult> UpdateProfile(int id, [FromForm] ProfileUpdateModel model, IFormFile? avatarFile)
        {
            var kh = await _context.KhachHangs.FindAsync(id);
            if (kh == null) return NotFound();

            if (avatarFile != null)
            {
                DeleteImage(kh.AnhDaiDien);
                string baseSlug = SlugifyUtil.GenerateSlug(model.HoTen);
                kh.AnhDaiDien = await SaveImageAsync(avatarFile, "avatars/avatarKH", baseSlug, id);
            }

            kh.HoTen = model.HoTen;
            kh.SoDienThoai = model.SoDienThoai;
            kh.Email = model.Email;
            kh.DiaChi = model.DiaChi;
            kh.TenDangNhap = model.TenDangNhap; // Đã thêm

            await _context.SaveChangesAsync();
            return Ok(new { newAvatarUrl = GetFullImageUrl(kh.AnhDaiDien) });
        }

        [HttpPost("change-password/{id}")]
        public async Task<IActionResult> ChangePassword(int id, [FromBody] PasswordChangeModel model)
        {
            var kh = await _context.KhachHangs.FindAsync(id);
            if (kh == null) return NotFound();

            if (kh.MatKhau != model.MatKhauCu)
            {
                return BadRequest(new { Message = "Mật khẩu cũ không chính xác." });
            }

            kh.MatKhau = model.MatKhauMoi;
            await _context.SaveChangesAsync();
            return Ok(new { Message = "Đổi mật khẩu thành công." });
        }

        [HttpGet("booking-history/{id}")]
        public async Task<IActionResult> GetBookingHistory(int id)
        {
            var bookings = await _context.PhieuDatBans
                .Include(p => p.Ban)
                .Where(p => p.IdKhachHang == id)
                .OrderByDescending(p => p.ThoiGianDat)
                .Select(p => new LichSuDatBanDto
                {
                    IdPhieuDatBan = p.IdPhieuDatBan,
                    TenBan = p.Ban.SoBan, // Sửa từ "TenBan" thành "SoBan"
                    ThoiGianDat = p.ThoiGianDat,
                    SoLuongKhach = p.SoLuongKhach,
                    TrangThai = p.TrangThai,
                    GhiChu = p.GhiChu
                })
                .ToListAsync();

            if (bookings == null)
            {
                return Ok(new List<LichSuDatBanDto>());
            }

            return Ok(bookings);
        }

        [HttpGet("rental-history/{id}")]
        public async Task<IActionResult> GetRentalHistory(int id)
        {
            var rentals = await _context.PhieuThueSachs
                .Include(p => p.ChiTietPhieuThues)
                .Include(p => p.PhieuTraSachs)
                .Where(p => p.IdKhachHang == id)
                .OrderByDescending(p => p.NgayThue)
                .Select(p => new LichSuPhieuThueDto
                {
                    IdPhieuThueSach = p.IdPhieuThueSach,
                    NgayThue = p.NgayThue,
                    TrangThai = p.TrangThai,
                    SoLuongSach = p.ChiTietPhieuThues.Count(),
                    TongTienCoc = p.TongTienCoc,
                    NgayTra = p.PhieuTraSachs.FirstOrDefault() != null ? (DateTime?)p.PhieuTraSachs.FirstOrDefault().NgayTra : null,
                    TongPhiThue = p.PhieuTraSachs.FirstOrDefault() != null ? (decimal?)p.PhieuTraSachs.FirstOrDefault().TongPhiThue : null,
                    TongTienPhat = p.PhieuTraSachs.FirstOrDefault() != null ? (decimal?)p.PhieuTraSachs.FirstOrDefault().TongTienPhat : null,
                    TongTienCocHoan = p.PhieuTraSachs.FirstOrDefault() != null ? (decimal?)p.PhieuTraSachs.FirstOrDefault().TongTienCocHoan : null
                })
                .ToListAsync();

            if (rentals == null)
            {
                return Ok(new List<LichSuPhieuThueDto>());
            }

            return Ok(rentals);
        }

        // ==========================================================
        // === SỬA LỖI 500 API TẠI ĐÂY ===
        // ==========================================================
        [HttpGet("order-history/{id}")]
        public async Task<IActionResult> GetOrderHistory(int id)
        {
            // 1. Tải dữ liệu thô từ CSDL (Không gọi GetFullImageUrl)
            var orders_raw = await _context.HoaDons
                .Include(h => h.ChiTietHoaDons).ThenInclude(ct => ct.SanPham)
                .Where(h => h.IdKhachHang == id && h.LoaiHoaDon == "Giao hàng")
                .OrderByDescending(h => h.ThoiGianTao)
                .Select(h => new // Dùng đối tượng tạm
                {
                    h.IdHoaDon,
                    h.ThoiGianTao,
                    h.TrangThai, // TrangThaiThanhToan
                    h.TrangThaiGiaoHang,
                    h.ThanhTien,
                    Items = h.ChiTietHoaDons.Select(ct => new
                    {
                        ct.IdSanPham,
                        ct.SanPham.TenSanPham,
                        HinhAnhRaw = ct.SanPham.HinhAnh, // Lấy đường dẫn thô
                        ct.SoLuong,
                        ct.DonGia
                    }).ToList()
                })
                .ToListAsync(); // <-- Thực thi SQL ở đây

            // 2. Chuyển đổi sang DTO (Lúc này đã ở trong C#)
            var orders_dto = orders_raw.Select(h => new LichSuDonHangWebDto
            {
                IdHoaDon = h.IdHoaDon,
                ThoiGianTao = h.ThoiGianTao,
                TrangThaiThanhToan = h.TrangThai,
                TrangThaiGiaoHang = h.TrangThaiGiaoHang,
                ThanhTien = h.ThanhTien,
                Items = h.Items.Select(ct => new DonHangItemWebDto
                {
                    IdSanPham = ct.IdSanPham,
                    TenSanPham = ct.TenSanPham,
                    HinhAnhUrl = GetFullImageUrl(ct.HinhAnhRaw), // <-- Gọi hàm C# an toàn
                    SoLuong = ct.SoLuong,
                    DonGia = ct.DonGia
                }).ToList()
            }).ToList();

            return Ok(orders_dto);
        }

        // ==========================================================
        // === YÊU CẦU MỚI: API CHO TRANG CHI TIẾT ĐƠN HÀNG ===
        // ==========================================================
        [HttpGet("order-detail/{id}")]
        public async Task<IActionResult> GetOrderDetail(int id)
        {
            var idKhachHang = GetCurrentUserId();
            if (idKhachHang == 0) return Unauthorized();

            var hoaDon = await _context.HoaDons
                .Include(h => h.ChiTietHoaDons).ThenInclude(ct => ct.SanPham)
                .AsNoTracking()
                .FirstOrDefaultAsync(h => h.IdHoaDon == id && h.IdKhachHang == idKhachHang);

            if (hoaDon == null)
            {
                return NotFound("Không tìm thấy đơn hàng hoặc bạn không có quyền xem.");
            }

            // Giả lập lịch sử vận chuyển
            var trackingEvents = new List<TrackingEventDto>();
            string currentStatus = hoaDon.TrangThaiGiaoHang ?? "Chờ xác nhận";

            // 1. Đặt hàng
            trackingEvents.Add(new TrackingEventDto
            {
                Timestamp = hoaDon.ThoiGianTao,
                Status = "Đơn hàng đã đặt",
                Description = "Đơn hàng của bạn đã được đặt thành công."
            });

            // 2. Xác nhận
            if (currentStatus != "Chờ xác nhận")
            {
                trackingEvents.Add(new TrackingEventDto
                {
                    Timestamp = hoaDon.ThoiGianTao.AddMinutes(15), // Giả lập
                    Status = "Đơn hàng được xác nhận",
                    Description = "Shop đang chuẩn bị hàng."
                });
            }

            // 3. Giao ĐVVC
            if (currentStatus == "Đang giao" || currentStatus == "Hoàn thành")
            {
                trackingEvents.Add(new TrackingEventDto
                {
                    Timestamp = hoaDon.ThoiGianTao.AddMinutes(45), // Giả lập
                    Status = "Đã giao cho ĐVVC",
                    Description = "Đơn hàng đã được bàn giao cho đơn vị vận chuyển."
                });
            }

            // 4. Hoàn thành
            if (currentStatus == "Hoàn thành")
            {
                trackingEvents.Add(new TrackingEventDto
                {
                    Timestamp = hoaDon.ThoiGianThanhToan ?? hoaDon.ThoiGianTao.AddHours(2), // Giả lập
                    Status = "Giao hàng thành công",
                    Description = "Đơn hàng đã được giao đến bạn.",
                    IsCurrent = true // Đây là trạng thái cuối
                });
            }
            else
            {
                // Đánh dấu trạng thái hiện tại
                var lastEvent = trackingEvents.LastOrDefault();
                if (lastEvent != null) lastEvent.IsCurrent = true;
            }


            var dto = new DonHangChiTietWebDto
            {
                IdHoaDon = hoaDon.IdHoaDon,
                MaDonHang = $"HD{hoaDon.IdHoaDon:D6}",
                TrangThaiGiaoHang = hoaDon.TrangThaiGiaoHang ?? "Chờ xác nhận",
                TrangThaiThanhToan = hoaDon.TrangThai,
                ThoiGianTao = hoaDon.ThoiGianTao,

                // Lấy thông tin từ HĐ
                HoTen = hoaDon.KhachHang?.HoTen ?? "Khách hàng",
                SoDienThoai = hoaDon.SoDienThoaiGiaoHang ?? hoaDon.KhachHang?.SoDienThoai ?? "N/A",
                DiaChiGiaoHang = hoaDon.DiaChiGiaoHang ?? hoaDon.KhachHang?.DiaChi ?? "N/A",

                TrackingEvents = trackingEvents.OrderBy(t => t.Timestamp).ToList(),

                Items = hoaDon.ChiTietHoaDons.Select(ct => new DonHangItemWebDto
                {
                    IdSanPham = ct.IdSanPham,
                    TenSanPham = ct.SanPham.TenSanPham,
                    HinhAnhUrl = GetFullImageUrl(ct.SanPham.HinhAnh),
                    SoLuong = ct.SoLuong,
                    DonGia = ct.DonGia
                }).ToList(),

                TongTienHang = hoaDon.TongTienGoc,
                GiamGia = hoaDon.GiamGia, // Gộp cả KM + Điểm
                ThanhTien = hoaDon.ThanhTien,
                PhuongThucThanhToan = hoaDon.PhuongThucThanhToan ?? "N/A"
            };

            return Ok(dto);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\Web\KhachHangTaiKhoanController.cs
================================================================================
﻿// Tập tin: CafebookApi/Controllers/Web/KhachHangTaiKhoanController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApi;
using CafebookModel.Model.ModelWeb;
using CafebookModel.Utils;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using System.IO;
// THÊM CÁC USING SAU:
using Microsoft.IdentityModel.Tokens;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;
using System;

namespace CafebookApi.Controllers.Web
{
    [Route("api/web/taikhoankhach")]
    [ApiController]
    public class KhachHangTaiKhoanController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private readonly IWebHostEnvironment _env;
        private readonly string _baseUrl;
        private readonly IConfiguration _config; // SỬA: Thêm IConfiguration

        public KhachHangTaiKhoanController(CafebookDbContext context, IWebHostEnvironment env, IConfiguration config)
        {
            _context = context;
            _env = env;
            _config = config; // SỬA: Thêm
            if (string.IsNullOrEmpty(_env.WebRootPath))
            {
                _env.WebRootPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot");
            }
            _baseUrl = config.GetValue<string>("Kestrel:Endpoints:Http:Url") ?? "http://127.0.0.1:5166";
        }

        [ApiExplorerSettings(IgnoreApi = true)]
        private string? GetFullImageUrl(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath))
                return null;
            return $"{_baseUrl}{relativePath.Replace(Path.DirectorySeparatorChar, '/')}";
        }

        // --- (Hàm Register giữ nguyên) ---
        // --- (Hàm Register đã được sửa đổi theo logic mới) ---
        [HttpPost("register")]
        public async Task<IActionResult> Register([FromBody] DangKyRequestModel model)
        {
            // 1. Kiểm tra đầu vào cơ bản
            if (model == null || string.IsNullOrEmpty(model.Email) || string.IsNullOrEmpty(model.SoDienThoai) || string.IsNullOrEmpty(model.Password))
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "Vui lòng điền đầy đủ Email, SĐT và Mật khẩu." });
            }

            // 2. KIỂM TRA XUNG ĐỘT VỚI TÀI KHOẢN CHÍNH THỨC (Rule 5)
            // Kiểm tra không trùng Email với người khác (tài khoản chính thức)
            var emailConflict = await _context.KhachHangs
                .FirstOrDefaultAsync(k => k.TaiKhoanTam == false && k.Email == model.Email);

            if (emailConflict != null)
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "Email này đã được sử dụng bởi một tài khoản khác." });
            }

            // Kiểm tra không trùng SĐT với người khác (tài khoản chính thức)
            var phoneConflict = await _context.KhachHangs
                .FirstOrDefaultAsync(k => k.TaiKhoanTam == false && k.SoDienThoai == model.SoDienThoai);

            if (phoneConflict != null)
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "SĐT này đã được sử dụng bởi một tài khoản khác." });
            }

            // 3. TÌM VÀ XỬ LÝ TÀI KHOẢN TẠM
            // Sau khi xác nhận Email và SĐT không xung đột với tài khoản chính,
            // chúng ta tìm tài khoản tạm để hợp nhất.
            var existingTempAccount = await _context.KhachHangs
                .FirstOrDefaultAsync(k => k.TaiKhoanTam == true && (k.Email == model.Email || k.SoDienThoai == model.SoDienThoai));

            KhachHang khachHang;

            if (existingTempAccount != null)
            {
                // Đã tìm thấy tài khoản tạm -> Cập nhật và kích hoạt nó
                khachHang = existingTempAccount;

                // Áp dụng các quy tắc cập nhật/bổ sung
                bool emailMatch = khachHang.Email == model.Email;
                bool phoneMatch = khachHang.SoDienThoai == model.SoDienThoai;

                if (emailMatch && !phoneMatch)
                {
                    // Rule 1 & 4: Email đúng, SĐT sai/trống -> Cập nhật SĐT
                    khachHang.SoDienThoai = model.SoDienThoai;
                }
                else if (!emailMatch && phoneMatch)
                {
                    // Rule 2 & 4: SĐT đúng, Email sai/trống -> Cập nhật Email
                    khachHang.Email = model.Email;
                }
                // Rule 3: Cả hai đều đúng -> Không làm gì

                // Kích hoạt tài khoản
                khachHang.MatKhau = model.Password;
                khachHang.NgayTao = DateTime.Now; // Cập nhật ngày tạo là ngày đăng ký
                khachHang.TaiKhoanTam = false;
                khachHang.BiKhoa = false;

                // Cập nhật HoTen nếu nó đang là email (trường hợp tài khoản tạm chỉ có email)
                if (khachHang.HoTen == existingTempAccount.Email)
                {
                    khachHang.HoTen = model.Email; // Cập nhật HoTen thành email mới (nếu có)
                }

                _context.KhachHangs.Update(khachHang);
            }
            else
            {
                // 4. TẠO MỚI (Không tìm thấy tài khoản tạm)
                // Tạo tài khoản mới hoàn toàn
                khachHang = new KhachHang
                {
                    HoTen = model.Email, // Mặc định HoTen là Email khi đăng ký
                    Email = model.Email,
                    SoDienThoai = model.SoDienThoai,
                    TenDangNhap = model.Email,
                    MatKhau = model.Password,
                    NgayTao = DateTime.Now,
                    DiemTichLuy = 0,
                    BiKhoa = false,
                    TaiKhoanTam = false // Tài khoản chính thức
                };
                _context.KhachHangs.Add(khachHang);
            }

            // 5. LƯU THAY ĐỔI VÀ TRẢ VỀ KẾT QUẢ
            await _context.SaveChangesAsync();

            // Tạo DTO và Token
            var dto = new KhachHangDto
            {
                IdKhachHang = khachHang.IdKhachHang,
                HoTen = khachHang.HoTen,
                Email = khachHang.Email,
                SoDienThoai = khachHang.SoDienThoai,
                TenDangNhap = khachHang.TenDangNhap,
                AnhDaiDienUrl = GetFullImageUrl(khachHang.AnhDaiDien)
            };

            // Tạo JWT Token
            string token = GenerateJwtToken(khachHang);

            return Ok(new WebLoginResponseModel { Success = true, KhachHangData = dto, Token = token });
        }


        [HttpPost("login")]
        public async Task<IActionResult> Login([FromBody] LoginRequestModel model)
        {
            if (model == null || string.IsNullOrEmpty(model.TenDangNhap) || string.IsNullOrEmpty(model.MatKhau))
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "Thông tin không hợp lệ." });
            }

            var userInput = model.TenDangNhap.Trim();
            var passInput = model.MatKhau.Trim();
            var khachHang = await _context.KhachHangs.FirstOrDefaultAsync(k =>
                (k.TenDangNhap == userInput || k.SoDienThoai == userInput || k.Email == userInput) &&
                (k.MatKhau == passInput)
            );
            if (khachHang == null)
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "Sai thông tin đăng nhập hoặc mật khẩu." });
            }

            if (khachHang.BiKhoa)
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "Tài khoản này đã bị khóa. Vui lòng liên hệ quản trị viên." });
            }

            if (khachHang.TaiKhoanTam)
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "Tài khoản này là tài khoản tạm. Vui lòng dùng chức năng Đăng Ký để kích hoạt." });
            }

            var dto = new KhachHangDto
            {
                IdKhachHang = khachHang.IdKhachHang,
                HoTen = khachHang.HoTen,
                Email = khachHang.Email,
                SoDienThoai = khachHang.SoDienThoai,
                TenDangNhap = khachHang.TenDangNhap,
                AnhDaiDienUrl = GetFullImageUrl(khachHang.AnhDaiDien)
            };

            // SỬA: Tạo và trả về JWT Token
            string token = GenerateJwtToken(khachHang);
            return Ok(new WebLoginResponseModel { Success = true, KhachHangData = dto, Token = token });
        }

        // --- THÊM MỚI: Hàm helper tạo JWT ---
        [ApiExplorerSettings(IgnoreApi = true)]
        private string GenerateJwtToken(KhachHang khachHang)
        {
            var tokenHandler = new JwtSecurityTokenHandler();
            var key = Encoding.ASCII.GetBytes(_config["Jwt:Key"]!);

            var claims = new List<Claim>
            {
                // Thêm các Claim giống như trong DangNhapView.cshtml.cs
                new Claim(ClaimTypes.NameIdentifier, khachHang.IdKhachHang.ToString()),
                new Claim(ClaimTypes.Name, khachHang.TenDangNhap ?? khachHang.Email ?? ""),
                new Claim(ClaimTypes.GivenName, khachHang.HoTen),
                new Claim(ClaimTypes.Email, khachHang.Email ?? ""),
                new Claim(ClaimTypes.MobilePhone, khachHang.SoDienThoai ?? ""),
                new Claim(ClaimTypes.Role, "KhachHang"), // Quan trọng
                
                // Thêm Claim "IdNhanVien" (dù là khách) để đồng bộ với App,
                // nhưng set giá trị là 0 hoặc ID khách.
                // Tốt nhất là dùng claim riêng. Chúng ta sẽ dùng NameIdentifier.
                new Claim(JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString())
            };

            var tokenDescriptor = new SecurityTokenDescriptor
            {
                Subject = new ClaimsIdentity(claims),
                Expires = DateTime.UtcNow.AddDays(7), // Token hết hạn sau 7 ngày
                Issuer = _config["Jwt:Issuer"],
                Audience = _config["Jwt:Audience"],
                SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Signature)
            };
            var token = tokenHandler.CreateToken(tokenDescriptor);
            return tokenHandler.WriteToken(token);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\Web\LienHeController.cs
================================================================================
﻿// Tập tin: CafebookApi/Controllers/Web/LienHeController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;
using System.Collections.Generic; // Thêm

namespace CafebookApi.Controllers.Web
{
    [Route("api/web/lienhe")]
    [ApiController]
    public class LienHeController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public LienHeController(CafebookDbContext context)
        {
            _context = context;
        }

        // Hàm helper để lấy giá trị an toàn
        private string? GetSettingValue(List<CafebookModel.Model.Entities.CaiDat> settings, string key)
        {
            // Trả về null nếu giá trị là chuỗi rỗng hoặc null
            var value = settings.FirstOrDefault(c => c.TenCaiDat == key)?.GiaTri;
            return string.IsNullOrWhiteSpace(value) ? null : value;
        }

        /// <summary>
        /// API lấy toàn bộ thông tin cho Trang Liên Hệ
        /// </summary>
        [HttpGet("info")]
        public async Task<IActionResult> GetContactInfo()
        {
            var keysToFetch = new[] {
                "GioiThieu", "DiaChi", "SoDienThoai", "LienHe_Email", "LienHe_GioMoCua",
                "LienHe_Facebook", "LienHe_Instagram", "LienHe_GoogleMapsEmbed", "LienHe_Zalo", "LienHe_Youtube"
            };

            var settings = await _context.CaiDats
                .Where(c => keysToFetch.Contains(c.TenCaiDat))
                .ToListAsync();

            var dto = new LienHeDto
            {
                GioiThieu = GetSettingValue(settings, "GioiThieu"),
                DiaChi = GetSettingValue(settings, "DiaChi"),
                SoDienThoai = GetSettingValue(settings, "SoDienThoai"),
                EmailLienHe = GetSettingValue(settings, "LienHe_Email"),
                GioMoCua = GetSettingValue(settings, "LienHe_GioMoCua"),
                LinkFacebook = GetSettingValue(settings, "LienHe_Facebook"),
                LinkInstagram = GetSettingValue(settings, "LienHe_Instagram"),
                LinkGoogleMapsEmbed = GetSettingValue(settings, "LienHe_GoogleMapsEmbed"),
                LinkZalo = GetSettingValue(settings, "LienHe_Zalo"),
                LinkYoutube = GetSettingValue(settings, "LienHe_Youtube")
            };

            return Ok(dto);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\Web\NhanVienTaiKhoanController.cs
================================================================================
﻿// Tập tin: CafebookApi/Controllers/Web/NhanVienTaiKhoanController.cs
using CafebookApi.Data;
using CafebookModel.Model.Data;
using CafebookModel.Model.ModelApi;
using CafebookModel.Utils; // THÊM
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Microsoft.AspNetCore.Hosting; // THÊM
using Microsoft.Extensions.Configuration; // THÊM
using System.IO; // THÊM

namespace CafebookApi.Controllers.Web
{
    [Route("api/web/taikhoannv")]
    [ApiController]
    public class NhanVienTaiKhoanController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        // --- THÊM MỚI (Giống các controller khác) ---
        private readonly IWebHostEnvironment _env;
        private readonly string _baseUrl;

        public NhanVienTaiKhoanController(CafebookDbContext context, IWebHostEnvironment env, IConfiguration config)
        {
            _context = context;
            _env = env;
            if (string.IsNullOrEmpty(_env.WebRootPath))
            {
                _env.WebRootPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot");
            }
            _baseUrl = config.GetValue<string>("Kestrel:Endpoints:Http:Url") ?? "http://127.0.0.1:5166";
        }

        // --- THÊM MỚI: Hàm helper ---
        [ApiExplorerSettings(IgnoreApi = true)]
        private string? GetFullImageUrl(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath))
                return null;
            return $"{_baseUrl}{relativePath.Replace(Path.DirectorySeparatorChar, '/')}";
        }
        // -------------------------

        [HttpPost("login")]
        public async Task<IActionResult> Login([FromBody] LoginRequestModel model)
        {
            if (model == null || string.IsNullOrEmpty(model.TenDangNhap) || string.IsNullOrEmpty(model.MatKhau))
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "Thông tin không hợp lệ." });
            }

            var userInput = model.TenDangNhap.Trim();
            var passInput = model.MatKhau.Trim();
            // 1. TÌM KIẾM NHÂN VIÊN (Tận dụng logic từ API của WPF)
            var nhanVien = await _context.NhanViens
                .Include(nv => nv.VaiTro)
                .ThenInclude(vt => vt.VaiTroQuyens)
                .ThenInclude(vtq => vtq.Quyen)
                .FirstOrDefaultAsync(nv =>
                    (nv.TenDangNhap == userInput || nv.SoDienThoai == userInput || nv.Email == userInput) &&
                    (nv.MatKhau == passInput)
                );
            if (nhanVien == null || nhanVien.VaiTro == null)
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "Sai thông tin đăng nhập hoặc mật khẩu." });
            }

            // 2. TẠO NhanVienDto (SỬA ĐỔI)
            var dto = new NhanVienDto
            {
                IdNhanVien = nhanVien.IdNhanVien,
                HoTen = nhanVien.HoTen,
                // SỬA: Trả về URL thay vì Base64
                AnhDaiDien = GetFullImageUrl(nhanVien.AnhDaiDien),
                TenVaiTro = nhanVien.VaiTro.TenVaiTro,
                DanhSachQuyen = nhanVien.VaiTro.VaiTroQuyens
                                    .Select(vtq => vtq.IdQuyen)
                                    .ToList()
            };
            return Ok(new WebLoginResponseModel { Success = true, NhanVienData = dto });
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\Web\PasswordResetController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.Web
{
    [Route("api/web/password")]
    [ApiController]
    public class PasswordResetController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public PasswordResetController(CafebookDbContext context)
        {
            _context = context;
        }

        // API kiểm tra Email
        [HttpPost("check-email")]
        public async Task<IActionResult> CheckEmailExists([FromBody] CheckEmailRequestDto model)
        {
            if (model == null || string.IsNullOrEmpty(model.Email))
                return BadRequest(new { Message = "Email là bắt buộc." });

            var khachHang = await _context.KhachHangs
                .FirstOrDefaultAsync(kh => kh.Email == model.Email);

            if (khachHang == null)
                return NotFound(new { Message = "Email không được tìm thấy trong hệ thống." });

            if (khachHang.BiKhoa)
                return BadRequest(new { Message = "Tài khoản này đang bị khóa. Không thể đặt lại mật khẩu." });

            return Ok(); // Email hợp lệ
        }

        // API đặt lại mật khẩu
        [HttpPost("reset")]
        public async Task<IActionResult> ResetPassword([FromBody] ResetPasswordRequestDto model)
        {
            if (model == null || string.IsNullOrEmpty(model.Email) || string.IsNullOrEmpty(model.NewPassword))
                return BadRequest(new { Message = "Dữ liệu không hợp lệ." });

            var khachHang = await _context.KhachHangs
                .FirstOrDefaultAsync(kh => kh.Email == model.Email);

            if (khachHang == null)
                return NotFound(new { Message = "Email không được tìm thấy." });

            // (Trong thực tế, bạn phải HASH mật khẩu này)
            khachHang.MatKhau = model.NewPassword;

            await _context.SaveChangesAsync();
            return Ok(new { Message = "Đặt lại mật khẩu thành công." });
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\Web\ThanhToanControllers.cs
================================================================================
﻿// Tập tin: CafebookApi/Controllers/Web/ThanhToanController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Security.Claims;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.Web
{
    [Route("api/web/thanhtoan")]
    [ApiController]
    [Authorize(Roles = "KhachHang")]
    public class ThanhToanController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public ThanhToanController(CafebookDbContext context)
        {
            _context = context;
        }

        private int GetCurrentUserId()
        {
            var idClaim = User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier);
            int.TryParse(idClaim?.Value, out int id);
            return id;
        }

        [HttpGet("load")]
        public async Task<IActionResult> LoadCheckoutData()
        {
            var idKhachHang = GetCurrentUserId();
            if (idKhachHang == 0) return Unauthorized();

            var khachHang = await _context.KhachHangs.FindAsync(idKhachHang);
            if (khachHang == null) return NotFound("Không tìm thấy khách hàng.");

            var settings = await _context.CaiDats.ToDictionaryAsync(c => c.TenCaiDat, c => c.GiaTri);
            decimal.TryParse(settings.GetValueOrDefault("DiemTichLuy_DoiVND", "1000"), out var tiLeDoiDiem);

            var khuyenMais = await _context.KhuyenMais
                .Where(km => km.TrangThai == "Hoạt động" && km.NgayBatDau <= DateTime.Now && km.NgayKetThuc >= DateTime.Now)
                .Select(km => new KhuyenMaiThanhToanDto
                {
                    IdKhuyenMai = km.IdKhuyenMai,
                    TenChuongTrinh = km.TenChuongTrinh,
                    MaKhuyenMai = km.MaKhuyenMai,
                    LoaiGiamGia = km.LoaiGiamGia,
                    GiaTriGiam = km.GiaTriGiam,
                    GiamToiDa = km.GiamToiDa,
                    IdSanPhamApDung = km.IdSanPhamApDung,
                    DieuKienApDung = km.DieuKienApDung,
                    HoaDonToiThieu = km.HoaDonToiThieu,

                    // =======================================
                    // === THÊM 3 TRƯỜNG MỚI TẠI ĐÂY ===
                    // =======================================
                    NgayTrongTuan = km.NgayTrongTuan,
                    GioBatDau = km.GioBatDau,
                    GioKetThuc = km.GioKetThuc
                })
                .ToListAsync();

            var dto = new ThanhToanLoadDto
            {
                KhachHang = new KhachHangThanhToanDto
                {
                    IdKhachHang = khachHang.IdKhachHang,
                    HoTen = khachHang.HoTen,
                    SoDienThoai = khachHang.SoDienThoai ?? "",
                    Email = khachHang.Email ?? "",
                    DiaChi = khachHang.DiaChi ?? "",
                    DiemTichLuy = khachHang.DiemTichLuy
                },
                KhuyenMaisHopLe = khuyenMais,
                TiLeDoiDiemVND = tiLeDoiDiem
            };

            return Ok(dto);
        }

        // ... (Hàm SubmitOrder, CalculateDiscount, GetOrderSummary giữ nguyên) ...
        [HttpPost("submit")]
        public async Task<IActionResult> SubmitOrder([FromBody] ThanhToanSubmitDto dto)
        {
            var idKhachHang = GetCurrentUserId();
            if (idKhachHang == 0) return Unauthorized();

            var khachHang = await _context.KhachHangs.FindAsync(idKhachHang);
            if (khachHang == null) return NotFound("Không tìm thấy khách hàng.");

            var sanPhamCartItems = dto.ItemsToPurchase; // Sửa: Đã xóa Loai
            if (!sanPhamCartItems.Any())
            {
                return BadRequest(new ThanhToanResponseDto { Success = false, Message = "Không có sản phẩm nào trong giỏ hàng để thanh toán." });
            }

            var settings = await _context.CaiDats.ToDictionaryAsync(c => c.TenCaiDat, c => c.GiaTri);
            decimal.TryParse(settings.GetValueOrDefault("DiemTichLuy_DoiVND", "1000"), out var tiLeDoiDiem);
            decimal.TryParse(settings.GetValueOrDefault("DiemTichLuy_NhanVND", "10000"), out var tiLeNhanDiem);

            await using var transaction = await _context.Database.BeginTransactionAsync();
            try
            {
                var productIds = sanPhamCartItems.Select(i => i.Id).ToList();
                var productsInDb = await _context.SanPhams
                    .Where(p => productIds.Contains(p.IdSanPham))
                    .ToDictionaryAsync(p => p.IdSanPham);

                var hoaDon = new HoaDon
                {
                    IdKhachHang = idKhachHang,
                    IdNhanVien = null,
                    ThoiGianTao = DateTime.Now,
                    // SỬA: Logic thanh toán
                    TrangThai = (dto.PhuongThucThanhToan == "COD") ? "Chưa thanh toán" : "Đã thanh toán",
                    LoaiHoaDon = "Giao hàng",
                    DiaChiGiaoHang = dto.DiaChiGiaoHang,
                    SoDienThoaiGiaoHang = dto.SoDienThoai,
                    GhiChu = dto.GhiChu,
                    PhuongThucThanhToan = dto.PhuongThucThanhToan,
                    // SỬA: Gán trạng thái giao hàng
                    TrangThaiGiaoHang = "Chờ xác nhận",
                    TongTienGoc = 0,
                    GiamGia = 0
                };

                _context.HoaDons.Add(hoaDon);
                await _context.SaveChangesAsync();

                decimal tongTienGoc = 0;
                var chiTietTach = new List<ChiTietHoaDon>();

                foreach (var item in sanPhamCartItems)
                {
                    if (productsInDb.TryGetValue(item.Id, out var sanPhamDb))
                    {
                        var chiTiet = new ChiTietHoaDon
                        {
                            IdHoaDon = hoaDon.IdHoaDon,
                            IdSanPham = item.Id,
                            SoLuong = item.SoLuong,
                            DonGia = sanPhamDb.GiaBan,
                            SanPham = sanPhamDb
                        };
                        _context.ChiTietHoaDons.Add(chiTiet);
                        chiTietTach.Add(chiTiet);
                        tongTienGoc += (sanPhamDb.GiaBan * item.SoLuong);
                    }
                }
                hoaDon.TongTienGoc = tongTienGoc;

                decimal giamGiaKM = 0;
                decimal giamGiaDiem = 0;

                if (dto.IdKhuyenMai.HasValue && dto.IdKhuyenMai > 0)
                {
                    var km = await _context.KhuyenMais.FindAsync(dto.IdKhuyenMai.Value);
                    if (km != null)
                    {
                        giamGiaKM = await CalculateDiscount(km, hoaDon.TongTienGoc, chiTietTach);
                        _context.HoaDonKhuyenMais.Add(new HoaDon_KhuyenMai { IdHoaDon = hoaDon.IdHoaDon, IdKhuyenMai = km.IdKhuyenMai });
                        if (km.SoLuongConLai.HasValue && km.SoLuongConLai > 0) km.SoLuongConLai -= 1;
                    }
                }

                if (dto.DiemSuDung > 0)
                {
                    if (khachHang.DiemTichLuy < dto.DiemSuDung)
                    {
                        await transaction.RollbackAsync();
                        return BadRequest(new ThanhToanResponseDto { Success = false, Message = "Bạn không đủ điểm tích lũy." });
                    }
                    giamGiaDiem = dto.DiemSuDung * tiLeDoiDiem;
                    decimal tongTruocDiem = hoaDon.TongTienGoc - giamGiaKM;

                    // Logic 50%
                    decimal maxAllowedPointDiscount = tongTruocDiem * 0.5m;
                    if (giamGiaDiem > maxAllowedPointDiscount)
                    {
                        giamGiaDiem = maxAllowedPointDiscount;
                    }
                    int diemBiTru = (int)Math.Ceiling(giamGiaDiem / tiLeDoiDiem);
                    if (diemBiTru > khachHang.DiemTichLuy) diemBiTru = khachHang.DiemTichLuy;

                    khachHang.DiemTichLuy -= diemBiTru;
                }

                hoaDon.GiamGia = giamGiaKM + giamGiaDiem;

                await _context.SaveChangesAsync();
                await _context.Entry(hoaDon).ReloadAsync();

                if (dto.DiemSuDung == 0 && tiLeNhanDiem > 0)
                {
                    int diemNhan = (int)Math.Floor(hoaDon.ThanhTien / tiLeNhanDiem);
                    if (diemNhan > 0)
                    {
                        khachHang.DiemTichLuy += diemNhan;
                    }
                }

                var giaoDich = new GiaoDichThanhToan
                {
                    IdHoaDon = hoaDon.IdHoaDon,
                    MaGiaoDichNgoai = $"WEB_{hoaDon.IdHoaDon}",
                    CongThanhToan = dto.PhuongThucThanhToan,
                    SoTien = hoaDon.ThanhTien,
                    ThoiGianGiaoDich = DateTime.Now,
                    TrangThai = (dto.PhuongThucThanhToan == "COD") ? "Chờ thanh toán" : "Thành công"
                };
                _context.GiaoDichThanhToans.Add(giaoDich);

                await _context.SaveChangesAsync();
                await transaction.CommitAsync();

                var thongBao = new ThongBao
                {
                    NoiDung = $"Đơn hàng Giao hàng mới #{hoaDon.IdHoaDon} từ {khachHang.HoTen} đang chờ xác nhận.",
                    LoaiThongBao = "DonHangMoi",
                    IdLienQuan = hoaDon.IdHoaDon,
                    ThoiGianTao = DateTime.Now,
                    DaXem = false
                };
                _context.ThongBaos.Add(thongBao);
                await _context.SaveChangesAsync();

                return Ok(new ThanhToanResponseDto { Success = true, Message = "Đặt hàng thành công!", IdHoaDonMoi = hoaDon.IdHoaDon });
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                return StatusCode(500, new ThanhToanResponseDto { Success = false, Message = $"Lỗi máy chủ: {ex.Message}" });
            }
        }

        private async Task<decimal> CalculateDiscount(KhuyenMai km, decimal tongTienGoc, ICollection<ChiTietHoaDon> chiTietList)
        {
            decimal tongTienGocChoKM = tongTienGoc;
            if (km.IdSanPhamApDung.HasValue)
            {
                tongTienGocChoKM = chiTietList
                    .Where(c => c.IdSanPham == km.IdSanPhamApDung.Value)
                    .Sum(c => c.ThanhTien);
            }

            decimal giamGia = 0;
            if (string.Equals(km.LoaiGiamGia, "PhanTram", StringComparison.OrdinalIgnoreCase))
            {
                giamGia = tongTienGocChoKM * (km.GiaTriGiam / 100);
                if (km.GiamToiDa.HasValue && giamGia > km.GiamToiDa.Value)
                {
                    giamGia = km.GiamToiDa.Value;
                }
            }
            else
            {
                giamGia = Math.Min(km.GiaTriGiam, tongTienGocChoKM);
            }
            return await Task.FromResult(giamGia);
        }

        [HttpGet("order-summary/{id}")]
        public async Task<IActionResult> GetOrderSummary(int id)
        {
            var idKhachHang = GetCurrentUserId();
            if (idKhachHang == 0) return Unauthorized();

            var hoaDon = await _context.HoaDons
                .Include(h => h.ChiTietHoaDons).ThenInclude(ct => ct.SanPham)
                .AsNoTracking()
                .FirstOrDefaultAsync(h => h.IdHoaDon == id && h.IdKhachHang == idKhachHang);

            if (hoaDon == null)
            {
                return NotFound("Không tìm thấy đơn hàng hoặc bạn không có quyền xem.");
            }

            var dto = new ThanhToanThanhCongDto
            {
                IdHoaDonMoi = hoaDon.IdHoaDon,
                ThoiGianTao = hoaDon.ThoiGianTao,
                TrangThai = hoaDon.TrangThai,
                PhuongThucThanhToan = hoaDon.PhuongThucThanhToan ?? "N/A",
                DiaChiGiaoHang = hoaDon.DiaChiGiaoHang ?? "N/A",
                SoDienThoai = hoaDon.SoDienThoaiGiaoHang ?? "N/A",
                TongTienHang = hoaDon.TongTienGoc,
                GiamGia = hoaDon.GiamGia,
                ThanhTien = hoaDon.ThanhTien,
                Items = hoaDon.ChiTietHoaDons.Select(ct => new GioHangItemViewModel
                {
                    Id = ct.IdSanPham,
                    // SỬA: Xóa 'Loai'
                    TenHienThi = ct.SanPham.TenSanPham,
                    DonGia = ct.DonGia,
                    SoLuong = ct.SoLuong
                }).ToList()
            };

            return Ok(dto);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\Web\ThucDonController.cs
================================================================================
﻿// Tập tin: CafebookApi/Controllers/Web/ThucDonController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelWeb;
using CafebookModel.Model.ModelApp; // For FilterLookupDto
using CafebookModel.Utils;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using System.IO;
using System.Threading.Tasks;
using System.Linq;
using System.Collections.Generic;
using System;

namespace CafebookApi.Controllers.Web
{
    [Route("api/web/thucdon")]
    [ApiController]
    public class ThucDonController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private readonly IWebHostEnvironment _env;
        private readonly string _baseUrl;

        // (Constructor và GetFullImageUrl, GetFilters giữ nguyên)
        public ThucDonController(CafebookDbContext context, IWebHostEnvironment env, IConfiguration config)
        {
            _context = context;
            _env = env;
            if (string.IsNullOrEmpty(_env.WebRootPath))
            {
                _env.WebRootPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot");
            }
            _baseUrl = config.GetValue<string>("Kestrel:Endpoints:Http:Url") ?? "http://127.0.0.1:5166";
        }

        [ApiExplorerSettings(IgnoreApi = true)]
        private string? GetFullImageUrl(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath))
                return null;
            return $"{_baseUrl}{relativePath.Replace(Path.DirectorySeparatorChar, '/')}";
        }

        [HttpGet("filters")]
        public async Task<IActionResult> GetFilters()
        {
            var danhMucs = await _context.DanhMucs
                .OrderBy(d => d.TenDanhMuc)
                .Select(d => new FilterLookupDto { Id = d.IdDanhMuc, Ten = d.TenDanhMuc })
                .ToListAsync();
            return Ok(danhMucs);
        }

        /// <summary>
        /// API tìm kiếm, lọc và phân trang Thực đơn
        /// </summary>
        [HttpGet("search")]
        // SỬA LỖI CS1737: Di chuyển các tham số optional (có giá trị mặc định) xuống cuối
        public async Task<IActionResult> Search(
            [FromQuery] int? loaiId,
            [FromQuery] string? search,
            [FromQuery] decimal? giaMin,  // <-- ĐÃ DI CHUYỂN LÊN
            [FromQuery] decimal? giaMax,  // <-- ĐÃ DI CHUYỂN LÊN
            [FromQuery] string sortBy = "ten_asc", // <-- ĐÃ DI CHUYỂN XUỐNG
            [FromQuery] int pageNum = 1,
            [FromQuery] int pageSize = 9)
        {
            var query = _context.SanPhams
                .Include(s => s.DanhMuc)
                .Where(s => s.TrangThaiKinhDoanh == true);

            // Lọc
            if (loaiId.HasValue && loaiId > 0)
                query = query.Where(s => s.IdDanhMuc == loaiId);

            if (giaMin.HasValue)
                query = query.Where(s => s.GiaBan >= giaMin);

            if (giaMax.HasValue)
                query = query.Where(s => s.GiaBan <= giaMax);

            if (!string.IsNullOrEmpty(search))
                query = query.Where(s => s.TenSanPham.Contains(search));

            // Sắp xếp
            query = sortBy switch
            {
                "ten_desc" => query.OrderByDescending(s => s.TenSanPham),
                "gia_asc" => query.OrderBy(s => s.GiaBan),
                "gia_desc" => query.OrderByDescending(s => s.GiaBan),
                _ => query.OrderBy(s => s.TenSanPham), // Mặc định ten_asc
            };

            // Phân trang
            var totalItems = await query.CountAsync();
            var totalPages = (int)Math.Ceiling(totalItems / (double)pageSize);

            // Bước 1: Lấy dữ liệu thô (gồm path)
            var items_raw = await query
                .Skip((pageNum - 1) * pageSize)
                .Take(pageSize)
                .Select(s => new {
                    s.IdSanPham,
                    s.TenSanPham,
                    TenLoaiSP = s.DanhMuc.TenDanhMuc,
                    s.GiaBan,
                    s.HinhAnh
                })
                .ToListAsync();

            // Bước 2: Chuyển đổi sang DTO (gọi GetFullImageUrl)
            var items_dto = items_raw.Select(s => new SanPhamThucDonDto
            {
                IdSanPham = s.IdSanPham,
                TenSanPham = s.TenSanPham,
                TenLoaiSP = s.TenLoaiSP,
                DonGia = s.GiaBan,
                AnhSanPhamUrl = GetFullImageUrl(s.HinhAnh)
            }).ToList();

            var result = new ThucDonDto
            {
                Items = items_dto,
                TotalPages = totalPages,
                CurrentPage = pageNum
            };
            return Ok(result);
        }

        /// <summary>
        /// API lấy chi tiết 1 sản phẩm (gồm định lượng)
        /// </summary>
        [HttpGet("{id}")]
        public async Task<IActionResult> GetDetails(int id)
        {
            var sp = await _context.SanPhams
                .Include(s => s.DanhMuc)
                .Include(s => s.DinhLuongs)
                    .ThenInclude(d => d.NguyenLieu)
                .AsNoTracking()
                .FirstOrDefaultAsync(s => s.IdSanPham == id);

            if (sp == null)
                return NotFound(new { Message = "Không tìm thấy sản phẩm." });

            // THÊM MỚI: Lấy danh sách gợi ý
            var suggestions_raw = await _context.DeXuatSanPhams
                .Where(d => d.IdSanPhamGoc == id) // Tìm các món được gợi ý TỪ món này
                .Include(d => d.SanPhamDeXuat)    // Lấy thông tin của món ĐƯỢC gợi ý
                .OrderByDescending(d => d.DoLienQuan)
                .Take(4) // Lấy 4 món
                .Select(d => d.SanPhamDeXuat) // Chỉ chọn sản phẩm được gợi ý
                .ToListAsync();

            // Chuyển đổi gợi ý sang DTO (chạy trong C#)
            var suggestions_dto = suggestions_raw.Select(s => new SanPhamThucDonDto
            {
                IdSanPham = s.IdSanPham,
                TenSanPham = s.TenSanPham,
                TenLoaiSP = null, // Không cần thiết cho card gợi ý
                DonGia = s.GiaBan,
                AnhSanPhamUrl = GetFullImageUrl(s.HinhAnh)
            }).ToList();


            var dto = new SanPhamChiTietDto
            {
                IdSanPham = sp.IdSanPham,
                TenSanPham = sp.TenSanPham,
                TenLoaiSP = sp.DanhMuc?.TenDanhMuc,
                DonGia = sp.GiaBan,
                HinhAnhUrl = GetFullImageUrl(sp.HinhAnh),
                MoTa = sp.MoTa,
                CongThucs = sp.DinhLuongs.Select(d => new CongThucDto
                {
                    TenNguyenLieu = d.NguyenLieu.TenNguyenLieu
                }).ToList(),

                // Gán danh sách gợi ý
                GoiY = suggestions_dto
            };
            return Ok(dto);
        }
    }
}
    

================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\Web\ThuVienSachController.cs
================================================================================
﻿// Tập tin: CafebookApi/Controllers/Web/ThuVienSachController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelWeb;
using CafebookModel.Model.ModelApp;
using CafebookModel.Utils;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using System.IO;
using System.Threading.Tasks;
using System.Linq;
using System.Collections.Generic;
using System;

namespace CafebookApi.Controllers.Web
{
    [Route("api/web/thuvien")]
    [ApiController]
    public class ThuVienSachController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private readonly IWebHostEnvironment _env;
        private readonly string _baseUrl;

        public ThuVienSachController(CafebookDbContext context, IWebHostEnvironment env, IConfiguration config)
        {
            _context = context;
            _env = env;
            if (string.IsNullOrEmpty(_env.WebRootPath))
            {
                _env.WebRootPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot");
            }
            _baseUrl = config.GetValue<string>("Kestrel:Endpoints:Http:Url") ?? "http://127.0.0.1:5166";
        }

        // Helper lấy URL ảnh
        [ApiExplorerSettings(IgnoreApi = true)]
        private string? GetFullImageUrl(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath)) return null;
            return $"{_baseUrl}{relativePath.Replace(Path.DirectorySeparatorChar, '/')}";
        }

        // API lấy bộ lọc (Giữ nguyên)
        [HttpGet("filters")]
        public async Task<IActionResult> GetFilters()
        {
            var filters = new CafebookModel.Model.ModelWeb.SachFiltersDto
            {
                TheLoais = await _context.TheLoais
                    .OrderBy(d => d.TenTheLoai)
                    .Select(d => new CafebookModel.Model.ModelApp.FilterLookupDto { Id = d.IdTheLoai, Ten = d.TenTheLoai })
                    .ToListAsync()
            };
            return Ok(filters);
        }

        // API trang thư viện chính (Giữ nguyên)
        [HttpGet("search")]
        public async Task<IActionResult> Search(
            [FromQuery] string? search,
            [FromQuery] int? theLoaiId,
            [FromQuery] string? trangThai,
            [FromQuery] string sortBy = "ten_asc",
            [FromQuery] int pageNum = 1,
            [FromQuery] int pageSize = 12)
        {
            var query = _context.Sachs.AsQueryable();

            if (theLoaiId.HasValue && theLoaiId > 0)
                query = query.Where(s => s.SachTheLoais.Any(stl => stl.IdTheLoai == theLoaiId));

            if (trangThai == "con_sach")
                query = query.Where(s => s.SoLuongHienCo > 0);
            else if (trangThai == "het_sach")
                query = query.Where(s => s.SoLuongHienCo <= 0);

            if (!string.IsNullOrEmpty(search))
            {
                var searchLower = search.ToLower();
                query = query.Where(s =>
                    s.TenSach.ToLower().Contains(searchLower) ||
                    s.SachTacGias.Any(stg => stg.TacGia.TenTacGia.ToLower().Contains(searchLower))
                );
            }

            query = sortBy switch
            {
                "ten_desc" => query.OrderByDescending(s => s.TenSach),
                "gia_asc" => query.OrderBy(s => s.GiaBia),
                "gia_desc" => query.OrderByDescending(s => s.GiaBia),
                _ => query.OrderBy(s => s.TenSach),
            };

            var totalItems = await query.CountAsync();
            var totalPages = (int)Math.Ceiling(totalItems / (double)pageSize);

            var items_raw = await query
                .Skip((pageNum - 1) * pageSize)
                .Take(pageSize)
                .Select(s => new {
                    s.IdSach,
                    s.TenSach,
                    TacGia = string.Join(", ", s.SachTacGias.Select(stg => stg.TacGia.TenTacGia)),
                    s.GiaBia,
                    s.SoLuongHienCo,
                    s.AnhBia
                })
                .ToListAsync();

            var items_dto = items_raw.Select(s => new SachCardDto
            {
                IdSach = s.IdSach,
                TieuDe = s.TenSach,
                TacGia = string.IsNullOrEmpty(s.TacGia) ? "Không rõ" : s.TacGia,
                GiaBia = s.GiaBia ?? 0,
                SoLuongCoSan = s.SoLuongHienCo,
                AnhBiaUrl = GetFullImageUrl(s.AnhBia)
            }).ToList();

            var result = new SachPhanTrangDto
            {
                Items = items_dto,
                TotalPages = totalPages,
                CurrentPage = pageNum
            };
            return Ok(result);
        }

        // API trang chi tiết sách (SỬA LẠI)
        [HttpGet("{id}")]
        public async Task<IActionResult> GetSachChiTiet(int id)
        {
            var sach = await _context.Sachs
                .Include(s => s.SachTacGias).ThenInclude(stg => stg.TacGia)
                .Include(s => s.SachTheLoais).ThenInclude(stl => stl.TheLoai)
                .Include(s => s.SachNhaXuatBans).ThenInclude(snxb => snxb.NhaXuatBan)
                .Include(s => s.DeXuatSachGocs).ThenInclude(ds => ds.SachDeXuat)
                .Where(s => s.IdSach == id)
                .Select(s => new SachChiTietDto
                {
                    IdSach = s.IdSach,
                    TieuDe = s.TenSach,
                    AnhBiaUrl = s.AnhBia, // Lấy đường dẫn thô
                    MoTa = s.MoTa,
                    GiaBia = s.GiaBia ?? 0,
                    ViTri = s.ViTri,
                    TongSoLuong = s.SoLuongTong,
                    SoLuongCoSan = s.SoLuongHienCo,
                    TacGias = s.SachTacGias.Select(stg => new TacGiaDto { IdTacGia = stg.IdTacGia, TenTacGia = stg.TacGia.TenTacGia }).ToList(),
                    TheLoais = s.SachTheLoais.Select(stl => new TheLoaiDto { IdTheLoai = stl.IdTheLoai, TenTheLoai = stl.TheLoai.TenTheLoai }).ToList(),
                    NhaXuatBans = s.SachNhaXuatBans.Select(snxb => new NhaXuatBanDto { IdNhaXuatBan = snxb.IdNhaXuatBan, TenNhaXuatBan = snxb.NhaXuatBan.TenNhaXuatBan }).ToList(),
                    GoiY = s.DeXuatSachGocs.Select(ds => new SachCardDto
                    {
                        IdSach = ds.IdSachDeXuat,
                        TieuDe = ds.SachDeXuat.TenSach,
                        AnhBiaUrl = ds.SachDeXuat.AnhBia, // Lấy đường dẫn thô
                        GiaBia = ds.SachDeXuat.GiaBia ?? 0
                    }).ToList()
                })
                .FirstOrDefaultAsync();

            if (sach == null) return NotFound();

            // Hoàn thiện URL (bên ngoài truy vấn SQL)
            sach.AnhBiaUrl = GetFullImageUrl(sach.AnhBiaUrl);
            foreach (var item in sach.GoiY)
            {
                item.AnhBiaUrl = GetFullImageUrl(item.AnhBiaUrl);
            }

            return Ok(sach);
        }

        // === API TÌM KIẾM ĐÃ CẬP NHẬT (thêm MoTaTrang) ===
        [HttpGet("filter-by-id")]
        public async Task<IActionResult> SearchSachById([FromQuery] int? idTacGia, [FromQuery] int? idTheLoai, [FromQuery] int? idNXB)
        {
            var query = _context.Sachs.AsQueryable();
            var resultDto = new SachKetQuaTimKiemDto();

            if (idTacGia.HasValue)
            {
                var tacGia = await _context.TacGias.FindAsync(idTacGia.Value);
                if (tacGia == null) return NotFound("Không tìm thấy tác giả.");

                resultDto.TieuDeTrang = $"Sách của tác giả: {tacGia.TenTacGia}";
                resultDto.MoTaTrang = tacGia.GioiThieu; // <-- CẬP NHẬT MÔ TẢ

                query = query.Where(s => s.SachTacGias.Any(stg => stg.IdTacGia == idTacGia.Value));
            }
            else if (idTheLoai.HasValue)
            {
                var theLoai = await _context.TheLoais.FindAsync(idTheLoai.Value);
                if (theLoai == null) return NotFound("Không tìm thấy thể loại.");

                resultDto.TieuDeTrang = $"Sách thuộc thể loại: {theLoai.TenTheLoai}";
                resultDto.MoTaTrang = theLoai.MoTa; // <-- CẬP NHẬT MÔ TẢ

                query = query.Where(s => s.SachTheLoais.Any(stl => stl.IdTheLoai == idTheLoai.Value));
            }
            else if (idNXB.HasValue)
            {
                var nxb = await _context.NhaXuatBans.FindAsync(idNXB.Value);
                if (nxb == null) return NotFound("Không tìm thấy NXB.");

                resultDto.TieuDeTrang = $"Sách của NXB: {nxb.TenNhaXuatBan}";
                resultDto.MoTaTrang = nxb.MoTa; // <-- CẬP NHẬT MÔ TẢ

                query = query.Where(s => s.SachNhaXuatBans.Any(snxb => snxb.IdNhaXuatBan == idNXB.Value));
            }
            else
            {
                return BadRequest("Cần cung cấp một tiêu chí tìm kiếm.");
            }

            var rawList = await query
                .Select(s => new {
                    s.IdSach,
                    s.TenSach,
                    s.AnhBia,
                    s.GiaBia
                })
                .ToListAsync();

            resultDto.SachList = rawList.Select(s => new SachCardDto
            {
                IdSach = s.IdSach,
                TieuDe = s.TenSach,
                AnhBiaUrl = GetFullImageUrl(s.AnhBia),
                GiaBia = s.GiaBia ?? 0
            }).ToList();

            return Ok(resultDto);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\Web\TrangChuController.cs
================================================================================
﻿// Tập tin: CafebookApi/Controllers/Web/TrangChuController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelWeb;
using CafebookModel.Utils;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using System.IO;
using System;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.Web
{
    [Route("api/web/trangchu")]
    [ApiController]
    public class TrangChuController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private readonly IWebHostEnvironment _env;
        private readonly string _baseUrl;

        // (Constructor và GetFullImageUrl giữ nguyên)
        public TrangChuController(CafebookDbContext context, IWebHostEnvironment env, IConfiguration config)
        {
            _context = context;
            _env = env;
            if (string.IsNullOrEmpty(_env.WebRootPath))
            {
                _env.WebRootPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot");
            }
            _baseUrl = config.GetValue<string>("Kestrel:Endpoints:Http:Url") ?? "http://127.0.0.1:5166";
        }

        [ApiExplorerSettings(IgnoreApi = true)]
        private string? GetFullImageUrl(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath))
                return null;
            return $"{_baseUrl}{relativePath.Replace(Path.DirectorySeparatorChar, '/')}";
        }

        [HttpGet("data")] // API endpoint
        public async Task<IActionResult> GetTrangChuData()
        {
            // 1. Lấy thông tin chung (từ bảng CaiDat)
            var settings = await _context.CaiDats
                .Where(c => c.TenCaiDat == "TenQuan" ||
                            c.TenCaiDat == "GioiThieu" ||
                            c.TenCaiDat == "BannerImage" ||
                            c.TenCaiDat == "DiaChi" ||
                            c.TenCaiDat == "SoDienThoai" ||
                            c.TenCaiDat == "LienHe_Email" ||
                            c.TenCaiDat == "LienHe_GioMoCua")
                .ToListAsync();

            var thongTinChung = new ThongTinChungDto
            {
                TenQuan = settings.FirstOrDefault(c => c.TenCaiDat == "TenQuan")?.GiaTri ?? "Cafebook",
                GioiThieu = settings.FirstOrDefault(c => c.TenCaiDat == "GioiThieu")?.GiaTri,
                BannerImageUrl = GetFullImageUrl(settings.FirstOrDefault(c => c.TenCaiDat == "BannerImage")?.GiaTri),
                DiaChi = settings.FirstOrDefault(c => c.TenCaiDat == "DiaChi")?.GiaTri,
                SoDienThoai = settings.FirstOrDefault(c => c.TenCaiDat == "SoDienThoai")?.GiaTri,
                EmailLienHe = settings.FirstOrDefault(c => c.TenCaiDat == "LienHe_Email")?.GiaTri,
                GioMoCua = settings.FirstOrDefault(c => c.TenCaiDat == "LienHe_GioMoCua")?.GiaTri,
                SoBanTrong = await _context.Bans.CountAsync(b => b.TrangThai == "Trống"),
                SoSachSanSang = await _context.Sachs.CountAsync(s => s.SoLuongHienCo > 0)
            };

            // 2. Lấy 3 khuyến mãi (Đang hoạt động)
            var promotions = await _context.KhuyenMais
                .Where(km => km.TrangThai == "Hoạt động" && km.NgayBatDau <= DateTime.Now && km.NgayKetThuc >= DateTime.Now)
                .OrderBy(km => km.NgayBatDau)
                .Take(3)
                .Select(km => new KhuyenMaiDto
                {
                    TenKhuyenMai = km.TenChuongTrinh,
                    MoTa = km.MoTa,
                    dieuKienApDung = km.DieuKienApDung
                }).ToListAsync();

            // 3. Lấy 5 món nổi bật (Không đổi)
            var monNoiBat_Raw = await _context.SanPhams
                .Where(sp => sp.TrangThaiKinhDoanh == true)
                .OrderByDescending(sp => sp.IdSanPham)
                .Take(5)
                .Select(sp => new
                {
                    sp.IdSanPham,
                    sp.TenSanPham,
                    sp.GiaBan,
                    sp.HinhAnh
                }).ToListAsync();

            var monNoiBat = monNoiBat_Raw.Select(sp => new SanPhamDto
            {
                IdSanPham = sp.IdSanPham,
                TenSanPham = sp.TenSanPham,
                DonGia = sp.GiaBan,
                AnhSanPhamUrl = GetFullImageUrl(sp.HinhAnh)
            }).ToList();

            // 4. Lấy 4 sách nổi bật (SỬA DÙNG N-N)
            var sachNoiBat_Raw = await _context.Sachs
                .OrderByDescending(s => s.SoLuongHienCo)
                .Take(4)
                .Select(s => new
                {
                    s.IdSach,
                    s.TenSach,
                    // SỬA: Nối chuỗi các tác giả từ bảng N-N
                    TacGia = string.Join(", ", s.SachTacGias.Select(stg => stg.TacGia.TenTacGia)),
                    s.AnhBia
                }).ToListAsync();

            var sachNoiBat = sachNoiBat_Raw.Select(s => new SachDto
            {
                IdSach = s.IdSach,
                TieuDe = s.TenSach,
                // SỬA: Xử lý trường hợp không có tác giả
                TacGia = string.IsNullOrEmpty(s.TacGia) ? "Không rõ" : s.TacGia,
                AnhBiaUrl = GetFullImageUrl(s.AnhBia)
            }).ToList();

            // 5. Gộp tất cả vào DTO
            var dto = new TrangChuDto
            {
                Info = thongTinChung,
                Promotions = promotions,
                MonNoiBat = monNoiBat,
                SachNoiBat = sachNoiBat
            };
            return Ok(dto);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\Web\WebQuanLyController.cs
================================================================================
﻿// Tập tin: CafebookApi/Controllers/Web/WebQuanLyController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelWeb;
using CafebookModel.Utils; // THÊM
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Microsoft.AspNetCore.Hosting; // THÊM
using Microsoft.Extensions.Configuration; // THÊM
using System.IO; // THÊM
using System;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.Web
{
    [Route("api/web/quanly")]
    [ApiController]
    public class WebQuanLyController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        // --- THÊM MỚI (Giống các controller khác) ---
        private readonly IWebHostEnvironment _env;
        private readonly string _baseUrl;

        public WebQuanLyController(CafebookDbContext context, IWebHostEnvironment env, IConfiguration config)
        {
            _context = context;
            _env = env;
            if (string.IsNullOrEmpty(_env.WebRootPath))
            {
                _env.WebRootPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot");
            }
            _baseUrl = config.GetValue<string>("Kestrel:Endpoints:Http:Url") ?? "http://127.0.0.1:5166";
        }

        // --- THÊM MỚI: Hàm helper ---
        [ApiExplorerSettings(IgnoreApi = true)]
        private string? GetFullImageUrl(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath))
                return null;
            return $"{_baseUrl}{relativePath.Replace(Path.DirectorySeparatorChar, '/')}";
        }
        // -------------------------

        [HttpGet("dashboard/{idNhanVien}")]
        public async Task<IActionResult> GetEmployeeDashboard(int idNhanVien)
        {
            var nhanVien = await _context.NhanViens
                .Include(nv => nv.VaiTro)
                .AsNoTracking()
                .FirstOrDefaultAsync(nv => nv.IdNhanVien == idNhanVien);
            if (nhanVien == null)
            {
                return NotFound("Không tìm thấy nhân viên.");
            }

            // Lấy ca làm việc hôm nay
            var caLamViec = await _context.LichLamViecs
                .Include(llv => llv.CaLamViec)
                .Where(llv => llv.IdNhanVien == idNhanVien && llv.NgayLam == DateTime.Today)
                .Select(llv => llv.CaLamViec.TenCa)
                .FirstOrDefaultAsync();
            // Lấy thống kê
            var banPhucVu = await _context.Bans.CountAsync(b => b.TrangThai == "Có khách");
            var donXuLy = await _context.HoaDons.CountAsync(h => h.TrangThai == "Chưa thanh toán" || h.TrangThai == "Đang giao");

            var dto = new WebQuanLyDashboardDto
            {
                HoTen = nhanVien.HoTen,
                VaiTro = nhanVien.VaiTro.TenVaiTro,
                // SỬA: Trả về URL thay vì Base64
                AnhDaiDienUrl = GetFullImageUrl(nhanVien.AnhDaiDien),
                CaHienTai = caLamViec ?? "Hôm nay nghỉ",
                TongBanDangPhucVu = banPhucVu,
                TongDonDangXuLy = donXuLy
            };
            return Ok(dto);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\Web\QuanLy\SoDoBanController.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.ModelWeb.QuanLy; // SỬA: Dùng namespace mới
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.Web.QuanLy
{
    [Route("api/web/quanly/sodoban")]
    [ApiController]
    public class SoDoBanController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public SoDoBanController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API lấy tất cả Khu Vực và Bàn
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> GetSoDoBan()
        {
            // 1. Lấy tất cả hóa đơn chưa thanh toán (để lấy tổng tiền)
            // SỬA LỖI 500 (Duplicate Key): GroupBy và Sum
            var hoaDonChuaThanhToan = await _context.HoaDons
                .Where(h => h.TrangThai == "Chưa thanh toán" && h.IdBan != null)
                .GroupBy(h => h.IdBan) // Nhóm theo IdBan
                .Select(g => new
                {
                    IdBan = g.Key,
                    // SỬA LỖI CS1061: Dùng tên thuộc tính PascalCase (từ Entities.cs)
                    TongTien = g.Sum(h => h.TongTienGoc - h.GiamGia + h.TongPhuThu)
                })
                .ToDictionaryAsync(h => (int)h.IdBan!, h => h.TongTien);

            // 2. Lấy tất cả Khu Vực và Bàn
            var khuVucList = await _context.KhuVucs
                .Include(k => k.Bans) // Join Bàn
                .OrderBy(k => k.IdKhuVuc)
                .Select(k => new KhuVucDto
                {
                    IdKhuVuc = k.IdKhuVuc,
                    TenKhuVuc = k.TenKhuVuc,
                    Bans = k.Bans.OrderBy(b => b.SoBan).Select(b => new BanDto
                    {
                        IdBan = b.IdBan,
                        SoBan = b.SoBan,
                        TrangThai = b.TrangThai,
                        GhiChu = b.GhiChu, // <-- THÊM GHI CHÚ
                        // SỬA LỖI CS0019: 'b.IdKhuVuc' (int?) ?? 0
                        IdKhuVuc = b.IdKhuVuc ?? 0,
                        TongTien = (b.TrangThai == "Có khách")
                                   ? hoaDonChuaThanhToan.GetValueOrDefault(b.IdBan, 0)
                                   : 0
                    }).ToList()
                })
                .ToListAsync();

            return Ok(khuVucList);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Data\CafebookDbContext.cs
================================================================================
﻿// Tập tin: CafebookApi/Data/CafebookDbContext.cs
using CafebookModel.Model.Entities;
using Microsoft.EntityFrameworkCore;

namespace CafebookApi.Data
{
    public class CafebookDbContext : DbContext
    {
        public CafebookDbContext(DbContextOptions<CafebookDbContext> options)
            : base(options)
        {
        }

        // --- Khai báo tất cả các Bảng (DbSet) ---
        public DbSet<KhuVuc> KhuVucs { get; set; }
        public DbSet<Ban> Bans { get; set; }
        public DbSet<NguoiGiaoHang> NguoiGiaoHangs { get; set; }
        public DbSet<HoaDon> HoaDons { get; set; }
        public DbSet<DanhMuc> DanhMucs { get; set; }
        public DbSet<SanPham> SanPhams { get; set; }
        public DbSet<ChiTietHoaDon> ChiTietHoaDons { get; set; }
        public DbSet<PhuThu> PhuThus { get; set; }
        public DbSet<ChiTietPhuThuHoaDon> ChiTietPhuThuHoaDons { get; set; }
        public DbSet<NhatKyHuyMon> NhatKyHuyMons { get; set; }
        public DbSet<NguyenLieu> NguyenLieus { get; set; }
        public DbSet<DinhLuong> DinhLuongs { get; set; }
        public DbSet<NhaCungCap> NhaCungCaps { get; set; }
        public DbSet<PhieuNhapKho> PhieuNhapKhos { get; set; }
        public DbSet<ChiTietNhapKho> ChiTietNhapKhos { get; set; }
        public DbSet<PhieuKiemKho> PhieuKiemKhos { get; set; }
        public DbSet<ChiTietKiemKho> ChiTietKiemKhos { get; set; }
        public DbSet<PhieuXuatHuy> PhieuXuatHuys { get; set; }
        public DbSet<ChiTietXuatHuy> ChiTietXuatHuys { get; set; }
        public DbSet<KhachHang> KhachHangs { get; set; }
        public DbSet<PhieuDatBan> PhieuDatBans { get; set; }
        public DbSet<KhuyenMai> KhuyenMais { get; set; }
        public DbSet<HoaDon_KhuyenMai> HoaDonKhuyenMais { get; set; }
        public DbSet<TheLoai> TheLoais { get; set; }
        public DbSet<TacGia> TacGias { get; set; }
        public DbSet<NhaXuatBan> NhaXuatBans { get; set; }
        public DbSet<SachTacGia> SachTacGias { get; set; }
        public DbSet<SachTheLoai> SachTheLoais { get; set; }
        public DbSet<SachNhaXuatBan> SachNhaXuatBans { get; set; }
        public DbSet<Sach> Sachs { get; set; }
        public DbSet<PhieuThueSach> PhieuThueSachs { get; set; }
        public DbSet<ChiTietPhieuThue> ChiTietPhieuThues { get; set; }
        public DbSet<VaiTro> VaiTros { get; set; }
        public DbSet<NhanVien> NhanViens { get; set; }
        public DbSet<CaLamViec> CaLamViecs { get; set; }
        public DbSet<LichLamViec> LichLamViecs { get; set; }
        public DbSet<BangChamCong> BangChamCongs { get; set; }
        public DbSet<PhieuLuong> PhieuLuongs { get; set; }
        public DbSet<DonXinNghi> DonXinNghis { get; set; }
        public DbSet<CaiDat> CaiDats { get; set; }
        public DbSet<Quyen> Quyens { get; set; }
        public DbSet<VaiTro_Quyen> VaiTroQuyens { get; set; }
        public DbSet<GiaoDichThanhToan> GiaoDichThanhToans { get; set; }
        public DbSet<ChatLichSu> ChatLichSus { get; set; }
        public DbSet<DeXuatSanPham> DeXuatSanPhams { get; set; }
        public DbSet<DeXuatSach> DeXuatSachs { get; set; }
        public DbSet<ThongBao> ThongBaos { get; set; }
        public DbSet<DonViChuyenDoi> DonViChuyenDois { get; set; }
        public DbSet<PhieuThuongPhat> PhieuThuongPhats { get; set; }
        public DbSet<PhieuTraSach> PhieuTraSachs { get; set; }
        public DbSet<ChiTietPhieuTra> ChiTietPhieuTras { get; set; }
        public DbSet<TrangThaiCheBien> TrangThaiCheBiens { get; set; }

        // --- Cấu hình Khóa (Fluent API) ---
        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);
            modelBuilder.UseCollation("Vietnamese_CI_AS");

            // Cấu hình Khóa chính tổng hợp (Composite Primary Keys)
            modelBuilder.Entity<ChiTietPhuThuHoaDon>().HasKey(c => new { c.IdHoaDon, c.IdPhuThu });
            modelBuilder.Entity<DinhLuong>().HasKey(c => new { c.IdSanPham, c.IdNguyenLieu });
            modelBuilder.Entity<ChiTietNhapKho>().HasKey(c => new { c.IdPhieuNhapKho, c.IdNguyenLieu });
            modelBuilder.Entity<ChiTietKiemKho>().HasKey(c => new { c.IdPhieuKiemKho, c.IdNguyenLieu });
            modelBuilder.Entity<ChiTietXuatHuy>().HasKey(c => new { c.IdPhieuXuatHuy, c.IdNguyenLieu });
            modelBuilder.Entity<HoaDon_KhuyenMai>().HasKey(c => new { c.IdHoaDon, c.IdKhuyenMai });
            modelBuilder.Entity<ChiTietPhieuThue>().HasKey(c => new { c.IdPhieuThueSach, c.IdSach });
            modelBuilder.Entity<VaiTro_Quyen>().HasKey(c => new { c.IdVaiTro, c.IdQuyen });
            modelBuilder.Entity<DeXuatSanPham>().HasKey(c => new { c.IdSanPhamGoc, c.IdSanPhamDeXuat, c.LoaiDeXuat });

            // SỬA LỖI & TỐI ƯU: Bỏ comment và thêm HasKey cho DeXuatSach
            modelBuilder.Entity<DeXuatSach>().HasKey(c => new { c.IdSachGoc, c.IdSachDeXuat, c.LoaiDeXuat });
            modelBuilder.Entity<ChiTietPhieuTra>().HasKey(c => new { c.IdPhieuTra, c.IdSach });


            // THÊM MỚI CẤU HÌNH CHO TrangThaiCheBien
            modelBuilder.Entity<TrangThaiCheBien>(e =>
            {
                e.HasOne(cb => cb.ChiTietHoaDon)
                 .WithMany() // Không cần collection ngược
                 .HasForeignKey(cb => cb.IdChiTietHoaDon)
                 .OnDelete(DeleteBehavior.Cascade); // Xóa CTHD thì xóa luôn phiếu bếp

                e.HasOne(cb => cb.HoaDon)
                 .WithMany() // Không cần collection ngược
                 .HasForeignKey(cb => cb.IdHoaDon)
                 .OnDelete(DeleteBehavior.NoAction); // Không cascade

                e.HasOne(cb => cb.SanPham)
                 .WithMany() // Không cần collection ngược
                 .HasForeignKey(cb => cb.IdSanPham)
                 .OnDelete(DeleteBehavior.NoAction); // Không cascade

                // Thêm Index
                e.HasIndex(cb => new { cb.TrangThai, cb.NhomIn })
                 .IncludeProperties(cb => cb.ThoiGianGoi);
            });
            // --- SỬA LỖI: THÊM CẤU HÌNH KHÓA NGOẠI CHO PHIẾU THUÊ ---
            modelBuilder.Entity<PhieuThueSach>(e =>
            {
                e.HasOne(p => p.KhachHang)
                 .WithMany(k => k.PhieuThueSachs)
                 .HasForeignKey(p => p.IdKhachHang) // Chỉ rõ FK là IdKhachHang
                 .OnDelete(DeleteBehavior.NoAction);

                e.HasOne(p => p.NhanVien)
                 .WithMany(n => n.PhieuThueSachs)
                 .HasForeignKey(p => p.IdNhanVien) // Chỉ rõ FK là IdNhanVien
                 .OnDelete(DeleteBehavior.NoAction);
            });

            modelBuilder.Entity<ChiTietPhieuThue>(e =>
            {
                // (Khóa chính đã được định nghĩa ở trên)
                // e.HasKey(c => new { c.IdPhieuThueSach, c.IdSach });

                e.HasOne(ct => ct.PhieuThueSach)
                 .WithMany(p => p.ChiTietPhieuThues)
                 .HasForeignKey(ct => ct.IdPhieuThueSach) // Chỉ rõ FK
                 .OnDelete(DeleteBehavior.NoAction);

                e.HasOne(ct => ct.Sach)
                 .WithMany(s => s.ChiTietPhieuThues)
                 .HasForeignKey(ct => ct.IdSach) // Chỉ rõ FK
                 .OnDelete(DeleteBehavior.NoAction);
            });

            // --- THÊM CẤU HÌNH MỚI CHO PHIẾU TRẢ SÁCH ---
            modelBuilder.Entity<PhieuTraSach>()
               .HasOne(pt => pt.PhieuThueSach)
               .WithMany(p => p.PhieuTraSachs)
               .HasForeignKey(pt => pt.IdPhieuThueSach)
               .OnDelete(DeleteBehavior.NoAction); // Tránh cascade

            modelBuilder.Entity<PhieuTraSach>()
               .HasOne(pt => pt.NhanVien)
               .WithMany(nv => nv.PhieuTraSachs)
               .HasForeignKey(pt => pt.IdNhanVien)
               .OnDelete(DeleteBehavior.NoAction); // Tránh cascade
            // --- KẾT THÚC THÊM MỚI ---

            // Cấu hình N-N cho Sách (Đã đúng)
            modelBuilder.Entity<SachTacGia>(e =>
            {
                e.HasKey(st => new { st.IdSach, st.IdTacGia });
                e.HasOne(st => st.Sach)
                    .WithMany(s => s.SachTacGias)
                    .HasForeignKey(st => st.IdSach);
                e.HasOne(st => st.TacGia)
                    .WithMany(t => t.SachTacGias)
                    .HasForeignKey(st => st.IdTacGia);
            });

            modelBuilder.Entity<SachTheLoai>(e =>
            {
                e.HasKey(st => new { st.IdSach, st.IdTheLoai });
                e.HasOne(st => st.Sach)
                    .WithMany(s => s.SachTheLoais)
                    .HasForeignKey(st => st.IdSach);
                e.HasOne(st => st.TheLoai)
                    .WithMany(t => t.SachTheLoais)
                    .HasForeignKey(st => st.IdTheLoai);
            });

            modelBuilder.Entity<SachNhaXuatBan>(e =>
            {
                e.HasKey(sn => new { sn.IdSach, sn.IdNhaXuatBan });
                e.HasOne(sn => sn.Sach)
                    .WithMany(s => s.SachNhaXuatBans)
                    .HasForeignKey(sn => sn.IdSach);
                e.HasOne(sn => sn.NhaXuatBan)
                    .WithMany(n => n.SachNhaXuatBans)
                    .HasForeignKey(sn => sn.IdNhaXuatBan);
            });

            // Cấu hình quan hệ N-1 phức tạp (Đã đúng)
            modelBuilder.Entity<PhieuThuongPhat>()
                .HasOne(p => p.NhanVien)
                .WithMany() // Không tạo collection
                .HasForeignKey(p => p.IdNhanVien)
                .OnDelete(DeleteBehavior.NoAction);

            modelBuilder.Entity<PhieuThuongPhat>()
                .HasOne(p => p.NguoiTao)
                .WithMany() // Không tạo collection
                .HasForeignKey(p => p.IdNguoiTao)
                .OnDelete(DeleteBehavior.NoAction);

            modelBuilder.Entity<PhieuThuongPhat>()
                .HasOne(p => p.PhieuLuong)
                .WithMany() // Không tạo collection
                .HasForeignKey(p => p.IdPhieuLuong)
                .OnDelete(DeleteBehavior.SetNull);

            // Cấu hình DinhLuong (Đã đúng)
            modelBuilder.Entity<DinhLuong>()
                .HasOne(d => d.DonViSuDung)
                .WithMany(dv => dv.DinhLuongs)
                .HasForeignKey(d => d.IdDonViSuDung)
                .OnDelete(DeleteBehavior.NoAction);

            // Cấu hình Tự tham chiếu (Đã đúng)
            modelBuilder.Entity<DanhMuc>()
                .HasOne(d => d.DanhMucCha)
                .WithMany(d => d.DanhMucCons)
                .HasForeignKey(d => d.IdDanhMucCha)
                .OnDelete(DeleteBehavior.NoAction);

            modelBuilder.Entity<DonXinNghi>()
                .HasOne(d => d.NguoiDuyet)
                .WithMany(nv => nv.DonXinNghiNguoiDuyets)
                .HasForeignKey(d => d.IdNguoiDuyet)
                .OnDelete(DeleteBehavior.NoAction);

            // Cấu hình DeXuat (Tránh lỗi cascade)
            modelBuilder.Entity<DeXuatSanPham>()
                .HasOne(d => d.SanPhamGoc)
                .WithMany(p => p.DeXuatSanPhamGocs)
                .HasForeignKey(d => d.IdSanPhamGoc)
                .OnDelete(DeleteBehavior.NoAction);

            modelBuilder.Entity<DeXuatSanPham>()
                .HasOne(d => d.SanPhamDeXuat)
                .WithMany(p => p.DeXuatSanPhamDeXuats)
                .HasForeignKey(d => d.IdSanPhamDeXuat)
                .OnDelete(DeleteBehavior.NoAction);

            // SỬA LỖI & TỐI ƯU: Bỏ comment cấu hình DeXuatSach
            modelBuilder.Entity<DeXuatSach>()
               .HasOne(d => d.SachGoc)
               .WithMany(p => p.DeXuatSachGocs)
               .HasForeignKey(d => d.IdSachGoc)
               .OnDelete(DeleteBehavior.NoAction);

            modelBuilder.Entity<DeXuatSach>()
                .HasOne(d => d.SachDeXuat)
                .WithMany(p => p.DeXuatSachDeXuats)
                .HasForeignKey(d => d.IdSachDeXuat)
                .OnDelete(DeleteBehavior.NoAction);

            // Cấu hình Tắt Cascade khác (Đã đúng)
            modelBuilder.Entity<NhatKyHuyMon>()
                .HasOne(n => n.HoaDon)
                .WithMany(h => h.NhatKyHuyMons)
                .HasForeignKey(n => n.IdHoaDon)
                .OnDelete(DeleteBehavior.NoAction);

            modelBuilder.Entity<NhatKyHuyMon>()
                .HasOne(n => n.NhanVienHuy)
                .WithMany(nv => nv.NhatKyHuyMons)
                .HasForeignKey(n => n.IdNhanVienHuy)
                .OnDelete(DeleteBehavior.NoAction);

            // Cấu hình bổ sung (Đã đúng)
            modelBuilder.Entity<Sach>()
                .Property(s => s.GiaBia)
                .HasColumnType("decimal(18, 2)");
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Properties\launchSettings.json
================================================================================
﻿{
  "$schema": "http://json.schemastore.org/launchsettings.json",
  "iisSettings": {
    "windowsAuthentication": false,
    "anonymousAuthentication": true,
    "iisExpress": {
      "applicationUrl": "http://127.0.0.1:5166", // <-- SỬA
      "sslPort": 0
    }
  },
  "profiles": {
    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "http://127.0.0.1:5166", // <-- SỬA: null,
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "launchUrl": "swagger",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\avatars\avatarKH\1_khach-vang-lai.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\avatars\avatarKH\2_tran-van-an.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\avatars\avatarKH\4_pham-hung-cuong.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\avatars\avatarKH\5_ang-thu-duyen.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\avatars\avatarKH\6_vo-thanh-danh.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\avatars\avatarKH\7_huynh-kim-yen.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\avatars\avatarKH\8_nguyen-hoang-bi-khoa.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\avatars\avatarKH\9_lam-chu-bao-toan.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\avatars\avatarNV\12_lam-chu-bao-toan.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\avatars\avatarNV\1_lam-chu-bao-toan.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\avatars\avatarNV\2_nguyen-van-quan-ly.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\avatars\avatarNV\3_20251107134032.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\avatars\avatarNV\4_le-van-phuc-vu.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\avatars\avatarNV\5_pham-thi-pha-che.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\avatars\avatarNV\6_ngo-thi-a-nghi.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\avatars\avatarNV\7_hoang-van-bep.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\avatars\avatarNV\8_o-van-kho.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\books\1_toi-thay-hoa-vang-tren-co-xanh.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\books\2_ac-nhan-tam.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\books\3_1984.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\books\4_sapiens-luoc-su-loai-nguoi.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\books\5_an-mang-tren-chuyen-tau-toc-hanh-phuong-ong.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\books\6_phan-tam-hoc-nhap-mon.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\books\7_harry-potter-va-hon-a-phu-thuy.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\books\8_xu-cat-dune.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\foods\1_ca-phe-en-nonga.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\foods\2_bac-xiu.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\foods\3_latte-nong.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\foods\4_tra-ao-cam-sa.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\foods\5_banh-croissant-bo.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\foods\6_matcha-latte.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\foods\7_banh-pate-chaud.jpg
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\foods\8_espresso.jpg
