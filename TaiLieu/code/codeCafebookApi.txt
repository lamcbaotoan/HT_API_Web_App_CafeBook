Backend: C#. 
Database: SQL Server Management Studio 21.
IDE: Visual Studio Insiders.
tÃªn projec: CafebookApi.
ná»n táº£ng: ASP.NET Core Web API, Net Framework 8.0.
//////////////////////////
ğŸŒ³ Solution 'AppCafebookApi' (4 of 4 projects)
â”‚
â”œâ”€â”€ ğŸ™ GitHub Actions/
â”‚
â”œâ”€â”€ ğŸ”· AppCafebookApi/ (Dá»± Ã¡n WPF Desktop)
â”‚   â”œâ”€â”€ â¡ï¸ Dependencies/
â”‚   â”œâ”€â”€ ğŸ“‚ Assets/
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ images/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ default-avatar.png
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ default-book-cover.png
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ default-food-icon.png
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ logo.ico
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ–¼ï¸ logo.png
â”‚   â”‚   â””â”€â”€ ğŸ“‚ Fonts/
â”‚   â”‚       â””â”€â”€ ğŸ…°ï¸ Font Awesome 6 Free-Solid-900.otf
â”‚   â”œâ”€â”€ ğŸ“‚ Services/
â”‚   â”‚   â”œâ”€â”€ C# AuthService.cs
â”‚   â”‚   â””â”€â”€ C# HinhAnhHelpers.cs
â”‚   â”œâ”€â”€ ğŸ“‚ View/
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ Common/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ BaocaodoanhthuPreviewWindow.xaml
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ BaoCaoHieuSuatNhanVientPreview.xaml
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ BaoCaoTonKhoNguyenLieuPreviewWindo...
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ BapCaoTonKhoSachPreviewWindow.xaml
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ InputDialogWindow.xaml
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ PhieuLuongPreviewWindow.xaml
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ WelcomeWindow.xaml
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ nhanvien/
â”‚   â”‚   â”‚    â”œâ”€â”€ ğŸ“‚ pages/
â”‚   â”‚   â”‚    â”‚     â”œâ”€â”€ ğŸ“„ SoDoBanView.xaml
â”‚   â”‚   â”‚    â”‚     â””â”€â”€ ğŸ“„ GoiMonView.xaml
â”‚   â”‚   â”‚    â””â”€â”€ ğŸ“„ ManHinhNhanVien.xaml
â”‚   â”‚   â””â”€â”€ ğŸ“‚ quanly/
â”‚   â”‚       â”œâ”€â”€ ğŸ“‚ pages/
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ BaoCaoNhanSuView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ CaiDatNhanSuView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ PhanQuyenView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyBanView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyDonHangView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyDonViChuyenDoiView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyDonXinNghiView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyKiemKhoView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyKhachHangView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyKhuyenMaiView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyLichLamViecView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyLuongView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyNguyenLieuView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyNhaCungCapView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyNhanVienView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyNhapKhoView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyPhatLuongView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLySachView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLySanPhamView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyVaiTroView.xaml
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ QuanLyXuatHuyView.xaml
â”‚   â”‚       â”‚   â””â”€â”€ ğŸ“„ TongQuanView.xaml
â”‚   â”‚       â”œâ”€â”€ ğŸ“„ ManHinhQuanly.xaml
â”‚   â”‚       â””â”€â”€ ğŸ“„ ManHinhDangNhap.xaml
â”‚   â”œâ”€â”€ âš™ï¸ App.xaml
â”‚   â””â”€â”€ ğŸ–¼ï¸ logo.ico
â”‚
â”œâ”€â”€ ğŸ”· CafebookApi/ (Dá»± Ã¡n ASP.NET Core API Backend)
â”‚   â”œâ”€â”€ â¡ï¸ Connected Services/
â”‚   â”œâ”€â”€ â¡ï¸ Dependencies/
â”‚   â”œâ”€â”€ ğŸ“‚ Properties/
â”‚   â”‚   â””â”€â”€ ğŸ“„ launchSettings.json
â”‚   â”œâ”€â”€ ğŸ“‚ wwwroot/
â”‚   â”‚   â””â”€â”€ ğŸ“‚ images/
â”‚   â”‚       â”œâ”€â”€ ğŸ“‚ avatars/
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“‚ avatarKH/
â”‚   â”‚       â”‚   â””â”€â”€ ğŸ“‚ avatarNV/
â”‚   â”‚       â”œâ”€â”€ ğŸ“‚ books/
â”‚   â”‚       â””â”€â”€ ğŸ“‚ foods/
â”‚   â”œâ”€â”€ ğŸ“‚ Controllers/
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ App/
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“‚ NhanVien/
â”‚   â”‚   â”‚   â”‚    â”œâ”€â”€ GoiMonController.cs
â”‚   â”‚   â”‚   â”‚    â”œâ”€â”€ GiaoHangController.cs
â”‚   â”‚   â”‚   â”‚    â”œâ”€â”€ SoDoBanController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# BanQuanLyController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# BaoCaoController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# BaoCaoHieuSuatController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# BaoCaoNhanSuController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# BaoCaoSachController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# BaoCaoTonKhoController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# CaiDatController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# CaiDatNhanSuController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# CalamViecController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# DashboardController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# DonHangController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# DonViChuyenDoiController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# DonXinNghiController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# KhachHangController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# KhoController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# KhuyenMaiController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# LichLamViecController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# LuongController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# NguyenLieuController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# NhaCungCapController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# NhanVienController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# PhanQuyenController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# PhatLuongController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# SachController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# SanPhamController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# SoDoBanController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# TaiKhoanController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# ThongBaoController.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ C# ThuongPhatController.cs
â”‚   â”‚   â”‚   â””â”€â”€ C# VaiTroController.cs
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ Shared/
â”‚   â”‚   â””â”€â”€ ğŸ“‚ Web/
â”‚   â”‚       â”œâ”€â”€ C# KhachHangTaiKhoanController.cs
â”‚   â”‚       â”œâ”€â”€ C# NhanVienTaiKhoanController.cs
â”‚   â”‚       â”œâ”€â”€ C# TrangChuController.cs
â”‚   â”‚       â””â”€â”€ C# WebQuanLyController.cs
â”‚   â”œâ”€â”€ ğŸ“‚ Data/
â”‚   â”‚   â””â”€â”€ C# CafebookDbContext.cs
â”‚   â”œâ”€â”€ ğŸ“‚ Services/
â”‚   â”œâ”€â”€ ğŸ“„ appsettings.json
â”‚   â””â”€â”€ C# Program.cs
â”‚
â”œâ”€â”€ ğŸ”· WebCafebookApi/ (Dá»± Ã¡n ASP.NET Core Web App - Razor Pages)
â”‚   â”œâ”€â”€ â¡ï¸ Connected Services/
â”‚   â”œâ”€â”€ â¡ï¸ Dependencies/
â”‚   â”œâ”€â”€ ğŸ“‚ Properties/
â”‚   â”‚   â””â”€â”€ ğŸ“„ launchSettings.json
â”‚   â”œâ”€â”€ ğŸ“‚ wwwroot/
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ css/
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ site.css
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ images/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ default-avatar.png
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ default-book-cover.png
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ default-food-icon.png
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ logo.ico
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ–¼ï¸ logo.png
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ js/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ profile.js
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ site.js
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ lib/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ bootstrap/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ dist/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ css/
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ bootstrap.css
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ bootstrap-grid.css
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ bootstrap-reboot.css
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ bootstrap-utilities.css
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“‚ js/
â”‚   â”‚   â”‚   â”‚   â”‚       â””â”€â”€ ğŸ“„ bootstrap.js
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ LICENSE
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ jquery/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ dist/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ jquery.js
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ LICENSE.txt
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ LICENSE
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ jquery-validation/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ dist/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ additional-methods.js
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ jquery.validate.js
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ LICENSE.md
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“‚ jquery-validation-unobtrusive/
â”‚   â”‚   â”‚       â”œâ”€â”€ ğŸ“‚ dist/
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ ğŸ“„ jquery.validate.unobtrusive.js
â”‚   â”‚   â”‚       â””â”€â”€ ğŸ“„ LICENSE.txt  <-- (ÄÃ£ cáº­p nháº­t tá»« áº£nh má»›i)
â”‚   â”‚   â””â”€â”€ ğŸ–¼ï¸ favicon.ico
â”‚   â”œâ”€â”€ ğŸ“‚ Data/
â”‚   â”œâ”€â”€ ğŸ“‚ Pages/
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ Account/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ DangKyView.cshtml
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ DangNhapView.cshtml
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ DangXuat.cshtml
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ QuenMatKhauView.cshtml
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ employee/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ _Layout_Employee.cshtml
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ _ViewStart.cshtml
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ DangNhapEmployee.cshtml
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ DangXuat.cshtml
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ SoDoBanView.cshtml
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ WebQuanLyView.cshtml
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ Shared/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ _ViewImports.cshtml
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ _ViewStart.cshtml
â”‚   â”‚   â””â”€â”€ ğŸ“„ TrangChuView.cshtml
â”‚   â”œâ”€â”€ ğŸ“‚ Services/
â”‚   â”œâ”€â”€ ğŸ“„ appsettings.json
â”‚   â”œâ”€â”€ ğŸ“„ appsettings.Development.json
â”‚   â””â”€â”€ C# Program.cs
â”‚
â””â”€â”€ ğŸ”· CafebookModel/ (Dá»± Ã¡n Class Library - Shared Models)
    â”œâ”€â”€ â¡ï¸ Dependencies/
   ğŸ“‚ Model
    â”œâ”€â”€ ğŸ“‚ Data/
    â”‚   â””â”€â”€ C# NhanVienDto.cs
    â”œâ”€â”€ ğŸ“‚ ModelApi/
    â”‚   â”œâ”€â”€ C# LoginRequestModel.cs
    â”‚   â””â”€â”€ C# LoginResponseModel.cs
    â”œâ”€â”€ ğŸ“‚ ModelApp/
    â”‚   â”œâ”€â”€ C# BanQuanLyDto.cs
    â”‚   â”œâ”€â”€ C# BaoCaoDto.cs
    â”‚   â”œâ”€â”€ C# BaoCaoHieuSuatDto.cs
    â”‚   â”œâ”€â”€ C# BaoCaoSachDto.cs
    â”‚   â”œâ”€â”€ C# BaoCaoTonKhoDto.cs
    â”‚   â”œâ”€â”€ C# CaiDatDto.cs
    â”‚   â”œâ”€â”€ C# CaiDatThongTinCuaHangDto.cs
    â”‚   â”œâ”€â”€ C# ChartDataPoint.cs
    â”‚   â”œâ”€â”€ C# DashboardSummaryDto.cs
    â”‚   â”œâ”€â”€ C# DonHangDto.cs
    â”‚   â”œâ”€â”€ C# DonViChuyenDoiDto.cs
    â”‚   â”œâ”€â”€ C# DonXinNghiDto.cs
    â”‚   â”œâ”€â”€ C# KhachHangDto.cs
    â”‚   â”œâ”€â”€ C# KhoDto.cs
    â”‚   â”œâ”€â”€ C# KhuyenMaiDto.cs
    â”‚   â”œâ”€â”€ C# NhanSuDto.cs
    â”‚   â”œâ”€â”€ C# PhatLuongDto.cs
    â”‚   â”œâ”€â”€ C# SachDto.cs
    â”‚   â”œâ”€â”€ C# SanPhamDto.cs
    â”‚   â”œâ”€â”€ C# SoDoBanDto.cs
    â”‚   â””â”€â”€ C# ThongBaoDto.cs
    â”œâ”€â”€ ğŸ“‚ ModelWeb/
    â”‚   â”œâ”€â”€ C# DangKyRequestModel.cs
    â”‚   â”œâ”€â”€ C# KhachHangDto.cs
    â”‚   â”œâ”€â”€ C# TrangChuDto.cs
    â”‚   â”œâ”€â”€ C# WebLoginResponseModel.cs
    â”‚   â””â”€â”€ C# WebQuanLyDashboardModel.cs
    â”œâ”€â”€ Entities.cs
    â””â”€â”€ ğŸ“‚ Utils/
        â”œâ”€â”€ C# HinhAnhPaths.cs
        â””â”€â”€ C# SlugifyUtil.cs
//////////////////////////
CafebookApi
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Properties\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Properties\launchSettings.json
/*{
  "$schema": "http://json.schemastore.org/launchsettings.json",
  "iisSettings": {
    "windowsAuthentication": false,
    "anonymousAuthentication": true,
    "iisExpress": {
      "applicationUrl": "http://localhost:51436",
      "sslPort": 0
    }
  },
  "profiles": {
    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "http://localhost:5166",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "launchUrl": "swagger",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}
*/
{
  "$schema": "http://json.schemastore.org/launchsettings.json",
  "iisSettings": {
    "windowsAuthentication": false,
    "anonymousAuthentication": true,
    "iisExpress": {
      "applicationUrl": "http://127.0.0.1:51436", // <-- Sá»¬A
      "sslPort": 0
    }
  },
  "profiles": {
    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "http://127.0.0.1:5166", // <-- Sá»¬A
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "launchUrl": "swagger",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\avatars\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\avatars\avatarKH\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\avatars\avatarNV\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\books\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\wwwroot\images\foods\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\NhanVien\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\NhanVien\GoiMonController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp.NhanVien;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;
using System;
using System.Collections.Generic;
using Microsoft.Extensions.Configuration;
using System.IO;

namespace CafebookApi.Controllers.App.NhanVien
{
    [Route("api/app/nhanvien/goimon")]
    [ApiController]
    public class GoiMonController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private readonly string _baseUrl;

        public GoiMonController(CafebookDbContext context, IConfiguration config)
        {
            _context = context;
            _baseUrl = config.GetValue<string>("Kestrel:Endpoints:Http:Url")
                       ?? "http://127.0.0.1:5166";
        }

        // Sá»¬A Lá»–I CS8604: ThÃªm '?'
        private string GetFullImageUrl(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath))
            {
                return $"{_baseUrl}/images/default-food-icon.png";
            }
            return $"{_baseUrl}{relativePath.Replace(Path.DirectorySeparatorChar, '/')}";
        }


        [HttpGet("load/{idHoaDon}")]
        public async Task<IActionResult> LoadGoiMonData(int idHoaDon)
        {
            var hoaDon = await _context.HoaDons
                .Include(h => h.Ban)
                .FirstOrDefaultAsync(h => h.IdHoaDon == idHoaDon);

            if (hoaDon == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y hÃ³a Ä‘Æ¡n.");

            // Sá»¬A Lá»–I CS1061: Láº¥y IdKhuyenMai tá»« báº£ng ná»‘i (Join Table)
            var currentPromotion = await _context.HoaDonKhuyenMais
                .FirstOrDefaultAsync(hk => hk.IdHoaDon == idHoaDon); // Sá»¬A: DÃ¹ng idHoaDon (viáº¿t thÆ°á»ng)

            var hoaDonInfo = new HoaDonInfoDto
            {
                IdHoaDon = hoaDon.IdHoaDon,
                SoBan = hoaDon.Ban?.SoBan ?? hoaDon.LoaiHoaDon,
                LoaiHoaDon = hoaDon.LoaiHoaDon,
                TongTienGoc = hoaDon.TongTienGoc,
                GiamGia = hoaDon.GiamGia,
                ThanhTien = hoaDon.ThanhTien,
                IdKhuyenMai = currentPromotion?.IdKhuyenMai // Sá»¬A: DÃ¹ng idKhuyenMai (viáº¿t thÆ°á»ng)
            };

            var chiTietItems = await _context.ChiTietHoaDons
                .Where(c => c.IdHoaDon == idHoaDon)
                .Select(c => new ChiTietDto
                {
                    IdChiTietHoaDon = c.IdChiTietHoaDon,
                    IdSanPham = c.IdSanPham,
                    TenSanPham = c.SanPham.TenSanPham,
                    SoLuong = c.SoLuong,
                    DonGia = c.DonGia,
                    ThanhTien = c.ThanhTien
                }).ToListAsync();

            var sanPhams = await _context.SanPhams
                .Where(s => s.TrangThaiKinhDoanh == true)
                .Select(s => new SanPhamDto
                {
                    IdSanPham = s.IdSanPham,
                    TenSanPham = s.TenSanPham,
                    DonGia = s.GiaBan,
                    HinhAnh = GetFullImageUrl(s.HinhAnh),
                    IdDanhMuc = s.IdDanhMuc
                }).ToListAsync();

            var danhMucs = await _context.DanhMucs
                .OrderBy(d => d.TenDanhMuc)
                .Select(d => new DanhMucDto { IdDanhMuc = d.IdDanhMuc, TenLoaiSP = d.TenDanhMuc })
                .ToListAsync();

            var khuyenMais = await _context.KhuyenMais
                .Where(k => k.TrangThai == "Hoáº¡t Ä‘á»™ng" && k.NgayBatDau <= DateTime.Now && k.NgayKetThuc >= DateTime.Now)
                .Select(k => new KhuyenMaiDto
                {
                    IdKhuyenMai = k.IdKhuyenMai,
                    TenKhuyenMai = k.TenChuongTrinh,
                    LoaiGiamGia = k.LoaiGiamGia,
                    GiaTriGiam = k.GiaTriGiam
                }).ToListAsync();

            khuyenMais.Insert(0, new KhuyenMaiDto { IdKhuyenMai = 0, TenKhuyenMai = "-- KhÃ´ng Ã¡p dá»¥ng --" });

            var dto = new GoiMonViewDto
            {
                HoaDonInfo = hoaDonInfo,
                ChiTietItems = chiTietItems,
                SanPhams = sanPhams,
                DanhMucs = danhMucs,
                KhuyenMais = khuyenMais
            };

            return Ok(dto);
        }

        [HttpPost("add-item")]
        public async Task<IActionResult> AddItem([FromBody] AddItemRequest req)
        {
            // (HÃ m nÃ y giá»¯ nguyÃªn)
            var hoaDon = await _context.HoaDons.FindAsync(req.IdHoaDon);
            if (hoaDon == null) return NotFound("HÃ³a Ä‘Æ¡n khÃ´ng tá»“n táº¡i.");
            if (hoaDon.TrangThai == "ÄÃ£ thanh toÃ¡n") return Conflict("HÃ³a Ä‘Æ¡n Ä‘Ã£ thanh toÃ¡n.");
            var sanPham = await _context.SanPhams.FindAsync(req.IdSanPham);
            if (sanPham == null) return NotFound("Sáº£n pháº©m khÃ´ng tá»“n táº¡i.");
            var existingItem = await _context.ChiTietHoaDons.FirstOrDefaultAsync(c => c.IdHoaDon == req.IdHoaDon && c.IdSanPham == req.IdSanPham);
            ChiTietDto resultDto;
            if (existingItem != null)
            {
                existingItem.SoLuong += req.SoLuong;
                //existingItem.ThanhTien = existingItem.SoLuong * existingItem.DonGia; // Tá»± tÃ­nh
                resultDto = new ChiTietDto { IdChiTietHoaDon = existingItem.IdChiTietHoaDon, IdSanPham = existingItem.IdSanPham, TenSanPham = sanPham.TenSanPham, SoLuong = existingItem.SoLuong, DonGia = existingItem.DonGia, ThanhTien = existingItem.SoLuong * existingItem.DonGia };
            }
            else
            {
                var newItem = new ChiTietHoaDon { IdHoaDon = req.IdHoaDon, IdSanPham = req.IdSanPham, SoLuong = req.SoLuong, DonGia = sanPham.GiaBan /*, ThanhTien = req.SoLuong * sanPham.GiaBan*/ };
                _context.ChiTietHoaDons.Add(newItem);
                await _context.SaveChangesAsync();
                resultDto = new ChiTietDto { IdChiTietHoaDon = newItem.IdChiTietHoaDon, IdSanPham = newItem.IdSanPham, TenSanPham = sanPham.TenSanPham, SoLuong = newItem.SoLuong, DonGia = newItem.DonGia, ThanhTien = newItem.SoLuong * newItem.DonGia };
            }
            await _context.SaveChangesAsync();
            var updatedHoaDonInfo = await GetHoaDonInfo(req.IdHoaDon);
            return Ok(new { updatedHoaDonInfo, newItem = resultDto });
        }

        [HttpPut("update-quantity")]
        public async Task<IActionResult> UpdateQuantity([FromBody] UpdateSoLuongRequest req)
        {
            // (HÃ m nÃ y giá»¯ nguyÃªn)
            var item = await _context.ChiTietHoaDons.Include(c => c.HoaDon).FirstOrDefaultAsync(c => c.IdChiTietHoaDon == req.IdChiTietHoaDon);
            if (item == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y mÃ³n.");
            if (item.HoaDon.TrangThai == "ÄÃ£ thanh toÃ¡n") return Conflict("HÃ³a Ä‘Æ¡n Ä‘Ã£ thanh toÃ¡n.");
            if (req.SoLuongMoi <= 0) _context.ChiTietHoaDons.Remove(item);
            else { item.SoLuong = req.SoLuongMoi; /* item.ThanhTien = item.SoLuong * item.DonGia; */ }
            await _context.SaveChangesAsync();
            var updatedHoaDonInfo = await GetHoaDonInfo(item.IdHoaDon);
            return Ok(updatedHoaDonInfo);
        }

        [HttpDelete("delete-item/{idChiTiet}")]
        public async Task<IActionResult> DeleteItem(int idChiTiet)
        {
            // (HÃ m nÃ y giá»¯ nguyÃªn)
            var item = await _context.ChiTietHoaDons.Include(c => c.HoaDon).FirstOrDefaultAsync(c => c.IdChiTietHoaDon == idChiTiet);
            if (item == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y mÃ³n.");
            if (item.HoaDon.TrangThai == "ÄÃ£ thanh toÃ¡n") return Conflict("HÃ³a Ä‘Æ¡n Ä‘Ã£ thanh toÃ¡n.");
            int idHoaDon = item.IdHoaDon;
            _context.ChiTietHoaDons.Remove(item);
            await _context.SaveChangesAsync();
            var updatedHoaDonInfo = await GetHoaDonInfo(idHoaDon);
            return Ok(updatedHoaDonInfo);
        }

        [HttpPut("apply-promotion")]
        public async Task<IActionResult> ApplyPromotion([FromBody] ThanhToanRequest req)
        {
            var hoaDon = await _context.HoaDons.FindAsync(req.IdHoaDon);
            if (hoaDon == null) return NotFound("HÃ³a Ä‘Æ¡n khÃ´ng tá»“n táº¡i.");

            // Sá»¬A Lá»–I CS1061: XÃ³a cÃ¡c KM cÅ© trÃªn báº£ng ná»‘i
            var existingPromos = _context.HoaDonKhuyenMais.Where(hk => hk.IdHoaDon == req.IdHoaDon);
            _context.HoaDonKhuyenMais.RemoveRange(existingPromos);

            if (req.IdKhuyenMai == null || req.IdKhuyenMai == 0)
            {
                hoaDon.GiamGia = 0;
            }
            else
            {
                var km = await _context.KhuyenMais.FindAsync(req.IdKhuyenMai);
                if (km == null) return NotFound("Khuyáº¿n mÃ£i khÃ´ng tá»“n táº¡i.");

                // ThÃªm vÃ o báº£ng ná»‘i
                _context.HoaDonKhuyenMais.Add(new HoaDon_KhuyenMai
                {
                    IdHoaDon = req.IdHoaDon,
                    IdKhuyenMai = km.IdKhuyenMai
                });

                // Cáº­p nháº­t HÃ³a Ä‘Æ¡n
                if (km.LoaiGiamGia == "PhanTram")
                {
                    hoaDon.GiamGia = hoaDon.TongTienGoc * (km.GiaTriGiam / 100);
                }
                else // "SoTien"
                {
                    hoaDon.GiamGia = km.GiaTriGiam;
                }
            }

            await _context.SaveChangesAsync();
            var updatedHoaDonInfo = await GetHoaDonInfo(req.IdHoaDon);
            return Ok(updatedHoaDonInfo);
        }

        [HttpPost("thanh-toan")]
        public async Task<IActionResult> ThanhToan([FromBody] ThanhToanRequest req)
        {
            // (HÃ m nÃ y giá»¯ nguyÃªn)
            var hoaDon = await _context.HoaDons
                .Include(h => h.Ban)
                .FirstOrDefaultAsync(h => h.IdHoaDon == req.IdHoaDon);
            if (hoaDon == null) return NotFound("HÃ³a Ä‘Æ¡n khÃ´ng tá»“n táº¡i.");
            if (hoaDon.TrangThai == "ÄÃ£ thanh toÃ¡n") return Ok("HÃ³a Ä‘Æ¡n Ä‘Ã£ Ä‘Æ°á»£c thanh toÃ¡n trÆ°á»›c Ä‘Ã³.");

            hoaDon.TrangThai = "ÄÃ£ thanh toÃ¡n";
            hoaDon.ThoiGianThanhToan = DateTime.Now;
            hoaDon.PhuongThucThanhToan = req.PhuongThucThanhToan;
            if (hoaDon.Ban != null)
            {
                hoaDon.Ban.TrangThai = "Trá»‘ng";
            }
            await _context.SaveChangesAsync();
            return Ok(new { message = "Thanh toÃ¡n thÃ nh cÃ´ng!" });
        }

        private async Task<HoaDonInfoDto> GetHoaDonInfo(int idHoaDon)
        {
            var updatedHoaDon = await _context.HoaDons
                .Include(h => h.Ban)
                .AsNoTracking()
                .FirstOrDefaultAsync(h => h.IdHoaDon == idHoaDon);

            // Sá»¬A Lá»–I CS8602: ThÃªm kiá»ƒm tra null
            if (updatedHoaDon == null)
                throw new Exception("KhÃ´ng thá»ƒ tÃ¬m tháº¥y hÃ³a Ä‘Æ¡n sau khi cáº­p nháº­t.");

            // Sá»¬A Lá»–I CS1061: Láº¥y KM tá»« báº£ng ná»‘i
            var currentPromotion = await _context.HoaDonKhuyenMais
                .AsNoTracking()
                .FirstOrDefaultAsync(hk => hk.IdHoaDon == idHoaDon); // Sá»¬A: idHoaDon

            return new HoaDonInfoDto
            {
                IdHoaDon = updatedHoaDon.IdHoaDon,
                SoBan = updatedHoaDon.Ban?.SoBan ?? updatedHoaDon.LoaiHoaDon,
                LoaiHoaDon = updatedHoaDon.LoaiHoaDon,
                TongTienGoc = updatedHoaDon.TongTienGoc,
                GiamGia = updatedHoaDon.GiamGia,
                ThanhTien = updatedHoaDon.ThanhTien,
                IdKhuyenMai = currentPromotion?.IdKhuyenMai // Sá»¬A: idKhuyenMai
            };
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\NhanVien\GiaoHangController.cs
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;

namespace CafebookApi.Controllers.App.NhanVien
{
    [Route("api/[controller]")]
    [ApiController]
    public class GiaoHangController : ControllerBase
    {
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\NhanVien\KhuyenMaiController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp.NhanVien;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App.NhanVien
{
    [Route("api/app/nhanvien/khuyenmai")]
    [ApiController]
    public class KhuyenMaiController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public KhuyenMaiController(CafebookDbContext context)
        {
            _context = context;
        }

        [HttpGet("available/{idHoaDon}")]
        public async Task<IActionResult> GetAvailablePromotions(int idHoaDon)
        {
            var hoaDon = await _context.HoaDons
                .Include(h => h.ChiTietHoaDons)
                .FirstOrDefaultAsync(h => h.IdHoaDon == idHoaDon);

            if (hoaDon == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y hÃ³a Ä‘Æ¡n.");

            var now = DateTime.Now;

            // === Sá»¬A Lá»–I TRANSLATE ===
            // 1. Táº£i toÃ n bá»™ KM vá» bá»™ nhá»› (Client Evaluation)
            var allKms = await _context.KhuyenMais.ToListAsync();

            var resultList = new List<KhuyenMaiHienThiDto>();

            // 2. DÃ¹ng C# Ä‘á»ƒ lá»c (Where) thay vÃ¬ SQL
            foreach (var km in allKms)
            {
                // YÃŠU Cáº¦U: "cÃ¡c khuyáº¿n mÃ£i Táº¡m dá»«ng , Háº¿t háº¡n sáº½ khÃ´ng hiá»ƒn thá»‹"
                if (!string.Equals(km.TrangThai, "Hoáº¡t Ä‘á»™ng", StringComparison.OrdinalIgnoreCase) ||
                    km.NgayBatDau > now ||
                    km.NgayKetThuc < now)
                {
                    continue; // Bá» qua náº¿u khÃ´ng há»£p lá»‡ vá» tráº¡ng thÃ¡i/ngÃ y
                }

                var (isEligible, reason, discountValue) = CheckEligibility(km, hoaDon, now);

                var dto = new KhuyenMaiHienThiDto
                {
                    IdKhuyenMai = km.IdKhuyenMai,
                    MaKhuyenMai = km.MaKhuyenMai,
                    TenChuongTrinh = km.TenChuongTrinh,
                    DieuKienApDung = string.IsNullOrEmpty(km.DieuKienApDung) ? km.MoTa : km.DieuKienApDung,
                    LoaiGiamGia = km.LoaiGiamGia,
                    GiaTriGiam = km.GiaTriGiam,
                    GiamToiDa = km.GiamToiDa,

                    IsEligible = isEligible,
                    IneligibilityReason = reason,
                    CalculatedDiscount = discountValue
                };
                resultList.Add(dto);
            }
            // === Káº¾T THÃšC Sá»¬A Lá»–I ===

            return Ok(resultList
                .OrderByDescending(k => k.IsEligible)
                .ThenByDescending(k => k.CalculatedDiscount)
                .ThenBy(k => k.TenChuongTrinh));
        }

        // Sá»­a: HÃ m kiá»ƒm tra tráº£ vá» 3 giÃ¡ trá»‹
        private (bool IsEligible, string? Reason, decimal CalculatedDiscount) CheckEligibility(KhuyenMai km, HoaDon hoaDon, DateTime now)
        {
            decimal calculatedDiscount = 0m;

            // Logic dá»±a trÃªn mÃ´ táº£ cá»§a báº¡n
            if (!string.Equals(km.TrangThai, "Hoáº¡t Ä‘á»™ng", StringComparison.OrdinalIgnoreCase))
                return (false, "Khuyáº¿n mÃ£i Ä‘Ã£ bá»‹ táº¡m ngÆ°ng.", 0);
            if (km.NgayBatDau > now)
                return (false, $"ChÆ°a tá»›i ngÃ y (Báº¯t Ä‘áº§u tá»« {km.NgayBatDau:dd/MM}).", 0);
            if (km.NgayKetThuc < now)
                return (false, $"ÄÃ£ háº¿t háº¡n (Káº¿t thÃºc lÃºc {km.NgayKetThuc:dd/MM}).", 0);
            if (km.SoLuongConLai.HasValue && km.SoLuongConLai <= 0)
                return (false, "ÄÃ£ háº¿t lÆ°á»£t sá»­ dá»¥ng.", 0);
            if (km.HoaDonToiThieu.HasValue && km.HoaDonToiThieu > 0 && hoaDon.TongTienGoc < km.HoaDonToiThieu.Value)
                return (false, $"Cáº§n hÃ³a Ä‘Æ¡n tá»‘i thiá»ƒu {km.HoaDonToiThieu.Value:N0} Ä‘.", 0);
            if (km.GioBatDau.HasValue && km.GioKetThuc.HasValue && (now.TimeOfDay < km.GioBatDau || now.TimeOfDay > km.GioKetThuc))
                return (false, $"Chá»‰ Ã¡p dá»¥ng trong khung giá» {km.GioBatDau} - {km.GioKetThuc}.", 0);

            if (!string.IsNullOrWhiteSpace(km.NgayTrongTuan))
            {
                string homNay = "";
                switch (now.DayOfWeek)
                {
                    case DayOfWeek.Monday: homNay = "Thá»© 2"; break;
                    case DayOfWeek.Tuesday: homNay = "Thá»© 3"; break;
                    case DayOfWeek.Wednesday: homNay = "Thá»© 4"; break;
                    case DayOfWeek.Thursday: homNay = "Thá»© 5"; break;
                    case DayOfWeek.Friday: homNay = "Thá»© 6"; break;
                    case DayOfWeek.Saturday: homNay = "Thá»© 7"; break;
                    case DayOfWeek.Sunday: homNay = "Chá»§ nháº­t"; break;
                }
                var ngayHopLe = km.NgayTrongTuan.Split(new[] { ',', ';' }, StringSplitOptions.RemoveEmptyEntries).Select(d => d.Trim());
                if (!ngayHopLe.Contains(homNay, StringComparer.OrdinalIgnoreCase))
                {
                    return (false, $"Chá»‰ Ã¡p dá»¥ng vÃ o {km.NgayTrongTuan}.", 0);
                }
            }

            // TÃ­nh toÃ¡n giÃ¡ trá»‹ giáº£m
            decimal tongTienGocChoKM = hoaDon.TongTienGoc;
            if (km.IdSanPhamApDung.HasValue)
            {
                if (!hoaDon.ChiTietHoaDons.Any(c => c.IdSanPham == km.IdSanPhamApDung.Value))
                {
                    var sp = _context.SanPhams.Find(km.IdSanPhamApDung.Value);
                    return (false, $"Chá»‰ Ã¡p dá»¥ng cho sáº£n pháº©m '{sp?.TenSanPham}'.", 0);
                }
                // Náº¿u cÃ³, chá»‰ tÃ­nh tiá»n cÃ¡c SP Ä‘Ã³
                tongTienGocChoKM = hoaDon.ChiTietHoaDons
                    .Where(c => c.IdSanPham == km.IdSanPhamApDung.Value)
                    .Sum(c => c.ThanhTien);
            }

            // TÃ­nh toÃ¡n
            if (string.Equals(km.LoaiGiamGia, "PhanTram", StringComparison.OrdinalIgnoreCase))
            {
                calculatedDiscount = tongTienGocChoKM * (km.GiaTriGiam / 100);
                if (km.GiamToiDa.HasValue && calculatedDiscount > km.GiamToiDa.Value)
                {
                    calculatedDiscount = km.GiamToiDa.Value;
                }
            }
            else // SoTien
            {
                calculatedDiscount = km.GiaTriGiam;
            }

            return (true, null, calculatedDiscount); // Há»£p lá»‡
        }
    }
}

e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\NhanVien\SoDoBanController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;
using System;
using CafebookModel.Model.ModelApp.NhanVien;

namespace CafebookApi.Controllers.App.NhanVien
{
    [Route("api/app/sodoban")]
    [ApiController]
    public class SoDoBanController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public SoDoBanController(CafebookDbContext context)
        {
            _context = context;
        }

        // (CÃ¡c hÃ m GetSoDoBan, CreateOrder, BaoCaoSuCo, CreateOrderNoTable giá»¯ nguyÃªn)
        [HttpGet("tables")]
        public async Task<IActionResult> GetSoDoBan()
        {
            var data = await _context.Bans
               .AsNoTracking()
               .Select(b => new BanSoDoDto
               {
                   IdBan = b.IdBan,
                   SoBan = b.SoBan,
                   TrangThai = b.TrangThai,
                   GhiChu = b.GhiChu,
                   IdKhuVuc = b.IdKhuVuc,
                   IdHoaDonHienTai = _context.HoaDons
                                       .Where(h => h.IdBan == b.IdBan && h.TrangThai == "ChÆ°a thanh toÃ¡n")
                                       .Select(h => (int?)h.IdHoaDon)
                                       .FirstOrDefault(),
                   TongTienHienTai = _context.HoaDons
                                       .Where(h => h.IdBan == b.IdBan && h.TrangThai == "ChÆ°a thanh toÃ¡n")
                                       .Select(h => h.ThanhTien)
                                       .FirstOrDefault()
               })
               .OrderBy(b => b.SoBan)
               .ToListAsync();
            return Ok(data);
        }

        [HttpPost("createorder/{idBan}/{idNhanVien}")]
        public async Task<IActionResult> CreateOrder(int idBan, int idNhanVien)
        {
            var ban = await _context.Bans.FindAsync(idBan);
            if (ban == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y bÃ n.");
            if (ban.TrangThai != "Trá»‘ng" && ban.TrangThai != "ÄÃ£ Ä‘áº·t")
                return Conflict("BÃ n nÃ y Ä‘ang báº­n hoáº·c Ä‘ang báº£o trÃ¬.");
            var nhanVien = await _context.NhanViens.FindAsync(idNhanVien);
            if (nhanVien == null) return NotFound("NhÃ¢n viÃªn khÃ´ng há»£p lá»‡.");
            var hoaDon = new HoaDon
            {
                IdBan = idBan,
                IdNhanVien = idNhanVien,
                TrangThai = "ChÆ°a thanh toÃ¡n",
                LoaiHoaDon = "Táº¡i quÃ¡n",
                ThoiGianTao = DateTime.Now
            };
            _context.HoaDons.Add(hoaDon);
            ban.TrangThai = "CÃ³ khÃ¡ch";
            await _context.SaveChangesAsync();
            return Ok(new { idHoaDon = hoaDon.IdHoaDon });
        }

        [HttpPost("reportproblem/{idBan}/{idNhanVien}")]
        public async Task<IActionResult> BaoCaoSuCo(int idBan, int idNhanVien, [FromBody] BaoCaoSuCoRequestDto request)
        {
            var ban = await _context.Bans.FindAsync(idBan);
            if (ban == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y bÃ n.");
            if (ban.TrangThai == "CÃ³ khÃ¡ch")
                return Conflict("KhÃ´ng thá»ƒ bÃ¡o cÃ¡o sá»± cá»‘ bÃ n Ä‘ang cÃ³ khÃ¡ch.");
            ban.TrangThai = "Báº£o trÃ¬";
            ban.GhiChu = $"[Sá»± cá»‘ NV bÃ¡o]: {request.GhiChuSuCo}";
            var thongBao = new ThongBao
            {
                IdNhanVienTao = idNhanVien,
                NoiDung = $"BÃ n {ban.SoBan} vá»«a Ä‘Æ°á»£c bÃ¡o cÃ¡o sá»± cá»‘: {request.GhiChuSuCo}",
                LoaiThongBao = "SuCoBan",
                IdLienQuan = idBan,
                ThoiGianTao = DateTime.Now,
                DaXem = false
            };
            _context.ThongBaos.Add(thongBao);
            await _context.SaveChangesAsync();
            return Ok(new { message = "BÃ¡o cÃ¡o sá»± cá»‘ thÃ nh cÃ´ng. BÃ n Ä‘Ã£ Ä‘Æ°á»£c khÃ³a." });
        }

        [HttpPost("createorder-no-table/{idNhanVien}")]
        public async Task<IActionResult> CreateOrderNoTable(int idNhanVien, [FromBody] string loaiHoaDon)
        {
            if (loaiHoaDon != "Mang vá»" && loaiHoaDon != "Táº¡i quáº§y")
                return BadRequest("Loáº¡i hÃ³a Ä‘Æ¡n khÃ´ng há»£p lá»‡.");
            var nhanVien = await _context.NhanViens.FindAsync(idNhanVien);
            if (nhanVien == null) return NotFound("NhÃ¢n viÃªn khÃ´ng há»£p lá»‡.");
            var hoaDon = new HoaDon
            {
                IdBan = null,
                IdNhanVien = idNhanVien,
                TrangThai = "ChÆ°a thanh toÃ¡n",
                LoaiHoaDon = loaiHoaDon,
                ThoiGianTao = DateTime.Now
            };
            _context.HoaDons.Add(hoaDon);
            await _context.SaveChangesAsync();
            return Ok(new { idHoaDon = hoaDon.IdHoaDon });
        }


        // === Báº®T Äáº¦U NÃ‚NG Cáº¤P ===

        [HttpPost("move-table")]
        public async Task<IActionResult> MoveTable([FromBody] BanActionRequestDto dto)
        {
            // (HÃ m Chuyá»ƒn BÃ n giá»¯ nguyÃªn)
            var hoaDon = await _context.HoaDons.Include(h => h.Ban).FirstOrDefaultAsync(h => h.IdHoaDon == dto.IdHoaDonNguon);
            if (hoaDon == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y hÃ³a Ä‘Æ¡n nguá»“n.");
            var banDich = await _context.Bans.FindAsync(dto.IdBanDich);
            if (banDich == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y bÃ n Ä‘Ã­ch.");
            if (banDich.TrangThai != "Trá»‘ng") return Conflict("BÃ n Ä‘Ã­ch Ä‘ang báº­n, khÃ´ng thá»ƒ chuyá»ƒn Ä‘áº¿n.");
            if (hoaDon.Ban != null) hoaDon.Ban.TrangThai = "Trá»‘ng";
            banDich.TrangThai = "CÃ³ khÃ¡ch";
            hoaDon.IdBan = dto.IdBanDich;
            await _context.SaveChangesAsync();
            return Ok(new { message = "Chuyá»ƒn bÃ n thÃ nh cÃ´ng." });
        }


        [HttpPost("merge-table")]
        public async Task<IActionResult> MergeTable([FromBody] BanActionRequestDto dto)
        {
            if (dto.IdHoaDonNguon == dto.IdHoaDonDich)
                return BadRequest("KhÃ´ng thá»ƒ gá»™p bÃ n vÃ o chÃ­nh nÃ³.");

            var chiTietNguon = await _context.ChiTietHoaDons
                .Where(c => c.IdHoaDon == dto.IdHoaDonNguon)
                .ToListAsync();

            if (!chiTietNguon.Any())
                return BadRequest("BÃ n nguá»“n khÃ´ng cÃ³ sáº£n pháº©m Ä‘á»ƒ gá»™p.");

            var hoaDonNguon = await _context.HoaDons
                .Include(h => h.Ban)
                .FirstOrDefaultAsync(h => h.IdHoaDon == dto.IdHoaDonNguon);

            if (hoaDonNguon == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y hÃ³a Ä‘Æ¡n nguá»“n.");

            // Sá»¬A Lá»–I CS0266: Kiá»ƒm tra HÄ ÄÃ­ch cÃ³ tá»“n táº¡i khÃ´ng
            if (!dto.IdHoaDonDich.HasValue ||
                !await _context.HoaDons.AnyAsync(h => h.IdHoaDon == dto.IdHoaDonDich.Value))
            {
                return NotFound("KhÃ´ng tÃ¬m tháº¥y hÃ³a Ä‘Æ¡n Ä‘Ã­ch.");
            }

            // Chuyá»ƒn cÃ¡c chi tiáº¿t HÄ
            foreach (var ct in chiTietNguon)
            {
                // Sá»¬A Lá»–I CS0266: GÃ¡n .Value
                ct.IdHoaDon = dto.IdHoaDonDich.Value;
            }

            // Sá»¬A Lá»–I CS1061: XÃ³a dÃ²ng nÃ y. CSDL (cá»™t computed) sáº½ tá»± tÃ­nh láº¡i tá»•ng tiá»n.
            // hoaDonDich.TongTien += tongTienGop; 

            if (hoaDonNguon.Ban != null)
            {
                hoaDonNguon.Ban.TrangThai = "Trá»‘ng";
            }

            _context.HoaDons.Remove(hoaDonNguon);

            await _context.SaveChangesAsync();
            return Ok(new { message = "Gá»™p bÃ n thÃ nh cÃ´ng." });
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\NhanVien\ThanhToanController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp.NhanVien;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App.NhanVien
{
    [Route("api/app/nhanvien/thanhtoan")]
    [ApiController]
    public class ThanhToanController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private decimal _tiLeDoiDiem = 1000m;
        private decimal _tiLeNhanDiem = 10000m;
        private Dictionary<string, string> _settings = new Dictionary<string, string>();

        public ThanhToanController(CafebookDbContext context)
        {
            _context = context;
        }

        // HÃ m helper táº£i cÃ i Ä‘áº·t
        private async Task LoadCaiDat()
        {
            _settings = await _context.CaiDats
                .Where(c =>
                    c.TenCaiDat == "DiemTichLuy_DoiVND" ||
                    c.TenCaiDat == "DiemTichLuy_NhanVND" ||
                    c.TenCaiDat == "TenQuan" ||
                    c.TenCaiDat == "DiaChi" ||
                    c.TenCaiDat == "SoDienThoai" ||
                    c.TenCaiDat == "Wifi_MatKhau")
                .AsNoTracking()
                .ToDictionaryAsync(c => c.TenCaiDat, c => c.GiaTri);

            decimal.TryParse(_settings.GetValueOrDefault("DiemTichLuy_DoiVND", "1000"), out _tiLeDoiDiem);
            decimal.TryParse(_settings.GetValueOrDefault("DiemTichLuy_NhanVND", "10000"), out _tiLeNhanDiem);
            if (_tiLeNhanDiem == 0) _tiLeNhanDiem = 10000;
            if (_tiLeDoiDiem == 0) _tiLeDoiDiem = 1000;
        }

        /// <summary>
        /// Táº£i dá»¯ liá»‡u cho mÃ n hÃ¬nh ThanhToanView
        /// </summary>
        [HttpGet("load/{idHoaDon}")]
        public async Task<IActionResult> LoadThanhToanData(int idHoaDon)
        {
            await LoadCaiDat(); // Táº£i cÃ i Ä‘áº·t

            var hoaDon = await _context.HoaDons
                .Include(h => h.Ban)
                .AsNoTracking()
                .FirstOrDefaultAsync(h => h.IdHoaDon == idHoaDon);

            if (hoaDon == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y hÃ³a Ä‘Æ¡n.");

            var hoaDonInfo = new HoaDonInfoDto
            {
                IdHoaDon = hoaDon.IdHoaDon,
                SoBan = hoaDon.Ban?.SoBan ?? hoaDon.LoaiHoaDon,
                LoaiHoaDon = hoaDon.LoaiHoaDon,
                TongTienGoc = hoaDon.TongTienGoc,
                GiamGia = hoaDon.GiamGia,
                ThanhTien = hoaDon.ThanhTien,
            };

            var chiTietItems = await _context.ChiTietHoaDons
                .Where(c => c.IdHoaDon == idHoaDon)
                .AsNoTracking()
                .Select(c => new ChiTietDto
                {
                    IdChiTietHoaDon = c.IdChiTietHoaDon,
                    IdSanPham = c.IdSanPham,
                    TenSanPham = c.SanPham.TenSanPham,
                    SoLuong = c.SoLuong,
                    DonGia = c.DonGia,
                    ThanhTien = c.ThanhTien
                }).ToListAsync();

            var phuThusDaApDung = await _context.ChiTietPhuThuHoaDons
                .Where(pt => pt.IdHoaDon == idHoaDon)
                .AsNoTracking()
                .Select(pt => new PhuThuDto
                {
                    IdPhuThu = pt.IdPhuThu,
                    TenPhuThu = pt.PhuThu.TenPhuThu,
                    SoTien = pt.SoTien,
                    LoaiGiaTri = pt.PhuThu.LoaiGiaTri,
                    GiaTri = pt.PhuThu.GiaTri
                }).ToListAsync();

            var idPhuThuDaApDung = phuThusDaApDung.Select(p => p.IdPhuThu);
            var phuThusKhaDung = await _context.PhuThus
                .Where(p => !idPhuThuDaApDung.Contains(p.IdPhuThu))
                .AsNoTracking()
                .ToListAsync();

            var khuyenMaiLink = await _context.HoaDonKhuyenMais
                .AsNoTracking()
                .FirstOrDefaultAsync(hkm => hkm.IdHoaDon == idHoaDon);

            KhachHang? khachHang = null;
            if (hoaDon.IdKhachHang.HasValue)
            {
                khachHang = await _context.KhachHangs.AsNoTracking().FirstOrDefaultAsync(kh => kh.IdKhachHang == hoaDon.IdKhachHang.Value);
            }

            // Sá»¬A Lá»–I CS0117: Táº£i danh sÃ¡ch KH cho ComboBox
            var khachHangsList = await _context.KhachHangs
                .AsNoTracking()
                .Select(kh => new KhachHangTimKiemDto
                {
                    IdKhachHang = kh.IdKhachHang,
                    DisplayText = kh.HoTen + " - " + (kh.SoDienThoai ?? kh.Email),
                    KhachHangData = kh
                }).ToListAsync();

            return Ok(new ThanhToanViewDto
            {
                HoaDonInfo = hoaDonInfo,
                ChiTietItems = chiTietItems,
                IdKhuyenMaiDaApDung = khuyenMaiLink?.IdKhuyenMai, // Tráº£ vá» ID
                PhuThusDaApDung = phuThusDaApDung,
                PhuThusKhaDung = phuThusKhaDung,
                KhachHang = khachHang,
                KhachHangsList = khachHangsList, // Tráº£ vá» DS KhÃ¡ch hÃ ng
                DiemTichLuy_DoiVND = _tiLeDoiDiem,
                DiemTichLuy_NhanVND = _tiLeNhanDiem,

                TenQuan = _settings.GetValueOrDefault("TenQuan", "CafeBook"),
                DiaChi = _settings.GetValueOrDefault("DiaChi", "N/A"),
                SoDienThoai = _settings.GetValueOrDefault("SoDienThoai", "N/A"),
                WifiMatKhau = _settings.GetValueOrDefault("Wifi_MatKhau", "N/A")
            });
        }

        [HttpGet("find-customer")]
        public async Task<IActionResult> FindCustomer([FromQuery] string query)
        {
            if (string.IsNullOrEmpty(query)) return BadRequest();
            var khachHang = await _context.KhachHangs
                .FirstOrDefaultAsync(kh => kh.SoDienThoai == query || kh.Email == query || kh.HoTen.Contains(query));
            if (khachHang == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y khÃ¡ch hÃ ng.");
            return Ok(khachHang);
        }

        [HttpPost("pay")]
        public async Task<IActionResult> ProcessPayment([FromBody] ThanhToanRequestDto req)
        {
            await LoadCaiDat();

            var hoaDonGoc = await _context.HoaDons
                .Include(h => h.Ban)
                .Include(h => h.ChiTietHoaDons)
                .Include(h => h.ChiTietPhuThuHoaDons)
                .FirstOrDefaultAsync(h => h.IdHoaDon == req.IdHoaDonGoc);

            if (hoaDonGoc == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y hÃ³a Ä‘Æ¡n gá»‘c.");
            if (hoaDonGoc.TrangThai != "ChÆ°a thanh toÃ¡n") return Conflict("HÃ³a Ä‘Æ¡n nÃ y Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½.");

            var allItemsGocIds = hoaDonGoc.ChiTietHoaDons.Select(c => c.IdChiTietHoaDon).ToList();
            bool isFullPayment = allItemsGocIds.Count == req.IdChiTietTach.Count && allItemsGocIds.All(req.IdChiTietTach.Contains);

            HoaDon hoaDonThanhToan;

            var chiTietTach = hoaDonGoc.ChiTietHoaDons
                .Where(c => req.IdChiTietTach.Contains(c.IdChiTietHoaDon)).ToList();

            var phuThuDaApDungGoc = hoaDonGoc.ChiTietPhuThuHoaDons
                .Where(pt => req.IdPhuThuTach.Contains(pt.IdPhuThu)).ToList();
            var idPhuThuMoi = req.IdPhuThuTach.Where(id => !phuThuDaApDungGoc.Any(pt => pt.IdPhuThu == id)).ToList();
            var phuThuMoi = await _context.PhuThus.Where(p => idPhuThuMoi.Contains(p.IdPhuThu)).ToListAsync();

            if (isFullPayment)
            {
                hoaDonThanhToan = hoaDonGoc;
                if (req.IdKhachHang.HasValue)
                    hoaDonThanhToan.IdKhachHang = req.IdKhachHang;
            }
            else
            {
                hoaDonThanhToan = new HoaDon
                {
                    IdBan = hoaDonGoc.IdBan,
                    IdNhanVien = hoaDonGoc.IdNhanVien,
                    IdKhachHang = req.IdKhachHang,
                    ThoiGianTao = hoaDonGoc.ThoiGianTao,
                    LoaiHoaDon = hoaDonGoc.LoaiHoaDon,
                    GhiChu = $"TÃ¡ch tá»« HÄ #{hoaDonGoc.IdHoaDon}"
                };
                _context.HoaDons.Add(hoaDonThanhToan);
                await _context.SaveChangesAsync();

                decimal tongTienTach = 0;
                foreach (var chiTiet in chiTietTach)
                {
                    chiTiet.IdHoaDon = hoaDonThanhToan.IdHoaDon;
                    tongTienTach += chiTiet.ThanhTien;
                }
                hoaDonThanhToan.TongTienGoc = tongTienTach;

                decimal tongPhuThuTach = 0;
                foreach (var phuThu in phuThuDaApDungGoc)
                {
                    phuThu.IdHoaDon = hoaDonThanhToan.IdHoaDon;
                    tongPhuThuTach += phuThu.SoTien;
                }
                foreach (var ptMoi in phuThuMoi)
                {
                    decimal soTienPT = string.Equals(ptMoi.LoaiGiaTri, "%", StringComparison.OrdinalIgnoreCase)
                        ? (tongTienTach * (ptMoi.GiaTri / 100))
                        : ptMoi.GiaTri;
                    _context.ChiTietPhuThuHoaDons.Add(new ChiTietPhuThuHoaDon
                    {
                        IdHoaDon = hoaDonThanhToan.IdHoaDon,
                        IdPhuThu = ptMoi.IdPhuThu,
                        SoTien = soTienPT
                    });
                    tongPhuThuTach += soTienPT;
                }
                hoaDonThanhToan.TongPhuThu = tongPhuThuTach;

                hoaDonGoc.TongTienGoc = hoaDonGoc.ChiTietHoaDons.Sum(c => c.ThanhTien);
                hoaDonGoc.TongPhuThu = hoaDonGoc.ChiTietPhuThuHoaDons.Sum(pt => pt.SoTien);
            }

            decimal giamGiaKM = 0;
            decimal giamGiaDiem = 0;

            if (req.IdKhuyenMai.HasValue && req.IdKhuyenMai > 0)
            {
                var km = await _context.KhuyenMais.FindAsync(req.IdKhuyenMai.Value);
                if (km != null)
                {
                    giamGiaKM = await CalculateDiscount(km, hoaDonThanhToan.TongTienGoc, chiTietTach);
                    _context.HoaDonKhuyenMais.Add(new HoaDon_KhuyenMai { IdHoaDon = hoaDonThanhToan.IdHoaDon, IdKhuyenMai = km.IdKhuyenMai });
                    if (km.SoLuongConLai.HasValue && km.SoLuongConLai > 0) km.SoLuongConLai -= 1;
                }
            }

            KhachHang? khachHang = null;
            if (req.IdKhachHang.HasValue)
            {
                khachHang = await _context.KhachHangs.FindAsync(req.IdKhachHang.Value);
            }

            if (khachHang != null && req.DiemSuDung > 0)
            {
                if (khachHang.DiemTichLuy < req.DiemSuDung)
                    return BadRequest("KhÃ¡ch hÃ ng khÃ´ng Ä‘á»§ Ä‘iá»ƒm tÃ­ch lÅ©y.");

                giamGiaDiem = req.DiemSuDung * _tiLeDoiDiem;

                // Sá»¬A Lá»–I CS0019: TongPhuThu lÃ  decimal (khÃ´ng rá»—ng)
                decimal tongTruocDiem = hoaDonThanhToan.TongTienGoc + hoaDonThanhToan.TongPhuThu - giamGiaKM;

                if (giamGiaDiem > tongTruocDiem)
                {
                    giamGiaDiem = tongTruocDiem;
                    req.DiemSuDung = (int)Math.Ceiling(giamGiaDiem / _tiLeDoiDiem);
                }

                khachHang.DiemTichLuy -= req.DiemSuDung;
                hoaDonThanhToan.IdKhachHang = khachHang.IdKhachHang;
            }

            hoaDonThanhToan.GiamGia = giamGiaKM + giamGiaDiem;

            await TruKho(hoaDonThanhToan.IdNhanVien, chiTietTach);

            hoaDonThanhToan.TrangThai = "ÄÃ£ thanh toÃ¡n";
            hoaDonThanhToan.ThoiGianThanhToan = DateTime.Now;
            hoaDonThanhToan.PhuongThucThanhToan = req.PhuongThucThanhToan;

            await _context.SaveChangesAsync();

            _context.GiaoDichThanhToans.Add(new GiaoDichThanhToan
            {
                IdHoaDon = hoaDonThanhToan.IdHoaDon,
                MaGiaoDichNgoai = $"HD_{hoaDonThanhToan.IdHoaDon}_{DateTime.Now:HHmmss}",
                CongThanhToan = req.PhuongThucThanhToan,
                SoTien = hoaDonThanhToan.ThanhTien,
                ThoiGianGiaoDich = (DateTime)hoaDonThanhToan.ThoiGianThanhToan,
                TrangThai = "ThÃ nh cÃ´ng"
            });

            if (khachHang != null && _tiLeNhanDiem > 0)
            {
                if (req.DiemSuDung == 0)
                {
                    int diemMoi = (int)Math.Floor(hoaDonThanhToan.ThanhTien / _tiLeNhanDiem);
                    if (diemMoi > 0)
                    {
                        khachHang.DiemTichLuy += diemMoi;
                    }
                }
            }

            if (isFullPayment || (hoaDonGoc.TongTienGoc == 0 && hoaDonGoc.TongPhuThu == 0))
            {
                if (hoaDonGoc.Ban != null)
                {
                    hoaDonGoc.Ban.TrangThai = "Trá»‘ng";
                }
                if (!isFullPayment)
                {
                    hoaDonGoc.TrangThai = "ÄÃ£ há»§y";
                }
            }

            await _context.SaveChangesAsync();
            return Ok(new { message = "Thanh toÃ¡n thÃ nh cÃ´ng!", isFullPayment = isFullPayment });
        }

        #region HÃ m Helper (Trá»« kho, TÃ­nh KM)

        private async Task TruKho(int idNhanVien, ICollection<ChiTietHoaDon> chiTietList)
        {
            foreach (var chiTiet in chiTietList)
            {
                var dinhLuongList = await _context.DinhLuongs
                    .Include(d => d.NguyenLieu)
                    .Include(d => d.DonViSuDung)
                    .Where(d => d.IdSanPham == chiTiet.IdSanPham)
                    .ToListAsync();

                foreach (var dl in dinhLuongList)
                {
                    var nguyenLieu = await _context.NguyenLieus.FindAsync(dl.IdNguyenLieu);
                    if (nguyenLieu != null)
                    {
                        decimal luongCanTru = (dl.SoLuongSuDung * dl.DonViSuDung.GiaTriQuyDoi) * chiTiet.SoLuong;
                        nguyenLieu.TonKho -= luongCanTru;

                        if (nguyenLieu.TonKho <= nguyenLieu.TonKhoToiThieu)
                        {
                            _context.ThongBaos.Add(new ThongBao
                            {
                                IdNhanVienTao = idNhanVien,
                                NoiDung = $"Cáº£nh bÃ¡o: Tá»“n kho '{nguyenLieu.TenNguyenLieu}' chá»‰ cÃ²n {nguyenLieu.TonKho:N2} {nguyenLieu.DonViTinh}.",
                                ThoiGianTao = DateTime.Now,
                                LoaiThongBao = "CanhBaoKho",
                                IdLienQuan = nguyenLieu.IdNguyenLieu
                            });
                        }
                    }
                }
            }
        }

        private async Task<decimal> CalculateDiscount(KhuyenMai km, decimal tongTienGoc, ICollection<ChiTietHoaDon> chiTietList)
        {
            decimal tongTienGocChoKM = tongTienGoc;
            if (km.IdSanPhamApDung.HasValue)
            {
                tongTienGocChoKM = chiTietList
                    .Where(c => c.IdSanPham == km.IdSanPhamApDung.Value)
                    .Sum(c => c.ThanhTien);
            }

            decimal giamGia = 0;
            if (string.Equals(km.LoaiGiamGia, "PhanTram", StringComparison.OrdinalIgnoreCase))
            {
                giamGia = tongTienGocChoKM * (km.GiaTriGiam / 100);
                if (km.GiamToiDa.HasValue && giamGia > km.GiamToiDa.Value)
                {
                    giamGia = km.GiamToiDa.Value;
                }
            }
            else // SoTien
            {
                giamGia = km.GiaTriGiam;
            }
            return await Task.FromResult(giamGia);
        }

        #endregion
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\BanQuanLyController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using CafebookModel.Model.Entities;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/banquanly")]
    [ApiController]
    public class BanQuanLyController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public BanQuanLyController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// Láº¥y toÃ n bá»™ cÃ¢y Khu Vá»±c vÃ  BÃ n
        /// </summary>
        [HttpGet("tree")]
        public async Task<IActionResult> GetKhuVucTree()
        {
            var data = await _context.KhuVucs
                .AsNoTracking()
                .Select(kv => new KhuVucDto // Chuyá»ƒn Ä‘á»•i sang DTO
                {
                    IdKhuVuc = kv.IdKhuVuc,
                    TenKhuVuc = kv.TenKhuVuc,
                    MoTa = kv.MoTa,
                    Bans = kv.Bans.Select(b => new BanDto
                    {
                        IdBan = b.IdBan,
                        SoBan = b.SoBan,
                        SoGhe = b.SoGhe,
                        TrangThai = b.TrangThai,
                        GhiChu = b.GhiChu,
                        IdKhuVuc = b.IdKhuVuc ?? 0
                    }).ToList()
                })
                .ToListAsync();

            return Ok(data);
        }

        // --- API CHO KHU Vá»°C ---

        [HttpPost("khuvuc")]
        public async Task<IActionResult> CreateKhuVuc([FromBody] KhuVucUpdateRequestDto dto)
        {
            var khuVuc = new KhuVuc
            {
                TenKhuVuc = dto.TenKhuVuc,
                MoTa = dto.MoTa
            };
            _context.KhuVucs.Add(khuVuc);
            await _context.SaveChangesAsync();
            return Ok(khuVuc); // Tráº£ vá» Ä‘á»‘i tÆ°á»£ng Ä‘Ã£ táº¡o
        }

        [HttpPut("khuvuc/{id}")]
        public async Task<IActionResult> UpdateKhuVuc(int id, [FromBody] KhuVucUpdateRequestDto dto)
        {
            var khuVuc = await _context.KhuVucs.FindAsync(id);
            if (khuVuc == null) return NotFound();

            khuVuc.TenKhuVuc = dto.TenKhuVuc;
            khuVuc.MoTa = dto.MoTa;
            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpDelete("khuvuc/{id}")]
        public async Task<IActionResult> DeleteKhuVuc(int id)
        {
            // Kiá»ƒm tra rÃ ng buá»™c (cÃ²n bÃ n khÃ´ng)
            if (await _context.Bans.AnyAsync(b => b.IdKhuVuc == id))
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a khu vá»±c Ä‘ang chá»©a bÃ n. Vui lÃ²ng di chuyá»ƒn hoáº·c xÃ³a cÃ¡c bÃ n trÆ°á»›c.");
            }

            var khuVuc = await _context.KhuVucs.FindAsync(id);
            if (khuVuc == null) return NotFound();

            _context.KhuVucs.Remove(khuVuc);
            await _context.SaveChangesAsync();
            return Ok();
        }

        // --- API CHO BÃ€N ---

        [HttpPost("ban")]
        public async Task<IActionResult> CreateBan([FromBody] BanUpdateRequestDto dto)
        {
            var ban = new Ban
            {
                SoBan = dto.SoBan,
                SoGhe = dto.SoGhe,
                IdKhuVuc = dto.IdKhuVuc,
                TrangThai = "Trá»‘ng", // Máº·c Ä‘á»‹nh khi thÃªm má»›i
                GhiChu = dto.GhiChu
            };
            _context.Bans.Add(ban);
            await _context.SaveChangesAsync();
            return Ok(ban);
        }

        [HttpPut("ban/{id}")]
        public async Task<IActionResult> UpdateBan(int id, [FromBody] BanUpdateRequestDto dto)
        {
            var ban = await _context.Bans.FindAsync(id);
            if (ban == null) return NotFound();

            ban.SoBan = dto.SoBan;
            ban.SoGhe = dto.SoGhe;
            ban.IdKhuVuc = dto.IdKhuVuc;   // Cho phÃ©p di chuyá»ƒn bÃ n
            ban.TrangThai = dto.TrangThai; // Cho phÃ©p khÃ³a bÃ n
            ban.GhiChu = dto.GhiChu;

            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpDelete("ban/{id}")]
        public async Task<IActionResult> DeleteBan(int id)
        {
            // Kiá»ƒm tra rÃ ng buá»™c theo yÃªu cáº§u
            if (await _context.HoaDons.AnyAsync(h => h.IdBan == id && h.TrangThai != "ÄÃ£ thanh toÃ¡n"))
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a. BÃ n Ä‘ang cÃ³ hÃ³a Ä‘Æ¡n CHÆ¯A thanh toÃ¡n.");
            }
            if (await _context.PhieuDatBans.AnyAsync(p => p.IdBan == id && p.ThoiGianDat > DateTime.Now))
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a. BÃ n Ä‘ang cÃ³ phiáº¿u Ä‘áº·t trÆ°á»›c CHÆ¯A diá»…n ra.");
            }

            var ban = await _context.Bans.FindAsync(id);
            if (ban == null) return NotFound();

            _context.Bans.Remove(ban);
            await _context.SaveChangesAsync();
            return Ok();
        }

        // --- API NÃ‚NG CAO ---

        [HttpGet("ban/{id}/history")]
        public async Task<IActionResult> GetBanHistory(int id)
        {
            var history = new BanHistoryDto
            {
                SoLuotPhucVu = await _context.HoaDons.CountAsync(h => h.IdBan == id && h.TrangThai == "ÄÃ£ thanh toÃ¡n"),
                TongDoanhThu = await _context.HoaDons
                                    .Where(h => h.IdBan == id && h.TrangThai == "ÄÃ£ thanh toÃ¡n")
                                    .SumAsync(h => h.ThanhTien),
                SoLuotDatTruoc = await _context.PhieuDatBans.CountAsync(p => p.IdBan == id)
            };
            return Ok(history);
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\BaoCaoController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/baocao")]
    [ApiController]
    public class BaoCaoController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public BaoCaoController(CafebookDbContext context)
        {
            _context = context;
        }

        [HttpPost("doanhthu")]
        public async Task<IActionResult> GetDoanhThuReport([FromBody] BaoCaoRequestDto request)
        {
            var startDate = request.StartDate.Date;
            var endDate = request.EndDate.Date.AddDays(1);

            // 1. TÃNH DOANH THU (Code nÃ y Ä‘Ã£ Ä‘Ãºng)
            var chiTietDoanhThu = (await _context.Database.SqlQuery<BaoCaoChiTietDoanhThuDto>($@"
                    SELECT
                        ISNULL(SUM(tongTienGoc), 0) AS TongDoanhThuGoc,
                        ISNULL(SUM(giamGia), 0) AS TongGiamGia,
                        ISNULL(SUM(TongPhuThu), 0) AS TongPhuThu,
                        ISNULL(SUM(thanhTien), 0) AS DoanhThuRong,
                        ISNULL(COUNT(idHoaDon), 0) AS SoLuongHoaDon,
                        ISNULL(AVG(thanhTien), 0) AS GiaTriTrungBinhHD
                    FROM dbo.HoaDon
                    WHERE trangThai = N'ÄÃ£ thanh toÃ¡n'
                    AND thoiGianThanhToan >= {startDate} AND thoiGianThanhToan < {endDate};
                ").ToListAsync()).FirstOrDefault() ?? new BaoCaoChiTietDoanhThuDto();

            // 2. TÃNH GIÃ Vá»N (COGS) (Sá»­a lá»—i CS1503 táº¡i Ä‘Ã¢y)
            // XÃ³a 'var cogsSql = ...' vÃ  truyá»n chuá»—i ná»™i suy TRá»°C TIáº¾P
            var cogsResult = await _context.Database.SqlQuery<decimal>($@"
                WITH GiaVonNguyenLieu AS (
                    SELECT idNguyenLieu, AVG(donGiaNhap) AS GiaVonTrungBinh
                    FROM dbo.ChiTietNhapKho GROUP BY idNguyenLieu
                ),
                SanPhamDaBan AS (
                    SELECT cthd.idSanPham, SUM(cthd.soLuong) AS TongSoLuongBan
                    FROM dbo.ChiTietHoaDon cthd
                    JOIN dbo.HoaDon hd ON cthd.idHoaDon = hd.idHoaDon
                    WHERE hd.trangThai = N'ÄÃ£ thanh toÃ¡n'
                    AND hd.thoiGianThanhToan >= {startDate} AND hd.thoiGianThanhToan < {endDate}
                    GROUP BY cthd.idSanPham
                )
                SELECT ISNULL(SUM(spb.TongSoLuongBan * dl.SoLuongSuDung * gv.GiaVonTrungBinh), 0)
Â  Â  Â  Â  Â  Â  Â  Â  FROM SanPhamDaBan spb
                JOIN dbo.DinhLuong dl ON spb.idSanPham = dl.idSanPham
                JOIN GiaVonNguyenLieu gv ON dl.idNguyenLieu = gv.idNguyenLieu;
            ").ToListAsync(); // Lá»—i CS1503 Ä‘Ã£ Ä‘Æ°á»£c sá»­a

            decimal tongGiaVon_COGS = cogsResult.FirstOrDefault();

            // 3. TÃNH CHI PHÃ Váº¬N HÃ€NH (OPEX) (Code nÃ y Ä‘Ã£ Ä‘Ãºng)
            var opexResult = (await _context.Database.SqlQuery<OpexDto>($@"
                    SELECT 
                    ISNULL((SELECT SUM(thucLanh) 
                        FROM dbo.PhieuLuong
                        WHERE trangThai = N'ÄÃ£ thanh toÃ¡n'
                        AND ngayTao >= {startDate} AND ngayTao < {endDate}
                    ), 0) AS TongChiPhiLuong,
                    
                    ISNULL((SELECT SUM(TongGiaTriHuy) 
                        FROM dbo.PhieuXuatHuy
                        WHERE NgayXuatHuy >= {startDate} AND NgayXuatHuy < {endDate}
                    ), 0) AS TongChiPhiHuyHang;
                ").ToListAsync()).FirstOrDefault() ?? new OpexDto();

            // 4. TOP Sáº¢N PHáº¨M (Code nÃ y Ä‘Ã£ Ä‘Ãºng)
            var topSanPham = await _context.Database.SqlQuery<TopSanPhamDto>($@"
                    SELECT TOP 10
                        sp.tenSanPham,
                        SUM(cthd.soLuong) AS TongSoLuongBan,
                        SUM(cthd.thanhTien) AS TongDoanhThu
                    FROM dbo.ChiTietHoaDon cthd
                    JOIN dbo.SanPham sp ON cthd.idSanPham = sp.idSanPham
                    JOIN dbo.HoaDon hd ON cthd.idHoaDon = hd.idHoaDon
                    WHERE hd.trangThai = N'ÄÃ£ thanh toÃ¡n'
                    AND hd.thoiGianThanhToan >= {startDate} AND hd.thoiGianThanhToan < {endDate}
                    GROUP BY sp.tenSanPham
                    ORDER BY TongSoLuongBan DESC;
                ").ToListAsync();

            // 5. Tá»”NG Há»¢P Káº¾T QUáº¢ (Code nÃ y Ä‘Ã£ Ä‘Ãºng)
            var dto = new BaoCaoTongHopDto
            {
                ChiTietDoanhThu = chiTietDoanhThu,
                ChiTietChiPhi = new BaoCaoChiPhiDto
                {
                    TongGiaVon_COGS = tongGiaVon_COGS,
                    TongChiPhiLuong = opexResult.TongChiPhiLuong,
                    TongChiPhiHuyHang = opexResult.TongChiPhiHuyHang
                },
                TopSanPham = topSanPham,
                Kpi = new BaoCaoKpiDto() // TÃ­nh toÃ¡n KPI
            };

            // TÃ­nh toÃ¡n KPI cuá»‘i cÃ¹ng
            dto.Kpi.DoanhThuRong = dto.ChiTietDoanhThu.DoanhThuRong;
            dto.Kpi.TongGiaVon = dto.ChiTietChiPhi.TongGiaVon_COGS;
            dto.Kpi.LoiNhuanGop = dto.Kpi.DoanhThuRong - dto.Kpi.TongGiaVon;
            dto.Kpi.ChiPhiOpex = dto.ChiTietChiPhi.TongChiPhiLuong + dto.ChiTietChiPhi.TongChiPhiHuyHang;
            dto.Kpi.LoiNhuanRong = dto.Kpi.LoiNhuanGop - dto.Kpi.ChiPhiOpex;

            return Ok(dto);
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\BaoCaoHieuSuatController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Data.SqlClient;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;
using System;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/baocaohieusuat")]
    [ApiController]
    public class BaoCaoHieuSuatController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public BaoCaoHieuSuatController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API Ä‘á»ƒ láº¥y dá»¯ liá»‡u cho ComboBox Vai TrÃ²
        /// </summary>
        [HttpGet("filters")]
        public async Task<IActionResult> GetFilterData()
        {
            var vaiTros = await _context.VaiTros
                .Select(t => new FilterLookupDto { Id = t.IdVaiTro, Ten = t.TenVaiTro })
                .OrderBy(t => t.Ten)
                .ToListAsync();

            return Ok(new { vaiTros });
        }

        /// <summary>
        /// API táº¡o bÃ¡o cÃ¡o chÃ­nh
        /// </summary>
        [HttpPost("report")]
        public async Task<IActionResult> GetHieuSuatReport([FromBody] BaoCaoHieuSuatRequestDto request)
        {
            var startDate = request.StartDate.Date;
            var endDate = request.EndDate.Date.AddDays(1);

            // Tham sá»‘ hÃ³a
            object pSearchTextValue = string.IsNullOrEmpty(request.SearchText) ? DBNull.Value : $"%{request.SearchText}%";
            var pStartDate = new SqlParameter("@StartDate", startDate);
            var pEndDate = new SqlParameter("@EndDate", endDate);
            var pVaiTroId = new SqlParameter("@VaiTroId", (object)request.VaiTroId ?? DBNull.Value);
            var pSearchText = new SqlParameter("@SearchText", string.IsNullOrEmpty(request.SearchText) ? (object)DBNull.Value : $"%{request.SearchText}%");

            // 1. TÃNH KPIs
            var kpi = (await _context.Database.SqlQuery<BaoCaoHieuSuatKpiDto>($@"
                SELECT
                    ISNULL(SUM(hd.thanhTien), 0) AS TongDoanhThu,
                    ISNULL(SUM(bc.soGioLam), 0) AS TongGioLam,
                    ISNULL(COUNT(bc.idChamCong), 0) AS TongSoCaLam,
                    ISNULL(COUNT(nkhm.idNhatKy), 0) AS TongLanHuyMon
                FROM dbo.NhanVien nv
                LEFT JOIN dbo.HoaDon hd ON nv.idNhanVien = hd.idNhanVien 
                    AND hd.trangThai = N'ÄÃ£ thanh toÃ¡n' AND hd.thoiGianThanhToan >= {pStartDate} AND hd.thoiGianThanhToan < {pEndDate}
                LEFT JOIN dbo.LichLamViec llv ON nv.idNhanVien = llv.idNhanVien 
                    AND llv.ngayLam >= {pStartDate} AND llv.ngayLam < {pEndDate}
                LEFT JOIN dbo.BangChamCong bc ON llv.idLichLamViec = bc.idLichLamViec
                LEFT JOIN dbo.NhatKyHuyMon nkhm ON nv.idNhanVien = nkhm.idNhanVienHuy 
                    AND nkhm.ThoiGianHuy >= {pStartDate} AND nkhm.ThoiGianHuy < {pEndDate}
                WHERE (nv.hoTen LIKE {pSearchText} OR {pSearchText} IS NULL)
                  AND (nv.idVaiTro = {pVaiTroId} OR {pVaiTroId} IS NULL);
            ").ToListAsync()).FirstOrDefault() ?? new BaoCaoHieuSuatKpiDto();
            
            // 2. TAB 1: HIá»†U SUáº¤T BÃN HÃ€NG
            var salesPerformance = await _context.Database.SqlQuery<BaoCaoSalesDto>($@"
                SELECT
                    nv.hoTen,
                    vt.tenVaiTro,
                    ISNULL(SUM(hd.thanhTien), 0) AS TongDoanhThu,
                    ISNULL(COUNT(DISTINCT hd.idHoaDon), 0) AS SoHoaDon,
                    ISNULL(AVG(hd.thanhTien), 0) AS DoanhThuTrungBinh,
                    (SELECT COUNT(nkhm.idNhatKy) 
                     FROM dbo.NhatKyHuyMon nkhm 
                     WHERE nkhm.idNhanVienHuy = nv.idNhanVien 
                     AND nkhm.ThoiGianHuy >= {pStartDate} AND nkhm.ThoiGianHuy < {pEndDate}) AS SoLanHuyMon
                FROM dbo.NhanVien nv
                JOIN dbo.VaiTro vt ON nv.idVaiTro = vt.idVaiTro
                LEFT JOIN dbo.HoaDon hd ON nv.idNhanVien = hd.idNhanVien 
                    AND hd.trangThai = N'ÄÃ£ thanh toÃ¡n' 
                    AND hd.thoiGianThanhToan >= {pStartDate} AND hd.thoiGianThanhToan < {pEndDate}
                WHERE
                    (vt.tenVaiTro IN (N'Thu ngÃ¢n', N'Phá»¥c vá»¥', N'Quáº£n lÃ½', N'Quáº£n trá»‹ viÃªn'))
                    AND (nv.hoTen LIKE {pSearchText} OR {pSearchText} IS NULL)
                    AND (nv.idVaiTro = {pVaiTroId} OR {pVaiTroId} IS NULL)
                GROUP BY nv.idNhanVien, nv.hoTen, vt.tenVaiTro
                ORDER BY TongDoanhThu DESC;
            ").ToListAsync();
            
            // 3. TAB 2: HIá»†U SUáº¤T Váº¬N HÃ€NH
            var operationalPerformance = await _context.Database.SqlQuery<BaoCaoOperationsDto>($@"
                SELECT
                    nv.hoTen,
                    vt.tenVaiTro,
                    (SELECT COUNT(idPhieuNhapKho) FROM PhieuNhapKho WHERE idNhanVien = nv.idNhanVien AND ngayNhap >= {pStartDate} AND ngayNhap < {pEndDate}) AS PhieuNhap,
                    (SELECT COUNT(idPhieuKiemKho) FROM PhieuKiemKho WHERE idNhanVienKiem = nv.idNhanVien AND NgayKiem >= {pStartDate} AND NgayKiem < {pEndDate}) AS PhieuKiem,
                    (SELECT COUNT(idPhieuXuatHuy) FROM PhieuXuatHuy WHERE idNhanVienXuat = nv.idNhanVien AND NgayXuatHuy >= {pStartDate} AND NgayXuatHuy < {pEndDate}) AS PhieuHuy,
                    (SELECT COUNT(idDonXinNghi) FROM DonXinNghi WHERE idNguoiDuyet = nv.idNhanVien AND NgayDuyet >= {pStartDate} AND NgayDuyet < {pEndDate}) AS DonDuyet
                FROM dbo.NhanVien nv
                JOIN dbo.VaiTro vt ON nv.idVaiTro = vt.idVaiTro
                WHERE
                    (vt.tenVaiTro IN (N'Quáº£n lÃ½', N'Quáº£n trá»‹ viÃªn', N'Pha cháº¿'))
                    AND (nv.hoTen LIKE {pSearchText} OR {pSearchText} IS NULL)
                    AND (nv.idVaiTro = {pVaiTroId} OR {pVaiTroId} IS NULL)
                GROUP BY nv.idNhanVien, nv.hoTen, vt.tenVaiTro;
            ").ToListAsync();

            // 4. TAB 3: CHUYÃŠN Cáº¦N
            var attendance = await _context.Database.SqlQuery<BaoCaoAttendanceDto>($@"
                SELECT
                    nv.hoTen,
                    ISNULL(COUNT(llv.idLichLamViec), 0) AS TongSoCaLam,
                    ISNULL(SUM(bc.soGioLam), 0) AS TongGioLam,
                    (SELECT COUNT(idDonXinNghi) FROM DonXinNghi WHERE idNhanVien = nv.idNhanVien AND NgayBatDau >= {pStartDate} AND NgayKetThuc < {pEndDate}) AS SoDonXinNghi,
                    (SELECT COUNT(idDonXinNghi) FROM DonXinNghi WHERE idNhanVien = nv.idNhanVien AND TrangThai = N'ÄÃ£ duyá»‡t' AND NgayBatDau >= {pStartDate} AND NgayKetThuc < {pEndDate}) AS SoDonDaDuyet,
                    (SELECT COUNT(idDonXinNghi) FROM DonXinNghi WHERE idNhanVien = nv.idNhanVien AND TrangThai = N'Chá» duyá»‡t' AND NgayBatDau >= {pStartDate} AND NgayKetThuc < {pEndDate}) AS SoDonChoDuyet
                FROM dbo.NhanVien nv
                LEFT JOIN dbo.LichLamViec llv ON nv.idNhanVien = llv.idNhanVien
                    AND llv.ngayLam >= {pStartDate} AND llv.ngayLam < {pEndDate}
                LEFT JOIN dbo.BangChamCong bc ON llv.idLichLamViec = bc.idLichLamViec
                WHERE (nv.hoTen LIKE {pSearchText} OR {pSearchText} IS NULL)
                  AND (nv.idVaiTro = {pVaiTroId} OR {pVaiTroId} IS NULL)
                GROUP BY nv.idNhanVien, nv.hoTen;
            ").ToListAsync();

            // 5. Tá»”NG Há»¢P Káº¾T QUáº¢
            var dto = new BaoCaoHieuSuatTongHopDto
            {
                Kpi = kpi,
                SalesPerformance = salesPerformance,
                OperationalPerformance = operationalPerformance,
                Attendance = attendance
            };

            return Ok(dto);
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\BaoCaoNhanSuController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/baocaonhansu")]
    [ApiController]
    public class BaoCaoNhanSuController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public BaoCaoNhanSuController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API Láº¥y cÃ¡c bá»™ lá»c (NhÃ¢n viÃªn, Vai trÃ²)
        /// </summary>
        [HttpGet("filters")]
        public async Task<IActionResult> GetFilters()
        {
            var dto = new BaoCaoNhanSu_FiltersDto
            {
                // Láº¥y táº¥t cáº£ NV (cáº£ nghá»‰ viá»‡c)
                NhanViens = await _context.NhanViens
                    .OrderBy(nv => nv.HoTen)
                    .Select(nv => new NhanVienLookupDto { IdNhanVien = nv.IdNhanVien, HoTen = nv.HoTen })
                    .ToListAsync(),

                VaiTros = await _context.VaiTros
                    .OrderBy(v => v.TenVaiTro)
                    .Select(v => new FilterLookupDto { Id = v.IdVaiTro, Ten = v.TenVaiTro })
                    .ToListAsync()
            };
            return Ok(dto);
        }

        /// <summary>
        /// API Táº¡o BÃ¡o CÃ¡o Tá»•ng Há»£p (ÄÃ£ sá»­a lá»—i LINQ)
        /// </summary>
        [HttpPost("report")]
        public async Task<IActionResult> GetHrReport([FromBody] BaoCaoNhanSuRequestDto filters)
        {
            var report = new BaoCaoNhanSuDto();

            // 1. Lá»c danh sÃ¡ch nhÃ¢n viÃªn cÆ¡ sá»Ÿ (base query)
            var nhanVienQuery = _context.NhanViens
                .Include(nv => nv.VaiTro)
                .AsQueryable();

            if (filters.IdNhanVien > 0)
                nhanVienQuery = nhanVienQuery.Where(nv => nv.IdNhanVien == filters.IdNhanVien);
            if (filters.IdVaiTro > 0)
                nhanVienQuery = nhanVienQuery.Where(nv => nv.IdVaiTro == filters.IdVaiTro);
            if (filters.TrangThaiNhanVien != "Táº¥t cáº£")
                nhanVienQuery = nhanVienQuery.Where(nv => nv.TrangThaiLamViec == filters.TrangThaiNhanVien);

            var nhanVienIds = await nhanVienQuery.Select(nv => nv.IdNhanVien).ToListAsync();
            report.Kpi.SoLuongNhanVien = nhanVienIds.Count;

            // Láº¥y danh sÃ¡ch nhÃ¢n viÃªn (Ä‘Ã£ lá»c) Ä‘á»ƒ join á»Ÿ client
            var nhanVienDaLoc = await nhanVienQuery.ToDictionaryAsync(nv => nv.IdNhanVien);

            // 2. Láº¥y dá»¯ liá»‡u Phiáº¿u LÆ°Æ¡ng (Tab 1, Chart, vÃ  KPI LÆ°Æ¡ng/Giá»)
            var phieuLuongQuery = _context.PhieuLuongs
                .Where(p => nhanVienIds.Contains(p.IdNhanVien) &&
                            p.NgayTao >= filters.StartDate &&
                            p.NgayTao <= filters.EndDate);

            report.Kpi.TongLuongDaTra = await phieuLuongQuery.SumAsync(p => p.ThucLanh);
            report.Kpi.TongGioLam = await phieuLuongQuery.SumAsync(p => p.TongGioLam); // Sá»­a: Gá»¡ (decimal)

            // DÃ¹ng ToList() Ä‘á»ƒ thá»±c thi truy váº¥n SQL
            var bangLuongData = await phieuLuongQuery
                .GroupBy(p => p.IdNhanVien) // Group theo ID
                .Select(g => new
                {
                    IdNhanVien = g.Key,
                    TongGioLam = g.Sum(p => p.TongGioLam),
                    TongLuongCoBan = g.Sum(p => p.LuongCoBan * p.TongGioLam), // TÃ­nh tá»•ng trÆ°á»›c

                    // === Sá»¬A Lá»–I CS0266 Táº I ÄÃ‚Y ===
                    TongThuong = g.Sum(p => p.TienThuong) ?? 0m,
                    TongPhat = g.Sum(p => p.KhauTru) ?? 0m,
                    // === Káº¾T THÃšC Sá»¬A Lá»–I ===

                    ThucLanh = g.Sum(p => p.ThucLanh)
                })
                .ToListAsync(); // <-- THá»°C THI TRUY Váº¤N Táº I ÄÃ‚Y

            // Join á»Ÿ client-side
            report.BangLuongChiTiet = bangLuongData
                .Where(bl => nhanVienDaLoc.ContainsKey(bl.IdNhanVien)) // Äáº£m báº£o nhÃ¢n viÃªn váº«n cÃ²n trong bá»™ lá»c
                .Select(bl => new BaoCaoNhanSu_BangLuongDto
                {
                    IdNhanVien = bl.IdNhanVien,
                    HoTenNhanVien = nhanVienDaLoc[bl.IdNhanVien].HoTen,
                    TenVaiTro = nhanVienDaLoc[bl.IdNhanVien].VaiTro.TenVaiTro,
                    TongGioLam = bl.TongGioLam,
                    TongLuongCoBan = bl.TongLuongCoBan,
                    TongThuong = bl.TongThuong, // ÄÃ£ lÃ  decimal (khÃ´ng pháº£i decimal?)
                    TongPhat = bl.TongPhat,   // ÄÃ£ lÃ  decimal (khÃ´ng pháº£i decimal?)
                    ThucLanh = bl.ThucLanh
                })
                .OrderByDescending(x => x.ThucLanh)
                .ToList();


            // 3. Láº¥y dá»¯ liá»‡u Nghá»‰ PhÃ©p (Tab 2 vÃ  KPI Nghá»‰)
            var donNghiQuery = _context.DonXinNghis
                .Where(d => nhanVienIds.Contains(d.IdNhanVien) &&
                            d.TrangThai == "ÄÃ£ duyá»‡t" &&
                            d.NgayBatDau >= filters.StartDate &&
                            d.NgayKetThuc <= filters.EndDate);

            // BÆ°á»›c 1: Táº£i dá»¯ liá»‡u thÃ´ vá» RAM
            var donNghiData = await donNghiQuery
                .Select(d => new
                {
                    d.IdNhanVien,
                    d.NgayBatDau,
                    d.NgayKetThuc
                })
                .ToListAsync(); // <-- THá»°C THI TRUY Váº¤N

            // BÆ°á»›c 2: Group vÃ  TÃ­nh toÃ¡n á»Ÿ client-side (trong RAM)
            var nghiPhepData = donNghiData
                .GroupBy(d => d.IdNhanVien)
                .Select(g => new
                {
                    IdNhanVien = g.Key,
                    SoDonDaDuyet = g.Count(),
                    // TÃ­nh tá»•ng sá»‘ ngÃ y nghá»‰ (giá» Ä‘Ã£ á»Ÿ client-side)
                    TongSoNgayNghi = g.Sum(d => (d.NgayKetThuc.Date - d.NgayBatDau.Date).Days + 1)
                })
                .ToList();

            // BÆ°á»›c 3: Join vá»›i thÃ´ng tin nhÃ¢n viÃªn
            report.ThongKeNghiPhep = nghiPhepData
                .Where(np => nhanVienDaLoc.ContainsKey(np.IdNhanVien)) // Äáº£m báº£o nhÃ¢n viÃªn váº«n cÃ²n trong bá»™ lá»c
                .Select(x => new BaoCaoNhanSu_NghiPhepDto
                {
                    IdNhanVien = x.IdNhanVien,
                    HoTenNhanVien = nhanVienDaLoc[x.IdNhanVien].HoTen,
                    TenVaiTro = nhanVienDaLoc[x.IdNhanVien].VaiTro.TenVaiTro,
                    SoDonDaDuyet = x.SoDonDaDuyet,
                    TongSoNgayNghi = x.TongSoNgayNghi
                })
                .OrderByDescending(x => x.TongSoNgayNghi)
                .ToList();

            report.Kpi.TongSoNgayNghi = report.ThongKeNghiPhep.Sum(x => x.TongSoNgayNghi);

            // 4. Láº¥y dá»¯ liá»‡u Biá»ƒu Ä‘á»“ (Tá»•ng lÆ°Æ¡ng tráº£ theo ngÃ y)
            report.LuongChartData = await phieuLuongQuery
                .GroupBy(p => p.NgayTao.Date)
                .Select(g => new ChartDataPoint
                {
                    Ngay = g.Key,
                    TongTien = g.Sum(p => p.ThucLanh)
                })
                .OrderBy(c => c.Ngay)
                .ToListAsync();

            return Ok(report);
        }
    }

    // (LÆ°u Ã½: Báº¡n khÃ´ng cáº§n class DbFunctions á»Ÿ Ä‘Ã¢y vÃ¬ chÃºng ta Ä‘Ã£ chuyá»ƒn
    // logic tÃ­nh toÃ¡n ra ngoÃ i SQL (sau khi ToListAsync))
    // Báº¡n cÃ³ thá»ƒ xÃ³a class DbFunctions náº¿u nÃ³ chá»‰ dÃ¹ng cho viá»‡c nÃ y.

    // (Náº¿u báº¡n váº«n dÃ¹ng DbFunctions á»Ÿ nÆ¡i khÃ¡c, hÃ£y giá»¯ nÃ³ láº¡i)
    public static class DbFunctions
    {
        [DbFunction(Name = "DATEDIFF", IsBuiltIn = true)]
        public static int DateDiffDay(DateTime startDate, DateTime endDate)
        {
            throw new NotSupportedException();
        }
    }
}

e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\BaoCaoSachController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Data.SqlClient;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;
using System; // ThÃªm

namespace CafebookApi.Controllers.App
{
    [Route("api/app/baocaosach")]
    [ApiController]
    public class BaoCaoSachController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public BaoCaoSachController(CafebookDbContext context)
        {
            _context = context;
        }

        [HttpGet("filters")]
        public async Task<IActionResult> GetFilterData()
        {
            var theLoais = await _context.TheLoais
                .Select(t => new FilterLookupDto { Id = t.IdTheLoai, Ten = t.TenTheLoai })
                .OrderBy(t => t.Ten)
                .ToListAsync();

            var tacGias = await _context.TacGias
                .Select(t => new FilterLookupDto { Id = t.IdTacGia, Ten = t.TenTacGia })
                .OrderBy(t => t.Ten)
                .ToListAsync();

            return Ok(new { theLoais, tacGias });
        }

        [HttpPost("report")]
        public async Task<IActionResult> GetSachReport([FromBody] BaoCaoSachRequestDto request)
        {
            // --- Sá»¬A Lá»–I CS8600 Táº I ÄÃ‚Y ---
            // Khá»Ÿi táº¡o an toÃ n hÆ¡n
            var pSearchText = new SqlParameter("@SearchText", (object)DBNull.Value);
            if (!string.IsNullOrEmpty(request.SearchText))
            {
                pSearchText.Value = $"%{request.SearchText}%";
            }

            var pTheLoaiId = new SqlParameter("@TheLoaiId", (object)request.TheLoaiId ?? DBNull.Value);
            var pTacGiaId = new SqlParameter("@TacGiaId", (object)request.TacGiaId ?? DBNull.Value);
            // --- Káº¾T THÃšC Sá»¬A Lá»–I ---

            // 1. TÃNH KPIs (Code nÃ y OK)
            var kpi = (await _context.Database.SqlQuery<BaoCaoSachKpiDto>($@"
                SELECT
                    ISNULL(COUNT(DISTINCT idSach), 0) AS TongDauSach,
                    ISNULL(SUM(soLuongTong), 0) AS TongSoLuong,
                    (SELECT ISNULL(COUNT(idSach), 0) FROM dbo.ChiTietPhieuThue WHERE ngayTraThucTe IS NULL) AS DangChoThue,
                    (ISNULL(SUM(soLuongTong), 0) - (SELECT ISNULL(COUNT(idSach), 0) FROM dbo.ChiTietPhieuThue WHERE ngayTraThucTe IS NULL)) AS SanSang
                FROM dbo.Sach;
            ").ToListAsync()).FirstOrDefault() ?? new BaoCaoSachKpiDto();

            // 2. TAB 1: Tá»’N KHO CHI TIáº¾T
            var chiTietTonKho = await _context.Database.SqlQuery<BaoCaoSachChiTietDto>($@"
                WITH SachDangThue AS (
                    SELECT idSach, COUNT(idSach) AS SoLuongDangMuon
                    FROM dbo.ChiTietPhieuThue
                    WHERE ngayTraThucTe IS NULL
                    GROUP BY idSach
                )
                SELECT
                    s.tenSach,
                    tg.tenTacGia,
                    tl.tenTheLoai,
                    s.soLuongTong,
                    ISNULL(sdt.SoLuongDangMuon, 0) AS SoLuongDangMuon,
                    (s.soLuongTong - ISNULL(sdt.SoLuongDangMuon, 0)) AS SoLuongConLai
                FROM dbo.Sach s
                LEFT JOIN dbo.TheLoai tl ON s.idTheLoai = tl.idTheLoai
                LEFT JOIN dbo.TacGia tg ON s.idTacGia = tg.idTacGia
                LEFT JOIN SachDangThue sdt ON s.idSach = sdt.idSach
                WHERE
                    (s.tenSach LIKE {pSearchText} OR {pSearchText} IS NULL)
                    AND (s.idTheLoai = {pTheLoaiId} OR {pTheLoaiId} IS NULL)
                    AND (s.idTacGia = {pTacGiaId} OR {pTacGiaId} IS NULL)
                ORDER BY SoLuongConLai ASC, s.tenSach;
            ").ToListAsync();

            // 3. TAB 2: SÃCH TRá»„ Háº N (Code nÃ y OK)
            var sachTreHan = await _context.Database.SqlQuery<BaoCaoSachTreHanDto>($@"
                SELECT
                    s.tenSach,
                    kh.hoTen,
                    kh.soDienThoai,
                    pts.ngayThue,
                    ctpt.ngayHenTra,
                    CASE
                        WHEN ctpt.ngayHenTra < GETDATE() 
                        THEN N'Trá»… ' + CAST(DATEDIFF(DAY, ctpt.ngayHenTra, GETDATE()) AS NVARCHAR) + N' ngÃ y'
                        ELSE N'Äang thuÃª'
                    END AS TinhTrang
                FROM dbo.ChiTietPhieuThue ctpt
                JOIN dbo.PhieuThueSach pts ON ctpt.idPhieuThueSach = pts.idPhieuThueSach
                JOIN dbo.Sach s ON ctpt.idSach = s.idSach
                JOIN dbo.KhachHang kh ON pts.idKhachHang = kh.idKhachHang
                WHERE ctpt.ngayTraThucTe IS NULL
                ORDER BY ctpt.ngayHenTra ASC;
            ").ToListAsync();

            // 4. TAB 3: TOP SÃCH THUÃŠ (Code nÃ y OK)
            var topSachThue = await _context.Database.SqlQuery<TopSachDuocThueDto>($@"
                SELECT TOP 10
                    s.tenSach,
                    tg.tenTacGia,
                    COUNT(ctpt.idSach) AS TongLuotThue
                FROM dbo.ChiTietPhieuThue ctpt
                JOIN dbo.Sach s ON ctpt.idSach = s.idSach
                LEFT JOIN dbo.TacGia tg ON s.idTacGia = tg.idTacGia
                GROUP BY s.tenSach, tg.tenTacGia
                ORDER BY TongLuotThue DESC;
            ").ToListAsync();

            // 5. Tá»”NG Há»¢P Káº¾T QUáº¢ (Code nÃ y OK)
            var dto = new BaoCaoSachTongHopDto
            {
                Kpi = kpi,
                ChiTietTonKho = chiTietTonKho,
                SachTreHan = sachTreHan,
                TopSachThue = topSachThue
            };

            return Ok(dto);
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\BaoCaoTonKhoController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Data.SqlClient;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;
using System;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/baocaokho")]
    [ApiController]
    public class BaoCaoTonKhoController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public BaoCaoTonKhoController(CafebookDbContext context)
        {
            _context = context;
        }

        [HttpGet("filters")]
        public async Task<IActionResult> GetFilterData()
        {
            var nhaCungCaps = await _context.NhaCungCaps
                .Select(t => new FilterLookupDto { Id = t.IdNhaCungCap, Ten = t.TenNhaCungCap })
                .OrderBy(t => t.Ten)
                .ToListAsync();

            return Ok(new { nhaCungCaps });
        }

        [HttpPost("report")]
        public async Task<IActionResult> GetKhoReport([FromBody] BaoCaoTonKhoRequestDto request)
        {
            // --- 1. TÃNH KPIs ---

            // KPI a: Tá»•ng giÃ¡ trá»‹ tá»“n kho (ÄÃƒ XÃ“A CÃC THáºº [cite] GÃ‚Y Lá»–I)
            var kpiGiaTriKho = await _context.Database.SqlQuery<decimal>($@"
                WITH GiaVonNguyenLieu AS (
                    SELECT idNguyenLieu, AVG(donGiaNhap) AS GiaVonTrungBinh
                    FROM dbo.ChiTietNhapKho
                    GROUP BY idNguyenLieu
                )
                SELECT ISNULL(SUM(nl.tonKho * ISNULL(gv.GiaVonTrungBinh, 0)), 0)
                FROM dbo.NguyenLieu nl
                LEFT JOIN GiaVonNguyenLieu gv ON nl.idNguyenLieu = gv.idNguyenLieu;
            ").ToListAsync();

            // KPI b: Sá»‘ lÆ°á»£ng SP sáº¯p háº¿t
            var kpiSapHet = await _context.Database.SqlQuery<int>($@"
                SELECT ISNULL(COUNT(idNguyenLieu), 0) FROM NguyenLieu WHERE tonKho <= TonKhoToiThieu;
            ").ToListAsync();

            // KPI c: Tá»•ng giÃ¡ trá»‹ Ä‘Ã£ há»§y (trong ká»³, giáº£ sá»­ 30 ngÃ y)
            var kpiHuyHang = await _context.Database.SqlQuery<decimal>($@"
                SELECT ISNULL(SUM(TongGiaTriHuy), 0) FROM PhieuXuatHuy
                WHERE NgayXuatHuy >= DATEADD(day, -30, GETDATE());
            ").ToListAsync();

            var kpi = new BaoCaoTonKhoKpiDto
            {
                TongGiaTriTonKho = kpiGiaTriKho.FirstOrDefault(),
                SoLuongSPSapHet = kpiSapHet.FirstOrDefault(),
                TongGiaTriDaHuy = kpiHuyHang.FirstOrDefault()
            };

            // --- 2. TAB 1: Tá»’N KHO CHI TIáº¾T ---
            var pSearchText = new SqlParameter("@SearchText", string.IsNullOrEmpty(request.SearchText) ? (object)DBNull.Value : $"%{request.SearchText}%");
            var pShowLowStockOnly = new SqlParameter("@ShowLowStockOnly", request.ShowLowStockOnly);
            // (LÆ°u Ã½: Lá»c theo NCC bá»‹ bá» qua vÃ¬ logic phá»©c táº¡p, khÃ´ng cÃ³ trong thiáº¿t káº¿ SQL)

            var chiTietTonKho = await _context.Database.SqlQuery<BaoCaoTonKhoChiTietDto>($@"
                SELECT
                    tenNguyenLieu,
                    donViTinh,
                    tonKho,
                    TonKhoToiThieu,
                    CASE
                        WHEN tonKho = 0 THEN N'Háº¿t hÃ ng'
                        WHEN tonKho <= TonKhoToiThieu THEN N'Sáº¯p háº¿t'
                        ELSE N'Äá»§ dÃ¹ng'
                    END AS TinhTrang
                FROM dbo.NguyenLieu
                WHERE
                    (tenNguyenLieu LIKE {pSearchText} OR {pSearchText} IS NULL)
                    AND ({pShowLowStockOnly} = 0 OR tonKho <= TonKhoToiThieu)
                ORDER BY
                    tonKho ASC;
            ").ToListAsync();

            // --- 3. TAB 2: Lá»ŠCH Sá»¬ KIá»‚M KÃŠ ---
            var lichSuKiemKe = await _context.Database.SqlQuery<BaoCaoKiemKeDto>($@"
                SELECT
                    pkk.NgayKiem,
                    nl.tenNguyenLieu,
                    ctkk.TonKhoHeThong,
                    ctkk.TonKhoThucTe,
                    ctkk.ChenhLech,
                    ctkk.LyDoChenhLech
                FROM dbo.ChiTietKiemKho ctkk
                JOIN dbo.PhieuKiemKho pkk ON ctkk.idPhieuKiemKho = pkk.idPhieuKiemKho
                JOIN dbo.NguyenLieu nl ON ctkk.idNguyenLieu = nl.idNguyenLieu
                WHERE
                    ctkk.ChenhLech != 0
                ORDER BY
                    pkk.NgayKiem DESC;
            ").ToListAsync();

            // --- 4. TAB 3: Lá»ŠCH Sá»¬ Há»¦Y HÃ€NG ---
            var lichSuHuyHang = await _context.Database.SqlQuery<BaoCaoHuyHangDto>($@"
                SELECT
                    pxh.NgayXuatHuy AS NgayHuy,
                    nl.tenNguyenLieu,
                    ctxh.SoLuong AS SoLuongHuy,
                    ctxh.ThanhTien AS GiaTriHuy,
                    pxh.LyDoXuatHuy AS LyDoHuy
                FROM dbo.ChiTietXuatHuy ctxh
                JOIN dbo.PhieuXuatHuy pxh ON ctxh.idPhieuXuatHuy = pxh.idPhieuXuatHuy
                JOIN dbo.NguyenLieu nl ON ctxh.idNguyenLieu = nl.idNguyenLieu
                ORDER BY
                    pxh.NgayXuatHuy DESC;
            ").ToListAsync();

            // --- 5. Tá»”NG Há»¢P Káº¾T QUáº¢ ---
            var dto = new BaoCaoTonKhoTongHopDto
            {
                Kpi = kpi,
                ChiTietTonKho = chiTietTonKho,
                LichSuKiemKe = lichSuKiemKe,
                LichSuHuyHang = lichSuHuyHang
            };

            return Ok(dto);
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\CaiDatController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using CafebookModel.Model.Entities; // ThÃªm
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq; // Cáº§n thÃªm
using System.Threading.Tasks; // Cáº§n thÃªm

namespace CafebookApi.Controllers.App
{
    [Route("api/app/caidat")]
    [ApiController]
    public class CaiDatController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public CaiDatController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API Ä‘á»ƒ láº¥y táº¥t cáº£ cÃ i Ä‘áº·t
        /// </summary>
        [HttpGet("all")]
        public async Task<IActionResult> GetAllSettings()
        {
            var settings = await _context.CaiDats
                .Select(c => new CaiDatDto
                {
                    TenCaiDat = c.TenCaiDat,
                    GiaTri = c.GiaTri,
                    MoTa = c.MoTa
                })
                .ToListAsync();

            return Ok(settings);
        }

        /// <summary>
        /// API Ä‘á»ƒ cáº­p nháº­t Má»˜T cÃ i Ä‘áº·t (lÆ°u tá»«ng cÃ¡i má»™t)
        /// </summary>
        [HttpPut("update-single")]
        public async Task<IActionResult> UpdateSingleSetting([FromBody] CaiDatDto settingToSave)
        {
            if (settingToSave == null)
            {
                return BadRequest("Dá»¯ liá»‡u khÃ´ng há»£p lá»‡.");
            }

            try
            {
                var settingInDb = await _context.CaiDats.FindAsync(settingToSave.TenCaiDat);

                if (settingInDb != null)
                {
                    settingInDb.GiaTri = settingToSave.GiaTri; // Chá»‰ cáº­p nháº­t giÃ¡ trá»‹
                    await _context.SaveChangesAsync();
                    return Ok(new { message = "Cáº­p nháº­t thÃ nh cÃ´ng!" });
                }

                return NotFound("KhÃ´ng tÃ¬m tháº¥y cÃ i Ä‘áº·t.");
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Lá»—i mÃ¡y chá»§: {ex.Message}");
            }
        }

        /// <summary>
        /// API má»›i: Láº¥y thÃ´ng tin cÆ¡ báº£n cá»§a cá»­a hÃ ng
        /// </summary>
        [HttpGet("thong-tin-cua-hang")]
        public async Task<IActionResult> GetThongTinCuaHang()
        {
            var settings = await _context.CaiDats
                                    .Where(c => c.TenCaiDat == "TenQuan" ||
                                                c.TenCaiDat == "DiaChi" ||
                                                c.TenCaiDat == "SoDienThoai")
                                    .ToListAsync();

            var dto = new CaiDatThongTinCuaHangDto
            {
                TenQuan = settings.FirstOrDefault(c => c.TenCaiDat == "TenQuan")?.GiaTri ?? "Cafe SÃ¡ch",
                DiaChi = settings.FirstOrDefault(c => c.TenCaiDat == "DiaChi")?.GiaTri ?? "N/A",
                SoDienThoai = settings.FirstOrDefault(c => c.TenCaiDat == "SoDienThoai")?.GiaTri ?? "N/A"
            };

            return Ok(dto);
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\CaiDatNhanSuController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/caidatnhansu")]
    [ApiController]
    public class CaiDatNhanSuController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public CaiDatNhanSuController(CafebookDbContext context)
        {
            _context = context;
        }

        // HÃ m helper Ä‘á»ƒ Ä‘á»c CÃ i Ä‘áº·t an toÃ n
        private string GetSetting(List<CaiDat> settings, string key, string defaultValue)
        {
            return settings.FirstOrDefault(c => c.TenCaiDat == key)?.GiaTri ?? defaultValue;
        }

        /// <summary>
        /// API Láº¥y táº¥t cáº£ CÃ i Ä‘áº·t NhÃ¢n sá»±
        /// </summary>
        [HttpGet("all")]
        public async Task<IActionResult> GetAllHrSettings()
        {
            var allSettings = await _context.CaiDats
                .Where(c => c.TenCaiDat.StartsWith("HR_"))
                .ToListAsync();

            // DÃ¹ng CultureInfo.InvariantCulture Ä‘á»ƒ Ä‘áº£m báº£o dáº¥u cháº¥m (.) lÃ  dáº¥u tháº­p phÃ¢n
            var dto = new CaiDatNhanSuDto
            {
                GioLamChuan = decimal.Parse(GetSetting(allSettings, "HR_GioLamChuan", "8"), CultureInfo.InvariantCulture),
                HeSoOT = decimal.Parse(GetSetting(allSettings, "HR_HeSoOT", "1.5"), CultureInfo.InvariantCulture),
                PhatDiTre_Phut = int.Parse(GetSetting(allSettings, "HR_PhatDiTre_Phut", "5")),
                PhatDiTre_HeSo = decimal.Parse(GetSetting(allSettings, "HR_PhatDiTre_HeSo", "1.0"), CultureInfo.InvariantCulture),
                ChuyenCan_SoNgay = int.Parse(GetSetting(allSettings, "HR_ChuyenCan_SoNgay", "26")),
                ChuyenCan_TienThuong = decimal.Parse(GetSetting(allSettings, "HR_ChuyenCan_TienThuong", "0"), CultureInfo.InvariantCulture),
                PhepNam_MacDinh = int.Parse(GetSetting(allSettings, "HR_PhepNam_MacDinh", "12"))
            };

            return Ok(dto);
        }

        /// <summary>
        /// API Cáº­p nháº­t (LÆ°u) táº¥t cáº£ CÃ i Ä‘áº·t NhÃ¢n sá»±
        /// </summary>
        [HttpPut("update")]
        public async Task<IActionResult> UpdateHrSettings([FromBody] CaiDatNhanSuDto dto)
        {
            if (dto == null) return BadRequest("Dá»¯ liá»‡u khÃ´ng há»£p lá»‡.");

            // DÃ¹ng Transaction Ä‘á»ƒ Ä‘áº£m báº£o lÆ°u táº¥t cáº£ hoáº·c khÃ´ng lÆ°u gÃ¬ cáº£
            using (var transaction = await _context.Database.BeginTransactionAsync())
            {
                try
                {
                    // HÃ m helper Ä‘á»ƒ cáº­p nháº­t CÃ i Ä‘áº·t
                    async Task UpdateSetting(string key, string value)
                    {
                        var setting = await _context.CaiDats.FindAsync(key);
                        if (setting != null)
                        {
                            setting.GiaTri = value;
                        }
                        // Náº¿u khÃ´ng tÃ¬m tháº¥y (do SQL script chÆ°a cháº¡y), thÃ¬ táº¡o má»›i
                        else
                        {
                            _context.CaiDats.Add(new CaiDat { TenCaiDat = key, GiaTri = value, MoTa = "Auto-generated HR Setting" });
                        }
                    }

                    // DÃ¹ng CultureInfo.InvariantCulture Ä‘á»ƒ lÆ°u dáº¥u cháº¥m (.)
                    await UpdateSetting("HR_GioLamChuan", dto.GioLamChuan.ToString(CultureInfo.InvariantCulture));
                    await UpdateSetting("HR_HeSoOT", dto.HeSoOT.ToString(CultureInfo.InvariantCulture));
                    await UpdateSetting("HR_PhatDiTre_Phut", dto.PhatDiTre_Phut.ToString());
                    await UpdateSetting("HR_PhatDiTre_HeSo", dto.PhatDiTre_HeSo.ToString(CultureInfo.InvariantCulture));
                    await UpdateSetting("HR_ChuyenCan_SoNgay", dto.ChuyenCan_SoNgay.ToString());
                    await UpdateSetting("HR_ChuyenCan_TienThuong", dto.ChuyenCan_TienThuong.ToString(CultureInfo.InvariantCulture));
                    await UpdateSetting("HR_PhepNam_MacDinh", dto.PhepNam_MacDinh.ToString());

                    await _context.SaveChangesAsync();
                    await transaction.CommitAsync();

                    return Ok(new { message = "LÆ°u cÃ i Ä‘áº·t nhÃ¢n sá»± thÃ nh cÃ´ng!" });
                }
                catch (Exception ex)
                {
                    await transaction.RollbackAsync();
                    return StatusCode(500, $"Lá»—i khi lÆ°u cÃ i Ä‘áº·t: {ex.Message}");
                }
            }
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\CaLamViecController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/calamviec")]
    [ApiController]
    public class CaLamViecController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public CaLamViecController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API Láº¥y táº¥t cáº£ Ca LÃ m Viá»‡c (Máº«u)
        /// </summary>
        [HttpGet("all")]
        public async Task<IActionResult> GetAll()
        {
            var data = await _context.CaLamViecs
                .Select(c => new CaLamViecDto
                {
                    IdCa = c.IdCa,
                    TenCa = c.TenCa,
                    GioBatDau = c.GioBatDau,
                    GioKetThuc = c.GioKetThuc
                })
                .OrderBy(c => c.GioBatDau)
                .ToListAsync();
            return Ok(data);
        }

        /// <summary>
        /// API ThÃªm má»›i Ca Máº«u
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> Create([FromBody] CaLamViecDto dto)
        {
            var entity = new CaLamViec
            {
                TenCa = dto.TenCa,
                GioBatDau = dto.GioBatDau,
                GioKetThuc = dto.GioKetThuc
            };
            _context.CaLamViecs.Add(entity);
            await _context.SaveChangesAsync();
            return Ok(entity);
        }

        /// <summary>
        /// API Cáº­p nháº­t Ca Máº«u
        /// </summary>
        [HttpPut("{id}")]
        public async Task<IActionResult> Update(int id, [FromBody] CaLamViecDto dto)
        {
            var entity = await _context.CaLamViecs.FindAsync(id);
            if (entity == null) return NotFound();

            entity.TenCa = dto.TenCa;
            entity.GioBatDau = dto.GioBatDau;
            entity.GioKetThuc = dto.GioKetThuc;

            await _context.SaveChangesAsync();
            return Ok();
        }

        /// <summary>
        /// API XÃ³a Ca Máº«u
        /// </summary>
        [HttpDelete("{id}")]
        public async Task<IActionResult> Delete(int id)
        {
            // Kiá»ƒm tra rÃ ng buá»™c
            if (await _context.LichLamViecs.AnyAsync(l => l.IdCa == id))
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a. Ca lÃ m viá»‡c nÃ y Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng trong Lá»‹ch LÃ m Viá»‡c.");
            }

            var entity = await _context.CaLamViecs.FindAsync(id);
            if (entity == null) return NotFound();

            _context.CaLamViecs.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\DashboardController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/dashboard")]
    [ApiController]
    public class DashboardController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public DashboardController(CafebookDbContext context)
        {
            _context = context;
        }

        [HttpGet("summary")]
        public async Task<IActionResult> GetDashboardSummary()
        {
            var dto = new DashboardSummaryDto();

            DateTime today = DateTime.Today;
            DateTime tomorrow = today.AddDays(1);
            DateTime startDate30Days = today.AddDays(-29);

            // 1. Láº¥y cÃ¡c hÃ³a Ä‘Æ¡n Ä‘Ã£ thanh toÃ¡n hÃ´m nay
            var hoaDonsHomNay = _context.HoaDons
                .Where(h => h.ThoiGianThanhToan >= today &&
                            h.ThoiGianThanhToan < tomorrow &&
                            h.TrangThai == "ÄÃ£ thanh toÃ¡n");

            // 2. TÃ­nh KPI Tháº»
            dto.TongDoanhThuHomNay = await hoaDonsHomNay.SumAsync(h => h.ThanhTien);
            dto.TongDonHangHomNay = await hoaDonsHomNay.CountAsync();

            // 3. Láº¥y sáº£n pháº©m bÃ¡n cháº¡y hÃ´m nay
            var spBanChayQuery = await _context.ChiTietHoaDons
                .Where(ct => ct.HoaDon.ThoiGianThanhToan >= today && ct.HoaDon.ThoiGianThanhToan < tomorrow && ct.HoaDon.TrangThai == "ÄÃ£ thanh toÃ¡n")
                .GroupBy(ct => ct.IdSanPham)
                .Select(g => new {
                    Id = g.Key,
                    SoLuong = g.Sum(ct => ct.SoLuong)
                })
                .OrderByDescending(x => x.SoLuong)
                .FirstOrDefaultAsync();

            if (spBanChayQuery != null)
            {
                var sanPham = await _context.SanPhams.FindAsync(spBanChayQuery.Id);
                dto.SanPhamBanChayHomNay = sanPham?.TenSanPham ?? "KhÃ´ng rÃµ";
            }

            // 4. Láº¥y dá»¯ liá»‡u biá»ƒu Ä‘á»“ 30 ngÃ y
            var doanhThuQuery = await _context.HoaDons
                .Where(h => h.ThoiGianThanhToan >= startDate30Days && h.TrangThai == "ÄÃ£ thanh toÃ¡n")
                .GroupBy(h => h.ThoiGianThanhToan!.Value.Date) // Group by ngÃ y
                .Select(g => new ChartDataPoint
                {
                    Ngay = g.Key,
                    TongTien = g.Sum(h => h.ThanhTien)
                })
                .OrderBy(dp => dp.Ngay)
                .ToListAsync();

            // Äiá»n vÃ o cÃ¡c ngÃ y bá»‹ thiáº¿u (náº¿u khÃ´ng cÃ³ doanh thu)
            dto.DoanhThu30Ngay = Enumerable.Range(0, 30)
                .Select(i => startDate30Days.AddDays(i))
                .GroupJoin(doanhThuQuery, // Left join
                           ngay => ngay,
                           data => data.Ngay,
                           (ngay, data) => data.SingleOrDefault(new ChartDataPoint { Ngay = ngay, TongTien = 0 }))
                .ToList();

            return Ok(dto);
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\DonHangController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using CafebookModel.Model.Entities;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/donhang")]
    [ApiController]
    public class DonHangController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public DonHangController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API láº¥y dá»¯ liá»‡u cho cÃ¡c ComboBox lá»c
        /// </summary>
        [HttpGet("filters")]
        public async Task<IActionResult> GetDonHangFilters()
        {
            var dto = new DonHangFiltersDto
            {
                NhanViens = await _context.NhanViens
                    .Select(nv => new FilterLookupDto { Id = nv.IdNhanVien, Ten = nv.HoTen })
                    .OrderBy(nv => nv.Ten)
                    .ToListAsync(),
                KhachHangs = await _context.KhachHangs
                    .Select(kh => new FilterLookupDto { Id = kh.IdKhachHang, Ten = kh.HoTen })
                    .OrderBy(kh => kh.Ten)
                    .ToListAsync()
            };
            return Ok(dto);
        }

        /// <summary>
        /// API Láº¥y danh sÃ¡ch ÄÆ¡n hÃ ng (cÃ³ lá»c)
        /// </summary>
        [HttpGet("search")]
        public async Task<IActionResult> SearchDonHang(
            [FromQuery] DateTime startDate,
            [FromQuery] DateTime endDate,
            [FromQuery] string? trangThai,
            [FromQuery] int? nhanVienId,
            [FromQuery] string? searchText)
        {
            var query = _context.HoaDons
                .Include(h => h.NhanVien)
                .Include(h => h.KhachHang)
                .Include(h => h.Ban)
                .Where(h => h.ThoiGianTao >= startDate && h.ThoiGianTao < endDate.AddDays(1))
                .AsQueryable();

            if (!string.IsNullOrEmpty(trangThai) && trangThai != "Táº¥t cáº£")
            {
                query = query.Where(h => h.TrangThai == trangThai);
            }

            if (nhanVienId.HasValue && nhanVienId > 0)
            {
                query = query.Where(h => h.IdNhanVien == nhanVienId);
            }

            if (!string.IsNullOrEmpty(searchText))
            {
                string searchLower = searchText.ToLower();
                query = query.Where(h =>
                    h.IdHoaDon.ToString().Contains(searchLower) ||
                    (h.KhachHang != null && h.KhachHang.HoTen.ToLower().Contains(searchLower)) ||
                    (h.KhachHang != null && h.KhachHang.SoDienThoai != null && h.KhachHang.SoDienThoai.Contains(searchLower))
                );
            }

            var results = await query
                .OrderByDescending(h => h.ThoiGianTao)
                .Select(h => new DonHangDto
                {
                    IdHoaDon = h.IdHoaDon,
                    ThoiGianTao = h.ThoiGianTao,
                    TenNhanVien = h.NhanVien.HoTen,
                    TenKhachHang = h.KhachHang != null ? h.KhachHang.HoTen : "KhÃ¡ch vÃ£ng lai",
                    SoBan = h.Ban != null ? h.Ban.SoBan : "Mang vá»/Giao",
                    ThanhTien = h.ThanhTien,
                    TrangThai = h.TrangThai,
                    LoaiHoaDon = h.LoaiHoaDon
                })
                .ToListAsync();

            return Ok(results);
        }

        /// <summary>
        /// API Láº¥y chi tiáº¿t má»™t ÄÆ¡n hÃ ng
        /// </summary>
        [HttpGet("details/{id}")]
        public async Task<IActionResult> GetDonHangDetails(int id)
        {
            var details = await _context.ChiTietHoaDons
                .Where(ct => ct.IdHoaDon == id)
                .Include(ct => ct.SanPham)
                .Select(ct => new DonHangChiTietDto
                {
                    TenSanPham = ct.SanPham.TenSanPham,
                    SoLuong = ct.SoLuong,
                    ThanhTien = ct.ThanhTien
                })
                .ToListAsync();

            return Ok(details);
        }

        /// <summary>
        /// API Cáº­p nháº­t tráº¡ng thÃ¡i (Há»§y, Giao hÃ ng)
        /// </summary>
        [HttpPut("update-status/{id}")]
        public async Task<IActionResult> UpdateOrderStatus(int id, [FromBody] string newStatus)
        {
            var hoaDon = await _context.HoaDons.FindAsync(id);
            if (hoaDon == null) return NotFound();

            if (hoaDon.TrangThai == "ÄÃ£ thanh toÃ¡n")
            {
                return Conflict("KhÃ´ng thá»ƒ cáº­p nháº­t tráº¡ng thÃ¡i cho hÃ³a Ä‘Æ¡n Ä‘Ã£ thanh toÃ¡n.");
            }

            // Cáº­p nháº­t tráº¡ng thÃ¡i chÃ­nh
            if (newStatus == "Há»§y")
            {
                hoaDon.TrangThai = "ÄÃ£ há»§y";
                // TODO: Logic hoÃ n kho (náº¿u cáº§n)
            }
            // Cáº­p nháº­t tráº¡ng thÃ¡i giao hÃ ng
            else if (newStatus == "Äang giao")
            {
                if (hoaDon.LoaiHoaDon != "Giao hÃ ng")
                {
                    return BadRequest("Chá»‰ cÃ³ thá»ƒ giao hÃ ng cho 'ÄÆ¡n Giao HÃ ng'.");
                }
                if (string.IsNullOrEmpty(hoaDon.DiaChiGiaoHang) || string.IsNullOrEmpty(hoaDon.SoDienThoaiGiaoHang))
                {
                    return BadRequest("KhÃ´ng thá»ƒ giao hÃ ng. Thiáº¿u Ä‘á»‹a chá»‰ hoáº·c SÄT.");
                }
                hoaDon.TrangThaiGiaoHang = "Äang giao";
            }
            else
            {
                return BadRequest("Tráº¡ng thÃ¡i má»›i khÃ´ng há»£p lá»‡.");
            }

            await _context.SaveChangesAsync();
            return Ok();
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\DonViChuyenDoiController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/donvichuyendoi")]
    [ApiController]
    public class DonViChuyenDoiController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public DonViChuyenDoiController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API Láº¥y táº¥t cáº£ ÄÆ¡n vá»‹ chuyá»ƒn Ä‘á»•i
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> GetAll()
        {
            var data = await _context.DonViChuyenDois
                .Include(d => d.NguyenLieu)
                .Select(d => new DonViChuyenDoiDtoo
                {
                    IdChuyenDoi = d.IdChuyenDoi,
                    IdNguyenLieu = d.IdNguyenLieu,
                    TenNguyenLieu = d.NguyenLieu.TenNguyenLieu,
                    TenDonVi = d.TenDonVi,
                    GiaTriQuyDoi = d.GiaTriQuyDoi,
                    LaDonViCoBan = d.LaDonViCoBan
                })
                .OrderBy(d => d.TenNguyenLieu)
                .ThenBy(d => d.LaDonViCoBan ? 0 : 1) // ÄÆ¡n vá»‹ cÆ¡ báº£n lÃªn Ä‘áº§u
                .ThenBy(d => d.TenDonVi)
                .ToListAsync();
            return Ok(data);
        }

        /// <summary>
        /// API ThÃªm má»›i ÄÆ¡n vá»‹ chuyá»ƒn Ä‘á»•i
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> Create([FromBody] DonViChuyenDoiUpdateRequestDto dto)
        {
            if (dto.IdNguyenLieu == 0) return BadRequest("Vui lÃ²ng chá»n nguyÃªn liá»‡u.");

            // Logic: Má»™t nguyÃªn liá»‡u chá»‰ cÃ³ 1 ÄVT CÆ¡ báº£n
            if (dto.LaDonViCoBan)
            {
                if (await _context.DonViChuyenDois.AnyAsync(d => d.IdNguyenLieu == dto.IdNguyenLieu && d.LaDonViCoBan))
                {
                    return Conflict("NguyÃªn liá»‡u nÃ y Ä‘Ã£ cÃ³ ÄÆ¡n vá»‹ cÆ¡ báº£n. KhÃ´ng thá»ƒ thÃªm.");
                }
                dto.GiaTriQuyDoi = 1; // ÄVT cÆ¡ báº£n luÃ´n cÃ³ há»‡ sá»‘ 1
            }

            var entity = new DonViChuyenDoi
            {
                IdNguyenLieu = dto.IdNguyenLieu,
                TenDonVi = dto.TenDonVi,
                GiaTriQuyDoi = dto.GiaTriQuyDoi,
                LaDonViCoBan = dto.LaDonViCoBan
            };
            _context.DonViChuyenDois.Add(entity);
            await _context.SaveChangesAsync();
            return Ok(entity);
        }

        /// <summary>
        /// API Cáº­p nháº­t ÄÆ¡n vá»‹ chuyá»ƒn Ä‘á»•i
        /// </summary>
        [HttpPut("{id}")]
        public async Task<IActionResult> Update(int id, [FromBody] DonViChuyenDoiUpdateRequestDto dto)
        {
            var entity = await _context.DonViChuyenDois.FindAsync(id);
            if (entity == null) return NotFound();

            if (dto.LaDonViCoBan)
            {
                if (await _context.DonViChuyenDois.AnyAsync(d => d.IdNguyenLieu == dto.IdNguyenLieu && d.LaDonViCoBan && d.IdChuyenDoi != id))
                {
                    return Conflict("NguyÃªn liá»‡u nÃ y Ä‘Ã£ cÃ³ ÄÆ¡n vá»‹ cÆ¡ báº£n. KhÃ´ng thá»ƒ cáº­p nháº­t.");
                }
                dto.GiaTriQuyDoi = 1;
            }

            entity.IdNguyenLieu = dto.IdNguyenLieu;
            entity.TenDonVi = dto.TenDonVi;
            entity.GiaTriQuyDoi = dto.GiaTriQuyDoi;
            entity.LaDonViCoBan = dto.LaDonViCoBan;

            await _context.SaveChangesAsync();
            return Ok();
        }

        /// <summary>
        /// API XÃ³a ÄÆ¡n vá»‹ chuyá»ƒn Ä‘á»•i
        /// </summary>
        [HttpDelete("{id}")]
        public async Task<IActionResult> Delete(int id)
        {
            if (await _context.DinhLuongs.AnyAsync(d => d.IdDonViSuDung == id))
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a. ÄÆ¡n vá»‹ nÃ y Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng trong Äá»‹nh lÆ°á»£ng sáº£n pháº©m.");
            }
            var entity = await _context.DonViChuyenDois.FindAsync(id);
            if (entity == null) return NotFound();

            _context.DonViChuyenDois.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\DonXinNghiController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/donxinnghi")]
    [ApiController]
    public class DonXinNghiController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public DonXinNghiController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API Láº¥y danh sÃ¡ch ÄÆ¡n Xin Nghá»‰ (cÃ³ lá»c/tÃ¬m kiáº¿m)
        /// </summary>
        [HttpGet("search")]
        public async Task<IActionResult> Search(
            [FromQuery] string? searchText,
            [FromQuery] string? trangThai)
        {
            var query = _context.DonXinNghis
                .Include(d => d.NhanVien)
                .Include(d => d.NguoiDuyet)
                .AsQueryable();

            if (!string.IsNullOrEmpty(trangThai) && trangThai != "Táº¥t cáº£")
            {
                query = query.Where(d => d.TrangThai == trangThai);
            }

            if (!string.IsNullOrEmpty(searchText))
            {
                string searchLower = searchText.ToLower();
                query = query.Where(d =>
                    d.NhanVien.HoTen.ToLower().Contains(searchLower) ||
                    d.LyDo.ToLower().Contains(searchLower)
                );
            }

            var results = await query
                .OrderByDescending(d => d.NgayBatDau)
                .Select(d => new DonXinNghiDto
                {
                    IdDonXinNghi = d.IdDonXinNghi,
                    TenNhanVien = d.NhanVien.HoTen,
                    LoaiDon = d.LoaiDon,
                    NgayBatDau = d.NgayBatDau,
                    NgayKetThuc = d.NgayKetThuc,
                    LyDo = d.LyDo,
                    TrangThai = d.TrangThai,
                    TenNguoiDuyet = d.NguoiDuyet != null ? d.NguoiDuyet.HoTen : null,
                    NgayDuyet = d.NgayDuyet,
                    GhiChuPheDuyet = d.GhiChuPheDuyet
                })
                .ToListAsync();

            return Ok(results);
        }

        /// <summary>
        /// API ThÃªm má»›i ÄÆ¡n Xin Nghá»‰
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> CreateDonXinNghi([FromBody] DonXinNghiCreateDto dto)
        {
            var entity = new DonXinNghi
            {
                IdNhanVien = dto.IdNhanVien,
                LoaiDon = dto.LoaiDon,
                LyDo = dto.LyDo,
                NgayBatDau = dto.NgayBatDau.Date,
                NgayKetThuc = dto.NgayKetThuc.Date,
                TrangThai = "Chá» duyá»‡t", // Máº·c Ä‘á»‹nh
                NgayDuyet = null
            };

            _context.DonXinNghis.Add(entity);
            await _context.SaveChangesAsync();
            return Ok(entity);
        }

        /// <summary>
        /// API Duyá»‡t Ä‘Æ¡n
        /// </summary>
        [HttpPut("approve/{idDon}")]
        public async Task<IActionResult> ApproveDon(int idDon, [FromBody] DonXinNghiActionDto dto)
        {
            var don = await _context.DonXinNghis.FindAsync(idDon);
            if (don == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n.");
            if (don.TrangThai != "Chá» duyá»‡t") return Conflict("ÄÆ¡n nÃ y Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½ trÆ°á»›c Ä‘Ã³.");

            // Cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n
            don.TrangThai = "ÄÃ£ duyá»‡t";
            don.IdNguoiDuyet = dto.IdNguoiDuyet;
            don.GhiChuPheDuyet = dto.GhiChuPheDuyet;
            don.NgayDuyet = DateTime.Now;

            // Tá»° Äá»˜NG Cáº¬P NHáº¬T Lá»ŠCH LÃ€M VIá»†C (YÃªu cáº§u #4)
            var conflictingSchedules = await _context.LichLamViecs
                .Where(l => l.IdNhanVien == don.IdNhanVien &&
                            l.NgayLam >= don.NgayBatDau.Date &&
                            l.NgayLam <= don.NgayKetThuc.Date)
                .ToListAsync();

            // Kiá»ƒm tra xem cÃ³ lá»‹ch nÃ o Ä‘Ã£ cháº¥m cÃ´ng chÆ°a
            foreach (var lich in conflictingSchedules)
            {
                if (await _context.BangChamCongs.AnyAsync(c => c.IdLichLamViec == lich.IdLichLamViec))
                {
                    // Náº¿u Ä‘Ã£ cháº¥m cÃ´ng, khÃ´ng thá»ƒ duyá»‡t -> Rollback
                    return Conflict($"KhÃ´ng thá»ƒ duyá»‡t. NhÃ¢n viÃªn Ä‘Ã£ cháº¥m cÃ´ng ngÃ y {lich.NgayLam:dd/MM/yyyy}.");
                }
            }

            // Náº¿u khÃ´ng cÃ³ xung Ä‘á»™t -> XÃ³a cÃ¡c lá»‹ch lÃ m viá»‡c
            if (conflictingSchedules.Any())
            {
                _context.LichLamViecs.RemoveRange(conflictingSchedules);
            }

            await _context.SaveChangesAsync();
            return Ok(new { message = "Duyá»‡t Ä‘Æ¡n thÃ nh cÃ´ng vÃ  Ä‘Ã£ cáº­p nháº­t lá»‹ch lÃ m viá»‡c." });
        }

        /// <summary>
        /// API Tá»« chá»‘i Ä‘Æ¡n
        /// </summary>
        [HttpPut("reject/{idDon}")]
        public async Task<IActionResult> RejectDon(int idDon, [FromBody] DonXinNghiActionDto dto)
        {
            var don = await _context.DonXinNghis.FindAsync(idDon);
            if (don == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n.");
            if (don.TrangThai != "Chá» duyá»‡t") return Conflict("ÄÆ¡n nÃ y Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½ trÆ°á»›c Ä‘Ã³.");

            don.TrangThai = "ÄÃ£ tá»« chá»‘i";
            don.IdNguoiDuyet = dto.IdNguoiDuyet;
            don.GhiChuPheDuyet = dto.GhiChuPheDuyet;
            don.NgayDuyet = DateTime.Now;

            await _context.SaveChangesAsync();
            return Ok(new { message = "Tá»« chá»‘i Ä‘Æ¡n thÃ nh cÃ´ng." });
        }

        /// <summary>
        /// API XÃ³a Ä‘Æ¡n (chá»‰ khi chÆ°a duyá»‡t)
        /// </summary>
        [HttpDelete("{idDon}")]
        public async Task<IActionResult> DeleteDon(int idDon)
        {
            var don = await _context.DonXinNghis.FindAsync(idDon);
            if (don == null) return NotFound();

            if (don.TrangThai != "Chá» duyá»‡t")
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a. ÄÆ¡n nÃ y Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½.");
            }

            _context.DonXinNghis.Remove(don);
            await _context.SaveChangesAsync();
            return Ok();
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\KhachHangController.cs
// Táº­p tin: CafebookApi/Controllers/App/KhachHangController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using CafebookModel.Utils;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using System.IO;
using Microsoft.AspNetCore.Http;
using System;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/khachhang")]
    [ApiController]
    public class KhachHangController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private readonly IWebHostEnvironment _env;
        private readonly string _baseUrl;

        public KhachHangController(CafebookDbContext context, IWebHostEnvironment env, IConfiguration config)
        {
            _context = context;

            _env = env;
            if (string.IsNullOrEmpty(_env.WebRootPath))
            {
                _env.WebRootPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot");
                if (!Directory.Exists(_env.WebRootPath))
                {
                    Directory.CreateDirectory(_env.WebRootPath);
                }
            }
            _baseUrl = config.GetValue<string>("Kestrel:Endpoints:Http:Url")
                       ?? "http://127.0.0.1:5166";
        }

        // === 5 HÃ€M HELPER Xá»¬ LÃ FILE ===
        [ApiExplorerSettings(IgnoreApi = true)]
        private string? GetFullImageUrl(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath))
                return null;
            return $"{_baseUrl}{relativePath.Replace(Path.DirectorySeparatorChar, '/')}";
        }
        [ApiExplorerSettings(IgnoreApi = true)]
        private string GenerateFileName(int id, string ten)
        {
            string slug = SlugifyUtil.GenerateSlug(ten);
            return $"{id}_{slug}.jpg";
        }
        [ApiExplorerSettings(IgnoreApi = true)]
        private void DeleteOldImage(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath)) return;
            var fileName = relativePath.TrimStart('/');
            var fullPath = Path.Combine(_env.WebRootPath, fileName.Replace('/', Path.DirectorySeparatorChar));
            if (System.IO.File.Exists(fullPath))
            {
                System.IO.File.Delete(fullPath);
            }
        }
        [ApiExplorerSettings(IgnoreApi = true)]
        private void RenameImage(string oldRelativePath, string newRelativePath)
        {
            if (string.IsNullOrEmpty(oldRelativePath) || string.IsNullOrEmpty(newRelativePath) || oldRelativePath == newRelativePath)
                return;
            var oldFullPath = Path.Combine(_env.WebRootPath, oldRelativePath.TrimStart('/').Replace('/', Path.DirectorySeparatorChar));
            var newFullPath = Path.Combine(_env.WebRootPath, newRelativePath.TrimStart('/').Replace('/', Path.DirectorySeparatorChar));
            if (System.IO.File.Exists(oldFullPath))
            {
                System.IO.File.Move(oldFullPath, newFullPath);
            }
        }
        [ApiExplorerSettings(IgnoreApi = true)]
        private async Task<string> SaveImageFromFile(IFormFile file, string fileName, string relativeDir)
        {
            var saveDir = Path.Combine(_env.WebRootPath, relativeDir);
            if (!Directory.Exists(saveDir))
            {
                Directory.CreateDirectory(saveDir);
            }
            var fullSavePath = Path.Combine(saveDir, fileName);
            await using (var stream = new FileStream(fullSavePath, FileMode.Create))
            {
                await file.CopyToAsync(stream);
            }
            return $"/{relativeDir.Replace(Path.DirectorySeparatorChar, '/')}/{fileName}";
        }
        // ===================================

        /// <summary>
        /// API Láº¥y danh sÃ¡ch KhÃ¡ch hÃ ng
        /// </summary>
        [HttpGet("search")]
        public async Task<IActionResult> SearchKhachHang(
            [FromQuery] string? searchText,
            [FromQuery] bool? biKhoa)
        {
            var query = _context.KhachHangs.AsQueryable();

            if (biKhoa.HasValue)
            {
                query = query.Where(kh => kh.BiKhoa == biKhoa.Value);
            }

            if (!string.IsNullOrEmpty(searchText))
            {
                string searchLower = searchText.ToLower();
                query = query.Where(kh =>
                    kh.HoTen.ToLower().Contains(searchLower) ||
                    (kh.SoDienThoai != null && kh.SoDienThoai.Contains(searchLower)) ||
                    (kh.Email != null && kh.Email.ToLower().Contains(searchLower))
                );
            }

            var results = await query
                .Select(kh => new KhachHangDto
                {
                    IdKhachHang = kh.IdKhachHang,
                    HoTen = kh.HoTen,
                    SoDienThoai = kh.SoDienThoai,
                    Email = kh.Email,
                    NgayTao = kh.NgayTao,
                    BiKhoa = kh.BiKhoa
                })
                .OrderBy(kh => kh.HoTen)
                .ToListAsync();

            return Ok(results);
        }

        /// <summary>
        /// Sá»¬A: API Láº¥y chi tiáº¿t vÃ  lá»‹ch sá»­
        /// </summary>
        [HttpGet("details/{id}")]
        public async Task<IActionResult> GetKhachHangDetails(int id)
        {
            var kh = await _context.KhachHangs.FindAsync(id);
            if (kh == null) return NotFound();

            var dto = new KhachHangDetailDto
            {
                IdKhachHang = kh.IdKhachHang,
                HoTen = kh.HoTen,
                SoDienThoai = kh.SoDienThoai,
                Email = kh.Email,
                DiaChi = kh.DiaChi,
                DiemTichLuy = kh.DiemTichLuy,
                TenDangNhap = kh.TenDangNhap,
                BiKhoa = kh.BiKhoa,
                AnhDaiDienUrl = GetFullImageUrl(kh.AnhDaiDien), // <-- Sá»¬A

                LichSuDonHang = await _context.HoaDons
                    .Where(h => h.IdKhachHang == id)
                    .OrderByDescending(h => h.ThoiGianTao)
                    .Select(h => new LichSuDonHangDto
                    {
                        IdHoaDon = h.IdHoaDon,
                        ThoiGianTao = h.ThoiGianTao,
                        ThanhTien = h.ThanhTien,
                        TrangThai = h.TrangThai
                    }).ToListAsync(),

                LichSuThueSach = await _context.PhieuThueSachs
                    .Where(p => p.IdKhachHang == id)
                    .Include(p => p.ChiTietPhieuThues)
                        .ThenInclude(ct => ct.Sach)
                    .OrderByDescending(p => p.NgayThue)
                    .SelectMany(p => p.ChiTietPhieuThues.Select(ct => new LichSuThueSachDto
                    {
                        IdPhieuThue = p.IdPhieuThueSach,
                        TieuDeSach = ct.Sach.TenSach,
                        NgayThue = p.NgayThue,
                        TrangThai = p.TrangThai
                    }))
                    .Take(20)
                    .ToListAsync()
            };
            return Ok(dto);
        }

        /// <summary>
        /// Sá»¬A: API ThÃªm khÃ¡ch hÃ ng má»›i
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> CreateKhachHang([FromForm] KhachHangUpdateRequestDto dto) // <-- Sá»¬A [FromForm]
        {
            if (string.IsNullOrEmpty(dto.HoTen) || string.IsNullOrEmpty(dto.SoDienThoai))
            {
                return BadRequest("Há» tÃªn vÃ  SÄT lÃ  báº¯t buá»™c.");
            }
            if (await _context.KhachHangs.AnyAsync(kh => kh.SoDienThoai == dto.SoDienThoai))
            {
                return Conflict("Sá»‘ Ä‘iá»‡n thoáº¡i nÃ y Ä‘Ã£ tá»“n táº¡i.");
            }
            if (!string.IsNullOrEmpty(dto.Email) && await _context.KhachHangs.AnyAsync(kh => kh.Email == dto.Email))
            {
                return Conflict("Email nÃ y Ä‘Ã£ tá»“n táº¡i.");
            }

            var khachHang = new KhachHang
            {
                HoTen = dto.HoTen,
                SoDienThoai = dto.SoDienThoai,
                Email = dto.Email,
                DiaChi = dto.DiaChi,
                TenDangNhap = dto.TenDangNhap,
                DiemTichLuy = 0,
                NgayTao = DateTime.Now,
                BiKhoa = false,
                AnhDaiDien = null // Sá»¬A: Táº¡m thá»i null
            };
            _context.KhachHangs.Add(khachHang);
            await _context.SaveChangesAsync(); // LÆ°u láº§n 1 Ä‘á»ƒ láº¥y ID

            // Sá»¬A: ThÃªm logic lÆ°u file
            if (dto.AnhDaiDienUpload != null)
            {
                try
                {
                    string fileName = GenerateFileName(khachHang.IdKhachHang, khachHang.HoTen);
                    string relativePath = await SaveImageFromFile(dto.AnhDaiDienUpload, fileName, HinhAnhPaths.UrlAvatarKH.TrimStart('/'));
                    khachHang.AnhDaiDien = relativePath;
                    await _context.SaveChangesAsync();
                }
                catch (Exception ex)
                {
                    _context.KhachHangs.Remove(khachHang);
                    await _context.SaveChangesAsync();
                    return StatusCode(500, $"Lá»—i khi lÆ°u áº£nh: {ex.Message}");
                }
            }

            return Ok(khachHang);
        }

        /// <summary>
        /// Sá»¬A: API Cáº­p nháº­t khÃ¡ch hÃ ng
        /// </summary>
        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateKhachHang(int id, [FromForm] KhachHangUpdateRequestDto dto) // <-- Sá»¬A [FromForm]
        {
            var kh = await _context.KhachHangs.FindAsync(id);
            if (kh == null) return NotFound();

            if (await _context.KhachHangs.AnyAsync(k => k.SoDienThoai == dto.SoDienThoai && k.IdKhachHang != id))
            {
                return Conflict("Sá»‘ Ä‘iá»‡n thoáº¡i nÃ y Ä‘Ã£ tá»“n táº¡i.");
            }
            if (!string.IsNullOrEmpty(dto.Email) && await _context.KhachHangs.AnyAsync(k => k.Email == dto.Email && k.IdKhachHang != id))
            {
                return Conflict("Email nÃ y Ä‘Ã£ tá»“n táº¡i.");
            }

            // Sá»¬A: Logic xá»­ lÃ½ file
            var oldImagePath = kh.AnhDaiDien;
            var oldTen = kh.HoTen;
            bool isImageUpload = dto.AnhDaiDienUpload != null;
            bool isNameChange = dto.HoTen != oldTen;

            // Cáº­p nháº­t text
            kh.HoTen = dto.HoTen;
            kh.SoDienThoai = dto.SoDienThoai;
            kh.Email = dto.Email;
            kh.DiaChi = dto.DiaChi;
            kh.TenDangNhap = dto.TenDangNhap;
            kh.DiemTichLuy = dto.DiemTichLuy;

            // Xá»­ lÃ½ file
            string newFileName = GenerateFileName(kh.IdKhachHang, kh.HoTen);
            string newRelativePath = $"/{HinhAnhPaths.UrlAvatarKH.TrimStart('/')}/{newFileName}";

            if (isImageUpload)
            {
                DeleteOldImage(oldImagePath);
                kh.AnhDaiDien = await SaveImageFromFile(dto.AnhDaiDienUpload, newFileName, HinhAnhPaths.UrlAvatarKH.TrimStart('/'));
            }
            else if (dto.XoaAnhDaiDien)
            {
                DeleteOldImage(oldImagePath);
                kh.AnhDaiDien = null;
            }
            else if (isNameChange && !string.IsNullOrEmpty(oldImagePath))
            {
                RenameImage(oldImagePath, newRelativePath);
                kh.AnhDaiDien = newRelativePath;
            }

            await _context.SaveChangesAsync();
            return Ok();
        }

        // Helper class cho API UpdateStatus
        public class UpdateStatusRequest
        {
            public bool BiKhoa { get; set; }
        }

        /// <summary>
        /// Sá»¬A: API KhÃ³a/Má»Ÿ khÃ³a tÃ i khoáº£n
        /// </summary>
        [HttpPut("update-status/{id}")]
        public async Task<IActionResult> UpdateKhachHangStatus(int id, [FromBody] UpdateStatusRequest request) // <-- Sá»¬A: Nháº­n Object
        {
            var kh = await _context.KhachHangs.FindAsync(id);
            if (kh == null) return NotFound();

            kh.BiKhoa = request.BiKhoa; // <-- Sá»¬A: Láº¥y tá»« object
            await _context.SaveChangesAsync();
            return Ok();
        }

        /// <summary>
        /// Sá»¬A: API XÃ³a khÃ¡ch hÃ ng
        /// </summary>
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteKhachHang(int id)
        {
            // Kiá»ƒm tra rÃ ng buá»™c
            if (await _context.HoaDons.AnyAsync(h => h.IdKhachHang == id))
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a. KhÃ¡ch hÃ ng nÃ y Ä‘Ã£ cÃ³ lá»‹ch sá»­ HÃ³a Ä‘Æ¡n.");
            }
            if (await _context.PhieuThueSachs.AnyAsync(p => p.IdKhachHang == id))
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a. KhÃ¡ch hÃ ng nÃ y Ä‘Ã£ cÃ³ lá»‹ch sá»­ ThuÃª sÃ¡ch.");
            }

            var kh = await _context.KhachHangs.FindAsync(id);
            if (kh == null) return NotFound();

            // Sá»¬A: ThÃªm xÃ³a file
            DeleteOldImage(kh.AnhDaiDien);

            _context.KhachHangs.Remove(kh);
            await _context.SaveChangesAsync();
            return Ok();
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\KhoController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/kho")]
    [ApiController]
    public class KhoController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public KhoController(CafebookDbContext context)
        {
            _context = context;
        }

        // --- TAB 1: Tá»’N KHO ---
        [HttpGet("tonkho")]
        public async Task<IActionResult> GetTonKho()
        {
            var tonKho = await _context.NguyenLieus
                .Select(nl => new NguyenLieuTonKhoDto
                {
                    IdNguyenLieu = nl.IdNguyenLieu,
                    TenNguyenLieu = nl.TenNguyenLieu,
                    TonKho = nl.TonKho,
                    DonViTinh = nl.DonViTinh,
                    TonKhoToiThieu = nl.TonKhoToiThieu,
                    TinhTrang = (nl.TonKho <= 0) ? "Háº¿t hÃ ng" : (nl.TonKho <= nl.TonKhoToiThieu ? "Sáº¯p háº¿t" : "Äá»§ dÃ¹ng")
                })
                .OrderBy(nl => nl.TinhTrang)
                .ThenBy(nl => nl.TenNguyenLieu)
                .ToListAsync();
            return Ok(tonKho);
        }

        // --- TAB 2: QUáº¢N LÃ NGUYÃŠN LIá»†U (CRUD) ---
        #region API NguyÃªn Liá»‡u
        [HttpGet("nguyenlieu")]
        public async Task<IActionResult> GetAllNguyenLieu()
        {
            var data = await _context.NguyenLieus
                .Select(nl => new NguyenLieuCrudDto
                {
                    IdNguyenLieu = nl.IdNguyenLieu,
                    TenNguyenLieu = nl.TenNguyenLieu,
                    DonViTinh = nl.DonViTinh,
                    TonKhoToiThieu = nl.TonKhoToiThieu,
                    TonKho = nl.TonKho // Sá»­a lá»—i CS0117
                })
                .OrderBy(nl => nl.TenNguyenLieu)
                .ToListAsync();
            return Ok(data);
        }

        [HttpPost("nguyenlieu")]
        public async Task<IActionResult> CreateNguyenLieu([FromBody] NguyenLieuUpdateRequestDto dto)
        {
            if (await _context.NguyenLieus.AnyAsync(nl => nl.TenNguyenLieu.ToLower() == dto.TenNguyenLieu.ToLower()))
            {
                return Conflict("TÃªn nguyÃªn liá»‡u Ä‘Ã£ tá»“n táº¡i.");
            }
            var entity = new NguyenLieu
            {
                TenNguyenLieu = dto.TenNguyenLieu,
                DonViTinh = dto.DonViTinh,
                TonKhoToiThieu = dto.TonKhoToiThieu,
                TonKho = 0
            };
            _context.NguyenLieus.Add(entity);
            await _context.SaveChangesAsync();
            return Ok(entity);
        }

        [HttpPut("nguyenlieu/{id}")]
        public async Task<IActionResult> UpdateNguyenLieu(int id, [FromBody] NguyenLieuUpdateRequestDto dto)
        {
            var entity = await _context.NguyenLieus.FindAsync(id);
            if (entity == null) return NotFound();

            if (await _context.NguyenLieus.AnyAsync(nl => nl.TenNguyenLieu.ToLower() == dto.TenNguyenLieu.ToLower() && nl.IdNguyenLieu != id))
            {
                return Conflict("TÃªn nguyÃªn liá»‡u Ä‘Ã£ tá»“n táº¡i.");
            }

            entity.TenNguyenLieu = dto.TenNguyenLieu;
            entity.DonViTinh = dto.DonViTinh;
            entity.TonKhoToiThieu = dto.TonKhoToiThieu;
            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpDelete("nguyenlieu/{id}")]
        public async Task<IActionResult> DeleteNguyenLieu(int id)
        {
            if (await _context.DinhLuongs.AnyAsync(d => d.IdNguyenLieu == id) ||
                await _context.ChiTietNhapKhos.AnyAsync(d => d.IdNguyenLieu == id))
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a. NguyÃªn liá»‡u nÃ y Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng trong Äá»‹nh lÆ°á»£ng hoáº·c Phiáº¿u nháº­p kho.");
            }
            var entity = await _context.NguyenLieus.FindAsync(id);
            if (entity == null) return NotFound();
            _context.NguyenLieus.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }
        #endregion

        // --- TAB 3: QUáº¢N LÃ NHáº¬P KHO ---
        #region API Nháº­p Kho
        [HttpGet("phieunhap")]
        public async Task<IActionResult> GetPhieuNhap([FromQuery] DateTime? startDate, [FromQuery] DateTime? endDate)
        {
            var query = _context.PhieuNhapKhos
                .Include(p => p.NhaCungCap)
                .Include(p => p.NhanVien)
                .OrderByDescending(p => p.NgayNhap)
                .AsQueryable();

            if (startDate.HasValue)
                query = query.Where(p => p.NgayNhap.Date >= startDate.Value.Date);
            if (endDate.HasValue)
                query = query.Where(p => p.NgayNhap.Date <= endDate.Value.Date);

            var data = await query.Select(p => new PhieuNhapDto
            {
                IdPhieuNhapKho = p.IdPhieuNhapKho,
                NgayNhap = p.NgayNhap,
                TenNhaCungCap = p.NhaCungCap != null ? p.NhaCungCap.TenNhaCungCap : "Nháº­p láº»",
                TenNhanVien = p.NhanVien.HoTen,
                TongTien = p.TongTien,
                TrangThai = p.TrangThai
            }).ToListAsync();
            return Ok(data);
        }

        [HttpGet("phieunhap/{id}")]
        public async Task<IActionResult> GetChiTietPhieuNhap(int id)
        {
            var data = await _context.ChiTietNhapKhos
                .Where(ct => ct.IdPhieuNhapKho == id)
                .Include(ct => ct.NguyenLieu)
                .Select(ct => new ChiTietPhieuNhapDto
                {
                    IdNguyenLieu = ct.IdNguyenLieu,
                    TenNguyenLieu = ct.NguyenLieu.TenNguyenLieu,
                    SoLuongNhap = ct.SoLuongNhap,
                    DonGiaNhap = ct.DonGiaNhap,
                    ThanhTien = ct.ThanhTien
                }).ToListAsync();
            return Ok(data);
        }

        [HttpPost("phieunhap")]
        public async Task<IActionResult> CreatePhieuNhap([FromBody] PhieuNhapCreateDto dto)
        {
            using var transaction = await _context.Database.BeginTransactionAsync();
            try
            {
                var phieuNhap = new PhieuNhapKho
                {
                    IdNhanVien = dto.IdNhanVien,
                    IdNhaCungCap = dto.IdNhaCungCap,
                    NgayNhap = dto.NgayNhap,
                    GhiChu = dto.GhiChu,
                    TrangThai = "ÄÃ£ nháº­p",
                    TongTien = dto.ChiTiet.Sum(ct => ct.SoLuongNhap * ct.DonGiaNhap)
                };
                _context.PhieuNhapKhos.Add(phieuNhap);
                await _context.SaveChangesAsync();

                foreach (var ctDto in dto.ChiTiet)
                {
                    var chiTiet = new ChiTietNhapKho
                    {
                        IdPhieuNhapKho = phieuNhap.IdPhieuNhapKho,
                        IdNguyenLieu = ctDto.IdNguyenLieu,
                        SoLuongNhap = ctDto.SoLuongNhap,
                        DonGiaNhap = ctDto.DonGiaNhap
                    };
                    _context.ChiTietNhapKhos.Add(chiTiet);

                    var nguyenLieu = await _context.NguyenLieus.FindAsync(ctDto.IdNguyenLieu);
                    if (nguyenLieu != null)
                    {
                        nguyenLieu.TonKho += ctDto.SoLuongNhap;
                    }
                }
                await _context.SaveChangesAsync();

                await transaction.CommitAsync();
                return Ok(new { IdPhieuNhapKho = phieuNhap.IdPhieuNhapKho });
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                return StatusCode(500, $"Lá»—i mÃ¡y chá»§: {ex.Message}");
            }
        }
        #endregion

        // --- TAB 4: QUáº¢N LÃ NHÃ€ CUNG Cáº¤P (CRUD) ---
        #region API NhÃ  Cung Cáº¥p
        [HttpGet("nhacungcap")]
        public async Task<IActionResult> GetAllNhaCungCap()
        {
            var data = await _context.NhaCungCaps
                .Select(ncc => new NhaCungCapDto
                {
                    IdNhaCungCap = ncc.IdNhaCungCap,
                    TenNhaCungCap = ncc.TenNhaCungCap,
                    SoDienThoai = ncc.SoDienThoai,
                    DiaChi = ncc.DiaChi,
                    Email = ncc.Email
                })
                .OrderBy(ncc => ncc.TenNhaCungCap)
                .ToListAsync();
            return Ok(data);
        }

        [HttpPost("nhacungcap")]
        public async Task<IActionResult> CreateNhaCungCap([FromBody] NhaCungCapDto dto)
        {
            var entity = new NhaCungCap
            {
                TenNhaCungCap = dto.TenNhaCungCap,
                SoDienThoai = dto.SoDienThoai,
                DiaChi = dto.DiaChi,
                Email = dto.Email
            };
            _context.NhaCungCaps.Add(entity);
            await _context.SaveChangesAsync();
            return Ok(entity);
        }

        [HttpPut("nhacungcap/{id}")]
        public async Task<IActionResult> UpdateNhaCungCap(int id, [FromBody] NhaCungCapDto dto)
        {
            var entity = await _context.NhaCungCaps.FindAsync(id);
            if (entity == null) return NotFound();

            entity.TenNhaCungCap = dto.TenNhaCungCap;
            entity.SoDienThoai = dto.SoDienThoai;
            entity.DiaChi = dto.DiaChi;
            entity.Email = dto.Email;

            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpDelete("nhacungcap/{id}")]
        public async Task<IActionResult> DeleteNhaCungCap(int id)
        {
            if (await _context.PhieuNhapKhos.AnyAsync(p => p.IdNhaCungCap == id))
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a. NhÃ  cung cáº¥p nÃ y Ä‘Ã£ cÃ³ lá»‹ch sá»­ nháº­p hÃ ng.");
            }
            var entity = await _context.NhaCungCaps.FindAsync(id);
            if (entity == null) return NotFound();
            _context.NhaCungCaps.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }
        #endregion

        // --- THÃŠM Má»šI: API CHO XUáº¤T Há»¦Y KHO ---
        #region API Xuáº¥t Há»§y Kho

        [HttpGet("phieuxuathuy")]
        public async Task<IActionResult> GetPhieuXuatHuy([FromQuery] DateTime? startDate, [FromQuery] DateTime? endDate)
        {
            var query = _context.PhieuXuatHuys
                .Include(p => p.NhanVienXuat)
                .OrderByDescending(p => p.NgayXuatHuy)
                .AsQueryable();

            if (startDate.HasValue)
                query = query.Where(p => p.NgayXuatHuy.Date >= startDate.Value.Date);
            if (endDate.HasValue)
                query = query.Where(p => p.NgayXuatHuy.Date <= endDate.Value.Date);

            var data = await query.Select(p => new PhieuXuatHuyDto
            {
                IdPhieuXuatHuy = p.IdPhieuXuatHuy,
                NgayXuatHuy = p.NgayXuatHuy,
                TenNhanVien = p.NhanVienXuat.HoTen,
                LyDoXuatHuy = p.LyDoXuatHuy,
                TongGiaTriHuy = p.TongGiaTriHuy
            }).ToListAsync();
            return Ok(data);
        }

        [HttpGet("phieuxuathuy/{id}")]
        public async Task<IActionResult> GetChiTietPhieuXuatHuy(int id)
        {
            var data = await _context.ChiTietXuatHuys
                .Where(ct => ct.IdPhieuXuatHuy == id)
                .Include(ct => ct.NguyenLieu)
                .Select(ct => new ChiTietPhieuXuatHuyDto
                {
                    IdNguyenLieu = ct.IdNguyenLieu,
                    TenNguyenLieu = ct.NguyenLieu.TenNguyenLieu,
                    SoLuong = ct.SoLuong,
                    DonGiaVon = ct.DonGiaVon,
                    ThanhTien = ct.ThanhTien
                }).ToListAsync();
            return Ok(data);
        }

        [HttpPost("phieuxuathuy")]
        public async Task<IActionResult> CreatePhieuXuatHuy([FromBody] PhieuXuatHuyCreateDto dto)
        {
            using var transaction = await _context.Database.BeginTransactionAsync();
            try
            {
                var phieuHuy = new PhieuXuatHuy
                {
                    IdNhanVienXuat = dto.IdNhanVien,
                    NgayXuatHuy = dto.NgayXuatHuy,
                    LyDoXuatHuy = dto.LyDoXuatHuy,
                    TongGiaTriHuy = 0 // Sáº½ tÃ­nh toÃ¡n bÃªn dÆ°á»›i
                };
                _context.PhieuXuatHuys.Add(phieuHuy);
                await _context.SaveChangesAsync(); // LÆ°u Ä‘á»ƒ láº¥y ID

                decimal tongGiaTri = 0;

                foreach (var ctDto in dto.ChiTiet)
                {
                    var nguyenLieu = await _context.NguyenLieus.FindAsync(ctDto.IdNguyenLieu);
                    if (nguyenLieu == null) continue;

                    // Láº¥y giÃ¡ vá»‘n trung bÃ¬nh (Ä‘Æ¡n giáº£n)
                    var giaVon = await _context.ChiTietNhapKhos
                        .Where(ct => ct.IdNguyenLieu == ctDto.IdNguyenLieu && ct.DonGiaNhap > 0)
                        .Select(ct => (decimal?)ct.DonGiaNhap)
                        .AverageAsync() ?? 0;

                    var chiTiet = new ChiTietXuatHuy
                    {
                        IdPhieuXuatHuy = phieuHuy.IdPhieuXuatHuy,
                        IdNguyenLieu = ctDto.IdNguyenLieu,
                        SoLuong = ctDto.SoLuong,
                        DonGiaVon = giaVon,
                        // ThanhTien sáº½ Ä‘Æ°á»£c tÃ­nh tá»± Ä‘á»™ng bá»Ÿi CSDL (Computed Column)
                    };
                    _context.ChiTietXuatHuys.Add(chiTiet);

                    // Trá»« tá»“n kho
                    nguyenLieu.TonKho -= ctDto.SoLuong;
                    tongGiaTri += (ctDto.SoLuong * giaVon);
                }

                phieuHuy.TongGiaTriHuy = tongGiaTri; // Cáº­p nháº­t tá»•ng tiá»n
                await _context.SaveChangesAsync();

                await transaction.CommitAsync();
                return Ok(new { idPhieuXuatHuy = phieuHuy.IdPhieuXuatHuy });
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                return StatusCode(500, $"Lá»—i mÃ¡y chá»§: {ex.Message}");
            }
        }

        #endregion

        // --- THÃŠM Má»šI: API CHO KIá»‚M KHO (Sá»¬A Lá»–I 404) ---
        #region API Kiá»ƒm Kho

        [HttpGet("phieukiemkho")]
        public async Task<IActionResult> GetPhieuKiemKho([FromQuery] DateTime? startDate, [FromQuery] DateTime? endDate)
        {
            var query = _context.PhieuKiemKhos
                .Include(p => p.NhanVienKiem)
                .OrderByDescending(p => p.NgayKiem)
                .AsQueryable();

            if (startDate.HasValue)
                query = query.Where(p => p.NgayKiem.Date >= startDate.Value.Date);
            if (endDate.HasValue)
                query = query.Where(p => p.NgayKiem.Date <= endDate.Value.Date);

            var data = await query.Select(p => new PhieuKiemKhoDto
            {
                IdPhieuKiemKho = p.IdPhieuKiemKho,
                NgayKiem = p.NgayKiem,
                TenNhanVienKiem = p.NhanVienKiem.HoTen,
                TrangThai = p.TrangThai
            }).ToListAsync();
            return Ok(data);
        }

        [HttpGet("phieukiemkho/{id}")]
        public async Task<IActionResult> GetChiTietPhieuKiemKho(int id)
        {
            var data = await _context.ChiTietKiemKhos
                .Where(ct => ct.IdPhieuKiemKho == id)
                .Include(ct => ct.NguyenLieu)
                .Select(ct => new ChiTietKiemKhoDto
                {
                    IdNguyenLieu = ct.IdNguyenLieu,
                    TenNguyenLieu = ct.NguyenLieu.TenNguyenLieu,
                    DonViTinh = ct.NguyenLieu.DonViTinh,
                    TonKhoHeThong = ct.TonKhoHeThong,
                    TonKhoThucTe = ct.TonKhoThucTe,
                    LyDoChenhLech = ct.LyDoChenhLech,
                    GiaTriChenhLech = ct.ChenhLech * (_context.ChiTietNhapKhos
                                                        .Where(c => c.IdNguyenLieu == ct.IdNguyenLieu)
                                                        .Select(c => (decimal?)c.DonGiaNhap).Average() ?? 0)
                }).ToListAsync();
            return Ok(data);
        }

        /// <summary>
        /// API Ä‘áº·c biá»‡t: Láº¥y toÃ n bá»™ tá»“n kho hiá»‡n táº¡i Ä‘á»ƒ báº¯t Ä‘áº§u kiá»ƒm kÃª
        /// </summary>
        [HttpGet("phieukiemkho/taomoi")]
        public async Task<IActionResult> GetCurrentStockForAudit()
        {
            var data = await _context.NguyenLieus
                .OrderBy(nl => nl.TenNguyenLieu)
                .Select(nl => new ChiTietKiemKhoDto
                {
                    IdNguyenLieu = nl.IdNguyenLieu,
                    TenNguyenLieu = nl.TenNguyenLieu,
                    DonViTinh = nl.DonViTinh,
                    TonKhoHeThong = nl.TonKho,
                    TonKhoThucTe = nl.TonKho, // Máº·c Ä‘á»‹nh báº±ng nhau
                    LyDoChenhLech = ""
                })
                .ToListAsync();
            return Ok(data);
        }

        [HttpPost("phieukiemkho")]
        public async Task<IActionResult> CreatePhieuKiemKho([FromBody] PhieuKiemKhoCreateDto dto)
        {
            using var transaction = await _context.Database.BeginTransactionAsync();
            try
            {
                var phieuKiem = new PhieuKiemKho
                {
                    IdNhanVienKiem = dto.IdNhanVien,
                    NgayKiem = dto.NgayKiem,
                    GhiChu = dto.GhiChu,
                    TrangThai = "HoÃ n thÃ nh"
                };
                _context.PhieuKiemKhos.Add(phieuKiem);
                await _context.SaveChangesAsync(); // LÆ°u Ä‘á»ƒ láº¥y ID

                foreach (var ctDto in dto.ChiTiet)
                {
                    var chiTiet = new ChiTietKiemKho
                    {
                        IdPhieuKiemKho = phieuKiem.IdPhieuKiemKho,
                        IdNguyenLieu = ctDto.IdNguyenLieu,
                        TonKhoHeThong = ctDto.TonKhoHeThong,
                        TonKhoThucTe = ctDto.TonKhoThucTe,
                        LyDoChenhLech = ctDto.LyDoChenhLech
                        // ChenhLech Ä‘Æ°á»£c tÃ­nh tá»± Ä‘á»™ng
                    };
                    _context.ChiTietKiemKhos.Add(chiTiet);

                    // CÃ¢n báº±ng kho: Cáº­p nháº­t Tá»“n Kho thá»±c táº¿
                    if (ctDto.ChenhLech != 0)
                    {
                        var nguyenLieu = await _context.NguyenLieus.FindAsync(ctDto.IdNguyenLieu);
                        if (nguyenLieu != null)
                        {
                            nguyenLieu.TonKho = ctDto.TonKhoThucTe;
                        }
                    }
                }
                await _context.SaveChangesAsync();

                await transaction.CommitAsync();
                return Ok(new { idPhieuKiemKho = phieuKiem.IdPhieuKiemKho });
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                return StatusCode(500, $"Lá»—i mÃ¡y chá»§: {ex.Message}");
            }
        }

        #endregion
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\KhuyenMaiController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Globalization;
using System.Linq;
using System.Threading.Tasks; // <--- Äáº£m báº£o báº¡n CÃ“ 'using' nÃ y

namespace CafebookApi.Controllers.App
{
    [Route("api/app/khuyenmai")]
    [ApiController]
    public class KhuyenMaiController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public KhuyenMaiController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// Sá»¬A Lá»–I: ThÃªm 'async Task<...>'
        /// </summary>
        [HttpGet("search")]
        public async Task<IActionResult> SearchKhuyenMai( // <-- Sá»¬A Lá»–I (ThÃªm async Task)
            [FromQuery] string? maKhuyenMai,
            [FromQuery] string? trangThai)
        {
            var now = DateTime.Now;
            var today = now.Date;

            // DÃ²ng 36: 'await' bÃ¢y giá» Ä‘Ã£ há»£p lá»‡
            var hetHan = await _context.KhuyenMais
                .Where(km => km.TrangThai != "Háº¿t háº¡n" && km.NgayKetThuc < today)
                .ToListAsync();

            foreach (var km in hetHan)
            {
                km.TrangThai = "Háº¿t háº¡n";
            }

            // DÃ²ng 44: 'await' bÃ¢y giá» Ä‘Ã£ há»£p lá»‡
            await _context.SaveChangesAsync();

            var query = _context.KhuyenMais.AsQueryable();

            if (!string.IsNullOrEmpty(trangThai) && trangThai != "Táº¥t cáº£")
            {
                query = query.Where(km => km.TrangThai == trangThai);
            }

            if (!string.IsNullOrEmpty(maKhuyenMai))
            {
                query = query.Where(km => km.MaKhuyenMai.Contains(maKhuyenMai));
            }

            // DÃ²ng 61: 'await' bÃ¢y giá» Ä‘Ã£ há»£p lá»‡
            var results = await query
                .OrderByDescending(km => km.NgayBatDau)
                .Select(km => new KhuyenMaiDto
                {
                    IdKhuyenMai = km.IdKhuyenMai,
                    MaKhuyenMai = km.MaKhuyenMai,
                    TenKhuyenMai = km.TenChuongTrinh,
                    GiaTriGiam = km.LoaiGiamGia == "PhanTram"
                                 ? km.GiaTriGiam.ToString("F0") + "%"
                                 : km.GiaTriGiam.ToString("N0"),
                    GiamToiDa = km.GiamToiDa,
                    DieuKienApDung = km.DieuKienApDung,
                    NgayBatDau = km.NgayBatDau,
                    NgayKetThuc = km.NgayKetThuc,
                    TrangThai = km.TrangThai
                })
                .ToListAsync();

            return Ok(results);
        }

        /// <summary>
        /// Sá»¬A Lá»–I: ThÃªm 'async Task<...>'
        /// </summary>
        [HttpGet("filters")]
        public async Task<IActionResult> GetFilters() // <-- Sá»¬A Lá»–I (ThÃªm async Task)
        {
            var filters = new KhuyenMaiFiltersDto
            {
                SanPhams = await _context.SanPhams // 'await' há»£p lá»‡
                    .Where(s => s.TrangThaiKinhDoanh)
                    .Select(s => new FilterLookupDto { Id = s.IdSanPham, Ten = s.TenSanPham })
                    .OrderBy(s => s.Ten)
                    .ToListAsync()
            };
            return Ok(filters);
        }

        /// <summary>
        /// Sá»¬A Lá»–I: ThÃªm 'async Task<...>'
        /// </summary>
        [HttpGet("details/{id}")]
        public async Task<IActionResult> GetKhuyenMaiDetails(int id) // <-- Sá»¬A Lá»–I (ThÃªm async Task)
        {
            var km = await _context.KhuyenMais.FindAsync(id); // 'await' há»£p lá»‡
            if (km == null) return NotFound();

            var dto = new KhuyenMaiUpdateRequestDto
            {
                IdKhuyenMai = km.IdKhuyenMai,
                MaKhuyenMai = km.MaKhuyenMai,
                TenChuongTrinh = km.TenChuongTrinh,
                MoTa = km.MoTa,
                LoaiGiamGia = km.LoaiGiamGia,
                GiaTriGiam = km.GiaTriGiam,
                GiamToiDa = km.GiamToiDa,
                HoaDonToiThieu = km.HoaDonToiThieu,
                IdSanPhamApDung = km.IdSanPhamApDung,
                NgayBatDau = km.NgayBatDau,
                NgayKetThuc = km.NgayKetThuc,
                NgayTrongTuan = km.NgayTrongTuan,
                GioBatDau = km.GioBatDau?.ToString(@"hh\:mm"),
                GioKetThuc = km.GioKetThuc?.ToString(@"hh\:mm"),
                DieuKienApDung = km.DieuKienApDung,
                TrangThai = km.TrangThai
            };
            return Ok(dto);
        }

        /// <summary>
        /// Sá»¬A Lá»–I: ThÃªm 'async Task<...>'
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> CreateKhuyenMai([FromBody] KhuyenMaiUpdateRequestDto dto) // <-- Sá»¬A Lá»–I (ThÃªm async Task)
        {
            if (string.IsNullOrWhiteSpace(dto.MaKhuyenMai))
            {
                return BadRequest("MÃ£ khuyáº¿n mÃ£i lÃ  báº¯t buá»™c.");
            }
            if (await _context.KhuyenMais.AnyAsync(km => km.MaKhuyenMai.ToLower() == dto.MaKhuyenMai.ToLower())) // 'await' há»£p lá»‡
            {
                return Conflict("MÃ£ khuyáº¿n mÃ£i nÃ y Ä‘Ã£ tá»“n táº¡i.");
            }

            var km = new KhuyenMai
            {
                MaKhuyenMai = dto.MaKhuyenMai.ToUpper(),
                TenChuongTrinh = dto.TenChuongTrinh,
                MoTa = dto.MoTa,
                LoaiGiamGia = dto.LoaiGiamGia,
                GiaTriGiam = dto.GiaTriGiam,
                GiamToiDa = dto.GiamToiDa,
                HoaDonToiThieu = dto.HoaDonToiThieu,
                IdSanPhamApDung = dto.IdSanPhamApDung,
                NgayBatDau = dto.NgayBatDau.Date,
                NgayKetThuc = dto.NgayKetThuc.Date,
                NgayTrongTuan = dto.NgayTrongTuan,
                GioBatDau = TimeSpan.TryParse(dto.GioBatDau, out var tsStart) ? tsStart : null,
                GioKetThuc = TimeSpan.TryParse(dto.GioKetThuc, out var tsEnd) ? tsEnd : null,
                DieuKienApDung = dto.DieuKienApDung,
                TrangThai = "Hoáº¡t Ä‘á»™ng"
            };

            _context.KhuyenMais.Add(km);
            await _context.SaveChangesAsync(); // 'await' há»£p lá»‡
            return Ok(km);
        }

        /// <summary>
        /// Sá»¬A Lá»–I: ThÃªm 'async Task<...>'
        /// </summary>
        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateKhuyenMai(int id, [FromBody] KhuyenMaiUpdateRequestDto dto) // <-- Sá»¬A Lá»–I (ThÃªm async Task)
        {
            var km = await _context.KhuyenMais.FindAsync(id); // 'await' há»£p lá»‡
            if (km == null) return NotFound();

            if (string.IsNullOrWhiteSpace(dto.MaKhuyenMai))
            {
                return BadRequest("MÃ£ khuyáº¿n mÃ£i lÃ  báº¯t buá»™c.");
            }
            if (await _context.KhuyenMais.AnyAsync(k => k.MaKhuyenMai.ToLower() == dto.MaKhuyenMai.ToLower() && k.IdKhuyenMai != id)) // 'await' há»£p lá»‡
            {
                return Conflict("MÃ£ khuyáº¿n mÃ£i nÃ y Ä‘Ã£ tá»“n táº¡i.");
            }

            km.MaKhuyenMai = dto.MaKhuyenMai.ToUpper();
            km.TenChuongTrinh = dto.TenChuongTrinh;
            km.MoTa = dto.MoTa;
            km.LoaiGiamGia = dto.LoaiGiamGia;
            km.GiaTriGiam = dto.GiaTriGiam;
            km.GiamToiDa = dto.GiamToiDa;
            km.HoaDonToiThieu = dto.HoaDonToiThieu;
            km.IdSanPhamApDung = dto.IdSanPhamApDung;
            km.NgayBatDau = dto.NgayBatDau.Date;
            km.NgayKetThuc = dto.NgayKetThuc.Date;
            km.NgayTrongTuan = dto.NgayTrongTuan;
            km.GioBatDau = TimeSpan.TryParse(dto.GioBatDau, out var tsStart) ? tsStart : null;
            km.GioKetThuc = TimeSpan.TryParse(dto.GioKetThuc, out var tsEnd) ? tsEnd : null;
            km.DieuKienApDung = dto.DieuKienApDung;

            if (km.TrangThai != "Háº¿t háº¡n")
            {
                km.TrangThai = dto.TrangThai;
            }

            await _context.SaveChangesAsync(); // 'await' há»£p lá»‡
            return Ok();
        }

        /// <summary>
        /// Sá»¬A Lá»–I: ThÃªm 'async Task<...>'
        /// </summary>
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteKhuyenMai(int id) // <-- Sá»¬A Lá»–I (ThÃªm async Task)
        {
            if (await _context.HoaDonKhuyenMais.AnyAsync(hkm => hkm.IdKhuyenMai == id)) // 'await' há»£p lá»‡
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a. Khuyáº¿n mÃ£i nÃ y Ä‘Ã£ Ä‘Æ°á»£c Ã¡p dá»¥ng cho hÃ³a Ä‘Æ¡n.");
            }

            var km = await _context.KhuyenMais.FindAsync(id); // 'await' há»£p lá»‡
            if (km == null) return NotFound();

            _context.KhuyenMais.Remove(km);
            await _context.SaveChangesAsync(); // 'await' há»£p lá»‡
            return Ok();
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\LichLamViecController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/lichlamviec")]
    [ApiController]
    public class LichLamViecController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public LichLamViecController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API Láº¥y danh sÃ¡ch NhÃ¢n viÃªn (cÃ²n lÃ m viá»‡c) Ä‘á»ƒ gÃ¡n lá»‹ch
        /// </summary>
        [HttpGet("all-nhanvien")]
        public async Task<IActionResult> GetAllNhanVienLookup()
        {
            var data = await _context.NhanViens
                .Where(nv => nv.TrangThaiLamViec == "Äang lÃ m viá»‡c")
                .Select(nv => new NhanVienLookupDto
                {
                    IdNhanVien = nv.IdNhanVien,
                    HoTen = nv.HoTen
                })
                .OrderBy(nv => nv.HoTen)
                .ToListAsync();
            return Ok(data);
        }

        /// <summary>
        /// API Láº¥y lá»‹ch lÃ m viá»‡c VÃ€ lá»‹ch nghá»‰ trong 1 ngÃ y
        /// </summary>
        [HttpGet("by-date")]
        public async Task<IActionResult> GetScheduleByDate([FromQuery] DateTime date)
        {
            var targetDate = date.Date;

            // 1. Láº¥y Lá»‹ch Äi LÃ m
            var caLamList = await _context.LichLamViecs
                .Include(l => l.NhanVien)
                .Include(l => l.CaLamViec)
                .Where(l => l.NgayLam == targetDate)
                .Select(l => new LichLamViecDisplayDto
                {
                    IdLich = l.IdLichLamViec,
                    IdNhanVien = l.IdNhanVien,
                    HoTenNhanVien = l.NhanVien.HoTen,
                    Ngay = l.NgayLam,
                    LoaiLich = "CaLam",
                    TenCa = l.CaLamViec.TenCa,
                    GioBatDau = l.CaLamViec.GioBatDau,
                    GioKetThuc = l.CaLamViec.GioKetThuc
                })
                .ToListAsync();

            // 2. Láº¥y Lá»‹ch ÄÃ£ Duyá»‡t Nghá»‰ (YÃªu cáº§u #5)
            var donNghiList = await _context.DonXinNghis
                .Include(d => d.NhanVien)
                .Where(d => d.TrangThai == "ÄÃ£ duyá»‡t" &&
                            targetDate >= d.NgayBatDau.Date &&
                            targetDate <= d.NgayKetThuc.Date)
                .Select(d => new LichLamViecDisplayDto
                {
                    IdLich = d.IdDonXinNghi,
                    IdNhanVien = d.IdNhanVien,
                    HoTenNhanVien = d.NhanVien.HoTen,
                    Ngay = targetDate,
                    LoaiLich = "NghiPhep",
                    LyDoNghi = d.LyDo
                })
                .ToListAsync();

            // 3. Gá»™p 2 danh sÃ¡ch
            var combinedList = caLamList.Concat(donNghiList)
                .OrderBy(l => l.HoTenNhanVien)
                .ToList();

            return Ok(combinedList);
        }

        /// <summary>
        /// API GÃ¡n lá»‹ch lÃ m viá»‡c cho nhiá»u nhÃ¢n viÃªn
        /// </summary>
        [HttpPost("assign")]
        public async Task<IActionResult> AssignSchedule([FromBody] LichLamViecCreateDto dto)
        {
            if (dto == null || !dto.DanhSachIdNhanVien.Any())
                return BadRequest("Dá»¯ liá»‡u khÃ´ng há»£p lá»‡.");

            var ngay = dto.NgayGanLich.Date;
            int successCount = 0;
            var errors = new List<string>();

            // Láº¥y danh sÃ¡ch lá»‹ch Ä‘Ã£ tá»“n táº¡i
            var existingSchedules = await _context.LichLamViecs
                .Where(l => l.NgayLam == ngay && dto.DanhSachIdNhanVien.Contains(l.IdNhanVien))
                .Select(l => l.IdNhanVien)
                .ToListAsync();

            // Láº¥y danh sÃ¡ch nghá»‰ Ä‘Ã£ tá»“n táº¡i
            var existingNghiPhep = await _context.DonXinNghis
                .Where(d => dto.DanhSachIdNhanVien.Contains(d.IdNhanVien) &&
                            d.TrangThai == "ÄÃ£ duyá»‡t" &&
                            ngay >= d.NgayBatDau.Date &&
                            ngay <= d.NgayKetThuc.Date)
                .Select(d => d.IdNhanVien)
                .ToListAsync();

            var newEntries = new List<LichLamViec>();
            foreach (var idNhanVien in dto.DanhSachIdNhanVien)
            {
                if (existingSchedules.Contains(idNhanVien))
                {
                    errors.Add($"ID {idNhanVien}: ÄÃ£ cÃ³ lá»‹ch lÃ m hÃ´m Ä‘Ã³.");
                }
                else if (existingNghiPhep.Contains(idNhanVien))
                {
                    errors.Add($"ID {idNhanVien}: Äang trong thá»i gian nghá»‰ phÃ©p.");
                }
                else
                {
                    newEntries.Add(new LichLamViec
                    {
                        IdNhanVien = idNhanVien,
                        IdCa = dto.IdCa,
                        NgayLam = ngay
                    });
                    successCount++;
                }
            }

            if (newEntries.Any())
            {
                _context.LichLamViecs.AddRange(newEntries);
                await _context.SaveChangesAsync();
            }

            return Ok(new LichLamViecAssignResponseDto
            {
                Message = $"GÃ¡n lá»‹ch thÃ nh cÃ´ng cho {successCount} nhÃ¢n viÃªn.",
                Failures = errors
            });
        }

        /// <summary>
        /// API XÃ³a 1 lá»‹ch lÃ m viá»‡c cá»¥ thá»ƒ
        /// </summary>
        [HttpDelete("{idLichLamViec}")]
        public async Task<IActionResult> DeleteSchedule(int idLichLamViec)
        {
            var entity = await _context.LichLamViecs.FindAsync(idLichLamViec);
            if (entity == null) return NotFound();

            // Kiá»ƒm tra xem Ä‘Ã£ cháº¥m cÃ´ng chÆ°a (YÃªu cáº§u #6)
            if (await _context.BangChamCongs.AnyAsync(c => c.IdLichLamViec == idLichLamViec))
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a. Lá»‹ch lÃ m viá»‡c nÃ y Ä‘Ã£ cÃ³ dá»¯ liá»‡u cháº¥m cÃ´ng.");
            }

            _context.LichLamViecs.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\LuongController.cs
// File: CafebookApi/Controllers/App/LuongController.cs (Cáº¬P NHáº¬T)

using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/luong")]
    [ApiController]
    public class LuongController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public LuongController(CafebookDbContext context)
        {
            _context = context;
        }

        #region === Helpers ===
        private async Task<CaiDatNhanSuDto> LoadHrSettingsAsync()
        {
            var settings = await _context.CaiDats
                .Where(c => c.TenCaiDat.StartsWith("HR_"))
                .ToListAsync();

            T GetSettingValue<T>(string key, T defaultValue)
            {
                var setting = settings.FirstOrDefault(s => s.TenCaiDat == key)?.GiaTri;
                if (string.IsNullOrEmpty(setting)) return defaultValue;
                try
                {
                    return (T)Convert.ChangeType(setting, typeof(T), CultureInfo.InvariantCulture);
                }
                catch
                {
                    return defaultValue;
                }
            }

            return new CaiDatNhanSuDto
            {
                // Sá»¬A: 8.0 -> 8.0m (decimal)
                GioLamChuan = GetSettingValue("HR_GioLamChuan", 8.0m),
                HeSoOT = GetSettingValue("HR_HeSoOT", 1.5m),
                PhatDiTre_Phut = GetSettingValue("HR_PhatDiTre_Phut", 5),
                PhatDiTre_HeSo = GetSettingValue("HR_PhatDiTre_HeSo", 1.0m),
                ChuyenCan_SoNgay = GetSettingValue("HR_ChuyenCan_SoNgay", 26),
                ChuyenCan_TienThuong = GetSettingValue("HR_ChuyenCan_TienThuong", 500000m),
                PhepNam_MacDinh = GetSettingValue("HR_PhepNam_MacDinh", 12)
            };
        }
        #endregion

        #region Module 6.1: Báº£ng Cháº¥m CÃ´ng
        [HttpGet("chamcong")]
        public async Task<IActionResult> GetChamCongByDate([FromQuery] DateTime date)
        {
            var hrSettings = await LoadHrSettingsAsync();
            var targetDate = date.Date;

            var query = _context.LichLamViecs
                .Include(l => l.NhanVien)
                .Include(l => l.CaLamViec)
                .Include(l => l.BangChamCongs)
                .Where(l => l.NgayLam == targetDate);

            var results = (await query.ToListAsync())
                .Select(l =>
                {
                    var chamCong = l.BangChamCongs.FirstOrDefault();
                    var gioVao = chamCong?.GioVao;
                    var gioRa = chamCong?.GioRa;
                    // Sá»¬A: 0 -> 0m (decimal)
                    var soGioLam = chamCong?.SoGioLam ?? 0m;
                    string trangThai = "ChÆ°a cháº¥m cÃ´ng";

                    if (gioVao.HasValue)
                    {
                        var gioCaVao = l.NgayLam.Add(l.CaLamViec.GioBatDau);
                        trangThai = (gioVao.Value > gioCaVao.AddMinutes(hrSettings.PhatDiTre_Phut)) ? "Äi trá»…" : "ÄÃºng giá»";
                    }

                    return new ChamCongDto
                    {
                        IdChamCong = chamCong?.IdChamCong ?? 0,
                        IdLichLamViec = l.IdLichLamViec,
                        HoTenNhanVien = l.NhanVien.HoTen,
                        TenCa = l.CaLamViec.TenCa,
                        NgayLam = l.NgayLam,
                        GioCaBatDau = l.CaLamViec.GioBatDau,
                        GioCaKetThuc = l.CaLamViec.GioKetThuc,
                        GioVao = gioVao,
                        GioRa = gioRa,
                        SoGioLam = soGioLam, // Sáº½ tá»± Ä‘á»™ng khá»›p kiá»ƒu decimal
                        TrangThai = trangThai
                    };
                })
                .OrderBy(c => c.TenCa)
                .ThenBy(c => c.HoTenNhanVien)
                .ToList();

            return Ok(results);
        }

        // HÃ m UpdateChamCong (Ä‘Ã£ sá»­a á»Ÿ láº§n trÆ°á»›c) giá»¯ nguyÃªn
        [HttpPut("chamcong")]
        public async Task<IActionResult> UpdateChamCong([FromBody] ChamCongUpdateDto dto)
        {
            BangChamCong chamCong;

            if (dto.IdChamCong == 0)
            {
                var lich = await _context.LichLamViecs.FindAsync(dto.IdLichLamViec);
                if (lich == null)
                {
                    return BadRequest("KhÃ´ng tÃ¬m tháº¥y lá»‹ch lÃ m viá»‡c tÆ°Æ¡ng á»©ng Ä‘á»ƒ táº¡o cháº¥m cÃ´ng.");
                }
                chamCong = new BangChamCong
                {
                    IdLichLamViec = dto.IdLichLamViec
                };
                _context.BangChamCongs.Add(chamCong);
            }
            else
            {
                chamCong = await _context.BangChamCongs.FindAsync(dto.IdChamCong);
                if (chamCong == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y dá»¯ liá»‡u cháº¥m cÃ´ng.");
            }

            chamCong.GioVao = dto.GioVaoMoi;
            chamCong.GioRa = dto.GioRaMoi;

            await _context.SaveChangesAsync();
            return Ok();
        }

        #endregion

        #region Module 6.3 & 6.4: TÃ­nh & Chá»‘t LÆ°Æ¡ng

        [HttpGet("calculate")]
        public async Task<IActionResult> CalculatePayroll([FromQuery] DateTime startDate, [FromQuery] DateTime endDate)
        {
            var bangKeList = new List<LuongBangKeDto>();
            var nhanViens = await _context.NhanViens
                .Where(nv => nv.TrangThaiLamViec == "Äang lÃ m viá»‡c")
                .ToListAsync();

            var hrSettings = await LoadHrSettingsAsync();

            // Sá»¬A: double -> decimal
            decimal HE_SO_OT = hrSettings.HeSoOT;
            decimal PHAT_DI_TRE_MOI_GIO = hrSettings.PhatDiTre_HeSo;
            int SO_PHUT_TRE_CHO_PHEP = hrSettings.PhatDiTre_Phut;

            foreach (var nv in nhanViens)
            {
                var ke = new LuongBangKeDto
                {
                    IdNhanVien = nv.IdNhanVien,
                    HoTenNhanVien = nv.HoTen,
                    LuongCoBan = nv.LuongCoBan,
                    ChiTiet = ""
                };

                var lichLamViecList = await _context.LichLamViecs
                    .Include(l => l.CaLamViec)
                    .Include(l => l.BangChamCongs)
                    .Where(l => l.IdNhanVien == nv.IdNhanVien &&
                                l.NgayLam >= startDate.Date &&
                                l.NgayLam <= endDate.Date)
                    .ToListAsync();

                // Sá»¬A: 0m -> decimal
                ke.TongGioLam = lichLamViecList.SelectMany(l => l.BangChamCongs).Sum(c => c.SoGioLam ?? 0m);
                ke.TienLuongGio = ke.TongGioLam * ke.LuongCoBan; // BÃ¢y giá» lÃ  decimal * decimal
                ke.ChiTiet += $"Giá»: {ke.TongGioLam:F2}h. LÆ°Æ¡ng: {ke.TienLuongGio:N0}. ";

                decimal tongPhatTuDong = 0;
                var diTreList = lichLamViecList
                    .Select(l => new {
                        GioCaVao = l.NgayLam.Add(l.CaLamViec.GioBatDau),
                        GioVao = l.BangChamCongs.FirstOrDefault()?.GioVao
                    })
                    .Where(x => x.GioVao.HasValue && x.GioVao.Value > x.GioCaVao.AddMinutes(SO_PHUT_TRE_CHO_PHEP))
                    .ToList();

                foreach (var tre in diTreList)
                {
                    var phutTre = (tre.GioVao.Value - tre.GioCaVao).TotalMinutes;
                    // (phutTre / 60.0) lÃ  double, Ã©p kiá»ƒu (decimal) lÃ  Ä‘Ãºng
                    tongPhatTuDong += (decimal)(phutTre / 60.0) * ke.LuongCoBan * PHAT_DI_TRE_MOI_GIO;
                }
                if (tongPhatTuDong > 0) ke.ChiTiet += $"Pháº¡t trá»…: {tongPhatTuDong:N0}. ";

                decimal tongThuongTuDong = 0;
                var otList = lichLamViecList
                    .Select(l => new {
                        GioCaRa = l.NgayLam.Add(l.CaLamViec.GioKetThuc),
                        GioRa = l.BangChamCongs.FirstOrDefault()?.GioRa
                    })
                    .Where(x => x.GioRa.HasValue && x.GioRa.Value > x.GioCaRa)
                    .ToList();

                foreach (var ot in otList)
                {
                    var phutOT = (ot.GioRa.Value - ot.GioCaRa).TotalMinutes;
                    // (phutOT / 60.0) lÃ  double, Ã©p kiá»ƒu (decimal) lÃ  Ä‘Ãºng
                    tongThuongTuDong += (decimal)(phutOT / 60.0) * ke.LuongCoBan * HE_SO_OT;
                }
                if (tongThuongTuDong > 0) ke.ChiTiet += $"ThÆ°á»Ÿng OT: {tongThuongTuDong:N0}. ";

                // Sá»¬A: (cc.SoGioLam ?? 0) -> (cc.SoGioLam ?? 0m)
                int soNgayLamViec = lichLamViecList
                                        .Count(l => l.BangChamCongs.Any(cc => (cc.SoGioLam ?? 0m) > 0));

                if (soNgayLamViec >= hrSettings.ChuyenCan_SoNgay)
                {
                    tongThuongTuDong += hrSettings.ChuyenCan_TienThuong;
                    ke.ChiTiet += $"ThÆ°á»Ÿng CC: {hrSettings.ChuyenCan_TienThuong:N0}. ";
                }

                var thuongPhatManual = await _context.PhieuThuongPhats
                    .Where(p => p.IdNhanVien == nv.IdNhanVien && p.IdPhieuLuong == null)
                    .ToListAsync();

                decimal tongThuongManual = thuongPhatManual.Where(p => p.SoTien > 0).Sum(p => p.SoTien);
                decimal tongPhatManual = thuongPhatManual.Where(p => p.SoTien < 0).Sum(p => p.SoTien) * -1;

                if (tongThuongManual > 0) ke.ChiTiet += $"ThÆ°á»Ÿng khÃ¡c: {tongThuongManual:N0}. ";
                if (tongPhatManual > 0) ke.ChiTiet += $"Pháº¡t khÃ¡c: {tongPhatManual:N0}. ";

                ke.TongThuong = tongThuongTuDong + tongThuongManual;
                ke.TongPhat = tongPhatTuDong + tongPhatManual;
                ke.ThucLanh = ke.TienLuongGio + ke.TongThuong - ke.TongPhat;

                bangKeList.Add(ke);
            }

            return Ok(bangKeList);
        }

        [HttpPost("finalize")]
        public async Task<IActionResult> FinalizePayroll([FromBody] LuongFinalizeDto dto)
        {
            if (dto == null || !dto.DanhSachBangKe.Any())
                return BadRequest("Dá»¯ liá»‡u chá»‘t lÆ°Æ¡ng khÃ´ng há»£p lá»‡.");

            var existing = await _context.PhieuLuongs
                .AnyAsync(p => p.Thang == dto.Thang && p.Nam == dto.Nam);
            if (existing)
                return Conflict($"LÆ°Æ¡ng ThÃ¡ng {dto.Thang}/{dto.Nam} Ä‘Ã£ Ä‘Æ°á»£c chá»‘t trÆ°á»›c Ä‘Ã³.");

            var newPhieuLuongs = new List<PhieuLuong>();

            using (var transaction = await _context.Database.BeginTransactionAsync())
            {
                try
                {
                    foreach (var ke in dto.DanhSachBangKe)
                    {
                        var phieuLuong = new PhieuLuong
                        {
                            IdNhanVien = ke.IdNhanVien,
                            Thang = dto.Thang,
                            Nam = dto.Nam,
                            LuongCoBan = ke.LuongCoBan,
                            TongGioLam = ke.TongGioLam, // Sá»¬A: Bá» Ã©p kiá»ƒu (decimal) vÃ¬ cáº£ 2 Ä‘Ã£ lÃ  decimal
                            TienThuong = ke.TongThuong,
                            KhauTru = ke.TongPhat,
                            ThucLanh = ke.ThucLanh,
                            NgayTao = DateTime.Now,
                            TrangThai = "ÄÃ£ chá»‘t"
                        };
                        newPhieuLuongs.Add(phieuLuong);
                    }
                    _context.PhieuLuongs.AddRange(newPhieuLuongs);
                    await _context.SaveChangesAsync();

                    for (int i = 0; i < newPhieuLuongs.Count; i++)
                    {
                        var phieuLuongMoi = newPhieuLuongs[i];
                        var keTuongUng = dto.DanhSachBangKe[i];

                        var phieuThuongPhats = await _context.PhieuThuongPhats
                            .Where(p => p.IdNhanVien == keTuongUng.IdNhanVien && p.IdPhieuLuong == null)
                            .ToListAsync();

                        foreach (var p in phieuThuongPhats)
                        {
                            p.IdPhieuLuong = phieuLuongMoi.IdPhieuLuong;
                        }
                    }
                    await _context.SaveChangesAsync();

                    await transaction.CommitAsync();
                    return Ok(new { message = $"Chá»‘t lÆ°Æ¡ng ThÃ¡ng {dto.Thang}/{dto.Nam} thÃ nh cÃ´ng cho {newPhieuLuongs.Count} nhÃ¢n viÃªn." });
                }
                catch (Exception ex)
                {
                    await transaction.RollbackAsync();
                    return StatusCode(500, $"Lá»—i nghiÃªm trá»ng khi chá»‘t lÆ°Æ¡ng: {ex.Message}");
                }
            }
        }
        #endregion
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\NguyenLieuController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/nguyenlieu")]
    [ApiController]
    public class NguyenLieuController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public NguyenLieuController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API Láº¥y táº¥t cáº£ NguyÃªn Liá»‡u (kÃ¨m tá»“n kho)
        /// </summary>
        [HttpGet("all")]
        public async Task<IActionResult> GetAllNguyenLieu()
        {
            var data = await _context.NguyenLieus
                .Select(nl => new NguyenLieuCrudDto
                {
                    IdNguyenLieu = nl.IdNguyenLieu,
                    TenNguyenLieu = nl.TenNguyenLieu,
                    DonViTinh = nl.DonViTinh,
                    TonKhoToiThieu = nl.TonKhoToiThieu,
                    TonKho = nl.TonKho // Láº¥y sá»‘ lÆ°á»£ng tá»“n
                })
                .OrderBy(nl => nl.TenNguyenLieu)
                .ToListAsync();
            return Ok(data);
        }

        /// <summary>
        /// API ThÃªm má»›i NguyÃªn Liá»‡u
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> CreateNguyenLieu([FromBody] NguyenLieuUpdateRequestDto dto)
        {
            if (string.IsNullOrWhiteSpace(dto.TenNguyenLieu) || string.IsNullOrWhiteSpace(dto.DonViTinh))
            {
                return BadRequest("TÃªn vÃ  ÄÆ¡n vá»‹ tÃ­nh lÃ  báº¯t buá»™c.");
            }

            if (await _context.NguyenLieus.AnyAsync(nl => nl.TenNguyenLieu.ToLower() == dto.TenNguyenLieu.ToLower()))
            {
                return Conflict("TÃªn nguyÃªn liá»‡u Ä‘Ã£ tá»“n táº¡i.");
            }

            var entity = new NguyenLieu
            {
                TenNguyenLieu = dto.TenNguyenLieu,
                DonViTinh = dto.DonViTinh,
                TonKhoToiThieu = dto.TonKhoToiThieu,
                TonKho = 0 // Má»›i táº¡o
            };

            _context.NguyenLieus.Add(entity);
            await _context.SaveChangesAsync();
            return Ok(entity);
        }

        /// <summary>
        /// API Cáº­p nháº­t NguyÃªn Liá»‡u
        /// </summary>
        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateNguyenLieu(int id, [FromBody] NguyenLieuUpdateRequestDto dto)
        {
            var entity = await _context.NguyenLieus.FindAsync(id);
            if (entity == null) return NotFound();

            if (await _context.NguyenLieus.AnyAsync(nl => nl.TenNguyenLieu.ToLower() == dto.TenNguyenLieu.ToLower() && nl.IdNguyenLieu != id))
            {
                return Conflict("TÃªn nguyÃªn liá»‡u Ä‘Ã£ tá»“n táº¡i.");
            }

            entity.TenNguyenLieu = dto.TenNguyenLieu;
            entity.DonViTinh = dto.DonViTinh;
            entity.TonKhoToiThieu = dto.TonKhoToiThieu;

            await _context.SaveChangesAsync();
            return Ok();
        }

        /// <summary>
        /// API XÃ³a NguyÃªn Liá»‡u
        /// </summary>
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteNguyenLieu(int id)
        {
            // Kiá»ƒm tra rÃ ng buá»™c
            if (await _context.DinhLuongs.AnyAsync(d => d.IdNguyenLieu == id))
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a. NguyÃªn liá»‡u nÃ y Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng trong Äá»‹nh lÆ°á»£ng sáº£n pháº©m.");
            }
            if (await _context.ChiTietNhapKhos.AnyAsync(d => d.IdNguyenLieu == id))
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a. NguyÃªn liá»‡u nÃ y Ä‘Ã£ cÃ³ trong lá»‹ch sá»­ Nháº­p kho.");
            }

            var entity = await _context.NguyenLieus.FindAsync(id);
            if (entity == null) return NotFound();

            _context.NguyenLieus.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\NhanVienController.cs
// Táº­p tin: CafebookApi/Controllers/App/NhanVienController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using CafebookModel.Utils; // <-- THÃŠM
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.IO; // <-- THÃŠM
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Hosting; // <-- THÃŠM
using Microsoft.Extensions.Configuration; // <-- THÃŠM
using Microsoft.AspNetCore.Http; // <-- THÃŠM

namespace CafebookApi.Controllers.App
{
    [Route("api/app/nhanvien")]
    [ApiController]
    public class NhanVienController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        // --- Sá»¬A: THÃŠM CÃC BIáº¾N Äá»‚ Xá»¬ LÃ FILE/URL ---
        private readonly IWebHostEnvironment _env;
        private readonly string _baseUrl;

        public NhanVienController(CafebookDbContext context, IWebHostEnvironment env, IConfiguration config) // <-- Sá»¬A
Â  Â  Â  Â  {
            _context = context;

            // --- THÃŠM LOGIC KHá»I Táº O (GIá»NG SACHCONTROLLER) ---
            _env = env;
            if (string.IsNullOrEmpty(_env.WebRootPath))
            {
                _env.WebRootPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot");
                if (!Directory.Exists(_env.WebRootPath))
                {
                    Directory.CreateDirectory(_env.WebRootPath);
                }
            }
            _baseUrl = config.GetValue<string>("Kestrel:Endpoints:Http:Url")
                       ?? "http://127.0.0.1:5166"; // <-- DÃ¹ng 127.0.0.1
Â  Â  Â  Â  }

        // === THÃŠM 5 HÃ€M HELPER Xá»¬ LÃ FILE ===
        [ApiExplorerSettings(IgnoreApi = true)]
        private string? GetFullImageUrl(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath))
                return null;
            return $"{_baseUrl}{relativePath.Replace(Path.DirectorySeparatorChar, '/')}";
        }
        [ApiExplorerSettings(IgnoreApi = true)]
        private string GenerateFileName(int id, string ten)
        {
            string slug = SlugifyUtil.GenerateSlug(ten);
            return $"{id}_{slug}.jpg";
        }
        [ApiExplorerSettings(IgnoreApi = true)]
        private void DeleteOldImage(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath)) return;
            var fileName = relativePath.TrimStart('/');
            var fullPath = Path.Combine(_env.WebRootPath, fileName.Replace('/', Path.DirectorySeparatorChar));
            if (System.IO.File.Exists(fullPath))
            {
                System.IO.File.Delete(fullPath);
            }
        }
        [ApiExplorerSettings(IgnoreApi = true)]
        private void RenameImage(string oldRelativePath, string newRelativePath)
        {
            if (string.IsNullOrEmpty(oldRelativePath) || string.IsNullOrEmpty(newRelativePath) || oldRelativePath == newRelativePath)
                return;
            var oldFullPath = Path.Combine(_env.WebRootPath, oldRelativePath.TrimStart('/').Replace('/', Path.DirectorySeparatorChar));
            var newFullPath = Path.Combine(_env.WebRootPath, newRelativePath.TrimStart('/').Replace('/', Path.DirectorySeparatorChar));
            if (System.IO.File.Exists(oldFullPath))
            {
                System.IO.File.Move(oldFullPath, newFullPath);
            }
        }
        [ApiExplorerSettings(IgnoreApi = true)]
        private async Task<string> SaveImageFromFile(IFormFile file, string fileName, string relativeDir)
        {
            var saveDir = Path.Combine(_env.WebRootPath, relativeDir);
            if (!Directory.Exists(saveDir))
            {
                Directory.CreateDirectory(saveDir);
            }
            var fullSavePath = Path.Combine(saveDir, fileName);
            await using (var stream = new FileStream(fullSavePath, FileMode.Create))
            {
                await file.CopyToAsync(stream);
            }
            return $"/{relativeDir.Replace(Path.DirectorySeparatorChar, '/')}/{fileName}";
        }
        // ===================================

Â  Â  Â  Â  /// <summary>
Â  Â  Â  Â  /// API Láº¥y bá»™ lá»c (Vai TrÃ²)
Â  Â  Â  Â  /// </summary>
Â  Â  Â  Â  [HttpGet("filters")]
        public async Task<IActionResult> GetFilters()
        {
Â  Â  Â  Â  Â  Â  // (Giá»¯ nguyÃªn)
Â  Â  Â  Â  Â  Â  var filters = new NhanSuFiltersDto
            {
                VaiTros = await _context.VaiTros
          .Select(v => new FilterLookupDto { Id = v.IdVaiTro, Ten = v.TenVaiTro })
          .OrderBy(v => v.Ten)
          .ToListAsync()
            };
            return Ok(filters);
        }

Â  Â  Â  Â  /// <summary>
Â  Â  Â  Â  /// API Láº¥y danh sÃ¡ch NhÃ¢n ViÃªn (cÃ³ lá»c/tÃ¬m kiáº¿m)
Â  Â  Â  Â  /// </summary>
Â  Â  Â  Â  [HttpGet("search")]
        public async Task<IActionResult> SearchNhanVien(
      [FromQuery] string? searchText,
      [FromQuery] int? vaiTroId)
        {
Â  Â  Â  Â  Â  Â  // (Giá»¯ nguyÃªn, khÃ´ng tráº£ vá» URL áº£nh á»Ÿ Ä‘Ã¢y cho nháº¹)
Â  Â  Â  Â  Â  Â  var query = _context.NhanViens
        .Include(nv => nv.VaiTro)
        .AsQueryable();

            if (vaiTroId.HasValue && vaiTroId > 0)
            {
                query = query.Where(nv => nv.IdVaiTro == vaiTroId);
            }

            if (!string.IsNullOrEmpty(searchText))
            {
                string searchLower = searchText.ToLower();
                query = query.Where(nv =>
                  nv.HoTen.ToLower().Contains(searchLower) ||
                  nv.TenDangNhap.ToLower().Contains(searchLower)
                );
            }

            var results = await query
              .Select(nv => new NhanVienGridDto
              {
                  IdNhanVien = nv.IdNhanVien,
                  HoTen = nv.HoTen,
                  TenVaiTro = nv.VaiTro.TenVaiTro,
                  LuongCoBan = nv.LuongCoBan,
                  TrangThaiLamViec = nv.TrangThaiLamViec
              })
              .OrderBy(nv => nv.HoTen)
              .ToListAsync();

            return Ok(results);
        }

Â  Â  Â  Â  /// <summary>
Â  Â  Â  Â  /// Sá»¬A: API Láº¥y chi tiáº¿t 1 NhÃ¢n viÃªn
Â  Â  Â  Â  /// </summary>
Â  Â  Â  Â  [HttpGet("details/{id}")]
        public async Task<IActionResult> GetDetails(int id)
        {
            var nv = await _context.NhanViens.FindAsync(id);
            if (nv == null) return NotFound();

Â  Â  Â  Â  Â  Â  // Sá»¬A: Tráº£ vá» NhanVienDetailDto (chá»©a URL)
Â  Â  Â  Â  Â  Â  var dto = new NhanVienDetailDto
            {
                IdNhanVien = nv.IdNhanVien,
                HoTen = nv.HoTen,
                TenDangNhap = nv.TenDangNhap,
                IdVaiTro = nv.IdVaiTro,
                LuongCoBan = nv.LuongCoBan,
                TrangThaiLamViec = nv.TrangThaiLamViec,
                SoDienThoai = nv.SoDienThoai,
                Email = nv.Email,
                DiaChi = nv.DiaChi,
                NgayVaoLam = nv.NgayVaoLam,
                AnhDaiDienUrl = GetFullImageUrl(nv.AnhDaiDien) // <-- Sá»¬A: DÃ¹ng Helper
Â  Â  Â  Â  Â  Â  };
            return Ok(dto);
        }

Â  Â  Â  Â  /// <summary>
Â  Â  Â  Â  /// Sá»¬A: API ThÃªm má»›i NhÃ¢n viÃªn
Â  Â  Â  Â  /// </summary>
Â  Â  Â  Â  [HttpPost]
        public async Task<IActionResult> CreateNhanVien([FromForm] NhanVienUpdateRequestDto dto) // <-- Sá»¬A [FromForm]
Â  Â  Â  Â  {
            if (string.IsNullOrWhiteSpace(dto.TenDangNhap) || string.IsNullOrWhiteSpace(dto.MatKhau))
            {
                return BadRequest("TÃªn Ä‘Äƒng nháº­p vÃ  Máº­t kháº©u lÃ  báº¯t buá»™c khi táº¡o má»›i.");
            }

            if (await _context.NhanViens.AnyAsync(nv => nv.TenDangNhap.ToLower() == dto.TenDangNhap.ToLower()))
            {
                return Conflict("TÃªn Ä‘Äƒng nháº­p Ä‘Ã£ tá»“n táº¡i.");
            }

            var entity = new NhanVien
            {
                HoTen = dto.HoTen,
                TenDangNhap = dto.TenDangNhap,
                MatKhau = dto.MatKhau,
                IdVaiTro = dto.IdVaiTro,
                LuongCoBan = dto.LuongCoBan,
                TrangThaiLamViec = dto.TrangThaiLamViec,
                SoDienThoai = dto.SoDienThoai,
                Email = dto.Email,
                DiaChi = dto.DiaChi,
                NgayVaoLam = dto.NgayVaoLam,
                AnhDaiDien = null // Sá»¬A: Táº¡m thá»i null
Â  Â  Â  Â  Â  Â  };

            _context.NhanViens.Add(entity);
            await _context.SaveChangesAsync(); // LÆ°u láº§n 1 Ä‘á»ƒ láº¥y ID

            // Sá»¬A: ThÃªm logic lÆ°u file
            if (dto.AnhDaiDienUpload != null)
            {
                try
                {
                    string fileName = GenerateFileName(entity.IdNhanVien, entity.HoTen);
                    // DÃ¹ng thÆ° má»¥c avatarNV
                    string relativePath = await SaveImageFromFile(dto.AnhDaiDienUpload, fileName, HinhAnhPaths.UrlAvatarNV.TrimStart('/'));
                    entity.AnhDaiDien = relativePath; // Sá»­a: LÆ°u path
                    await _context.SaveChangesAsync(); // LÆ°u láº§n 2 (cáº­p nháº­t path)
                }
                catch (Exception ex)
                {
                    // (Xá»­ lÃ½ lá»—i náº¿u lÆ°u áº£nh tháº¥t báº¡i)
                    return StatusCode(500, $"Lá»—i khi lÆ°u áº£nh: {ex.Message}");
                }
            }

            return Ok(entity); // Tráº£ vá» entity má»›i
Â  Â  Â  Â  }

Â  Â  Â  Â  /// <summary>
Â  Â  Â  Â  /// Sá»¬A: API Cáº­p nháº­t NhÃ¢n viÃªn
Â  Â  Â  Â  /// </summary>
Â  Â  Â  Â  [HttpPut("{id}")]
        public async Task<IActionResult> UpdateNhanVien(int id, [FromForm] NhanVienUpdateRequestDto dto) // <-- Sá»¬A [FromForm]
Â  Â  Â  Â  {
            var entity = await _context.NhanViens.FindAsync(id);
            if (entity == null) return NotFound();

            if (await _context.NhanViens.AnyAsync(nv => nv.TenDangNhap.ToLower() == dto.TenDangNhap.ToLower() && nv.IdNhanVien != id))
            {
                return Conflict("TÃªn Ä‘Äƒng nháº­p Ä‘Ã£ tá»“n táº¡i.");
            }

Â  Â  Â  Â  Â  Â  // Sá»¬A: Logic xá»­ lÃ½ file
            var oldImagePath = entity.AnhDaiDien;
            var oldTen = entity.HoTen;
            bool isImageUpload = dto.AnhDaiDienUpload != null;
            bool isNameChange = dto.HoTen != oldTen;

            // Cáº­p nháº­t cÃ¡c trÆ°á»ng text
Â  Â  Â  Â  Â  Â  entity.HoTen = dto.HoTen;
            entity.TenDangNhap = dto.TenDangNhap;
            entity.IdVaiTro = dto.IdVaiTro;
Â  Â  Â  Â  Â  Â  // ... (gÃ¡n cÃ¡c trÆ°á»ng khÃ¡c)
            entity.LuongCoBan = dto.LuongCoBan;
            entity.TrangThaiLamViec = dto.TrangThaiLamViec;
            entity.SoDienThoai = dto.SoDienThoai;
            entity.Email = dto.Email;
            entity.DiaChi = dto.DiaChi;
            entity.NgayVaoLam = dto.NgayVaoLam;
            if (!string.IsNullOrWhiteSpace(dto.MatKhau))
            {
                entity.MatKhau = dto.MatKhau;
            }

            // Xá»­ lÃ½ file
            string newFileName = GenerateFileName(entity.IdNhanVien, entity.HoTen);
            string newRelativePath = $"/{HinhAnhPaths.UrlAvatarNV.TrimStart('/')}/{newFileName}";

            if (isImageUpload)
            {
                DeleteOldImage(oldImagePath);
                entity.AnhDaiDien = await SaveImageFromFile(dto.AnhDaiDienUpload, newFileName, HinhAnhPaths.UrlAvatarNV.TrimStart('/'));
            }
            else if (dto.XoaAnhDaiDien)
            {
                DeleteOldImage(oldImagePath);
                entity.AnhDaiDien = null;
            }
            else if (isNameChange && !string.IsNullOrEmpty(oldImagePath))
            {
                RenameImage(oldImagePath, newRelativePath);
                entity.AnhDaiDien = newRelativePath;
            }

            await _context.SaveChangesAsync();
            return Ok();
        }

Â  Â  Â  Â  /// <summary>
Â  Â  Â  Â  /// API Cáº­p nháº­t tráº¡ng thÃ¡i (NgÆ°ng hoáº¡t Ä‘á»™ng)
Â  Â  Â  Â  /// </summary>
Â  Â  Â  Â  [HttpPut("update-status/{id}")]
        public async Task<IActionResult> UpdateStatus(int id, [FromBody] string newStatus)
        {
Â  Â  Â  Â  Â  Â  // (Giá»¯ nguyÃªn)
Â  Â  Â  Â  Â  Â  var entity = await _context.NhanViens.FindAsync(id);
            if (entity == null) return NotFound();

            entity.TrangThaiLamViec = newStatus;
            await _context.SaveChangesAsync();
            return Ok();
        }

Â  Â  Â  Â  /// <summary>
Â  Â  Â  Â  /// Sá»¬A: API XÃ³a NhÃ¢n viÃªn (Logic kiá»ƒm tra)
Â  Â  Â  Â  /// </summary>
Â  Â  Â  Â  [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteNhanVien(int id)
        {
            // Kiá»ƒm tra rÃ ng buá»™c
            if (await _context.LichLamViecs.AnyAsync(l => l.IdNhanVien == id) ||
                await _context.PhieuLuongs.AnyAsync(p => p.IdNhanVien == id) ||
                await _context.HoaDons.AnyAsync(h => h.IdNhanVien == id))
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a. NhÃ¢n viÃªn nÃ y Ä‘Ã£ cÃ³ dá»¯ liá»‡u Lá»‹ch lÃ m viá»‡c, LÆ°Æ¡ng hoáº·c HÃ³a Ä‘Æ¡n. Vui lÃ²ng chá»n 'Nghá»‰ viá»‡c'.");
            }

            var entity = await _context.NhanViens.FindAsync(id);
            if (entity == null) return NotFound();

            // Sá»¬A: ThÃªm xÃ³a file
            DeleteOldImage(entity.AnhDaiDien);

            _context.NhanViens.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\PhanQuyenController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/phanquyen")]
    [ApiController]
    public class PhanQuyenController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public PhanQuyenController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API Láº¥y Táº¤T Cáº¢ cÃ¡c Quyá»n cÃ³ trong há»‡ thá»‘ng
        /// </summary>
        [HttpGet("all-permissions")]
        public async Task<IActionResult> GetAllPermissions()
        {
            var data = await _context.Quyens
                .AsNoTracking()
                .Select(q => new QuyenDto
                {
                    IdQuyen = q.IdQuyen,
                    TenQuyen = q.TenQuyen,
                    NhomQuyen = q.NhomQuyen
                })
                .OrderBy(q => q.NhomQuyen)
                .ThenBy(q => q.TenQuyen)
                .ToListAsync();
            return Ok(data);
        }

        /// <summary>
        /// API Láº¥y danh sÃ¡ch IdQuyen Ä‘Ã£ Ä‘Æ°á»£c gÃ¡n cho má»™t VaiTrÃ²
        /// </summary>
        [HttpGet("for-role/{idVaiTro}")]
        public async Task<IActionResult> GetPermissionsForRole(int idVaiTro)
        {
            var data = await _context.VaiTroQuyens
                .Where(vtq => vtq.IdVaiTro == idVaiTro)
                .Select(vtq => vtq.IdQuyen)
                .ToListAsync();
            return Ok(data);
        }

        /// <summary>
        /// API Cáº­p nháº­t (Sync) toÃ n bá»™ quyá»n cho má»™t Vai TrÃ²
        /// </summary>
        [HttpPut("update")]
        public async Task<IActionResult> UpdatePermissions([FromBody] PhanQuyenDto dto)
        {
            if (dto == null) return BadRequest("Dá»¯ liá»‡u khÃ´ng há»£p lá»‡.");

            // 1. Láº¥y cÃ¡c quyá»n hiá»‡n táº¡i
            var currentPermissions = await _context.VaiTroQuyens
                .Where(vtq => vtq.IdVaiTro == dto.IdVaiTro)
                .ToListAsync();

            var currentIdList = currentPermissions.Select(p => p.IdQuyen).ToList();
            var newIdList = dto.DanhSachIdQuyen;

            // 2. TÃ¬m cÃ¡c quyá»n cáº§n XÃ“A
            var toDelete = currentPermissions
                .Where(p => !newIdList.Contains(p.IdQuyen))
                .ToList();

            // 3. TÃ¬m cÃ¡c quyá»n cáº§n THÃŠM
            var toAddIds = newIdList
                .Where(id => !currentIdList.Contains(id))
                .ToList();

            // 4. Thá»±c thi
            if (toDelete.Any())
            {
                _context.VaiTroQuyens.RemoveRange(toDelete);
            }

            if (toAddIds.Any())
            {
                var toAddEntities = toAddIds.Select(id => new VaiTro_Quyen
                {
                    IdVaiTro = dto.IdVaiTro,
                    IdQuyen = id
                });
                await _context.VaiTroQuyens.AddRangeAsync(toAddEntities);
            }

            await _context.SaveChangesAsync();
            return Ok(new { message = "Cáº­p nháº­t phÃ¢n quyá»n thÃ nh cÃ´ng!" });
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\PhatLuongController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/phatluong")] // Äá»•i route thÃ nh /app/phatluong
    [ApiController]
    public class PhatLuongController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public PhatLuongController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// Láº¥y danh sÃ¡ch cÃ¡c phiáº¿u lÆ°Æ¡ng Ä‘Ã£ chá»‘t hoáº·c Ä‘Ã£ phÃ¡t theo ká»³
        /// </summary>
        [HttpGet("danhsach")]
        public async Task<IActionResult> GetDanhSachPhieuLuong([FromQuery] int thang, [FromQuery] int nam)
        {
            var query = _context.PhieuLuongs
                .Include(p => p.NhanVien)
                .Where(p => p.Thang == thang && p.Nam == nam &&
                             (p.TrangThai == "ÄÃ£ chá»‘t" || p.TrangThai == "ÄÃ£ phÃ¡t"))
                .OrderByDescending(p => p.TrangThai) // Æ¯u tiÃªn "ÄÃ£ chá»‘t" lÃªn Ä‘áº§u
                .ThenBy(p => p.NhanVien.HoTen);

            var result = await query.Select(p => new PhieuLuongDto
            {
                IdPhieuLuong = p.IdPhieuLuong,
                IdNhanVien = p.IdNhanVien,
                HoTenNhanVien = p.NhanVien.HoTen,
                Thang = p.Thang,
                Nam = p.Nam,
                TongGioLam = p.TongGioLam,
                ThucLanh = p.ThucLanh,
                NgayChot = p.NgayTao, // Láº¥y NgayTao lÃ m NgayChot
                TrangThai = p.TrangThai
            }).ToListAsync();

            return Ok(result);
        }

        /// <summary>
        /// Láº¥y chi tiáº¿t 1 phiáº¿u lÆ°Æ¡ng Ä‘á»ƒ xem hoáº·c in
        /// </summary>
        [HttpGet("chitiet/{id}")]
        public async Task<IActionResult> GetChiTietPhieuLuong(int id)
        {
            var phieu = await _context.PhieuLuongs
                .Include(p => p.NhanVien)
                .Include(p => p.NguoiPhat) // Join vá»›i NhanVien qua IdNguoiPhat
                .Where(p => p.IdPhieuLuong == id)
                .Select(p => new PhieuLuongChiTietDto
                {
                    IdPhieuLuong = p.IdPhieuLuong,
                    HoTenNhanVien = p.NhanVien.HoTen,
                    Thang = p.Thang,
                    Nam = p.Nam,
                    LuongCoBan = p.LuongCoBan,
                    TongGioLam = p.TongGioLam,
                    TienThuong = p.TienThuong ?? 0,
                    KhauTru = p.KhauTru ?? 0,
                    ThucLanh = p.ThucLanh,
                    TrangThai = p.TrangThai,
                    NgayPhat = p.NgayPhatLuong,
                    TenNguoiPhat = p.NguoiPhat != null ? p.NguoiPhat.HoTen : null
                })
                .FirstOrDefaultAsync();

            if (phieu == null)
            {
                return NotFound("KhÃ´ng tÃ¬m tháº¥y phiáº¿u lÆ°Æ¡ng.");
            }

            return Ok(phieu);
        }

        /// <summary>
        /// XÃ¡c nháº­n Ä‘Ã£ phÃ¡t lÆ°Æ¡ng cho 1 phiáº¿u lÆ°Æ¡ng
        /// </summary>
        [HttpPut("xacnhan/{id}")]
        public async Task<IActionResult> XacNhanPhatLuong(int id, [FromBody] PhatLuongXacNhanDto dto)
        {
            var phieu = await _context.PhieuLuongs.FindAsync(id);

            if (phieu == null)
            {
                return NotFound("KhÃ´ng tÃ¬m tháº¥y phiáº¿u lÆ°Æ¡ng.");
            }

            if (phieu.TrangThai == "ÄÃ£ phÃ¡t")
            {
                return BadRequest("Phiáº¿u lÆ°Æ¡ng nÃ y Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c nháº­n phÃ¡t trÆ°á»›c Ä‘Ã³.");
            }

            phieu.TrangThai = "ÄÃ£ phÃ¡t";
            phieu.NgayPhatLuong = DateTime.Now;
            phieu.IdNguoiPhat = dto.IdNguoiPhat;

            // (ThÃªm ghi log LichSuHeThong náº¿u cÃ³)

            await _context.SaveChangesAsync();

            return Ok(new { message = "XÃ¡c nháº­n phÃ¡t lÆ°Æ¡ng thÃ nh cÃ´ng." });
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\SachController.cs
// Táº­p tin: CafebookApi/Controllers/App/SachController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using CafebookModel.Utils;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Data.SqlClient;
using Microsoft.EntityFrameworkCore;
using System;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using Microsoft.AspNetCore.Http; // <-- THÃŠM

namespace CafebookApi.Controllers.App
{
    [Route("api/app/sach")]
    [ApiController]
    public class SachController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private readonly IWebHostEnvironment _env;
        private readonly string _baseUrl;

        public SachController(CafebookDbContext context, IWebHostEnvironment env, IConfiguration config)
        {
            _context = context;
            _env = env;

            // Äáº£m báº£o WebRootPath tá»“n táº¡i
            if (string.IsNullOrEmpty(_env.WebRootPath))
            {
                _env.WebRootPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot");
                if (!Directory.Exists(_env.WebRootPath))
                {
                    Directory.CreateDirectory(_env.WebRootPath);
                }
            }

            _baseUrl = config.GetValue<string>("Kestrel:Endpoints:Http:Url") ?? "http://127.0.0.1:5166";
        }

        // === 5 HÃ€M HELPER Xá»¬ LÃ FILE ===

        // HELPER 1: Táº O URL TUYá»†T Äá»I (Giá»¯ nguyÃªn)
        private string? GetFullImageUrl(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath))
                return null;
            return $"{_baseUrl}{relativePath.Replace(Path.DirectorySeparatorChar, '/')}";
        }

        // HELPER 2: Táº O TÃŠN FILE (Giá»¯ nguyÃªn)
        private string GenerateFileName(int id, string ten)
        {
            string slug = SlugifyUtil.GenerateSlug(ten);
            return $"{id}_{slug}.jpg";
        }

        // HELPER 3: XÃ“A FILE CÅ¨ (Giá»¯ nguyÃªn)
        private void DeleteOldImage(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath)) return;
            var fileName = relativePath.TrimStart('/');
            var fullPath = Path.Combine(_env.WebRootPath, fileName.Replace('/', Path.DirectorySeparatorChar));
            if (System.IO.File.Exists(fullPath))
            {
                System.IO.File.Delete(fullPath);
            }
        }

        // HELPER 4: Äá»”I TÃŠN FILE (Giá»¯ nguyÃªn)
        private void RenameImage(string oldRelativePath, string newRelativePath)
        {
            if (string.IsNullOrEmpty(oldRelativePath) || string.IsNullOrEmpty(newRelativePath) || oldRelativePath == newRelativePath)
                return;
            var oldFileName = oldRelativePath.TrimStart('/');
            var oldFullPath = Path.Combine(_env.WebRootPath, oldFileName.Replace('/', Path.DirectorySeparatorChar));
            var newFileName = newRelativePath.TrimStart('/');
            var newFullPath = Path.Combine(_env.WebRootPath, newFileName.Replace('/', Path.DirectorySeparatorChar));
            if (System.IO.File.Exists(oldFullPath))
            {
                System.IO.File.Move(oldFullPath, newFullPath);
            }
        }

        // HELPER 5 (Sá»¬A): LÆ¯U FILE Tá»ª IFormFile
        // (ÄÃ£ xÃ³a SaveImageFromBase64)
        private async Task<string> SaveImageFromFile(IFormFile file, string fileName, string relativeDir)
        {
            var saveDir = Path.Combine(_env.WebRootPath, relativeDir);
            if (!Directory.Exists(saveDir))
            {
                Directory.CreateDirectory(saveDir);
            }
            var fullSavePath = Path.Combine(saveDir, fileName);

            // DÃ¹ng stream Ä‘á»ƒ copy file
            await using (var stream = new FileStream(fullSavePath, FileMode.Create))
            {
                await file.CopyToAsync(stream);
            }

            return $"/{relativeDir.Replace(Path.DirectorySeparatorChar, '/')}/{fileName}";
        }
        // =============================

        [HttpGet("filters")] // <-- PHáº¢I LÃ€ [HttpGet]
        public async Task<IActionResult> GetSachFilters()
        {
            var theLoais = await _context.TheLoais
                .Select(t => new FilterLookupDto { Id = t.IdTheLoai, Ten = t.TenTheLoai })
                .OrderBy(t => t.Ten)
                .ToListAsync();

            var tacGias = await _context.TacGias
                .Select(t => new FilterLookupDto { Id = t.IdTacGia, Ten = t.TenTacGia })
                .OrderBy(t => t.Ten)
                .ToListAsync();

            var nhaXuatBans = await _context.NhaXuatBans
                .Select(t => new FilterLookupDto { Id = t.IdNhaXuatBan, Ten = t.TenNhaXuatBan })
                .OrderBy(t => t.Ten)
                .ToListAsync();

            var dto = new SachFiltersDto
            {
                TheLoais = theLoais,
                TacGias = tacGias,
                NhaXuatBans = nhaXuatBans
            };
            return Ok(dto);
        }

        #region API SÃ¡ch (ÄÃ£ sá»­a)

        // (HÃ m SearchSach vÃ  GetSachDetails giá»¯ nguyÃªn logic, chá»‰ Ä‘áº£m báº£o tráº£ vá» URL)
        [HttpGet("search")]
        public async Task<IActionResult> SearchSach(
            [FromQuery] string? searchText,
            [FromQuery] int? theLoaiId)
        {
            var query = _context.Sachs
                .Include(s => s.TacGia)
                .Include(s => s.TheLoai)
                .AsQueryable();

            if (theLoaiId.HasValue && theLoaiId > 0)
            {
                query = query.Where(s => s.IdTheLoai == theLoaiId);
            }
            if (!string.IsNullOrEmpty(searchText))
            {
                string searchLower = searchText.ToLower();
                query = query.Where(s =>
                    s.TenSach.ToLower().Contains(searchLower) ||
                    (s.TacGia != null && s.TacGia.TenTacGia.ToLower().Contains(searchLower))
                );
            }

            var rawResults = await query
                .Select(s => new
                {
                    s.IdSach,
                    s.TenSach,
                    TenTacGia = s.TacGia != null ? s.TacGia.TenTacGia : "N/A",
                    TenTheLoai = s.TheLoai != null ? s.TheLoai.TenTheLoai : "N/A",
                    s.ViTri,
                    s.SoLuongTong,
                    s.SoLuongHienCo,
                    s.AnhBia // Chá»‰ láº¥y path
                })
                .OrderBy(s => s.TenSach)
                .ToListAsync();

            var results = rawResults.Select(s => new SachDto
            {
                IdSach = s.IdSach,
                TenSach = s.TenSach,
                TenTacGia = s.TenTacGia,
                TenTheLoai = s.TenTheLoai,
                ViTri = s.ViTri,
                SoLuongTong = s.SoLuongTong,
                SoLuongHienCo = s.SoLuongHienCo,
                AnhBiaUrl = GetFullImageUrl(s.AnhBia) // <-- DÃ¹ng Helper
            }).ToList();

            return Ok(results);
        }

        [HttpGet("details/{id}")]
        public async Task<IActionResult> GetSachDetails(int id)
        {
            var sach = await _context.Sachs.FindAsync(id);
            if (sach == null) return NotFound();

            var dto = new SachDetailDto
            {
                IdSach = sach.IdSach,
                TenSach = sach.TenSach,
                IdTheLoai = sach.IdTheLoai,
                IdTacGia = sach.IdTacGia,
                IdNhaXuatBan = sach.IdNhaXuatBan,
                NamXuatBan = sach.NamXuatBan,
                MoTa = sach.MoTa,
                SoLuongTong = sach.SoLuongTong,
                AnhBiaUrl = GetFullImageUrl(sach.AnhBia), // <-- DÃ¹ng Helper
                GiaBia = sach.GiaBia,
                ViTri = sach.ViTri
            };
            return Ok(dto);
        }

        // Sá»¬A: DÃ¹ng [FromForm]
        [HttpPost]
        public async Task<IActionResult> CreateSach(
                    [FromForm] SachUpdateRequestDto dto)
        {
            var sach = new Sach
            {
                TenSach = dto.TenSach,
                IdTheLoai = dto.IdTheLoai,
                IdTacGia = dto.IdTacGia,
                IdNhaXuatBan = dto.IdNhaXuatBan,
                NamXuatBan = dto.NamXuatBan,
                MoTa = dto.MoTa,
                SoLuongTong = dto.SoLuongTong,
                SoLuongHienCo = dto.SoLuongTong,
                GiaBia = dto.GiaBia,
                ViTri = dto.ViTri,
                AnhBia = null
            };
            _context.Sachs.Add(sach);
            await _context.SaveChangesAsync();

            // Sá»¬A: Láº¥y file tá»« dto.AnhBiaUpload
            if (dto.AnhBiaUpload != null)
            {
                try
                {
                    string fileName = GenerateFileName(sach.IdSach, sach.TenSach);
                    string relativePath = await SaveImageFromFile(dto.AnhBiaUpload, fileName, HinhAnhPaths.UrlBooks.TrimStart('/'));
                    sach.AnhBia = relativePath;
                    await _context.SaveChangesAsync();
                }
                catch (Exception ex)
                {
                    _context.Sachs.Remove(sach);
                    await _context.SaveChangesAsync();
                    return StatusCode(500, $"Lá»—i khi lÆ°u áº£nh: {ex.Message}");
                }
            }

            var detailDto = new SachDetailDto
            {
                IdSach = sach.IdSach,
                TenSach = sach.TenSach,
                AnhBiaUrl = GetFullImageUrl(sach.AnhBia)
            };
            return Ok(detailDto);
        }

        // Sá»¬A: DÃ¹ng [FromForm]
        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateSach(int id,
                    [FromForm] SachUpdateRequestDto dto)
        {
            var sach = await _context.Sachs.FindAsync(id);
            if (sach == null) return NotFound();

            int soLuongDangMuon = sach.SoLuongTong - sach.SoLuongHienCo;
            if (dto.SoLuongTong < soLuongDangMuon)
            {
                return Conflict($"Sá»‘ lÆ°á»£ng tá»•ng ({dto.SoLuongTong}) khÃ´ng thá»ƒ nhá» hÆ¡n sá»‘ lÆ°á»£ng Ä‘ang cho thuÃª ({soLuongDangMuon}).");
            }

            var oldImagePath = sach.AnhBia;
            var oldTenSach = sach.TenSach;

            // Sá»¬A: Láº¥y file vÃ  cá» XÃ³a tá»« DTO
            bool isImageUpload = dto.AnhBiaUpload != null;
            bool isNameChange = dto.TenSach != oldTenSach;

            sach.TenSach = dto.TenSach;
            sach.IdTheLoai = dto.IdTheLoai;
            sach.IdTacGia = dto.IdTacGia;
            sach.IdNhaXuatBan = dto.IdNhaXuatBan;
            sach.NamXuatBan = dto.NamXuatBan;
            sach.MoTa = dto.MoTa;
            sach.SoLuongTong = dto.SoLuongTong;
            sach.SoLuongHienCo = dto.SoLuongTong - soLuongDangMuon;
            sach.GiaBia = dto.GiaBia;
            sach.ViTri = dto.ViTri;

            string newFileName = GenerateFileName(sach.IdSach, sach.TenSach);
            string newRelativePath = $"/{HinhAnhPaths.UrlBooks.TrimStart('/')}/{newFileName}";

            if (isImageUpload)
            {
                DeleteOldImage(oldImagePath);
                sach.AnhBia = await SaveImageFromFile(dto.AnhBiaUpload, newFileName, HinhAnhPaths.UrlBooks.TrimStart('/'));
            }
            // Sá»¬A: Láº¥y cá» XÃ³a tá»« DTO
            else if (dto.XoaAnhBia)
            {
                DeleteOldImage(oldImagePath);
                sach.AnhBia = null;
            }
            else if (isNameChange && !string.IsNullOrEmpty(oldImagePath))
            {
                RenameImage(oldImagePath, newRelativePath);
                sach.AnhBia = newRelativePath;
            }

            await _context.SaveChangesAsync();
            return Ok();
        }

        // (HÃ m DeleteSach giá»¯ nguyÃªn logic)
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteSach(int id)
        {
            if (await _context.ChiTietPhieuThues.AnyAsync(ct => ct.IdSach == id && ct.NgayTraThucTe == null))
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a sÃ¡ch. SÃ¡ch nÃ y Ä‘ang Ä‘Æ°á»£c khÃ¡ch hÃ ng thuÃª.");
            }

            var sach = await _context.Sachs.FindAsync(id);
            if (sach == null) return NotFound();

            DeleteOldImage(sach.AnhBia); // <-- XÃ³a file áº£nh

            _context.Sachs.Remove(sach);
            await _context.SaveChangesAsync();
            return Ok();
        }

        #endregion

        #region API Lá»‹ch sá»­, TÃ¡c giáº£, Thá»ƒ loáº¡i, NXB
        // (ToÃ n bá»™ cÃ¡c hÃ m trong region nÃ y giá»¯ nguyÃªn)
        [HttpGet("rentals")]
        public async Task<IActionResult> GetRentalData()
        {
            var dto = new SachRentalsDto
            {
                SachQuaHan = await _context.Database.SqlQuery<BaoCaoSachTreHanDto>(@$"
                    SELECT
                        s.tenSach AS TenSach, kh.hoTen AS HoTen, kh.soDienThoai AS SoDienThoai,
                        pts.ngayThue AS NgayThue, ctpt.ngayHenTra AS NgayHenTra,
                        N'Trá»… ' + CAST(DATEDIFF(DAY, ctpt.ngayHenTra, GETDATE()) AS NVARCHAR) + N' ngÃ y' AS TinhTrang
                    FROM dbo.ChiTietPhieuThue ctpt
                    JOIN dbo.PhieuThueSach pts ON ctpt.idPhieuThueSach = pts.idPhieuThueSach
                    JOIN dbo.Sach s ON ctpt.idSach = s.idSach
                    JOIN dbo.KhachHang kh ON pts.idKhachHang = kh.idKhachHang
                    WHERE ctpt.ngayTraThucTe IS NULL AND ctpt.ngayHenTra < GETDATE()
                    ORDER BY ctpt.ngayHenTra ASC;
                ").ToListAsync(),

                LichSuThue = await _context.Database.SqlQuery<LichSuThueDto>(@$"
                    SELECT TOP 50
                        s.tenSach AS TenSach, kh.hoTen AS TenKhachHang, pts.ngayThue AS NgayThue,
                        ctpt.ngayHenTra AS NgayHenTra, ctpt.ngayTraThucTe AS NgayTraThucTe,
                        ISNULL(ctpt.TienPhatTraTre, 0) AS TienPhat,
                        pts.trangThai AS TrangThai
                    FROM dbo.ChiTietPhieuThue ctpt
                    JOIN dbo.PhieuThueSach pts ON ctpt.idPhieuThueSach = pts.idPhieuThueSach
                    JOIN dbo.Sach s ON ctpt.idSach = s.idSach
                    JOIN dbo.KhachHang kh ON pts.idKhachHang = kh.idKhachHang
                    ORDER BY pts.ngayThue DESC;
                ").ToListAsync()
            };
            return Ok(dto);
        }
        [HttpPost("tacgia")]
        public async Task<IActionResult> CreateTacGia([FromBody] FilterLookupDto dto)
        {
            if (string.IsNullOrEmpty(dto.Ten)) return BadRequest("TÃªn khÃ´ng Ä‘Æ°á»£c rá»—ng.");
            var existing = await _context.TacGias.FirstOrDefaultAsync(t => t.TenTacGia.ToLower() == dto.Ten.ToLower());
            if (existing != null)
            {
                return Conflict("TÃªn tÃ¡c giáº£ Ä‘Ã£ tá»“n táº¡i.");
            }
            var newEntity = new TacGia { TenTacGia = dto.Ten };
            _context.TacGias.Add(newEntity);
            await _context.SaveChangesAsync();
            return Ok(new FilterLookupDto { Id = newEntity.IdTacGia, Ten = newEntity.TenTacGia });
        }

        [HttpPut("tacgia/{id}")]
        public async Task<IActionResult> UpdateTacGia(int id, [FromBody] FilterLookupDto dto)
        {
            var entity = await _context.TacGias.FindAsync(id);
            if (entity == null) return NotFound();
            entity.TenTacGia = dto.Ten;
            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpDelete("tacgia/{id}")]
        public async Task<IActionResult> DeleteTacGia(int id)
        {
            if (await _context.Sachs.AnyAsync(s => s.IdTacGia == id))
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a. TÃ¡c giáº£ nÃ y Ä‘Ã£ Ä‘Æ°á»£c gÃ¡n cho sÃ¡ch.");
            }
            var entity = await _context.TacGias.FindAsync(id);
            if (entity == null) return NotFound();
            _context.TacGias.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }
        [HttpPost("theloai")]
        public async Task<IActionResult> CreateTheLoai([FromBody] FilterLookupDto dto)
        {
            if (string.IsNullOrEmpty(dto.Ten)) return BadRequest("TÃªn khÃ´ng Ä‘Æ°á»£c rá»—ng.");
            var existing = await _context.TheLoais.FirstOrDefaultAsync(t => t.TenTheLoai.ToLower() == dto.Ten.ToLower());
            if (existing != null)
            {
                return Conflict("TÃªn thá»ƒ loáº¡i Ä‘Ã£ tá»“n táº¡i.");
            }

            var newEntity = new TheLoai { TenTheLoai = dto.Ten };
            _context.TheLoais.Add(newEntity);
            await _context.SaveChangesAsync();
            return Ok(new FilterLookupDto { Id = newEntity.IdTheLoai, Ten = newEntity.TenTheLoai });
        }

        [HttpPut("theloai/{id}")]
        public async Task<IActionResult> UpdateTheLoai(int id, [FromBody] FilterLookupDto dto)
        {
            var entity = await _context.TheLoais.FindAsync(id);
            if (entity == null) return NotFound();
            entity.TenTheLoai = dto.Ten;
            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpDelete("theloai/{id}")]
        public async Task<IActionResult> DeleteTheLoai(int id)
        {
            if (await _context.Sachs.AnyAsync(s => s.IdTheLoai == id))
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a. Thá»ƒ loáº¡i nÃ y Ä‘Ã£ Ä‘Æ°á»£c gÃ¡n cho sÃ¡ch.");
            }
            var entity = await _context.TheLoais.FindAsync(id);
            if (entity == null) return NotFound();
            _context.TheLoais.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }
        [HttpPost("nhaxuatban")]
        public async Task<IActionResult> CreateNhaXuatBan([FromBody] FilterLookupDto dto)
        {
            if (string.IsNullOrEmpty(dto.Ten)) return BadRequest("TÃªn khÃ´ng Ä‘Æ°á»£c rá»—ng.");
            var existing = await _context.NhaXuatBans.FirstOrDefaultAsync(t => t.TenNhaXuatBan.ToLower() == dto.Ten.ToLower());
            if (existing != null)
            {
                return Conflict("TÃªn NXB Ä‘Ã£ tá»“n táº¡i.");
            }

            var newEntity = new NhaXuatBan { TenNhaXuatBan = dto.Ten };
            _context.NhaXuatBans.Add(newEntity);
            await _context.SaveChangesAsync();
            return Ok(new FilterLookupDto { Id = newEntity.IdNhaXuatBan, Ten = newEntity.TenNhaXuatBan });
        }

        [HttpPut("nhaxuatban/{id}")]
        public async Task<IActionResult> UpdateNhaXuatBan(int id, [FromBody] FilterLookupDto dto)
        {
            var entity = await _context.NhaXuatBans.FindAsync(id);
            if (entity == null) return NotFound();
            entity.TenNhaXuatBan = dto.Ten;
            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpDelete("nhaxuatban/{id}")]
        public async Task<IActionResult> DeleteNhaXuatBan(int id)
        {
            if (await _context.Sachs.AnyAsync(s => s.IdNhaXuatBan == id))
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a. NXB nÃ y Ä‘Ã£ Ä‘Æ°á»£c gÃ¡n cho sÃ¡ch.");
            }
            var entity = await _context.NhaXuatBans.FindAsync(id);
            if (entity == null) return NotFound();
            _context.NhaXuatBans.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }

        #endregion
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\SanPhamController.cs
// Táº­p tin: CafebookApi/Controllers/App/SanPhamController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using CafebookModel.Utils;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using Microsoft.AspNetCore.Http; // <-- ThÃªm

namespace CafebookApi.Controllers.App
{
    [Route("api/app/sanpham")]
    [ApiController]
    public class SanPhamController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        private readonly IWebHostEnvironment _env;
        private readonly string _baseUrl;

        public SanPhamController(CafebookDbContext context, IWebHostEnvironment env, IConfiguration config)
        {
            _context = context;
            _env = env;

            if (string.IsNullOrEmpty(_env.WebRootPath))
            {
                _env.WebRootPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot");
                if (!Directory.Exists(_env.WebRootPath))
                {
                    Directory.CreateDirectory(_env.WebRootPath);
                }
            }

            _baseUrl = config.GetValue<string>("Kestrel:Endpoints:Http:Url") ?? "http://127.0.0.1:5166";
        }

        // === HELPER 1: Táº O URL TUYá»†T Äá»I === (Giá»¯ nguyÃªn)
        private string? GetFullImageUrl(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath))
                return null;
            return $"{_baseUrl}{relativePath.Replace(Path.DirectorySeparatorChar, '/')}";
        }

        // === HELPER 2: Táº O TÃŠN FILE === (Giá»¯ nguyÃªn)
        private string GenerateFileName(int id, string ten)
        {
            string slug = SlugifyUtil.GenerateSlug(ten);
            return $"{id}_{slug}.jpg"; // LuÃ´n lÆ°u lÃ  .jpg
        }

        // === HELPER 3: XÃ“A FILE CÅ¨ === (Giá»¯ nguyÃªn)
        private void DeleteOldImage(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath)) return;
            var fileName = relativePath.TrimStart('/');
            var fullPath = Path.Combine(_env.WebRootPath, fileName.Replace('/', Path.DirectorySeparatorChar));
            if (System.IO.File.Exists(fullPath))
            {
                System.IO.File.Delete(fullPath);
            }
        }

        // === HELPER 4 (Má»šI): Äá»”I TÃŠN FILE === (Giá»¯ nguyÃªn)
        private void RenameImage(string oldRelativePath, string newRelativePath)
        {
            if (string.IsNullOrEmpty(oldRelativePath) || string.IsNullOrEmpty(newRelativePath) || oldRelativePath == newRelativePath)
                return;

            var oldFileName = oldRelativePath.TrimStart('/');
            var oldFullPath = Path.Combine(_env.WebRootPath, oldFileName.Replace('/', Path.DirectorySeparatorChar));

            var newFileName = newRelativePath.TrimStart('/');
            var newFullPath = Path.Combine(_env.WebRootPath, newFileName.Replace('/', Path.DirectorySeparatorChar));

            if (System.IO.File.Exists(oldFullPath))
            {
                System.IO.File.Move(oldFullPath, newFullPath);
            }
        }

        // === HELPER 5 (Sá»¬A): LÆ¯U FILE Tá»ª IFormFile ===
        // (ÄÃ£ xÃ³a SaveImageFromBase64)
        private async Task<string> SaveImageFromFile(IFormFile file, string fileName, string relativeDir)
        {
            var saveDir = Path.Combine(_env.WebRootPath, relativeDir);
            if (!Directory.Exists(saveDir))
            {
                Directory.CreateDirectory(saveDir);
            }
            var fullSavePath = Path.Combine(saveDir, fileName);

            // DÃ¹ng stream Ä‘á»ƒ copy file
            await using (var stream = new FileStream(fullSavePath, FileMode.Create))
            {
                await file.CopyToAsync(stream);
            }

            return $"/{relativeDir.Replace(Path.DirectorySeparatorChar, '/')}/{fileName}";
        }

        #region API Sáº£n Pháº©m (ÄÃ£ sá»­a)

        // ... (HÃ m SearchSanPham, GetSanPhamDetails giá»¯ nguyÃªn) ...
        [HttpGet("search")]
        public async Task<IActionResult> SearchSanPham([FromQuery] string? searchText, [FromQuery] int? danhMucId, [FromQuery] bool? trangThai)
        {
            // ... (Logic khÃ´ng Ä‘á»•i)
            var query = _context.SanPhams.Include(s => s.DanhMuc).AsQueryable();

            if (danhMucId.HasValue && danhMucId > 0)
                query = query.Where(s => s.IdDanhMuc == danhMucId);
            if (trangThai.HasValue)
                query = query.Where(s => s.TrangThaiKinhDoanh == trangThai.Value);
            if (!string.IsNullOrEmpty(searchText))
            {
                string searchLower = searchText.ToLower();
                query = query.Where(s => s.TenSanPham.ToLower().Contains(searchLower));
            }

            var rawResults = await query.Select(s => new
            {
                s.IdSanPham,
                s.TenSanPham,
                s.GiaBan,
                TenDanhMuc = s.DanhMuc != null ? s.DanhMuc.TenDanhMuc : "N/A",
                s.TrangThaiKinhDoanh,
                s.HinhAnh
            })
            .OrderBy(s => s.TenSanPham)
            .ToListAsync();

            var results = rawResults.Select(s => new SanPhamDto
            {
                IdSanPham = s.IdSanPham,
                TenSanPham = s.TenSanPham,
                GiaBan = s.GiaBan,
                TenDanhMuc = s.TenDanhMuc,
                TrangThaiKinhDoanh = s.TrangThaiKinhDoanh,
                HinhAnhUrl = GetFullImageUrl(s.HinhAnh)
            }).ToList();

            return Ok(results);
        }

        [HttpGet("details/{id}")]
        public async Task<IActionResult> GetSanPhamDetails(int id)
        {
            // ... (Logic khÃ´ng Ä‘á»•i)
            var sp = await _context.SanPhams.FindAsync(id);
            if (sp == null) return NotFound();

            var dto = new SanPhamDetailDto
            {
                IdSanPham = sp.IdSanPham,
                TenSanPham = sp.TenSanPham,
                IdDanhMuc = sp.IdDanhMuc,
                GiaBan = sp.GiaBan,
                MoTa = sp.MoTa,
                TrangThaiKinhDoanh = sp.TrangThaiKinhDoanh,
                NhomIn = sp.NhomIn,
                HinhAnhUrl = GetFullImageUrl(sp.HinhAnh) // <-- DÃ¹ng Helper
            };
            return Ok(dto);
        }


        // Sá»¬A: DÃ¹ng [FromForm]
        [HttpPost]
        public async Task<IActionResult> CreateSanPham(
                    [FromForm] SanPhamUpdateRequestDto dto)
        {
            if (await _context.SanPhams.AnyAsync(s => s.TenSanPham.ToLower() == dto.TenSanPham.ToLower() && s.IdDanhMuc == dto.IdDanhMuc))
            {
                return Conflict("TÃªn sáº£n pháº©m nÃ y Ä‘Ã£ tá»“n táº¡i trong danh má»¥c Ä‘Ã£ chá»n.");
            }

            var sanPham = new SanPham
            {
                TenSanPham = dto.TenSanPham,
                IdDanhMuc = dto.IdDanhMuc ?? 0,
                GiaBan = dto.GiaBan,
                MoTa = dto.MoTa,
                TrangThaiKinhDoanh = dto.TrangThaiKinhDoanh,
                NhomIn = dto.NhomIn,
                HinhAnh = null
            };
            _context.SanPhams.Add(sanPham);
            await _context.SaveChangesAsync(); // LÆ°u láº§n 1 (Láº¥y ID)

            // Sá»¬A: Láº¥y file tá»« dto.HinhAnhUpload
            if (dto.HinhAnhUpload != null)
            {
                try
                {
                    string fileName = GenerateFileName(sanPham.IdSanPham, sanPham.TenSanPham);
                    string relativePath = await SaveImageFromFile(dto.HinhAnhUpload, fileName, HinhAnhPaths.UrlFoods.TrimStart('/'));
                    sanPham.HinhAnh = relativePath;
                    await _context.SaveChangesAsync(); // LÆ°u láº§n 2 (Cáº­p nháº­t áº£nh)
                }
                catch (Exception ex)
                {
                    _context.SanPhams.Remove(sanPham);
                    await _context.SaveChangesAsync();
                    return StatusCode(500, $"Lá»—i khi lÆ°u áº£nh: {ex.Message}");
                }
            }

            var detailDto = new SanPhamDetailDto
            {
                IdSanPham = sanPham.IdSanPham,
                TenSanPham = sanPham.TenSanPham,
                HinhAnhUrl = GetFullImageUrl(sanPham.HinhAnh)
            };

            return Ok(detailDto);
        }

        // Sá»¬A: DÃ¹ng [FromForm]
        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateSanPham(int id,
                    [FromForm] SanPhamUpdateRequestDto dto)
        {
            var sp = await _context.SanPhams.FindAsync(id);
            if (sp == null) return NotFound();

            if (await _context.SanPhams.AnyAsync(s => s.TenSanPham.ToLower() == dto.TenSanPham.ToLower() && s.IdDanhMuc == dto.IdDanhMuc && s.IdSanPham != id))
            {
                return Conflict("TÃªn sáº£n pháº©m nÃ y Ä‘Ã£ tá»“n táº¡i trong danh má»¥c Ä‘Ã£ chá»n.");
            }

            var oldImagePath = sp.HinhAnh;
            var oldTenSanPham = sp.TenSanPham;

            // Sá»¬A: Láº¥y file vÃ  cá» XÃ³a tá»« DTO
            bool isImageUpload = dto.HinhAnhUpload != null;
            bool isNameChange = dto.TenSanPham != oldTenSanPham;

            sp.TenSanPham = dto.TenSanPham;
            sp.IdDanhMuc = dto.IdDanhMuc ?? 0;
            sp.GiaBan = dto.GiaBan;
            sp.MoTa = dto.MoTa;
            sp.TrangThaiKinhDoanh = dto.TrangThaiKinhDoanh;
            sp.NhomIn = dto.NhomIn;

            string newFileName = GenerateFileName(sp.IdSanPham, sp.TenSanPham);
            string newRelativePath = $"/{HinhAnhPaths.UrlFoods.TrimStart('/')}/{newFileName}";

            if (isImageUpload)
            {
                DeleteOldImage(oldImagePath);
                sp.HinhAnh = await SaveImageFromFile(dto.HinhAnhUpload, newFileName, HinhAnhPaths.UrlFoods.TrimStart('/'));
            }
            // Sá»¬A: Láº¥y cá» XÃ³a tá»« DTO
            else if (dto.XoaHinhAnh)
            {
                DeleteOldImage(oldImagePath);
                sp.HinhAnh = null;
            }
            else if (isNameChange && !string.IsNullOrEmpty(oldImagePath))
            {
                RenameImage(oldImagePath, newRelativePath);
                sp.HinhAnh = newRelativePath;
            }

            await _context.SaveChangesAsync();
            return Ok();
        }

        // ... (DeleteSanPham giá»¯ nguyÃªn, logic DeleteOldImage Ä‘Ã£ cÃ³) ...
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteSanPham(int id)
        {
            if (await _context.ChiTietHoaDons.AnyAsync(ct => ct.IdSanPham == id))
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a. Sáº£n pháº©m nÃ y Ä‘Ã£ tá»“n táº¡i trong lá»‹ch sá»­ hÃ³a Ä‘Æ¡n.");
            }
            var sp = await _context.SanPhams.FindAsync(id);
            if (sp == null) return NotFound();

            DeleteOldImage(sp.HinhAnh); // <-- Logic xÃ³a áº£nh

            var dinhLuong = await _context.DinhLuongs.Where(d => d.IdSanPham == id).ToListAsync();
            if (dinhLuong.Any())
            {
                _context.DinhLuongs.RemoveRange(dinhLuong);
            }
            _context.SanPhams.Remove(sp);
            await _context.SaveChangesAsync();
            return Ok();
        }

        #endregion

        #region API Danh Má»¥c
        [HttpGet("filters")] // <-- PHáº¢I LÃ€ [HttpGet]
        public async Task<IActionResult> GetSanPhamFilters()
        {
            var danhMucs = await _context.DanhMucs
                .Select(t => new FilterLookupDto { Id = t.IdDanhMuc, Ten = t.TenDanhMuc })
                .OrderBy(t => t.Ten)
                .ToListAsync();
            var nguyenLieus = (await _context.NguyenLieus
                .Select(nl => new { nl.IdNguyenLieu, nl.TenNguyenLieu, nl.DonViTinh })
                .ToListAsync())
                .Select(nl => new FilterLookupDto
                {
                    Id = nl.IdNguyenLieu,
                    Ten = nl.TenNguyenLieu + $" ({nl.DonViTinh})"
                })
                .OrderBy(nl => nl.Ten)
                .ToList();
            var donViTinhs = await _context.DonViChuyenDois
                .Select(d => new DonViChuyenDoiDto
                {
                    Id = d.IdChuyenDoi,
                    IdNguyenLieu = d.IdNguyenLieu,
                    Ten = d.TenDonVi
                })
                .ToListAsync();
            var dto = new SanPhamFiltersDto
            {
                DanhMucs = danhMucs,
                NguyenLieus = nguyenLieus,
                DonViTinhs = donViTinhs
            };
            return Ok(dto);
        }

        [HttpPost("danhmuc")]
        public async Task<IActionResult> CreateDanhMuc([FromBody] FilterLookupDto dto)
        {
            if (string.IsNullOrEmpty(dto.Ten)) return BadRequest("TÃªn khÃ´ng Ä‘Æ°á»£c rá»—ng.");
            var existing = await _context.DanhMucs.FirstOrDefaultAsync(t => t.TenDanhMuc.ToLower() == dto.Ten.ToLower());
            if (existing != null) return Conflict("TÃªn danh má»¥c Ä‘Ã£ tá»“n táº¡i.");
            var newEntity = new DanhMuc { TenDanhMuc = dto.Ten };
            _context.DanhMucs.Add(newEntity);
            await _context.SaveChangesAsync();
            return Ok(new FilterLookupDto { Id = newEntity.IdDanhMuc, Ten = newEntity.TenDanhMuc });
        }

        [HttpPut("danhmuc/{id}")]
        public async Task<IActionResult> UpdateDanhMuc(int id, [FromBody] FilterLookupDto dto)
        {
            var entity = await _context.DanhMucs.FindAsync(id);
            if (entity == null) return NotFound();
            entity.TenDanhMuc = dto.Ten;
            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpDelete("danhmuc/{id}")]
        public async Task<IActionResult> DeleteDanhMuc(int id)
        {
            if (await _context.SanPhams.AnyAsync(s => s.IdDanhMuc == id))
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a. Danh má»¥c nÃ y Ä‘Ã£ Ä‘Æ°á»£c gÃ¡n cho sáº£n pháº©m.");
            }
            if (await _context.DanhMucs.AnyAsync(d => d.IdDanhMucCha == id))
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a. Danh má»¥c nÃ y Ä‘ang lÃ  cha cá»§a danh má»¥c khÃ¡c.");
            }
            var entity = await _context.DanhMucs.FindAsync(id);
            if (entity == null) return NotFound();
            _context.DanhMucs.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }
        #endregion

        #region API Äá»‹nh LÆ°á»£ng
        [HttpGet("{idSanPham}/dinhluong")]
        public async Task<IActionResult> GetDinhLuong(int idSanPham)
        {
            var data = await _context.DinhLuongs
                .Where(d => d.IdSanPham == idSanPham)
                .Include(d => d.NguyenLieu)
                .Include(d => d.DonViSuDung)
                .Select(d => new DinhLuongDto
                {
                    IdNguyenLieu = d.IdNguyenLieu,
                    TenNguyenLieu = d.NguyenLieu.TenNguyenLieu,
                    SoLuong = d.SoLuongSuDung,
                    IdDonViSuDung = d.IdDonViSuDung,
                    TenDonViSuDung = d.DonViSuDung.TenDonVi
                })
                .ToListAsync();
            return Ok(data);
        }

        [HttpPost("dinhluong")]
        public async Task<IActionResult> UpdateDinhLuong([FromBody] DinhLuongUpdateRequestDto dto)
        {
            var existing = await _context.DinhLuongs.FindAsync(dto.IdSanPham, dto.IdNguyenLieu);
            if (existing != null)
            {
                existing.SoLuongSuDung = dto.SoLuong;
                existing.IdDonViSuDung = dto.IdDonViSuDung;
            }
            else
            {
                var newDinhLuong = new DinhLuong
                {
                    IdSanPham = dto.IdSanPham,
                    IdNguyenLieu = dto.IdNguyenLieu,
                    SoLuongSuDung = dto.SoLuong,
                    IdDonViSuDung = dto.IdDonViSuDung
                };
                _context.DinhLuongs.Add(newDinhLuong);
            }
            await _context.SaveChangesAsync();
            return Ok();
        }

        [HttpDelete("dinhluong/{idSanPham}/{idNguyenLieu}")]
        public async Task<IActionResult> DeleteDinhLuong(int idSanPham, int idNguyenLieu)
        {
            var existing = await _context.DinhLuongs.FindAsync(idSanPham, idNguyenLieu);
            if (existing != null)
            {
                _context.DinhLuongs.Remove(existing);
                await _context.SaveChangesAsync();
            }
            return Ok();
        }
        #endregion
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\SoDoBanController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using CafebookModel.Model.Entities; // ThÃªm
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;
using System;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/sodoban")]
    [ApiController]
    public class SoDoBanController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public SoDoBanController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API chÃ­nh: Láº¥y tráº¡ng thÃ¡i cá»§a táº¥t cáº£ cÃ¡c bÃ n
        /// </summary>
        [HttpGet("tables")]
        public async Task<IActionResult> GetSoDoBan()
        {
            // DÃ¹ng LINQ Ä‘á»ƒ truy váº¥n tráº¡ng thÃ¡i vÃ  hÃ³a Ä‘Æ¡n chÆ°a thanh toÃ¡n
            var data = await _context.Bans
                .AsNoTracking()
                .Select(b => new BanSoDoDto
                {
                    IdBan = b.IdBan,
                    SoBan = b.SoBan,
                    TrangThai = b.TrangThai,
                    GhiChu = b.GhiChu,

                    // TÃ¬m hÃ³a Ä‘Æ¡n 'ChÆ°a thanh toÃ¡n' tÆ°Æ¡ng á»©ng
                    IdHoaDonHienTai = _context.HoaDons
                                      .Where(h => h.IdBan == b.IdBan && h.TrangThai == "ChÆ°a thanh toÃ¡n")
                                      .Select(h => (int?)h.IdHoaDon)
                                      .FirstOrDefault(),

                    TongTienHienTai = _context.HoaDons
                                      .Where(h => h.IdBan == b.IdBan && h.TrangThai == "ChÆ°a thanh toÃ¡n")
                                      .Select(h => h.ThanhTien) // 'thanhTien' lÃ  cá»™t computed
                                      .FirstOrDefault()
                })
                .OrderBy(b => b.SoBan) // Sáº¯p xáº¿p theo tÃªn bÃ n
                .ToListAsync();

            return Ok(data);
        }

        /// <summary>
        /// API táº¡o má»™t HÃ³a Ä‘Æ¡n má»›i cho bÃ n Trá»‘ng
        /// </summary>
        [HttpPost("createorder/{idBan}/{idNhanVien}")]
        public async Task<IActionResult> CreateOrder(int idBan, int idNhanVien)
        {
            var ban = await _context.Bans.FindAsync(idBan);
            if (ban == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y bÃ n.");
            if (ban.TrangThai != "Trá»‘ng" && ban.TrangThai != "ÄÃ£ Ä‘áº·t")
                return Conflict("BÃ n nÃ y Ä‘ang báº­n hoáº·c Ä‘ang báº£o trÃ¬.");

            // Kiá»ƒm tra xem nhÃ¢n viÃªn cÃ³ tá»“n táº¡i khÃ´ng
            var nhanVien = await _context.NhanViens.FindAsync(idNhanVien);
            if (nhanVien == null) return NotFound("NhÃ¢n viÃªn khÃ´ng há»£p lá»‡.");

            var hoaDon = new HoaDon
            {
                IdBan = idBan,
                IdNhanVien = idNhanVien,
                TrangThai = "ChÆ°a thanh toÃ¡n",
                LoaiHoaDon = "Táº¡i quÃ¡n",
                ThoiGianTao = DateTime.Now
            };

            _context.HoaDons.Add(hoaDon);

            // Cáº­p nháº­t tráº¡ng thÃ¡i bÃ n
            ban.TrangThai = "CÃ³ khÃ¡ch";

            await _context.SaveChangesAsync();

            // Tráº£ vá» HÃ³a Ä‘Æ¡n vá»«a táº¡o
            return Ok(new { idHoaDon = hoaDon.IdHoaDon });
        }

        /// <summary>
        /// API bÃ¡o cÃ¡o sá»± cá»‘ (KhÃ³a bÃ n)
        /// </summary>
        [HttpPost("reportproblem/{idBan}/{idNhanVien}")] // ThÃªm idNhanVien
        public async Task<IActionResult> BaoCaoSuCo(int idBan, int idNhanVien, [FromBody] BaoCaoSuCoRequestDto request)
        {
            var ban = await _context.Bans.FindAsync(idBan);
            if (ban == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y bÃ n.");

            if (ban.TrangThai == "CÃ³ khÃ¡ch")
                return Conflict("KhÃ´ng thá»ƒ bÃ¡o cÃ¡o sá»± cá»‘ bÃ n Ä‘ang cÃ³ khÃ¡ch.");

            ban.TrangThai = "Báº£o trÃ¬";
            ban.GhiChu = $"[Sá»± cá»‘ NV bÃ¡o]: {request.GhiChuSuCo}";

            // --- NÃ‚NG Cáº¤P: Táº O THÃ”NG BÃO Má»šI ---
            var thongBao = new ThongBao
            {
                IdNhanVienTao = idNhanVien,
                NoiDung = $"BÃ n {ban.SoBan} vá»«a Ä‘Æ°á»£c bÃ¡o cÃ¡o sá»± cá»‘: {request.GhiChuSuCo}",
                LoaiThongBao = "SuCoBan",
                IdLienQuan = idBan,
                ThoiGianTao = DateTime.Now,
                DaXem = false
            };
            _context.ThongBaos.Add(thongBao);
            // --- Káº¾T THÃšC NÃ‚NG Cáº¤P ---

            await _context.SaveChangesAsync();
            return Ok(new { message = "BÃ¡o cÃ¡o sá»± cá»‘ thÃ nh cÃ´ng. BÃ n Ä‘Ã£ Ä‘Æ°á»£c khÃ³a." });
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\TaiKhoanController.cs
// Táº­p tin: CafebookApi/Controllers/App/TaiKhoanController.cs
using CafebookApi.Data;
using CafebookModel.Model.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApi;
using CafebookModel.Utils; // <-- THÃŠM
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Hosting; // <-- THÃŠM
using Microsoft.Extensions.Configuration; // <-- THÃŠM
using System.IO; // <-- THÃŠM

namespace CafebookApi.Controllers.App
{
    [Route("api/app/taikhoan")]
    [ApiController]
    public class TaiKhoanController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        // --- Sá»¬A: THÃŠM CÃC BIáº¾N Äá»‚ Xá»¬ LÃ URL ---
        private readonly IWebHostEnvironment _env;
        private readonly string _baseUrl;

        public TaiKhoanController(CafebookDbContext context, IWebHostEnvironment env, IConfiguration config) // <-- Sá»¬A: ThÃªm tham sá»‘
Â  Â  Â  Â  {
            _context = context;

            // --- THÃŠM LOGIC KHá»I Táº O Tá»ª SANPHAMCONTROLLER ---
            _env = env;
            if (string.IsNullOrEmpty(_env.WebRootPath))
            {
                _env.WebRootPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot");
                if (!Directory.Exists(_env.WebRootPath))
                {
                    Directory.CreateDirectory(_env.WebRootPath);
                }
            }
            _baseUrl = config.GetValue<string>("Kestrel:Endpoints:Http:Url")
                             ?? "http://127.0.0.1:5166"; // <-- DÃ¹ng 127.0.0.1
Â  Â  Â  Â  }

        // --- THÃŠM HÃ€M HELPER GetFullImageUrl ---
Â  Â  Â  Â  [ApiExplorerSettings(IgnoreApi = true)]
        private string? GetFullImageUrl(string? relativePath)
        {
            if (string.IsNullOrEmpty(relativePath))
                return null;
            // Äáº£m báº£o Ä‘Æ°á»ng dáº«n dÃ¹ng "/"
Â  Â  Â  Â  Â  Â  return $"{_baseUrl}{relativePath.Replace(Path.DirectorySeparatorChar, '/')}";
        }


        [HttpPost("login")]
        public async Task<IActionResult> Login([FromBody] LoginRequestModel model)
        {
Â  Â  Â  Â  Â  Â  // ... (Logic kiá»ƒm tra model, truy váº¥n CSDL giá»¯ nguyÃªn) ...
            var userInput = model.TenDangNhap.Trim();
            var passInput = model.MatKhau.Trim();

            var nhanVien = await _context.NhanViens
              .Include(nv => nv.VaiTro)
                .ThenInclude(vt => vt.VaiTroQuyens)
                .ThenInclude(vtq => vtq.Quyen)
              .FirstOrDefaultAsync(nv =>
                (nv.TenDangNhap == userInput || nv.SoDienThoai == userInput || nv.Email == userInput) &&
                (nv.MatKhau == passInput)
              );

            if (nhanVien == null)
            {
                return Ok(new LoginResponseModel { Success = false, Message = "Sai tÃªn Ä‘Äƒng nháº­p hoáº·c máº­t kháº©u." });
            }

            if (nhanVien.VaiTro == null)
            {
                return Ok(new LoginResponseModel { Success = false, Message = "TÃ i khoáº£n khÃ´ng cÃ³ vai trÃ²." });
            }

Â  Â  Â  Â  Â  Â  // Táº¡o DTO Ä‘á»ƒ tráº£ vá»
Â  Â  Â  Â  Â  Â  var userDto = new NhanVienDto
            {
                IdNhanVien = nhanVien.IdNhanVien,
                HoTen = nhanVien.HoTen,

                // Sá»¬A: DÃ¹ng GetFullImageUrl
                AnhDaiDien = GetFullImageUrl(nhanVien.AnhDaiDien), // Chuyá»ƒn path thÃ nh URL

                TenVaiTro = nhanVien.VaiTro.TenVaiTro,
                DanhSachQuyen = nhanVien.VaiTro.VaiTroQuyens
                  .Select(vtq => vtq.IdQuyen)
                  .ToList()
            };

            string token = "day_la_jwt_token_tam_thoi";

            return Ok(new LoginResponseModel
            {
                Success = true,
                Message = "ÄÄƒng nháº­p thÃ nh cÃ´ng!",
                Token = token,
                UserData = userDto
            });
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\ThongBaoController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/thongbao")]
    [ApiController]
    public class ThongBaoController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public ThongBaoController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API Ä‘áº¿m sá»‘ thÃ´ng bÃ¡o chÆ°a Ä‘á»c
        /// </summary>
        [HttpGet("unread-count")]
        public async Task<IActionResult> GetUnreadCount()
        {
            var count = await _context.ThongBaos.CountAsync(t => !t.DaXem);
            return Ok(new ThongBaoCountDto { UnreadCount = count });
        }

        /// <summary>
        /// API láº¥y táº¥t cáº£ thÃ´ng bÃ¡o (má»›i nháº¥t trÆ°á»›c)
        /// </summary>
        [HttpGet("all")]
        public async Task<IActionResult> GetAllNotifications()
        {
            var notifications = await _context.ThongBaos
                .Include(t => t.NhanVienTao) // Join Ä‘á»ƒ láº¥y tÃªn NV
                .OrderByDescending(t => t.ThoiGianTao)
                .Take(20) // Chá»‰ láº¥y 20 thÃ´ng bÃ¡o má»›i nháº¥t
                .Select(t => new ThongBaoDto
                {
                    IdThongBao = t.IdThongBao,
                    NoiDung = t.NoiDung,
                    ThoiGianTao = t.ThoiGianTao,
                    LoaiThongBao = t.LoaiThongBao,
                    IdLienQuan = t.IdLienQuan,
                    DaXem = t.DaXem,
                    TenNhanVienTao = t.NhanVienTao != null ? t.NhanVienTao.HoTen : "Há»‡ thá»‘ng"
                })
                .ToListAsync();

            return Ok(notifications);
        }

        /// <summary>
        /// API Ä‘Ã¡nh dáº¥u 1 thÃ´ng bÃ¡o lÃ  Ä‘Ã£ Ä‘á»c
        /// </summary>
        [HttpPost("mark-as-read/{id}")]
        public async Task<IActionResult> MarkAsRead(int id)
        {
            var thongBao = await _context.ThongBaos.FindAsync(id);
            if (thongBao == null) return NotFound();

            if (!thongBao.DaXem)
            {
                thongBao.DaXem = true;
                await _context.SaveChangesAsync();
            }
            return Ok();
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\ThuongPhatController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/thuongphat")]
    [ApiController]
    public class ThuongPhatController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public ThuongPhatController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API Láº¥y danh sÃ¡ch ThÆ°á»Ÿng/Pháº¡t (chÆ°a chá»‘t lÆ°Æ¡ng)
        /// </summary>
        [HttpGet("pending/{idNhanVien}")]
        public async Task<IActionResult> GetPending(int idNhanVien)
        {
            var data = await _context.PhieuThuongPhats
                .Include(p => p.NguoiTao)
                .Where(p => p.IdNhanVien == idNhanVien && p.IdPhieuLuong == null) // Chá»‰ láº¥y phiáº¿u chÆ°a chá»‘t
                .OrderByDescending(p => p.NgayTao)
                .Select(p => new PhieuThuongPhatDto
                {
                    IdPhieuThuongPhat = p.IdPhieuThuongPhat,
                    IdNhanVien = p.IdNhanVien,
                    HoTenNhanVien = p.NhanVien.HoTen,
                    NgayTao = p.NgayTao,
                    SoTien = p.SoTien,
                    LyDo = p.LyDo,
                    TenNguoiTao = p.NguoiTao.HoTen
                })
                .ToListAsync();
            return Ok(data);
        }

        /// <summary>
        /// API ThÃªm má»›i ThÆ°á»Ÿng/Pháº¡t
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> Create([FromBody] PhieuThuongPhatCreateDto dto)
        {
            var entity = new PhieuThuongPhat
            {
                IdNhanVien = dto.IdNhanVien,
                IdNguoiTao = dto.IdNguoiTao,
                NgayTao = DateTime.Now,
                SoTien = dto.SoTien,
                LyDo = dto.LyDo,
                IdPhieuLuong = null // ChÆ°a chá»‘t
            };

            _context.PhieuThuongPhats.Add(entity);
            await _context.SaveChangesAsync();
            return Ok(entity);
        }

        /// <summary>
        /// API XÃ³a ThÆ°á»Ÿng/Pháº¡t (chá»‰ khi chÆ°a chá»‘t)
        /// </summary>
        [HttpDelete("{id}")]
        public async Task<IActionResult> Delete(int id)
        {
            var entity = await _context.PhieuThuongPhats.FindAsync(id);
            if (entity == null) return NotFound();

            if (entity.IdPhieuLuong != null)
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a. Khoáº£n nÃ y Ä‘Ã£ Ä‘Æ°á»£c chá»‘t trong phiáº¿u lÆ°Æ¡ng.");
            }

            _context.PhieuThuongPhats.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\App\VaiTroController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApp;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.App
{
    [Route("api/app/vaitro")]
    [ApiController]
    public class VaiTroController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public VaiTroController(CafebookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// API Láº¥y táº¥t cáº£ Vai TrÃ²
        /// </summary>
        [HttpGet("all")]
        public async Task<IActionResult> GetAll()
        {
            var data = await _context.VaiTros
                .Select(v => new VaiTroDto
                {
                    IdVaiTro = v.IdVaiTro,
                    TenVaiTro = v.TenVaiTro,
                    MoTa = v.MoTa
                })
                .OrderBy(v => v.TenVaiTro)
                .ToListAsync();
            return Ok(data);
        }

        /// <summary>
        /// API ThÃªm má»›i Vai TrÃ²
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> Create([FromBody] VaiTroDto dto)
        {
            if (await _context.VaiTros.AnyAsync(v => v.TenVaiTro.ToLower() == dto.TenVaiTro.ToLower()))
            {
                return Conflict("TÃªn vai trÃ² Ä‘Ã£ tá»“n táº¡i.");
            }
            var entity = new VaiTro
            {
                TenVaiTro = dto.TenVaiTro,
                MoTa = dto.MoTa
            };
            _context.VaiTros.Add(entity);
            await _context.SaveChangesAsync();
            return Ok(entity);
        }

        /// <summary>
        /// API Cáº­p nháº­t Vai TrÃ²
        /// </summary>
        [HttpPut("{id}")]
        public async Task<IActionResult> Update(int id, [FromBody] VaiTroDto dto)
        {
            var entity = await _context.VaiTros.FindAsync(id);
            if (entity == null) return NotFound();

            if (await _context.VaiTros.AnyAsync(v => v.TenVaiTro.ToLower() == dto.TenVaiTro.ToLower() && v.IdVaiTro != id))
            {
                return Conflict("TÃªn vai trÃ² Ä‘Ã£ tá»“n táº¡i.");
            }

            entity.TenVaiTro = dto.TenVaiTro;
            entity.MoTa = dto.MoTa;
            await _context.SaveChangesAsync();
            return Ok();
        }

        /// <summary>
        /// API XÃ³a Vai TrÃ²
        /// </summary>
        [HttpDelete("{id}")]
        public async Task<IActionResult> Delete(int id)
        {
            if (await _context.NhanViens.AnyAsync(nv => nv.IdVaiTro == id))
            {
                return Conflict("KhÃ´ng thá»ƒ xÃ³a. Vai trÃ² nÃ y Ä‘ang Ä‘Æ°á»£c gÃ¡n cho nhÃ¢n viÃªn.");
            }

            var entity = await _context.VaiTros.FindAsync(id);
            if (entity == null) return NotFound();

            _context.VaiTros.Remove(entity);
            await _context.SaveChangesAsync();
            return Ok();
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\Shared\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\Web\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\Web\KhachHangTaiKhoanController.cs
using CafebookApi.Data;
using CafebookModel.Model.Entities;
using CafebookModel.Model.ModelApi;
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace CafebookApi.Controllers.Web
{
    [Route("api/web/taikhoankhach")]
    [ApiController]
    public class KhachHangTaiKhoanController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public KhachHangTaiKhoanController(CafebookDbContext context)
        {
            _context = context;
        }

        [HttpPost("login")]
        public async Task<IActionResult> Login([FromBody] LoginRequestModel model)
        {
            if (model == null || string.IsNullOrEmpty(model.TenDangNhap) || string.IsNullOrEmpty(model.MatKhau))
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "ThÃ´ng tin khÃ´ng há»£p lá»‡." });
            }

            var userInput = model.TenDangNhap.Trim();
            var passInput = model.MatKhau.Trim();

            // 1. TÃŒM KIáº¾M KHÃCH HÃ€NG
            var khachHang = await _context.KhachHangs.FirstOrDefaultAsync(k =>
                (k.TenDangNhap == userInput || k.SoDienThoai == userInput || k.Email == userInput) &&
                (k.MatKhau == passInput) // LÆ¯U Ã: Pháº£i HASH máº­t kháº©u trong thá»±c táº¿
            );

            if (khachHang == null)
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "Sai thÃ´ng tin Ä‘Äƒng nháº­p hoáº·c máº­t kháº©u." });
            }

            // 2. Táº O DTO TRáº¢ Vá»€
            var dto = new KhachHangDto
            {
                IdKhachHang = khachHang.IdKhachHang,
                HoTen = khachHang.HoTen,
                Email = khachHang.Email,
                SoDienThoai = khachHang.SoDienThoai,
                TenDangNhap = khachHang.TenDangNhap
            };

            return Ok(new WebLoginResponseModel { Success = true, KhachHangData = dto });
        }
        // THÃŠM API Má»šI CHO ÄÄ‚NG KÃ
        [HttpPost("register")]
        public async Task<IActionResult> Register([FromBody] DangKyRequestModel model)
        {
            if (model == null || string.IsNullOrEmpty(model.HoTen) || string.IsNullOrEmpty(model.Email) || string.IsNullOrEmpty(model.SoDienThoai) || string.IsNullOrEmpty(model.Password))
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin báº¯t buá»™c." });
            }

            // KIá»‚M TRA TRÃ™NG Láº¶P
            if (await _context.KhachHangs.AnyAsync(k => k.Email == model.Email))
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "Email nÃ y Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng." });
            }
            if (await _context.KhachHangs.AnyAsync(k => k.SoDienThoai == model.SoDienThoai))
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "SÄT nÃ y Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng." });
            }
            if (!string.IsNullOrEmpty(model.TenDangNhap) && await _context.KhachHangs.AnyAsync(k => k.TenDangNhap == model.TenDangNhap))
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "TÃªn Ä‘Äƒng nháº­p nÃ y Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng." });
            }

            // Táº O KHÃCH HÃ€NG Má»šI
            var khachHang = new KhachHang // <-- DÃ¹ng Entity
            {
                HoTen = model.HoTen,
                Email = model.Email,
                SoDienThoai = model.SoDienThoai,
                TenDangNhap = string.IsNullOrEmpty(model.TenDangNhap) ? null : model.TenDangNhap,
                MatKhau = model.Password, // LÆ¯U Ã: PHáº¢I HASH Máº¬T KHáº¨U
                NgayTao = DateTime.Now,
                DiemTichLuy = 0
            };

            _context.KhachHangs.Add(khachHang);
            await _context.SaveChangesAsync();

            // Tráº£ vá» thÃ´ng tin khÃ¡ch hÃ ng (Ä‘á»ƒ tá»± Ä‘á»™ng Ä‘Äƒng nháº­p)
            var dto = new KhachHangDto
            {
                IdKhachHang = khachHang.IdKhachHang,
                HoTen = khachHang.HoTen,
                Email = khachHang.Email,
                SoDienThoai = khachHang.SoDienThoai,
                TenDangNhap = khachHang.TenDangNhap
            };

            return Ok(new WebLoginResponseModel { Success = true, KhachHangData = dto });
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\Web\NhanVienTaiKhoanController.cs
using CafebookApi.Data;
using CafebookModel.Model.Data;
using CafebookModel.Model.ModelApi;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace CafebookApi.Controllers.Web
{
    [Route("api/web/taikhoannv")]
    [ApiController]
    public class NhanVienTaiKhoanController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public NhanVienTaiKhoanController(CafebookDbContext context)
        {
            _context = context;
        }

        [HttpPost("login")]
        public async Task<IActionResult> Login([FromBody] LoginRequestModel model)
        {
            if (model == null || string.IsNullOrEmpty(model.TenDangNhap) || string.IsNullOrEmpty(model.MatKhau))
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "ThÃ´ng tin khÃ´ng há»£p lá»‡." });
            }

            var userInput = model.TenDangNhap.Trim();
            var passInput = model.MatKhau.Trim();

            // 1. TÃŒM KIáº¾M NHÃ‚N VIÃŠN (Táº­n dá»¥ng logic tá»« API cá»§a WPF)
            var nhanVien = await _context.NhanViens
                .Include(nv => nv.VaiTro)
                .ThenInclude(vt => vt.VaiTroQuyens)
                .ThenInclude(vtq => vtq.Quyen)
                .FirstOrDefaultAsync(nv =>
                    (nv.TenDangNhap == userInput || nv.SoDienThoai == userInput || nv.Email == userInput) &&
                    (nv.MatKhau == passInput)
                );

            if (nhanVien == null || nhanVien.VaiTro == null)
            {
                return Ok(new WebLoginResponseModel { Success = false, Message = "Sai thÃ´ng tin Ä‘Äƒng nháº­p hoáº·c máº­t kháº©u." });
            }

            // 2. Táº O NhanVienDto (Táº­n dá»¥ng DTO cá»§a WPF)
            var dto = new NhanVienDto
            {
                IdNhanVien = nhanVien.IdNhanVien,
                HoTen = nhanVien.HoTen,
                AnhDaiDien = nhanVien.AnhDaiDien, // Base64
                TenVaiTro = nhanVien.VaiTro.TenVaiTro,
                DanhSachQuyen = nhanVien.VaiTro.VaiTroQuyens
                                    .Select(vtq => vtq.IdQuyen)
                                    .ToList()
            };

            return Ok(new WebLoginResponseModel { Success = true, NhanVienData = dto });
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\Web\TrangChuController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace CafebookApi.Controllers.Web
{
    [Route("api/web/trangchu")]
    [ApiController]
    public class TrangChuController : ControllerBase
    {
        private readonly CafebookDbContext _context;
        public TrangChuController(CafebookDbContext context) { _context = context; }

        [HttpGet("data")] // API endpoint
        public async Task<IActionResult> GetTrangChuData()
        {
            // 1. Láº¥y thÃ´ng tin chung (tá»« báº£ng CaiDat)
            var settings = await _context.CaiDats.ToListAsync();
            var thongTinChung = new ThongTinChungDto
            {
                TenQuan = settings.FirstOrDefault(c => c.TenCaiDat == "TenQuan")?.GiaTri ?? "Cafebook",
                GioiThieu = "NÆ¡i báº¡n cÃ³ thá»ƒ thÆ°á»Ÿng thá»©c cÃ  phÃª thÆ¡m ngon...",
                DiaChi = settings.FirstOrDefault(c => c.TenCaiDat == "DiaChi")?.GiaTri,
                SoDienThoai = settings.FirstOrDefault(c => c.TenCaiDat == "SoDienThoai")?.GiaTri,
                EmailLienHe = "contact@cafebook.vn",
                GioMoCua = "07:00 - 22:00",
                SoBanTrong = await _context.Bans.CountAsync(b => b.TrangThai == "Trá»‘ng"),
                SoSachDangDuocThue = await _context.ChiTietPhieuThues.CountAsync(ct => ct.NgayTraThucTe == null)
            };

            // 2. Láº¥y 3 khuyáº¿n mÃ£i má»›i nháº¥t
            var promotions = await _context.KhuyenMais
                .Where(km => km.NgayKetThuc > DateTime.Now && km.NgayBatDau < DateTime.Now)
                .OrderByDescending(km => km.NgayBatDau)
                .Take(3)
                .Select(km => new KhuyenMaiDto
                {
                    TenKhuyenMai = km.TenChuongTrinh,
                    MoTa = km.MoTa,
                    dieuKienApDung = km.DieuKienApDung
                }).ToListAsync();

            // 3. Láº¥y 5 mÃ³n ná»•i báº­t
            var monNoiBat = await _context.SanPhams
                .Where(sp => sp.TrangThaiKinhDoanh == true)
                .OrderByDescending(sp => sp.IdSanPham) // Giáº£ láº­p mÃ³n má»›i = ná»•i báº­t
                .Take(5)
                .Select(sp => new SanPhamDto
                {
                    TenSanPham = sp.TenSanPham,
                    DonGia = sp.GiaBan,
                    AnhSanPhamBase64 = sp.HinhAnh // Giáº£ sá»­ Ä‘Ã¢y lÃ  Base64
                }).ToListAsync();

            // 4. Láº¥y 4 sÃ¡ch ná»•i báº­t
            var sachNoiBat = await _context.Sachs
                .Include(s => s.TacGia) // Join báº£ng TÃ¡c giáº£
                .OrderByDescending(s => s.SoLuongHienCo)
                .Take(4)
                .Select(s => new SachDto
                {
                    IdSach = s.IdSach,
                    TieuDe = s.TenSach,
                    TacGia = s.TacGia != null ? s.TacGia.TenTacGia : "KhÃ´ng rÃµ",
                    AnhBia = s.AnhBia // Base64
                }).ToListAsync();

            // 5. Gá»™p táº¥t cáº£ vÃ o DTO
            var dto = new TrangChuDto
            {
                Info = thongTinChung,
                Promotions = promotions,
                MonNoiBat = monNoiBat,
                SachNoiBat = sachNoiBat
            };

            return Ok(dto);
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Controllers\Web\WebQuanLyController.cs
using CafebookApi.Data;
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Linq;
using System.Threading.Tasks;

namespace CafebookApi.Controllers.Web
{
    [Route("api/web/quanly")]
    [ApiController]
    public class WebQuanLyController : ControllerBase
    {
        private readonly CafebookDbContext _context;

        public WebQuanLyController(CafebookDbContext context)
        {
            _context = context;
        }

        [HttpGet("dashboard/{idNhanVien}")]
        public async Task<IActionResult> GetEmployeeDashboard(int idNhanVien)
        {
            var nhanVien = await _context.NhanViens
                .Include(nv => nv.VaiTro)
                .AsNoTracking()
                .FirstOrDefaultAsync(nv => nv.IdNhanVien == idNhanVien);

            if (nhanVien == null)
            {
                return NotFound("KhÃ´ng tÃ¬m tháº¥y nhÃ¢n viÃªn.");
            }

            // Láº¥y ca lÃ m viá»‡c hÃ´m nay
            var caLamViec = await _context.LichLamViecs
                .Include(llv => llv.CaLamViec)
                .Where(llv => llv.IdNhanVien == idNhanVien && llv.NgayLam == DateTime.Today)
                .Select(llv => llv.CaLamViec.TenCa)
                .FirstOrDefaultAsync();

            // Láº¥y thá»‘ng kÃª
            var banPhucVu = await _context.Bans.CountAsync(b => b.TrangThai == "CÃ³ khÃ¡ch");
            var donXuLy = await _context.HoaDons.CountAsync(h => h.TrangThai == "ChÆ°a thanh toÃ¡n" || h.TrangThai == "Äang giao");

            var dto = new WebQuanLyDashboardDto
            {
                HoTen = nhanVien.HoTen,
                VaiTro = nhanVien.VaiTro.TenVaiTro,
                AnhDaiDien = nhanVien.AnhDaiDien,
                CaHienTai = caLamViec ?? "HÃ´m nay nghá»‰",
                TongBanDangPhucVu = banPhucVu,
                TongDonDangXuLy = donXuLy
            };

            return Ok(dto);
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Data\
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Data\CafebookDbContext.cs
using CafebookModel.Model.Entities;
using Microsoft.EntityFrameworkCore;

namespace CafebookApi.Data
{
    public class CafebookDbContext : DbContext
    {
        public CafebookDbContext(DbContextOptions<CafebookDbContext> options)
            : base(options)
        {
        }

        // --- Khai bÃ¡o táº¥t cáº£ cÃ¡c Báº£ng (DbSet) ---
        public DbSet<KhuVuc> KhuVucs { get; set; }
        public DbSet<Ban> Bans { get; set; }
        public DbSet<NguoiGiaoHang> NguoiGiaoHangs { get; set; }
        public DbSet<HoaDon> HoaDons { get; set; }
        public DbSet<DanhMuc> DanhMucs { get; set; }
        public DbSet<SanPham> SanPhams { get; set; }
        public DbSet<ChiTietHoaDon> ChiTietHoaDons { get; set; }
        public DbSet<PhuThu> PhuThus { get; set; }
        public DbSet<ChiTietPhuThuHoaDon> ChiTietPhuThuHoaDons { get; set; }
        public DbSet<NhatKyHuyMon> NhatKyHuyMons { get; set; }
        public DbSet<NguyenLieu> NguyenLieus { get; set; }
        public DbSet<DinhLuong> DinhLuongs { get; set; }
        public DbSet<NhaCungCap> NhaCungCaps { get; set; }
        public DbSet<PhieuNhapKho> PhieuNhapKhos { get; set; }
        public DbSet<ChiTietNhapKho> ChiTietNhapKhos { get; set; }
        public DbSet<PhieuKiemKho> PhieuKiemKhos { get; set; }
        public DbSet<ChiTietKiemKho> ChiTietKiemKhos { get; set; }
        public DbSet<PhieuXuatHuy> PhieuXuatHuys { get; set; }
        public DbSet<ChiTietXuatHuy> ChiTietXuatHuys { get; set; }
        public DbSet<KhachHang> KhachHangs { get; set; }
        public DbSet<PhieuDatBan> PhieuDatBans { get; set; }
        public DbSet<KhuyenMai> KhuyenMais { get; set; }
        public DbSet<HoaDon_KhuyenMai> HoaDonKhuyenMais { get; set; }
        public DbSet<TheLoai> TheLoais { get; set; }
        public DbSet<TacGia> TacGias { get; set; }
        public DbSet<NhaXuatBan> NhaXuatBans { get; set; }
        public DbSet<Sach> Sachs { get; set; }
        public DbSet<PhieuThueSach> PhieuThueSachs { get; set; }
        public DbSet<ChiTietPhieuThue> ChiTietPhieuThues { get; set; }
        public DbSet<VaiTro> VaiTros { get; set; }
        public DbSet<NhanVien> NhanViens { get; set; }
        public DbSet<CaLamViec> CaLamViecs { get; set; }
        public DbSet<LichLamViec> LichLamViecs { get; set; }
        public DbSet<BangChamCong> BangChamCongs { get; set; }
        public DbSet<PhieuLuong> PhieuLuongs { get; set; }
        public DbSet<DonXinNghi> DonXinNghis { get; set; }
        public DbSet<CaiDat> CaiDats { get; set; }
        public DbSet<Quyen> Quyens { get; set; }
        public DbSet<VaiTro_Quyen> VaiTroQuyens { get; set; }
        public DbSet<GiaoDichThanhToan> GiaoDichThanhToans { get; set; }
        public DbSet<ChatLichSu> ChatLichSus { get; set; }
        public DbSet<DeXuatSanPham> DeXuatSanPhams { get; set; }
        public DbSet<DeXuatSach> DeXuatSachs { get; set; }
        public DbSet<ThongBao> ThongBaos { get; set; }
        public DbSet<DonViChuyenDoi> DonViChuyenDois { get; set; } // <-- THÃŠM DÃ’NG NÃ€Y
        public DbSet<PhieuThuongPhat> PhieuThuongPhats { get; set; }
        // --- Cáº¥u hÃ¬nh KhÃ³a (Fluent API) ---
        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);

            // Cáº¥u hÃ¬nh KhÃ³a chÃ­nh tá»•ng há»£p (Composite Primary Keys)
            modelBuilder.Entity<ChiTietPhuThuHoaDon>().HasKey(c => new { c.IdHoaDon, c.IdPhuThu });
            modelBuilder.Entity<DinhLuong>().HasKey(c => new { c.IdSanPham, c.IdNguyenLieu });
            modelBuilder.Entity<ChiTietNhapKho>().HasKey(c => new { c.IdPhieuNhapKho, c.IdNguyenLieu });
            modelBuilder.Entity<ChiTietKiemKho>().HasKey(c => new { c.IdPhieuKiemKho, c.IdNguyenLieu });
            modelBuilder.Entity<ChiTietXuatHuy>().HasKey(c => new { c.IdPhieuXuatHuy, c.IdNguyenLieu });
            modelBuilder.Entity<HoaDon_KhuyenMai>().HasKey(c => new { c.IdHoaDon, c.IdKhuyenMai });
            modelBuilder.Entity<ChiTietPhieuThue>().HasKey(c => new { c.IdPhieuThueSach, c.IdSach });
            modelBuilder.Entity<VaiTro_Quyen>().HasKey(c => new { c.IdVaiTro, c.IdQuyen });
            modelBuilder.Entity<DeXuatSanPham>().HasKey(c => new { c.IdSanPhamGoc, c.IdSanPhamDeXuat, c.LoaiDeXuat });
            modelBuilder.Entity<DeXuatSach>().HasKey(c => new { c.IdSachGoc, c.IdSachDeXuat, c.LoaiDeXuat });
            // === THÃŠM Cáº¤U HÃŒNH Má»šI NÃ€Y (Äá»‚ GIáº¢I QUYáº¾T XUNG Äá»˜T FK) ===
            modelBuilder.Entity<PhieuThuongPhat>()
                .HasOne(p => p.NhanVien)
                .WithMany() // KhÃ´ng táº¡o collection
                .HasForeignKey(p => p.IdNhanVien)
                .OnDelete(DeleteBehavior.NoAction);

            modelBuilder.Entity<PhieuThuongPhat>()
                .HasOne(p => p.NguoiTao)
                .WithMany() // KhÃ´ng táº¡o collection
                .HasForeignKey(p => p.IdNguoiTao)
                .OnDelete(DeleteBehavior.NoAction);

            modelBuilder.Entity<PhieuThuongPhat>()
                .HasOne(p => p.PhieuLuong)
                .WithMany() // KhÃ´ng táº¡o collection
                .HasForeignKey(p => p.IdPhieuLuong)
                .OnDelete(DeleteBehavior.SetNull); // Náº¿u xÃ³a phiáº¿u lÆ°Æ¡ng, set null
            // --- THÃŠM 2 DÃ’NG NÃ€Y Äá»‚ Sá»¬A WARNING ---
            modelBuilder.Entity<Sach>()
                .Property(s => s.GiaBia)
                .HasColumnType("decimal(18, 2)");
            // --- THÃŠM 2 DÃ’NG NÃ€Y Äá»‚ Sá»¬A WARNING ---
            // <-- THÃŠM KHÃ“A NGOáº I Má»šI CHO DINHLUONG (Náº¾U CHÆ¯A CÃ“) -->
            modelBuilder.Entity<DinhLuong>()
                .HasOne(d => d.DonViSuDung)
                .WithMany(dv => dv.DinhLuongs)
                .HasForeignKey(d => d.IdDonViSuDung)
                .OnDelete(DeleteBehavior.NoAction); // Ráº¥t quan trá»ng

            // Cáº¥u hÃ¬nh Quan há»‡ Ä‘áº·c biá»‡t (vÃ­ dá»¥: Tá»± tham chiáº¿u)
            modelBuilder.Entity<DanhMuc>()
                .HasOne(d => d.DanhMucCha)
                .WithMany(d => d.DanhMucCons)
                .HasForeignKey(d => d.IdDanhMucCha)
                .OnDelete(DeleteBehavior.NoAction); // TrÃ¡nh lá»—i self-referencing cascade

            modelBuilder.Entity<DonXinNghi>()
                .HasOne(d => d.NguoiDuyet)
                .WithMany(nv => nv.DonXinNghiNguoiDuyets)
                .HasForeignKey(d => d.IdNguoiDuyet)
                .OnDelete(DeleteBehavior.NoAction);

            // Cáº¥u hÃ¬nh Quan há»‡ cho DeXuatSanPham
            modelBuilder.Entity<DeXuatSanPham>()
                .HasOne(d => d.SanPhamGoc)
                .WithMany(p => p.DeXuatSanPhamGocs)
                .HasForeignKey(d => d.IdSanPhamGoc)
                .OnDelete(DeleteBehavior.NoAction);

            modelBuilder.Entity<DeXuatSanPham>()
                .HasOne(d => d.SanPhamDeXuat)
                .WithMany(p => p.DeXuatSanPhamDeXuats)
                .HasForeignKey(d => d.IdSanPhamDeXuat)
                .OnDelete(DeleteBehavior.NoAction);

            // Cáº¥u hÃ¬nh Quan há»‡ cho DeXuatSach
            modelBuilder.Entity<DeXuatSach>()
               .HasOne(d => d.SachGoc)
               .WithMany(p => p.DeXuatSachGocs)
               .HasForeignKey(d => d.IdSachGoc)
               .OnDelete(DeleteBehavior.NoAction);

            modelBuilder.Entity<DeXuatSach>()
                .HasOne(d => d.SachDeXuat)
                .WithMany(p => p.DeXuatSachDeXuats)
                .HasForeignKey(d => d.IdSachDeXuat)
                .OnDelete(DeleteBehavior.NoAction);

            // Táº¯t ON DELETE CASCADE cho cÃ¡c khÃ³a ngoáº¡i gÃ¢y lá»—i (náº¿u cáº§n)
            // VÃ­ dá»¥: Báº£ng NhatKyHuyMon
            modelBuilder.Entity<NhatKyHuyMon>()
                .HasOne(n => n.HoaDon)
                .WithMany(h => h.NhatKyHuyMons)
                .HasForeignKey(n => n.IdHoaDon)
                .OnDelete(DeleteBehavior.NoAction);

            modelBuilder.Entity<NhatKyHuyMon>()
                .HasOne(n => n.NhanVienHuy)
                .WithMany(nv => nv.NhatKyHuyMons)
                .HasForeignKey(n => n.IdNhanVienHuy)
                .OnDelete(DeleteBehavior.NoAction);
        }
    }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\appsettings.Development.json e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\appsettings.json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "CafeBookConnectionString": "Server=localhost\\SQLEXPRESS;Database=CAFEBOOKDB_v2;Integrated Security=True;Encrypt=False;"
  }
}
e:\Tai Lieu Hoc Tap\CS 445 AM\Project\CafebookApi\Program.cs
using CafebookApi.Data;
using Microsoft.EntityFrameworkCore;

var builder = WebApplication.CreateBuilder(args);

// 1ï¸âƒ£ Káº¿t ná»‘i SQL Server
var connectionString = builder.Configuration.GetConnectionString("CafeBookConnectionString");
builder.Services.AddDbContext<CafebookDbContext>(options =>
    options.UseSqlServer(connectionString));

// 2ï¸âƒ£ Cáº¥u hÃ¬nh controller, Swagger
builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

var app = builder.Build();

// 3ï¸âƒ£ Swagger (chá»‰ báº­t khi dev)
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

// 4ï¸âƒ£ Cho phÃ©p truy cáº­p file tÄ©nh (wwwroot)
app.UseStaticFiles();  // <--- Quan trá»ng: náº±m trÆ°á»›c UseRouting()

// 5ï¸âƒ£ Há»— trá»£ HTTPS redirect
//app.UseHttpsRedirection();

app.UseRouting();

app.UseAuthorization();

// 6ï¸âƒ£ Map controllers
app.MapControllers();

app.Run();
