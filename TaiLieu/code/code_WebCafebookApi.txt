=== MÃ NGUỒN DỰ ÁN: WebCafebookApi ===

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\appsettings.Development.json
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\appsettings.json
================================================================================
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "SmtpSettings": {
    "Host": "smtp.gmail.com",
    "Port": 587,
    "Username": "cafebook.hotro@gmail.com",
    "Password": "raja nenx mxhk vtvn",
    "EnableSsl": true,
    "FromName": "Cafebook Hỗ Trợ"
  }
}

================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\libman.json
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Program.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Program.cs
// (Nội dung đầy đủ của file Program.cs dựa trên context bạn cung cấp)

using Microsoft.AspNetCore.Authentication.Cookies;
using WebCafebookApi.Services;
using System.Net.Http.Headers;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddHttpContextAccessor();

// SỬA CẤU HÌNH HTTPCLIENT
builder.Services.AddHttpClient("ApiClient", (serviceProvider, client) =>
{
    client.BaseAddress = new Uri("http://localhost:5166");
    client.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

    var httpContextAccessor = serviceProvider.GetService<IHttpContextAccessor>();
    if (httpContextAccessor != null)
    {
        // SỬA: Đọc JWT Token từ Session (do DangNhapView.cshtml.cs lưu vào)
        var token = httpContextAccessor.HttpContext?.Session.GetString("JwtToken");

        if (!string.IsNullOrEmpty(token))
        {
            // Gắn JWT Token thật vào Header
            client.DefaultRequestHeaders.Authorization =
                new AuthenticationHeaderValue("Bearer", token);
        }
    }
});
// (Kết thúc sửa)

builder.Services.AddHttpClient();

builder.Services.AddDistributedMemoryCache();
builder.Services.AddSession(options =>
{
    options.IdleTimeout = TimeSpan.FromMinutes(30);
    options.Cookie.HttpOnly = true;
    options.Cookie.IsEssential = true;
});

builder.Services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
    .AddCookie(options =>
    {
        options.Cookie.Name = "AuthToken"; // Cookie này chỉ dùng cho Frontend
        options.LoginPath = "/account/DangNhapView";
        options.AccessDeniedPath = "/AccessDenied";
        options.LogoutPath = "/Account/DangXuat";
    });

builder.Services.AddRazorPages();
builder.Services.Configure<SmtpSettings>(builder.Configuration.GetSection("SmtpSettings"));
builder.Services.AddTransient<EmailService>();
builder.Services.AddMemoryCache();

var app = builder.Build();

// ... (Pipeline giữ nguyên) ...
//app.UseHttpsRedirection();
app.UseStaticFiles();
app.UseRouting();

// Đảm bảo đúng thứ tự
app.UseSession(); // Session phải được gọi trước
app.UseAuthentication();
app.UseAuthorization();

app.MapRazorPages();
app.Run();
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\WebCafebookApi.csproj
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\WebCafebookApi.csproj.user
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\AccessDenied.cshtml
================================================================================
﻿@page
@{
    ViewData["Title"] = "Từ chối truy cập";
    Layout = "_Layout_Employee";
}

<div class="container text-center mt-5">
    <h1 class="text-danger display-1 fw-bold">403</h1>
    <h2 class="mb-3">Truy cập bị từ chối</h2>
    <p class="lead text-muted">Xin lỗi, bạn không có quyền truy cập vào trang này.</p>
    <a href="/Employee/WebQuanLyView" class="btn btn-primary mt-3">Quay lại Trang chủ</a>
</div>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\AccessDenied.cshtml.cs
================================================================================
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;

namespace WebCafebookApi.Pages
{
    public class AccessDeniedModel : PageModel
    {
        public void OnGet()
        {
        }
    }
}

================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\ChinhSachView.cshtml
================================================================================
﻿@page "/Privacy"
@model WebCafebookApi.Pages.ChinhSachViewModel
@{
    ViewData["Title"] = "Chính sách & Giới thiệu";
}

@* ... (Phần @section và <style> giữ nguyên) ... *@
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
}
<style>
    .policy-container h2 {
        color: var(--cf-dark-brown, #4E342E);
        font-weight: 700;
        margin-top: 2.5rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--cf-orange, #D27D2D);
    }

    .policy-container h3 {
        color: var(--cf-brown, #6F4E37);
        font-weight: 600;
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
    }

    .policy-container p,
    .policy-container li {
        line-height: 1.7;
        color: var(--cf-text, #4E342E);
        font-size: 1.05rem;
    }

    .policy-container ul {
        padding-left: 1.5rem;
    }
</style>

<div class="container mt-5 mb-5 policy-container">
    <div class="row">
        <div class="col-lg-10 mx-auto">

            <div class="text-center mb-5">
                <h1>Về Cafebook & Điều khoản</h1>
                <p class="lead text-muted">Những giá trị cốt lõi và quy định chung tại không gian của chúng tôi.</p>
            </div>

            <h2>Về Chúng Tôi</h2>
            <p>
                <strong>Cafebook</strong> được sinh ra từ niềm đam mê bất tận với hai thứ: hương vị đậm đà của cà phê nguyên chất và giá trị vĩnh cửu của những trang sách. Chúng tôi không chỉ là một quán cà phê, chúng tôi là một "Ốc đảo tri thức", một không gian yên tĩnh nơi bạn có thể tạm gác lại những bộn bề của cuộc sống để đắm mình trong thế giới của riêng mình.
            </p>
            <p>
                Sứ mệnh của chúng tôi là tạo ra một cộng đồng nơi những người yêu sách và đam mê cà phê có thể kết nối, chia sẻ và truyền cảm hứng. Từ hạt cà phê Robusta Việt Nam được rang xay tỉ mỉ đến những cuốn sách kinh điển thế giới được chọn lọc kỹ càng, mọi chi tiết tại Cafebook đều được chăm chút để mang đến cho bạn trải nghiệm trọn vẹn nhất.
            </p>

            <h2>Điều Khoản Dịch Vụ</h2>
            <p>
                Chào mừng bạn đến với Cafebook. Bằng việc sử dụng các dịch vụ của chúng tôi (bao gồm gọi món, đặt bàn, và thuê sách), bạn đồng ý tuân thủ các điều khoản và điều kiện dưới đây:
            </p>

            <h3>1. Quy định chung tại cửa hàng</h3>
            <ul>
                <li>Vui lòng giữ gìn không gian yên tĩnh, đặc biệt tại các khu vực làm việc và đọc sách (Tầng 2, Gác lửng).</li>
                <li>Không mang đồ ăn, thức uống từ bên ngoài vào cửa hàng.</li>
                <li>Chúng tôi không chịu trách nhiệm về tài sản cá nhân của quý khách.</li>
            </ul>

            <h3>2. Dịch vụ Đặt bàn</h3>
            <ul>
                <li>Việc đặt bàn trực tuyến qua website hoặc ứng dụng cần được thực hiện trước ít nhất 1 giờ.</li>
                <li>Chúng tôi sẽ giữ bàn cho bạn trong vòng 15 phút kể từ thời gian đặt hẹn. Sau thời gian trên, đặt hẹn có thể bị hủy để nhường chỗ cho khách hàng khác.</li>
                <li>Đối với các yêu cầu đặc biệt (phòng VIP, nhóm đông), vui lòng liên hệ trực tiếp qua hotline.</li>
            </ul>

            <h3>3. Dịch vụ Thuê sách</h3>
            <ul>
                <li>Bạn có thể đọc sách tại chỗ miễn phí khi sử dụng dịch vụ của quán.</li>
                <li>Khi thuê sách mang về, bạn cần cung cấp thông tin cá nhân (Tên, SĐT) và thanh toán một khoản tiền cọc tương đương với giá bìa của cuốn sách.</li>

                <li>
                    Phí dịch vụ thuê sách (hiện tại là <strong>@Model.ChinhSach.PhiThue.ToString("N0")đ</strong>) và mọi khoản phí phạt trễ hạn (nếu có) sẽ được khấu trừ vào tiền cọc khi bạn trả sách.
                </li>
                <li>
                    Thời gian thuê tiêu chuẩn là 7 ngày. Phí phạt trễ hạn là <strong>@Model.ChinhSach.PhiTraTreMoiNgay.ToString("N0")đ</strong> cho mỗi ngày quá hạn.
                </li>

                <li>Vui lòng giữ gìn sách cẩn thận, không làm rách, ướt, hoặc ghi chú lên sách. Trường hợp sách bị hư hỏng nặng, chúng tôi có thể sẽ giữ lại toàn bộ tiền cọc để bù đắp chi phí.</li>
            </ul>

            <h3>4. Chính sách thành viên & Tích điểm</h3>
            <ul>
                <li>Khi đăng ký tài khoản trên website (hoặc cung cấp SĐT tại quầy), bạn sẽ tự động trở thành thành viên của Cafebook.</li>

                <li>
                    Với mỗi <strong>@Model.ChinhSach.DiemNhanVND.ToString("N0")đ</strong> trong hóa đơn, bạn sẽ được tích <strong>1 điểm</strong>.
                </li>
                <li>
                    Mỗi <strong>1 điểm</strong> tích lũy có giá trị quy đổi thành <strong>@Model.ChinhSach.DiemDoiVND.ToString("N0")đ</strong>, được trừ trực tiếp vào hóa đơn lần sau.
                </li>
            </ul>

            <h3>5. Miễn trừ trách nhiệm</h3>
            <p>
                Cafebook có quyền thay đổi, cập nhật hoặc ngưng các điều khoản này, cũng như các chương trình khuyến mãi, giá cả dịch vụ mà không cần báo trước. Các thay đổi sẽ được cập nhật công khai trên website này.
            </p>

        </div>
    </div>
</div>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\ChinhSachView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/ChinhSachView.cshtml.cs
using CafebookModel.Model.ModelWeb; // THÊM DTO MỚI
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Json; // THÊM
using System.Threading.Tasks; // THÊM

namespace WebCafebookApi.Pages
{
    public class ChinhSachViewModel : PageModel
    {
        // THÊM MỚI: Khởi tạo HttpClient
        private readonly IHttpClientFactory _httpClientFactory;
        public ChinhSachViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        // THÊM MỚI: Model để chứa dữ liệu
        public ChinhSachDto ChinhSach { get; set; } = new ChinhSachDto();

        public async Task OnGetAsync()
        {
            // THÊM MỚI: Logic tải dữ liệu động
            var httpClient = _httpClientFactory.CreateClient();
            try
            {
                var response = await httpClient.GetFromJsonAsync<ChinhSachDto>("http://localhost:5166/api/web/chinhsach/data");
                if (response != null)
                {
                    ChinhSach = response;
                }
            }
            catch (Exception)
            {
                // Nếu API lỗi, ChinhSach sẽ dùng giá trị mặc định đã khởi tạo
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\ChiTietSachView.cshtml
================================================================================
﻿@page "{id:int}"
@model WebCafebookApi.Pages.ChiTietSachViewModel

@{
    ViewData["Title"] = Model.Sach?.TieuDe ?? "Chi Tiết Sách";
    var imgSrc = string.IsNullOrEmpty(Model.Sach?.AnhBiaUrl)
        ? "/images/default-book-cover.png"
        : Model.Sach.AnhBiaUrl;
}

@section Styles {
    <style>
        /* ==============================
           CSS CHO TABS (ĐỒNG BỘ TỪ TRANG SẢN PHẨM)
        ============================== */
        /* Các biến màu (giả định) */
        :root {
            --cf-orange-light: #FF9800;
            --cf-orange: #F57C00;
            --cf-text: #333333;
            --cf-white: #ffffff;
            --cf-shadow: rgba(0, 0, 0, 0.08);
        }
        
        /* Card container */
        .product-detail-card,
        .tab-content {
            background-color: var(--cf-white);
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--cf-shadow);
        }

        /* CSS cho các tab */
        .product-tabs .nav-link {
            color: var(--cf-text);
            background-color: var(--cf-white);
            border: none;
            border-bottom: 3px solid transparent;
            border-radius: 0;
            font-weight: 500;
            padding-top: 1rem;
            padding-bottom: 1rem;
            text-transform: uppercase;
            font-size: 0.9rem;
            transition: all 0.2s ease-in-out;
        }

        .product-tabs .nav-link.active {
            color: var(--cf-orange);
            border-bottom-color: var(--cf-orange);
            background-color: var(--cf-white);
        }

        .product-tabs .nav-link:hover:not(.active) {
            color: var(--cf-orange-light);
            border-bottom-color: rgba(var(--cf-orange-light), 0.3);
        }

        .product-tabs {
            background-color: var(--cf-white);
            border-radius: 8px 8px 0 0;
            box-shadow: 0 1px 3px var(--cf-shadow);
            margin-bottom: -1px;
            border-bottom: 1px solid #dee2e6;
        }

        /* Tăng khoảng cách các phần */
        .product-section {
            margin-bottom: 2.5rem;
        }

        /* ==============================
           CSS CHO MÔ TẢ (GIỮ NGUYÊN)
        ============================== */
        #description-wrapper.description-truncated p {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: .5rem !important;
        }

        #description-wrapper.description-expanded p {
            display: block;
            white-space: pre-wrap !important;
            overflow: visible;
        }

        /* ==============================
           CSS CHO TRANG (GIỮ NGUYÊN)
        ============================== */
        .detail-img-container img {
            max-height: 500px;
            object-fit: cover;
        }

        .ingredient-list li {
            margin-bottom: .5rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* ==============================
           CSS MỚI: HỘP THUÊ SÁCH
        ============================== */
        .rent-box-card {
            background-color: #fdfaf6; /* Màu nền be nhạt */
            border-radius: 8px;
            border: 1px solid #eee;
            padding: 1.25rem;
        }
    </style>
}

<div class="container mt-5">

    @if (Model.Sach != null)
    {
        <div class="row product-detail-card p-4 gy-4 product-section">

            <div class="col-lg-4">
                <div class="detail-img-container">
                    <img src="@imgSrc" class="img-fluid rounded shadow-sm w-100" alt="@Model.Sach.TieuDe">
                </div>
            </div>

            <div class="col-lg-8 ps-lg-5">

                <nav aria-label="breadcrumb" class="page-breadcrumb mb-3">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a asp-page="/TrangChuView">
                                <span class="material-symbols-outlined">home</span> Trang Chủ
                            </a>
                        </li>
                        <li class="breadcrumb-item">
                            <a asp-page="/ThuVienSachView">
                                <span class="material-symbols-outlined">import_contacts</span> Thư Viện Sách
                            </a>
                        </li>
                        <li class="breadcrumb-item active">@Model.Sach.TieuDe</li>
                    </ol>
                </nav>

                <h1 class="display-5 fw-bold">@Model.Sach.TieuDe</h1>

                <p class="lead fs-5 mb-4">
                    Tác giả:
                    @if (Model.Sach.TacGias?.Any() == true)
                    {
                        foreach (var tg in Model.Sach.TacGias)
                        {
                            <a asp-page="/TimKiemSachView"
                               asp-route-idTacGia="@tg.IdTacGia"
                               class="text-muted text-decoration-none">@tg.TenTacGia</a>
                            @(tg != Model.Sach.TacGias.Last() ? ", " : "")
                        }
                    }
                    else
                    {
                        <span class="text-muted">(Đang cập nhật)</span>
                    }
                </p>

                <h3 class="text-danger fw-bolder mb-4">
                    @Model.Sach.GiaBia.ToString("N0") đ
                    <small class="text-muted fs-5">(Tiền cọc)</small>
                </h3>

                <hr class="my-4" />

                <div class="rent-box-card">
                    <h5 class="card-title mb-3">Thuê Sách</h5>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fs-6" style="font-weight: 500;">Tình trạng:</span>
                        @if (Model.Sach.SoLuongCoSan > 0)
                        {
                            <strong class="text-success ms-2">
                                <span class="material-symbols-outlined" style="vertical-align: sub; font-size: 1.1rem;">check_circle</span>
                                Còn @Model.Sach.SoLuongCoSan cuốn
                            </strong>
                        }
                        else
                        {
                            <strong class="text-danger ms-2">
                                <span class="material-symbols-outlined" style="vertical-align: sub; font-size: 1.1rem;">cancel</span>
                                Đã thuê hết
                            </strong>
                        }
                    </div>
                    
                    <div class="d-grid gap-3">
                        <button type="button" class="btn btn-lg px-4 btn-primary-custom" disabled>
                            <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.2rem;">auto_stories</span>
                            Thuê sách (Sắp có)
                        </button>
                    </div>
                     <small class="text-muted d-block text-center mt-3">Vui lòng liên hệ quầy để làm thủ tục thuê sách.</small>
                </div>
                </div>
        </div>
        <div class="mt-5 product-section">
            <ul class="nav nav-tabs product-tabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#descriptionTab">Mô Tả Chi Tiết</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#stockTab">Thông Tin Kho</a>
                </li>
            </ul>

            <div class="tab-content p-4">
                <div class="tab-pane fade show active" id="descriptionTab">
                    
                    <h5 class="fw-bold">Thể loại</h5>
                    <div class="mb-3">
                        @if (Model.Sach.TheLoais?.Any() == true)
                        {
                            foreach (var tl in Model.Sach.TheLoais)
                            {
                                <a asp-page="/TimKiemSachView"
                                   asp-route-idTheLoai="@tl.IdTheLoai"
                                   class="badge bg-primary text-decoration-none me-1 mb-1">@tl.TenTheLoai</a>
                            }
                        }
                        else
                        {
                            <span class="badge bg-secondary">(Đang cập nhật)</span>
                        }
                    </div>

                    <h5 class="fw-bold mt-4">Nhà xuất bản</h5>
                    <div class="mb-4">
                        @if (Model.Sach.NhaXuatBans?.Any() == true)
                        {
                            foreach (var nxb in Model.Sach.NhaXuatBans)
                            {
                                <a asp-page="/TimKiemSachView"
                                   asp-route-idNXB="@nxb.IdNhaXuatBan"
                                   class="badge bg-success text-decoration-none me-1 mb-1">@nxb.TenNhaXuatBan</a>
                            }
                        }
                        else
                        {
                            <span class="badge bg-secondary">(Đang cập nhật)</span>
                        }
                    </div>

                    <h5 class="fw-bold mt-4">Giới thiệu sách</h5>
                    <div id="description-wrapper" class="description-truncated">
                        <p class="mt-3 fs-6" style="white-space: pre-wrap;">
                            @Model.Sach.MoTa
                        </p>
                    </div>
                    <a id="toggle-description"
                       href="javascript:void(0);"
                       class="btn btn-link ps-0"
                       style="display:none;">Đọc thêm...</a>
                </div>

                <div class="tab-pane fade" id="stockTab">
                    <h5 class="fw-bold mb-3">Thông tin kho</h5>
                    <ul class="ingredient-list list-unstyled fs-6">
                        <li class="list-group-item d-flex justify-content-between align-items-center py-2 px-0">
                            <div>
                                <span class="material-symbols-outlined text-muted me-2" style="vertical-align: bottom;">push_pin</span>
                                Vị trí:
                            </div>
                            <strong class="ms-2">@Model.Sach.ViTri</strong>
                        </li>
                         <li class="list-group-item d-flex justify-content-between align-items-center py-2 px-0 border-top">
                            <div>
                                <span class="material-symbols-outlined text-muted me-2" style="vertical-align: bottom;">inventory</span>
                                Tổng số lượng:
                            </div>
                            <strong class="ms-2">@Model.Sach.TongSoLuong cuốn</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center py-2 px-0 border-top">
                            <div>
                                <span class="material-symbols-outlined text-muted me-2" style="vertical-align: bottom;">check_circle</span>
                                Hiện có sẵn:
                            </div>
                            @if (Model.Sach.SoLuongCoSan > 0)
                            {
                                <strong class="text-success ms-2">@Model.Sach.SoLuongCoSan cuốn</strong>
                            }
                            else
                            {
                                <strong class="text-danger ms-2">Đã thuê hết</strong>
                            }
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="row mt-5 product-section">
            <div class="col-12">

                <h3 class="border-bottom pb-2 mb-3 section-header">
                    <span class="material-symbols-outlined">recommend</span> Có thể bạn cũng thích
                </h3>

                @if (Model.Sach.GoiY?.Any() == true)
                {
                    <div class="row row-cols-2 row-cols-md-4 row-cols-lg-5 g-3"> @foreach (var item in Model.Sach.GoiY)
                        {
                            var imgUrl = string.IsNullOrEmpty(item.AnhBiaUrl)
                                ? "/images/default-book-cover.png"
                                : item.AnhBiaUrl;
                            <div class="col">
                                <a asp-page="/ChiTietSachView"
                                   asp-route-id="@item.IdSach"
                                   class="text-decoration-none">

                                    <div class="card h-100 product-card">
                                        <div class="card-img-container">
                                            <img src="@imgUrl"
                                                 class="card-img-top book-card-img"
                                                 alt="@item.TieuDe" />
                                        </div>

                                        <div class="card-body d-flex flex-column">
                                            <h6 class="book-card-title">@item.TieuDe</h6>
                                            <p class="card-text text-danger fw-bold mt-auto mb-0">
                                                @item.GiaBia.ToString("N0") đ
                                            </p>
                                        </div>
                                    </div>

                                </a>
                            </div>
                        }

                    </div>
                }
                else
                {
                    <p class="text-muted">(Chưa có gợi ý nào cho cuốn sách này.)</p>
                }

            </div>
        </div>

    }
    else
    {
        <div class="alert alert-danger">
            <h4>Không tìm thấy sách</h4>
            <p>@Model.ErrorMessage</p>
        </div>
        <a asp-page="/ThuVienSachView" class="btn btn-link">Quay lại thư viện</a>
    }

</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        $(function () {
            // Logic "Đọc thêm"
            const $wrapper = $('#description-wrapper');
            const $content = $wrapper.find('p');
            const $btn = $('#toggle-description');

            const lineHeight = parseFloat($content.css("line-height"));
            const maxHeight = lineHeight * 3;

            if ($content[0].scrollHeight > (maxHeight + 5)) { // Thêm 5px dự phòng
                $btn.show();
            }

            $btn.on("click", function () {
                const expanded = $wrapper.hasClass('description-expanded');
                $wrapper.toggleClass('description-expanded description-truncated');
                $btn.text(expanded ? "Đọc thêm..." : "Thu gọn");
            });
        });
    </script>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\ChiTietSachView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/ChiTietSachView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
// using WebCafebookApi.Services; // ĐÃ XÓA
// using System.Linq; // ĐÃ XÓA
// using Microsoft.AspNetCore.Http; // ĐÃ XÓA
// using System.Collections.Generic; // ĐÃ XÓA

namespace WebCafebookApi.Pages
{
    public class ChiTietSachViewModel : PageModel
    {
        // ... (Constructor và OnGetAsync giữ nguyên) ...
        private readonly IHttpClientFactory _httpClientFactory;
        public ChiTietSachViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        [BindProperty(SupportsGet = true)]
        public int Id { get; set; }

        public SachChiTietDto? Sach { get; set; }
        public string? ErrorMessage { get; set; }

        public async Task<IActionResult> OnGetAsync()
        {
            if (Id <= 0)
            {
                ErrorMessage = "ID sách không hợp lệ.";
                return Page();
            }

            var httpClient = _httpClientFactory.CreateClient("ApiClient");
            try
            {
                Sach = await httpClient.GetFromJsonAsync<SachChiTietDto>($"api/web/thuvien/{Id}");
                if (Sach == null)
                {
                    ErrorMessage = "Không tìm thấy cuốn sách bạn yêu cầu.";
                    return Page();
                }
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Lỗi khi tải chi tiết: {ex.Message}";
            }
            return Page();
        }


        // === CẬP NHẬT HÀM XỬ LÝ GIỎ HÀNG ===
        // 
        //  ĐÃ XÓA TOÀN BỘ PHƯƠNG THỨC OnPostAddToCart TỪ ĐÂY
        //
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\ChiTietSanPhamView.cshtml
================================================================================
﻿@page "/san-pham/{id:int}"
@model WebCafebookApi.Pages.ChiTietSanPhamViewModel
@{
    ViewData["Title"] = Model.SanPham?.TenSanPham ?? "Chi tiết sản phẩm";
}

@section Styles {
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Material+Symbols+Outlined" rel="stylesheet" />

    <style>
        .section-header {
            font-size: 1.75rem; /* 28px */
            font-weight: 700;
            color: var(--coffee-dark);
            display: flex;
            align-items: center;
            gap: 8px;
            border-color: #E0E0E0 !important;
        }

            .section-header .material-symbols-outlined {
                font-size: 28px;
                color: var(--earth-orange);
            }

        :root {
            --coffee-dark: #4E342E;
            --coffee: #6D4C41;
            --coffee-light: #A1887F;
            --cream: #FFF8E1;
            --beige: #F5E6D3;
            --earth-orange: #E57A3B;
            --earth-orange-dark: #cf6b2f;
            --white: #ffffff;
            --radius: 14px;
            --shadow: 0px 8px 24px rgba(0,0,0,0.08);
            --shadow-hover: 0px 14px 34px rgba(0,0,0,0.14);
            --transition: all 0.28s ease;
        }

        body {
            background: var(--cream);
            font-family: 'Inter', sans-serif;
        }

        /* PRODUCT MAIN CARD */
        .product-wrapper {
            background: var(--white);
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

            .product-wrapper:hover {
                transform: translateY(-4px);
                box-shadow: var(--shadow-hover);
            }

        .product-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--coffee-dark);
        }

        .product-image {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

            .product-image:hover {
                transform: scale(1.03);
            }

        /* STAR */
        .star-rating .material-symbols-outlined {
            color: #FFC107;
            font-size: 22px;
        }

        .star-rating .empty {
            color: #D7CCC8;
        }

        /* PRICE */
        .price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--earth-orange);
        }

        /* QUANTITY INPUT */
        .qty-box {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .qty-btn {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            border: 1px solid #BCAAA4;
            background: var(--white);
            font-size: 20px;
            transition: var(--transition);
            user-select: none;
        }

            .qty-btn:hover {
                background: var(--beige);
                transform: translateY(-2px);
            }

            .qty-btn:active {
                transform: translateY(1px) scale(0.95);
                background: var(--beige);
                box-shadow: none;
            }

        .qty-input {
            width: 70px;
            padding: 8px;
            border-radius: 10px;
            border: 1px solid #BCAAA4;
            text-align: center;
            transition: var(--transition);
        }

            .qty-input:focus {
                border-color: var(--earth-orange);
                box-shadow: 0 0 0 3px rgba(229, 122, 59, .25);
            }

        /* BUTTONS */
        .btn-cafe {
            background: var(--earth-orange);
            color: white;
            padding: 14px 26px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 6px;
        }

            .btn-cafe:hover {
                background: var(--earth-orange-dark);
                transform: translateY(-3px);
                box-shadow: var(--shadow-hover);
            }

        .btn-gray {
            background: var(--coffee-light);
            color: white;
            padding: 14px 26px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            opacity: .8;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* TABS */
        .tabs-cafe .nav-link {
            border: none;
            border-bottom: 3px solid transparent;
            padding: 1rem 1.4rem;
            font-weight: 600;
            color: var(--coffee-dark);
            transition: var(--transition);
        }

            .tabs-cafe .nav-link.active {
                color: var(--earth-orange);
                border-color: var(--earth-orange);
            }

            .tabs-cafe .nav-link:hover {
                color: var(--earth-orange);
                background: rgba(229, 122, 59, 0.07);
            }

        .tab-pane {
            background: var(--white);
            padding: 2rem;
            border-radius: 0 0 var(--radius) var(--radius);
            box-shadow: var(--shadow);
        }

        /* REVIEW */
        .review-item {
            padding: 1.2rem 0;
            border-bottom: 1px solid #eee;
        }

        .review-avatar {
            width: 52px;
            height: 52px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid var(--beige);
        }

        .review-reply {
            background: #F9FBE7;
            border: 1px solid #EEE;
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
        }

        /* RECOMMENDED PRODUCTS */
        .recommend-card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: var(--transition);
            position: relative;
            /* FIX LỖI CHE TOÀN MÀN HÌNH */
        }

            .recommend-card:hover {
                transform: translateY(-6px);
                box-shadow: var(--shadow-hover);
            }

            .recommend-card img {
                width: 100%;
                aspect-ratio: 1/1;
                object-fit: cover;
            }
    </style>
}


@if (Model.SanPham != null)
{
    <div class="container py-5">

        <div class="product-wrapper mb-5">
            <div class="row g-4">

                <div class="col-lg-5">
                    <img src="@Model.SanPham.HinhAnhUrl" class="product-image" />
                </div>

                <div class="col-lg-7">
                    <h1 class="product-title">@Model.SanPham.TenSanPham</h1>

                    <div class="d-flex align-items-center mb-2">
                        <span class="fs-5 fw-bold text-danger me-2">@Model.SaoTrungBinh.ToString("0.0")</span>

                        <div class="star-rating me-2">
                            @for (int i = 1; i <= 5; i++)
                            {
                                <span class="material-symbols-outlined @(i <= Model.SaoTrungBinh ? "" : "empty")">star</span>
                            }
                        </div>

                        <span class="text-muted">(@Model.TongSoDanhGia đánh giá)</span>
                    </div>

                    <div class="price my-3">@Model.SanPham.DonGia.ToString("N0") đ</div>

                    <p class="text-muted">@Model.SanPham.MoTa</p>

                    <hr />

                    <form method="post" asp-page-handler="AddToCart">
                        <input type="hidden" name="idSanPham" value="@Model.SanPham.IdSanPham" />

                        <label class="fw-semibold mb-1">Số lượng</label>
                        <div class="qty-box mb-4">
                            <button type="button" class="qty-btn btn-minus">-</button>
                            <input asp-for="SoLuong" name="SoLuong" type="number" value="1" min="1" max="99" class="qty-input" />
                            <button type="button" class="qty-btn btn-plus">+</button>
                        </div>

                        <div class="d-flex gap-3">
                            <button type="submit" class="btn-cafe">
                                <span class="material-symbols-outlined">add_shopping_cart</span> Thêm vào giỏ
                            </button>

                            <button type="button" class="btn-gray" disabled>
                                <span class="material-symbols-outlined">bolt</span> Mua ngay (Sắp có)
                            </button>
                        </div>
                    </form>

                </div>
            </div>
        </div>

        <ul class="nav nav-tabs tabs-cafe">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#reviewsTab">Đánh giá (@Model.TongSoDanhGia)</a>
            </li>

            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#descTab">Mô tả chi tiết</a>
            </li>
        </ul>

        <div class="tab-content">

            <div class="tab-pane fade show active" id="reviewsTab">
                @if (!Model.DanhSachDanhGia.Any())
                {
                    <div class="alert alert-warning text-center mt-3">
                        Chưa có đánh giá nào cho sản phẩm này.
                    </div>
                }
                else
                {
                    @foreach (var rv in Model.DanhSachDanhGia)
                    {
                        <div class="review-item d-flex gap-3">
                            <img src="@(rv.AvatarKhachHang ?? "/images/default-avatar.png")" class="review-avatar" />

                            <div>
                                <strong>@rv.TenKhachHang</strong>

                                <div class="star-rating my-1">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        <span class="material-symbols-outlined @(i <= rv.SoSao ? "" : "empty")">star</span>
                                    }
                                </div>

                                <small class="text-muted">@rv.NgayTao.ToString("dd/MM/yyyy HH:mm")</small>

                                @if (!string.IsNullOrEmpty(rv.BinhLuan))
                                {
                                    <p class="mt-2">@rv.BinhLuan</p>
                                }

                                @if (!string.IsNullOrEmpty(rv.HinhAnhUrl))
                                {
                                    <img src="@rv.HinhAnhUrl" style="width:90px;height:90px;border-radius:12px;object-fit:cover;box-shadow:var(--shadow);" />
                                }

                                @if (rv.PhanHoi != null)
                                {
                                    <div class="review-reply">
                                        <strong>Phản hồi từ @rv.PhanHoi.TenNhanVien</strong>
                                        <small class="text-muted d-block" style="font-size: 0.8rem;">@rv.PhanHoi.NgayTao.ToString("dd/MM/yyyy HH:mm")</small>
                                        <p class="mt-2 mb-0">@rv.PhanHoi.NoiDung</p>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                }
            </div>

            <div class="tab-pane fade" id="descTab">
                <h5 class="fw-bold mb-3">Mô tả sản phẩm</h5>
                <p>@Model.SanPham.MoTa</p>

                <h5 class="fw-bold mt-4">Thông tin chi tiết</h5>

                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between px-0">
                        <strong>Danh mục:</strong> <span>@Model.SanPham.TenLoaiSP</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between px-0">
                        <strong>Giá:</strong> <span class="text-danger fw-bold">@Model.SanPham.DonGia.ToString("N0") đ</span>
                    </li>
                </ul>
            </div>
        </div>

        @if (Model.SanPham.GoiY.Any())
        {
            <h3 class="border-bottom pb-2 mb-3 section-header mt-5">
                <span class="material-symbols-outlined">recommend</span> Có thể bạn cũng thích
            </h3>

            <div class="row g-4">
                @foreach (var item in Model.SanPham.GoiY)
                {
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="recommend-card">
                            <img src="@item.AnhSanPhamUrl" alt="@item.TenSanPham" />
                            <div class="p-3">
                                <h6 class="fw-semibold">@item.TenSanPham</h6>
                                <div class="text-danger fw-bold">@item.DonGia.ToString("N0") đ</div>
                                <a href="/san-pham/@item.IdSanPham" class="stretched-link"></a>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <p class="text-muted mt-5">(Chưa có gợi ý nào cho món này.)</p>
        }
    </div>
}
else
{
    <div class="container py-5">
        <div class="alert alert-danger shadow p-4 rounded">
            @Model.ErrorMessage
        </div>
    </div>
}

@section Scripts {
    <script>
        $(function () {

            // --- NÚT TĂNG ---
            $('.btn-plus').on("click", function (event) {
                // *** SỬA LỖI "NHẢY TRANG" ***
                // Ngăn trình duyệt thực hiện hành động mặc định của thẻ <a>
                event.preventDefault();
                // Ngăn sự kiện click "nổi bọt" lên thẻ <a> cha
                event.stopPropagation();
                // Tìm input "anh em" gần nhất
                let input = $(this).closest('.qty-box').find('.qty-input');
                let v = parseInt(input.val());
                if (v < 99) {
                    input.val(v + 1);
                }
            });

            // --- NÚT GIẢM ---
            $('.btn-minus').on("click", function (event) {

                // *** SỬA LỖI "NHẢY TRANG" ***
                event.preventDefault();
                event.stopPropagation();

                let input = $(this).closest('.qty-box').find('.qty-input');
                let v = parseInt(input.val());
                if (v > 1) {
                    input.val(v - 1);
                }
            });

            // --- Ô NHẬP SỐ LƯỢNG ---
            // Ngăn việc "nhấn" vào ô input cũng bị nhảy trang
            $('.qty-input').on("click", function (event) {
                // *** SỬA LỖI "NHẢY TRANG" ***
                event.preventDefault();
                event.stopPropagation();
            });

            // Xử lý khi người dùng tự gõ số
            $('.qty-input').on("change", function () {
                let v = parseInt($(this).val());
                if (isNaN(v) || v < 1) {
                    $(this).val(1); // Nếu nhập số 0 hoặc chữ, tự động đặt lại là 1
                } else if (v > 99) {
                    $(this).val(99); // Giới hạn tối đa 99
                }
            });
        });
    </script>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\ChiTietSanPhamView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/ChiTietSanPhamView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Json;
using System.Threading.Tasks;
using WebCafebookApi.Services;
using System.Collections.Generic;
using System.Linq;

namespace WebCafebookApi.Pages
{
    public class ChiTietSanPhamViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;
        public ChiTietSanPhamViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        [BindProperty(SupportsGet = true)]
        public int Id { get; set; }

        [BindProperty]
        public int SoLuong { get; set; } = 1;

        public SanPhamChiTietDto? SanPham { get; set; }
        public string? ErrorMessage { get; set; }

        public List<DanhGiaWebDto> DanhSachDanhGia { get; set; } = new List<DanhGiaWebDto>();
        public double SaoTrungBinh { get; set; } = 0;
        public int TongSoDanhGia { get; set; } = 0;

        public async Task<IActionResult> OnGetAsync()
        {
            if (Id <= 0)
            {
                ErrorMessage = "ID sản phẩm không hợp lệ.";
                return Page();
            }

            var client = _httpClientFactory.CreateClient("ApiClient");

            // --- Bước 1: Tải sản phẩm ---
            try
            {
                // <<< SỬA LỖI 404 TẠI ĐÂY >>>
                // var productApiUrl = $"/api/web/sanpham/{Id}"; // <-- URL CŨ BỊ SAI
                var productApiUrl = $"/api/web/thucdon/{Id}"; // <-- URL ĐÚNG (theo ThucDonController.cs)

                SanPham = await client.GetFromJsonAsync<SanPhamChiTietDto>(productApiUrl);
            }
            catch (System.Net.Http.HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                ErrorMessage = "Không tìm thấy sản phẩm bạn yêu cầu.";
                return Page();
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Lỗi khi tải chi tiết sản phẩm: {ex.Message}";
                return Page();
            }

            if (SanPham == null)
            {
                ErrorMessage = "Không tìm thấy sản phẩm bạn yêu cầu.";
                return Page();
            }

            // --- Bước 2: Tải đánh giá (Code này đã đúng từ lần trước) ---
            try
            {
                var reviewsApiUrl = $"/api/web/danhgia/sanpham/{Id}";
                DanhSachDanhGia = await client.GetFromJsonAsync<List<DanhGiaWebDto>>(reviewsApiUrl) ?? new List<DanhGiaWebDto>();

                if (DanhSachDanhGia.Any())
                {
                    SaoTrungBinh = DanhSachDanhGia.Average(d => d.SoSao);
                    TongSoDanhGia = DanhSachDanhGia.Count;
                }
            }
            catch (System.Exception ex)
            {
                TempData["ReviewError"] = $"Không thể tải đánh giá: {ex.Message}";
                DanhSachDanhGia = new List<DanhGiaWebDto>();
            }

            return Page();
        }


        // (Hàm OnPostAddToCart giữ nguyên)
        public IActionResult OnPostAddToCart(int idSanPham)
        {
            var cart = HttpContext.Session.Get<List<CartItemDto>>(WebCafebookApi.Services.SessionExtensions.CartKey) ?? new List<CartItemDto>();

            var existingItem = cart.FirstOrDefault(i => i.Id == idSanPham);

            if (existingItem != null)
            {
                existingItem.SoLuong += this.SoLuong;
                TempData["CartMessage"] = $"Đã cập nhật số lượng (tổng: {existingItem.SoLuong}).";
            }
            else
            {
                cart.Add(new CartItemDto { Id = idSanPham, SoLuong = this.SoLuong });
                TempData["CartMessage"] = "Đã thêm sản phẩm vào giỏ!";
            }

            HttpContext.Session.Set(WebCafebookApi.Services.SessionExtensions.CartKey, cart);

            return RedirectToPage("/ChiTietSanPhamView", new { id = idSanPham });
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\DatBanView.cshtml
================================================================================
﻿@page "/dat-ban"
@model WebCafebookApi.Pages.DatBanViewModel
@{
    ViewData["Title"] = "Đặt Bàn";
}

<style>
    /* Style cho nút bấm MẶC ĐỊNH hoặc 'available' */
    .table-select-btn {
        border-color: var(--cf-brown);
        color: var(--cf-dark-brown);
        opacity: 1;
        cursor: pointer;
    }

    /* Style cho DIV cha (cột) khi bàn không khả dụng */
    .table-item.unavailable {
        display: none;
        /* Ẩn hoàn toàn bàn không khả dụng */
    }
</style>

<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="fw-bold" style="color: var(--cf-brown);">ĐẶT BÀN TRỰC TUYẾN</h1>
        <p class="text-muted lead">Chọn thời gian và vị trí yêu thích của bạn</p>
    </div>

    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
            <i class="fa-solid fa-circle-check me-2"></i> @Model.SuccessMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
            <i class="fa-solid fa-circle-exclamation me-2"></i> @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="card shadow-sm border-0 mb-4" style="background-color: var(--cf-white);">
        <div class="card-body p-4">

            <form method="post" asp-page-handler="TimKiem" class="row g-3 align-items-end">
                <div class="col-lg-3 col-md-6">
                    <label asp-for="Search.Date" class="form-label fw-semibold">Ngày đặt</label>
                    <input type="date" class="form-control form-control-lg" asp-for="Search.Date" min="@DateTime.Today.ToString("yyyy-MM-dd")"
                           id="dateInput">
                    <span asp-validation-for="Search.Date" class="text-danger small"></span>
                </div>
                <div class="col-lg-3 col-md-6">
                    <label asp-for="Search.Time" class="form-label fw-semibold">Giờ đến</label>
                    <input type="text" class="form-control form-control-lg" asp-for="Search.Time" id="timeInput"
                           placeholder="HH:mm (ví dụ: 18:05)" />
                    <span asp-validation-for="Search.Time" class="text-danger small"></span>
                </div>
                <div class="col-lg-3 col-md-6">
                    <label asp-for="Search.People" class="form-label fw-semibold">Số người</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="fa-solid fa-user-group"></i></span>
                        <input type="number" class="form-control form-control-lg" asp-for="Search.People" min="1" max="50">
                    </div>
                    <span asp-validation-for="Search.People" class="text-danger small"></span>
                </div>

                <div class="col-lg-3 col-md-6">
                    <button type="submit" class="btn btn-primary w-100 py-3 fw-bold text-uppercase" style="border-radius: 50px;">
                        <i class="fa-solid fa-magnifying-glass me-2"></i> Kiểm tra bàn trống
                    </button>
                </div>
            </form>
        </div>
    </div>


    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 h-100" style="background-color: var(--cf-white);">
                <div class="card-body p-4">
                    <h4 class="card-title fw-bold mb-4" style="color: var(--cf-dark-brown);">
                        <i class="fa-solid fa-filter me-2"></i>Lọc theo khu vực
                    </h4>
                    <div class="list-group list-group-flush" id="areaFilterList">
                        <a class="list-group-item list-group-item-action active" href="#" data-khuvuc-id="all">
                            <i class="fa-solid fa-border-all me-2"></i> Tất cả khu vực
                        </a>
                        @foreach (var kv in Model.KhuVucList)
                        {
                            <a class="list-group-item list-group-item-action" href="#" data-khuvuc-id="@kv.IdKhuVuc">
                                <i class="fa-solid fa-location-dot me-2"></i> @kv.TenKhuVuc (@kv.BanList.Count)
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">

            @if (Model.IsSearched)
            {
                <h5 class="mb-3 text-muted">
                    Kết quả cho <strong>@Model.Search.People người</strong> vào lúc <strong>@Model.Search.Time</strong> ngày <strong>@Model.Search.Date.ToString("dd/MM/yyyy")</strong>:
                </h5>

                @if (!string.IsNullOrEmpty(Model.SearchSuccessMessage))
                {
                    <div class="alert alert-success">@Model.SearchSuccessMessage</div>
                }

            }
            else if (string.IsNullOrEmpty(Model.SuccessMessage) && string.IsNullOrEmpty(Model.ErrorMessage))
            {
                <h5 class="mb-3 text-muted">Vui lòng chọn thời gian để xem bàn trống</h5>
            }


            @foreach (var kv in Model.KhuVucList)
            {
                <div class="mb-4 area-group" data-area-id="@kv.IdKhuVuc">
                    <h4 class="fw-bold" style="color: var(--cf-dark-brown);">@kv.TenKhuVuc</h4>
                    <hr class="mt-2 mb-3">
                    <div class="row row-cols-2 row-cols-md-3 row-cols-xl-4 g-3">
                        @foreach (var ban in kv.BanList)
                        {
                            string tableStatusClass = "";
                            string buttonClass = "table-select-btn";

                            if (Model.IsSearched)
                            {
                                if (!Model.AvailableTableIds.Contains(ban.IdBan))
                                {
                                    tableStatusClass = "unavailable"; // Ẩn DIV cha
                                }
                            }

                            <div class="col table-item @tableStatusClass" data-table-ghe="@ban.SoGhe">
                                <button type="button"
                                        class="btn btn-outline-light w-100 h-100 p-3 text-start shadow-sm @buttonClass"
                                        data-bs-toggle="modal" data-bs-target="#confirmBookingModal"
                                        data-table-id="@ban.IdBan" data-table-name="@ban.SoBan"
                                        style="border-width: 2px;">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="badge bg-success">@ban.KhuVuc</span>
                                        <small class="text-muted"><i class="fa-solid fa-chair me-1"></i>@ban.SoGhe</small>
                                    </div>
                                    <h4 class="fw-bold mb-0">@ban.SoBan</h4>
                                </button>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<div class="modal fade" id="confirmBookingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white border-0">
                <h5 class="modal-title fw-bold">
                    <i class="fa-solid fa-clipboard-check me-2"></i>Xác nhận đặt bàn
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-info border-0 d-flex align-items-center" style="background-color: var(--cf-cream); color: var(--cf-dark-brown);">
                    <i class="fa-solid fa-circle-info me-3 fs-4"></i>
                    <div>
                        Bạn đang đặt <strong>Bàn <span id="modalTableName"></span></strong><br>
                        Vào lúc
                        <strong>@Model.Search.Time</strong> ngày <strong>@Model.Search.Date.ToString("dd/MM/yyyy")</strong>
                    </div>
                </div>

                <form method="post" asp-page-handler="Book" id="bookingForm">
                    <input type="hidden" asp-for="Search.Date" />
                    <input type="hidden" asp-for="Search.Time" />
                    <input type="hidden" asp-for="Search.People" />

                    <input type="hidden" asp-for="Booking.SelectedTableId" id="modalTableIdInput" />

                    @if (!User.Identity.IsAuthenticated)
                    {
                        <div class="mb-3">
                            <label asp-for="Booking.FullName" class="form-label fw-semibold">Họ và tên <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" asp-for="Booking.FullName" required placeholder="Nhập tên của bạn">
                            <span asp-validation-for="Booking.FullName" class="text-danger small"></span>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <label asp-for="Booking.Phone" class="form-label fw-semibold">Số điện thoại <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" asp-for="Booking.Phone" required placeholder="Nhập SĐT liên hệ">
                                <span asp-validation-for="Booking.Phone" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Booking.Email" class="form-label fw-semibold">Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" asp-for="Booking.Email" required placeholder="Nhận xác nhận qua email">
                                <span asp-validation-for="Booking.Email" class="text-danger small"></span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div id="loggedInUserInfo" class="mb-3">
                            <label class="form-label fw-semibold text-muted">Thông tin người đặt:</label>
                            <p class="form-control-plaintext fw-bold mb-0">@Model.Booking.FullName</p>
                            <p class="form-control-plaintext text-muted mt-0">
                                @Model.Booking.Phone
                                @if (!string.IsNullOrEmpty(Model.Booking.Email))
                                {
                                    <text>| @Model.Booking.Email</text>
                                }
                            </p>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="bookForOtherCheck">
                            <label class="form-check-label" for="bookForOtherCheck">
                                Đặt hộ cho người khác?
                            </label>
                        </div>

                        <div id="loggedInUserFields">
                            <input type="hidden" asp-for="Booking.FullName" />
                            <input type="hidden" asp-for="Booking.Phone" />
                            @if (!Model.IsLoggedInUserMissingEmail)
                            {
                                <input type="hidden" asp-for="Booking.Email" />
                            }
                        </div>

                        @if (Model.IsLoggedInUserMissingEmail)
                        {
                            <div class="mb-3" id="loggedInEmailInput">
                                <label asp-for="Booking.Email" class="form-label fw-semibold">Email của bạn <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" asp-for="Booking.Email" required placeholder="Chúng tôi cần email để xác nhận">
                                <span asp-validation-for="Booking.Email" class="text-danger small"></span>
                            </div>
                        }

                        <div id="bookForOtherFields" style="display: none;">
                            <div class="mb-3">
                                <label asp-for="Booking.FullName" class="form-label fw-semibold">Họ tên người được đặt hộ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" asp-for="Booking.FullName" placeholder="Nhập tên" disabled required>
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col-md-6">
                                    <label asp-for="Booking.Phone" class="form-label fw-semibold">SĐT người được đặt hộ <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" asp-for="Booking.Phone" placeholder="Nhập SĐT" disabled required>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="Booking.Email" class="form-label fw-semibold">Email người được đặt hộ <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" asp-for="Booking.Email" placeholder="Nhập Email" disabled required>
                                </div>
                            </div>
                        </div>
                    }

                    <div class="mb-3">
                        <label asp-for="Booking.Note" class="form-label fw-semibold">Ghi chú thêm</label>
                        <textarea class="form-control" asp-for="Booking.Note" rows="2" placeholder="VD: Cần ghế trẻ em, trang trí sinh nhật..."></textarea>
                    </div>

                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-primary py-3 fw-bold" style="border-radius: 50px;">
                            HOÀN TẤT ĐẶT BÀN
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // Logic truyền data vào Modal
            var confirmModal = document.getElementById('confirmBookingModal');
            if (confirmModal) {
                confirmModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    var tableId = button.getAttribute('data-table-id');
                    var tableName = button.getAttribute('data-table-name');
                    document.getElementById('modalTableIdInput').value = tableId;
                    document.getElementById('modalTableName').textContent = tableName;
                });
            }

            // Logic "Đặt Hộ"
            const bookForOtherCheck = document.getElementById('bookForOtherCheck');
            if (bookForOtherCheck) {
                const loggedInInfo = document.getElementById('loggedInUserInfo');
                const loggedInFields = document.getElementById('loggedInUserFields');
                const otherFields = document.getElementById('bookForOtherFields');
                const otherInputs = otherFields.querySelectorAll('input');
                const loggedInEmailInput = document.getElementById('loggedInEmailInput');
                const originalValues = {
                    name: loggedInFields.querySelector('input[name="Booking.FullName"]').value,
                    phone: loggedInFields.querySelector('input[name="Booking.Phone"]').value,
                    email: document.querySelector('input[name="Booking.Email"]').value
                };

                bookForOtherCheck.addEventListener('change', function () {
                    if (this.checked) {
                        loggedInInfo.style.display = 'none';
                        otherFields.style.display = 'block';
                        if (loggedInEmailInput) loggedInEmailInput.style.display = 'none'; // Ẩn ô email
                        otherInputs.forEach(i => { i.disabled = false; i.value = ''; });
                        loggedInFields.querySelectorAll('input').forEach(i => i.disabled = true);
                        if (loggedInEmailInput) loggedInEmailInput.querySelector('input').disabled = true;
                    } else {
                        loggedInInfo.style.display = 'block';
                        otherFields.style.display = 'none';
                        if (loggedInEmailInput) loggedInEmailInput.style.display = 'block'; // Hiện lại ô email
                        otherInputs.forEach(i => i.disabled = true);
                        loggedInFields.querySelectorAll('input').forEach(i => {
                            i.disabled = false;
                            if (i.name === "Booking.FullName") i.value = originalValues.name;
                            if (i.name === "Booking.Phone") i.value = originalValues.phone;
                        });
                        var emailInput = document.querySelector('input[name="Booking.Email"]');
                        if (emailInput) {
                            emailInput.disabled = false;
                            emailInput.value = originalValues.email;
                        }
                    }
                });
            }

            // Logic Lọc Khu Vực
            const areaLinks = document.querySelectorAll('#areaFilterList .list-group-item-action');
            const areaGroups = document.querySelectorAll('.area-group');
            areaLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    areaLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    const targetAreaId = this.getAttribute('data-khuvuc-id');
                    areaGroups.forEach(group => {
                        group.style.display = (targetAreaId === 'all' || group.getAttribute('data-area-id') === targetAreaId) ? 'block' : 'none';
                    });
                });
            });

            // ***** NÂNG CẤP MỚI: TỰ ĐỘNG ĐIỀN SĐT *****
            var phoneInput = document.querySelector('input[asp-for="Booking.Phone"]');
            var nameInput = document.querySelector('input[asp-for="Booking.FullName"]');
            var emailInput = document.querySelector('input[asp-for="Booking.Email"]');

            // Chỉ chạy khi 3 ô này tồn tại (tức là form khách vãng lai)
            if (phoneInput && nameInput && emailInput) {

                phoneInput.addEventListener('blur', function() { // 'blur' là khi người dùng bấm ra ngoài
                    var phone = this.value;
                    if (phone && phone.length >= 9) { // Chỉ tìm khi SĐT có vẻ hợp lệ

                        // Gọi API đã tạo ở DatBanWebController.cs
                        fetch(`/api/web/datban/get-customer-info?phone=${phone}`)
                            .then(response => {
                                if (response.ok) {
                                    return response.json();
                                }
                                throw new Error('Customer not found');
                            })
                            .then(data => {
                                // Tự động điền nếu SĐT tồn tại
                                if (nameInput.value === '') { // Chỉ điền nếu ô tên còn trống
                                    nameInput.value = data.hoTen;
                                }
                                if (emailInput.value === '') { // Chỉ điền nếu ô email còn trống
                                    emailInput.value = data.email;
                                }
                            })
                            .catch(error => {
                                // Không tìm thấy SĐT, không làm gì cả
                                console.log('Không tìm thấy thông tin SĐT.');
                            });
                    }
                });
            }
            // ***** HẾT PHẦN NÂNG CẤP *****

        });
    </script>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\DatBanView.cshtml.cs
================================================================================
﻿/*
* FILE ĐÃ SỬA LỖI LOGIC TRIỆT ĐỂ (V11-FINAL)
*
* GIẢI THÍCH LỖI GỐC:
* Thuộc tính [BindProperty] trên "BookingInfoModel Booking" đã khiến
* ASP.NET Core validate (kiểm tra) model này trên MỌI HÀNH ĐỘNG POST,
* kể cả khi nhấn nút "TimKiem" (vốn không cần Booking).
*
* CÁCH SỬA:
* 1. Đã XÓA [BindProperty] khỏi "public BookingInfoModel Booking".
* 2. Đã thêm [BindProperty] vào tham số của HÀM OnPostBookAsync().
* (public async Task<IActionResult> OnPostBookAsync([Bind(Prefix = "Booking")] BookingInfoModel bookingForm))
* 3. Đã đổi tên OnPostSearchAsync -> OnPostTimKiemAsync để khớp với file .cshtml.
*
* KẾT QUẢ:
* - Nút "TimKiem" sẽ KHÔNG BAO GIỜ validate "Booking" nữa -> Lỗi "Vui lòng nhập Email" sẽ biến mất.
* - Nút "Book" sẽ validate "Booking" như bình thường.
*/

using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.ComponentModel.DataAnnotations;
using System.Net.Http.Json;
using System.Security.Claims;

namespace WebCafebookApi.Pages
{
    public class DatBanViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;
        private readonly HttpClient _apiClient;

        public TimeSpan OpeningTime { get; set; } = new(6, 0, 0);
        public TimeSpan ClosingTime { get; set; } = new(23, 0, 0);


        public DatBanViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
            _apiClient = _httpClientFactory.CreateClient("WebClient");
            _apiClient.BaseAddress = new Uri("http://localhost:5166");
        }

        [BindProperty(SupportsGet = true)]
        public SearchModel Search { get; set; } = new();

        // SỬA LỖI: Đã XÓA [BindProperty] ở đây.
        // Chúng ta sẽ bind nó ở tham số hàm OnPostBookAsync.
        public BookingInfoModel Booking { get; set; } = new();

        public List<KhuVucBanDto> KhuVucList { get; set; } = new();
        public List<int> AvailableTableIds { get; set; } = new();
        public bool IsSearched { get; set; } = false;
        public string? ErrorMessage { get; set; }
        public string? SuccessMessage { get; set; }
        public string? SearchSuccessMessage { get; set; }

        public bool IsLoggedInUserMissingEmail { get; set; } = false;

        public class SearchModel
        {
            [Required(ErrorMessage = "Vui lòng chọn ngày")]
            [DataType(DataType.Date)]
            public DateTime Date { get; set; } = DateTime.Today;

            [Required(ErrorMessage = "Vui lòng chọn giờ")]
            public string Time { get; set; } = "09:00";

            [Required, Range(1, 50, ErrorMessage = "Số người từ 1-50")]
            public int People { get; set; } = 2;
        }

        public class BookingInfoModel
        {
            public int SelectedTableId { get; set; }
            public string? SelectedTableNumber { get; set; }

            [Required(ErrorMessage = "Vui lòng nhập họ tên")]
            public string FullName { get; set; } = string.Empty;

            [Required(ErrorMessage = "Vui lòng nhập SĐT")]
            [Phone(ErrorMessage = "SĐT không hợp lệ")]
            public string Phone { get; set; } = string.Empty;

            [Required(ErrorMessage = "Vui lòng nhập Email")]
            [EmailAddress(ErrorMessage = "Email không hợp lệ")]
            public string Email { get; set; } = string.Empty;

            public string? Note { get; set; }
        }

        public async Task OnGetAsync()
        {
            PopulateBookingInfoForUser();
            await LoadOpeningHoursAsync();
            await LoadAllTablesAsync();

            if (User.Identity?.IsAuthenticated == true && string.IsNullOrEmpty(Booking.Email))
            {
                IsLoggedInUserMissingEmail = true;
            }

            if (!Request.Query.ContainsKey("handler"))
            {
                if (Search.Date == DateTime.Today)
                {
                    Search.Time = GetDefaultStartTime(OpeningTime, ClosingTime);
                }
                else
                {
                    Search.Time = OpeningTime.ToString(@"hh\:mm");
                }
            }

            // SỬA LỖI: Đổi "Search" -> "TimKiem" để khớp với URL
            if (Request.Query.ContainsKey("handler") &&
                Request.Query["handler"] == "TimKiem")
            {
                await OnPostTimKiemAsync();
            }
        }

        // SỬA LỖI: Đổi tên hàm thành "OnPostTimKiemAsync" để khớp với .cshtml
        public async Task<IActionResult> OnPostTimKiemAsync()
        {
            // Populate lại thông tin user đăng nhập (nếu có)
            PopulateBookingInfoForUser();
            await LoadOpeningHoursAsync();
            await LoadAllTablesAsync();
            if (User.Identity?.IsAuthenticated == true && string.IsNullOrEmpty(Booking.Email))
            {
                IsLoggedInUserMissingEmail = true;
            }

            // 1. Kiểm tra validation CHỈ CỦA SearchModel
            // (Vì BookingModel không còn [BindProperty], nó sẽ không bị validate ở đây)
            if (!ModelState.IsValid)
            {
                IsSearched = false;
                ErrorMessage = ModelState.Values.SelectMany(v => v.Errors).FirstOrDefault()?.ErrorMessage ?? "Dữ liệu tìm kiếm không hợp lệ.";
                return Page();
            }

            // 2. Kiểm tra Time
            if (!TimeSpan.TryParse(Search.Time, out TimeSpan time))
            {
                ModelState.AddModelError("Search.Time", "Giờ không hợp lệ, vui lòng nhập dạng HH:mm");
                IsSearched = false;
                ErrorMessage = "Giờ không hợp lệ, vui lòng nhập dạng HH:mm";
                return Page();
            }

            // 3. Gọi API
            var req = new TimBanRequestDto
            {
                NgayDat = Search.Date,
                GioDat = time,
                SoNguoi = Search.People
            };

            var response = await _apiClient.PostAsJsonAsync("/api/web/datban/tim-ban", req);
            IsSearched = true;

            if (response.IsSuccessStatusCode)
            {
                var availableTables = await response.Content.ReadFromJsonAsync<List<BanTrongDto>>() ?? new List<BanTrongDto>();
                AvailableTableIds = availableTables.Select(b => b.IdBan).ToList();
                if (!AvailableTableIds.Any())
                {
                    ErrorMessage = "Rất tiếc, không còn bàn trống phù hợp với lựa chọn của bạn.";
                }
                else
                {
                    SearchSuccessMessage = $"Đã tìm thấy {AvailableTableIds.Count} bàn trống phù hợp.";
                }
            }
            else
            {
                ErrorMessage = await response.Content.ReadAsStringAsync();
            }

            return Page();
        }

        // SỬA LỖI: Thêm [BindProperty] vào tham số hàm
        public async Task<IActionResult> OnPostBookAsync([Bind(Prefix = "Booking")] BookingInfoModel bookingForm)
        {
            // Gán model được bind từ form vào property chính để hiển thị lại
            Booking = bookingForm;

            // Chạy lại logic load trang
            if (User.Identity?.IsAuthenticated == true && string.IsNullOrEmpty(Booking.FullName))
            {
                PopulateBookingInfoForUser();
            }
            if (User.Identity?.IsAuthenticated == true && string.IsNullOrEmpty(Booking.Email))
            {
                IsLoggedInUserMissingEmail = true;
            }
            await LoadOpeningHoursAsync();
            await LoadAllTablesAsync();

            // Luôn set IsSearched = true để hiển thị các bàn
            IsSearched = true;

            // Kiểm tra Time (phải kiểm tra thủ công vì nó thuộc model 'Search')
            if (!TimeSpan.TryParse(Search.Time, out TimeSpan time))
            {
                ModelState.AddModelError("Search.Time", "Giờ không hợp lệ.");
                ErrorMessage = "Giờ đặt bàn không hợp lệ.";
                // Tải lại các bàn trống (nếu có)
                await PopulateAvailableTablesAsync();
                return Page();
            }

            // Giờ kiểm tra ModelState (chỉ check 'Booking' vì nó là tham số, và 'Search' vì nó là [BindProperty])
            if (!ModelState.IsValid)
            {
                if (string.IsNullOrEmpty(ErrorMessage))
                {
                    ErrorMessage = ModelState.Values
                        .SelectMany(v => v.Errors)
                        .FirstOrDefault()?.ErrorMessage ?? "Thông tin không hợp lệ.";
                }
                // Tải lại các bàn trống (nếu có)
                await PopulateAvailableTablesAsync();
                return Page();
            }

            // Nếu mọi thứ hợp lệ, gọi API
            var req = new DatBanWebRequestDto
            {
                IdBan = Booking.SelectedTableId,
                NgayDat = Search.Date,
                GioDat = time,
                SoLuongKhach = Search.People,
                HoTen = Booking.FullName,
                SoDienThoai = Booking.Phone,
                Email = Booking.Email,
                GhiChu = Booking.Note
            };

            var response = await _apiClient.PostAsJsonAsync("/api/web/datban/tao-yeu-cau", req);

            if (response.IsSuccessStatusCode)
            {
                SuccessMessage = "Yêu cầu đặt bàn thành công! Vui lòng chờ xác nhận (qua Email hoặc SĐT).";
                IsSearched = false;
                AvailableTableIds.Clear();
                ModelState.Clear();

                // Đặt lại Search về giá trị mặc định
                Search = new SearchModel();
                await LoadOpeningHoursAsync(); // Tải lại giờ mở cửa để tính toán
                Search.Time = (Search.Date == DateTime.Today)
                    ? GetDefaultStartTime(OpeningTime, ClosingTime)
                    : OpeningTime.ToString(@"hh\:mm");

                // Đặt lại Booking
                Booking = new BookingInfoModel();
                PopulateBookingInfoForUser(); // Điền lại thông tin nếu đăng nhập

                if (User.Identity?.IsAuthenticated == true && string.IsNullOrEmpty(Booking.Email))
                {
                    IsLoggedInUserMissingEmail = true;
                }
            }
            else
            {
                ErrorMessage = await response.Content.ReadAsStringAsync();
                // Tải lại các bàn trống (nếu có)
                await PopulateAvailableTablesAsync();
            }

            return Page();
        }


        /// <summary>
        /// Đây là hàm helper mới, chỉ dùng cho OnPostBookAsync khi bị lỗi
        /// để tải lại danh sách bàn.
        /// </summary>
        private async Task PopulateAvailableTablesAsync()
        {
            if (TimeSpan.TryParse(Search.Time, out TimeSpan time))
            {
                var req = new TimBanRequestDto
                {
                    NgayDat = Search.Date,
                    GioDat = time,
                    SoNguoi = Search.People
                };
                var response = await _apiClient.PostAsJsonAsync("/api/web/datban/tim-ban", req);
                if (response.IsSuccessStatusCode)
                {
                    var tables = await response.Content.ReadFromJsonAsync<List<BanTrongDto>>() ?? new List<BanTrongDto>();
                    AvailableTableIds = tables.Select(b => b.IdBan).ToList();
                }
            }
            // Không set ErrorMessage ở đây, để giữ lỗi gốc (ví dụ: SĐT trùng)
        }


        // --- Helpers (Không đổi) ---
        private void PopulateBookingInfoForUser()
        {
            if (User.Identity?.IsAuthenticated == true)
            {
                // Chỉ điền nếu Booking rỗng (tránh ghi đè khi postback lỗi)
                if (string.IsNullOrEmpty(Booking.FullName) && string.IsNullOrEmpty(Booking.Phone))
                {
                    Booking.FullName = User.FindFirstValue(ClaimTypes.GivenName) ?? User.Identity.Name ?? "";
                    Booking.Phone = User.FindFirstValue(ClaimTypes.MobilePhone) ?? "";
                    Booking.Email = User.FindFirstValue(ClaimTypes.Email) ?? "";
                }
            }
        }

        private async Task LoadOpeningHoursAsync()
        {
            try
            {
                var hours = await _apiClient.GetFromJsonAsync<OpeningHoursDto>("/api/web/datban/get-opening-hours");
                if (hours != null)
                {
                    OpeningTime = hours.Open;
                    ClosingTime = hours.Close;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine("Loi khi tai gio mo cua: " + ex.Message);
            }
        }

        private async Task LoadAllTablesAsync()
        {
            if (!KhuVucList.Any())
            {
                try
                {
                    KhuVucList = await _apiClient.GetFromJsonAsync<List<KhuVucBanDto>>("/api/web/datban/get-all-tables-by-area") ?? new List<KhuVucBanDto>();
                }
                catch (Exception ex)
                {
                    ErrorMessage = "Lỗi khi tải danh sách bàn: " + ex.Message;
                }
            }
        }

        private string GetDefaultStartTime(TimeSpan open, TimeSpan close)
        {
            var now = DateTime.Now;
            var nowPlus10Min = now.AddMinutes(10);

            int minutes = nowPlus10Min.Minute;
            int minutesToAdd = (minutes % 30 == 0) ? 0 : (30 - (minutes % 30));
            var defaultTime = nowPlus10Min.AddMinutes(minutesToAdd);

            var defaultTimeSpan = defaultTime.TimeOfDay;

            if (defaultTimeSpan < open) return open.ToString(@"hh\:mm");
            if (defaultTimeSpan >= close) return open.ToString(@"hh\:mm");

            return defaultTime.ToString("HH:mm");
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\GioHangView.cshtml
================================================================================
﻿@page
@model WebCafebookApi.Pages.GioHangViewPageModel
@{
    ViewData["Title"] = "Giỏ Hàng";
}

<div class="container mt-5">
    <div class="main-content-card">
        <h1 class="display-5 fw-bold">Giỏ Hàng Của Bạn</h1>
        <hr />

        @if (Model.Cart.Items == null || !Model.Cart.Items.Any())
        {
            <div class="alert alert-info text-center" style="padding: 50px;">
                <span class="material-symbols-outlined" style="font-size: 48px;">shopping_cart</span>
                <h4 class="mt-3">Giỏ hàng của bạn đang trống</h4>
                <p>Hãy khám phá thêm sách và thực đơn của Cafebook nhé!</p>
                @* SỬA: Xóa link xem thư viện sách *@
                <a asp-page="/ThucDonView" class="btn btn-success">Xem Thực Đơn</a>
            </div>
        }
        else
        {
            <div class="row">
                <div class="col-lg-8">
                    @foreach (var item in Model.Cart.Items)
                    {
                        <div class="card mb-3 shadow-sm">
                            <div class="row g-0">
                                <div class="col-md-2 d-flex align-items-center justify-content-center p-2">
                                    <img src="@(item.HinhAnhUrl ?? "/images/default-food-icon.png")"
                                         class="img-fluid rounded" alt="@item.TenHienThi" style="max-height: 120px; object-fit: cover;">
                                </div>
                                <div class="col-md-10">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h5 class="card-title mb-1">@item.TenHienThi</h5>

                                                <span class="badge bg-success">Thức uống/Món</span>

                                                <p class="card-text text-muted mb-1">Đơn giá: @item.DonGia.ToString("N0") đ</p>
                                            </div>
                                            <div class="text-end">
                                                <h5 class="text-danger fw-bold">@item.ThanhTien.ToString("N0") đ</h5>
                                                <form method="post" class="mt-2">
                                                    <input type="hidden" name="id" value="@item.Id" />

                                                    <input type="number" name="soLuong" value="@item.SoLuong" min="1" class="form-control-sm" style="width: 60px;" />
                                                    <button type="submit" asp-page-handler="UpdateQuantity" class="btn btn-sm btn-outline-secondary" title="Cập nhật">
                                                        <span class="material-symbols-outlined" style="font-size: 18px;">sync</span>
                                                    </button>

                                                    <button type="submit" asp-page-handler="Remove" class="btn btn-sm btn-outline-danger" title="Xóa">
                                                        <span class="material-symbols-outlined" style="font-size: 18px;">delete</span>
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <div class="col-lg-4">
                    <div class="card sticky-top" style="top: 20px;">
                        <div class="card-body">
                            <h5 class="card-title">Tóm tắt đơn hàng</h5>
                            <hr />
                            <div class="d-flex justify-content-between fs-5 mb-3">
                                <span>Tổng cộng</span>
                                <strong class="text-danger">@Model.Cart.TongTien.ToString("N0") đ</strong>
                            </div>
                            <a asp-page="/Account/ThanhToanView" class="btn btn-primary w-100 btn-lg">
                                Tiến hành thanh toán
                                <span class="material-symbols-outlined" style="vertical-align: middle;">arrow_forward</span>
                            </a>
                            <a asp-page="/ThucDonView" class="btn btn-outline-secondary w-100 mt-2">
                                + Thêm món khác
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\GioHangView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/GioHangView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Collections.Generic;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using WebCafebookApi.Services;
using System.Linq;

namespace WebCafebookApi.Pages
{
    public class GioHangViewPageModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;
        public GioHangViewPageModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        public GioHangViewModel Cart { get; set; } = new();
        public string? ErrorMessage { get; set; }

        public async Task<IActionResult> OnGetAsync()
        {
            var sessionCart = HttpContext.Session.Get<List<CartItemDto>>(WebCafebookApi.Services.SessionExtensions.CartKey);
            if (sessionCart == null || !sessionCart.Any())
            {
                return Page();
            }

            var httpClient = _httpClientFactory.CreateClient("ApiClient");
            var populatedItems = new List<GioHangItemViewModel>();

            foreach (var item in sessionCart)
            {
                try
                {
                    // SỬA: Xóa bỏ logic kiểm tra "Sach"
                    // Giờ chỉ tải "SanPham"
                    var sp = await httpClient.GetFromJsonAsync<SanPhamChiTietDto>($"api/web/thucdon/{item.Id}");
                    if (sp != null)
                    {
                        populatedItems.Add(new GioHangItemViewModel
                        {
                            Id = item.Id,
                            // Xóa "Loai"
                            TenHienThi = sp.TenSanPham,
                            HinhAnhUrl = sp.HinhAnhUrl,
                            DonGia = sp.DonGia,
                            SoLuong = item.SoLuong
                        });
                    }
                }
                catch (System.Exception ex)
                {
                    ErrorMessage = "Lỗi khi tải thông tin giỏ hàng: " + ex.Message;
                }
            }
            Cart.Items = populatedItems;
            return Page();
        }

        // SỬA: Xóa tham số "loai"
        public IActionResult OnPostRemove(int id)
        {
            var sessionCart = HttpContext.Session.Get<List<CartItemDto>>(WebCafebookApi.Services.SessionExtensions.CartKey);
            if (sessionCart != null)
            {
                // SỬA: Tìm chỉ bằng Id
                var itemToRemove = sessionCart.FirstOrDefault(i => i.Id == id);
                if (itemToRemove != null)
                {
                    sessionCart.Remove(itemToRemove);
                    HttpContext.Session.Set(WebCafebookApi.Services.SessionExtensions.CartKey, sessionCart);
                }
            }
            return RedirectToPage();
        }

        // SỬA: Xóa tham số "loai"
        public IActionResult OnPostUpdateQuantity(int id, int soLuong)
        {
            // SỬA: Xóa kiểm tra "Sach"
            if (soLuong <= 0)
            {
                // Nếu cập nhật số lượng về 0, hãy xóa nó
                return OnPostRemove(id);
            }

            var sessionCart = HttpContext.Session.Get<List<CartItemDto>>(WebCafebookApi.Services.SessionExtensions.CartKey);
            if (sessionCart != null)
            {
                // SỬA: Tìm chỉ bằng Id
                var itemToUpdate = sessionCart.FirstOrDefault(i => i.Id == id);
                if (itemToUpdate != null)
                {
                    itemToUpdate.SoLuong = soLuong;
                    HttpContext.Session.Set(WebCafebookApi.Services.SessionExtensions.CartKey, sessionCart);
                }
            }
            return RedirectToPage();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\HoTroView.cshtml
================================================================================
﻿@page "/ho-tro"
@model WebCafebookApi.Pages.HoTroViewModel
@{
    ViewData["Title"] = "Trung tâm Hỗ trợ";
    Layout = "_Layout";
}

@section Styles {
    <style>
        /* === CAFEBOOK THEME VARIABLES === */
        :root {
            --cf-brown-dark: #4E342E;
            --cf-brown-light: #A1887F;
            --cf-terracotta-dark: #E65100; /* Primary accent */
            --cf-terracotta-light: #FF7043;
            --cf-beige: #F9F9F9; /* Chat history background */
            --cf-cream: #FFF8E1;
            --cf-white: #FFFFFF;
            --cf-text: #333;
            --cf-text-light: #757575;
            --cf-border: #EEEEEE;
        }

        .page-title-account {
            color: var(--cf-brown-dark);
            font-weight: 700;
        }

        .page-lead-account {
            color: var(--cf-text-light);
            font-size: 1.1rem;
        }

        /* === CHAT WINDOW === */
        .chat-window-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
            overflow: hidden;
        }

        .chat-window {
            display: flex;
            flex-direction: column;
            height: 70vh; /* Tăng chiều cao */
            max-height: 750px;
            background-color: var(--cf-white);
        }

        /* === CHAT HISTORY (Nâng cấp) === */
        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem; /* Tăng khoảng cách */
            background-color: var(--cf-beige);
        }

            /* Tùy chỉnh thanh cuộn */
            .chat-history::-webkit-scrollbar {
                width: 8px;
            }

            .chat-history::-webkit-scrollbar-track {
                background: var(--cf-beige);
            }

            .chat-history::-webkit-scrollbar-thumb {
                background-color: #D1C4E9; /* Màu tím nhạt từ theme Material */
                border-radius: 20px;
                border: 2px solid var(--cf-beige);
            }

                .chat-history::-webkit-scrollbar-thumb:hover {
                    background-color: #B39DDB;
                }

        /* === CHAT ROW (Cấu trúc mới với Avatar) === */
        .chat-message-row {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @@keyframes popIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .chat-message-row .message-content {
            display: flex;
            flex-direction: column;
            max-width: 75%;
        }

        /* === AVATAR === */
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--cf-white);
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .avatar-user {
            background-color: var(--cf-terracotta-dark);
        }

            .avatar-user .material-symbols-outlined {
                font-size: 24px;
            }

        .avatar-bot {
            background-color: var(--cf-brown-light);
        }

            .avatar-bot .material-symbols-outlined {
                font-size: 24px;
            }

        /* === CHAT BUBBLE (Nâng cấp) === */
        .chat-bubble {
            padding: 0.8rem 1.25rem;
            border-radius: 1.25rem;
            line-height: 1.6;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        /* Bot (AI/Nhân viên) */
        .bot-row .message-content {
            align-items: flex-start;
        }

        .chat-bubble-bot {
            background-color: var(--cf-white);
            color: var(--cf-text);
            border: 1px solid var(--cf-border);
            border-bottom-left-radius: 0.25rem;
        }

        /* User (Khách hàng) */
        .user-row {
            flex-direction: row-reverse; /* Đảo ngược hàng */
        }

            .user-row .message-content {
                align-items: flex-end;
            }

        .chat-bubble-user {
            background: linear-gradient(135deg, var(--cf-terracotta-light), var(--cf-terracotta-dark));
            color: white;
            border-bottom-right-radius: 0.25rem;
        }

        /* === THỜI GIAN === */
        .chat-bubble-time {
            font-size: 0.75rem;
            color: var(--cf-text-light);
            margin-top: 6px;
            padding: 0 0.5rem;
        }

        /* === INPUT FORM (Material Design) === */
        .chat-input-form {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--cf-border);
            background-color: var(--cf-white);
            gap: 1rem;
        }

        .chat-input-wrapper {
            position: relative;
            flex-grow: 1;
        }

        #chatMessageInput {
            border: none;
            border-bottom: 2px solid var(--cf-border);
            border-radius: 0;
            padding: 0.75rem 0.25rem;
            font-size: 1.1rem;
            width: 100%;
            transition: border-color 0.3s ease;
        }

            #chatMessageInput:focus {
                box-shadow: none;
                border-color: var(--cf-terracotta-dark);
            }

            #chatMessageInput::placeholder {
                color: #BDBDBD;
            }

        #sendButton {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--cf-terracotta-dark);
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

            #sendButton .material-symbols-outlined {
                color: var(--cf-white);
                font-size: 28px;
                transition: transform 0.3s ease;
            }

            #sendButton:hover {
                background-color: var(--cf-terracotta-light);
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
                transform: translateY(-2px);
            }

            #sendButton:disabled {
                background-color: #E0E0E0;
                box-shadow: none;
            }

                #sendButton:disabled .material-symbols-outlined {
                    color: #9E9E9E;
                }
    </style>
}

<div class="container my-5">

    <div class="main-content-card">
        <h3 class="page-title-account">@ViewData["Title"]</h3>
        <p class="page-lead-account">Chào @Model.HoTroData.TenKhachHang, bạn cần Cafebook hỗ trợ gì hôm nay?</p>

        <hr class="my-4" />

        <div class="row">
            <div class="col-lg-10 mx-auto">
                <div class="chat-window-card">
                    <div class="chat-window">

                        <div class="chat-history" id="chat-history">
                            @foreach (var msg in Model.HoTroData.LichSuChat)
                            {
                                <div class="chat-message-row @(msg.IsUser ? "user-row" : "bot-row")">
                                    <div class="chat-avatar @(msg.IsUser ? "avatar-user" : "avatar-bot")">
                                        <span class="material-symbols-outlined">
                                            @(msg.IsUser ? "person" : "support_agent")
                                        </span>
                                    </div>

                                    <div class="message-content">
                                        <div class="chat-bubble @(msg.IsUser ? "chat-bubble-user" : "chat-bubble-bot")">
                                            @Html.Raw(msg.NoiDung.Replace("\n", "<br />"))
                                        </div>
                                        <div class="chat-bubble-time @(msg.IsUser ? "text-end" : "text-start")">
                                            @msg.ThoiGian.ToString("HH:mm")
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <form method="post" id="chatForm" class="chat-input-form" asp-antiforgery="true">
                            <input type="hidden" id="IdKhachHang" value="@Model.HoTroData.IdKhachHang" />
                            <input type="hidden" id="GuestSessionId" value="@Model.HoTroData.GuestSessionId" />
                            <input type="hidden" id="JwtToken" value="@Model.JwtToken" />

                            <div class="chat-input-wrapper">
                                <input asp-for="Input.NoiDung" id="chatMessageInput" class="form-control" placeholder="Nhập câu hỏi của bạn..." autocomplete="off" />
                            </div>
                            <button type="submit" id="sendButton" class="btn">
                                <span class="material-symbols-outlined">send</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
@section Scripts {

    <partial name="_ValidationScriptsPartial" />
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script>
                const apiBaseUrl = '@Model.ApiBaseUrl';
        $(document).ready(function () {
                    const $chatHistory = $('#chat-history');
                    const $chatForm = $('#chatForm');
                    const $chatInput = $('#chatMessageInput');
                    const $sendButton = $('#sendButton');

                    // === DỮ LIỆU CHAT TỪ MODEL ===
                    const idKhachHang = parseInt($('#IdKhachHang').val()) || 0;

                  const guestSessionId = $('#GuestSessionId').val() || null;
                    const jwtToken = $('#JwtToken').val() || null;
                    const antiForgeryToken = $('input[name="__RequestVerificationToken"]').val();

                    const groupName = idKhachHang > 0 ? `khach_${idKhachHang}` : `guest_${guestSessionId}`;

                    // === NÂNG CẤP: KHAI BÁO BIẾN LƯU TRỮ ===
                    const storageKey = `chat_history_${groupName}`;
                    let currentIdThongBao = null; // ID phiếu hỗ trợ

        let isRealtimeMode = false; // Cờ đánh dấu chế độ chat
                    let hubConnection = null; // Đối tượng SignalR

                    // === NÂNG CẤP: CÁC HÀM LƯU TRỮ SESSION ===
                    function getHistoryFromSession() {
                        try {
                            return JSON.parse(sessionStorage.getItem(storageKey) || '[]');
                        } catch (e) {
                            return [];
                        }
                    }

                    function saveHistoryToSession(history) {
                        sessionStorage.setItem(storageKey, JSON.stringify(history));
                    }

                    function saveMessageToHistory(message) {
                        const history = getHistoryFromSession();
                        // Tránh lưu trùng lặp tin nhắn chào
                        if (message.idChat === 0 && history.length > 0) {
                            return;
                        }
                        history.push(message);
                        saveHistoryToSession(history);
                    }

                    // === HÀM VẼ UI (Đã đổi tên) ===
                    function drawMessage(message, isUser, isStaff = false) {
                        // (isStaff = true nếu là nhân viên)
                        const rowClass = isUser ?
        'user-row' : (isStaff ? 'staff-row' : 'bot-row');
                        const avatarClass = isUser ? 'avatar-user' : (isStaff ? 'avatar-staff' : 'avatar-bot');
        const avatarIcon = isUser ? 'person' : (isStaff ? 'support' : 'support_agent');
                        const bubbleClass = isUser ?
        'chat-bubble-user' : (isStaff ? 'chat-bubble-staff' : 'chat-bubble-bot');
                        const timeAlign = isUser ? 'text-end' : 'text-start';
        const formattedContent = (message.noiDung || '').replace(/\n/g, '<br />');
                        const time = new Date(message.thoiGian).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        const $row = $('<div></div>').addClass('chat-message-row ' + rowClass);
                        const $avatar = $('<div></div>').addClass('chat-avatar ' + avatarClass)
                            .html(`<span class="material-symbols-outlined">${avatarIcon}</span>`);
        const $content = $('<div></div>').addClass('message-content');
                        const $bubble = $('<div></div>').addClass('chat-bubble ' + bubbleClass).html(formattedContent);
                        const $time = $('<div></div>').addClass('chat-bubble-time ' + timeAlign).text(time);

                        $content.append($bubble).append($time);
                        $row.append($avatar).append($content);
        $chatHistory.append($row);
                    }

                    // === NÂNG CẤP: HÀM TẢI LỊCH SỬ CHAT KHI VÀO TRANG ===
                    function loadChatHistory() {
                        const history = getHistoryFromSession();

                        // Lấy tin nhắn chào mặc định từ server (nếu có)
                        const serverWelcomeMessage = @Html.Raw(Json.Serialize(Model.HoTroData.LichSuChat.FirstOrDefault()));

                        if (history.length === 0 && serverWelcomeMessage) {
                            // Nếu session rỗng, lưu tin nhắn chào của server vào
                            saveMessageToHistory(serverWelcomeMessage);
                            // (Không cần vẽ vì server đã vẽ rồi)
                        }
                        else if (history.length > 0) {
                            // Nếu session có, xóa tin nhắn server vẽ và vẽ lại toàn bộ
                            $chatHistory.html(''); // Xóa tin nhắn "Chào bạn" do server render
                            history.forEach(msg => {
                                const isUser = msg.loaiTinNhan === 'KhachHang';
                                const isStaff = msg.loaiTinNhan === 'NhanVien';
                                drawMessage(msg, isUser, isStaff);
                            });
                        }
                    }

                    function scrollToBottom() { $chatHistory.scrollTop($chatHistory[0].scrollHeight);
        }

                    // === CHẠY HÀM TẢI LỊCH SỬ ===
                    loadChatHistory();
                    scrollToBottom();


                    // === LOGIC CHAT HYBRID (Đã cập nhật) ===

                    $chatForm.on('submit', async function (e) {
                        e.preventDefault();
                        const messageText = $chatInput.val();
                        if (!messageText.trim()) return;


           $chatInput.val('').prop('disabled', true);
                        $sendButton.prop('disabled', true);

                        if (isRealtimeMode && hubConnection) {
                            // --- CHẾ ĐỘ 2: GỬI QUA SIGNALR (Chat với NV) ---
                            try {

                         await hubConnection.invoke("SendMessageFromClient",
                                    groupName,
                                    messageText,

          idKhachHang,
                                    guestSessionId,
                                    currentIdThongBao
                                );

          } catch (err) {
                                console.error(err.toString());
                                alert('Mất kết nối. Không thể gửi tin nhắn.');
        } finally {
                                $chatInput.prop('disabled', false).focus();
        $sendButton.prop('disabled', false);
                            }
                        } else {
                            // --- CHẾ ĐỘ 1: GỬI QUA FETCH (Chat với AI) ---
                            const payload = { noiDung: messageText, guestSessionId: guestSessionId };
        const headers = {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': antiForgeryToken
                            };
        if (jwtToken) { headers['Authorization'] = 'Bearer ' + jwtToken; }

                            try {
                                const response = await fetch(`${apiBaseUrl}/api/web/hotro/send`, {
                                    method: 'POST',

                        headers: headers,
                                    body: JSON.stringify(payload)
                                });
        if (response.status === 401) { /* ... (Xử lý 401) ... */ }
                                if (!response.ok) { throw new Error('Lỗi máy chủ');
        }

                                const result = await response.json();
        // SendChatResponseDto

                                // NÂNG CẤP: Vẽ và Lưu tin nhắn của khách
                                drawMessage(result.tinNhanCuaKhach, true, false);
                                saveMessageToHistory(result.tinNhanCuaKhach);

                                // NÂNG CẤP: Vẽ và Lưu tin nhắn của AI
                                if (result.tinNhanPhanHoi) {
                                    setTimeout(() => {
                                        drawMessage(result.tinNhanPhanHoi, false, false);
                                        saveMessageToHistory(result.tinNhanPhanHoi);

                                    scrollToBottom();
                                    }, 300);
        }

                                // === KÍCH HOẠT SIGNALR ===
                                if (result.idThongBaoHoTro && result.idThongBaoHoTro > 0) {
                                    currentIdThongBao = result.idThongBaoHoTro;
        isRealtimeMode = true; // Chuyển chế độ
                                    await startSignalRConnection();
        // Bắt đầu kết nối
                                }

                            } catch (error) {
                                console.error('Lỗi khi gửi tin nhắn (Fetch):', error);
        alert('Không thể gửi tin nhắn. Vui lòng thử lại.');
                            } finally {
                                $chatInput.prop('disabled', false).focus();
        $sendButton.prop('disabled', false);
                                scrollToBottom();
                            }
                        }
                    });
        // === HÀM KẾT NỐI VÀ LẮNG NGHE SIGNALR (Đã cập nhật) ===
                    async function startSignalRConnection() {
                        if (hubConnection) return;
        // Đã kết nối

                        hubConnection = new signalR.HubConnectionBuilder()
                            .withUrl(apiBaseUrl + "/chatHub")
                            .build();
        // Lắng nghe tin nhắn TỪ SERVER (của Nhân viên HOẶC của chính mình)
                        hubConnection.on("ReceiveMessage", function (message) {

                            const isUser = message.loaiTinNhan === 'KhachHang';
                            const isStaff = message.loaiTinNhan === 'NhanVien';

                            // NÂNG CẤP: Vẽ và Lưu
                            drawMessage(message, isUser, isStaff);
                            saveMessageToHistory(message);
                            scrollToBottom();
              });

                        // Bắt đầu kết nối
                        try {
                            await hubConnection.start();
        console.log("SignalR Connected (Client).");
                            await hubConnection.invoke("JoinGroup", groupName);
                            console.log(`Joined group (Client): ${groupName}`);
        } catch (err) {
                            console.error(err.toString());
        }
                    }
                });
    </script>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\HoTroView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/HoTroView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http;
using System.Net.Http.Json;
using System.Security.Claims;
using System.Threading.Tasks;
using System;
using Microsoft.AspNetCore.Http;
using System.Collections.Generic;
using Microsoft.Extensions.Configuration;
using System.Net.Http.Headers;

namespace WebCafebookApi.Pages
{
    [AllowAnonymous]
    public class HoTroViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;
        private readonly IConfiguration _configuration;

        public HoTroViewModel(IHttpClientFactory httpClientFactory, IConfiguration configuration)
        {
            _httpClientFactory = httpClientFactory;
            _configuration = configuration;
        }

        public HoTroViewDto HoTroData { get; set; } = new HoTroViewDto();
        public string ApiBaseUrl { get; set; } = "";
        public string? JwtToken { get; set; } // Dùng để truyền Token xuống JS

        [BindProperty]
        public SendChatRequestDto Input { get; set; } = new SendChatRequestDto();

        public async Task<IActionResult> OnGetAsync()
        {
            ApiBaseUrl = _configuration["ApiBaseUrl"] ?? "http://localhost:5166";
            string? guestSessionId = null;

            if (User.Identity != null && User.Identity.IsAuthenticated)
            {
                // 1. ĐÃ ĐĂNG NHẬP
                var idKhachHang = User.FindFirstValue(ClaimTypes.NameIdentifier);
                var tenKhachHang = User.FindFirstValue(ClaimTypes.GivenName);

                if (string.IsNullOrEmpty(idKhachHang))
                {
                    return RedirectToPage("/Account/Login");
                }

                HoTroData.IdKhachHang = int.Parse(idKhachHang);
                HoTroData.TenKhachHang = tenKhachHang ?? "Khách hàng";

                // Đọc Token từ Session (VẪN CẦN để gửi tin nhắn)
                var token = HttpContext.Session.GetString("JwtToken");
                JwtToken = token; // Lưu token để truyền cho JavaScript

                if (string.IsNullOrEmpty(token))
                {
                    return RedirectToPage("/Account/Login", new { ReturnUrl = "/ho-tro" });
                }

                // ======================================
                // === SỬA THEO YÊU CẦU MỚI ===
                // === (Xóa bỏ việc tải lịch sử chat) ===
                // ======================================
                // try
                // {
                //     var httpClient = _httpClientFactory.CreateClient();
                //     httpClient.BaseAddress = new Uri(ApiBaseUrl);
                //     httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);
                //     var lichSu = await httpClient.GetFromJsonAsync<List<ChatMessageDto>>("api/web/hotro/history");
                //     ...
                // }
                // catch ...
            }
            else
            {
                // 2. KHÁCH VÃNG LAI
                guestSessionId = HttpContext.Session.GetString("GuestChatSession");
                if (string.IsNullOrEmpty(guestSessionId))
                {
                    guestSessionId = Guid.NewGuid().ToString();
                    HttpContext.Session.SetString("GuestChatSession", guestSessionId);
                }

                HoTroData.IdKhachHang = 0;
                HoTroData.GuestSessionId = guestSessionId;
                HoTroData.TenKhachHang = "Khách vãng lai";
            }

            // 3. AI CHÀO TRƯỚC
            // (Vì cả 2 trường hợp đều không tải lịch sử (Count == 0),
            // code này sẽ luôn chạy)
            if (HoTroData.LichSuChat.Count == 0)
            {
                HoTroData.LichSuChat.Add(new ChatMessageDto
                {
                    IdChat = 0,
                    LoaiTinNhan = "AI",
                    NoiDung = "Chào bạn! Tôi là trợ lý ảo của Cafebook. Tôi có thể giúp gì cho bạn?",
                    ThoiGian = DateTime.Now
                });
            }

            return Page();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\LienHeView.cshtml
================================================================================
﻿@page
@model WebCafebookApi.Pages.LienHeViewModel
@{
    ViewData["Title"] = "Liên Hệ";
}

@* Thêm Font Awesome (nếu _Layout chưa có) *@
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
}

<style>
    .contact-icon {
        font-size: 1.5rem;
        color: var(--bs-primary, #0d6efd);
        width: 40px; /* Căn chỉnh icon */
    }

    .contact-info li {
        font-size: 1.1rem;
        margin-bottom: 1rem;
    }

    .social-icon {
        font-size: 1.75rem;
        color: #333;
        transition: color .2s;
    }

        .social-icon:hover {
            color: var(--bs-primary, #0d6efd);
        }
</style>

<div class="container mt-5">
    <div class="text-center mb-5">
        <h1>Liên Hệ Với Chúng Tôi</h1>
        <p class="lead">Cafebook luôn sẵn sàng lắng nghe bạn. Đừng ngần ngại gửi phản hồi hoặc ghé thăm chúng tôi!</p>
    </div>

    <div class="row g-5">
        <div class="col-lg-5">
            <h3 class="mb-4">Thông Tin Chung</h3>

            <p>
                @(Model.Info.GioiThieu ?? "⚙️ Thông tin giới thiệu đang được cập nhật...")
            </p>

            <ul class="list-unstyled contact-info mt-4">
                <li class="d-flex align-items-start">
                    <i class="fas fa-map-marker-alt contact-icon text-center me-3"></i>
                    <span>@(Model.Info.DiaChi ?? "⚙️ Địa chỉ đang cập nhật...")</span>
                </li>
                <li class="d-flex align-items-start">
                    <i class="fas fa-phone contact-icon text-center me-3"></i>
                    <span>@(Model.Info.SoDienThoai ?? "⚙️ SĐT đang cập nhật...")</span>
                </li>
                <li class="d-flex align-items-start">
                    <i class="fas fa-envelope contact-icon text-center me-3"></i>
                    <span>@(Model.Info.EmailLienHe ?? "⚙️ Email đang cập nhật...")</span>
                </li>
                <li class="d-flex align-items-start">
                    <i class="fas fa-clock contact-icon text-center me-3"></i>
                    <span>@(Model.Info.GioMoCua ?? "⚙️ Giờ mở cửa đang cập nhật...")</span>
                </li>
            </ul>

            <h5 class="mt-4">Theo dõi chúng tôi</h5>
            <div class="mt-3">
                @if (!string.IsNullOrWhiteSpace(Model.Info.LinkFacebook))
                {
                    <a href="@Model.Info.LinkFacebook" class="social-icon me-3" target="_blank" rel="noopener noreferrer" title="Facebook"><i class="fab fa-facebook-square"></i></a>
                }
                @if (!string.IsNullOrWhiteSpace(Model.Info.LinkInstagram))
                {
                    <a href="@Model.Info.LinkInstagram" class="social-icon me-3" target="_blank" rel="noopener noreferrer" title="Instagram"><i class="fab fa-instagram-square"></i></a>
                }
                @if (!string.IsNullOrWhiteSpace(Model.Info.LinkZalo))
                {
                    <a href="@Model.Info.LinkZalo" class="social-icon me-3" target="_blank" rel="noopener noreferrer" title="Zalo">
                        <i class="fa-solid fa-comment"></i>
                        <small style="font-size: 0.5em; vertical-align: top;">Zalo</small>
                    </a>
                }
                @if (!string.IsNullOrWhiteSpace(Model.Info.LinkYoutube))
                {
                    <a href="@Model.Info.LinkYoutube" class="social-icon" target="_blank" rel="noopener noreferrer" title="Youtube"><i class="fab fa-youtube-square"></i></a>
                }
            </div>
        </div>

        <div class="col-lg-7">
            <h3 class="mb-4">Tìm Chúng Tôi</h3>
            <div class="card shadow-sm mb-4" style="height: 300px;">
                @if (string.IsNullOrWhiteSpace(Model.Info.LinkGoogleMapsEmbed))
                {
                    <div class="card-body d-flex align-items-center justify-content-center text-muted">
                        ⚙️ Bản đồ đang được cập nhật...
                    </div>
                }
                else
                {
                    <iframe src="@Model.Info.LinkGoogleMapsEmbed"
                            height="300" style="border:0; width:100%;"
                            allowfullscreen="" loading="lazy"
                            referrerpolicy="no-referrer-when-downgrade"></iframe>
                }
            </div>

            <h3 class="mb-4">Gửi Góp Ý</h3>
            @if (!string.IsNullOrEmpty(Model.SuccessMessage))
            {
                <div class="alert alert-success">@Model.SuccessMessage</div>
            }
            @if (!string.IsNullOrEmpty(Model.ErrorMessage))
            {
                <div class="alert alert-danger">@Model.ErrorMessage</div>
            }

            <form method="post">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="ModelOnly" class="text-danger mb-3" role="alert"></div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="PhanHoiInput.Ten" class="form-label">Tên của bạn <span class="text-danger">*</span></label>
                        <input type="text" asp-for="PhanHoiInput.Ten" class="form-control" />
                        <span asp-validation-for="PhanHoiInput.Ten" class="text-danger small"></span>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="PhanHoiInput.Email" class="form-label">Email <span class="text-danger">*</span></label>
                        <input type="email" asp-for="PhanHoiInput.Email" class="form-control" />
                        <span asp-validation-for="PhanHoiInput.Email" class="text-danger small"></span>
                    </div>
                    <div class="col-12">
                        <label asp-for="PhanHoiInput.NoiDung" class="form-label">Nội dung <span class="text-danger">*</span></label>
                        <textarea asp-for="PhanHoiInput.NoiDung" class="form-control" rows="5"></textarea>
                        <span asp-validation-for="PhanHoiInput.NoiDung" class="text-danger small"></span>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary mt-3">Gửi Phản Hồi</button>
                <p class="text-muted small mt-2">⚙️ Tính năng này đang được cập nhật. Phản hồi của bạn sẽ được ghi lại trong log hệ thống.</p>
            </form>

        </div>
    </div>
</div>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\LienHeView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/LienHeView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.ComponentModel.DataAnnotations;
using System.Net.Http.Json;
using System.Threading.Tasks;

// SỬA: Đảm bảo namespace chính xác
namespace WebCafebookApi.Pages
{
    public class LienHeViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        public LienHeViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        // SỬA: Dùng DTO mới
        public LienHeDto Info { get; set; } = new LienHeDto();

        [BindProperty]
        public PhanHoiInputModel PhanHoiInput { get; set; } = new PhanHoiInputModel();

        [TempData]
        public string? SuccessMessage { get; set; }
        [TempData]
        public string? ErrorMessage { get; set; }

        public async Task OnGetAsync()
        {
            var httpClient = _httpClientFactory.CreateClient();
            try
            {
                // SỬA: Gọi API mới
                var response = await httpClient.GetFromJsonAsync<LienHeDto>("http://localhost:5166/api/web/lienhe/info");
                if (response != null)
                {
                    Info = response;
                }
            }
            catch (Exception)
            {
                Info = new LienHeDto(); // Khởi tạo rỗng nếu lỗi
            }
        }

        public async Task<IActionResult> OnPostAsync()
        {
            if (!ModelState.IsValid)
            {
                await OnGetAsync();
                return Page();
            }

            try
            {
                // Logic giả lập gửi phản hồi (vì chưa có API)
                System.Diagnostics.Debug.WriteLine($"--- PHAN HOI MOI ---");
                System.Diagnostics.Debug.WriteLine($"Ten: {PhanHoiInput.Ten}");
                System.Diagnostics.Debug.WriteLine($"Email: {PhanHoiInput.Email}");
                System.Diagnostics.Debug.WriteLine($"Noi Dung: {PhanHoiInput.NoiDung}");
                System.Diagnostics.Debug.WriteLine($"---------------------");

                SuccessMessage = "Cảm ơn bạn! Chúng tôi đã nhận được góp ý.";

                ModelState.Clear();
                PhanHoiInput = new PhanHoiInputModel();
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Lỗi: {ex.Message}";
            }

            await OnGetAsync();
            return Page();
        }

        public class PhanHoiInputModel
        {
            [Required(ErrorMessage = "Vui lòng nhập tên của bạn.")]
            public string Ten { get; set; } = string.Empty;

            [Required(ErrorMessage = "Vui lòng nhập email.")]
            [EmailAddress(ErrorMessage = "Email không hợp lệ.")]
            public string Email { get; set; } = string.Empty;

            [Required(ErrorMessage = "Vui lòng nhập nội dung.")]
            [MinLength(10, ErrorMessage = "Nội dung phải có ít nhất 10 ký tự.")]
            public string NoiDung { get; set; } = string.Empty;
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\ThucDonView.cshtml
================================================================================
﻿@page
@model WebCafebookApi.Pages.ThucDonViewModel
@{
    ViewData["Title"] = "Thực Đơn";
    // ... (routeData giữ nguyên) ...
    var routeData = new Dictionary<string, string?>
    {
        { "LoaiId", Model.LoaiId?.ToString() },
        { "Search", Model.Search },
        { "SortBy", Model.SortBy },
        { "GiaMin", Model.GiaMin?.ToString() },
        { "GiaMax", Model.GiaMax?.ToString() }
    };
}

<div class="container mt-4">
    <div class="text-center mb-4">
        <h1>@ViewData["Title"]</h1>
        <p class="lead text-muted">Khám phá các món ăn và đồ uống đặc sắc tại Cafebook.</p>
    </div>

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger">@Model.ErrorMessage</div>
    }

    <div class="row">
        <div class="col-lg-3 mb-4">
            <form method="get" asp-page="/ThucDonView">
                <div class="card sticky-top filter-card" style="top: 20px;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.5rem;">filter_list</span>
                            Tìm & Lọc
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3 material-input-group">
                            <label asp-for="Search" class="form-label fw-bold">Tìm theo tên</label>
                            <input asp-for="Search" class="material-input" placeholder="Cà phê sữa...">
                        </div>

                        <div class="mb-3 material-input-group">
                            <label asp-for="LoaiId" class="form-label fw-bold">Danh mục</label>
                            <select asp-for="LoaiId" asp-items="@Model.LoaiSanPhamsList" class="material-select"></select>
                        </div>

                        <div class="mb-3 material-input-group">
                            <label class="form-label fw-bold">Khoảng giá</label>
                            <div class="input-group">
                                <input asp-for="GiaMin" class="material-input" placeholder="Từ" type="number" step="1000">
                                <input asp-for="GiaMax" class="material-input" placeholder="Đến" type="number" step="1000">
                            </div>
                        </div>

                        <div class="mb-3 material-input-group">
                            <label asp-for="SortBy" class="form-label fw-bold">Sắp xếp</label>
                            <select asp-for="SortBy" class="material-select">
                                <option value="ten_asc">Tên (A-Z)</option>
                                <option value="ten_desc">Tên (Z-A)</option>
                                <option value="gia_asc">Giá (Thấp đến Cao)</option>
                                <option value="gia_desc">Giá (Cao đến Thấp)</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">Áp dụng</button>
                        <a asp-page="/ThucDonView" class="btn btn-link text-muted w-100 mt-2">Xóa bộ lọc</a>
                    </div>
                </div>
            </form>
        </div>

        <div class="col-lg-9">
            <div class="row row-cols-1 row-cols-md-3 g-4">
                @if (Model.MenuResult != null && Model.MenuResult.Items.Any())
                {
                    @foreach (var item in Model.MenuResult.Items)
                    {
                        <div class="col">
                            <a asp-page="/ChiTietSanPhamView" asp-route-id="@item.IdSanPham" class="text-decoration-none">
                                <div class="card h-100 shadow-sm product-card">
                                    @{
                                        var imgSrc = string.IsNullOrEmpty(item.AnhSanPhamUrl)
                                        ? "/images/default-food-icon.png"
                                        : item.AnhSanPhamUrl;
                                    }
                                    <div class="card-img-container">
                                        <img src="@imgSrc" class="card-img-top product-card-img" alt="@item.TenSanPham">
                                    </div>
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title text-decoration-none">@item.TenSanPham</h5>
                                        <p class="card-text text-muted small">@item.TenLoaiSP</p>
                                        <h5 class="card-subtitle mt-auto mb-2 text-danger fw-bold">@item.DonGia.ToString("N0") đ</h5>
                                    </div>
                                </div>
                            </a>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12">
                        <p class="text-center text-muted fs-5 mt-5">Không tìm thấy sản phẩm nào phù hợp.</p>
                    </div>
                }
            </div>

        </div>
    </div>
</div>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\ThucDonView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/ThucDonView.cshtml.cs
using CafebookModel.Model.ModelApp; // For FilterLookupDto
using CafebookModel.Model.ModelWeb; // For ThucDonDto
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.AspNetCore.Mvc.Rendering; // For SelectListItem
using System.Collections.Generic;
using System.Linq;
using System.Net.Http.Json;
using System.Threading.Tasks;

namespace WebCafebookApi.Pages
{
    public class ThucDonViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        // Thuộc tính để hứng dữ liệu từ API
        public ThucDonDto? MenuResult { get; set; }
        public List<SelectListItem> LoaiSanPhamsList { get; set; } = new();
        public string? ErrorMessage { get; set; }

        // --- Thuộc tính [BindProperty] cho Form (Filters) ---
        [BindProperty(SupportsGet = true)]
        public string? Search { get; set; }

        [BindProperty(SupportsGet = true)]
        public int? LoaiId { get; set; }

        [BindProperty(SupportsGet = true)]
        public decimal? GiaMin { get; set; }

        [BindProperty(SupportsGet = true)]
        public decimal? GiaMax { get; set; }

        [BindProperty(SupportsGet = true)]
        public string SortBy { get; set; } = "ten_asc";

        [BindProperty(SupportsGet = true)]
        public int PageNum { get; set; } = 1;
        // ----------------------------------------------------

        public ThucDonViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        public async Task OnGetAsync()
        {
            var httpClient = _httpClientFactory.CreateClient();

            try
            {
                // 1. Tải bộ lọc (Danh mục)
                var filters = await httpClient.GetFromJsonAsync<List<FilterLookupDto>>("http://localhost:5166/api/web/thucdon/filters");
                LoaiSanPhamsList.Add(new SelectListItem("Tất cả danh mục", "0"));
                if (filters != null)
                {
                    LoaiSanPhamsList.AddRange(filters.Select(f => new SelectListItem(f.Ten, f.Id.ToString())));
                }

                // 2. Tải danh sách sản phẩm (có phân trang & lọc)
                var queryString = $"?loaiId={LoaiId ?? 0}&search={Search}&sortBy={SortBy}&giaMin={GiaMin}&giaMax={GiaMax}&pageNum={PageNum}";
                MenuResult = await httpClient.GetFromJsonAsync<ThucDonDto>($"http://localhost:5166/api/web/thucdon/search{queryString}");
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Không thể tải thực đơn. Đảm bảo API (http://localhost:5166) đang chạy. Lỗi: {ex.Message}";
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\ThuVienSachView.cshtml
================================================================================
﻿@page
@model WebCafebookApi.Pages.ThuVienSachViewModel
@{
    ViewData["Title"] = "Thư Viện Sách";
    // ... (routeData giữ nguyên) ...
    var routeData = new Dictionary<string, string?>
    {
        { "TheLoai", Model.TheLoai?.ToString() },
        { "Search", Model.Search },
        { "SortBy", Model.SortBy },
        { "TrangThai", Model.TrangThai }
    };
}

<div class="container mt-5">
    <div class="main-content-card">

        <div class="text-center mb-4">
            <h1 class="page-title">@ViewData["Title"]</h1>
            <p class="page-lead">Khám phá kho tàng tri thức trong khi thưởng thức ly cà phê của bạn.</p>
        </div>

        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="alert alert-danger">@Model.ErrorMessage</div>
        }

        <div class="card filter-card mb-4">
            <div class="card-body">
                <form method="get" asp-page="/ThuVienSachView">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4 material-input-group">
                            <label asp-for="Search" class="form-label">Tìm theo tên, tác giả</label>
                            <input asp-for="Search" class="material-input" placeholder="Dế Mèn Phiêu Lưu Ký...">
                        </div>
                        <div class="col-md-2 material-input-group">
                            <label asp-for="TheLoai" class="form-label">Thể loại</label>
                            <select asp-for="TheLoai" asp-items="@Model.TheLoaiList" class="material-select"></select>
                        </div>
                        <div class="col-md-2 material-input-group">
                            <label asp-for="TrangThai" class="form-label">Tình trạng</label>
                            <select asp-for="TrangThai" asp-items="@Model.TrangThaiList" class="material-select"></select>
                        </div>
                        <div class="col-md-2 material-input-group">
                            <label asp-for="SortBy" class="form-label">Sắp xếp</label>
                            <select asp-for="SortBy" asp-items="@Model.SortList" class="material-select"></select>
                        </div>
                        <div class="col-md-2 d-grid">
                            <button type="submit" class="btn btn-primary">Tìm kiếm</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 g-4">
            @if (Model.SachResult != null && Model.SachResult.Items.Any())
            {
                @foreach (var sach in Model.SachResult.Items)
                {
                    <div class="col">
                        <div class="card h-100 shadow-sm product-card">
                            @{
                                // SỬA: Dùng AnhBiaUrl
                                var imgSrc = string.IsNullOrEmpty(sach.AnhBiaUrl) ? "/images/default-book-cover.png" : sach.AnhBiaUrl;
                            }
                            <a asp-page="/ChiTietSachView" asp-route-id="@sach.IdSach">
                                <div class="card-img-container">
                                    <img src="@imgSrc" class="card-img-top book-card-img" alt="@sach.TieuDe">
                                </div>
                            </a>
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title book-card-title">
                                    <a asp-page="/ChiTietSachView" asp-route-id="@sach.IdSach" class="text-decoration-none text-dark stretched-link">
                                        @sach.TieuDe
                                    </a>
                                </h5>
                                <p class="card-text text-muted small book-card-author">@sach.TacGia</p>
                                <div class="mt-auto d-flex justify-content-between align-items-center">
                                    <span class="text-danger fw-bold">@sach.GiaBia.ToString("N0") đ <small>(Cọc)</small></span>
                                    @if (sach.SoLuongCoSan > 0)
                                    {
                                        <span class="badge bg-success">Còn sách</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Đã thuê hết</span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12">
                    <p class="text-center text-muted fs-5 mt-5">Không tìm thấy cuốn sách nào phù hợp.</p>
                </div>
            }
        </div>

        @if (Model.SachResult != null && Model.SachResult.TotalPages > 1)
        {
            <nav aria-label="Trang thư viện" class="mt-5">
                <ul class="pagination justify-content-center">
                     </ul>
            </nav>
        }

    </div> </div> 
    @section Styles {
    <style>
        .book-card-img {
            height: 300px;
            object-fit: cover;
        }
        .book-card-title {
            font-size: 1rem;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            height: 2.5em; /* 1.25em * 2 */
        }
        .book-card-author {
            font-size: 0.9rem;
            height: 1.5em; /* Giới hạn 1 dòng */
            overflow: hidden;
        }
    </style>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\ThuVienSachView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/ThuVienSachView.cshtml.cs
using CafebookModel.Model.ModelApp; // For FilterLookupDto
using CafebookModel.Model.ModelWeb; // For SachPhanTrangDto
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.AspNetCore.Mvc.Rendering;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http.Json;
using System.Threading.Tasks;

namespace WebCafebookApi.Pages
{
    public class ThuVienSachViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        // Dữ liệu trả về
        public SachPhanTrangDto? SachResult { get; set; }
        public string? ErrorMessage { get; set; }

        // Dữ liệu cho bộ lọc
        public List<SelectListItem> TheLoaiList { get; set; } = new();
        public List<SelectListItem> TrangThaiList { get; set; } = new();
        public List<SelectListItem> SortList { get; set; } = new();

        // --- Thuộc tính [BindProperty] cho Form (Filters) ---
        [BindProperty(SupportsGet = true)]
        public string? Search { get; set; }

        [BindProperty(SupportsGet = true)]
        public int? TheLoai { get; set; } // Dùng int? cho "Tất cả"

        [BindProperty(SupportsGet = true)]
        public string? TrangThai { get; set; }

        [BindProperty(SupportsGet = true)]
        public string SortBy { get; set; } = "ten_asc";

        [BindProperty(SupportsGet = true)]
        public int PageNum { get; set; } = 1;

        public ThuVienSachViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        public async Task OnGetAsync()
        {
            var httpClient = _httpClientFactory.CreateClient();

            try
            {
                // 1. Tải bộ lọc (Thể loại)
                // SỬA LỖI CS0104: Chỉ định rõ namespace ModelWeb
                var filters = await httpClient.GetFromJsonAsync<CafebookModel.Model.ModelWeb.SachFiltersDto>("http://localhost:5166/api/web/thuvien/filters");
                TheLoaiList.Add(new SelectListItem("Tất cả thể loại", "0"));
                if (filters != null)
                {
                    TheLoaiList.AddRange(filters.TheLoais.Select(f => new SelectListItem(f.Ten, f.Id.ToString())));
                }

                // 2. Tải bộ lọc tĩnh (Trạng thái, Sắp xếp)
                TrangThaiList.Add(new SelectListItem("Tất cả", "all"));
                TrangThaiList.Add(new SelectListItem("Còn sách", "con_sach"));
                TrangThaiList.Add(new SelectListItem("Hết sách", "het_sach"));

                SortList.Add(new SelectListItem("Tên (A-Z)", "ten_asc"));
                SortList.Add(new SelectListItem("Tên (Z-A)", "ten_desc"));
                SortList.Add(new SelectListItem("Tiền cọc (Thấp-Cao)", "gia_asc"));
                SortList.Add(new SelectListItem("Tiền cọc (Cao-Thấp)", "gia_desc"));

                // 3. Tải danh sách Sách (có phân trang & lọc)
                var queryString = $"?search={Search}&theLoaiId={TheLoai ?? 0}&trangThai={TrangThai}&sortBy={SortBy}&pageNum={PageNum}";
                SachResult = await httpClient.GetFromJsonAsync<SachPhanTrangDto>($"http://localhost:5166/api/web/thuvien/search{queryString}");
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Không thể tải thư viện sách. Đảm bảo API (http://localhost:5166) đang chạy. Lỗi: {ex.Message}";
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\TimKiemSachView.cshtml
================================================================================
﻿@page "/ThuVien/TimKiemSachView"
@model WebCafebookApi.Pages.TimKiemSachViewModel

@{
    ViewData["Title"] = Model.PageTitle;
}

@section Styles {
    <style>
        /* TRẠNG THÁI THU GỌN — CHỈ 1 DÒNG + DẤU “…” */
        #page-description-wrapper.description-truncated p {
            white-space: nowrap !important;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* TRẠNG THÁI MỞ RỘNG — HIỂN THỊ ĐẦY ĐỦ */
        #page-description-wrapper.description-expanded p {
            white-space: pre-wrap !important;
            overflow: visible;
        }

        /* Ảnh sách */
        .card-img-container img {
            height: 260px;
            width: 100%;
            object-fit: cover;
        }
    </style>
}

<div class="container mt-5">
    <div class="main-content-card">

        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="page-breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a asp-page="/TrangChuView">
                        <span class="material-symbols-outlined">home</span> Trang Chủ
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a asp-page="/ThuVienSachView">
                        <span class="material-symbols-outlined">import_contacts</span> Thư Viện Sách
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Tìm kiếm
                </li>
            </ol>
        </nav>

        <!-- Tiêu đề -->
        <h1 class="display-6 fw-bold">@Model.PageTitle</h1>

        <!-- Mô tả trang -->
        @if (!string.IsNullOrEmpty(Model.PageDescription))
        {
            <div id="page-description-wrapper" class="description-truncated">
                <p class="fs-6 text-muted" style="white-space: pre-wrap;">
                    @Model.PageDescription
                </p>
            </div>

            <a href="javascript:void(0);" id="toggle-page-description"
               class="btn btn-link ps-0" style="display:none;">
                Đọc thêm...
            </a>
        }

        <hr />

        <!-- Lỗi -->
        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="alert alert-danger">@Model.ErrorMessage</div>
        }

        <!-- Danh sách sách -->
        @if (Model.SachList != null && Model.SachList.Any())
        {
            <div class="row row-cols-1 row-cols-md-4 g-4">

                @foreach (var item in Model.SachList)
                {
                    var imgUrl = string.IsNullOrEmpty(item.AnhBiaUrl)
                        ? "/images/default-book-cover.png"
                        : item.AnhBiaUrl;

                    <div class="col">
                        <a asp-page="/ChiTietSachView"
                           asp-route-id="@item.IdSach"
                           class="text-decoration-none">

                            <div class="card h-100 product-card">

                                <div class="card-img-container">
                                    <img src="@imgUrl"
                                         class="card-img-top"
                                         alt="@item.TieuDe" />
                                </div>

                                <div class="card-body d-flex flex-column">
                                    <h6 class="card-title book-card-title">@item.TieuDe</h6>
                                    <p class="card-text text-danger fw-bold mt-auto mb-0">
                                        @item.GiaBia.ToString("N0") đ
                                    </p>
                                </div>

                            </div>

                        </a>
                    </div>
                }

            </div>
        }
        else
        {
            <div class="alert alert-info">
                Không tìm thấy cuốn sách nào khớp với tiêu chí của bạn.
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {

            const $wrapper = $('#page-description-wrapper');
            if ($wrapper.length === 0) return;

            const $content = $wrapper.find('p');
            const $btn = $('#toggle-page-description');

            // Kiểm tra xem nội dung có vượt quá 1 dòng hay không
            if ($content[0].scrollWidth > $wrapper.width()) {
                $btn.show();
            } else {
                $wrapper.removeClass('description-truncated');
            }

            // Toggle mở rộng - thu gọn
            $btn.on("click", function () {
                const expanded = $wrapper.hasClass('description-expanded');

                $wrapper.toggleClass('description-expanded description-truncated');
                $btn.text(expanded ? 'Đọc thêm...' : 'Thu gọn');
            });
        });
    </script>
}

================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\TimKiemSachView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/TimKiemSachView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Collections.Generic;
using System.Net.Http;
using System.Net.Http.Json;
using System.Text;
using System.Threading.Tasks;

namespace WebCafebookApi.Pages
{
    public class TimKiemSachViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        [BindProperty(SupportsGet = true)]
        public int? IdTacGia { get; set; }

        [BindProperty(SupportsGet = true)]
        public int? IdTheLoai { get; set; }

        [BindProperty(SupportsGet = true)]
        public int? IdNXB { get; set; }

        public string PageTitle { get; set; } = "Thư Viện Sách";
        public string? PageDescription { get; set; }
        public List<SachCardDto> SachList { get; set; } = new List<SachCardDto>();
        public string? ErrorMessage { get; set; }

        public TimKiemSachViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        public async Task<IActionResult> OnGetAsync()
        {
            var httpClient = _httpClientFactory.CreateClient();
            var sb = new StringBuilder("http://localhost:5166/api/web/thuvien/filter-by-id?");

            if (IdTacGia.HasValue) sb.Append($"idTacGia={IdTacGia.Value}");
            else if (IdTheLoai.HasValue) sb.Append($"idTheLoai={IdTheLoai.Value}");
            else if (IdNXB.HasValue) sb.Append($"idNXB={IdNXB.Value}");
            else
            {
                return RedirectToPage("/ThuVienSachView");
            }

            try
            {
                var result = await httpClient.GetFromJsonAsync<SachKetQuaTimKiemDto>(sb.ToString());
                if (result != null)
                {
                    PageTitle = result.TieuDeTrang;
                    PageDescription = result.MoTaTrang; // Dòng này sẽ hết lỗi sau khi bạn sửa file DTO
                    SachList = result.SachList;
                }
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Lỗi khi tải dữ liệu: {ex.Message}";
            }
            return Page();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\TrangChuView.cshtml
================================================================================
﻿@page "/"
@model WebCafebookApi.Pages.TrangChuViewModel
@{
    ViewData["Title"] = "Trang Chủ";
    var bannerStyle = string.IsNullOrEmpty(Model.Info?.BannerImageUrl)
        ? "background-color: #4E342E; color: #FFF8E1;"
        : $"background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('{Model.Info.BannerImageUrl}'); background-size: cover; background-position: center; color: white;";
}

<div class="container-fluid px-0 mb-5">
    <div class="text-center p-5" style="@bannerStyle min-height: 40vh; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <h1 class="display-3 fw-bold" style="color: inherit;">
            @(Model.Info?.TenQuan ?? "Chào mừng đến Cafebook")
        </h1>
        <p class="lead fs-4 col-md-8" style="color: inherit; opacity: 0.9;">
            @(Model.Info?.GioiThieu ?? "Nơi bạn có thể thưởng thức cà phê thơm ngon, đọc những cuốn sách hay và tìm thấy không gian yên tĩnh cho riêng mình.")
        </p>
        <div class="mt-4">
            <a asp-page="/ThucDonView" class="btn btn-primary btn-lg me-2">Xem Thực Đơn</a>
            <a asp-page="/ThuVienSachView" class="btn btn-outline-light btn-lg">Khám Phá Sách</a>
        </div>
    </div>
</div>


<div class="container">

    @if (Model.Promotions != null && Model.Promotions.Any())
    {
        <div class="row mt-5 promotion-section">
            <h2 class="text-center mb-4 pb-2 section-header-alt">
                <span class="material-symbols-outlined">stars</span> Khuyến Mãi Đặc Biệt <span class="material-symbols-outlined">stars</span>
            </h2>
            @foreach (var promo in Model.Promotions)
            {
                <div class="col-md-12 promotion-item">
                    <h5 class="promo-title">@promo.TenKhuyenMai</h5>
                    <p class="promo-description">@promo.MoTa</p>
                    <p class="promo-condition">Áp dụng: @promo.dieuKienApDung</p>
                </div>
            }
        </div>
    }

    <div class="row mt-5">
        <h2 class="text-center mb-4 pb-2 section-header">
            <span class="material-symbols-outlined">coffee</span> Món Nổi Bật
        </h2>
        @if (Model.MonNoiBat != null && Model.MonNoiBat.Any())
        {
            @foreach (var item in Model.MonNoiBat)
            {
                <div class="col-lg col-md-4 col-sm-6 mb-4">
                    <a asp-page="/ChiTietSanPhamView" asp-route-id="@item.IdSanPham" class="text-decoration-none">
                        <div class="card h-100">
                            @{
                                var imgSrc = string.IsNullOrEmpty(item.AnhSanPhamUrl)
                                ? "/images/default-food-icon.png"
                                : item.AnhSanPhamUrl;
                            }
                            <div class="card-img-container">
                                <img src="@imgSrc" class="card-img-top" alt="@item.TenSanPham" style="height: 180px; object-fit: cover;">
                            </div>
                            <div class="card-body d-flex flex-column">
                                <h6 class="card-title text-decoration-none">@item.TenSanPham</h6>
                                <p class="card-text text-danger fw-bold mt-auto mb-0">@item.DonGia.ToString("N0") đ</p>
                            </div>
                        </div>
                    </a>
                </div>
            }
        }
        else
        {
            <p class="text-center text-muted">
                <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.1rem;">spark</span>
                Dữ liệu món nổi bật đang được cập nhật...
            </p>
        }
    </div>

    <div class="row mt-5">
        <h2 class="text-center mb-4 pb-2 section-header">
            <span class="material-symbols-outlined">auto_stories</span> Sách Hay Nên Đọc
        </h2>
        @if (Model.SachNoiBat != null && Model.SachNoiBat.Any())
        {
            @foreach (var sach in Model.SachNoiBat)
            {
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card h-100">
                        @{
                            var imgSrc = string.IsNullOrEmpty(sach.AnhBiaUrl)
                            ? "/images/default-book-cover.png"
                            : sach.AnhBiaUrl;
                        }
                        <div class="card-img-container">
                            <img src="@imgSrc" class="card-img-top" alt="@sach.TieuDe" style="height: 250px; object-fit: cover;">
                        </div>
                        <div class="card-body">
                            <h6 class="card-title" style="height: 2.5em; overflow: hidden;">@sach.TieuDe</h6>
                            <p class="card-text text-muted small">@sach.TacGia</p>
                        </div>
                        <div class="card-footer bg-transparent border-0 pb-3">
                            <a asp-page="/ChiTietSachView" asp-route-id="@sach.IdSach" class="btn btn-outline-primary btn-sm w-100">
                                Xem chi tiết
                            </a>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <p class="text-center text-muted">
                <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.1rem;">spark</span>
                Dữ liệu sách nổi bật đang được cập nhật...
            </p>
        }
    </div>

    <div class="row mt-5">
        <div class="col-12">
            <div class="find-space-section card-body">
                <div class="row">
                    <div class="col-md-7">
                        <h2 class="fw-bold">Tìm không gian cho riêng bạn?</h2>
                        <p class="lead text-muted">
                            Hiện chúng tôi đang có <strong>@Model.Info?.SoBanTrong bàn trống</strong> sẵn sàng phục vụ.
                            Và <strong>@Model.Info?.SoSachSanSang đầu sách</strong> đang sẵn sàng để bạn đọc và mượn.
                        </p>
                        <a asp-page="/DatBanView" class="btn btn-success btn-lg">
                            <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 8px;">book_online</span>
                            Đặt Bàn Ngay
                        </a>
                        <p class="text-muted small mt-3">
                            <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.1rem;">spark</span>
                            Chức năng xem sơ đồ bàn trực quan đang được cập nhật.
                        </p>
                    </div>
                    <div class="col-md-5 border-start-md contact-info">
                        <h5 class="fw-bold">Liên hệ nhanh</h5>
                        <ul class="list-unstyled">
                            <li><span class="material-symbols-outlined">call</span> @Model.Info?.SoDienThoai</li>
                            <li><span class="material-symbols-outlined">mail</span> @Model.Info?.EmailLienHe</li>
                            <li><span class="material-symbols-outlined">schedule</span> @Model.Info?.GioMoCua</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-5">
        <h2 class="text-center mb-4 pb-2 section-header-alt">
            Khách Hàng Nói Gì Về Chúng Tôi
        </h2>
        <div class="col-12 text-center">
            <p class="text-muted">
                <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.1rem;">spark</span>
                Chức năng hiển thị đánh giá của khách hàng đang được phát triển.
            </p>
        </div>
    </div>

</div>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\TrangChuView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/TrangChuView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Json;

namespace WebCafebookApi.Pages
{
    public class TrangChuViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;
        public TrangChuViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        public ThongTinChungDto? Info { get; set; }
        public List<KhuyenMaiDto> Promotions { get; set; } = new();
        public List<SanPhamDto> MonNoiBat { get; set; } = new();
        public List<SachDto> SachNoiBat { get; set; } = new();

        public async Task OnGetAsync()
        {
            var httpClient = _httpClientFactory.CreateClient();
            try
            {
                var response = await httpClient.GetFromJsonAsync<TrangChuDto>("http://localhost:5166/api/web/trangchu/data");

                if (response != null)
                {
                    Info = response.Info;
                    Promotions = response.Promotions;
                    MonNoiBat = response.MonNoiBat;
                    SachNoiBat = response.SachNoiBat;
                }
            }
            catch (Exception)
            {
                Info = new ThongTinChungDto();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\_ViewImports.cshtml
================================================================================
﻿@using WebCafebookApi
@namespace WebCafebookApi.Pages
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@using Microsoft.AspNetCore.Mvc.TagHelpers
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\_ViewStart.cshtml
================================================================================
﻿@{
    Layout = "_Layout";
}

================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\DangKyView.cshtml
================================================================================
﻿@page "/Account/Register"
@model WebCafebookApi.Pages.Account.DangKyViewModel
@{
    ViewData["Title"] = "Đăng ký";
    Layout = null;
    // Dùng layout riêng của trang Login
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Cafebook</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body class="login-page-body">

    <div class="login-wrapper">
        <div class="login-container">

            <div class="login-brand-col d-none d-md-flex">
                <img src="/images/logo.png" alt="Cafebook Logo">

                <h1 class="mb-2">Cafebook</h1>
                <p class="fs-5 opacity-75">Tham gia cộng đồng</p>
            </div>

            <div class="login-form-col">

                <h2>@ViewData["Title"]</h2>
                <p class="text-muted">
                    Tạo tài khoản mới để
                    đặt bàn và thuê sách.
                </p>

                <form id="registerForm" asp-route-returnUrl="@Model.ReturnUrl" method="post">

                    <div asp-validation-summary="ModelOnly" class="text-danger mb-2" role="alert"></div>

                    <div class="form-floating-material">
                        <input asp-for="Input.SoDienThoai" class="form-control" autocomplete="tel" aria-required="true" placeholder=" " />
                        <label asp-for="Input.SoDienThoai"></label>
                        <span class="material-symbols-outlined">phone</span>

                        <span asp-validation-for="Input.SoDienThoai" class="text-danger small"></span>
                    </div>

                    <div class="form-floating-material">
                        <input asp-for="Input.Email" class="form-control" autocomplete="email" aria-required="true" placeholder=" " />

                        <label asp-for="Input.Email"></label>
                        <span class="material-symbols-outlined">mail</span>
                        <span asp-validation-for="Input.Email" class="text-danger small"></span>
                    </div>

                    <div class="form-floating-material">
                        <input asp-for="Input.Password" class="form-control" type="password" autocomplete="new-password" aria-required="true" placeholder=" " />

                        <label asp-for="Input.Password"></label>
                        <span class="material-symbols-outlined">lock</span>
                        <span asp-validation-for="Input.Password" class="text-danger small"></span>
                    </div>


                    <div class="form-floating-material">
                        <input asp-for="Input.ConfirmPassword" class="form-control" type="password" autocomplete="new-password" aria-required="true" placeholder=" " />
                        <label asp-for="Input.ConfirmPassword"></label>
                        <span class="material-symbols-outlined">password</span>

                        <span asp-validation-for="Input.ConfirmPassword" class="text-danger small"></span>
                    </div>

                    <div>
                        <button id="registerSubmit" type="submit" class="w-100 btn btn-lg btn-primary">Đăng ký</button>

                    </div>

                    <div class="mt-4 text-center">
                        <p class="text-muted mb-0">
                            Đã có tài khoản?
                            <a asp-page="/account/DangNhapView">Quay lại Đăng nhập</a>
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <partial name="_ValidationScriptsPartial" />
    <script src="~/lib/jquery/dist/jquery.min.js"></script>

    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\DangKyView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/Account/DangKyView.cshtml.cs
using System.ComponentModel.DataAnnotations;
using System.Security.Claims;
using CafebookModel.Model.ModelApi;
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Json;

namespace WebCafebookApi.Pages.Account
{
    public class DangKyViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;
        public DangKyViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        [BindProperty]
        public InputModel Input { get; set; } = new();

        public string? ReturnUrl { get; set; }

        public class InputModel
        {
            // ĐÃ XÓA: HoTen

            [Required(ErrorMessage = "Vui lòng nhập SĐT")]
            [Phone(ErrorMessage = "Số điện thoại không hợp lệ")]
            [Display(Name = "Số điện thoại")]
            public string SoDienThoai { get; set; } = string.Empty;

            [Required(ErrorMessage = "Vui lòng nhập Email")]
            [EmailAddress(ErrorMessage = "Email không hợp lệ")]
            [Display(Name = "Email")]
            public string Email { get; set; } = string.Empty;

            // ĐÃ XÓA: TenDangNhap

            [Required(ErrorMessage = "Vui lòng nhập mật khẩu")]
            [StringLength(100, ErrorMessage = "{0} phải dài từ {2} đến {1} ký tự.", MinimumLength = 6)]
            [DataType(DataType.Password)]
            [Display(Name = "Mật khẩu")]
            public string Password { get; set; } = string.Empty;

            [DataType(DataType.Password)]
            [Display(Name = "Xác nhận mật khẩu")]
            [Compare("Password", ErrorMessage = "Mật khẩu và mật khẩu xác nhận không khớp.")]
            public string ConfirmPassword { get; set; } = string.Empty;
        }

        public void OnGet(string? returnUrl = null)
        {
            ReturnUrl = returnUrl;
        }

        public async Task<IActionResult> OnPostAsync(string? returnUrl = null)
        {
            returnUrl ??= Url.Content("~/");
            if (!ModelState.IsValid)
            {
                return Page();
            }

            var httpClient = _httpClientFactory.CreateClient();
            var apiRequest = new DangKyRequestModel
            {
                // ĐÃ XÓA: HoTen
                Email = Input.Email,
                SoDienThoai = Input.SoDienThoai,
                // ĐÃ XÓA: TenDangNhap
                Password = Input.Password
            };
            var response = await httpClient.PostAsJsonAsync("http://localhost:5166/api/web/taikhoankhach/register", apiRequest);

            if (response.IsSuccessStatusCode)
            {
                var apiResponse = await response.Content.ReadFromJsonAsync<WebLoginResponseModel>();
                if (apiResponse != null && apiResponse.Success && apiResponse.KhachHangData != null)
                {
                    // TỰ ĐỘNG ĐĂNG NHẬP SAU KHI ĐĂNG KÝ
                    var user = apiResponse.KhachHangData;
                    var claims = new List<Claim>
                    {
                        new Claim(ClaimTypes.NameIdentifier, user.IdKhachHang.ToString()),
                        new Claim(ClaimTypes.Name, user.TenDangNhap ?? user.Email ?? ""),
                        new Claim(ClaimTypes.GivenName, user.HoTen),
                        new Claim(ClaimTypes.Email, user.Email ?? ""),
                        new Claim(ClaimTypes.MobilePhone, user.SoDienThoai ?? ""),
                        new Claim(ClaimTypes.Role, "KhachHang")
                    };

                    var claimsIdentity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);

                    await HttpContext.SignInAsync(
                        CookieAuthenticationDefaults.AuthenticationScheme,
                        new ClaimsPrincipal(claimsIdentity));

                    HttpContext.Session.SetString("AvatarUrl", user.AnhDaiDienUrl ?? "");

                    return LocalRedirect(returnUrl);
                }
                else
                {
                    ModelState.AddModelError(string.Empty, apiResponse?.Message ?? "Lỗi đăng ký.");
                    return Page();
                }
            }

            ModelState.AddModelError(string.Empty, "Không thể kết nối máy chủ đăng ký.");
            return Page();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\DangNhapView.cshtml
================================================================================
﻿@page "/Account/Login"
@model WebCafebookApi.Pages.Account.DangNhapViewModel
@{
    ViewData["Title"] = "Đăng nhập";
    Layout = null;
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Cafebook</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body class="login-page-body">

    <div class="login-wrapper">
        <div class="login-container">

            <div class="login-brand-col d-none d-md-flex">
                <img src="/images/logo.png" alt="Cafebook Logo">
                <h1 class="mb-2">Cafebook</h1>
                <p class="fs-5 opacity-75">Awaken your senses</p>
            </div>

            <div class="login-form-col">
                <a asp-page="/TrangChuView" class="text-decoration-none mb-3" style="align-self: flex-start;">
                    <span class="material-symbols-outlined" style="vertical-align: middle;">arrow_back</span>
                    Về Trang Chủ
                </a>

                <h2>@ViewData["Title"]</h2>
                <p class="text-muted">Chào mừng trở lại! Vui lòng nhập thông tin của bạn.</p>

                <form id="account" method="post">

                    <div asp-validation-summary="ModelOnly" class="text-danger mb-2" role="alert"></div>

                    <div class="form-floating-material">
                        <input asp-for="Input.LoginIdentifier" class="form-control" autocomplete="username" aria-required="true" placeholder=" " />
                        <label asp-for="Input.LoginIdentifier" class="form-label">Email, Username hoặc SĐT</label>
                        <span class="material-symbols-outlined">person</span>
                        <span asp-validation-for="Input.LoginIdentifier" class="text-danger small"></span>
                    </div>

                    <div class="form-floating-material">
                        <input asp-for="Input.Password" type="password" class="form-control" autocomplete="current-password" aria-required="true" placeholder=" " />
                        <label asp-for="Input.Password" class="form-label">Mật khẩu</label>
                        <span class="material-symbols-outlined">lock</span>
                        <span asp-validation-for="Input.Password" class="text-danger small"></span>
                    </div>

                    <div class="text-end mb-3">
                        <a asp-page="/account/QuenMatKhauView" class="small">Quên mật khẩu?</a>
                    </div>

                    <div>
                        <button id="login-submit" type="submit" class="w-100 btn btn-lg btn-primary">Đăng nhập</button>
                    </div>

                    <div class="mt-4 text-center">
                        <p class="text-muted mb-0">
                            Chưa có tài khoản?
                            <a asp-page="/account/DangKyView" asp-route-returnUrl="@Model.ReturnUrl">Đăng ký ngay</a>
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <partial name="_ValidationScriptsPartial" />
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\DangNhapView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/Account/DangNhapView.cshtml.cs
using System.ComponentModel.DataAnnotations;
using System.Security.Claims;
using CafebookModel.Model.ModelApi;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Json;

namespace WebCafebookApi.Pages.Account
{
    public class DangNhapViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;
        public DangNhapViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        [BindProperty]
        public InputModel Input { get; set; } = new();

        public string? ReturnUrl { get; set; }

        [TempData]
        public string? ErrorMessage { get; set; }

        public class InputModel
        {
            [Required(ErrorMessage = "Vui lòng nhập Tên đăng nhập, Email hoặc SĐT")]
            [Display(Name = "Tên đăng nhập, Email hoặc SĐT")]
            public string LoginIdentifier { get; set; } = string.Empty;

            [Required(ErrorMessage = "Vui lòng nhập Mật khẩu")]
            [DataType(DataType.Password)]
            [Display(Name = "Mật khẩu")]
            public string Password { get; set; } = string.Empty;

            // ĐÃ XÓA: Thuộc tính RememberMe
        }

        public async Task OnGetAsync(string? returnUrl = null)
        {
            if (!string.IsNullOrEmpty(ErrorMessage))
            {
                ModelState.AddModelError(string.Empty, ErrorMessage);
            }
            returnUrl ??= Url.Content("~/");
            await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
            ReturnUrl = returnUrl;
        }

        public async Task<IActionResult> OnPostAsync(string? returnUrl = null)
        {
            returnUrl ??= Url.Content("~/");
            if (!ModelState.IsValid)
            {
                return Page();
            }

            var httpClient = _httpClientFactory.CreateClient();
            var apiRequest = new LoginRequestModel
            {
                TenDangNhap = Input.LoginIdentifier,
                MatKhau = Input.Password
            };
            var response = await httpClient.PostAsJsonAsync("http://localhost:5166/api/web/taikhoankhach/login", apiRequest);

            if (response.IsSuccessStatusCode)
            {
                var apiResponse = await response.Content.ReadFromJsonAsync<WebLoginResponseModel>();
                if (apiResponse != null && apiResponse.Success && apiResponse.KhachHangData != null && apiResponse.Token != null)
                {
                    var user = apiResponse.KhachHangData;
                    var claims = new List<Claim>
                    {
                        new Claim(ClaimTypes.NameIdentifier, user.IdKhachHang.ToString()),
                        new Claim(ClaimTypes.Name, user.TenDangNhap ?? user.Email ?? ""),
                        new Claim(ClaimTypes.GivenName, user.HoTen),
                        new Claim(ClaimTypes.Email, user.Email ?? ""),
                        new Claim(ClaimTypes.MobilePhone, user.SoDienThoai ?? ""),
                        new Claim(ClaimTypes.Role, "KhachHang") // Gán Role
                    };

                    var claimsIdentity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);

                    // SỬA: Không còn IsPersistent = Input.RememberMe
                    var authProperties = new AuthenticationProperties();

                    // 1. Đăng nhập Cookie cho Frontend
                    await HttpContext.SignInAsync(
                        CookieAuthenticationDefaults.AuthenticationScheme,
                        new ClaimsPrincipal(claimsIdentity),
                        authProperties);

                    // 2. Lưu JWT Token vào Session để ApiClient sử dụng
                    HttpContext.Session.SetString("JwtToken", apiResponse.Token);

                    HttpContext.Session.SetString("AvatarUrl", user.AnhDaiDienUrl ?? "");
                    return LocalRedirect(returnUrl);
                }
                else
                {
                    ModelState.AddModelError(string.Empty, apiResponse?.Message ?? "Lỗi không xác định từ API.");
                    return Page();
                }
            }

            ModelState.AddModelError(string.Empty, "Không thể kết nối đến máy chủ đăng nhập.");
            return Page();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\DangXuat.cshtml
================================================================================
﻿@page
@model WebCafebookApi.Pages.Account.DangXuatModel
@{
    // Trang này không cần hiển thị gì đặc biệt,
    // chỉ cần để PageModel xử lý logic đăng xuất trong OnPost.
    ViewData["Title"] = "Đăng xuất";
}

<header>
    <h1>@ViewData["Title"]</h1>
    <p>Bạn đã đăng xuất thành công.</p>
    @* Có thể thêm nút quay lại trang chủ *@
    <a asp-page="/TrangChuView">Quay lại Trang Chủ</a>
</header>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\DangXuat.cshtml.cs
================================================================================
﻿using System.Threading.Tasks;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;

namespace WebCafebookApi.Pages.Account
{
    public class DangXuatModel : PageModel
    {
        // Sửa lỗi CS8625: string -> string?
        public async Task<IActionResult> OnPostAsync(string? returnUrl = null)
        {
            await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
            HttpContext.Session.Clear();

            if (returnUrl != null)
            {
                return LocalRedirect(returnUrl);
            }
            else
            {
                return RedirectToPage("/TrangChuView");
            }
        }

        public async Task<IActionResult> OnGetAsync(string? returnUrl = null) // Sửa lỗi CS8625
        {
            return await OnPostAsync(returnUrl);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\DanhGiaView.cshtml
================================================================================
﻿@page "/tai-khoan/danh-gia"
@model WebCafebookApi.Pages.Account.DanhGiaViewModel
@{
    ViewData["Title"] = "Gửi Đánh Giá";
    Layout = "_Layout_Account";
}

<style>
    /* CSS cho ngôi sao */
    .rating {
        display: inline-block;
        direction: rtl; /* Đảo ngược thứ tự để sao từ phải qua trái */
    }

        .rating > input {
            display: none;
        }

        .rating > label {
            font-size: 2.5rem;
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s;
        }

            /* Khi input được check (chọn), tất cả các label "sau" nó (thực tế là trước nó vì đã đảo) sẽ đổi màu */
            .rating > input:checked ~ label,
            /* Khi hover vào một label, nó và tất cả các label "sau" nó sẽ đổi màu */
            .rating > label:hover,
            .rating > label:hover ~ label {
                color: #f5b301; /* Màu vàng cam */
            }

        /* Đảm bảo khi không hover nữa, màu sắc trở về đúng trạng thái checked */
        .rating > input:checked:not(:hover) ~ label {
            color: #f5b301;
        }
</style>

<div class="col-lg-9">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3">
            <h5 class="mb-0">Đánh giá sản phẩm cho Đơn hàng #@Model.IdHoaDonHienTai</h5>
        </div>
        <div class="card-body p-4">

            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success">@TempData["SuccessMessage"]</div>
            }
            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
            }
            @if (TempData["InfoMessage"] != null)
            {
                <div class="alert alert-info">@TempData["InfoMessage"]</div>
            }
            <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>


            @if (Model.SanPhamsDeDanhGia == null || !Model.SanPhamsDeDanhGia.Any())
            {
                <p>Không có sản phẩm nào cần đánh giá cho đơn hàng này.</p>
            }
            else
            {
                foreach (var sanPham in Model.SanPhamsDeDanhGia)
                {
                    <div class="row align-items-center mb-3">
                        <div class="col-md-2">
                            <img src="@(sanPham.HinhAnhUrl ?? "/images/default-food-icon.png")" class="img-fluid rounded" alt="@sanPham.TenSanPham">
                        </div>
                        <div class="col-md-10">
                            <h6 class="mb-1">@sanPham.TenSanPham</h6>

                            @if (sanPham.DaDanhGia)
                            {
                                <div class="alert alert-light" role="alert">
                                    <small class="text-muted">Bạn đã đánh giá sản phẩm này.</small>
                                </div>
                            }
                            else
                            {
                                <form method="post" asp-page-handler="SubmitReview" enctype="multipart/form-data">

                                    <input type="hidden" asp-for="DanhGiaInput.idHoaDon" value="@Model.IdHoaDonHienTai" />
                                    <input type="hidden" asp-for="DanhGiaInput.idSanPham" value="@sanPham.IdSanPham" />

                                    <div class="mb-2">
                                        <label class="form-label d-block">Chất lượng sản phẩm:</label>
                                        <div class="rating">
                                            <input type="radio" id="star5-@sanPham.IdSanPham" asp-for="DanhGiaInput.SoSao" value="5" /><label for="star5-@sanPham.IdSanPham">☆</label>
                                            <input type="radio" id="star4-@sanPham.IdSanPham" asp-for="DanhGiaInput.SoSao" value="4" /><label for="star4-@sanPham.IdSanPham">☆</label>
                                            <input type="radio" id="star3-@sanPham.IdSanPham" asp-for="DanhGiaInput.SoSao" value="3" /><label for="star3-@sanPham.IdSanPham">☆</label>
                                            <input type="radio" id="star2-@sanPham.IdSanPham" asp-for="DanhGiaInput.SoSao" value="2" /><label for="star2-@sanPham.IdSanPham">☆</label>
                                            <input type="radio" id="star1-@sanPham.IdSanPham" asp-for="DanhGiaInput.SoSao" value="1" /><label for="star1-@sanPham.IdSanPham">☆</label>
                                        </div>

                                        <span asp-validation-for="DanhGiaInput.SoSao" class="text-danger small d-block mt-1"></span>
                                    </div>

                                    <div class="mb-3">
                                        <label asp-for="DanhGiaInput.BinhLuan" class="form-label">Viết bình luận</label>
                                        <textarea asp-for="DanhGiaInput.BinhLuan" class="form-control" rows="3" placeholder="Chia sẻ trải nghiệm của bạn..."></textarea>

                                        <span asp-validation-for="DanhGiaInput.BinhLuan" class="text-danger small"></span>
                                    </div>

                                    <div class="mb-3">
                                        <label asp-for="HinhAnhFile" class="form-label">Thêm hình ảnh (không bắt buộc)</label>
                                        <input asp-for="HinhAnhFile" class="form-control" type="file" accept="image/*">
                                    </div>

                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                        <button type="submit" class="btn btn-primary">Gửi Đánh Giá</button>
                                    </div>
                                </form>
                            }
                        </div>
                    </div>
                    <hr class="my-3" />
                }
            }

            <div class="mt-4">
                <a asp-page="/Account/LichSuDonHangDetailView" asp-route-id="@Model.IdHoaDonHienTai" class="btn btn-secondary me-md-2">
                    Quay lại Đơn hàng
                </a>
                <a asp-page="/Account/LichSuDonHangView" class="btn btn-outline-secondary">
                    Về Lịch sử mua hàng
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\DanhGiaView.cshtml.cs
================================================================================
﻿using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.ComponentModel.DataAnnotations;
using System.Net.Http.Headers;
using System.Text.Json;
using System.Net.Http.Json;

namespace WebCafebookApi.Pages.Account
{
    [Authorize]
    public class DanhGiaViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;
        private readonly IHttpContextAccessor _httpContextAccessor;

        public DanhGiaViewModel(IHttpClientFactory httpClientFactory, IHttpContextAccessor httpContextAccessor)
        {
            _httpClientFactory = httpClientFactory;
            _httpContextAccessor = httpContextAccessor;
        }

        [BindProperty]
        public TaoDanhGiaDto DanhGiaInput { get; set; } = new TaoDanhGiaDto();

        [BindProperty]
        public IFormFile? HinhAnhFile { get; set; }

        public List<SanPhamChoDanhGiaDto> SanPhamsDeDanhGia { get; set; } = new List<SanPhamChoDanhGiaDto>();

        [BindProperty(SupportsGet = true)]
        public int IdHoaDonHienTai { get; set; }

        public async Task<IActionResult> OnGetAsync(int idHoaDon)
        {
            IdHoaDonHienTai = idHoaDon;
            var client = _httpClientFactory.CreateClient("ApiClient");

            // <<< SỬA LỖI 1: Sửa "JWToken" thành "JwtToken"
            var token = _httpContextAccessor.HttpContext?.Session.GetString("JwtToken");

            if (string.IsNullOrEmpty(token))
            {
                TempData["ErrorMessage"] = "Phiên đăng nhập đã hết hạn.";
                // <<< SỬA LỖI 2: Sửa "/Account/LoginView" thành "/Account/Login"
                return RedirectToPage("/Account/Login");
            }
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

            try
            {
                var apiUrl = $"api/web/danhgia/cho-danh-gia/{idHoaDon}";
                var response = await client.GetAsync(apiUrl);

                if (response.IsSuccessStatusCode)
                {
                    SanPhamsDeDanhGia = await response.Content.ReadFromJsonAsync<List<SanPhamChoDanhGiaDto>>() ?? new List<SanPhamChoDanhGiaDto>();

                    if (!SanPhamsDeDanhGia.Any())
                    {
                        TempData["InfoMessage"] = "Không tìm thấy sản phẩm nào trong đơn hàng này hoặc đơn hàng chưa hoàn thành.";
                    }
                }
                else
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    TempData["ErrorMessage"] = $"Không thể tải danh sách sản phẩm: {errorContent}";
                }
            }
            catch (Exception ex)
            {
                TempData["ErrorMessage"] = $"Lỗi hệ thống khi tải trang: {ex.Message}";
            }

            return Page();
        }


        public async Task<IActionResult> OnPostSubmitReviewAsync()
        {
            IdHoaDonHienTai = DanhGiaInput.idHoaDon;

            if (!ModelState.IsValid)
            {
                TempData["ErrorMessage"] = "Dữ liệu không hợp lệ. Vui lòng kiểm tra lại.";
                await OnGetAsync(IdHoaDonHienTai);
                return Page();
            }

            var client = _httpClientFactory.CreateClient("ApiClient");

            // <<< SỬA LỖI 1: Sửa "JWToken" thành "JwtToken"
            var token = _httpContextAccessor.HttpContext?.Session.GetString("JwtToken");

            if (string.IsNullOrEmpty(token))
            {
                TempData["ErrorMessage"] = "Phiên đăng nhập đã hết hạn.";
                // <<< SỬA LỖI 2: Sửa "/Account/LoginView" thành "/Account/Login"
                return RedirectToPage("/Account/Login");
            }
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);


            var formData = new MultipartFormDataContent();
            formData.Add(new StringContent(DanhGiaInput.idHoaDon.ToString()), "idHoaDon");
            formData.Add(new StringContent(DanhGiaInput.idSanPham.ToString()), "idSanPham");
            formData.Add(new StringContent(DanhGiaInput.SoSao.ToString()), "SoSao");

            if (!string.IsNullOrEmpty(DanhGiaInput.BinhLuan))
            {
                formData.Add(new StringContent(DanhGiaInput.BinhLuan), "BinhLuan");
            }

            if (HinhAnhFile != null && HinhAnhFile.Length > 0)
            {
                var fileContent = new StreamContent(HinhAnhFile.OpenReadStream());
                fileContent.Headers.ContentType = new MediaTypeHeaderValue(HinhAnhFile.ContentType);
                formData.Add(fileContent, "hinhAnhFile", HinhAnhFile.FileName);
            }

            try
            {
                var response = await client.PostAsync("api/web/danhgia", formData);

                if (response.IsSuccessStatusCode)
                {
                    TempData["SuccessMessage"] = "Gửi đánh giá thành công!";
                    return RedirectToPage("/Account/DanhGiaView", new { idHoaDon = IdHoaDonHienTai });
                }
                else
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    TempData["ErrorMessage"] = $"Lỗi khi gửi đánh giá: {errorContent}";
                    await OnGetAsync(IdHoaDonHienTai);
                    return Page();
                }
            }
            catch (Exception ex)
            {
                TempData["ErrorMessage"] = $"Lỗi hệ thống: {ex.Message}";
                await OnGetAsync(IdHoaDonHienTai);
                return Page();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\DatLaiMatKhauView.cshtml
================================================================================
﻿@page "/Account/ResetPassword"
@* SỬA: Namespace *@
@model WebCafebookApi.Pages.Account.DatLaiMatKhauViewModel
@{
    ViewData["Title"] = "Đặt Lại Mật Khẩu";
    Layout = null; // Dùng layout login
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Cafebook</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body class="login-page-body">

    <div class="login-wrapper">
        <div class="login-container">
            <div class="login-brand-col d-none d-md-flex">
                <img src="/images/logo.png" alt="Cafebook Logo">
                <h1 class="mb-2">Cafebook</h1>
                <p class="fs-5 opacity-75">Khôi phục tài khoản</p>
            </div>

            <div class="login-form-col">
                <h2>@ViewData["Title"]</h2>
                <p class="text-muted">Nhập mật khẩu mới cho tài khoản của bạn.</p>

                @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                {
                    <div class="alert alert-danger">@Model.ErrorMessage</div>
                }

                @if (string.IsNullOrEmpty(Model.ErrorMessage))
                {
                    <form method="post">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-2" role="alert"></div>
                        <input type="hidden" asp-for="Input.Email" />
                        <input type="hidden" asp-for="Input.Token" />

                        <div class="form-floating-material">
                            <input asp-for="Input.NewPassword" type="password" class="form-control" autocomplete="new-password" aria-required="true" placeholder=" " />
                            <label asp-for="Input.NewPassword" class="form-label"></label>
                            <span class="material-symbols-outlined">lock</span>
                            <span asp-validation-for="Input.NewPassword" class="text-danger small"></span>
                        </div>

                        <div class="form-floating-material">
                            <input asp-for="Input.ConfirmPassword" type="password" class="form-control" autocomplete="new-password" aria-required="true" placeholder=" " />
                            <label asp-for="Input.ConfirmPassword" class="form-label"></label>
                            <span class="material-symbols-outlined">lock_reset</span>
                            <span asp-validation-for="Input.ConfirmPassword" class="text-danger small"></span>
                        </div>

                        <button type="submit" class="w-100 btn btn-lg btn-primary mt-3">Đặt Lại Mật Khẩu</button>
                    </form>
                }
                else
                {
                    <a asp-page="/Account/QuenMatKhauView" class="btn btn-primary">Yêu cầu mã mới</a>
                }
            </div>
        </div>
    </div>

    <partial name="_ValidationScriptsPartial" />
</body>
</html>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\DatLaiMatKhauView.cshtml.cs
================================================================================
﻿using CafebookModel.Model.ModelWeb; // <-- THÊM
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.Extensions.Caching.Memory;
using System.ComponentModel.DataAnnotations;
using System.Threading.Tasks;
using System.Net.Http; // <-- THÊM
using System.Net.Http.Json; // <-- THÊM
using System; // <-- THÊM

namespace WebCafebookApi.Pages.Account // SỬA: Namespace
{
    public class DatLaiMatKhauViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory; // <-- SỬA
        private readonly IMemoryCache _cache;

        public DatLaiMatKhauViewModel(IHttpClientFactory httpClientFactory, IMemoryCache cache)
        {
            _httpClientFactory = httpClientFactory; // <-- SỬA
            _cache = cache;
        }

        [BindProperty]
        public InputModel Input { get; set; } = new InputModel();

        [TempData]
        public string? ErrorMessage { get; set; }

        public class InputModel
        {
            [Required]
            [HiddenInput]
            public string Email { get; set; } = string.Empty;

            [Required]
            [HiddenInput]
            public string Token { get; set; } = string.Empty;

            [Required(ErrorMessage = "Vui lòng nhập mật khẩu mới")]
            [StringLength(100, ErrorMessage = "Mật khẩu mới phải dài ít nhất 6 ký tự.", MinimumLength = 6)]
            [DataType(DataType.Password)]
            [Display(Name = "Mật khẩu mới")]
            public string NewPassword { get; set; } = string.Empty;

            [DataType(DataType.Password)]
            [Display(Name = "Xác nhận mật khẩu mới")]
            [Compare("NewPassword", ErrorMessage = "Mật khẩu mới và mật khẩu xác nhận không khớp.")]
            public string ConfirmPassword { get; set; } = string.Empty;
        }

        public IActionResult OnGet(string email, string token)
        {
            string resetCacheKey = $"ResetToken_{email}";
            if (string.IsNullOrEmpty(email) || string.IsNullOrEmpty(token) ||
                !_cache.TryGetValue(resetCacheKey, out string? cachedToken) || cachedToken != token)
            {
                ErrorMessage = "Đường dẫn đặt lại mật khẩu không hợp lệ hoặc đã hết hạn. Vui lòng thử lại.";
            }
            else
            {
                Input.Email = email;
                Input.Token = token;
            }
            return Page();
        }

        public async Task<IActionResult> OnPostAsync()
        {
            if (!ModelState.IsValid)
            {
                return Page();
            }

            string email = Input.Email;
            string token = Input.Token;
            string resetCacheKey = $"ResetToken_{email}";

            if (string.IsNullOrEmpty(email) || string.IsNullOrEmpty(token) ||
                !_cache.TryGetValue(resetCacheKey, out string? cachedToken) || cachedToken != token)
            {
                ErrorMessage = "Phiên làm việc đã hết hạn. Vui lòng yêu cầu lại mã.";
                return Page();
            }

            var httpClient = _httpClientFactory.CreateClient();
            var resetRequest = new ResetPasswordRequestDto
            {
                Email = email,
                NewPassword = Input.NewPassword
            };

            try
            {
                var response = await httpClient.PostAsJsonAsync("http://localhost:5166/api/web/password/reset", resetRequest);

                if (response.IsSuccessStatusCode)
                {
                    _cache.Remove(resetCacheKey);
                    TempData["LoginMessage"] = "Mật khẩu của bạn đã được đặt lại thành công. Vui lòng đăng nhập.";
                    return RedirectToPage("./DangNhapView");
                }
                else
                {
                    ErrorMessage = "Đã xảy ra lỗi khi đặt lại mật khẩu. Vui lòng thử lại.";
                    return Page();
                }
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Lỗi kết nối API: {ex.Message}";
                return Page();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\DoiMatKhauView.cshtml
================================================================================
﻿@page "/Account/DoiMatKhauView"
@model WebCafebookApi.Pages.Account.DoiMatKhauViewModel
@{
    ViewData["Title"] = "Đổi mật khẩu";
    Layout = "_Layout_Account"; // Sử dụng layout tài khoản
}

<h3 class="page-title-account">@ViewData["Title"]</h3>
<p class="page-lead-account">Để bảo mật, hãy chọn một mật khẩu mạnh và không sử dụng lại ở nơi khác.</p>

<hr class="my-4" />

<div class="row">
    <div class="col-md-8">
        @if (!string.IsNullOrEmpty(Model.PasswordSuccessMessage))
        {
            <div class="alert alert-success">@Model.PasswordSuccessMessage</div>
        }
        @if (!string.IsNullOrEmpty(Model.PasswordErrorMessage))
        {
            <div class="alert alert-danger">@Model.PasswordErrorMessage</div>
        }

        <form method="post">
            <div asp-validation-summary="ModelOnly" class="text-danger mb-3" role="alert"></div>

            <div class="material-input-group mb-3">
                <label asp-for="PasswordInput.MatKhauCu" class="form-label fw-bold"></label>
                <input asp-for="PasswordInput.MatKhauCu" class="material-input" type="password" />
                <span asp-validation-for="PasswordInput.MatKhauCu" class="text-danger small"></span>
            </div>

            <div class="material-input-group mb-3">
                <label asp-for="PasswordInput.MatKhauMoi" class="form-label fw-bold"></label>
                <input asp-for="PasswordInput.MatKhauMoi" class="material-input" type="password" />
                <span asp-validation-for="PasswordInput.MatKhauMoi" class="text-danger small"></span>
            </div>

            <div class="material-input-group mb-3">
                <label asp-for="PasswordInput.XacNhanMatKhauMoi" class="form-label fw-bold"></label>
                <input asp-for="PasswordInput.XacNhanMatKhauMoi" class="material-input" type="password" />
                <span asp-validation-for="PasswordInput.XacNhanMatKhauMoi" class="text-danger small"></span>
            </div>

            <button type="submit" class="btn btn-primary mt-3">
                <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 4px;">lock_reset</span>
                Đổi Mật Khẩu
            </button>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\DoiMatKhauView.cshtml.cs
================================================================================
﻿using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Json;
using System.Security.Claims;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Authentication;
using System; // <-- THÊM

namespace WebCafebookApi.Pages.Account
{
    [Authorize(Roles = "KhachHang")]
    public class DoiMatKhauViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        [BindProperty]
        public PasswordChangeModel PasswordInput { get; set; } = new();

        [TempData]
        public string? PasswordSuccessMessage { get; set; }
        [TempData]
        public string? PasswordErrorMessage { get; set; }

        public DoiMatKhauViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        public void OnGet()
        {
            // SỬA LỖI CS0103: Xóa dòng "Layout = ..." ở đây.
        }

        private int GetCurrentUserId()
        {
            var userIdClaim = User.FindFirstValue(ClaimTypes.NameIdentifier);
            int.TryParse(userIdClaim, out int userId);
            return userId;
        }

        public async Task<IActionResult> OnPostAsync()
        {
            // SỬA LỖI CS0103: Xóa dòng "Layout = ..." ở đây.
            var userId = GetCurrentUserId();
            if (userId == 0) return Challenge();

            if (!ModelState.IsValid)
            {
                return Page();
            }

            var httpClient = _httpClientFactory.CreateClient();
            try
            {
                var response = await httpClient.PostAsJsonAsync($"http://localhost:5166/api/web/profile/change-password/{userId}", PasswordInput);

                if (response.IsSuccessStatusCode)
                {
                    await HttpContext.SignOutAsync(Microsoft.AspNetCore.Authentication.Cookies.CookieAuthenticationDefaults.AuthenticationScheme);
                    TempData["LoginMessage"] = "Đổi mật khẩu thành công! Vui lòng đăng nhập lại.";
                    return RedirectToPage("/Account/DangNhapView");
                }
                else
                {
                    var error = await response.Content.ReadFromJsonAsync<ApiErrorResponse>();
                    PasswordErrorMessage = error?.Message ?? "Lỗi không xác định.";
                }
            }
            catch (Exception ex)
            {
                PasswordErrorMessage = $"Lỗi: {ex.Message}";
            }

            return Page();
        }

        private class ApiErrorResponse { public string? Message { get; set; } }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\LichSuDatBanView.cshtml
================================================================================
﻿@page "/Account/LichSuDatBanView"
@model WebCafebookApi.Pages.Account.LichSuDatBanViewModel
@{
    ViewData["Title"] = "Lịch sử đặt bàn";
    Layout = "_Layout_Account"; // Sử dụng layout tài khoản
}

<h3 class="page-title-account">@ViewData["Title"]</h3>
<p class="page-lead-account">Theo dõi các phiếu đặt bàn sắp tới và đã hoàn thành của bạn.</p>

<hr class="my-4" />

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

@if (Model.Bookings == null || !Model.Bookings.Any())
{
    <div class="alert alert-info">
        Bạn chưa có lịch sử đặt bàn nào.
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th scope="col">Bàn</th>
                    <th scope="col">Thời gian</th>
                    <th scope="col">Số khách</th>
                    <th scope="col">Trạng thái</th>
                    <th scope="col">Ghi chú</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Bookings)
                {
                    <tr>
                        <td class="fw-bold">@item.TenBan</td>
                        <td>@item.ThoiGianDat.ToString("HH:mm, dd/MM/yyyy")</td>
                        <td>@item.SoLuongKhach</td>
                        <td>
                            <span class="badge @GetBadgeClass(item.TrangThai)">
                                @item.TrangThai
                            </span>
                        </td>
                        <td>@item.GhiChu</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@functions {
    private string GetBadgeClass(string trangThai)
    {
        return trangThai switch
        {
            "Đã xác nhận" => "bg-primary",
            "Đã hủy" => "bg-danger",
            "Khách đã đến" => "bg-success",
            "Đã hoàn thành" => "bg-secondary",
            _ => "bg-dark",
        };
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\LichSuDatBanView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/Account/LichSuDatBanView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Collections.Generic;
using System.Net.Http;
using System.Net.Http.Json;
using System.Security.Claims;
using System.Threading.Tasks;

namespace WebCafebookApi.Pages.Account
{
    [Authorize(Roles = "KhachHang")]
    public class LichSuDatBanViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        public List<LichSuDatBanDto> Bookings { get; set; } = new List<LichSuDatBanDto>();

        [TempData]
        public string? ErrorMessage { get; set; }

        public LichSuDatBanViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        private int GetCurrentUserId()
        {
            var userIdClaim = User.FindFirstValue(ClaimTypes.NameIdentifier);
            int.TryParse(userIdClaim, out int userId);
            return userId;
        }

        public async Task<IActionResult> OnGetAsync()
        {
            var userId = GetCurrentUserId();
            if (userId == 0) return Challenge();

            var httpClient = _httpClientFactory.CreateClient();
            try
            {
                var response = await httpClient.GetAsync($"http://localhost:5166/api/web/profile/booking-history/{userId}");
                if (response.IsSuccessStatusCode)
                {
                    Bookings = await response.Content.ReadFromJsonAsync<List<LichSuDatBanDto>>() ?? new List<LichSuDatBanDto>();
                }
                else
                {
                    ErrorMessage = "Không thể tải lịch sử đặt bàn.";
                }
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Lỗi kết nối: {ex.Message}";
            }

            return Page();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\LichSuDonHangDetailView.cshtml
================================================================================
﻿@page "/Account/LichSuDonHangDetailView/{id:int}"
@model WebCafebookApi.Pages.Account.LichSuDonHangDetailViewModel
@{
    ViewData["Title"] = "Chi Tiết Đơn Hàng";
    Layout = "_Layout_Account";
}

@section Styles {
    <style>
        /* CSS cho thanh tiến trình (Progress Tracker) */
        .progress-tracker {
            display: flex;
            justify-content: space-between;
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
        }

            .progress-step .icon {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background-color: #e0e0e0;
                color: white;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                font-size: 1.2rem;
                border: 4px solid #fff;
                z-index: 2;
                position: relative;
            }

            .progress-step .text {
                display: block;
                margin-top: 5px;
                font-size: 0.9rem;
                color: #757575;
            }

            .progress-step:not(:first-child)::before {
                content: '';
                position: absolute;
                width: 100%;
                height: 4px;
                background-color: #e0e0e0;
                top: 20px; /* (40px + 4px*2) / 2 - 4px/2 */
                right: 50%;
                z-index: 1;
            }
            /* Trạng thái Active/Completed */
            .progress-step.completed .icon,
            .progress-step.active .icon {
                background-color: var(--bs-success);
            }

            .progress-step.completed .text {
                color: var(--bs-success);
                font-weight: 500;
            }

            .progress-step.active .text {
                color: var(--cf-dark-brown);
                font-weight: 700;
            }

            .progress-step.completed:not(:first-child)::before {
                background-color: var(--bs-success);
            }

        /* CSS cho Timeline Vận Chuyển */
        .timeline {
            list-style: none;
            padding: 0;
            position: relative;
        }

            .timeline::before {
                content: '';
                position: absolute;
                top: 0;
                bottom: 0;
                left: 20px;
                width: 4px;
                background-color: #eee;
            }

        .timeline-item {
            position: relative;
            padding-left: 50px;
            margin-bottom: 25px;
        }

        .timeline-icon {
            position: absolute;
            left: 0;
            top: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e0e0e0;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            border: 4px solid #f9f9f9;
            z-index: 2;
        }

        .timeline-item.active .timeline-icon {
            background-color: var(--bs-success);
        }

        .timeline-content {
            padding-top: 5px;
        }

            .timeline-content .status {
                font-weight: 600;
                color: var(--cf-dark-brown);
            }

            .timeline-content .description {
                color: #6c757d;
                font-size: 0.9rem;
            }

            .timeline-content .timestamp {
                font-size: 0.85rem;
                color: #9e9e9e;
            }

        .timeline-item.active .timeline-content .status {
            color: var(--bs-success);
        }

        /* CSS cho thẻ đơn hàng (Copy từ LichSuDonHangView) */
        .order-card {
            background-color: var(--cf-white);
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .order-card-header {
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .order-item {
            padding: 1.25rem;
            display: flex;
            gap: 1rem;
            border-bottom: 1px dashed #eee;
        }

        .order-item-img img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        .order-item-info {
            flex: 1;
        }

            .order-item-info h6 {
                font-weight: 600;
                margin-bottom: 0.25rem;
            }

            .order-item-info .qty {
                font-size: 0.9rem;
                color: #666;
            }

        .order-item-price {
            font-weight: 500;
            color: var(--cf-text);
            font-size: 0.9rem;
        }

        .order-total-summary {
            list-style: none;
            padding: 0;
            font-size: 1.1rem;
        }

            .order-total-summary li {
                display: flex;
                justify-content: space-between;
                margin-bottom: 0.5rem;
            }

                .order-total-summary li span:first-child {
                    color: #6c757d;
                }

                .order-total-summary li.total {
                    font-size: 1.3rem;
                    font-weight: 700;
                    color: var(--bs-danger);
                    border-top: 1px dashed #eee;
                    padding-top: 1rem;
                    margin-top: 0.5rem;
                }
        /* Thêm style cho ảnh trong modal */
        #deliveryProofImage {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>
}

<div class="mb-3">
    <a asp-page="/Account/LichSuDonHangView" class="text-decoration-none text-secondary fw-bold">
        <span class="material-symbols-outlined" style="vertical-align: middle;">arrow_back</span>
        Quay lại danh sách đơn hàng
    </a>
</div>

<h3 class="page-title-account">@ViewData["Title"]</h3>
@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}
else if (Model.OrderDetails != null)
{
    var order = Model.OrderDetails;
    <div class="card order-card">
        <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">Mã đơn hàng: <strong>@order.MaDonHang</strong></h5>
                    <span class="text-muted">Ngày đặt: @order.ThoiGianTao.ToString("dd/MM/yyyy HH:mm")</span>
                </div>
                <div class="text-end">
                    <h5 class="mb-0 text-uppercase" style="color: var(--cf-orange);">@order.TrangThaiGiaoHang</h5>
                    
                    @if (!string.IsNullOrEmpty(order.AnhXacNhanGiaoHangUrl) && order.TrangThaiGiaoHang == "Hoàn thành")
                    {
                        <button type="button" class="btn btn-sm btn-outline-success mt-2" data-bs-toggle="modal" data-bs-target="#imageModal">
                            <span class="material-symbols-outlined" style="font-size: 1rem; vertical-align: text-bottom;">image</span>
                            Xem ảnh giao hàng
                        </button>
                    }
                </div>
            </div>

            <hr />
            <ul class="progress-tracker">
                @{
                    bool cxn = order.TrangThaiGiaoHang == "Chờ xác nhận";
                    bool clh = order.TrangThaiGiaoHang == "Chờ lấy hàng";
                    bool dg = order.TrangThaiGiaoHang == "Đang giao";
                    bool ht = order.TrangThaiGiaoHang == "Hoàn thành";
                    bool dh = order.TrangThaiGiaoHang == "Đã Hủy"; // Sửa "Đã Hủy" cho khớp API
                }
                <li class="progress-step @(cxn || clh || dg || ht ? "completed" : "") @(cxn ? "active" : "")">
                    <span class="icon"><span class="material-symbols-outlined">receipt_long</span></span>
                    <span class="text">Đã Đặt</span>
                </li>
                 <li class="progress-step @(clh || dg || ht ? "completed" : "") @(clh ? "active" : "")">
                    <span class="icon"><span class="material-symbols-outlined">inventory_2</span></span>
                    <span class="text">Chờ Lấy Hàng</span>
                </li>
                 <li class="progress-step @(dg || ht ? "completed" : "") @(dg ? "active" : "")">
                    <span class="icon"><span class="material-symbols-outlined">local_shipping</span></span>
                    <span class="text">Đang Giao</span>
                </li>
                <li class="progress-step @(ht ? "completed" : "") @(ht ? "active" : "")">
                    <span class="icon"><span class="material-symbols-outlined">task_alt</span></span>
                    <span class="text">Hoàn Thành</span>
                </li>
            </ul>

        </div>
    </div>

    <div class="row g-4">
         <div class="col-lg-5">
            <div class="card order-card h-100">
                <div class="card-body p-4">
                    <h5 class="mb-3">Địa Chỉ Nhận Hàng</h5>
                    <h6 class="fw-bold">@order.HoTen</h6>
                    <p class="mb-1 text-muted">@order.SoDienThoai</p>
                    <p class="mb-0 text-muted">@order.DiaChiGiaoHang</p>
                </div>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="card order-card h-100">
                <div class="card-body p-4">
                    <h5 class="mb-4">Lịch sử vận chuyển</h5>
                    <ul class="timeline">
                        @foreach (var tracking in order.TrackingEvents)
                        {
                          <li class="timeline-item @(tracking.IsCurrent ? "active" : "")">
                                <div class="timeline-icon">
                                    <span class="material-symbols-outlined">@(tracking.Status == "Đơn hàng đã đặt" ? "receipt_long" : (tracking.Status == "Giao hàng thành công" ? "task_alt" : "local_shipping"))</span>
                               </div>
                                <div class="timeline-content">
                                    <span class="status">@tracking.Status</span>
                                    <p class="description mb-0">@tracking.Description</p>
                                    <span class="timestamp">@tracking.Timestamp.ToString("HH:mm dd/MM/yyyy")</span>
                                </div>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row g-4">
         <div class="col-lg-8">
            <div class="card order-card">
                 <div class="order-card-header">
                    <span class="shop-name">
                        <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.2rem;">storefront</span>
                        Cafebook
                    </span>
                </div>
                <div class="order-items-container">
                     @foreach (var item in order.Items)
                    {
                        var imgUrl = item.HinhAnhUrl ?? "/images/default-food-icon.png";
                        <div class="order-item">
                            <div class="order-item-img">
                                <img src="@imgUrl" alt="@item.TenSanPham" />
                            </div>
                            <div class="order-item-info">
                                <h6>@item.TenSanPham</h6>
                                <div class="qty">x @item.SoLuong</div>

                                 @if (order.TrangThaiGiaoHang == "Hoàn thành")
                                {
                                    bool daDanhGiaSP = await Model.KiemTraDaDanhGia(order.IdHoaDon, item.IdSanPham, null);
                                     if (daDanhGiaSP)
                                    {
                                        <span class="text-success mt-2 d-block" style="font-size: 0.9rem;">
                                           <span class="material-symbols-outlined" style="vertical-align: bottom; font-size: 1.1rem;">check_circle</span>
                                            Đã đánh giá
                                        </span>
                                       }
                                    else
                                    {
                                        <a asp-page="./DanhGiaView"
                                           asp-route-idHoaDon="@order.IdHoaDon"
                                           asp-route-idSanPham="@item.IdSanPham"
                                           class="btn btn-sm btn-outline-primary mt-2">
                                             Viết đánh giá
                                        </a>
                                    }
                                 }
                            </div>
                            <div class="order-item-price">
                                @item.DonGia.ToString("N0") đ
                            </div>
                        </div>
                    }
                </div>
            </div>
         </div>
          <div class="col-lg-4">
            <div class="card order-card">
                <div class="card-body p-4">
                    <h5 class="mb-3">Tổng cộng</h5>
                    <ul class="order-total-summary">
                        <li>
                            <span>Tổng tiền hàng</span>
                            <span>@order.TongTienHang.ToString("N0") đ</span>
                        </li>
                        <li>
                            <span>Giảm giá</span>
                            <span class="text-danger">-@order.GiamGia.ToString("N0") đ</span>
                         </li>
                        <li class="total">
                            <span>Thành tiền</span>
                            <span>@order.ThanhTien.ToString("N0") đ</span>
                        </li>
                    </ul>
                    <hr />
                    <p class="mb-0">
                        <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.2rem; color: #6c757d;">payments</span>
                        <span class="text-muted">Đã thanh toán bằng @order.PhuongThucThanhToan</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(order.AnhXacNhanGiaoHangUrl))
    {
        <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header border-0">
                        <h5 class="modal-title" id="imageModalLabel">Ảnh xác nhận giao hàng</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center bg-light p-4">
                        <img src="@order.AnhXacNhanGiaoHangUrl" id="deliveryProofImage" alt="Ảnh giao hàng" class="img-fluid" />
                    </div>
                </div>
            </div>
        </div>
    }
}
else
{
    <div class="alert alert-info">Đang tải chi tiết đơn hàng...</div>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\LichSuDonHangDetailView.cshtml.cs
================================================================================
﻿// TỆP: WebCafebookApi/Pages/Account/LichSuDonHangDetailView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
// Thêm 2 using này để xử lý AuthenticationHeaderValue
using System.Net.Http.Headers;
using Microsoft.AspNetCore.Http;

namespace WebCafebookApi.Pages.Account
{
    [Authorize(Roles = "KhachHang")]
    public class LichSuDonHangDetailViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        public LichSuDonHangDetailViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        [BindProperty(SupportsGet = true)]
        public int Id { get; set; } // IdHoaDon

        public DonHangChiTietWebDto? OrderDetails { get; set; }
        public string? ErrorMessage { get; set; }

        public async Task<IActionResult> OnGetAsync()
        {
            if (Id == 0)
            {
                ErrorMessage = "Mã đơn hàng không hợp lệ.";
                return Page();
            }

            var httpClient = _httpClientFactory.CreateClient("ApiClient");
            try
            {
                // Gọi API mới trong KhachHangProfileController
                OrderDetails = await httpClient.GetFromJsonAsync<DonHangChiTietWebDto>($"/api/web/profile/order-detail/{Id}");
            }
            catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                ErrorMessage = "Không tìm thấy đơn hàng hoặc bạn không có quyền xem đơn hàng này.";
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Lỗi tải chi tiết đơn hàng: {ex.Message}";
            }

            return Page();
        }

        // ==================================================
        // ===== VÙNG CODE ĐÃ SỬA LỖI _apiClient =====
        // ==================================================
        public async Task<bool> KiemTraDaDanhGia(int idHoaDon, int? idSanPham, int? idSach)
        {
            // 1. Lấy HttpClient từ Factory (giống như OnGetAsync)
            var httpClient = _httpClientFactory.CreateClient("ApiClient");

            // 2. Lấy token từ Session
            var accessToken = HttpContext.Session.GetString("JWToken");
            if (string.IsNullOrEmpty(accessToken))
            {
                return true; // Không có token, không thể kiểm tra, tạm ẩn nút
            }

            // 3. Gắn token vào header của request này
            httpClient.DefaultRequestHeaders.Authorization =
                new AuthenticationHeaderValue("Bearer", accessToken);

            try
            {
                // 4. Gọi API kiểm tra bằng httpClient
                // (Giả định API controller của bạn là 'DanhGiaWebController' và route là 'api/danhgia/kiemtra')
                var daDanhGia = await httpClient.GetFromJsonAsync<bool>($"api/danhgia/kiemtra?idHoaDon={idHoaDon}&idSanPham={idSanPham}&idSach={idSach}");

                // 5. Xóa header sau khi dùng xong
                httpClient.DefaultRequestHeaders.Authorization = null;
                return daDanhGia;
            }
            catch (Exception)
            {
                httpClient.DefaultRequestHeaders.Authorization = null;
                return true; // Giả định là ĐÃ đánh giá nếu có lỗi, để tránh cho người dùng đánh giá lại
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\LichSuDonHangView.cshtml
================================================================================
﻿@page "/Account/LichSuDonHangView"
@model WebCafebookApi.Pages.Account.LichSuDonHangViewModel
@{
    ViewData["Title"] = "Lịch sử mua hàng";
    Layout = "_Layout_Account";
}

@section Styles {
    <style>
        /* CSS cho các tab (giống Shopee) */
        .order-tabs .nav-link {
            color: var(--cf-text);
            background-color: var(--cf-white);
            border: none;
            border-bottom: 3px solid transparent;
            border-radius: 0;
            font-weight: 500;
            padding-top: 1rem;
            padding-bottom: 1rem;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

            .order-tabs .nav-link.active {
                color: var(--cf-orange);
                border-bottom-color: var(--cf-orange);
                background-color: var(--cf-white);
            }

            .order-tabs .nav-link:hover {
                color: var(--cf-orange);
            }

        .order-tabs {
            background-color: var(--cf-white);
            border-radius: 8px 8px 0 0;
            box-shadow: 0 1px 3px var(--cf-shadow);
        }

        /* CSS cho thẻ đơn hàng (Order Card) */
        .order-card {
            background-color: var(--cf-white);
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px var(--cf-shadow);
        }

        .order-card-header {
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

            .order-card-header .shop-name {
                font-weight: 600;
                color: var(--cf-dark-brown);
            }

            .order-card-header .status-delivery {
                font-weight: 500;
                color: var(--cf-orange);
                text-transform: uppercase;
                font-size: 0.9rem;
            }

            .order-card-header .status-cancelled {
                color: var(--bs-danger);
            }

            .order-card-header .status-completed {
                color: var(--bs-success);
            }

        /* SỬA: Thêm CSS cho vùng item có thể nhấp */
        a.order-items-link {
            display: block;
            text-decoration: none;
            color: inherit;
        }

            a.order-items-link:hover {
                background-color: #fcfcfc;
            }

        .order-item {
            padding: 1.25rem;
            display: flex;
            gap: 1rem;
            border-bottom: 1px dashed #eee;
        }

            .order-item:last-child {
                border-bottom: none;
            }

        .order-item-img img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        .order-item-info {
            flex: 1;
        }

            .order-item-info h6 {
                font-weight: 600;
                margin-bottom: 0.25rem;
            }

            .order-item-info .qty {
                font-size: 0.9rem;
                color: #666;
            }

        .order-item-price {
            font-weight: 500;
            color: var(--cf-text);
            font-size: 0.9rem;
        }

        .order-card-footer {
            padding: 1rem 1.25rem;
            background-color: #fcfcfc;
            border-top: 1px solid #f0f0f0;
            text-align: right;
        }

        .order-total-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--bs-danger);
        }

        .order-card-actions {
            padding: 1rem 1.25rem;
            border-top: 1px solid #f0f0f0;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            flex-wrap: wrap; /* Đảm bảo các nút xuống dòng nếu không đủ chỗ */
        }
    </style>
}

<h3 class="page-title-account">@ViewData["Title"]</h3>
<p class="page-lead-account">Theo dõi các đơn hàng giao tận nơi của bạn.</p>

<hr class="my-4" />

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

<ul class="nav nav-tabs order-tabs">
    @foreach (var tabName in Model.StatusTabs)
    {
        <li class="nav-item">
            <a class="nav-link @(Model.StatusFilter == tabName ? "active" : "")"
               asp-page="/Account/LichSuDonHangView"
               asp-route-StatusFilter="@tabName">@tabName</a>
        </li>
    }
</ul>

<div class="mt-4">
    @if (!Model.FilteredOrders.Any())
    {
        <div class="alert alert-info text-center" style="padding: 50px;">
            <span class="material-symbols-outlined" style="font-size: 48px;">receipt_long</span>
            <h4 class="mt-3">Không có đơn hàng</h4>
            <p>Không tìm thấy đơn hàng nào trong mục này.</p>
        </div>
    }
    else
    {
        @foreach (var order in Model.FilteredOrders)
        {
            var statusText = order.TrangThaiGiaoHang;
            var statusClass = "status-delivery";

            if (order.TrangThaiThanhToan == "Đã hủy")
            {
                statusText = "Đã Hủy";
                statusClass = "status-cancelled";
            }
            else if (order.TrangThaiGiaoHang == "Hoàn thành")
            {
                statusText = "Giao hàng thành công";
                statusClass = "status-completed";
            }

            <div class="order-card">
                <div class="order-card-header">
                    <span class="shop-name">
                        <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.2rem;">storefront</span>
                        Cafebook
                    </span>
                    <span class="status-delivery @statusClass">
                        @statusText
                    </span>
                </div>

                <a asp-page="/Account/LichSuDonHangDetailView" asp-route-id="@order.IdHoaDon" class="order-items-link">
                    <div class="order-items-container">
                        @foreach (var item in order.Items)
                        {
                            var imgUrl = item.HinhAnhUrl ?? "/images/default-food-icon.png";
                            <div class="order-item">
                                <div class="order-item-img">
                                    <img src="@imgUrl" alt="@item.TenSanPham" />
                                </div>
                                <div class="order-item-info">
                                    <h6>@item.TenSanPham</h6>
                                    <div class="qty">x @item.SoLuong</div>
                                </div>
                                <div class="order-item-price">
                                    @item.DonGia.ToString("N0") đ
                                </div>
                            </div>
                        }
                    </div>
                </a>

                <div class="order-card-footer">
                    <span class="me-2">Thành tiền:</span>
                    <span class="order-total-amount">@order.ThanhTien.ToString("N0") đ</span>
                </div>

                <div class="order-card-actions">
                    <a asp-page="/HoTroView" class="btn btn-outline-secondary btn-sm">
                        <span class="material-symbols-outlined" style="font-size: 1rem; vertical-align: middle;">support_agent</span>
                        Liên Hệ Shop
                    </a>

                    @if (order.TrangThaiGiaoHang == "Chờ xác nhận" && order.TrangThaiThanhToan != "Đã hủy")
                    {
                        <button class="btn btn-outline-danger btn-sm" disabled>Hủy Đơn (Sắp có)</button>
                    }

                    @if (order.TrangThaiGiaoHang == "Hoàn thành")
                    {
                        <button class="btn btn-outline-secondary btn-sm" disabled>Mua Lại (Sắp có)</button>

                        <a asp-page="./DanhGiaView"
                           asp-route-idHoaDon="@order.IdHoaDon"
                           class="btn btn-primary btn-sm mx-1">
                            ĐÁNH GIÁ
                        </a>
                    }

                    <a asp-page="/Account/LichSuDonHangDetailView" asp-route-id="@order.IdHoaDon" class="btn btn-outline-primary btn-sm ms-auto">Xem Chi Tiết</a>
                </div>
            </div>
        }
    }
</div>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\LichSuDonHangView.cshtml.cs
================================================================================
﻿// TẠO TỆP MỚI: WebCafebookApi/Pages/Account/LichSuDonHangView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Security.Claims;
using System.Threading.Tasks;

namespace WebCafebookApi.Pages.Account
{
    [Authorize(Roles = "KhachHang")]
    public class LichSuDonHangViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        public List<LichSuDonHangWebDto> AllOrders { get; set; } = new List<LichSuDonHangWebDto>();
        public List<LichSuDonHangWebDto> FilteredOrders { get; set; } = new List<LichSuDonHangWebDto>();

        [TempData]
        public string? ErrorMessage { get; set; }

        [BindProperty(SupportsGet = true)]
        public string StatusFilter { get; set; } = "Tất cả";

        // Mảng này để render các tab
        public string[] StatusTabs { get; set; } = {
            "Tất cả", "Chờ xác nhận", "Chờ lấy hàng",
            "Đang giao", "Hoàn thành", "Đã Hủy" 
            // "Trả Hàng" sẽ được thêm khi có nghiệp vụ
        };

        public LichSuDonHangViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        public async Task<IActionResult> OnGetAsync()
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId)) return Challenge();

            var httpClient = _httpClientFactory.CreateClient("ApiClient");
            try
            {
                var response = await httpClient.GetFromJsonAsync<List<LichSuDonHangWebDto>>($"/api/web/profile/order-history/{userId}");
                if (response != null)
                {
                    AllOrders = response;
                }

                // Lọc danh sách đơn hàng dựa trên tab
                FilterOrders();
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Lỗi tải lịch sử đơn hàng: {ex.Message}";
            }
            return Page();
        }

        private void FilterOrders()
        {
            if (StatusFilter == "Tất cả")
            {
                FilteredOrders = AllOrders;
                return;
            }

            if (StatusFilter == "Đã Hủy")
            {
                // Đã hủy là trạng thái thanh toán
                FilteredOrders = AllOrders.Where(o => o.TrangThaiThanhToan == "Đã hủy").ToList();
            }
            else
            {
                // Các trạng thái còn lại là TrangThaiGiaoHang
                // (Và phải đảm bảo đơn đó chưa bị hủy)
                FilteredOrders = AllOrders.Where(o =>
                    o.TrangThaiGiaoHang == StatusFilter &&
                    o.TrangThaiThanhToan != "Đã hủy")
                    .ToList();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\LichSuThueSachView.cshtml
================================================================================
﻿@page "/Account/LichSuThueSachView"
@model WebCafebookApi.Pages.Account.LichSuThueSachViewModel
@{
    ViewData["Title"] = "Lịch sử thuê sách";
    Layout = "_Layout_Account"; // Sử dụng layout tài khoản [cite: 35]
}

<h3 class="page-title-account">@ViewData["Title"]</h3>
<p class="page-lead-account">Theo dõi các phiếu thuê sách và chi phí của bạn.</p>

<hr class="my-4" />

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

@if (Model.Rentals == null || !Model.Rentals.Any())
{
    <div class="alert alert-info">
        Bạn chưa có lịch sử thuê sách nào.
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th scope="col">Mã Phiếu</th>
                    <th scope="col">Ngày Thuê</th>
                    <th scope="col">Trạng Thái</th>
                    <th scope="col">SL Sách</th>
                    <th scope="col">Tiền Cọc</th>
                    <th scope="col">Phí Thuê</th>
                    <th scope="col">Tiền Phạt</th>
                    <th scope="col">Cọc Hoàn</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Rentals)
                {
                    <tr>
                        <td class="fw-bold">#@item.IdPhieuThueSach</td>
                        <td>@item.NgayThue.ToString("dd/MM/yyyy")</td>
                        <td>
                            <span class="badge @GetBadgeClass(item.TrangThai)">
                                @item.TrangThai
                            </span>
                        </td>
                        <td>@item.SoLuongSach</td>
                        <td>@item.TongTienCoc.ToString("N0") đ</td>

                        @if (item.NgayTra.HasValue)
                        {
                            <td class="text-danger">@item.TongPhiThue?.ToString("N0") đ</td>
                            <td class="text-danger fw-bold">@item.TongTienPhat?.ToString("N0") đ</td>
                            <td class="text-success">@item.TongTienCocHoan?.ToString("N0") đ</td>
                        }
                        else
                        {
                            <td colspan="3" class="text-muted text-center small"><em>(Chưa trả)</em></td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@functions {
    private string GetBadgeClass(string trangThai)
    {
        return trangThai.ToLower() switch
        {
            "đang thuê" => "bg-primary",
            "đã trả" => "bg-success",
            "đã hủy" => "bg-danger",
            _ => "bg-secondary",
        };
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\LichSuThueSachView.cshtml.cs
================================================================================
// T?p tin: WebCafebookApi/Pages/Account/LichSuThueSachView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Collections.Generic;
using System.Net.Http;
using System.Net.Http.Json;
using System.Security.Claims;
using System.Threading.Tasks;

namespace WebCafebookApi.Pages.Account
{
    [Authorize(Roles = "KhachHang")]
    public class LichSuThueSachViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        public List<LichSuPhieuThueDto> Rentals { get; set; } = new List<LichSuPhieuThueDto>();

        [TempData]
        public string? ErrorMessage { get; set; }

        public LichSuThueSachViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        private int GetCurrentUserId()
        {
            var userIdClaim = User.FindFirstValue(ClaimTypes.NameIdentifier);
            int.TryParse(userIdClaim, out int userId);
            return userId;
        }

        public async Task<IActionResult> OnGetAsync()
        {
            var userId = GetCurrentUserId();
            if (userId == 0) return Challenge();

            var httpClient = _httpClientFactory.CreateClient();
            try
            {
                var response = await httpClient.GetAsync($"http://localhost:5166/api/web/profile/rental-history/{userId}");
                if (response.IsSuccessStatusCode)
                {
                    Rentals = await response.Content.ReadFromJsonAsync<List<LichSuPhieuThueDto>>() ?? new List<LichSuPhieuThueDto>();
                }
                else
                {
                    ErrorMessage = "Không th? t?i l?ch s? thuê sách.";
                }
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"L?i k?t n?i: {ex.Message}";
            }

            return Page();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\QuenMatKhauView.cshtml
================================================================================
﻿@page "/Account/ForgotPassword"
@* SỬA: Namespace *@
@model WebCafebookApi.Pages.Account.QuenMatKhauViewModel
@{
    ViewData["Title"] = "Quên Mật Khẩu";
    Layout = null; // Dùng layout login
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Cafebook</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body class="login-page-body">

    <div class="login-wrapper">
        <div class="login-container">
            <div class="login-brand-col d-none d-md-flex">
                <img src="/images/logo.png" alt="Cafebook Logo">
                <h1 class="mb-2">Cafebook</h1>
                <p class="fs-5 opacity-75">Khôi phục tài khoản</p>
            </div>

            <div class="login-form-col">
                <a asp-page="/Account/DangNhapView" class="text-decoration-none mb-3" style="align-self: flex-start;">
                    <span class="material-symbols-outlined" style="vertical-align: middle;">arrow_back</span>
                    Về trang Đăng nhập
                </a>

                <h2>@ViewData["Title"]</h2>
                <p class="text-muted">Nhập email của bạn để nhận mã xác nhận.</p>

                <form method="post">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-2" role="alert"></div>

                    <div class="form-floating-material">
                        <input asp-for="Input.Email" class="form-control" autocomplete="email" aria-required="true" placeholder=" " />
                        <label asp-for="Input.Email" class="form-label">Email</label>
                        <span class="material-symbols-outlined">mail</span>
                        <span asp-validation-for="Input.Email" class="text-danger small"></span>
                    </div>

                    <button type="submit" class="w-100 btn btn-lg btn-primary mt-3">Gửi Mã Xác Nhận</button>
                </form>
            </div>
        </div>
    </div>

    <partial name="_ValidationScriptsPartial" />
</body>
</html>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\QuenMatKhauView.cshtml.cs
================================================================================
﻿using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.ComponentModel.DataAnnotations;
using System.Threading.Tasks;
using WebCafebookApi.Services; // SỬA: Namespace
using Microsoft.Extensions.Caching.Memory;
using System;
using System.Net.Http; // <-- THÊM
using System.Net.Http.Json; // <-- THÊM
using CafebookModel.Model.ModelWeb; // <-- THÊM

namespace WebCafebookApi.Pages.Account // SỬA: Namespace
{
    public class QuenMatKhauViewModel : PageModel
    {
        private readonly EmailService _emailService;
        private readonly IHttpClientFactory _httpClientFactory; // <-- SỬA
        private readonly IMemoryCache _cache;
        private readonly Random _random = new Random();

        public QuenMatKhauViewModel(EmailService emailService, IHttpClientFactory httpClientFactory, IMemoryCache cache)
        {
            _emailService = emailService;
            _httpClientFactory = httpClientFactory; // <-- SỬA
            _cache = cache;
        }

        [BindProperty]
        public InputModel Input { get; set; } = new InputModel();

        [TempData]
        public string? StatusMessage { get; set; }

        public class InputModel
        {
            [Required(ErrorMessage = "Vui lòng nhập email.")]
            [EmailAddress(ErrorMessage = "Định dạng email không hợp lệ.")]
            public string Email { get; set; } = string.Empty;
        }

        public void OnGet() { }

        public async Task<IActionResult> OnPostAsync()
        {
            if (!ModelState.IsValid)
            {
                return Page();
            }

            var httpClient = _httpClientFactory.CreateClient();

            // 1. SỬA: Kiểm tra Email có tồn tại và hợp lệ không
            try
            {
                var checkEmail = new CheckEmailRequestDto { Email = Input.Email };
                var apiResponse = await httpClient.PostAsJsonAsync("http://localhost:5166/api/web/password/check-email", checkEmail);

                if (!apiResponse.IsSuccessStatusCode)
                {
                    var error = await apiResponse.Content.ReadFromJsonAsync<ApiErrorResponse>();
                    ModelState.AddModelError(string.Empty, error?.Message ?? "Email không tồn tại hoặc tài khoản bị khóa.");
                    return Page();
                }
            }
            catch (Exception ex)
            {
                ModelState.AddModelError(string.Empty, $"Lỗi kết nối API: {ex.Message}");
                return Page();
            }

            // 2. Tạo mã xác nhận
            string verificationCode = _random.Next(100000, 999999).ToString("D6");

            // 3. Lưu mã vào Cache
            string cacheKey = $"ForgotPassword_{Input.Email}";
            var cacheEntryOptions = new MemoryCacheEntryOptions()
                .SetAbsoluteExpiration(TimeSpan.FromMinutes(5));
            _cache.Set(cacheKey, verificationCode, cacheEntryOptions);

            // 4. Gửi email
            try
            {
                await _emailService.SendVerificationCodeAsync(Input.Email, verificationCode);

                // 5. Chuyển hướng
                TempData["VerificationEmail"] = Input.Email;
                return RedirectToPage("./XacNhanMaView");
            }
            catch (Exception ex)
            {
                ModelState.AddModelError(string.Empty, $"Không thể gửi email. Lỗi: {ex.Message}");
                return Page();
            }
        }

        private class ApiErrorResponse { public string? Message { get; set; } }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\TaiKhoanTongQuanView.cshtml
================================================================================
﻿@page "/Account/TaiKhoanTongQuanView"
@model WebCafebookApi.Pages.Account.TaiKhoanTongQuanViewModel
@{
    ViewData["Title"] = "Tài khoản của tôi";
    Layout = "_Layout_Account"; // Sử dụng layout tài khoản
}

<h3 class="page-title-account">Chào mừng, @Model.HoTen!</h3>
<p class="page-lead-account">Đây là trang tổng quan tài khoản của bạn.</p>

<hr class="my-4" />

<h5 class="mb-3">Thành viên Cafebook</h5>
<div class="row g-4">
    <div class="col-md-6">
        <div class="card overview-card h-100">
            <div class="card-body">
                <div class="overview-card-icon" style="color: var(--cf-orange);">
                    <span class="material-symbols-outlined">stars</span>
                </div>
                <h6 class="text-muted mb-1">Điểm tích lũy</h6>
                <h2 class="fw-bold">@Model.Overview.DiemTichLuy</h2>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card overview-card h-100">
            <div class="card-body">
                <div class="overview-card-icon">
                    <span class="material-symbols-outlined">calendar_month</span>
                </div>
                <h6 class="text-muted mb-1">Ngày tham gia</h6>
                <h2 class="fw-bold">@Model.Overview.NgayTao.ToString("dd/MM/yyyy")</h2>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card overview-card h-100">
            <div class="card-body">
                <div class="overview-card-icon">
                    <span class="material-symbols-outlined">receipt_long</span>
                </div>
                <h6 class="text-muted mb-1">Tổng số hóa đơn</h6>
                <h2 class="fw-bold">@Model.Overview.TongHoaDon</h2>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card overview-card h-100">
            <div class="card-body">
                <div class="overview-card-icon">
                    <span class="material-symbols-outlined">payments</span>
                </div>
                <h6 class="text-muted mb-1">Tổng chi tiêu</h6>
                <h2 class="fw-bold">@Model.Overview.TongChiTieu.ToString("N0") đ</h2>
            </div>
        </div>
    </div>
</div>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\TaiKhoanTongQuanView.cshtml.cs
================================================================================
﻿using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Json;
using System.Security.Claims;
using System.Threading.Tasks;

namespace WebCafebookApi.Pages.Account
{
    [Authorize(Roles = "KhachHang")]
    public class TaiKhoanTongQuanViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        public KhachHangTongQuanDto Overview { get; set; } = new();
        public string HoTen { get; set; } = string.Empty;

        public TaiKhoanTongQuanViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        private int GetCurrentUserId()
        {
            var userIdClaim = User.FindFirstValue(ClaimTypes.NameIdentifier);
            int.TryParse(userIdClaim, out int userId);
            return userId;
        }

        public async Task<IActionResult> OnGetAsync()
        {
            // SỬA LỖI CS0103: Xóa dòng "Layout = ..." ở đây.
            // Layout đã được gán trong file .cshtml
            var userId = GetCurrentUserId();
            if (userId == 0) return Challenge();

            HoTen = User.FindFirstValue(ClaimTypes.GivenName) ?? "Khách hàng";

            var httpClient = _httpClientFactory.CreateClient();
            try
            {
                var result = await httpClient.GetFromJsonAsync<KhachHangTongQuanDto>($"http://localhost:5166/api/web/profile/overview/{userId}");
                if (result != null)
                {
                    Overview = result;
                }
                return Page();
            }
            catch (System.Exception)
            {
                return Page();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\ThanhToanThanhCongView.cshtml
================================================================================
﻿@page "/Account/ThanhToanThanhCong/{id:int}"
@model WebCafebookApi.Pages.Account.ThanhToanThanhCongViewModel
@{
    ViewData["Title"] = "Đặt hàng thành công";
    Layout = "_Layout"; // Dùng layout chính
}

<div class="container mt-5">
    <div class="main-content-card">
        <div class="text-center" style="padding: 40px 20px;">

            @if (Model.ErrorMessage != null)
            {
                <span class="material-symbols-outlined text-danger" style="font-size: 60px;">error</span>
                <h1 class="display-5 fw-bold mt-3">Đã có lỗi xảy ra</h1>
                <p class="lead">@Model.ErrorMessage</p>
                <a asp-page="/GioHangView" class="btn btn-outline-primary mt-3">Quay lại giỏ hàng</a>
            }
            else if (Model.HoaDon != null)
            {
                <span class="material-symbols-outlined text-success" style="font-size: 60px;">task_alt</span>
                <h1 class="display-5 fw-bold mt-3">Đặt hàng thành công!</h1>
                <p class="lead text-muted">
                    Cảm ơn bạn đã đặt hàng.
                    Đơn hàng của bạn <strong>#@Model.HoaDon.IdHoaDonMoi</strong> đã được ghi nhận.
                </p>
                <p>Nhân viên của chúng tôi sẽ gọi điện xác nhận đơn hàng đến SĐT <strong>@Model.HoaDon.SoDienThoai</strong> trong thời gian sớm nhất.</p>

                <hr class="my-4" />

                <div class="row justify-content-center">
                    <div class="col-lg-8 text-start">
                        <h5 class="mb-3">Tóm tắt đơn hàng</h5>
                        <ul class="list-group mb-3">
                            @foreach (var item in Model.HoaDon.Items)
                            {
                                <li class="list-group-item d-flex justify-content-between lh-sm">
                                    <div>
                                        <h6 class="my-0">@item.TenHienThi</h6>
                                        <small class="text-muted">Số lượng: @item.SoLuong</small>
                                    </div>
                                    <span class="text-muted">@item.ThanhTien.ToString("N0") đ</span>
                                </li>
                            }
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Tiền hàng</span>
                                <strong>@Model.HoaDon.TongTienHang.ToString("N0") đ</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between text-danger">
                                <span>Giảm giá (KM + Điểm)</span>
                                <span>-@Model.HoaDon.GiamGia.ToString("N0") đ</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between fs-5">
                                <strong>Tổng cộng</strong>
                                <strong>@Model.HoaDon.ThanhTien.ToString("N0") đ</strong>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="d-flex justify-content-center gap-2 mt-4">
                    <a asp-page="/TrangChuView" class="btn btn-outline-secondary">Tiếp tục mua sắm</a>
                    <a asp-page="/Account/LichSuDonHangDetailView" asp-route-id="@Model.HoaDon.IdHoaDonMoi" class="btn btn-primary">
                        Xem chi tiết đơn hàng
                    </a>
                </div>
            }
        </div>
    </div>
</div>

@section Styles {
    <style>
        .page-title-account {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--cf-dark-brown);
        }

        .page-lead-account {
            font-size: 1.1rem;
            color: var(--cf-text);
            margin-bottom: 0;
        }
    </style>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\ThanhToanThanhCongView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/Account/ThanhToanThanhCongView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;

namespace WebCafebookApi.Pages.Account
{
    [Authorize(Roles = "KhachHang")]
    public class ThanhToanThanhCongViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        public ThanhToanThanhCongViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        [BindProperty(SupportsGet = true)]
        public int Id { get; set; } // Đây là IdHoaDon

        public ThanhToanThanhCongDto? HoaDon { get; set; }
        public string? ErrorMessage { get; set; }

        public async Task<IActionResult> OnGetAsync()
        {
            if (Id == 0)
            {
                ErrorMessage = "Không tìm thấy mã đơn hàng.";
                return Page();
            }

            var httpClient = _httpClientFactory.CreateClient("ApiClient");
            try
            {
                // Gọi API mới để lấy tóm tắt đơn hàng
                HoaDon = await httpClient.GetFromJsonAsync<ThanhToanThanhCongDto>($"api/web/thanhtoan/order-summary/{Id}");
                if (HoaDon == null)
                {
                    ErrorMessage = "Không thể tải thông tin đơn hàng.";
                }
            }
            catch (System.Exception ex)
            {
                // Lỗi 401 (Unauthorized) hoặc 404 (NotFound) cũng sẽ bị bắt ở đây
                ErrorMessage = $"Bạn không có quyền xem đơn hàng này hoặc đơn hàng không tồn tại. ({ex.Message})";
            }

            return Page();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\ThanhToanView.cshtml
================================================================================
﻿@page "/Account/ThanhToanView"
@model WebCafebookApi.Pages.Account.ThanhToanViewModel
@using System.Globalization
@{
    ViewData["Title"] = "Thanh Toán";
    Layout = "_Layout";
}

<div class="container mt-5">
    <div class="main-content-card">

        <h3 class="page-title-account">@ViewData["Title"]</h3>
        <p class="page-lead-account">Hoàn tất thông tin để đặt hàng (Chỉ áp dụng cho Thức uống/Món).</p>

        <hr class="my-4" />
        
        @* (Phần Form Input và Hóa đơn giữ nguyên) *@
        @if (!string.IsNullOrEmpty(Model.SuccessMessage))
        {
            <div class="alert alert-success">@Model.SuccessMessage</div>
        }
        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="alert alert-danger">@Model.ErrorMessage</div>
        }
        
        <form method="post">
            <div class="row g-5">
                
                <div class="col-lg-7">
                    <h4 class="mb-3">Thông tin giao hàng</h4>
                    
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3" role="alert"></div>

                    <div class="row g-3">
                        <div class="col-12">
                            <div class="material-input-group">
                                <label asp-for="Input.HoTen" class="form-label fw-bold"></label>
                                <input asp-for="Input.HoTen" class="material-input" />
                                <span asp-validation-for="Input.HoTen" class="text-danger small"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="material-input-group">
                                <label asp-for="Input.SoDienThoai" class="form-label fw-bold"></label>
                                <input asp-for="Input.SoDienThoai" class="material-input" />
                                <span asp-validation-for="Input.SoDienThoai" class="text-danger small"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="material-input-group">
                                <label asp-for="Input.Email" class="form-label fw-bold"></label>
                                <input asp-for="Input.Email" class="material-input" />
                                <span asp-validation-for="Input.Email" class="text-danger small"></span>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="material-input-group">
                                <label asp-for="Input.DiaChiGiaoHang" class="form-label fw-bold">Địa chỉ giao hàng</label>
                                <input asp-for="Input.DiaChiGiaoHang" class="material-input" placeholder="Số nhà, đường, phường/xã, quận/huyện..." />
                                <span asp-validation-for="Input.DiaChiGiaoHang" class="text-danger small"></span>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="material-input-group">
                                <label asp-for="Input.GhiChu" class="form-label fw-bold">Ghi chú (Không bắt buộc)</label>
                                <textarea asp-for="Input.GhiChu" class="material-input" rows="3" placeholder="Yêu cầu thêm (ít đường, nhiều đá...)"></textarea>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <h4 class="mb-3">Phương thức thanh toán</h4>
                    <div class="my-3">
                        <div class="form-check">
                            <input asp-for="Input.PhuongThucThanhToan" type="radio" value="COD" class="form-check-input" checked />
                            <label class="form-check-label" for="Input_PhuongThucThanhToan_COD">
                                Thanh toán khi nhận hàng (COD)
                            </label>
                        </div>
                        <div class="form-check">
                            <input asp-for="Input.PhuongThucThanhToan" type="radio" value="ChuyenKhoan" class="form-check-input" />
                            <label class="form-check-label" for="Input_PhuongThucThanhToan_ChuyenKhoan">
                                Chuyển khoản (Chúng tôi sẽ gọi xác nhận)
                            </label>
                        </div>
                    </div>
                    <span asp-validation-for="Input.PhuongThucThanhToan" class="text-danger small"></span>
                </div>

                <div class="col-lg-5">
                    <div class="card sticky-top" style="top: 20px;">
                        <div class="card-body">
                            <h4 class="d-flex justify-content-between align-items-center mb-3">
                                <span class="text-primary">Đơn hàng của bạn</span>
                                <span class="badge bg-primary rounded-pill">@Model.PageData.SanPhamItems.Count</span>
                            </h4>

                            <ul class="list-group mb-3">
                                @foreach (var item in Model.PageData.SanPhamItems)
                                {
                                    <li class="list-group-item d-flex justify-content-between lh-sm">
                                        <div>
                                            <h6 class="my-0">@item.TenHienThi</h6>
                                            <small class="text-muted">Số lượng: @item.SoLuong</small>
                                        </div>
                                        <span class="text-muted">@item.ThanhTien.ToString("N0") đ</span>
                                    </li>
                                }
                                
                                <li class="list-group-item d-flex justify-content-between lh-sm">
                                    <h6 class="my-0">Tiền hàng</h6>
                                    <strong>@Model.PageData.TongTienHang.ToString("N0") đ</strong>
                                </li>
                                <li class="list-group-item d-flex justify-content-between lh-sm">
                                    <div>
                                        <h6 class="my-0">Khuyến mãi</h6>
                                        <small class="text-muted" id="selected-promo-name">-- Chưa áp dụng --</small>
                                        <input type="hidden" asp-for="Input.IdKhuyenMai" id="selected-promo-id" value="" />
                                    </div>
                                    <button type="button" class="btn btn-link btn-sm p-0" data-bs-toggle="modal" data-bs-target="#promoModal" id="btn-chon-km">
                                        Chọn mã
                                    </button>
                                </li>
                                <li class="list-group-item d-flex justify-content-between text-success">
                                    <span>Giảm giá (KM)</span>
                                    <span id="discount-amount">- 0 đ</span>
                                </li>
                                
                                <li class="list-group-item d-flex justify-content-between lh-sm">
                                    <div>
                                        <h6 class="my-0">Dùng điểm tích lũy</h6>
                                        <small class="text-muted">Bạn có: @Model.PageData.KhachHang.DiemTichLuy điểm</small>
                                        <div class="input-group input-group-sm mt-1" style="max-width: 150px;">
                                            <input asp-for="Input.DiemSuDung" type="number" class="form-control" value="0" min="0" max="@Model.PageData.KhachHang.DiemTichLuy" id="Input_DiemSuDung" />
                                            <span class="input-group-text">điểm</span>
                                        </div>
                                    </div>
                                </li>
                                <li class="list-group-item d-flex justify-content-between text-info">
                                    <span>Giảm giá (Điểm)</span>
                                    <span id="point-discount-amount">- 0 đ</span>
                                </li>

                                <li class="list-group-item d-flex justify-content-between">
                                    <span>Tổng (VND)</span>
                                    <strong id="total-amount" class="fs-5">@Model.PageData.TongTienHang.ToString("N0") đ</strong>
                                </li>
                            </ul>

                            <button type="submit" class="w-100 btn btn-primary btn-lg">
                                Xác nhận Đặt Hàng
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="promoModal" tabindex="-1" aria-labelledby="promoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="promoModalLabel">Chọn Khuyến Mãi Áp Dụng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="list-group-item list-group-item-action promo-item-modal active" data-id="0">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">-- Không áp dụng --</h6>
                        <span class="badge bg-success">Có thể áp dụng</span>
                    </div>
                    <p class="mb-1 small text-muted">Chọn mục này để gỡ bỏ khuyến mãi hiện tại.</p>
                </div>
                
                @foreach (var promo in Model.PageData.KhuyenMaisHopLe)
                {
                    <div class="list-group-item list-group-item-action promo-item-modal" 
                         data-id="@promo.IdKhuyenMai"
                         data-loai="@promo.LoaiGiamGia"
                         data-giatri="@promo.GiaTriGiam.ToString(CultureInfo.InvariantCulture)"
                         data-giamtoida="@((promo.GiamToiDa ?? 0).ToString(CultureInfo.InvariantCulture))"
                         data-idspapdung="@(promo.IdSanPhamApDung ?? 0)"
                         data-hdttoithieu="@((promo.HoaDonToiThieu ?? 0).ToString(CultureInfo.InvariantCulture))"
                         
                         data-ngaytrongtuan="@(promo.NgayTrongTuan ?? "")"
                         data-giobatdau="@(promo.GioBatDau?.ToString(@"hh\:mm") ?? "")"
                         data-gioketthuc="@(promo.GioKetThuc?.ToString(@"hh\:mm") ?? "")">

                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1 promo-title">@promo.TenChuongTrinh (@promo.MaKhuyenMai)</h6>
                            <span class="badge promo-status"></span>
                        </div>
                        <p class="mb-1 small text-muted promo-description">@promo.DieuKienApDung</p>
                        <small class="text-danger promo-reason"></small>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="btnApplyPromo">Áp dụng</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // 1. Dữ liệu từ Backend
        const subtotal = @Model.PageData.TongTienHang.ToString(CultureInfo.InvariantCulture);
        const tiLeDoiDiem = @Model.PageData.TiLeDoiDiemVND.ToString(CultureInfo.InvariantCulture);
        const maxPoints = @Model.PageData.KhachHang.DiemTichLuy;
        
        const cartItems = {
        @foreach (var item in Model.PageData.SanPhamItems)
        {
            @Html.Raw($"'{item.Id}': {item.ThanhTien.ToString(CultureInfo.InvariantCulture)},")
        }
        };

        // Biến toàn cục lưu trữ KM đã chọn
        let selectedPromo = {
            id: 0,
            name: "-- Chưa áp dụng --",
            discount: 0
        };

        // 2. DOM Elements
        const $diemInput = $('#Input_DiemSuDung');
        const $promoModal = $('#promoModal');
        const $promoAmountText = $('#discount-amount');
        const $diemAmountText = $('#point-discount-amount');
        const $totalAmountText = $('#total-amount');
        const $selectedPromoIdInput = $('#selected-promo-id');
        const $selectedPromoNameText = $('#selected-promo-name');
        const $btnChonKmTrigger = $('#btn-chon-km'); 

        // =======================================
        // === THÊM MỚI: HÀM HELPER THỜI GIAN ===
        // =======================================
        function getCurrentTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        function getCurrentDayOfWeek() {
            const days = ["Chủ nhật", "Thứ 2", "Thứ 3", "Thứ 4", "Thứ 5", "Thứ 6", "Thứ 7"];
            const now = new Date();
            return days[now.getDay()];
        }

        // 3. Hàm kiểm tra điều kiện KM (ĐÃ NÂNG CẤP)
        function checkEligibility(promoData) {
            const minSpend = parseFloat(promoData.hdttoithieu); 
            const idSpApDung = parseInt(promoData.idspapdung);

            // === YÊU CẦU MỚI: KIỂM TRA THỜI GIAN ===
            const ngayTrongTuan = promoData.ngaytrongtuan; // "Thứ 2, Thứ 3"
            const gioBatDau = promoData.giobatdau;       // "14:00"
            const gioKetThuc = promoData.gioketthuc;     // "16:00"

            if (gioBatDau && gioKetThuc) {
                const currentTime = getCurrentTime();
                if (currentTime < gioBatDau || currentTime > gioKetThuc) {
                    return { eligible: false, reason: `Chỉ áp dụng trong khung giờ ${gioBatDau} - ${gioKetThuc}.` };
                }
            }
            if (ngayTrongTuan) {
                const currentDay = getCurrentDayOfWeek(); // "Thứ 5"
                if (!ngayTrongTuan.includes(currentDay)) {
                    return { eligible: false, reason: `Chỉ áp dụng vào các ngày: ${ngayTrongTuan}.` };
                }
            }
            // === KẾT THÚC LOGIC MỚI ===

            if (minSpend > 0 && subtotal < minSpend) {
                return { eligible: false, reason: `Cần hóa đơn tối thiểu ${minSpend.toLocaleString('vi-VN')} đ.` };
            }

            if (idSpApDung > 0 && !cartItems.hasOwnProperty(idSpApDung)) {
                return { eligible: false, reason: "Khuyến mãi này chỉ áp dụng cho một số sản phẩm nhất định (hiện không có trong giỏ)." };
            }

            // Nếu qua hết, tính toán giảm giá
            let subtotalForPromo = subtotal;
            if (idSpApDung > 0) {
                subtotalForPromo = cartItems[idSpApDung] || 0;
            }

            let discount = 0;
            const loai = promoData.loai;
            const giaTri = parseFloat(promoData.giatri);
            const giamToiDa = parseFloat(promoData.giamtoida);

            if (loai.toLowerCase() === 'phantram') {
                discount = subtotalForPromo * (giaTri / 100);
                if (giamToiDa > 0 && discount > giamToiDa) {
                    discount = giamToiDa;
                }
            } else { // SoTien
                discount = giaTri;
            }
            
            discount = Math.min(discount, subtotalForPromo);
            return { eligible: true, reason: null, discount: discount };
        }

        // 4. Hàm cập nhật tổng tiền (ĐÃ SỬA LỖI 50%)
        function updateTotal() {
            // 4.1. Lấy giá trị khuyến mãi (KM)
            const promoDiscount = selectedPromo.discount;
            $promoAmountText.text('- ' + promoDiscount.toLocaleString('vi-VN') + ' đ');
            $selectedPromoNameText.text(selectedPromo.name);
            $btnChonKmTrigger.text(selectedPromo.name); 
            $selectedPromoIdInput.val(selectedPromo.id);

            // 4.2. Lấy giá trị điểm và validate
            let points = parseInt($diemInput.val()) || 0;
            if (points < 0) { points = 0; }
            if (points > maxPoints) { points = maxPoints; $diemInput.val(maxPoints); }
            
            let pointDiscount = points * tiLeDoiDiem;
            const totalAfterPromo = subtotal - promoDiscount; 

            // Logic 50%
            const maxAllowedPointDiscount = totalAfterPromo * 0.5; 
            
            if (pointDiscount > maxAllowedPointDiscount) {
                pointDiscount = maxAllowedPointDiscount;
                let pointsUsed = Math.ceil(pointDiscount / tiLeDoiDiem); 
                if (pointsUsed > maxPoints) { pointsUsed = maxPoints; } 
                
                if (parseInt($diemInput.val()) !== pointsUsed) {
                    $diemInput.val(pointsUsed);
                }
                points = pointsUsed;
            }

            $diemAmountText.text('- ' + pointDiscount.toLocaleString('vi-VN') + ' đ');

            // 4.3. Tính tổng cuối cùng
            let total = subtotal - promoDiscount - pointDiscount; 
            if (total < 0) total = 0;

            $totalAmountText.text(total.toLocaleString('vi-VN') + ' đ');
        }

        // 5. Sự kiện khi mở Modal (Đã sửa)
        $promoModal.on('show.bs.modal', function () {
            const currentPromoId = selectedPromo.id; 

            $('.promo-item-modal').each(function() {
                const $item = $(this);
                const id = parseInt($item.data('id'));
                
                $item.removeClass('active');
                if (id === currentPromoId) {
                    $item.addClass('active'); 
                }

                if (id === 0) return; 

                const promoData = $item.data();
                const result = checkEligibility(promoData);

                const $status = $item.find('.promo-status');
                const $reason = $item.find('.promo-reason');

                if (result.eligible) {
                    $item.removeClass('disabled-promo');
                    $status.text('Có thể áp dụng').removeClass('bg-danger').addClass('bg-success');
                    $reason.text('');
                } else {
                    $item.addClass('disabled-promo');
                    $status.text('Không hợp lệ').removeClass('bg-success').addClass('bg-danger');
                    $reason.text(result.reason);
                }
            });
        });

        // 6. Sự kiện khi click CHỌN 1 KM (Chỉ highlight)
        $('.promo-item-modal').on('click', function() {
            const $item = $(this);
            if ($item.hasClass('disabled-promo')) {
                return; 
            }
            $('.promo-item-modal').removeClass('active');
            $item.addClass('active');
        });

        // 7. SỰ KIỆN MỚI: Khi nhấn nút "Áp dụng"
        $('#btnApplyPromo').on('click', function() {
            const $item = $('.promo-item-modal.active');
            
            if ($item.length === 0) {
                selectedPromo = { id: 0, name: "Chọn mã", discount: 0 };
            } else {
                const id = parseInt($item.data('id'));
                
                if (id === 0) {
                    selectedPromo = { id: 0, name: "Chọn mã", discount: 0 };
                } else {
                    const promoData = $item.data();
                    const result = checkEligibility(promoData); 
                    selectedPromo = {
                        id: id,
                        name: $item.find('.promo-title').text(),
                        discount: result.discount
                    };
                }
            }
            
            updateTotal(); 
            $promoModal.modal('hide'); 
        });

        // 8. Sự kiện khi nhập điểm (Giữ nguyên)
        $diemInput.on('input', updateTotal);
        
        // Chạy lần đầu khi tải trang
        updateTotal();
    </script>
}

@section Styles {
    <style>
        .page-title-account {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--cf-dark-brown);
        }
        .page-lead-account {
            font-size: 1.1rem;
            color: var(--cf-text);
            margin-bottom: 0;
        }
        .material-input-group {
            margin-bottom: 1.5rem !important;
        }
        .promo-item-modal {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .promo-item-modal:hover {
            background-color: #f8f9fa;
        }
        .promo-item-modal.disabled-promo {
            cursor: not-allowed;
            background-color: #f8f8f8;
            opacity: 0.7;
        }
        .promo-item-modal.disabled-promo .promo-title {
            color: #6c757d;
        }
        .promo-item-modal.active {
            background-color: var(--cf-cream, #FFF8E1);
            border-left: 4px solid var(--cf-orange, #D27D2D);
            font-weight: 500;
        }
        #btn-chon-km {
            text-decoration: none;
            font-weight: 500;
        }
    </style>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\ThanhToanView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/Account/ThanhToanView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http;
using System.Net.Http.Json;
using System.Security.Claims;
using System.Threading.Tasks;
using WebCafebookApi.Services;
using System.Linq;
using System.Collections.Generic;

namespace WebCafebookApi.Pages.Account
{
    [Authorize(Roles = "KhachHang")]
    public class ThanhToanViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        public ThanhToanViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        public ThanhToanLoadDto PageData { get; set; } = new();

        [BindProperty]
        public ThanhToanSubmitDto Input { get; set; } = new();

        [TempData]
        public string? SuccessMessage { get; set; }
        [TempData]
        public string? ErrorMessage { get; set; }

        private HttpClient GetApiClient()
        {
            // ApiClient (từ Program.cs) đã tự động đính kèm JWT Token
            return _httpClientFactory.CreateClient("ApiClient");
        }

        public async Task<IActionResult> OnGetAsync()
        {
            var httpClient = GetApiClient();
            try
            {
                // 1. Tải dữ liệu API (Khách hàng, Khuyến mãi, Tỷ lệ điểm)
                var loadedData = await httpClient.GetFromJsonAsync<ThanhToanLoadDto>("api/web/thanhtoan/load");

                if (loadedData == null)
                {
                    ErrorMessage = "Không thể tải dữ liệu thanh toán.";
                    return Page();
                }
                PageData = loadedData;

                // 2. Tải giỏ hàng từ SESSION (của Frontend)
                var sessionCart = HttpContext.Session.Get<List<CartItemDto>>(WebCafebookApi.Services.SessionExtensions.CartKey)
                                  ?? new List<CartItemDto>();

                // 3. Lấy thông tin chi tiết cho giỏ hàng
                var sanPhamItems = new List<GioHangItemViewModel>();
                // SỬA: Xóa List<GioHangItemViewModel> sachItems

                var publicClient = _httpClientFactory.CreateClient(); // Client không auth

                foreach (var item in sessionCart)
                {
                    // =======================================
                    // === SỬA LỖI CS1061 TẠI ĐÂY ===
                    // Xóa toàn bộ logic if/else (item.Loai), vì giỏ hàng chỉ còn IdSanPham
                    try
                    {
                        var sp = await publicClient.GetFromJsonAsync<SanPhamChiTietDto>($"http://localhost:5166/api/web/thucdon/{item.Id}");
                        if (sp != null)
                        {
                            sanPhamItems.Add(new GioHangItemViewModel
                            {
                                Id = item.Id,
                                // SỬA: Xóa 'Loai'
                                TenHienThi = sp.TenSanPham,
                                HinhAnhUrl = sp.HinhAnhUrl,
                                DonGia = sp.DonGia,
                                SoLuong = item.SoLuong
                            });
                        }
                    }
                    catch (System.Exception ex)
                    {
                        ErrorMessage = "Lỗi khi tải thông tin giỏ hàng: " + ex.Message;
                    }
                    // =======================================
                }

                // 4. Gán giỏ hàng đã xử lý vào PageData
                PageData.SanPhamItems = sanPhamItems;
                PageData.SachItems = new List<GioHangItemViewModel>(); // SỬA: Khởi tạo rỗng
                PageData.TongTienHang = sanPhamItems.Sum(i => i.ThanhTien);


                // 5. Xử lý chuyển hướng nếu giỏ hàng không hợp lệ
                // SỬA: Xóa logic kiểm tra sách
                if (PageData.SanPhamItems.Count == 0)
                {
                    return RedirectToPage("/GioHangView");
                }

                // 6. Điền thông tin mặc định cho form Input
                Input.HoTen = PageData.KhachHang.HoTen;
                Input.SoDienThoai = PageData.KhachHang.SoDienThoai;
                Input.Email = PageData.KhachHang.Email;
                Input.DiaChiGiaoHang = PageData.KhachHang.DiaChi;
                Input.PhuongThucThanhToan = "COD";
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Lỗi tải trang: {ex.Message}";
            }
            return Page();
        }

        public async Task<IActionResult> OnPostAsync()
        {
            var loadTask = OnGetAsync(); // Tải lại dữ liệu nền

            if (!ModelState.IsValid)
            {
                await loadTask;
                return Page();
            }

            var httpClient = GetApiClient();
            try
            {
                var sessionCart = HttpContext.Session.Get<List<CartItemDto>>(WebCafebookApi.Services.SessionExtensions.CartKey)
                                  ?? new List<CartItemDto>();
                Input.ItemsToPurchase = sessionCart; // Gán giỏ hàng vào DTO

                var response = await httpClient.PostAsJsonAsync("api/web/thanhtoan/submit", Input);

                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<ThanhToanResponseDto>();
                    SuccessMessage = result?.Message ?? "Đặt hàng thành công!";

                    // =======================================
                    // === SỬA LỖI CS1061 TẠI ĐÂY ===
                    // Xóa giỏ hàng hoàn toàn (thay vì lọc sách)
                    HttpContext.Session.Remove(WebCafebookApi.Services.SessionExtensions.CartKey);
                    // =======================================

                    // =======================================
                    // === YÊU CẦU MỚI: Chuyển hướng ===
                    // =======================================
                    return RedirectToPage("/Account/ThanhToanThanhCongView", new { id = result.IdHoaDonMoi });
                }
                else
                {
                    var errorResult = await response.Content.ReadFromJsonAsync<ThanhToanResponseDto>();
                    ErrorMessage = errorResult?.Message ?? "Đã xảy ra lỗi khi đặt hàng.";
                }
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Lỗi hệ thống: {ex.Message}";
            }

            await loadTask;
            return Page();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\ThongTinCaNhanView.cshtml
================================================================================
﻿@page "/Account/ThongTinCaNhanView"
@model WebCafebookApi.Pages.Account.ThongTinCaNhanViewModel
@{
    ViewData["Title"] = "Hồ sơ";
    Layout = "_Layout_Account"; // Sử dụng layout tài khoản
}

<h3 class="page-title-account">@ViewData["Title"]</h3>
<p class="page-lead-account">Quản lý thông tin hồ sơ của bạn.</p>

<hr class="my-4" />

@if (!string.IsNullOrEmpty(Model.SuccessMessage))
{
    <div class="alert alert-success">@Model.SuccessMessage</div>
}
@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

@if (Model.IsEditMode)
{
    <form method="post" enctype="multipart/form-data">
        <div class="row g-4">
            <div class="col-md-4">
                <h5 class="mb-3">Ảnh đại diện</h5>
                <div class="avatar-upload-container">
                    <img id="avatarPreview" src="@Model.AvatarHienTaiUrl" alt="Avatar" class="rounded-circle shadow-sm" />
                    <label for="avatarUploadInput" class="btn btn-outline-primary btn-sm mt-3">
                        <span class="material-symbols-outlined" style="font-size: 1rem; vertical-align: middle;">upload</span>
                        Đổi ảnh
                    </label>
                    <input type="file" asp-for="AvatarFile" id="avatarUploadInput" class="d-none" accept="image/png, image/jpeg, image/gif" />
                    <div id="avatarSizeError" class="text-danger small mt-2" style="display: none;">Lỗi: Ảnh không được vượt quá 3MB.</div>
                    <div id="avatarTypeError" class="text-danger small mt-2" style="display: none;">Lỗi: Chỉ chấp nhận file .png, .jpg, .gif.</div>
                </div>
            </div>

            <div class="col-md-8">
                <h5 class="mb-3">Thông tin hồ sơ</h5>
                <div asp-validation-summary="ModelOnly" class="text-danger mb-3" role="alert"></div>

                <div class="material-input-group mb-3">
                    <label asp-for="Input.TenDangNhap" class="form-label fw-bold">Tên đăng nhập</label>
                    @* Xóa "readonly disabled" và thay value bằng asp-for *@
                    <input asp-for="Input.TenDangNhap" class="material-input" />
                    <span asp-validation-for="Input.TenDangNhap" class="text-danger small"></span>
                </div>

                <div class="material-input-group mb-3">
                    <label asp-for="Input.HoTen" class="form-label fw-bold"></label>
                    <input asp-for="Input.HoTen" class="material-input" />
                    <span asp-validation-for="Input.HoTen" class="text-danger small"></span>
                </div>

                <div class="material-input-group mb-3">
                    <label asp-for="Input.Email" class="form-label fw-bold"></label>
                    <input asp-for="Input.Email" class="material-input" placeholder="example@gmail.com" />
                    <span asp-validation-for="Input.Email" class="text-danger small"></span>
                </div>

                <div class="material-input-group mb-3">
                    <label asp-for="Input.SoDienThoai" class="form-label fw-bold"></label>
                    <input asp-for="Input.SoDienThoai" class="material-input" placeholder="090..." />
                    <span asp-validation-for="Input.SoDienThoai" class="text-danger small"></span>
                </div>

                <div class="material-input-group mb-3">
                    <label asp-for="Input.DiaChi" class="form-label fw-bold"></label>
                    <input asp-for="Input.DiaChi" class="material-input" placeholder="Số nhà, đường, phường/xã..." />
                    <span asp-validation-for="Input.DiaChi" class="text-danger small"></span>
                </div>

                <button type="submit" class="btn btn-primary mt-3">
                    <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 4px;">save</span>
                    Lưu Thay Đổi
                </button>
                <a asp-page="/Account/ThongTinCaNhanView" class="btn btn-link text-muted mt-3">Hủy</a>
            </div>
        </div>
    </form>
}
else
{
    <div class="row g-4">
        <div class="col-md-4 text-center">
            <img src="@Model.AvatarHienTaiUrl" alt="Avatar" class="rounded-circle shadow-sm" style="width: 200px; height: 200px; object-fit: cover;" />
        </div>
        <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Thông tin hồ sơ</h5>
                <a asp-page-handler="Edit" class="btn btn-outline-primary btn-sm">
                    <span class="material-symbols-outlined" style="font-size: 1rem; vertical-align: middle;">edit</span>
                    Sửa
                </a>
            </div>

            <div class="profile-display-group">
                <label>Họ tên</label>
                <p>@Model.Input.HoTen</p>
            </div>
            <div class="profile-display-group">
                <label>Tên đăng nhập</label>
                @* Sửa "Model.TenDangNhap" thành "Model.Input.TenDangNhap" *@
                <p>@(string.IsNullOrWhiteSpace(Model.Input.TenDangNhap) ? "(Chưa cập nhật)" : Model.Input.TenDangNhap)</p>
            </div>
            <div class="profile-display-group">
                <label>Email</label>
                <p>@(string.IsNullOrWhiteSpace(Model.Input.Email) ? "(Chưa cập nhật)" : Model.Input.Email)</p>
            </div>
            <div class="profile-display-group">
                <label>Số điện thoại</label>
                <p>@(string.IsNullOrWhiteSpace(Model.Input.SoDienThoai) ? "(Chưa cập nhật)" : Model.Input.SoDienThoai)</p>
            </div>
            <div class="profile-display-group">
                <label>Địa chỉ</label>
                <p>@(string.IsNullOrWhiteSpace(Model.Input.DiaChi) ? "(Chưa cập nhật)" : Model.Input.DiaChi)</p>
            </div>
        </div>
    </div>
}


@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/profile.js" asp-append-version="true"></script>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\ThongTinCaNhanView.cshtml.cs
================================================================================
﻿using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http;
using System.Net.Http.Json;
using System.Security.Claims;
using System.Threading.Tasks;

namespace WebCafebookApi.Pages.Account
{
    [Authorize(Roles = "KhachHang")]
    public class ThongTinCaNhanViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        [BindProperty]
        public ProfileUpdateModel Input { get; set; } = new();

        [BindProperty]
        public IFormFile? AvatarFile { get; set; }

        public string TenDangNhap { get; set; } = string.Empty;
        public string AvatarHienTaiUrl { get; set; } = string.Empty;

        public bool IsEditMode { get; set; } = false;

        [TempData]
        public string? SuccessMessage { get; set; }
        [TempData]
        public string? ErrorMessage { get; set; }

        public ThongTinCaNhanViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        private int GetCurrentUserId()
        {
            var userIdClaim = User.FindFirstValue(ClaimTypes.NameIdentifier);
            int.TryParse(userIdClaim, out int userId);
            return userId;
        }

        public async Task<IActionResult> OnGetAsync(string? handler)
        {
            // SỬA LỖI CS0103: Xóa dòng "Layout = ..." ở đây.
            var userId = GetCurrentUserId();
            if (userId == 0) return Challenge();

            if (handler == "Edit")
            {
                IsEditMode = true;
            }

            var httpClient = _httpClientFactory.CreateClient();
            try
            {
                var profile = await httpClient.GetFromJsonAsync<KhachHangProfileDto>($"http://localhost:5166/api/web/profile/{userId}");
                if (profile != null)
                {
                    Input.HoTen = profile.HoTen;
                    Input.SoDienThoai = profile.SoDienThoai;
                    Input.Email = profile.Email;
                    Input.DiaChi = profile.DiaChi;
                    Input.TenDangNhap = profile.TenDangNhap ?? ""; // Gán vào Input
                    AvatarHienTaiUrl = profile.AnhDaiDienUrl ?? "/images/default-avatar.png";
                }
                return Page();
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Lỗi tải thông tin: {ex.Message}";
                return Page();
            }
        }

        public async Task<IActionResult> OnPostAsync()
        {
            var userId = GetCurrentUserId();
            if (userId == 0) return Challenge();
            if (!ModelState.IsValid)
            {
                return await OnGetAsync("Edit");
            }

            var httpClient = _httpClientFactory.CreateClient();
            using var formData = new MultipartFormDataContent();

            formData.Add(new StringContent(Input.HoTen), nameof(Input.HoTen));
            formData.Add(new StringContent(Input.SoDienThoai ?? ""), nameof(Input.SoDienThoai));
            formData.Add(new StringContent(Input.Email ?? ""), nameof(Input.Email));
            formData.Add(new StringContent(Input.DiaChi ?? ""), nameof(Input.DiaChi));

            // ==================================
            // === THÊM MỚI ===
            // ==================================
            formData.Add(new StringContent(Input.TenDangNhap), nameof(Input.TenDangNhap));
            // ==================================

            if (AvatarFile != null)
            {
                formData.Add(new StreamContent(AvatarFile.OpenReadStream()), "avatarFile", AvatarFile.FileName);
            }

            try
            {
                var response = await httpClient.PutAsync($"http://localhost:5166/api/web/profile/update-info/{userId}", formData);

                if (response.IsSuccessStatusCode)
                {
                    SuccessMessage = "Cập nhật thông tin thành công!";

                    var result = await response.Content.ReadFromJsonAsync<UpdateAvatarResponse>();
                    if (!string.IsNullOrEmpty(result?.newAvatarUrl))
                    {
                        HttpContext.Session.SetString("AvatarUrl", result.newAvatarUrl);
                    }
                    // Cập nhật claims
                    await UpdateClaims(Input.HoTen, Input.TenDangNhap);
                }
                else
                {
                    // ==================================
                    // === SỬA LẠI: Hiển thị lỗi rõ ràng ===
                    // ==================================
                    var errorBody = await response.Content.ReadAsStringAsync();
                    // Thử parse lỗi validation từ API (nếu có)
                    try
                    {
                        var errorResult = System.Text.Json.JsonSerializer.Deserialize<ValidationProblemDetails>(errorBody);
                        if (errorResult?.Errors != null)
                        {
                            foreach (var err in errorResult.Errors)
                            {
                                ModelState.AddModelError($"Input.{err.Key}", err.Value.FirstOrDefault() ?? "Lỗi không xác định");
                            }
                        }
                        else
                        {
                            ModelState.AddModelError(string.Empty, errorBody);
                        }
                    }
                    catch
                    {
                        ModelState.AddModelError(string.Empty, $"Lỗi từ API: {errorBody}");
                    }

                    AvatarHienTaiUrl = HttpContext.Session.GetString("AvatarUrl") ?? "/images/default-avatar.png";
                    IsEditMode = true;
                    return Page();
                    // ==================================
                }
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Lỗi: {ex.Message}";
                return await OnGetAsync("Edit");
            }

            return RedirectToPage();
        }

        // (Hàm helper UpdateClaims và class UpdateAvatarResponse giữ nguyên)
        private async Task UpdateClaims(string newHoTen, string newTenDangNhap)
        {
            var user = User.Identity as ClaimsIdentity;
            if (user != null)
            {
                var oldGivenName = user.FindFirst(ClaimTypes.GivenName);
                if (oldGivenName != null) user.RemoveClaim(oldGivenName);
                user.AddClaim(new Claim(ClaimTypes.GivenName, newHoTen));

                // ==================================
                // === THÊM MỚI: Cập nhật ClaimTypes.Name (dùng cho TenDangNhap) ===
                // ==================================
                var oldName = user.FindFirst(ClaimTypes.Name);
                if (oldName != null) user.RemoveClaim(oldName);
                user.AddClaim(new Claim(ClaimTypes.Name, newTenDangNhap));
                // ==================================

                await HttpContext.SignOutAsync();
                await HttpContext.SignInAsync(new ClaimsPrincipal(user));
            }
        }
        private class UpdateAvatarResponse { public string? newAvatarUrl { get; set; } }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\XacNhanMaView.cshtml
================================================================================
﻿@page "/Account/VerifyCode"
@model WebCafebookApi.Pages.Account.XacNhanMaViewModel
@{
    ViewData["Title"] = "Xác Nhận Mã";
    Layout = null; // Dùng layout login
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Cafebook</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body class="login-page-body">

    <div class="login-wrapper">
        <div class="login-container">
            <div class="login-brand-col d-none d-md-flex">
                <img src="/images/logo.png" alt="Cafebook Logo">
                <h1 class="mb-2">Cafebook</h1>
                <p class="fs-5 opacity-75">Khôi phục tài khoản</p>
            </div>

            <div class="login-form-col">
                <a asp-page="/Account/QuenMatKhauView" class="text-decoration-none mb-3" style="align-self: flex-start;">
                    <span class="material-symbols-outlined" style="vertical-align: middle;">arrow_back</span>
                    Gửi lại mã?
                </a>

                <h2>@ViewData["Title"]</h2>
                <p class="text-muted">Nhập mã 6 chữ số đã được gửi đến @Model.Input.Email</p>

                <form method="post">
                    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                    {
                        <div class="alert alert-danger">@Model.ErrorMessage</div>
                    }

                    <input type="hidden" asp-for="Input.Email" />

                    <div class="form-floating-material">
                        <input asp-for="Input.VerificationCode" class="form-control" autocomplete="one-time-code" aria-required="true" placeholder=" " />
                        <label asp-for="Input.VerificationCode" class="form-label">Mã 6 chữ số</label>
                        <span class="material-symbols-outlined">password</span>
                        <span asp-validation-for="Input.VerificationCode" class="text-danger small"></span>
                    </div>

                    <button type="submit" class="w-100 btn btn-lg btn-primary mt-3">Xác Nhận</button>
                </form>
            </div>
        </div>
    </div>

    <partial name="_ValidationScriptsPartial" />
</body>
</html>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\XacNhanMaView.cshtml.cs
================================================================================
﻿using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.Extensions.Caching.Memory;
using System.ComponentModel.DataAnnotations;
using System;

namespace WebCafebookApi.Pages.Account // SỬA: Namespace
{
    public class XacNhanMaViewModel : PageModel
    {
        private readonly IMemoryCache _cache;

        public XacNhanMaViewModel(IMemoryCache cache)
        {
            _cache = cache;
        }

        [BindProperty]
        public InputModel Input { get; set; } = new InputModel();

        [TempData]
        public string? ErrorMessage { get; set; }

        public class InputModel
        {
            [Required]
            [HiddenInput]
            public string Email { get; set; } = string.Empty;

            [Required(ErrorMessage = "Vui lòng nhập mã xác nhận.")]
            [Display(Name = "Mã Xác Nhận")]
            [RegularExpression(@"^\d{6}$", ErrorMessage = "Mã xác nhận phải gồm 6 chữ số.")]
            public string VerificationCode { get; set; } = string.Empty;
        }

        public IActionResult OnGet()
        {
            var email = TempData["VerificationEmail"] as string;
            if (string.IsNullOrEmpty(email))
            {
                return RedirectToPage("./QuenMatKhauView");
            }

            Input.Email = email;
            TempData.Keep("VerificationEmail");
            return Page();
        }

        public IActionResult OnPostAsync()
        {
            if (!ModelState.IsValid)
            {
                return Page();
            }

            string email = Input.Email;
            string cacheKey = $"ForgotPassword_{email}";

            if (_cache.TryGetValue(cacheKey, out string? cachedCode))
            {
                if (cachedCode == Input.VerificationCode)
                {
                    // Mã ĐÚNG. Tạo token reset
                    string resetToken = Guid.NewGuid().ToString("N");
                    string resetCacheKey = $"ResetToken_{email}";
                    var resetCacheOptions = new MemoryCacheEntryOptions()
                        .SetAbsoluteExpiration(TimeSpan.FromMinutes(10));

                    _cache.Set(resetCacheKey, resetToken, resetCacheOptions);
                    _cache.Remove(cacheKey);
                    TempData.Remove("VerificationEmail");

                    return RedirectToPage("./DatLaiMatKhauView", new { email = email, token = resetToken });
                }
                else
                {
                    ErrorMessage = "Mã xác nhận không đúng.";
                    TempData.Keep("VerificationEmail");
                    return Page();
                }
            }
            else
            {
                ErrorMessage = "Mã xác nhận đã hết hạn hoặc không tồn tại.";
                TempData.Keep("VerificationEmail");
                return Page();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\_Layout_Account.cshtml
================================================================================
﻿@* Tập tin: WebCafebookApi/Pages/Account/_Layout_Account.cshtml *@
@{
    Layout = "_Layout";
    string? CurrentPage()
    {
        return ViewContext.RouteData.Values["page"]?.ToString();
    }
}

<div class="container mt-5">
    <div class="main-content-card">
        <div class="account-layout-container">

            <div class="account-sidebar">
                <nav class="nav flex-column nav-pills">

                    <a class="nav-link @(CurrentPage() == "/Account/TaiKhoanTongQuanView" ? "active" : "")"
                       asp-page="/Account/TaiKhoanTongQuanView">
                        <span class="material-symbols-outlined">person</span>
                        Tài khoản của tôi
                    </a>
                    <a class="nav-link @(CurrentPage() == "/Account/ThongTinCaNhanView" ? "active" : "")"
                       asp-page="/Account/ThongTinCaNhanView">
                        <span class="material-symbols-outlined">badge</span>
                        Hồ sơ
                    </a>
                    <a class="nav-link @(CurrentPage() == "/Account/DoiMatKhauView" ? "active" : "")"
                       asp-page="/Account/DoiMatKhauView">
                        <span class="material-symbols-outlined">lock</span>
                        Đổi mật khẩu
                    </a>
                    <a class="nav-link @(CurrentPage() == "/Account/LichSuDatBanView" ? "active" : "")"
                       asp-page="/Account/LichSuDatBanView">
                        <span class="material-symbols-outlined">event_list</span>
                        Lịch sử đặt bàn
                    </a>
                    <a class="nav-link @(CurrentPage() == "/Account/LichSuThueSachView" ? "active" : "")"
                       asp-page="/Account/LichSuThueSachView">
                        <span class="material-symbols-outlined">menu_book</span>
                        Lịch sử thuê sách
                    </a>

                    <a class="nav-link @(CurrentPage() == "/Account/LichSuDonHangView" ? "active" : "")"
                       asp-page="/Account/LichSuDonHangView">
                        <span class="material-symbols-outlined">receipt_long</span>
                        Lịch sử mua hàng
                    </a>

                </nav>
            </div>

            <div class="account-content">
                @RenderBody()
            </div>

        </div>
    </div>
</div>

@section Scripts {
    @await RenderSectionAsync("Scripts", required: false)
}

@section Styles {
    @await RenderSectionAsync("Styles", required: false)
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\DangNhapEmployee.cshtml
================================================================================
﻿@page "/Employee/Login"
@model WebCafebookApi.Pages.employee.DangNhapEmployeeModel
@{
    ViewData["Title"] = "Đăng nhập Nhân viên";
    Layout = null; // Dùng layout riêng của trang Login
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Cafebook</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body class="login-page-body">

    <div class="login-wrapper" style="max-width: 450px;">
        <div class="login-container" style="flex-direction: column;">

            <div class="login-form-col">
                <a href="/"
                   class="text-decoration-none mb-3" style="align-self: flex-start;">
                    <span class="material-symbols-outlined" style="vertical-align: middle;">arrow_back</span>
                    Về Trang Chủ
                </a>

                <h2 class="text-center">@ViewData["Title"]</h2>
                <p class="text-muted text-center">Sử dụng tài khoản nội bộ của bạn.</p>

                <form id="account" method="post">

                    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                    {
                        <div class="alert alert-danger" role="alert">@Model.ErrorMessage</div>
                    }
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-2" role="alert"></div>

                    <div class="form-floating-material">
                        <input asp-for="Input.TenDangNhap" class="form-control" autocomplete="username" aria-required="true" placeholder=" " />
                        <label asp-for="Input.TenDangNhap">Tài khoản (Username, Email hoặc SĐT)</label>
                        <span class="material-symbols-outlined">shield_person</span>
                        <span asp-validation-for="Input.TenDangNhap" class="text-danger small"></span>
                    </div>

                    <div class="form-floating-material">
                        <input asp-for="Input.MatKhau" type="password" class="form-control" autocomplete="current-password" aria-required="true" placeholder=" " />
                        <label asp-for="Input.MatKhau">Mật khẩu</label>
                        <span class="material-symbols-outlined">lock</span>
                        <span asp-validation-for="Input.MatKhau" class="text-danger small"></span>
                    </div>

                    <div>
                        <button id="login-submit" type="submit" class="w-100 btn btn-lg btn-primary">Đăng nhập</button>
                    </div>

                </form>
            </div>
        </div>
    </div>

    <partial name="_ValidationScriptsPartial" />
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\DangNhapEmployee.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/employee/DangNhapEmployee.cshtml.cs
using System.ComponentModel.DataAnnotations;
using System.Security.Claims;
using CafebookModel.Model.ModelApi;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Json;
using CafebookModel.Model.Data; // Cần thiết cho LoginRequestModel & WebLoginResponseModel
using System.Collections.Generic; // Cần thiết cho List<Claim>
using System; // Cần thiết cho DateTimeOffset
using System.Threading.Tasks; // Cần thiết cho Task
using Microsoft.AspNetCore.Http; // Cần thiết cho Session

namespace WebCafebookApi.Pages.employee
{
    public class DangNhapEmployeeModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;
        public DangNhapEmployeeModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        [BindProperty]
        public InputModel Input { get; set; } = new();

        [TempData]
        public string? ErrorMessage { get; set; }

        public class InputModel
        {
            [Required(ErrorMessage = "Vui lòng nhập tài khoản")]
            public string TenDangNhap { get; set; } = string.Empty;

            [Required(ErrorMessage = "Vui lòng nhập mật khẩu")]
            [DataType(DataType.Password)]
            public string MatKhau { get; set; } = string.Empty;
        }

        public async Task OnGetAsync()
        {
            await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
            // Xóa JWT Token khỏi session nếu có
            HttpContext.Session.Remove("JwtToken");
        }

        public async Task<IActionResult> OnPostAsync()
        {
            if (!ModelState.IsValid)
            {
                return Page();
            }

            // Dùng "ApiClient" đã cấu hình BaseAddress
            var httpClient = _httpClientFactory.CreateClient("ApiClient");

            var apiRequest = new LoginRequestModel
            {
                TenDangNhap = Input.TenDangNhap,
                MatKhau = Input.MatKhau
            };

            // Dùng đường dẫn tương đối
            var response = await httpClient.PostAsJsonAsync("api/web/taikhoannv/login", apiRequest);

            if (response.IsSuccessStatusCode)
            {
                var apiResponse = await response.Content.ReadFromJsonAsync<WebLoginResponseModel>();

                // SỬA: Kiểm tra cả Token
                if (apiResponse != null && apiResponse.Success && apiResponse.NhanVienData != null && !string.IsNullOrEmpty(apiResponse.Token))
                {
                    var user = apiResponse.NhanVienData;

                    // --- VIỆC 1: TẠO COOKIE XÁC THỰC (Cho Razor Pages) ---
                    var claims = new List<Claim>
                    {
                        new Claim(ClaimTypes.NameIdentifier, user.IdNhanVien.ToString()),
                        new Claim(ClaimTypes.Name, user.HoTen ?? ""),
                        new Claim(ClaimTypes.GivenName, user.HoTen ?? ""),
                        new Claim(ClaimTypes.Role, user.TenVaiTro ?? "NhanVien") // Rất quan trọng
                    };
                    foreach (var quyen in user.DanhSachQuyen)
                    {
                        claims.Add(new Claim("Permission", quyen));
                    }

                    var claimsIdentity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
                    var authProperties = new AuthenticationProperties
                    {
                        ExpiresUtc = DateTimeOffset.UtcNow.AddHours(8),
                        IsPersistent = true // Tùy chọn: ghi nhớ đăng nhập
                    };

                    await HttpContext.SignInAsync(
                        CookieAuthenticationDefaults.AuthenticationScheme,
                        new ClaimsPrincipal(claimsIdentity),
                        authProperties);

                    // --- VIỆC 2: LƯU VÀO SESSION (Cho HttpClient/API) ---

                    // THÊM DÒNG NÀY: Lưu JWT Token để HttpClient tự động sử dụng
                    HttpContext.Session.SetString("JwtToken", apiResponse.Token);

                    // Lưu Avatar (Giữ nguyên)
                    HttpContext.Session.SetString("AvatarUrl", user.AnhDaiDien ?? "");

                    // Chuyển hướng đến trang Dashboard
                    return LocalRedirect(Url.Content("~/Employee/Dashboard"));
                }
                else
                {
                    // Cập nhật thông báo lỗi
                    ErrorMessage = apiResponse?.Message ?? "Lỗi: API trả về dữ liệu không hợp lệ (thiếu Token hoặc NhanVienData).";
                    return Page();
                }
            }

            ErrorMessage = "Không thể kết nối đến máy chủ đăng nhập.";
            return Page();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\DangXuat.cshtml
================================================================================
﻿@page "/Employee/Logout"
@model WebCafebookApi.Pages.employee.DangXuatModel
@{
    ViewData["Title"] = "Đăng xuất";
}
<p>Đang đăng xuất...</p>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\DangXuat.cshtml.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Threading.Tasks;

namespace WebCafebookApi.Pages.employee
{
    public class DangXuatModel : PageModel
    {
        public async Task<IActionResult> OnPostAsync()
        {
            await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
            HttpContext.Session.Clear();
            return RedirectToPage("/Employee/DangNhapEmployee");
        }

        public async Task<IActionResult> OnGetAsync()
        {
            return await OnPostAsync();
        }
    }
}



================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\GoiMonView.cshtml
================================================================================
﻿@page "/Employee/GoiMon"
@model WebCafebookApi.Pages.employee.GoiMonViewModel
@{
    ViewData["Title"] = "Gọi Món";
    Layout = "_Layout_Employee";
}

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
    <a asp-page="/Employee/SoDoBan" class="btn btn-primary">Quay lại Sơ đồ bàn</a>
}
else
{
    <div class="goimon-layout-container" 
         id="goimon-main-container"
         data-id-hoadon="@Model.IdHoaDon"
         data-id-nhanvien="@Model.IdNhanVien"
         data-jwt-token="@Model.JwtToken">

        <nav class="goimon-danhmuc-list card">
            <div class="card-body">
                <h6 class="px-3 text-muted text-uppercase small">Danh Mục</h6>
                <ul class="nav flex-column nav-pills" id="category-list">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-id-danhmuc="0">
                            <span class="material-symbols-outlined">select_all</span>
                            Tất cả
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <div class="goimon-sanpham-grid">
            <div class="p-3">
                <input type="search" id="search-bar" class="form-control" placeholder="Tìm kiếm món..." />
            </div>
            <div class="goimon-sanpham-list" id="product-list">
                </div>
        </div>

        <div class="goimon-hoadon-panel card">
            <div class="card-header p-3">
                <h5 class="fw-bold mb-0" id="lblTieuDeHoaDon">Hóa đơn - ...</h5>
            </div>
            <div class="goimon-hoadon-body">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Tên Món</th>
                            <th style="width: 120px;">Số Lượng</th>
                            <th style="width: 50px;">Xóa</th>
                        </tr>
                    </thead>
                    <tbody id="bill-details-body">
                        </tbody>
                </table>
            </div>
            
            <div class="card-footer goimon-hoadon-footer">
                <div class="bill-summary">
                    <div class="bill-row">
                        <span>Tổng tiền:</span>
                        <span id="lblTongTien">0 đ</span>
                    </div>
                    <div class="bill-row">
                        <span>Khuyến mãi:</span>
                        <select id="cboKhuyenMai" class="form-select form-select-sm" style="max-width: 180px;">
                            <option value="0">-- Không áp dụng --</option>
                        </select>
                    </div>
                    <div class="bill-row">
                        <span>Tiền giảm:</span>
                        <span class="text-success fw-bold" id="lblTienGiam">0 đ</span>
                    </div>
                    <hr class="my-2" />
                    <div class="bill-row bill-total">
                        <span>Thành Tiền:</span>
                        <span id="lblThanhTien">0 đ</span>
                    </div>
                </div>
                
                <div class="goimon-actions">
                    <button class="btn btn-danger" id="btnHuyDon">
                        <span class="material-symbols-outlined">delete_forever</span> Hủy Đơn
                    </button>
                    @*
                    <a asp-page="/Employee/SoDoBan" class="btn btn-secondary">
                        <span class="material-symbols-outlined">arrow_back</span> Quay Lại
                    </a>*@
                    <button type="button" class="btn btn-secondary" id="btnQuayLai">
                        <span class="material-symbols-outlined">arrow_back</span> Quay Lại
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@section Styles {
    <style>
        .goimon-layout-container {
            display: flex;
            gap: 1.5rem;
            height: calc(100vh - 100px); /* Chiều cao tối đa */
        }

        /* Cột 1: Danh Mục */
        .goimon-danhmuc-list {
            flex: 0 0 220px;
            border: none;
            height: 100%;
        }
            .goimon-danhmuc-list .card-body { padding: 0.75rem; }
            .goimon-danhmuc-list .nav-link {
                color: var(--cf-brown-dark); font-weight: 600;
                font-size: 0.95rem; padding: 0.75rem 1.25rem;
                display: flex; align-items: center; gap: 0.75rem;
                border-radius: 8px; margin-bottom: 0.25rem;
                transition: all 0.2s ease-in-out;
            }
            .goimon-danhmuc-list .nav-link:hover { background-color: var(--cf-cream); }
            .goimon-danhmuc-list .nav-link.active {
                background-color: var(--cf-brown); color: var(--cf-white);
                box-shadow: 0 4px 12px rgba(111, 78, 55, 0.3);
            }
            .goimon-danhmuc-list .nav-link.active .material-symbols-outlined { color: var(--cf-white); }
            .goimon-danhmuc-list .nav-link .material-symbols-outlined { color: var(--cf-orange); }

        /* Cột 2: Sản Phẩm */
        .goimon-sanpham-grid {
            flex: 1;
            min-width: 0;
            background: #f9f9f9;
            border-radius: 8px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .goimon-sanpham-list {
            overflow-y: auto;
            flex-grow: 1;
            padding: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
            align-content: flex-start;
        }
        .product-card {
            background: var(--cf-white);
            border-radius: 8px;
            border: 1px solid var(--cf-gray-light);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px var(--cf-shadow);
        }
        .product-card:hover {
            transform: translateY(-4px);
            border-color: var(--cf-orange);
            box-shadow: 0 8px 16px var(--cf-shadow);
        }
        .product-card img {
            width: 100%; height: 100px;
            object-fit: cover;
            border-radius: 8px 8px 0 0;
            background: var(--cf-gray-light);
        }
        .product-card-body { padding: 0.75rem; }
        .product-card-name {
            font-size: 0.9rem; font-weight: 600;
            color: var(--cf-brown-dark);
            height: 40px; /* 2 dòng */
            overflow: hidden;
        }
        .product-card-price {
            font-size: 0.9rem; font-weight: 700;
            color: var(--cf-orange);
            margin-top: 4px;
        }

        /* Cột 3: Hóa Đơn */
        .goimon-hoadon-panel {
            flex: 0 0 420px;
            border: none;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .goimon-hoadon-body {
            flex-grow: 1;
            overflow-y: auto;
            min-height: 0;
        }
        .goimon-hoadon-body .table { margin-bottom: 0; }
        .goimon-hoadon-body .item-name {
            font-weight: 600;
            font-size: 0.95rem;
        }
        .goimon-hoadon-body .item-note {
            font-size: 0.8rem;
            color: #777;
            font-style: italic;
        }
        .goimon-hoadon-body .item-price {
            font-size: 0.85rem;
            color: var(--cf-gray);
        }
        .goimon-hoadon-body .quantity-control {
            display: flex;
            align-items: center;
        }
        .goimon-hoadon-body .quantity-control .btn {
            width: 30px; height: 30px;
            padding: 0; line-height: 0;
            font-weight: 600;
        }
        .goimon-hoadon-body .quantity-control .quantity-display {
            width: 35px; text-align: center;
            font-weight: 600;
        }
        
        .goimon-hoadon-footer {
            background: var(--cf-white);
            box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
            padding: 1rem;
        }
        .bill-summary .bill-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }
        .bill-summary .bill-row span:first-child { color: var(--cf-gray); }
        .bill-summary .bill-row span:last-child { font-weight: 600; }
        .bill-summary .bill-total {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--cf-brown);
        }
        .bill-summary .bill-total span:last-child { color: var(--cf-orange); }

        .goimon-actions {
            margin-top: 1rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        .goimon-actions .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem;
            font-weight: 600;
        }
    </style>
}

@section Scripts {
    <script>
        // --- KHỞI TẠO BIẾN TOÀN CỤC ---
        let _idHoaDon = 0;
        let _idNhanVien = 0;
        let _jwtToken = "";
        const _apiBaseUrl = "http://127.0.0.1:5166/api/web/quanly/goimon";

        let _allSanPhams = [];
        let _chiTietItems = []; // Lưu dưới dạng Map { idChiTiet: item }
        let _availableKms = [];

        // --- HÀM TIỆN ÍCH ---
        function formatCurrency(number) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(number);
        }
        
        /**
         * Hàm gọi API chung (lấy từ SoDoBanView)
         */
        async function callApi(endpoint, method, data) {
            if (!_jwtToken) {
                alert("Lỗi: Không tìm thấy token xác thực.");
                return null;
            }
            try {
                const response = await fetch(`${_apiBaseUrl}/${endpoint}`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${_jwtToken}`
                    },
                    body: data ? JSON.stringify(data) : null
                });
                if (response.status === 401) {
                    alert("Phiên đăng nhập API đã hết hạn.");
                    window.location.href = "/account/DangNhapView";
                    return null;
                }
                const contentType = response.headers.get("content-type");
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `Lỗi ${response.status}`);
                }
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    return await response.json();
                } else {
                    return { success: true, message: await response.text() };
                }
            } catch (error) {
                console.error('Lỗi API:', error);
                showToast(`Thao tác thất bại: ${error.message}`, 'error');
                return null;
            }
        }
        
        // Cải tiến: Dùng Toast thay vì Alert
        function showToast(message, type = 'success') {
            // (Tạm thời dùng console.log, bạn có thể thay bằng thư viện toast)
            if (type === 'error') {
                console.error(message);
                alert(message); // Vẫn alert nếu lỗi
            } else {
                console.log(message);
            }
        }

        // --- CÁC HÀM RENDER UI ---

        function renderDanhMucs(danhMucs) {
            const $list = $("#category-list");
            $list.children(".nav-item:not(:first-child)").remove(); // Giữ lại "Tất cả"
            
            danhMucs.forEach(dm => {
                if(dm.idDanhMuc === 0) return; // Bỏ qua nếu là "Tất cả"
                const $li = $(`
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-id-danhmuc="${dm.idDanhMuc}">
                            <span class="material-symbols-outlined">label</span>
                            ${dm.tenLoaiSP}
                        </a>
                    </li>
                `);
                $list.append($li);
            });
        }

        function renderSanPhams(sanPhamList) {
            const $list = $("#product-list");
            $list.empty();
            if (!sanPhamList || sanPhamList.length === 0) {
                $list.html('<p class="text-muted p-3">Không tìm thấy sản phẩm.</p>');
                return;
            }
            
            sanPhamList.forEach(sp => {
                const $card = $(`
                    <div class="product-card" data-id-sanpham="${sp.idSanPham}">
                        <img src="${sp.hinhAnh}" alt="${sp.tenSanPham}" />
                        <div class="product-card-body">
                            <div class="product-card-name">${sp.tenSanPham}</div>
                            <div class="product-card-price">${formatCurrency(sp.donGia)}</div>
                        </div>
                    </div>
                `);
                $card.data('sanpham', sp); // Gắn full data
                $list.append($card);
            });
        }

        function renderChiTiet() {
            const $body = $("#bill-details-body");
            $body.empty();
            if (_chiTietItems.length === 0) {
                $body.html('<tr><td colspan="3" class="text-center text-muted p-4">Hóa đơn trống</td></tr>');
                return;
            }
            
            // Sắp xếp theo IdChiTietHoaDon để món mới thêm luôn ở cuối
            const sortedItems = Object.values(_chiTietItems).sort((a, b) => a.idChiTietHoaDon - b.idChiTietHoaDon);

            sortedItems.forEach(item => {
                const $tr = $(`
                    <tr data-id-chitiet="${item.idChiTietHoaDon}">
                        <td>
                            <div class="item-name">${item.tenSanPham}</div>
                            <div class="item-price">${formatCurrency(item.donGia)}</div>
                            ${item.ghiChu ? `<div class="item-note">Ghi chú: ${item.ghiChu}</div>` : ''}
                        </td>
                        <td>
                            <div class="quantity-control">
                                <button class="btn btn-outline-danger btn-sm btn-giam-sl" data-id-chitiet="${item.idChiTietHoaDon}">-</button>
                                <span class="quantity-display">${item.soLuong}</span>
                                <button class="btn btn-outline-success btn-sm btn-tang-sl" data-id-chitiet="${item.idChiTietHoaDon}">+</button>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-link text-danger btn-xoa-mon" data-id-chitiet="${item.idChiTietHoaDon}">
                                <span class="material-symbols-outlined">delete</span>
                            </button>
                        </td>
                    </tr>
                `);
                $body.append($tr);
            });
        }

        function updateBillUI(hoaDonInfo) {
            if (!hoaDonInfo) return;

            $("#lblTieuDeHoaDon").text(`Hóa đơn - ${hoaDonInfo.soBan}`);
            $("#lblTongTien").text(formatCurrency(hoaDonInfo.tongTienGoc));
            $("#lblTienGiam").text(formatCurrency(hoaDonInfo.giamGia));
            $("#lblThanhTien").text(formatCurrency(hoaDonInfo.thanhTien));

            // Cập nhật ComboBox Khuyến mãi
            const $cbo = $("#cboKhuyenMai");
            if ($cbo.children().length <= 1) { // Chỉ load 1 lần
                _availableKms.forEach(km => {
                    if(km.idKhuyenMai === 0) return;
                    $cbo.append(`<option value="${km.idKhuyenMai}">${km.tenKhuyenMai}</option>`);
                });
            }
            // Chọn đúng KM đang áp dụng
            $cbo.val(hoaDonInfo.idKhuyenMai || 0);
        }

        // --- HÀM XỬ LÝ SỰ KIỆN ---

        async function handleLoadData() {
            const result = await callApi(`load/${_idHoaDon}`, 'GET');
            if (result) {
                _allSanPhams = result.sanPhams;
                _availableKms = result.khuyenMais;
                
                // Chuyển array chi tiết sang Map để truy cập nhanh
                _chiTietItems = {};
                result.chiTietItems.forEach(item => {
                    _chiTietItems[item.idChiTietHoaDon] = item;
                });

                renderDanhMucs(result.danhMucs);
                renderSanPhams(_allSanPhams);
                renderChiTiet();
                updateBillUI(result.hoaDonInfo);
            } else {
                // Nếu load lỗi (ví dụ HĐ đã thanh toán), vô hiệu hóa trang
                $("#goimon-main-container").find("input, button, select, a").prop("disabled", true);
            }
        }

        function handleFilterProduct() {
            const $link = $(this);
            const idDanhMuc = $link.data("id-danhmuc");

            $(".goimon-danhmuc-list .nav-link").removeClass("active");
            $link.addClass("active");

            const keyword = $("#search-bar").val().toLowerCase();
            
            let filteredList = _allSanPhams;

            if (idDanhMuc !== 0) {
                filteredList = filteredList.filter(sp => sp.idDanhMuc == idDanhMuc);
            }
            if (keyword) {
                filteredList = filteredList.filter(sp => sp.tenSanPham.toLowerCase().includes(keyword));
            }

            renderSanPhams(filteredList);
        }

        async function handleAddProduct() {
            const sanPham = $(this).data('sanpham');
            if (!sanPham) return;
            
            // Cho phép nhập ghi chú
            let ghiChu = prompt(`Thêm ghi chú cho món [${sanPham.tenSanPham}]:`, "");
            if (ghiChu === null) return; // User bấm Hủy

            const request = {
                idHoaDon: _idHoaDon,
                idSanPham: sanPham.idSanPham,
                soLuong: 1,
                ghiChu: ghiChu.trim()
            };

            const result = await callApi('add-item', 'POST', request);
            if (result && result.updatedHoaDonInfo && result.newItem) {
                // Cập nhật item mới/hiện có
                const newItem = result.newItem;
                _chiTietItems[newItem.idChiTietHoaDon] = newItem;

                renderChiTiet();
                updateBillUI(result.updatedHoaDonInfo);
                showToast(`Đã thêm [${newItem.tenSanPham}] và gửi bếp.`);
            }
        }
        
        async function handleChangeQuantity(idChiTiet, delta) {
            const item = _chiTietItems[idChiTiet];
            if (!item) return;

            const soLuongMoi = item.soLuong + delta;
            
            const request = {
                idChiTietHoaDon: item.idChiTietHoaDon,
                soLuongMoi: soLuongMoi
            };
            
            const hoaDonInfo = await callApi('update-quantity', 'PUT', request);
            if(hoaDonInfo) {
                if (soLuongMoi <= 0) {
                    delete _chiTietItems[item.idChiTietHoaDon];
                    showToast(`Đã xóa [${item.tenSanPham}] và báo bếp.`);
                } else {
                    // Cập nhật lại SL trong bộ nhớ
                    item.soLuong = soLuongMoi;
                    item.thanhTien = item.donGia * soLuongMoi;
                    showToast(`Cập nhật [${item.tenSanPham}] và báo bếp.`);
                }
                renderChiTiet();
                updateBillUI(hoaDonInfo);
            }
        }

        async function handleDeleteItem(idChiTiet) {
            const item = _chiTietItems[idChiTiet];
            if (!item) return;

            if (!confirm(`Bạn chắc chắn muốn xóa [${item.tenSanPham}]?`)) return;

            const hoaDonInfo = await callApi(`delete-item/${idChiTiet}`, 'DELETE');
            if(hoaDonInfo) {
                delete _chiTietItems[item.idChiTietHoaDon];
                renderChiTiet();
                updateBillUI(hoaDonInfo);
                showToast(`Đã xóa [${item.tenSanPham}] và báo bếp.`);
            }
        }

        async function handleApplyPromotion() {
            const idKhuyenMai = $(this).val();
            
            const request = {
                idHoaDon: _idHoaDon,
                idKhuyenMai: idKhuyenMai == "0" ? null : parseInt(idKhuyenMai)
            };
            
            const hoaDonInfo = await callApi('apply-promotion', 'PUT', request);
            if(hoaDonInfo) {
                updateBillUI(hoaDonInfo);
                showToast("Đã cập nhật khuyến mãi.");
            }
        }

        async function handleCancelOrder() {
            if (!confirm("Bạn có chắc chắn muốn HỦY hóa đơn này không?\nHành động này không thể hoàn tác!")) return;
            
            const result = await callApi(`cancel-order/${_idHoaDon}`, 'PUT');
            if(result) {
                alert("Đã hủy hóa đơn thành công!");
                window.location.href = "/Employee/SoDoBan"; // Quay về Sơ đồ bàn
            }
        }


        // --- KHỞI CHẠY ---
        $(document).ready(function () {
            const $container = $("#goimon-main-container");
            _idHoaDon = $container.data("id-hoadon");
            _idNhanVien = $container.data("id-nhanvien");
            _jwtToken = $container.data("jwt-token");

            // Tải dữ liệu
            handleLoadData();

            // Gắn sự kiện
            $("#category-list").on("click", ".nav-link", handleFilterProduct);
            $("#search-bar").on("keyup", handleFilterProduct);
            $("#product-list").on("click", ".product-card", handleAddProduct);
            
            $("#bill-details-body").on("click", ".btn-tang-sl", function() {
                handleChangeQuantity($(this).data('id-chitiet'), 1);
            });
            $("#bill-details-body").on("click", ".btn-giam-sl", function() {
                handleChangeQuantity($(this).data('id-chitiet'), -1);
            });
            $("#bill-details-body").on("click", ".btn-xoa-mon", function() {
                handleDeleteItem($(this).data('id-chitiet'));
            });

            $("#cboKhuyenMai").on("change", handleApplyPromotion);
            $("#btnHuyDon").on("click", handleCancelOrder);
            $("#btnQuayLai").on("click", function() {
                window.history.back();
            });
        });
    </script>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\GoiMonView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/employee/GoiMonView.cshtml.cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.AspNetCore.Authorization;
using System.Security.Claims;
using Microsoft.AspNetCore.Http; // Thêm

namespace WebCafebookApi.Pages.employee
{
    [Authorize(Roles = "Quản trị viên, Phục vụ, Thu ngân, Pha chế, Bếp, Quản lý")]
    public class GoiMonViewModel : PageModel
    {
        // Các thuộc tính này sẽ được truyền xuống JavaScript
        public int IdHoaDon { get; set; }
        public int IdNhanVien { get; set; }
        public string? JwtToken { get; set; }
        public string? ErrorMessage { get; set; }

        public IActionResult OnGet()
        {
            // 1. Lấy IdHoaDon từ query string (?idHoaDon=...)
            if (!int.TryParse(Request.Query["idHoaDon"], out int idHoaDon))
            {
                ErrorMessage = "Không tìm thấy IdHoaDon. Vui lòng quay lại Sơ Đồ Bàn.";
                return Page();
            }
            IdHoaDon = idHoaDon;

            // 2. Lấy IdNhanVien từ Claims (giống SoDoBanView)
            var idNhanVienStr = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (!int.TryParse(idNhanVienStr, out int idNhanVien))
            {
                return RedirectToPage("/account/DangNhapView"); // Lỗi claim
            }
            IdNhanVien = idNhanVien;

            // 3. Lấy JwtToken từ Session (giống SoDoBanView)
            JwtToken = HttpContext.Session.GetString("JwtToken");
            if (string.IsNullOrEmpty(JwtToken))
            {
                return RedirectToPage("/account/DangNhapView"); // Lỗi token
            }

            return Page();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\HoTroKhachHangView.cshtml
================================================================================
﻿@page "/Employee/HoTroKhachHangView"
@model WebCafebookApi.Pages.employee.HoTroKhachHangViewModel
@{
    ViewData["Title"] = "Trung tâm Hỗ trợ";
    Layout = "_Layout_Employee";
}

@section Styles {
    <style>
        :root {
            --cf-brown-dark: #4E342E;
            --cf-brown-light: #A1887F;
            --cf-terracotta-dark: #E65100;
            --cf-beige: #F9F9F9;
            --cf-white: #FFFFFF;
            --cf-text: #333;
            --cf-text-light: #757575;
            --cf-border: #EEEEEE;
        }

        /* === CÀI ĐẶT CHUNG === */
        .main-content-card {
            padding: 0;
            /* Xóa padding gốc */
        }

        .support-dashboard-grid {
            display: grid;
            grid-template-columns: 300px 1fr 380px; /* 3 cột */
            gap: 0;
            height: 85vh; /* Chiều cao tối đa */
            border: 1px solid var(--cf-border);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
        }

        /* === CỘT 1: DANH SÁCH PHIẾU (ĐÃ SỬA) === */
        .ticket-list-wrapper {
            background-color: var(--cf-white);
            border-right: 1px solid var(--cf-border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .ticket-list-header {
            padding: 1rem;
            border-bottom: 1px solid var(--cf-border);
            flex-shrink: 0;
        }

            /* (MỚI) Thêm tiêu đề cho Cột 1 */
            .ticket-list-header h5 {
                font-weight: 700;
                color: var(--cf-brown-dark);
                margin-bottom: 0.75rem;
                font-size: 1.25rem;
            }

        /* (MỚI) Ô tìm kiếm Cột 1 */
        #ticketSearchInput {
            width: 100%;
            padding: 0.5rem 1rem;
            border: 1px solid var(--cf-border);
            border-radius: 20px; /* Bo tròn giống Messenger */
            font-size: 0.9rem;
        }

            #ticketSearchInput:focus {
                box-shadow: none;
                border-color: var(--cf-terracotta-dark);
            }


        .ticket-list {
            overflow-y: auto;
            flex-grow: 1;
        }

        .ticket-item {
            padding: 1rem;
            border-bottom: 1px solid var(--cf-border);
            cursor: pointer;
            transition: background-color 0.2s ease;
            position: relative; /* (MỚI) Cần cho chấm đỏ */
        }

            .ticket-item:hover {
                background-color: var(--cf-beige);
            }

            .ticket-item.active {
                background-color: #FFFDE7; /* Màu vàng nhạt khi active */
                border-right: 3px solid var(--cf-terracotta-dark);
            }

            /* (MỚI) Tô đậm phiếu chưa xử lý */
            .ticket-item.status-pending strong {
                font-weight: 700; /* Tô đậm */
                color: var(--cf-brown-dark);
            }

        /* (MỚI) Chấm đỏ báo hiệu */
        .status-indicator {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background-color: var(--cf-terracotta-dark); /* Màu cam */
            border-radius: 50%;
            border: 2px solid var(--cf-white);
        }

        .ticket-item strong {
            display: block;
            font-size: 0.9rem;
            color: var(--cf-text);
        }

        .ticket-item .ticket-preview {
            font-size: 0.85rem;
            color: var(--cf-text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ticket-item .ticket-time {
            font-size: 0.75rem;
            color: var(--cf-terracotta-dark);
        }

        /* === CỘT 2: CHAT (ĐÃ SỬA) === */
        .chat-column {
            display: flex;
            flex-direction: column;
            background-color: var(--cf-white);
            border-right: 1px solid var(--cf-border);
            overflow: hidden;
        }

        /* (MỚI) Header cho Cột 2, chứa tên và nút tìm kiếm */
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1.5rem; /* Giảm padding 1 chút */
            border-bottom: 1px solid var(--cf-border);
            flex-shrink: 0;
            background-color: var(--cf-white);
        }

        .chat-header-info strong {
            display: block;
            font-size: 1.1rem;
            color: var(--cf-brown-dark);
        }

        .chat-header-info small {
            color: var(--cf-text-light);
        }

        .chat-header-actions span {
            cursor: pointer;
            color: var(--cf-terracotta-dark);
            font-size: 1.5rem;
            padding: 0.5rem;
            border-radius: 50%;
        }

            .chat-header-actions span:hover {
                background-color: var(--cf-beige);
            }


        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            background-color: var(--cf-beige);
        }

        .chat-message-row {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--cf-white);
            flex-shrink: 0;
        }

        .avatar-user {
            background-color: var(--cf-terracotta-dark);
        }

        .avatar-bot {
            background-color: var(--cf-brown-light);
        }

        .avatar-staff {
            background-color: #0D47A1;
        }

        .chat-message-row .message-content {
            display: flex;
            flex-direction: column;
            max-width: 75%;
        }

        .chat-bubble {
            padding: 0.8rem 1.25rem;
            border-radius: 1.25rem;
            line-height: 1.6;
        }

        .bot-row .message-content {
            align-items: flex-start;
        }

        .chat-bubble-bot {
            background-color: var(--cf-white);
            color: var(--cf-text);
            border: 1px solid var(--cf-border);
            border-bottom-left-radius: 0.25rem;
        }

        .user-row {
            flex-direction: row-reverse;
        }

            .user-row .message-content {
                align-items: flex-end;
            }

        .chat-bubble-user {
            background: linear-gradient(135deg, #FF7043, #E65100);
            color: white;
            border-bottom-right-radius: 0.25rem;
        }

        .staff-row .message-content {
            align-items: flex-start;
        }

        .chat-bubble-staff {
            background-color: #E3F2FD;
            color: #0D47A1;
            border: 1px solid #BBDEFB;
            border-bottom-left-radius: 0.25rem;
        }

        .chat-bubble-time {
            font-size: 0.75rem;
            color: var(--cf-text-light);
            margin-top: 6px;
            padding: 0 0.5rem;
        }

        .chat-input-form {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--cf-border);
            background-color: var(--cf-white);
            gap: 1rem;
            flex-shrink: 0;
        }

        .chat-input-wrapper {
            position: relative;
            flex-grow: 1;
        }

        #chatMessageInput {
            border: none;
            border-bottom: 2px solid var(--cf-border);
            border-radius: 0;
            padding: 0.75rem 0.25rem;
            font-size: 1.1rem;
            width: 100%;
        }

            #chatMessageInput:focus {
                box-shadow: none;
                border-color: var(--cf-terracotta-dark);
            }

        #sendButton {
            background-color: var(--cf-terracotta-dark);
            border: none;
            color: white;
        }

        /* === CỘT 3: TÓM TẮT (Giữ nguyên) === */
        .summary-column {
            background-color: var(--cf-white);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .summary-card {
            border: none;
            border-radius: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

            .summary-card .card-header {
                background-color: var(--cf-brown-dark);
                color: white;
                font-weight: 700;
                border-radius: 0;
                border-bottom: none;
                flex-shrink: 0;
            }

            .summary-card .card-body {
                padding: 1.5rem;
                overflow-y: auto;
                flex-grow: 1;
            }

                .summary-card .card-body p {
                    margin-bottom: 1rem;
                }

                    .summary-card .card-body p strong {
                        color: var(--cf-text);
                        display: block;
                        font-size: 0.9rem;
                        margin-bottom: 4px;
                    }

                .summary-card .card-body span,
                .summary-card .card-body .request-content {
                    font-size: 1rem;
                }

                .summary-card .card-body .request-content {
                    background-color: var(--cf-beige);
                    padding: 10px;
                    border-radius: 8px;
                    font-style: italic;
                    color: var(--cf-text-light);
                    white-space: pre-wrap;
                }

        /* Trạng thái trống/chờ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--cf-text-light);
            text-align: center;
        }
        /* (MỚI) Thanh tìm kiếm Cột 2 */
        .chat-search-bar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1.5rem;
            background-color: var(--cf-beige);
            border-bottom: 1px solid var(--cf-border);
            flex-shrink: 0;
        }

            .chat-search-bar input {
                flex-grow: 1;
                border: none;
                border-bottom: 2px solid var(--cf-brown-light);
                font-size: 0.9rem;
                padding: 0.25rem;
                background: transparent;
            }

                .chat-search-bar input:focus {
                    box-shadow: none;
                    border-color: var(--cf-terracotta-dark);
                }

            .chat-search-bar .btn-icon {
                border: none;
                background: none;
                color: var(--cf-text-light);
                padding: 0.25rem;
            }

                .chat-search-bar .btn-icon:hover {
                    color: var(--cf-terracotta-dark);
                }

            .chat-search-bar #chatSearchResultCount {
                font-size: 0.85rem;
                color: var(--cf-text-light);
                min-width: 40px; /* Giữ cho layout ổn định */
            }

        /* (MỚI) CSS để highlight kết quả tìm kiếm */
        .highlight-search {
            background-color: #FFF59D; /* Màu vàng nhạt */
            color: #333;
            border-radius: 3px;
        }

        .highlight-search-active {
            background-color: #FFB74D; /* Màu vàng cam */
            color: #333;
            font-weight: bold;
        }
    </style>
}

@* === PHẦN HTML (ĐÃ SỬA) === *@
<div class="support-dashboard-grid">

    @* CỘT 1 (ĐÃ SỬA) *@
    <div class="ticket-list-wrapper">
        <div class="ticket-list-header">
            <h5>Hộp thư hỗ trợ</h5>
            <input type="text" id="ticketSearchInput" class="form-control" placeholder="Tìm kiếm hội thoại...">
        </div>
        <div class="ticket-list" id="ticket-list-container">
            <div class="empty-state p-3">Đang tải danh sách...</div>
        </div>
    </div>

    @* CỘT 2 (ĐÃ SỬA) *@
    <div class="chat-column" id="chat-column">

        <div class="chat-header" id="chat-header" style="display: none;">
            <div class="chat-header-info">
                <strong id="chatHeaderName"></strong>
                <small id="chatHeaderStatus"></small>
            </div>
            <div class="chat-header-actions">
                <span class="material-symbols-outlined" id="chatSearchIcon" title="Tìm kiếm trong hội thoại">search</span>
            </div>
        </div>
        <div class="chat-search-bar" id="chat-search-bar" style="display: none;">
            <input type="text" id="chatSearchInput" class="form-control" placeholder="Tìm kiếm trong chat..." />
            <span id="chatSearchResultCount">0/0</span>
            <button class="btn-icon" id="chatSearchPrev" title="Kết quả trước">
                <span class="material-symbols-outlined">expand_less</span>
            </button>
            <button class="btn-icon" id="chatSearchNext" title="Kết quả tiếp theo">
                <span class="material-symbols-outlined">expand_more</span>
            </button>
            <button class="btn-icon" id="chatSearchClose" title="Đóng">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="chat-history" id="chat-history">
            <div class="empty-state">
                <span class="material-symbols-outlined fs-1">arrow_back</span>
                <p>Vui lòng chọn một phiếu hỗ trợ từ danh sách bên trái.</p>
            </div>
        </div>

        <form method="post" id="chatForm" class="chat-input-form" asp-antiforgery="true">
            <input type="hidden" id="JwtToken" value="@Model.JwtToken" />

            <div class="chat-input-wrapper">
                <input id="chatMessageInput" class="form-control" placeholder="Nhân viên nhập phản hồi..." autocomplete="off" disabled />
            </div>
            <button type="submit" id="sendButton" class="btn" disabled>
                <span class="material-symbols-outlined">send</span>
            </button>
            <button type="button" id="resolveButton" class="btn btn-success" disabled>
                Đã xử lý
            </button>
        </form>
    </div>

    @* CỘT 3 (Giữ nguyên) *@
    <div class="summary-column" id="summary-column">
        <div class="summary-card card">
            <div class="card-header">
                Thông tin Phiếu Hỗ Trợ
            </div>
            <div class="card-body" id="summary-card-content">
                <div class="empty-state">
                    <p>Chưa chọn phiếu.</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script>
                const apiBaseUrl = '@Model.ApiBaseUrl';
        $(document).ready(function () {
                    // === Lấy các đối tượng DOM ===
                    const $ticketListContainer = $('#ticket-list-container');
                    const $chatHistory = $('#chat-history');
                    const $summaryCardContent = $('#summary-card-content');
        const $chatForm = $('#chatForm');
                    const $chatInput = $('#chatMessageInput');
                    const $sendButton = $('#sendButton');
                    const $resolveButton = $('#resolveButton'); // Nút "Đã xử lý"

                    const $ticketSearchInput = $('#ticketSearchInput');
                    const $chatHeader = $('#chat-header');
                    const $chatHeaderName = $('#chatHeaderName');
                    const $chatHeaderStatus = $('#chatHeaderStatus');
                    const $chatSearchIcon = $('#chatSearchIcon');

                    // (MỚI) DOM cho thanh tìm kiếm Ctrl+F
                    const $chatSearchBar = $('#chat-search-bar');
                    const $chatSearchInput = $('#chatSearchInput');
                    const $chatSearchResultCount = $('#chatSearchResultCount');
                    const $chatSearchPrev = $('#chatSearchPrev');
                    const $chatSearchNext = $('#chatSearchNext');
                    const $chatSearchClose = $('#chatSearchClose');


        const jwtToken = $('#JwtToken').val() || null;
                    const antiForgeryToken = $('input[name="__RequestVerificationToken"]').val();

                    let currentTicketId = null; // ID của phiếu đang được chọn
        let currentGroupName = null; // "Phòng" chat đang xem
                    let currentTicketData = null; // DTO chi tiết của phiếu

                    // (MỚI) Biến trạng thái cho tìm kiếm Ctrl+F
                    let searchMatches = [];
                    let currentSearchIndex = -1;

                    const headers = {
        'Content-Type': 'application/json',
                        'RequestVerificationToken': antiForgeryToken
                    };
        if (jwtToken) { headers['Authorization'] = 'Bearer ' + jwtToken;
        }

                    // === HÀM TRUY CẬP API ===
        async function loadTicketList() {
                        try {
                            const response = await fetch(`${apiBaseUrl}/api/web/quanly/hotro/tickets`, {
                                method: 'GET',
                                headers: headers
        });
                            if (!response.ok) throw new Error('Failed to load tickets');
                            const tickets = await response.json();
                            renderTicketList(tickets);
        } catch (error) {
                            console.error('Lỗi tải danh sách phiếu:', error);
        $ticketListContainer.html('<div class="empty-state p-3">Lỗi tải danh sách.</div>');
                        }
                    }

                    async function loadTicketDetail(id) {
        if (!id || id === currentTicketId) return;

                        // (MỚI) Reset tìm kiếm khi tải phiếu mới
                        clearSearch();
                        $chatSearchBar.hide();

                        currentTicketId = id;
        currentGroupName = null;
                        currentTicketData = null;

                        $('.ticket-item').removeClass('active');
                        $(`.ticket-item[data-id="${id}"]`).addClass('active');

                        $chatInput.prop('disabled', true);
                        $sendButton.prop('disabled', true);
                        $resolveButton.prop('disabled', true);
        try {
                            $chatHistory.html('<div class="empty-state">Đang tải chi tiết...</div>');
        $summaryCardContent.html('<div class="empty-state">Đang tải...</div>');

        const response = await fetch(`${apiBaseUrl}/api/web/quanly/hotro/ticket/${id}`, {
                                method: 'GET',
                                headers: headers
                            });
        if (!response.ok) throw new Error('Failed to load ticket detail');
                            const ticketData = await response.json();
        currentTicketData = ticketData;

                            renderChatHistory(ticketData.lichSuChat);
        renderSummary(ticketData);

                            $chatHeader.show();
                            $chatHeaderName.text(ticketData.tenKhachHang);
                            $chatHeaderStatus.text(ticketData.trangThai);

        const { idKhachHang, guestSessionId } = ticketData;
        const groupName = idKhachHang > 0 ? `khach_${idKhachHang}` : `guest_${guestSessionId}`;
                            if (groupName) {
                                currentGroupName = groupName;
        await hubConnection.invoke("JoinGroup", currentGroupName);
                                console.log(`Joined group: ${currentGroupName}`);
                                $chatInput.prop('disabled', false);
        $sendButton.prop('disabled', false);
                                $resolveButton.prop('disabled', false);
                            } else {
                                throw new Error("Không thể xác định groupName cho phiếu này.");
        }
                        } catch (error) {
                            console.error('Lỗi tải chi tiết phiếu:', error);
        $chatHistory.html('<div class="empty-state">Lỗi tải chi tiết.</div>');
                        }
                    }

                    // === HÀM RENDER HTML (ĐÃ CẬP NHẬT) ===
                    function renderTicketList(tickets) {
        if (tickets.length === 0) {
                            $ticketListContainer.html('<div class="empty-state p-3">Không có phiếu nào.</div>');
        return;
                        }
        $ticketListContainer.empty();
                        tickets.forEach(ticket => {
                            const time = new Date(ticket.thoiGianTao).toLocaleString('vi-VN');
                            const isPending = ticket.trangThai === 'Chờ xử lý';
                            const statusClass = isPending ? 'status-pending' : '';
                            const indicatorHtml = isPending ? '<span class="status-indicator"></span>' : '';
                            const statusColorClass = isPending ? 'text-danger' : 'text-success';
        const ticketHtml = `
                                <div class="ticket-item ${statusClass}" data-id="${ticket.idThongBao}">
                                    <div class="d-flex justify-content-between">
                                        <strong>${ticket.tenKhachHang}</strong>
        <span class="ticket-time ${statusColorClass}">${ticket.trangThai}</span>
                                    </div>
                                    <div class="ticket-preview">${ticket.noiDungYeuCau || '...'}</div>
        <small>${time}</small>
                                    ${indicatorHtml}
                                </div>
                            `;
                            $ticketListContainer.append(ticketHtml);
        });
        }
                    function renderSummary(data) {
                        const summaryHtml = `
                            <p><strong>Khách hàng:</strong> <span>${data.tenKhachHang}</span></p>
        <p><strong>Phiếu số:</strong> <span>#${data.idThongBao}</span></p>
                            <p><strong>Trạng thái:</strong> <span class="badge bg-warning text-dark fs-6">${data.trangThai}</span></p>
                            <p><strong>Thời gian tạo:</strong> <span>${new Date(data.thoiGianTao).toLocaleString('vi-VN')}</span></p>
        <hr />
                            <p><strong>Yêu cầu gốc của khách:</strong> <div class="request-content">${data.noiDungYeuCau ||
        '(Không có)'}</div></p>
                            <p><strong>Ghi chú (AI):</strong> <div class="request-content" style="border: 1px dashed var(--cf-terracotta-dark); color: var(--cf-text)">${data.ghiChuTuAI ||
        '(Không có)'}</div></p>
                        `;
        $summaryCardContent.html(summaryHtml);
                    }
                    function renderChatHistory(messages) {
                        $chatHistory.empty();
        if (!messages || messages.length === 0) {
                            $chatHistory.html('<div class="empty-state">Chưa có lịch sử chat.</div>');
        return;
                        }
                        messages.forEach(msg => {
                            addMessageToUI(msg);
                        });
        scrollToBottom();

                        // (MỚI) Lưu trữ HTML gốc để tìm kiếm
                        $chatHistory.find('.chat-bubble').each(function () {
                            $(this).data('original-html', $(this).html());
                        });
                    }
                    function addMessageToUI(message) {
        const isUser = message.loaiTinNhan === 'KhachHang';
        const isStaff = message.loaiTinNhan === 'NhanVien';
        const rowClass = isUser ? 'user-row' : (isStaff ? 'staff-row' : 'bot-row');
        const avatarClass = isUser ? 'avatar-user' : (isStaff ? 'avatar-staff' : 'avatar-bot');
        const avatarIcon = isUser ? 'person' : (isStaff ? 'support' : 'support_agent');
        const bubbleClass = isUser ? 'chat-bubble-user' : (isStaff ? 'chat-bubble-staff' : 'chat-bubble-bot');
        const timeAlign = isUser ? 'text-end' : 'text-start';
        const formattedContent = (message.noiDung || '').replace(/\n/g, '<br />');
        const time = new Date(message.thoiGian).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

        const $row = $('<div></div>').addClass('chat-message-row ' + rowClass);
        const $avatar = $('<div></div>').addClass('chat-avatar ' + avatarClass)
                            .html(`<span class="material-symbols-outlined">${avatarIcon}</span>`);
        const $content = $('<div></div>').addClass('message-content');
                        const $bubble = $('<div></div>').addClass('chat-bubble ' + bubbleClass).html(formattedContent);
                        const $time = $('<div></div>').addClass('chat-bubble-time ' + timeAlign).text(time);
                        $content.append($bubble).append($time);
                        $row.append($avatar).append($content);
        $chatHistory.append($row);

                        // (MỚI) Cập nhật HTML gốc nếu tin nhắn đến sau (Realtime)
                        $bubble.data('original-html', $bubble.html());
                    }
                    function scrollToBottom() {
                        $chatHistory.scrollTop($chatHistory[0].scrollHeight);
        }

                    // === (MỚI) CÁC HÀM TÌM KIẾM CTRL+F ===

                    // Hàm helper để escape Regex
                    function escapeRegExp(string) {
                        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // $& nghĩa là toàn bộ chuỗi khớp
                    }

                    // 1. Xóa các highlight
                    function clearSearch() {
                        // Khôi phục HTML gốc từ data
                        $chatHistory.find('.chat-bubble').each(function () {
                            const originalHtml = $(this).data('original-html');
                            if (originalHtml !== undefined) {
                                $(this).html(originalHtml);
                            }
                        });
                        searchMatches = [];
                        currentSearchIndex = -1;
                        $chatSearchResultCount.text('0/0');
                    }

                    // 2. Thực hiện tìm kiếm
                    function performSearch() {
                        clearSearch();
                        const searchTerm = $chatSearchInput.val();
                        if (!searchTerm || searchTerm.length < 1) {
                            return;
                        }

                        const regex = new RegExp(escapeRegExp(searchTerm), 'gi');

                        // Lặp qua các bubble để tìm và highlight
                        $chatHistory.find('.chat-bubble').each(function () {
                            const $bubble = $(this);
                            const originalHtml = $bubble.data('original-html');
                            const textContent = $bubble.text(); // Chỉ tìm kiếm trên text, không tìm trên HTML

                            if (textContent.toLowerCase().includes(searchTerm.toLowerCase())) {
                                // Chỉ thay thế trên HTML gốc đã lưu
                                const newHtml = originalHtml.replace(regex, (match) => {
                                    return `<span class="highlight-search">${match}</span>`;
                                });
                                $bubble.html(newHtml);
                            }
                        });

                        // Lấy TẤT CẢ các span đã được highlight
                        searchMatches = $chatHistory.find('.highlight-search');
                        currentSearchIndex = -1;

                        if (searchMatches.length > 0) {
                            currentSearchIndex = 0; // Chuyển đến kết quả đầu tiên
                            updateSearchState();
                        } else {
                            $chatSearchResultCount.text('0/0');
                        }
                    }

                    // 3. Cập nhật trạng thái (active, cuộn)
                    function updateSearchState() {
                        const total = searchMatches.length;
                        if (total === 0) {
                            $chatSearchResultCount.text('0/0');
                            return;
                        }

                        // Cập nhật text
                        $chatSearchResultCount.text(`${currentSearchIndex + 1}/${total}`);

                        // Xóa active cũ, thêm active mới
                        searchMatches.removeClass('highlight-search-active');
                        const $activeMatch = $(searchMatches[currentSearchIndex]);
                        $activeMatch.addClass('highlight-search-active');

                        // Cuộn tới
                        $activeMatch[0].scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }

                    // === LOGIC SIGNALR ===
        const hubConnection = new signalR.HubConnectionBuilder()
                        .withUrl(apiBaseUrl + "/chatHub")
                        .build();

        hubConnection.on("ReceiveMessage", function (message) {
        if (currentTicketId && message.idThongBaoHoTro == currentTicketId) {
                            addMessageToUI(message);
        scrollToBottom();
                            if (message.loaiTinNhan === 'NhanVien') {
                                $chatHeaderStatus.text('Đã trả lời');
                            }
                        }
        });
        hubConnection.on("ReloadTicketList", function () {
                        loadTicketList();
                    });
        async function startConnection() {
                        try {
                            await hubConnection.start();
        console.log("SignalR Connected (Staff).");
                        } catch (err) {
                            console.error(err.toString());
        alert("Không thể kết nối đến máy chủ chat.");
                        }
                    }

                    // === XỬ LÝ SỰ KIỆN ===
        $ticketListContainer.on('click', '.ticket-item', function () {
                        const id = $(this).data('id');
                        loadTicketDetail(id);
                    });

        $chatForm.on('submit', async function (e) {
                        e.preventDefault();
        if (!currentTicketId || !currentGroupName || !currentTicketData) return;
                        const messageText = $chatInput.val();
        if (!messageText.trim()) { return; }
                        $chatInput.val('').prop('disabled', true);
                        $sendButton.prop('disabled', true);
                        try {
                            $chatHeaderStatus.text('Đã trả lời');
        await hubConnection.invoke("SendMessageFromStaff",
                                currentGroupName,
                                messageText,
        currentTicketId,
                                currentTicketData.idKhachHang,
                                currentTicketData.guestSessionId
        );
        } catch (err) {
                            console.error(err.toString());
        alert('Không thể gửi phản hồi.');
                        } finally {
                            $chatInput.prop('disabled', false).focus();
        $sendButton.prop('disabled', false);
                        }
                    });

        $resolveButton.on('click', async function () {
        if (!currentTicketId || !confirm("Bạn có chắc muốn đóng phiếu hỗ trợ này?")) return;
                        $resolveButton.prop('disabled', true).text("Đang xử lý...");
                        try {
        const response = await fetch(`${apiBaseUrl}/api/web/quanly/hotro/resolve/${currentTicketId}`, {
                                method: 'POST',
                                headers: headers
                            });
        if (response.ok) {
                                alert("Đã đóng phiếu thành công!");
                                loadTicketList();
                                $chatHeader.hide();
                                clearSearch(); // (MỚI) Xóa tìm kiếm
                                $chatSearchBar.hide(); // (MỚI) Ẩn thanh tìm kiếm
        $chatHistory.html('<div class="empty-state">Phiếu đã đóng. Vui lòng chọn phiếu khác.</div>');
                                $summaryCardContent.html('<div class="empty-state">Phiếu đã đóng.</div>');
                                $chatInput.prop('disabled', true);
        $sendButton.prop('disabled', true);
                                $resolveButton.prop('disabled', true);
                                currentTicketId = null;
                                currentGroupName = null;
                                currentTicketData = null;
        } else {
                                alert("Không thể đóng phiếu.");
        }
                        } catch (error) {
                            console.error('Lỗi khi đóng phiếu:', error);
        } finally {
                            $resolveButton.prop('disabled', false).text("Đã xử lý");
        }
                    });

        $ticketSearchInput.on('keyup', function () {
                        const searchTerm = $(this).val().toLowerCase();
                        $ticketListContainer.find('.ticket-item').each(function () {
                            const customerName = $(this).find('strong').text().toLowerCase();
                            const preview = $(this).find('.ticket-preview').text().toLowerCase();
                            if (customerName.includes(searchTerm) || preview.includes(searchTerm)) {
                                $(this).show();
                            } else {
                                $(this).hide();
                            }
                        });
                    });

                    // === (MỚI) SỰ KIỆN CHO THANH TÌM KIẾM CTRL+F ===

                    // 5. Bấm icon search trên header
                    $chatSearchIcon.on('click', function () {
                        $chatSearchBar.slideToggle(200);
                        if ($chatSearchBar.is(':visible')) {
                            $chatSearchInput.focus();
                        } else {
                            clearSearch(); // Xóa khi đóng
                        }
                    });

                    // 6. Bấm nút X (đóng)
                    $chatSearchClose.on('click', function () {
                        $chatSearchBar.slideUp(200);
                        clearSearch();
                    });

                    // 7. Gõ vào ô tìm kiếm
                    $chatSearchInput.on('input', function () {
                        performSearch();
                    });

                    // 8. Bấm nút Next
                    $chatSearchNext.on('click', function () {
                        if (searchMatches.length === 0) return;
                        currentSearchIndex++;
                        if (currentSearchIndex >= searchMatches.length) {
                            currentSearchIndex = 0; // Quay về đầu
                        }
                        updateSearchState();
                    });

                    // 9. Bấm nút Prev
                    $chatSearchPrev.on('click', function () {
                        if (searchMatches.length === 0) return;
                        currentSearchIndex--;
                        if (currentSearchIndex < 0) {
                            currentSearchIndex = searchMatches.length - 1; // Về cuối
                        }
                        updateSearchState();
                    });

                    // === KHỞI CHẠY ===
        startConnection();
        loadTicketList();
        });
    </script>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\HoTroKhachHangView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/employee/HoTroKhachHangView.cshtml.cs
using CafebookModel.Model.ModelWeb.QuanLy;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.Extensions.Configuration;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Net.Http.Headers;
using Microsoft.AspNetCore.Http;

namespace WebCafebookApi.Pages.employee
{
    // [Authorize(Roles = "NhanVien,QuanLy")]
    public class HoTroKhachHangViewModel : PageModel
    {
        private readonly IConfiguration _configuration;

        // Xóa IHttpClientFactory vì JS sẽ gọi trực tiếp
        public HoTroKhachHangViewModel(IConfiguration configuration)
        {
            _configuration = configuration;
        }

        // Xóa [BindProperty] Id và TicketData, JS sẽ quản lý

        public string ApiBaseUrl { get; set; } = "";
        public string? JwtToken { get; set; } // Token của nhân viên

        public void OnGet()
        {
            // Trang này giờ chỉ cần tải, không cần nạp dữ liệu cụ thể
            ApiBaseUrl = _configuration["ApiBaseUrl"] ?? "http://localhost:5166";

            // Giả định token của nhân viên được lưu trong session
            JwtToken = HttpContext.Session.GetString("JwtToken");

            // Không cần gọi API ở đây nữa
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\QuanLyGiaoHangView.cshtml
================================================================================
﻿@page "/Employee/QuanLyGiaoHang"
@model WebCafebookApi.Pages.employee.QuanLyGiaoHangViewModel
@{
    ViewData["Title"] = "Quản lý Giao Hàng";
    Layout = "_Layout_Employee";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-primary"><span class="material-symbols-outlined align-middle fs-2">local_shipping</span> Quản lý Giao Hàng</h2>
    @if (Model.Status == "Chờ xác nhận" && Model.GiaoHangData.DonGiaoHang.Any())
    {
        <form method="post" asp-page-handler="ConfirmAll">
            <button class="btn btn-success"><span class="material-symbols-outlined align-middle">done_all</span> Xác nhận tất cả</button>
        </form>
    }
</div>

@if (TempData["Message"] != null)
{
    <div class="alert alert-success">@TempData["Message"]</div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}

<ul class="nav nav-tabs mb-4">
    @foreach (var tab in Model.StatusTabs)
    {
        <li class="nav-item">
            <a class="nav-link @(Model.Status == tab ? "active fw-bold" : "")"
               asp-page="./QuanLyGiaoHangView" asp-route-Status="@tab">@tab</a>
        </li>
    }
</ul>

<form method="get" class="mb-3 d-flex gap-2">
    <input type="hidden" name="Status" value="@Model.Status" />
    <input type="text" name="Search" value="@Model.Search" class="form-control" placeholder="Tìm theo Mã HĐ, Tên hoặc SĐT..." />
    <button class="btn btn-primary">Tìm kiếm</button>
</form>

<div class="card shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th>#ID</th>
                        <th>Thời gian</th>
                        <th>Khách hàng</th>
                        <th>Địa chỉ</th>
                        <th>Tổng tiền</th>
                        <th>TT Giao Hàng</th>
                        <th>Shipper</th>
                        <th class="text-end">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!Model.GiaoHangData.DonGiaoHang.Any())
                    {
                        <tr><td colspan="8" class="text-center py-5 text-muted">Không có đơn hàng nào.</td></tr>
                    }
                    @foreach (var item in Model.GiaoHangData.DonGiaoHang)
                    {
                        <tr>
                            <td class="fw-bold">@item.IdHoaDon</td>
                            <td>@item.ThoiGianTao.ToString("HH:mm dd/MM")</td>
                            <td>
                                <div>@item.TenKhachHang</div>
                                <small class="text-muted">@item.SoDienThoaiGiaoHang</small>
                            </td>
                            <td class="text-truncate" style="max-width: 200px;" title="@item.DiaChiGiaoHang">@item.DiaChiGiaoHang</td>
                            <td class="text-danger fw-bold">@item.ThanhTien.ToString("N0") đ</td>
                            <td><span class="badge bg-info text-dark">@item.TrangThaiGiaoHang</span></td>
                            <td>@(item.TenNguoiGiaoHang ?? "-")</td>
                            <td class="text-end">
                                <form method="post" asp-page-handler="UpdateStatus" class="d-inline-flex gap-2 align-items-center">
                                    <input type="hidden" name="idHoaDon" value="@item.IdHoaDon" />

                                    @if (item.TrangThaiGiaoHang == "Chờ xác nhận")
                                    {
                                        <button name="newStatus" value="Đang chuẩn bị" class="btn btn-sm btn-primary">Xác nhận</button>
                                    }
                                    else if (item.TrangThaiGiaoHang == "Chờ lấy hàng")
                                    {
                                        <select name="shipperId" class="form-select form-select-sm w-auto" required>
                                            <option value="">Chọn Shipper</option>
                                            @foreach (var s in Model.GiaoHangData.NguoiGiaoHangSanSang)
                                            {
                                                <option value="@s.IdNguoiGiaoHang" selected="@(s.IdNguoiGiaoHang == item.IdNguoiGiaoHang)">@s.TenNguoiGiaoHang</option>
                                            }
                                        </select>
                                        <button name="newStatus" value="Đang giao" class="btn btn-sm btn-info text-white">Giao đi</button>
                                    }
                                    else if (item.TrangThaiGiaoHang == "Đang giao")
                                    {
                                        <button type="button" class="btn btn-sm btn-success" onclick="openCompleteModal(@item.IdHoaDon, '@item.TenKhachHang')">
                                            <span class="material-symbols-outlined align-middle fs-6">check_circle</span> Hoàn thành
                                        </button>
                                    }

                                    @if (item.TrangThaiGiaoHang != "Hoàn thành" && item.TrangThaiGiaoHang != "Đã hủy")
                                    {
                                        <button name="newStatus" value="Hủy" class="btn btn-sm btn-outline-danger" onclick="return confirm('Hủy đơn này?')">Hủy</button>
                                    }
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="completeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="CompleteOrder" enctype="multipart/form-data">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Xác nhận giao hàng thành công</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" asp-for="OrderIdToComplete" id="modalOrderId" />
                    <p>Khách hàng: <strong id="modalCustomerName"></strong></p>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Ảnh xác nhận (Tùy chọn):</label>
                        <input type="file" asp-for="UploadImage" class="form-control" accept="image/*" />
                        <div class="form-text">Chụp ảnh gói hàng hoặc biên lai đã ký nhận. Lưu vào thư mục: <code>images/anhgiaohang</code></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-success">Hoàn thành ngay</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function openCompleteModal(id, name) {
            document.getElementById('modalOrderId').value = id;
            document.getElementById('modalCustomerName').innerText = name;
            var myModal = new bootstrap.Modal(document.getElementById('completeModal'));
            myModal.show();
        }
    </script>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\QuanLyGiaoHangView.cshtml.cs
================================================================================
﻿using CafebookModel.Model.ModelWeb.QuanLy;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Headers;
using System.Net.Http.Json;

namespace WebCafebookApi.Pages.employee
{
    [Authorize(Roles = "Quản trị viên, Quản lý, Thu ngân, Phục vụ")]
    public class QuanLyGiaoHangViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        public QuanLyGiaoHangViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        public GiaoHangViewDto GiaoHangData { get; set; } = new GiaoHangViewDto();

        [BindProperty(SupportsGet = true)]
        public string? Search { get; set; }

        [BindProperty(SupportsGet = true)]
        public string Status { get; set; } = "Chờ xác nhận";

        // Để upload ảnh
        [BindProperty]
        public IFormFile? UploadImage { get; set; }

        [BindProperty]
        public int OrderIdToComplete { get; set; }

        [TempData]
        public string? Message { get; set; }
        [TempData]
        public string? ErrorMessage { get; set; }

        public string[] StatusTabs { get; set; } = {
            "Chờ xác nhận", "Đang chuẩn bị", "Chờ lấy hàng",
            "Đang giao", "Hoàn thành", "Đã Hủy", "Tất cả"
        };

        public async Task<IActionResult> OnGetAsync()
        {
            var client = _httpClientFactory.CreateClient("ApiClient");
            try
            {
                var result = await client.GetFromJsonAsync<GiaoHangViewDto>($"api/web/quanly/giaohang/load?search={Search}&status={Status}");
                if (result != null) GiaoHangData = result;
            }
            catch (Exception ex)
            {
                ErrorMessage = "Không thể tải dữ liệu: " + ex.Message;
            }
            return Page();
        }

        // Hành động cập nhật trạng thái đơn giản
        public async Task<IActionResult> OnPostUpdateStatusAsync(int idHoaDon, string newStatus, int? shipperId)
        {
            var client = _httpClientFactory.CreateClient("ApiClient");
            using var content = new MultipartFormDataContent();
            content.Add(new StringContent(newStatus), "TrangThaiGiaoHang");
            if (shipperId.HasValue) content.Add(new StringContent(shipperId.ToString()!), "IdNguoiGiaoHang");

            var res = await client.PostAsync($"api/web/quanly/giaohang/update/{idHoaDon}", content);
            if (res.IsSuccessStatusCode) Message = "Cập nhật thành công!";
            else ErrorMessage = "Lỗi cập nhật.";

            return RedirectToPage(new { Search, Status });
        }

        // Hành động Hoàn thành (kèm ảnh)
        public async Task<IActionResult> OnPostCompleteOrderAsync()
        {
            var client = _httpClientFactory.CreateClient("ApiClient");
            using var content = new MultipartFormDataContent();
            content.Add(new StringContent("Hoàn thành"), "TrangThaiGiaoHang");

            if (UploadImage != null)
            {
                var fileContent = new StreamContent(UploadImage.OpenReadStream());
                fileContent.Headers.ContentType = new MediaTypeHeaderValue(UploadImage.ContentType);
                content.Add(fileContent, "HinhAnhXacNhan", UploadImage.FileName);
            }

            var res = await client.PostAsync($"api/web/quanly/giaohang/update/{OrderIdToComplete}", content);
            if (res.IsSuccessStatusCode) Message = "Đã hoàn thành đơn hàng!";
            else ErrorMessage = "Lỗi khi hoàn thành đơn.";

            return RedirectToPage(new { Search, Status });
        }

        public async Task<IActionResult> OnPostConfirmAllAsync()
        {
            var client = _httpClientFactory.CreateClient("ApiClient");
            await client.PostAsync("api/web/quanly/giaohang/confirm-all-pending", null);
            Message = "Đã xác nhận tất cả đơn.";
            return RedirectToPage(new { Status = "Đang chuẩn bị" });
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\ShipperGiaoHangView.cshtml
================================================================================
﻿@page "/Employee/ShipperGiaoHangView"
@model WebCafebookApi.Pages.employee.ShipperGiaoHangViewModel
@{
    ViewData["Title"] = "Ứng dụng Shipper";
    Layout = "_Layout_Employee";
}

@section Styles {
    <style>
        /* CSS tối ưu cho Mobile */
        .shipper-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 1rem;
            transition: transform 0.2s;
        }

            .shipper-card:active {
                transform: scale(0.98);
            }

        .card-header-ship {
            background-color: #fff;
            border-bottom: 1px dashed #eee;
            padding: 1rem;
            border-radius: 12px 12px 0 0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-body-ship {
            padding: 1rem;
            background-color: #fff;
        }

        .info-row {
            display: flex;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .info-icon {
            width: 24px;
            color: var(--cf-orange);
            margin-right: 8px;
        }

        .btn-action-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 0 0 12px 12px;
        }

        .btn-lg-mobile {
            padding: 12px;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .nav-pills .nav-link {
            border-radius: 20px;
            padding: 8px 20px;
            font-weight: 600;
        }

            .nav-pills .nav-link.active {
                background-color: var(--cf-orange);
            }
    </style>
}

<div class="container py-3 px-2" style="max-width: 600px;">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-0">Xin chào, Shipper!</h4>
            <small class="text-muted">Chúc bạn một ngày làm việc an toàn.</small>
        </div>
        <a asp-page="/Employee/WebQuanLyView" class="btn btn-outline-secondary btn-sm rounded-circle" style="width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center;">
            <span class="material-symbols-outlined">home</span>
        </a>
    </div>

    @if (TempData["Message"] != null)
    {
        <div class="alert alert-success shadow-sm">@TempData["Message"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger shadow-sm">@TempData["Error"]</div>
    }

    <ul class="nav nav-pills mb-4 justify-content-center bg-white p-2 rounded-pill shadow-sm" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pills-my-tab" data-bs-toggle="pill" data-bs-target="#pills-my" type="button">
                Đang giao <span class="badge bg-white text-danger rounded-pill ms-1">@Model.MyOrders.Count</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pills-new-tab" data-bs-toggle="pill" data-bs-target="#pills-new" type="button">
                Đơn mới <span class="badge bg-secondary rounded-pill ms-1">@Model.AvailableOrders.Count</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pills-history-tab" data-bs-toggle="pill" data-bs-target="#pills-history" type="button">
                Lịch sử
            </button>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade" id="pills-history">

            <div class="card bg-primary text-white shadow-sm mb-4 rounded-3 border-0">
                <div class="card-body text-center">
                    <h6 class="opacity-75 mb-1">TỔNG TIỀN MẶT (COD) CẦN NỘP</h6>
                    <h1 class="fw-bold display-4 mb-0">@Model.HistoryData.TongTienMatCam.ToString("N0")</h1>
                    <span class="fs-5">VNĐ</span>
                    <div class="mt-3 d-flex justify-content-center gap-4 border-top border-white border-opacity-25 pt-3">
                        <div>
                            <strong class="d-block fs-5">@Model.HistoryData.TongDonHoanThanh</strong>
                            <small class="opacity-75">Đã giao</small>
                        </div>
                        <div>
                            <strong class="d-block fs-5">@Model.HistoryData.TongDonHuy</strong>
                            <small class="opacity-75">Đã hủy</small>
                        </div>
                    </div>
                </div>
            </div>

            <h6 class="fw-bold text-muted ms-2 mb-3">DANH SÁCH HÔM NAY</h6>

            @if (!Model.HistoryData.LichSuDonHang.Any())
            {
                <div class="text-center py-4 text-muted">Chưa có lịch sử giao hàng hôm nay.</div>
            }
            else
            {
                @foreach (var item in Model.HistoryData.LichSuDonHang)
                {
                    <div class="card shipper-card border-start border-5 @(item.TrangThaiGiaoHang == "Hoàn thành" ? "border-success" : "border-danger")">
                        <div class="card-body-ship p-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="fw-bold text-dark">#@item.IdHoaDon</span>
                                <span class="badge @(item.TrangThaiGiaoHang == "Hoàn thành" ? "bg-success" : "bg-danger")">
                                    @item.TrangThaiGiaoHang
                                </span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="small text-muted mb-1">@item.ThoiGianTao.ToString("HH:mm") - @item.TenKhachHang</div>
                                    <div class="fw-bold text-primary">
                                        @if (item.GhiChu == "COD")
                                        {
                                            <span class="material-symbols-outlined align-middle fs-6">payments</span>
                                        }
                                        else
                                        {

                                            <span class="material-symbols-outlined align-middle fs-6">credit_card</span>
                                        }
                                        @item.GhiChu
                                    </div>
                                </div>
                                <div class="text-end">
                                    <span class="d-block fw-bold text-dark">@item.ThanhTien.ToString("N0")đ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>

    <div class="tab-content" id="pills-tabContent">

        <div class="tab-pane fade show active" id="pills-my">
            @if (!Model.MyOrders.Any())
            {
                <div class="text-center py-5 text-muted">
                    <span class="material-symbols-outlined fs-1 text-secondary opacity-50">local_shipping</span>
                    <p class="mt-2">Bạn chưa nhận đơn nào.</p>
                </div>
            }
            else
            {
                @foreach (var item in Model.MyOrders)
                {
                    <div class="card shipper-card border-warning border-2">
                        <div class="card-header-ship">
                            <span class="text-primary">#@item.IdHoaDon</span>
                            <span class="badge bg-warning text-dark">Đang giao</span>
                        </div>
                        <div class="card-body-ship">
                            <div class="info-row">
                                <span class="material-symbols-outlined info-icon">person</span>
                                <span class="fw-bold">@item.TenKhachHang</span>
                            </div>
                            <div class="info-row">
                                <span class="material-symbols-outlined info-icon">call</span>
                                <a href="tel:@item.SoDienThoaiGiaoHang" class="text-decoration-none">@item.SoDienThoaiGiaoHang</a>
                            </div>
                            <div class="info-row">
                                <span class="material-symbols-outlined info-icon">location_on</span>
                                <span class="text-break">@item.DiaChiGiaoHang</span>
                            </div>
                            <div class="info-row mt-2 pt-2 border-top">
                                <span class="material-symbols-outlined info-icon">payments</span>
                                <span class="text-danger fw-bold fs-5">Thu: @item.ThanhTien.ToString("N0")đ</span>
                            </div>
                        </div>
                        <div class="btn-action-group">
                            <button class="btn btn-outline-danger btn-lg-mobile" onclick="openFailModal(@item.IdHoaDon)">
                                <span class="material-symbols-outlined">close</span> Thất bại
                            </button>
                            <button class="btn btn-success btn-lg-mobile" onclick="openSuccessModal(@item.IdHoaDon, '@item.TenKhachHang')">
                                <span class="material-symbols-outlined">photo_camera</span> Đã giao
                            </button>
                        </div>
                    </div>
                }
            }
        </div>

        <div class="tab-pane fade" id="pills-new">
            @if (!Model.AvailableOrders.Any())
            {
                <div class="text-center py-5 text-muted">
                    <span class="material-symbols-outlined fs-1 text-secondary opacity-50">inventory_2</span>
                    <p class="mt-2">Chưa có đơn hàng chờ lấy.</p>
                </div>
            }
            else
            {
                @foreach (var item in Model.AvailableOrders)
                {
                    <div class="card shipper-card">
                        <div class="card-header-ship">
                            <span>#@item.IdHoaDon</span>
                            <span class="badge bg-info text-dark">Chờ lấy hàng</span>
                        </div>
                        <div class="card-body-ship">
                            <div class="info-row">
                                <span class="material-symbols-outlined info-icon">schedule</span>
                                <span>@item.ThoiGianTao.ToString("HH:mm dd/MM")</span>
                            </div>
                            <div class="info-row">
                                <span class="material-symbols-outlined info-icon">location_on</span>
                                <span>@item.DiaChiGiaoHang</span>
                            </div>
                            <div class="info-row text-muted small">
                                <span class="material-symbols-outlined info-icon" style="font-size:18px">store</span>
                                <span>Lấy tại quầy pha chế/bếp</span>
                            </div>
                        </div>
                        <div class="p-3 bg-light rounded-bottom">
                            <form method="post" asp-page-handler="Pickup">
                                <input type="hidden" name="idHoaDon" value="@item.IdHoaDon" />
                                <button class="btn btn-primary w-100 btn-lg-mobile">
                                    <span class="material-symbols-outlined">pan_tool_alt</span> NHẬN ĐƠN NÀY
                                </button>
                            </form>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>

<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="post" asp-page-handler="Success" enctype="multipart/form-data">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-success">Xác nhận giao thành công</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="idHoaDon" id="successOrderId" />
                    <p class="mb-3">Khách: <strong id="successCustomerName"></strong></p>

                    <div class="text-center mb-3 p-3 bg-light rounded border border-dashed">
                        <label for="cameraInput" class="d-block cursor-pointer">
                            <span class="material-symbols-outlined fs-1 text-primary display-1">add_a_photo</span>
                            <div class="mt-2 text-primary fw-bold">Chụp ảnh xác nhận</div>
                        </label>
                        <input type="file" asp-for="ProofImage" id="cameraInput" class="d-none" accept="image/*" capture="environment" onchange="previewImage(this)" required />
                        <img id="imgPreview" class="img-fluid mt-3 rounded d-none" style="max-height: 200px;" />
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="submit" class="btn btn-success w-100 py-3 fw-bold">HOÀN TẤT ĐƠN HÀNG</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="failModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="post" asp-page-handler="Fail">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold text-danger">Báo cáo giao thất bại</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="idHoaDon" id="failOrderId" />
                    <label class="form-label fw-bold">Lý do hủy/trả hàng:</label>
                    <select asp-for="CancelReason" class="form-select mb-3" required>
                        <option value="">-- Chọn lý do --</option>
                        <option value="Khách không nghe máy">Khách không nghe máy</option>
                        <option value="Sai địa chỉ/SĐT">Sai địa chỉ / SĐT</option>
                        <option value="Khách bom hàng">Khách bom hàng (từ chối nhận)</option>
                        <option value="Hàng bị hỏng">Hàng bị đổ/hỏng khi vận chuyển</option>
                        <option value="Khác">Lý do khác</option>
                    </select>
                </div>
                <div class="modal-footer border-0">
                    <button type="submit" class="btn btn-danger w-100 py-3 fw-bold">XÁC NHẬN HỦY</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function openSuccessModal(id, name) {
            document.getElementById('successOrderId').value = id;
            document.getElementById('successCustomerName').innerText = name;
            // Reset ảnh preview
            document.getElementById('imgPreview').classList.add('d-none');
            document.getElementById('imgPreview').src = '';
            new bootstrap.Modal(document.getElementById('successModal')).show();
        }

        function openFailModal(id) {
            document.getElementById('failOrderId').value = id;
            new bootstrap.Modal(document.getElementById('failModal')).show();
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    var img = document.getElementById('imgPreview');
                    img.src = e.target.result;
                    img.classList.remove('d-none');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
    </script>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\ShipperGiaoHangView.cshtml.cs
================================================================================
﻿using CafebookModel.Model.ModelWeb.QuanLy;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Headers;
using System.Security.Claims;

namespace WebCafebookApi.Pages.employee
{
    //[Authorize(Roles = "GiaoHang,PhucVu,QuanLy,QuanTriVien")]
    [Authorize]
    public class ShipperGiaoHangViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;
        public ShipperHistorySummaryDto HistoryData { get; set; } = new ShipperHistorySummaryDto();
        // Vẫn giữ ID 5 để đánh dấu loại hình là "Nội bộ"
        private const int INTERNAL_SHIPPER_TYPE_ID = 5;

        public ShipperGiaoHangViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        public List<GiaoHangItemDto> MyOrders { get; set; } = new List<GiaoHangItemDto>();
        public List<GiaoHangItemDto> AvailableOrders { get; set; } = new List<GiaoHangItemDto>();

        [BindProperty] public IFormFile? ProofImage { get; set; }
        [BindProperty] public string? CancelReason { get; set; }
        [TempData] public string? Message { get; set; }
        [TempData] public string? Error { get; set; }

        private int GetCurrentUserId()
        {
            var claim = User.FindFirst(ClaimTypes.NameIdentifier);
            return claim != null && int.TryParse(claim.Value, out int id) ? id : 0;
        }

        public async Task<IActionResult> OnGetAsync()
        {
            var userId = GetCurrentUserId();
            if (userId == 0) return RedirectToPage("/Account/Login");

            var client = _httpClientFactory.CreateClient("ApiClient");
            try
            {
                var result = await client.GetFromJsonAsync<GiaoHangViewDto>("api/web/quanly/giaohang/load?status=Tất cả");

                if (result != null)
                {
                    // 1. Đơn chờ lấy: 
                    // - Chưa có nhân viên nào nhận (IdNhanVien == null)
                    // - HOẶC đã gán cho chính mình (IdNhanVien == userId)
                    AvailableOrders = result.DonGiaoHang
                        .Where(x => x.TrangThaiGiaoHang == "Chờ lấy hàng" &&
                                   (x.IdNhanVien == null || x.IdNhanVien == userId))
                        .OrderByDescending(x => x.ThoiGianTao)
                        .ToList();

                    // 2. Đơn CỦA TÔI:
                    // - Phải là đơn mà CHÍNH TÔI đang giữ (IdNhanVien == userId)
                    MyOrders = result.DonGiaoHang
                        .Where(x => x.IdNhanVien == userId && x.TrangThaiGiaoHang == "Đang giao")
                        .OrderBy(x => x.ThoiGianTao)
                        .ToList();
                }
                // 2. THÊM MỚI: Tải lịch sử & Tổng tiền
                var historyResult = await client.GetFromJsonAsync<ShipperHistorySummaryDto>("api/web/quanly/giaohang/shipper-history");
                if (historyResult != null)
                {
                    HistoryData = historyResult;
                }
            }
            catch (Exception ex) { Error = "Lỗi: " + ex.Message; }
            return Page();
        }

        public async Task<IActionResult> OnPostPickupAsync(int idHoaDon)
        {
            var userId = GetCurrentUserId();
            var client = _httpClientFactory.CreateClient("ApiClient");

            using var content = new MultipartFormDataContent();
            content.Add(new StringContent("Đang giao"), nameof(GiaoHangUpdateRequestDto.TrangThaiGiaoHang));

            // Lưu loại hình là "Nội bộ" (ID=5) để thống kê
            content.Add(new StringContent(INTERNAL_SHIPPER_TYPE_ID.ToString()), nameof(GiaoHangUpdateRequestDto.IdNguoiGiaoHang));

            // QUAN TRỌNG: Lưu chính xác ID của Shipper (bạn) vào hóa đơn
            content.Add(new StringContent(userId.ToString()), nameof(GiaoHangUpdateRequestDto.IdNhanVien));

            try
            {
                var res = await client.PostAsync($"api/web/quanly/giaohang/update/{idHoaDon}", content);
                if (res.IsSuccessStatusCode) Message = "Đã nhận đơn thành công!";
                else Error = "Lỗi API: " + res.ReasonPhrase;
            }
            catch (Exception ex) { Error = "Lỗi kết nối: " + ex.Message; }

            return RedirectToPage();
        }

        // ... (Các hàm OnPostSuccessAsync và OnPostFailAsync giữ nguyên như cũ) ...
        // Lưu ý: Không cần sửa OnPostSuccessAsync vì nó chỉ cập nhật trạng thái và ảnh, 
        // IdNhanVien đã được gán lúc Pickup rồi.

        public async Task<IActionResult> OnPostSuccessAsync(int idHoaDon)
        {
            if (ProofImage == null) { Error = "Thiếu ảnh."; return RedirectToPage(); }

            var client = _httpClientFactory.CreateClient("ApiClient");
            using var content = new MultipartFormDataContent();
            content.Add(new StringContent("Hoàn thành"), nameof(GiaoHangUpdateRequestDto.TrangThaiGiaoHang));

            var fileContent = new StreamContent(ProofImage.OpenReadStream());
            fileContent.Headers.ContentType = new MediaTypeHeaderValue(ProofImage.ContentType);
            content.Add(fileContent, nameof(GiaoHangUpdateRequestDto.HinhAnhXacNhan), ProofImage.FileName);

            var res = await client.PostAsync($"api/web/quanly/giaohang/update/{idHoaDon}", content);
            if (res.IsSuccessStatusCode) Message = "Đã hoàn thành đơn!";
            else Error = "Lỗi cập nhật.";
            return RedirectToPage();
        }

        public async Task<IActionResult> OnPostFailAsync(int idHoaDon)
        {
            var client = _httpClientFactory.CreateClient("ApiClient");
            using var content = new MultipartFormDataContent();
            content.Add(new StringContent("Hủy"), nameof(GiaoHangUpdateRequestDto.TrangThaiGiaoHang));
            var res = await client.PostAsync($"api/web/quanly/giaohang/update/{idHoaDon}", content);
            if (res.IsSuccessStatusCode) Message = "Đã hủy đơn.";
            else Error = "Lỗi cập nhật.";
            return RedirectToPage();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\SoDoBanView.cshtml
================================================================================
﻿@page "/Employee/SoDoBan"
@model WebCafebookApi.Pages.employee.SoDoBanViewModel
@{
    ViewData["Title"] = "Sơ Đồ Bàn";
    Layout = "_Layout_Employee";
}

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}
else
{
    <div class="sodoban-layout-container">

        <nav class="sodoban-khuvuc-tabs card">
            <div class="card-body">
                <h6 class="px-3 text-muted text-uppercase small">Khu Vực</h6>
                <ul class="nav flex-column nav-pills">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-khuvuc-id="all">
                            <span class="material-symbols-outlined">apps</span>
                            Tất cả Khu Vực
                        </a>
                    </li>
                    <li class="nav-item"><hr class="my-1 mx-3"></li>
                    @foreach (var kv in Model.KhuVucList)
                    {
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-khuvuc-id="@kv.IdKhuVuc">
                                <span class="material-symbols-outlined">label</span>
                                @kv.TenKhuVuc
                            </a>
                        </li>
                    }
                </ul>
            </div>
        </nav>

        <div class="sodoban-content">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1 class="page-title" style="border: none; margin: 0;">@ViewData["Title"]</h1>
                <div class="d-none d-md-flex small">
                    <div class="me-3"><span class="status-box status-trong"></span> Trống</div>
                    <div class="me-3"><span class="status-box status-co-khach"></span> Có khách</div>
                    <div class="me-3"><span class="status-box status-da-dat"></span> Đã đặt</div>
                    <div class="me-3"><span class="status-box status-bao-tri"></span> Bảo trì</div>
                </div>
            </div>

            <div id="table-layout-container" class="sodoban-grid" data-nhanvien-id="@Model.NhanVienId">
                <!-- Bàn sẽ được render bởi JS -->
            </div>
        </div>

        <div class="sodoban-panel">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-body p-4">

                    <div id="panel-selection-mode" class="text-center" style="display: none;">
                        <h5 id="selection-text-header" class="fw-bold">...</h5>
                        <p class="text-muted small">Vui lòng chọn một bàn trên sơ đồ để tiếp tục.</p>
                        <hr/>
                        <button id="btn-cancel-select" class="btn btn-danger w-100">
                            <span class="material-symbols-outlined">close</span> Hủy Thao Tác
                        </button>
                    </div>

                    <div id="panel-no-selection" class="text-center p-4">
                        <span class="material-symbols-outlined" style="font-size: 48px; color: var(--cf-gray-light);">touch_app</span>
                        <p class="text-muted mt-2">Chọn một bàn để xem thao tác.</p>
                    </div>

                    <div id="panel-da-chon" style="display: none;">
                        <span class="text-muted fw-bold small">Thông Tin Bàn</span>
                        <h2 class="fw-bold mt-1" style="color: var(--cf-brown);">Bàn <span id="ban-so-ban"></span></h2>
                        <p id="ban-trang-thai" class="badge bg-success fs-6 mb-2">Trống</p>
                        
                        <div id="ban-dat-truoc-group" class="alert alert-warning py-2 px-3 small" style="display:none;">
                            <span class="material-symbols-outlined" style="font-size: 1rem; vertical-align: text-bottom; margin-right: 4px;">bookmark_added</span>
                            <span id="ban-thong-tin-dat-ban"></span>
                        </div>
                        
                        <div id="ban-ghi-chu-group" class="alert alert-secondary py-2 px-3 small" style="display:none;">
                            <strong class="text-muted">Ghi chú:</strong>
                            <p id="ban-ghi-chu" class="fst-italic mb-0" style="color: var(--cf-text);"></p>
                        </div>
                         
                        <div id="ban-tong-tien-group" class="mt-2" style="display:none;">
                            <span class="text-muted small">Tổng tiền tạm tính:</span>
                            <h4 id="ban-tong-tien" class="text-danger fw-bold mb-0">0 đ</h4>
                        </div>

                        <hr class="my-3" />

                        <div class="d-grid gap-2">
                            <button id="btn-goi-mon-cu" class="btn btn-primary btn-lg p-3">
                                <span class="material-symbols-outlined">add_shopping_cart</span> 
                                <span id="btn-goi-mon-text-main">Gọi Món / Thanh Toán</span>
                            </button>
                            <div class="row g-2 mt-2">
                                <div class="col-6 d-grid">
                                    <button id="btn-chuyen-ban" class="btn btn-outline-secondary p-3">
                                        <span class="material-symbols-outlined">swap_horiz</span> Chuyển Bàn
                                    </button>
                                </div>
                                <div class="col-6 d-grid">
                                    <button id="btn-gop-ban" class="btn btn-outline-secondary p-3">
                                        <span class="material-symbols-outlined">merge_type</span> Gộp Bàn
                                    </button>
                                </div>
                            </div>
                            <button id="btn-bao-cao-su-co" class="btn btn-outline-warning p-3 mt-2">
                                <span class="material-symbols-outlined">warning</span> Báo cáo Sự cố
                            </button>
                            <button id="refresh-tables-btn" class="btn btn-link text-muted mt-3">
                                <span class="material-symbols-outlined">refresh</span> Làm mới Sơ đồ
                            </button>
                        </div>
                    </div>
                </div>
             </div>
        </div>
    </div>
}

@section Scripts {
<script>
    // --- KHỞI TẠO BIẾN TOÀN CỤC ---
    const khuVucData = @Json.Serialize(Model.KhuVucList);
    const allTables = [];
    khuVucData.forEach(kv => {
        if (kv.bans) {
            allTables.push(...kv.bans);
        }
    });

    const apiBaseUrl = "http://localhost:5166/api/web/quanly/sodoban";
    const currentNhanVienId = $("#table-layout-container").data("nhanvien-id");
    const jwtToken = @Json.Serialize(Model.JwtToken);
    
    let currentSelectedBan = null;
    let currentMode = "none"; // 'none', 'chuyen', 'gop'
    let sourceHoaDonId = null;

    // --- HÀM TIỆN ÍCH ---
    function formatCurrency(number) {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(number);
    }

    // --- HÀM RENDER VÀ CẬP NHẬT UI ---
    function renderTables(banList) {
        const $container = $("#table-layout-container");
        $container.empty(); 

        if (!banList || banList.length === 0) {
            $container.append('<p class="text-muted text-center w-100 p-5">Khu vực này không có bàn nào.</p>');
            return;
        }

        banList.forEach(ban => {
            let statusClass = "status-trong";
            let icon = "event_seat"; // Icon mặc định
            let infoHtml = `<div class="table-status">${ban.trangThai}</div>`;

            switch (ban.trangThai.toLowerCase()) {
                case "có khách":
                    statusClass = "status-co-khach";
                    icon = "people";
                    if(ban.tongTien > 0) { 
                        infoHtml = `<div class="table-status-price">${formatCurrency(ban.tongTien)}</div>`; 
                    }
                    break;
                case "đã đặt":
                    statusClass = "status-da-dat";
                    icon = "book_online";
                    break;
                case "bảo trì":
                    statusClass = "status-bao-tri";
                    icon = "build";
                    break;
            }
            
            let datBanHtml = '';
            if (ban.thongTinDatBan && ban.trangThai.toLowerCase() !== 'có khách') { 
                datBanHtml = `<div class="table-booked-info">${ban.thongTinDatBan}</div>`; 
            }

            // Gắn data-ban-id (Cách này an toàn 100%)
            const cardHtml = `
                <div class="table-card ${statusClass}" data-ban-id="${ban.idBan}">
                    <div class="table-icon">
                        <span class="material-symbols-outlined">${icon}</span>
                    </div>
                    <h5 class="table-name">${ban.soBan}</h5>
                    ${infoHtml}
                    ${datBanHtml}
                </div>
            `;
            const $card = $(cardHtml);
            
            // Chúng ta vẫn gắn data-ban-json để dự phòng,
            // nhưng sẽ ưu tiên dùng allTables.find()
            $card.data('ban-json', ban); 
            $container.append($card);
        });
    }

    function updatePanel(ban) {
        // Guard clause: Nếu ban không có data (do lỗi)
        if (!ban || !ban.soBan) {
            console.error("Lỗi: Dữ liệu bàn (banData) bị rỗng khi gọi updatePanel.");
            resetPanel();
            return;
        }

        currentSelectedBan = ban;
        $("#panel-no-selection").hide();
        $("#panel-selection-mode").hide();
        $("#panel-da-chon").show();

        $("#ban-so-ban").text(ban.soBan);
        const $statusBadge = $("#ban-trang-thai");
        $statusBadge.text(ban.trangThai).removeClass('bg-success bg-danger bg-warning bg-secondary');

        $("#ban-ghi-chu-group, #ban-dat-truoc-group, #ban-tong-tien-group").hide();
        $("#btn-goi-mon-cu, #btn-chuyen-ban, #btn-gop-ban, #btn-bao-cao-su-co").hide().prop('disabled', false);
        // Reset lại text nút sự cố
        $("#btn-bao-cao-su-co").text("Báo cáo Sự cố").prepend('<span class="material-symbols-outlined">warning</span>');

        switch (ban.trangThai.toLowerCase()) {
            case "trống":
                $statusBadge.addClass('bg-success');
                $("#btn-goi-mon-cu").show().find('#btn-goi-mon-text-main').text("Tạo Hóa Đơn Mới");
                $("#btn-bao-cao-su-co").show();
                break;
            case "có khách":
                $statusBadge.addClass('bg-danger');
                $("#btn-goi-mon-cu").show().find('#btn-goi-mon-text-main').text("Gọi Món / Thanh Toán");
                $("#btn-chuyen-ban, #btn-gop-ban, #ban-tong-tien-group").show();
                $("#ban-tong-tien").text(formatCurrency(ban.tongTien)); 
                break;
            case "đã đặt":
                $statusBadge.addClass('bg-warning');
                $("#btn-goi-mon-cu").show().find('#btn-goi-mon-text-main').text("Khách đến (Mở Bàn)");
                $("#btn-bao-cao-su-co").show(); 
                if (ban.thongTinDatBan) { 
                    $("#ban-dat-truoc-group").show();
                    $("#ban-thong-tin-dat-ban").text(ban.thongTinDatBan); 
                }
                break;
            default: // Bảo trì
                $statusBadge.addClass('bg-secondary');
                if (ban.ghiChu) { 
                    $("#ban-ghi-chu-group").show();
                    $("#ban-ghi-chu").text(ban.ghiChu); 
                }
                $("#btn-bao-cao-su-co").show().text("Hủy Bảo Trì").prepend('<span class="material-symbols-outlined">build_circle</span>');
                break;
        }
    }

    function resetPanel() {
        currentSelectedBan = null;
        currentMode = "none";
        sourceHoaDonId = null;
        $("#panel-no-selection").show();
        $("#panel-da-chon, #panel-selection-mode").hide();
        $(".table-card").removeClass("selected dimmed");
    }

    function startSelectionMode(mode, instructionText) {
        currentMode = mode;
        sourceHoaDonId = currentSelectedBan.idHoaDonHienTai; 
        $("#panel-no-selection, #panel-da-chon").hide();
        $("#panel-selection-mode").show();
        $("#selection-text-header").text(instructionText);

        $(".table-card").addClass("dimmed");
        let $validTargets = (mode === 'chuyen') 
            ? $(".table-card.status-trong") 
            : $(".table-card.status-co-khach:not(.selected)");
        $validTargets.removeClass("dimmed");
    }
    
    // (Hàm callApi không thay đổi)
    async function callApi(endpoint, method, data) {
        if (!jwtToken) {
            alert("Lỗi: Không tìm thấy token xác thực. Vui lòng đăng nhập lại.");
            window.location.href = "/account/DangNhapView";
            return null;
        }
        try {
             const response = await fetch(`${apiBaseUrl}/${endpoint}`, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`
                },
                body: data ? JSON.stringify(data) : null
            });
            if (response.status === 401) {
                alert("Phiên đăng nhập API đã hết hạn. Vui lòng đăng nhập lại.");
                window.location.href = "/account/DangNhapView";
                return null;
            }
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || `Lỗi ${response.status}`);
            }
            const contentType = response.headers.get("content-type");
            return (contentType && contentType.includes("application/json"))
                ? await response.json()
                : { success: true, message: await response.text() };
        } catch (error) {
            console.error('Lỗi API:', error);
            alert(`Thao tác thất bại: ${error.message}`);
            return null;
        }
    }

    // (Hàm handleTableClick không thay đổi)
    async function handleTableClick($card, banData) {
        if (currentMode === "none") {
            $(".table-card").removeClass("selected");
            $card.addClass("selected"); 
            updatePanel(banData);
        } else {
            let confirmText = '', apiEndpoint = '', requestData = {};
            if (currentMode === 'chuyen') {
                if (banData.trangThai.toLowerCase() !== 'trống') return alert("Bàn đích phải là [Bàn Trống].");
                confirmText = `Bạn chắc chắn muốn CHUYỂN [${currentSelectedBan.soBan}] sang [${banData.soBan}]?`;
                apiEndpoint = 'move-table';
                requestData = { idHoaDonNguon: sourceHoaDonId, idBanDich: banData.idBan };
            } else if (currentMode === 'gop') {
                if (banData.trangThai.toLowerCase() !== 'có khách') return alert("Bàn đích phải là [Bàn Có Khách].");
                if (banData.idBan === currentSelectedBan.idBan) return alert("Không thể gộp bàn vào chính nó.");
                confirmText = `Bạn chắc chắn muốn GỘP [${currentSelectedBan.soBan}] vào [${banData.soBan}]?`;
                apiEndpoint = 'merge-table';
                requestData = { idHoaDonNguon: sourceHoaDonId, idHoaDonDich: banData.idHoaDonHienTai };
            }

            if (confirm(confirmText)) {
                const result = await callApi(apiEndpoint, 'POST', requestData);
                if (result) {
                    alert(result.message || "Thao tác thành công!");
                    location.reload(); 
                }
            }
            resetPanel();
        }
    }

    // --- SỬA LỖI RACE CONDITION (ICON FONT) + HOT RELOAD ---
    // Bọc toàn bộ code thực thi trong $(window).on('load')
    $(window).on('load', function () {
    
        // 1. Gắn sự kiện (luôn gắn vào các phần tử tĩnh)
        $(".sodoban-khuvuc-tabs .nav-link").on("click", function (e) {
             e.preventDefault();
            $(".sodoban-khuvuc-tabs .nav-link").removeClass("active");
            $(this).addClass("active");
            const khuVucId = $(this).data("khuvuc-id");
            const banList = (khuVucId === "all") 
                ? allTables 
                : (khuVucData.find(kv => kv.idKhuVuc == khuVucId) || {}).bans;
            renderTables(banList);
            resetPanel();
        });

// =================================================================
        // --- SỬA LỖI HOT RELOAD VÀ RACE CONDITION (Bản cuối) ---
        // =================================================================
        $("#table-layout-container").on("click", ".table-card", function () {
            const $card = $(this);
            if ($card.hasClass('dimmed')) return;

            // 1. Lấy ID của bàn (luôn luôn đúng)
            const banId = $card.data('ban-id'); 
            
            // 2. Tìm lại (re-find) dữ liệu bàn từ 'khuVucData' GỐC.
            // Biến 'allTables' đang bị lỗi khi Hot Reload.
            let banData = null;
            for (const kv of khuVucData) {
                // Dùng '==' để so sánh string (từ data-ban-id) và number (từ idBan)
                banData = kv.bans.find(b => b.idBan == banId);
                if (banData) break; // Thoát ngay khi tìm thấy
            }
            
            // 3. Gọi hàm
            handleTableClick($card, banData); 
        });
        // =================================================================

        $("#btn-cancel-select").on("click", resetPanel);
        $("#refresh-tables-btn").on("click", () => location.reload());

        // (Các sự kiện click cho nút trong panel giữ nguyên)
        $("#btn-goi-mon-cu").on("click", async function () {
            if (!currentSelectedBan) return;
            const banStatus = currentSelectedBan.trangThai.toLowerCase();
            if (banStatus === "có khách") {
                if (!currentSelectedBan.idHoaDonHienTai) return alert("Lỗi: Bàn này không có hóa đơn hiện tại.");
                window.location.href = `/Employee/GoiMon?idHoaDon=${currentSelectedBan.idHoaDonHienTai}`;
            } else if (banStatus === "trống" || banStatus === "đã đặt") {
                const text = (banStatus === "trống") ? "Tạo Hóa Đơn Mới" : "Khách đến (Mở Bàn)";
                if (!confirm(`Bạn muốn ${text} cho [${currentSelectedBan.soBan}]?`)) return;
                const result = await callApi('createorder', 'POST', { idBan: currentSelectedBan.idBan, idNhanVien: currentNhanVienId });
                if (result && result.idHoaDon) {
                    window.location.href = `/Employee/GoiMon?idHoaDon=${result.idHoaDon}`;
                }
            }
        });

        $("#btn-bao-cao-su-co").on("click", async function () {
            if (!currentSelectedBan) return;
            if (currentSelectedBan.trangThai.toLowerCase() === "bảo trì") {
                if (!confirm(`Bạn muốn HỦY BẢO TRÌ cho [${currentSelectedBan.soBan}] và chuyển về "Trống"?`)) return;
                const result = await callApi('reportproblem', 'POST', { idBan: currentSelectedBan.idBan, idNhanVien: currentNhanVienId, ghiChu: "" });
                if (result) {
                    alert("Đã hủy bảo trì bàn!");
                    location.reload();
                }
            } else {
                const ghiChu = prompt(`Vui lòng nhập mô tả sự cố cho [${currentSelectedBan.soBan}]:`);
                if (ghiChu && ghiChu.trim() !== "") {
                    const result = await callApi('reportproblem', 'POST', { idBan: currentSelectedBan.idBan, idNhanVien: currentNhanVienId, ghiChu: ghiChu });
                    if (result) {
                        alert(result.message || "Báo cáo thành công!");
                        location.reload();
                    }
                }
            }
        });

        $("#btn-chuyen-ban").on("click", function() {
            if (!currentSelectedBan) return;
            startSelectionMode('chuyen', `Đang Chuyển [${currentSelectedBan.soBan}]`);
        });

        $("#btn-gop-ban").on("click", function() {
            if (!currentSelectedBan) return;
            startSelectionMode('gop', `Đang Gộp [${currentSelectedBan.soBan}]`);
        });

        // 2. Chạy code render lần đầu *SAU MỘT KHOẢNG TRỄ NHỎ*
        // Đây là "cú đấm" cuối cùng để diệt lỗi race condition
        // do Hot Reload gây ra.
        setTimeout(function() {
            renderTables(allTables);
            resetPanel();
        }, 100); // Trì hoãn 100ms

    }); // <-- Kết thúc $(window).on('load')
</script>
}

@section Styles {
    <style>
        :root {
            --cf-brown: #6F4E37;
            --cf-brown-dark: #4E342E;
            --cf-orange: #D27D2D;
            --cf-cream: #FFF8E1;
            --cf-white: #FFFFFF;
            --cf-text: #333;
            --cf-gray: #757575;
            --cf-gray-light: #EEEEEE;
            --cf-shadow: rgba(0, 0, 0, 0.1);
            --cf-status-green: #66BB6A;
            --cf-status-red: #EF5350;
            --cf-status-yellow: #FFA726;
            --cf-status-gray: #BDBDBD;
        }
    
        .sodoban-layout-container {
            display: flex;
            gap: 1.5rem;
        }

        /* 1. Tab Khu Vực (Trái) */
        .sodoban-khuvuc-tabs {
            flex: 0 0 240px;
            border: none;
            height: fit-content;
            position: sticky;
            top: 20px;
        }
            .sodoban-khuvuc-tabs .nav-link {
                color: var(--cf-brown-dark);
                font-weight: 600;
                font-size: 0.95rem;
                padding: 0.75rem 1.25rem;
                display: flex;
                align-items: center;
                gap: 0.75rem;
                border-radius: 8px;
                margin-bottom: 0.25rem;
                transition: all 0.2s ease-in-out;
            }
                .sodoban-khuvuc-tabs .nav-link .material-symbols-outlined {
                    color: var(--cf-orange);
                    font-variation-settings: 'FILL' 0;
                    transition: all 0.2s ease;
                }
            .sodoban-khuvuc-tabs .nav-link:hover {
                background-color: var(--cf-cream);
            }
            .sodoban-khuvuc-tabs .nav-link.active {
                background-color: var(--cf-brown);
                color: var(--cf-white);
                box-shadow: 0 4px 12px rgba(111, 78, 55, 0.3);
            }
                /* SỬA LỖI FONT: Xóa 'FILL' 1 để tránh lỗi render */
                .sodoban-khuvuc-tabs .nav-link.active .material-symbols-outlined {
                    color: var(--cf-white);
                    /* font-variation-settings: 'FILL' 1; */ /* <-- Gây lỗi */
                }

        /* 2. Content (Giữa) */
        .sodoban-content {
            flex: 1;
            min-width: 0;
        }
        .sodoban-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        /* 3. Panel (Phải) */
        .sodoban-panel {
            flex: 0 0 320px;
        }
            .sodoban-panel .card {
                border: none;
            }
            .sodoban-panel .btn {
                padding-top: 0.75rem;
                padding-bottom: 0.75rem;
                font-weight: 600;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
            }
            .sodoban-panel .btn .material-symbols-outlined {
                margin: 0;
                font-size: 1.25rem;
            }
            .sodoban-panel .btn-lg {
                padding-top: 1rem;
                padding-bottom: 1rem;
            }

        /* 4. Thẻ Bàn (Table Card) */
        .table-card {
            width: 150px;
            height: 130px;
            background: var(--cf-white);
            border-radius: 8px;
            border: 1px solid var(--cf-gray-light);
            border-top: 5px solid;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 0 2px 4px var(--cf-shadow);
        }
        .table-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px var(--cf-shadow);
        }
        .table-card.selected {
            border-color: var(--cf-orange) !important;
            box-shadow: 0 8px 20px rgba(210, 125, 45, 0.5) !important;
        }
        .table-card.dimmed {
            opacity: 0.3;
            cursor: not-allowed;
            background-color: var(--cf-gray-light);
        }
        /* SỬA LỖI FONT: Xóa 'FILL' 1 để tránh lỗi render */
        .table-card .table-icon .material-symbols-outlined {
            font-size: 28px;
            /* font-variation-settings: 'FILL' 1; */ /* <-- Gây lỗi */
            margin-bottom: 8px;
        }
        .table-card .table-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--cf-brown-dark);
            margin: 0;
        }
        .table-card .table-status {
            font-size: 0.8rem;
            color: var(--cf-gray);
        }
        .table-card .table-status-price {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--cf-status-red);
            margin-top: 4px;
        }
        .table-card .table-booked-info {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--cf-status-yellow);
            text-align: center;
        }

        /* Trạng thái thẻ bàn */
        .table-card.status-trong { border-top-color: var(--cf-status-green); }
        .table-card.status-trong .table-icon { color: var(--cf-status-green); }
        
        .table-card.status-co-khach { border-top-color: var(--cf-status-red); }
        .table-card.status-co-khach .table-icon { color: var(--cf-status-red); }

        .table-card.status-da-dat { border-top-color: var(--cf-status-yellow); }
        .table-card.status-da-dat .table-icon { color: var(--cf-status-yellow); }

        .table-card.status-bao-tri { border-top-color: var(--cf-status-gray); opacity: 0.7; }
        .table-card.status-bao-tri .table-icon { color: var(--cf-status-gray); }

        /* Chú thích trạng thái */
        .status-box {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 3px;
            margin-right: 6px;
            vertical-align: middle;
        }
        .status-box.status-trong { background-color: var(--cf-status-green); }
        .status-box.status-co-khach { background-color: var(--cf-status-red); }
        .status-box.status-da-dat { background-color: var(--cf-status-yellow); }
        .status-box.status-bao-tri { background-color: var(--cf-status-gray); }
    </style>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\SoDoBanView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/employee/SoDoBanView.cshtml.cs
using CafebookModel.Model.ModelWeb.QuanLy;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Collections.Generic;
using System.Net.Http;
using System.Net.Http.Json;
using System.Security.Claims;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Authorization;
// XÓA: using System.Net.Http.Headers; (Không cần nữa)

namespace WebCafebookApi.Pages.employee
{
    [Authorize(Roles = "Quản trị viên, Phục vụ, Thu ngân, Pha chế, Bếp, Quản lý")]
    public class SoDoBanViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        public int NhanVienId { get; set; }
        public string? ErrorMessage { get; set; }
        public List<KhuVucDto> KhuVucList { get; set; } = new();

        // THÊM MỚI: Thuộc tính để truyền token xuống JavaScript
        public string? JwtToken { get; set; }

        public SoDoBanViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        public async Task<IActionResult> OnGetAsync()
        {
            var idNhanVienStr = User.FindFirstValue(ClaimTypes.NameIdentifier);
            int.TryParse(idNhanVienStr, out var id);
            NhanVienId = id;

            // --- CẬP NHẬT LOGIC GỌI API ---

            // 1. LẤY TOKEN TỪ SESSION
            // (Giống hệt cách cấu hình HttpClient trong Program.cs)
            JwtToken = HttpContext.Session.GetString("JwtToken");

            if (string.IsNullOrEmpty(JwtToken))
            {
                // Nếu không có JWT token (phiên đăng nhập API hết hạn)
                // -> Về trang đăng nhập để lấy lại
                return RedirectToPage("/account/DangNhapView");
            }

            // 2. SỬ DỤNG ĐÚNG TÊN CLIENT ĐÃ ĐĂNG KÝ
            // "ApiClient" đã được Program.cs cấu hình BaseAddress
            // và tự động gắn Bearer Token từ Session.
            var httpClient = _httpClientFactory.CreateClient("ApiClient");

            // 3. XÓA BỎ TOÀN BỘ CODE LẤY TOKEN THỦ CÔNG TỪ COOKIE
            // (Khối code "Lấy token từ cookie..." đã bị xóa)

            try
            {
                // Đường dẫn API giữ nguyên (BaseAddress là http://localhost:5166)
                var response = await httpClient.GetFromJsonAsync<List<KhuVucDto>>("api/web/quanly/sodoban");
                if (response != null)
                {
                    KhuVucList = response;
                }
            }
            catch (System.Net.Http.HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                // Lỗi 401: Token không hợp lệ (hết hạn, sai...)
                ErrorMessage = "Phiên đăng nhập API đã hết hạn. Vui lòng đăng nhập lại.";
                HttpContext.Session.Remove("JwtToken");
                return RedirectToPage("/account/DangNhapView");
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Lỗi tải Sơ đồ bàn: {ex.Message}. Vui lòng kiểm tra kết nối API (đang gọi {httpClient.BaseAddress}api/web/quanly/sodoban).";
            }

            return Page();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\WebQuanLyView.cshtml
================================================================================
﻿@page "/Employee/Dashboard"
@model WebCafebookApi.Pages.employee.WebQuanLyViewModel
@{
    ViewData["Title"] = "Bảng điều khiển";
    Layout = "_Layout_Employee";

    var avatarSrc = string.IsNullOrEmpty(Model.DashboardData.AnhDaiDienUrl)
        ? "/images/default-avatar.png"
        : Model.DashboardData.AnhDaiDienUrl;
}

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}
else
{
    <div class="mb-4">
        <h1 class="page-title">@ViewData["Title"]</h1>
        <p class="page-lead">Tổng quan hoạt động của quán trong ngày.</p>
    </div>

    <div class="row g-4">
        <div class="col-lg-4 col-md-5">
            <div class="card h-100 product-card">
                <div class="card-body text-center d-flex flex-column justify-content-center align-items-center p-4">
                    <img src="@avatarSrc" alt="Avatar" class="rounded-circle mb-3 shadow-sm" style="width: 120px; height: 120px; object-fit: cover;" />
                    <h3 class="card-title fw-bold mb-1">@Model.DashboardData.HoTen</h3>
                    <p class="card-text text-muted fs-5 mb-3">@Model.DashboardData.VaiTro</p>
                    <hr class="w-100" />
                    <p class="card-text fs-5 mb-0">
                        <strong class="text-uppercase">Ca làm việc hôm nay:</strong>
                        <br />
                        <span class="fw-bold fs-4" style="color: var(--cf-orange);">
                            @(Model.DashboardData.CaHienTai ?? "...")
                        </span>
                    </p>
                </div>
            </div>
        </div>

        <div class="col-lg-8 col-md-7">
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="stat-card stat-red">
                        <div class="card-body">
                            <div class="stat-icon">
                                <span class="material-symbols-outlined">group</span>
                            </div>
                            <div>
                                <h1 class="display-5 fw-bold mb-0">@Model.DashboardData.TongBanDangPhucVu</h1>
                                <p class="card-text fs-5 text-muted mb-0">Bàn Đang Phục Vụ</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stat-card stat-blue">
                        <div class="card-body">
                            <div class="stat-icon">
                                <span class="material-symbols-outlined">receipt_long</span>
                            </div>
                            <div>
                                <h1 class="display-5 fw-bold mb-0">@Model.DashboardData.TongDonDangXuLy</h1>
                                <p class="card-text fs-5 text-muted mb-0">Đơn Đang Xử Lý</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-grid">
                <a asp-page="/Employee/SoDoBanView" class="btn btn-primary btn-lg p-4">
                    <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 8px;">grid_view</span>
                    Bắt đầu làm việc (Sơ Đồ Bàn)
                </a>
            </div>
        </div>
    </div>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\WebQuanLyView.cshtml.cs
================================================================================
﻿using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Json;
using System.Security.Claims;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Authorization; // <-- THÊM

namespace WebCafebookApi.Pages.employee
{
    // SỬA: Thêm [Authorize] với các vai trò thực tế từ CSDL
    [Authorize(Roles = "Quản trị viên, Phục vụ, Thu ngân, Pha chế, Bếp, Quản lý")]
    public class WebQuanLyViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        public WebQuanLyViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        [BindProperty]
        public WebQuanLyDashboardDto DashboardData { get; set; } = new();
        public string? ErrorMessage { get; set; }

        public async Task<IActionResult> OnGetAsync()
        {
            var idNhanVienStr = User.FindFirstValue(ClaimTypes.NameIdentifier);
            // SỬA: Không cần kiểm tra ID nữa vì [Authorize] đã làm việc đó

            var httpClient = _httpClientFactory.CreateClient();
            try
            {
                var response = await httpClient.GetFromJsonAsync<WebQuanLyDashboardDto>($"http://localhost:5166/api/web/quanly/dashboard/{idNhanVienStr}");

                if (response != null)
                {
                    DashboardData = response;
                }
                else
                {
                    ErrorMessage = "Không thể tải dữ liệu dashboard.";
                }
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Lỗi kết nối API: {ex.Message}";
            }

            return Page();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\_Layout_Employee.cshtml
================================================================================
﻿@using System.Security.Claims
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Quản lý Cafebook</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
    @await RenderSectionAsync("Styles", required: false)
</head>
<body class="employee-body">
    <div class="d-flex">

        <nav class="sidebar-nav">
            <div class="sidebar-header">
                <a class="navbar-brand fs-4" asp-page="/employee/WebQuanLyView">
                    <span class="material-symbols-outlined" style="vertical-align: middle;">coffee</span>
                    Cafebook
                </a>
            </div>

            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link @(ViewData["Title"]?.ToString() == "Bảng điều khiển" ? "active" : "")"
                       asp-page="/Employee/WebQuanLyView">
                        <span class="material-symbols-outlined">analytics</span>
                        Tổng quan
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @(ViewData["Title"]?.ToString() == "Sơ Đồ Bàn" ? "active" : "")"
                       asp-page="/Employee/SoDoBanView">
                        <span class="material-symbols-outlined">grid_view</span>
                        Sơ Đồ Bàn
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link @(ViewData["Title"]?.ToString() == "Hỗ trợ Khách hàng" ? "active" : "")"
                       asp-page="/Employee/HoTroKhachHangView">
                        <span class="material-symbols-outlined">support_agent</span>
                        Hỗ trợ Khách hàng
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link @(ViewData["Title"]?.ToString() == "Quản lý Giao hàng" ? "active" : "")"
                       asp-page="/Employee/QuanLyGiaoHangView">
                        <span class="material-symbols-outlined">support_agent</span>
                        Quản lý Giao hàng
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link @(ViewData["Title"]?.ToString() == "Ứng dụng Shipper" ? "active" : "")"
                       asp-page="/Employee/ShipperGiaoHangView">
                        <span class="material-symbols-outlined">two_wheeler</span>
                        Ứng dụng Shipper
                    </a>
                </li>
            </ul>
        </nav>

        <div class="main-content">
            <header class="header-nav shadow-sm">
                <span class="navbar-text fw-bold" style="color: var(--cf-text);">
                    Xin chào, @(User.FindFirstValue(ClaimTypes.GivenName) ?? User.Identity?.Name)!
                </span>
                <form method="post" asp-page="/employee/DangXuat">
                    <button type="submit" class="btn btn-link nav-link text-danger d-flex align-items-center gap-2">
                        <span class="material-symbols-outlined">logout</span>
                        Đăng xuất
                    </button>
                </form>
            </header>

            <main role="main">
                <div class="main-content-card">
                    @RenderBody()
                </div>
            </main>
        </div>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\_ViewStart.cshtml
================================================================================
﻿@{
    Layout = "_Layout_Employee";
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Shared\_Layout.cshtml
================================================================================
﻿@using System.Security.Claims
@using WebCafebookApi.Services     
@using CafebookModel.Model.ModelWeb 
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

@{
    // 4. Đọc giỏ hàng từ Session
    var cart = HttpContextAccessor.HttpContext?.Session.Get<List<CartItemDto>>(WebCafebookApi.Services.SessionExtensions.CartKey);
    var cartCount = cart?.Count ?? 0;
}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Cafebook</title>

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />

    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
    @await RenderSectionAsync("Styles", required: false)
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-white border-bottom box-shadow-sm mb-3">
            <div class="container">
                <a class="navbar-brand" asp-page="/Index">
                    <img src="/images/logo.png" alt="Cafebook Logo" style="height: 30px; margin-right: 8px;">
                    Cafebook
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target=".navbar-collapse" aria-controls="navbarSupportedContent"
                        aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="navbar-collapse collapse d-sm-inline-flex justify-content-between">
                    <ul class="navbar-nav flex-grow-1">
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-page="/TrangChuView">Trang Chủ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-page="/ThucDonView">Thực Đơn</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-page="/ThuVienSachView">Thư Viện Sách</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-page="/DatBanView">Đặt Bàn</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-page="/LienHeView">Liên Hệ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-page="/HoTroView">Hỗ Trợ</a>
                        </li>
                    </ul>

                    @* === 5. THÊM ICON GIỎ HÀNG VÀ LOGINPARTIAL === *@
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-cart-icon" asp-page="/GioHangView" title="Giỏ hàng">
                                <span class="material-symbols-outlined">shopping_cart</span>
                                @if (cartCount > 0)
                                {
                                    <span class="badge rounded-pill bg-danger">@cartCount</span>
                                }
                            </a>
                        </li>
                        <partial name="_LoginPartial" />
                    </ul>

                </div>
            </div>
        </nav>
    </header>

    <div class="main-container">
        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>

    <footer class="footer text-muted mt-5">
        <div class="container d-flex justify-content-between align-items-center py-4">
            <div>
                &copy; @DateTime.Now.Year - Cafebook
                <a class="footer-link" asp-page="/LienHeView">Liên Hệ</a>
                <a class="footer-link" asp-page="/ChinhSachView">Chính sách</a>
            </div>
            <div>
                <a class="footer-link" asp-page="/Employee/DangNhapEmployee">Đăng nhập nhân viên</a>
            </div>
        </div>
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Shared\_Layout.cshtml.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Shared\_LoginPartial.cshtml
================================================================================
﻿@using System.Security.Claims
@using Microsoft.AspNetCore.Http

<ul class="navbar-nav align-items-center">
    @if (User.Identity?.IsAuthenticated == true && User.IsInRole("KhachHang"))
    {
        var displayName = User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.GivenName)?.Value;
        if (string.IsNullOrWhiteSpace(displayName))
        {
            displayName = User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Name)?.Value ?? "Người dùng";
        }

        // SỬA LỖI: Lấy "AvatarUrl" từ Session thay vì "AvatarBase64"
        var avatarUrl = Context.Session.GetString("AvatarUrl");
        var avatarSrc = string.IsNullOrEmpty(avatarUrl)
        ? "/images/default-avatar.png" // 1. Lấy ảnh MẶC ĐỊNH
        : avatarUrl; // 2. Dùng thẳng URL từ API

        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <img src="@avatarSrc" alt="Avatar" class="rounded-circle" style="width: 30px; height: 30px; object-fit: cover; margin-right: 8px;" />
                Xin chào, @displayName!
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <li>
                    <a class="dropdown-item" asp-page="/account/ThongTinCaNhanView">
                        <span class="material-symbols-outlined" style="vertical-align: sub; font-size: 1.2rem; margin-right: 8px;">account_circle</span>
                        Thông tin cá nhân
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" asp-page="/account/LichSuDatBanView">
                        <span class="material-symbols-outlined" style="vertical-align: sub; font-size: 1.2rem; margin-right: 8px;">history</span>
                        Lịch sử đặt bàn
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" asp-page="/account/LichSuThueSachView">
                        <span class="material-symbols-outlined" style="vertical-align: sub; font-size: 1.2rem; margin-right: 8px;">book</span>
                        Sách đang thuê
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <form class="form-inline" asp-page="/Account/DangXuat" asp-route-returnUrl="@Url.Page("/Index", new { area = "" })" method="post">
                        <button type="submit" class="dropdown-item">
                            <span class="material-symbols-outlined" style="vertical-align: sub; font-size: 1.2rem; margin-right: 8px;">logout</span>
                            Đăng xuất
                        </button>
                    </form>
                </li>
            </ul>
        </li>
    }
    else
    {
        <li class="nav-item">
            <a class="nav-link text-dark" asp-page="/Account/DangKyView">Đăng ký</a>
        </li>
        <li class="nav-item">
            <a class="nav-link text-dark" asp-page="/Account/DangNhapView">Đăng nhập</a>
        </li>
    }
</ul>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Shared\_ValidationScriptsPartial.cshtml
================================================================================
﻿<script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
<script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>

================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Properties\launchSettings.json
================================================================================
{
  "$schema": "http://json.schemastore.org/launchsettings.json",
  "iisSettings": {
    "windowsAuthentication": false,
    "anonymousAuthentication": true,
    "iisExpress": {
      "applicationUrl": "http://localhost:20767",
      "sslPort": 0
    }
  },
  "profiles": {
    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "applicationUrl": "http://localhost:5156",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}

================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Services\EmailService.cs
================================================================================
﻿// Đảm bảo file này nằm trong: WebCafebookApi/Services/EmailService.cs
using System.Net;
using System.Net.Mail;
using System.Threading.Tasks;
using Microsoft.Extensions.Options;
using System;

namespace WebCafebookApi.Services
{
    public class EmailService
    {
        private readonly SmtpSettings _smtpSettings;

        public EmailService(IOptions<SmtpSettings> smtpSettings)
        {
            _smtpSettings = smtpSettings.Value;
        }

        public async Task SendEmailAsync(string toEmail, string subject, string body)
        {
            try
            {
                using (var client = new SmtpClient(_smtpSettings.Host, _smtpSettings.Port))
                {
                    client.EnableSsl = _smtpSettings.EnableSsl;
                    client.UseDefaultCredentials = false;
                    client.Credentials = new NetworkCredential(_smtpSettings.Username, _smtpSettings.Password);

                    var mailMessage = new MailMessage
                    {
                        // Lỗi CS1061 xảy ra ở đây nếu _smtpSettings.Username rỗng
                        From = new MailAddress(_smtpSettings.Username, _smtpSettings.FromName),
                        Subject = subject,
                        Body = body,
                        IsBodyHtml = true,
                    };
                    mailMessage.To.Add(toEmail);

                    await client.SendMailAsync(mailMessage);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error sending email to {toEmail}: {ex}");
                throw new ApplicationException($"Không thể gửi email: {ex.Message}", ex);
            }
        }

        // Hàm tiện ích để gửi mã xác nhận
        public Task SendVerificationCodeAsync(string toEmail, string code)
        {
            string subject = "Cafebook - Mã Xác Nhận Đặt Lại Mật Khẩu";
            string body = $@"
                <div style='font-family: Arial, sans-serif; line-height: 1.6;'>
                <p>Xin chào,</p>
                <p>Bạn nhận được email này vì đã yêu cầu đặt lại mật khẩu cho tài khoản Cafebook của bạn.</p>
                <p>Mã xác nhận của bạn là: <strong style='font-size: 1.5em; color: #D27D2D;'>{code}</strong></p>
                <p>Mã này sẽ hết hạn sau 5 phút.</p>
                <p>Nếu bạn không yêu cầu đặt lại mật khẩu, vui lòng bỏ qua email này.</p>
                <p>Trân trọng,<br/>Đội ngũ Cafebook</p>
                </div>";
            return SendEmailAsync(toEmail, subject, body);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Services\SessionHelper.cs
================================================================================
﻿using Microsoft.AspNetCore.Http;
using System.Text.Json;

namespace WebCafebookApi.Services
{
    // Helper để lưu và đọc object từ Session
    public static class SessionExtensions
    {
        public const string CartKey = "CafeBookCart"; // Dùng key này thống nhất

        public static void Set<T>(this ISession session, string key, T value)
        {
            session.SetString(key, JsonSerializer.Serialize(value));
        }

        public static T? Get<T>(this ISession session, string key)
        {
            var value = session.GetString(key);
            return value == null ? default : JsonSerializer.Deserialize<T>(value);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Services\SmtpSettings.cs
================================================================================
﻿// Đảm bảo file này nằm trong: WebCafebookApi/Services/SmtpSettings.cs
namespace WebCafebookApi.Services
{
    public class SmtpSettings
    {
        public string Host { get; set; } = string.Empty;
        public int Port { get; set; }
        public string Username { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public bool EnableSsl { get; set; }
        public string FromName { get; set; } = string.Empty;
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\favicon.ico
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\css\site.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\images\default-avatar.png
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\images\default-book-cover.png
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\images\default-food-icon.png
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\images\logo.ico
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\images\logo.png
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\js\profile.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\js\site.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\LICENSE
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-grid.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-grid.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-grid.min.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-grid.min.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-grid.rtl.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-grid.rtl.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-grid.rtl.min.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-grid.rtl.min.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-reboot.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-reboot.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-reboot.min.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-reboot.min.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-reboot.rtl.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-reboot.rtl.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-reboot.rtl.min.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-reboot.rtl.min.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-utilities.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-utilities.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-utilities.min.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-utilities.min.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-utilities.rtl.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-utilities.rtl.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-utilities.rtl.min.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-utilities.rtl.min.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap.min.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap.min.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap.rtl.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap.rtl.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap.rtl.min.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap.rtl.min.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.bundle.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.bundle.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.bundle.min.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.bundle.min.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.esm.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.esm.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.esm.min.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.esm.min.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.min.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.min.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery\LICENSE.txt
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery\dist\jquery.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery\dist\jquery.min.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery\dist\jquery.min.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery-validation\LICENSE.md
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery-validation\dist\additional-methods.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery-validation\dist\additional-methods.min.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery-validation\dist\jquery.validate.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery-validation\dist\jquery.validate.min.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery-validation-unobtrusive\jquery.validate.unobtrusive.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery-validation-unobtrusive\jquery.validate.unobtrusive.min.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery-validation-unobtrusive\LICENSE.txt
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\package.json
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\README.md
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\browser\signalr.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\browser\signalr.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\browser\signalr.min.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\browser\signalr.min.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\AbortController.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\AbortController.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\browser-index.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\browser-index.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\DefaultHttpClient.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\DefaultHttpClient.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\DefaultReconnectPolicy.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\DefaultReconnectPolicy.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\Errors.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\Errors.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\FetchHttpClient.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\FetchHttpClient.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\HandshakeProtocol.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\HandshakeProtocol.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\HeaderNames.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\HeaderNames.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\HttpClient.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\HttpClient.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\HttpConnection.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\HttpConnection.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\HubConnection.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\HubConnection.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\HubConnectionBuilder.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\HubConnectionBuilder.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\IConnection.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\IConnection.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\IHttpConnectionOptions.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\IHttpConnectionOptions.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\IHubProtocol.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\IHubProtocol.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\ILogger.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\ILogger.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\index.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\index.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\IRetryPolicy.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\IRetryPolicy.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\ITransport.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\ITransport.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\JsonHubProtocol.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\JsonHubProtocol.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\Loggers.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\Loggers.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\LongPollingTransport.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\LongPollingTransport.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\Polyfills.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\Polyfills.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\ServerSentEventsTransport.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\ServerSentEventsTransport.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\Stream.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\Stream.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\Subject.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\Subject.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\TextMessageFormat.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\TextMessageFormat.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\Utils.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\Utils.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\WebSocketTransport.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\WebSocketTransport.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\XhrHttpClient.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\cjs\XhrHttpClient.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\AbortController.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\AbortController.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\AbortController.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\browser-index.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\browser-index.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\browser-index.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\DefaultHttpClient.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\DefaultHttpClient.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\DefaultHttpClient.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\DefaultReconnectPolicy.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\DefaultReconnectPolicy.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\DefaultReconnectPolicy.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\Errors.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\Errors.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\Errors.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\FetchHttpClient.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\FetchHttpClient.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\FetchHttpClient.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\HandshakeProtocol.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\HandshakeProtocol.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\HandshakeProtocol.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\HeaderNames.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\HeaderNames.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\HeaderNames.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\HttpClient.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\HttpClient.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\HttpClient.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\HttpConnection.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\HttpConnection.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\HttpConnection.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\HubConnection.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\HubConnection.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\HubConnection.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\HubConnectionBuilder.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\HubConnectionBuilder.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\HubConnectionBuilder.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\IConnection.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\IConnection.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\IConnection.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\IHttpConnectionOptions.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\IHttpConnectionOptions.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\IHttpConnectionOptions.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\IHubProtocol.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\IHubProtocol.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\IHubProtocol.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\ILogger.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\ILogger.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\ILogger.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\index.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\index.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\index.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\IRetryPolicy.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\IRetryPolicy.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\IRetryPolicy.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\ITransport.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\ITransport.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\ITransport.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\JsonHubProtocol.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\JsonHubProtocol.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\JsonHubProtocol.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\Loggers.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\Loggers.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\Loggers.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\LongPollingTransport.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\LongPollingTransport.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\LongPollingTransport.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\Polyfills.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\Polyfills.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\Polyfills.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\ServerSentEventsTransport.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\ServerSentEventsTransport.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\ServerSentEventsTransport.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\Stream.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\Stream.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\Stream.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\Subject.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\Subject.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\Subject.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\TextMessageFormat.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\TextMessageFormat.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\TextMessageFormat.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\Utils.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\Utils.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\Utils.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\WebSocketTransport.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\WebSocketTransport.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\WebSocketTransport.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\XhrHttpClient.d.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\XhrHttpClient.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\esm\XhrHttpClient.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\webworker\signalr.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\webworker\signalr.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\webworker\signalr.min.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\dist\webworker\signalr.min.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\AbortController.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\browser-index.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\DefaultHttpClient.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\DefaultReconnectPolicy.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\Errors.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\FetchHttpClient.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\HandshakeProtocol.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\HeaderNames.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\HttpClient.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\HttpConnection.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\HubConnection.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\HubConnectionBuilder.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\IConnection.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\IHttpConnectionOptions.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\IHubProtocol.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\ILogger.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\index.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\IRetryPolicy.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\ITransport.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\JsonHubProtocol.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\Loggers.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\LongPollingTransport.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\Polyfills.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\ServerSentEventsTransport.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\Stream.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\Subject.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\TextMessageFormat.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\third-party-notices.txt
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\Utils.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\WebSocketTransport.ts
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\microsoft\signalr\src\XhrHttpClient.ts
