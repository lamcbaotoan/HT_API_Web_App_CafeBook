=== MÃ NGUỒN DỰ ÁN: WebCafebookApi ===

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\appsettings.Development.json
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\appsettings.json
================================================================================
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",

  "SmtpSettings": {
    "Host": "smtp.gmail.com",
    "Port": 587,
    "Username": "cafebook.hotro@gmail.com",
    "Password": "raja nenx mxhk vtvn",
    "EnableSsl": true,
    "FromName": "Cafebook Hỗ Trợ"
  }
}

================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Program.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Program.cs
// (Nội dung đầy đủ của file Program.cs dựa trên context bạn cung cấp)

using Microsoft.AspNetCore.Authentication.Cookies;
using WebCafebookApi.Services;
using System.Net.Http.Headers;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddHttpContextAccessor();

// SỬA CẤU HÌNH HTTPCLIENT
builder.Services.AddHttpClient("ApiClient", (serviceProvider, client) =>
{
    client.BaseAddress = new Uri("http://localhost:5166");
    client.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

    var httpContextAccessor = serviceProvider.GetService<IHttpContextAccessor>();
    if (httpContextAccessor != null)
    {
        // SỬA: Đọc JWT Token từ Session (do DangNhapView.cshtml.cs lưu vào)
        var token = httpContextAccessor.HttpContext?.Session.GetString("JwtToken");

        if (!string.IsNullOrEmpty(token))
        {
            // Gắn JWT Token thật vào Header
            client.DefaultRequestHeaders.Authorization =
                new AuthenticationHeaderValue("Bearer", token);
        }
    }
});
// (Kết thúc sửa)

builder.Services.AddHttpClient();

builder.Services.AddDistributedMemoryCache();
builder.Services.AddSession(options =>
{
    options.IdleTimeout = TimeSpan.FromMinutes(30);
    options.Cookie.HttpOnly = true;
    options.Cookie.IsEssential = true;
});

builder.Services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
    .AddCookie(options =>
    {
        options.Cookie.Name = "AuthToken"; // Cookie này chỉ dùng cho Frontend
        options.LoginPath = "/account/DangNhapView";
        options.AccessDeniedPath = "/AccessDenied";
        options.LogoutPath = "/Account/DangXuat";
    });

builder.Services.AddRazorPages();
builder.Services.Configure<SmtpSettings>(builder.Configuration.GetSection("SmtpSettings"));
builder.Services.AddTransient<EmailService>();
builder.Services.AddMemoryCache();

var app = builder.Build();

// ... (Pipeline giữ nguyên) ...
//app.UseHttpsRedirection();
app.UseStaticFiles();
app.UseRouting();

// Đảm bảo đúng thứ tự
app.UseSession(); // Session phải được gọi trước
app.UseAuthentication();
app.UseAuthorization();

app.MapRazorPages();
app.Run();
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\WebCafebookApi.csproj
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\WebCafebookApi.csproj.user
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\ChinhSachView.cshtml
================================================================================
﻿@page "/Privacy"
@model WebCafebookApi.Pages.ChinhSachViewModel
@{
    ViewData["Title"] = "Chính sách & Giới thiệu";
}

@* ... (Phần @section và <style> giữ nguyên) ... *@
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
}
<style>
    .policy-container h2 {
        color: var(--cf-dark-brown, #4E342E);
        font-weight: 700;
        margin-top: 2.5rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--cf-orange, #D27D2D);
    }

    .policy-container h3 {
        color: var(--cf-brown, #6F4E37);
        font-weight: 600;
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
    }

    .policy-container p,
    .policy-container li {
        line-height: 1.7;
        color: var(--cf-text, #4E342E);
        font-size: 1.05rem;
    }

    .policy-container ul {
        padding-left: 1.5rem;
    }
</style>

<div class="container mt-5 mb-5 policy-container">
    <div class="row">
        <div class="col-lg-10 mx-auto">

            <div class="text-center mb-5">
                <h1>Về Cafebook & Điều khoản</h1>
                <p class="lead text-muted">Những giá trị cốt lõi và quy định chung tại không gian của chúng tôi.</p>
            </div>

            <h2>Về Chúng Tôi</h2>
            <p>
                <strong>Cafebook</strong> được sinh ra từ niềm đam mê bất tận với hai thứ: hương vị đậm đà của cà phê nguyên chất và giá trị vĩnh cửu của những trang sách. Chúng tôi không chỉ là một quán cà phê, chúng tôi là một "Ốc đảo tri thức", một không gian yên tĩnh nơi bạn có thể tạm gác lại những bộn bề của cuộc sống để đắm mình trong thế giới của riêng mình.
            </p>
            <p>
                Sứ mệnh của chúng tôi là tạo ra một cộng đồng nơi những người yêu sách và đam mê cà phê có thể kết nối, chia sẻ và truyền cảm hứng. Từ hạt cà phê Robusta Việt Nam được rang xay tỉ mỉ đến những cuốn sách kinh điển thế giới được chọn lọc kỹ càng, mọi chi tiết tại Cafebook đều được chăm chút để mang đến cho bạn trải nghiệm trọn vẹn nhất.
            </p>

            <h2>Điều Khoản Dịch Vụ</h2>
            <p>
                Chào mừng bạn đến với Cafebook. Bằng việc sử dụng các dịch vụ của chúng tôi (bao gồm gọi món, đặt bàn, và thuê sách), bạn đồng ý tuân thủ các điều khoản và điều kiện dưới đây:
            </p>

            <h3>1. Quy định chung tại cửa hàng</h3>
            <ul>
                <li>Vui lòng giữ gìn không gian yên tĩnh, đặc biệt tại các khu vực làm việc và đọc sách (Tầng 2, Gác lửng).</li>
                <li>Không mang đồ ăn, thức uống từ bên ngoài vào cửa hàng.</li>
                <li>Chúng tôi không chịu trách nhiệm về tài sản cá nhân của quý khách.</li>
            </ul>

            <h3>2. Dịch vụ Đặt bàn</h3>
            <ul>
                <li>Việc đặt bàn trực tuyến qua website hoặc ứng dụng cần được thực hiện trước ít nhất 1 giờ.</li>
                <li>Chúng tôi sẽ giữ bàn cho bạn trong vòng 15 phút kể từ thời gian đặt hẹn. Sau thời gian trên, đặt hẹn có thể bị hủy để nhường chỗ cho khách hàng khác.</li>
                <li>Đối với các yêu cầu đặc biệt (phòng VIP, nhóm đông), vui lòng liên hệ trực tiếp qua hotline.</li>
            </ul>

            <h3>3. Dịch vụ Thuê sách</h3>
            <ul>
                <li>Bạn có thể đọc sách tại chỗ miễn phí khi sử dụng dịch vụ của quán.</li>
                <li>Khi thuê sách mang về, bạn cần cung cấp thông tin cá nhân (Tên, SĐT) và thanh toán một khoản tiền cọc tương đương với giá bìa của cuốn sách.</li>

                <li>
                    Phí dịch vụ thuê sách (hiện tại là <strong>@Model.ChinhSach.PhiThue.ToString("N0")đ</strong>) và mọi khoản phí phạt trễ hạn (nếu có) sẽ được khấu trừ vào tiền cọc khi bạn trả sách.
                </li>
                <li>
                    Thời gian thuê tiêu chuẩn là 7 ngày. Phí phạt trễ hạn là <strong>@Model.ChinhSach.PhiTraTreMoiNgay.ToString("N0")đ</strong> cho mỗi ngày quá hạn.
                </li>

                <li>Vui lòng giữ gìn sách cẩn thận, không làm rách, ướt, hoặc ghi chú lên sách. Trường hợp sách bị hư hỏng nặng, chúng tôi có thể sẽ giữ lại toàn bộ tiền cọc để bù đắp chi phí.</li>
            </ul>

            <h3>4. Chính sách thành viên & Tích điểm</h3>
            <ul>
                <li>Khi đăng ký tài khoản trên website (hoặc cung cấp SĐT tại quầy), bạn sẽ tự động trở thành thành viên của Cafebook.</li>

                <li>
                    Với mỗi <strong>@Model.ChinhSach.DiemNhanVND.ToString("N0")đ</strong> trong hóa đơn, bạn sẽ được tích <strong>1 điểm</strong>.
                </li>
                <li>
                    Mỗi <strong>1 điểm</strong> tích lũy có giá trị quy đổi thành <strong>@Model.ChinhSach.DiemDoiVND.ToString("N0")đ</strong>, được trừ trực tiếp vào hóa đơn lần sau.
                </li>
            </ul>

            <h3>5. Miễn trừ trách nhiệm</h3>
            <p>
                Cafebook có quyền thay đổi, cập nhật hoặc ngưng các điều khoản này, cũng như các chương trình khuyến mãi, giá cả dịch vụ mà không cần báo trước. Các thay đổi sẽ được cập nhật công khai trên website này.
            </p>

        </div>
    </div>
</div>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\ChinhSachView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/ChinhSachView.cshtml.cs
using CafebookModel.Model.ModelWeb; // THÊM DTO MỚI
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Json; // THÊM
using System.Threading.Tasks; // THÊM

namespace WebCafebookApi.Pages
{
    public class ChinhSachViewModel : PageModel
    {
        // THÊM MỚI: Khởi tạo HttpClient
        private readonly IHttpClientFactory _httpClientFactory;
        public ChinhSachViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        // THÊM MỚI: Model để chứa dữ liệu
        public ChinhSachDto ChinhSach { get; set; } = new ChinhSachDto();

        public async Task OnGetAsync()
        {
            // THÊM MỚI: Logic tải dữ liệu động
            var httpClient = _httpClientFactory.CreateClient();
            try
            {
                var response = await httpClient.GetFromJsonAsync<ChinhSachDto>("http://localhost:5166/api/web/chinhsach/data");
                if (response != null)
                {
                    ChinhSach = response;
                }
            }
            catch (Exception)
            {
                // Nếu API lỗi, ChinhSach sẽ dùng giá trị mặc định đã khởi tạo
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\ChiTietSachView.cshtml
================================================================================
﻿@page "{id:int}"
@model WebCafebookApi.Pages.ChiTietSachViewModel

@{
    ViewData["Title"] = Model.Sach?.TieuDe ?? "Chi Tiết Sách";
    var imgSrc = string.IsNullOrEmpty(Model.Sach?.AnhBiaUrl)
        ? "/images/default-book-cover.png"
        : Model.Sach.AnhBiaUrl;
}

@section Styles {
    <style>

        /* ==============================
           MÔ TẢ: RÚT GỌN 3 DÒNG
        ============================== */
        #description-wrapper.description-truncated p {
            display: -webkit-box;
            -webkit-line-clamp: 3;          /* CHỈ 3 DÒNG */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: .5rem !important;   /* ĐẨY SÁT LÊN */
        }

        /* MỞ RỘNG */
        #description-wrapper.description-expanded p {
            display: block;
            white-space: pre-wrap !important;
            overflow: visible;
        }

        /* Image */
        .detail-img-container img {
            max-height: 500px;
            object-fit: cover;
        }

        .ingredient-list li {
            margin-bottom: .5rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 6px;
        }
    </style>
}

<div class="container mt-5">
    <div class="main-content-card">

        @if (Model.Sach != null)
        {
            <div class="row gy-4">

                <!-- Cột ảnh -->
                <div class="col-lg-4">
                    <div class="detail-img-container">
                        <img src="@imgSrc" class="img-fluid rounded shadow-sm w-100" alt="@Model.Sach.TieuDe">
                    </div>
                </div>

                <!-- Cột thông tin -->
                <div class="col-lg-5">

                    <!-- Breadcrumb -->
                    <nav aria-label="breadcrumb" class="page-breadcrumb mb-3">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a asp-page="/TrangChuView">
                                    <span class="material-symbols-outlined">home</span> Trang Chủ
                                </a>
                            </li>
                            <li class="breadcrumb-item">
                                <a asp-page="/ThuVienSachView">
                                    <span class="material-symbols-outlined">import_contacts</span> Thư Viện Sách
                                </a>
                            </li>
                            <li class="breadcrumb-item active">@Model.Sach.TieuDe</li>
                        </ol>
                    </nav>

                    <h1 class="display-5 fw-bold">@Model.Sach.TieuDe</h1>

                    <!-- Tác giả -->
                    <p class="lead fs-5">
                        Tác giả:
                        @if (Model.Sach.TacGias?.Any() == true)
                        {
                            foreach (var tg in Model.Sach.TacGias)
                            {
                                <a asp-page="/TimKiemSachView"
                                   asp-route-idTacGia="@tg.IdTacGia"
                                   class="text-muted text-decoration-none">@tg.TenTacGia</a>

                                @(tg != Model.Sach.TacGias.Last() ? ", " : "")
                            }
                        }
                        else
                        {
                            <span class="text-muted">(Đang cập nhật)</span>
                        }
                    </p>

                    <!-- Thể loại -->
                    <div class="fs-5 mb-3">
                        <span>Thể loại:</span>
                        @if (Model.Sach.TheLoais?.Any() == true)
                        {
                            foreach (var tl in Model.Sach.TheLoais)
                            {
                                <a asp-page="/TimKiemSachView"
                                   asp-route-idTheLoai="@tl.IdTheLoai"
                                   class="badge bg-primary text-decoration-none me-1 mb-1">@tl.TenTheLoai</a>
                            }
                        }
                        else
                        {
                            <span class="badge bg-secondary">(Đang cập nhật)</span>
                        }
                    </div>

                    <!-- NXB -->
                    <div class="fs-5 mb-3">
                        <span>Nhà xuất bản:</span>
                        @if (Model.Sach.NhaXuatBans?.Any() == true)
                        {
                            foreach (var nxb in Model.Sach.NhaXuatBans)
                            {
                                <a asp-page="/TimKiemSachView"
                                   asp-route-idNXB="@nxb.IdNhaXuatBan"
                                   class="badge bg-success text-decoration-none me-1 mb-1">@nxb.TenNhaXuatBan</a>
                            }
                        }
                        else
                        {
                            <span class="badge bg-secondary">(Đang cập nhật)</span>
                        }
                    </div>

                    <!-- Giá -->
                    <h3 class="text-danger fw-bolder">
                        @Model.Sach.GiaBia.ToString("N0") đ
                        <small class="text-muted fs-5">(Tiền cọc)</small>
                    </h3>

                    <!-- Mô tả sách -->
                    <div id="description-wrapper" class="description-truncated">
                        <p class="mt-4 fs-6" style="white-space: pre-wrap;">
                            @Model.Sach.MoTa
                        </p>
                    </div>

                    <a id="toggle-description"
                       href="javascript:void(0);"
                       class="btn btn-link ps-0"
                       style="display:none;">Đọc thêm...</a>

                    <!-- Thông tin kho -->
                    <h5 class="mt-4">Thông tin kho:</h5>
                    <ul class="ingredient-list">
                        <li><span class="material-symbols-outlined">push_pin</span> Vị trí: <strong>@Model.Sach.ViTri</strong></li>
                        <li><span class="material-symbols-outlined">inventory</span> Tổng số lượng: <strong>@Model.Sach.TongSoLuong</strong></li>
                        <li>
                            <span class="material-symbols-outlined">check_circle</span>
                            Hiện có sẵn:
                            @if (Model.Sach.SoLuongCoSan > 0)
                            {
                                <strong class="text-success ms-2">@Model.Sach.SoLuongCoSan cuốn</strong>
                            }
                            else
                            {
                                <strong class="text-danger ms-2">Đã thuê hết</strong>
                            }
                        </li>
                    </ul>

                </div>

                <!-- Cột thuê sách -->
                <div class="col-lg-3">
                    <div class="card sticky-top" style="top: 20px;">
                        <div class="card-body">
                            <h5 class="card-title">Thuê Sách</h5>
                            <hr />
                        </div>
                    </div>
                </div>

            </div>

            <!-- Gợi ý -->
            <div class="row mt-5">
                <div class="col-12">

                    <h3 class="border-bottom pb-2 mb-3 section-header">
                        <span class="material-symbols-outlined">recommend</span> Có thể bạn cũng thích
                    </h3>

                    @if (Model.Sach.GoiY?.Any() == true)
                    {
                        <div class="row row-cols-1 row-cols-md-4 g-4">

                            @foreach (var item in Model.Sach.GoiY)
                            {
                                var imgUrl = string.IsNullOrEmpty(item.AnhBiaUrl)
                                    ? "/images/default-book-cover.png"
                                    : item.AnhBiaUrl;

                                <div class="col">
                                    <a asp-page="/ChiTietSachView"
                                       asp-route-id="@item.IdSach"
                                       class="text-decoration-none">

                                        <div class="card h-100 product-card">
                                            <div class="card-img-container">
                                                <img src="@imgUrl"
                                                     class="card-img-top book-card-img"
                                                     alt="@item.TieuDe" />
                                            </div>

                                            <div class="card-body d-flex flex-column">
                                                <h6 class="book-card-title">@item.TieuDe</h6>
                                                <p class="card-text text-danger fw-bold mt-auto mb-0">
                                                    @item.GiaBia.ToString("N0") đ
                                                </p>
                                            </div>
                                        </div>

                                    </a>
                                </div>
                            }

                        </div>
                    }
                    else
                    {
                        <p class="text-muted">(Chưa có gợi ý nào cho cuốn sách này.)</p>
                    }

                </div>
            </div>

        }
        else
        {
            <div class="alert alert-danger">
                <h4>Không tìm thấy sách</h4>
                <p>@Model.ErrorMessage</p>
            </div>
            <a asp-page="/ThuVienSachView" class="btn btn-link">Quay lại thư viện</a>
        }

    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        $(function () {

            const $wrapper = $('#description-wrapper');
            const $content = $wrapper.find('p');
            const $btn = $('#toggle-description');

            // Lấy chiều cao dòng để tính 3 dòng
            const lineHeight = parseFloat($content.css("line-height"));
            const maxHeight = lineHeight * 3;

            // Nếu nội dung cao hơn 3 dòng => hiện nút
            if ($content[0].scrollHeight > maxHeight) {
                $btn.show();
            }

            // Toggle
            $btn.on("click", function () {
                const expanded = $wrapper.hasClass('description-expanded');

                $wrapper.toggleClass('description-expanded description-truncated');
                $btn.text(expanded ? "Đọc thêm..." : "Thu gọn");
            });
        });
    </script>
}

================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\ChiTietSachView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/ChiTietSachView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
// using WebCafebookApi.Services; // ĐÃ XÓA
// using System.Linq; // ĐÃ XÓA
// using Microsoft.AspNetCore.Http; // ĐÃ XÓA
// using System.Collections.Generic; // ĐÃ XÓA

namespace WebCafebookApi.Pages
{
    public class ChiTietSachViewModel : PageModel
    {
        // ... (Constructor và OnGetAsync giữ nguyên) ...
        private readonly IHttpClientFactory _httpClientFactory;
        public ChiTietSachViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        [BindProperty(SupportsGet = true)]
        public int Id { get; set; }

        public SachChiTietDto? Sach { get; set; }
        public string? ErrorMessage { get; set; }

        public async Task<IActionResult> OnGetAsync()
        {
            if (Id <= 0)
            {
                ErrorMessage = "ID sách không hợp lệ.";
                return Page();
            }

            var httpClient = _httpClientFactory.CreateClient("ApiClient");
            try
            {
                Sach = await httpClient.GetFromJsonAsync<SachChiTietDto>($"api/web/thuvien/{Id}");
                if (Sach == null)
                {
                    ErrorMessage = "Không tìm thấy cuốn sách bạn yêu cầu.";
                    return Page();
                }
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Lỗi khi tải chi tiết: {ex.Message}";
            }
            return Page();
        }


        // === CẬP NHẬT HÀM XỬ LÝ GIỎ HÀNG ===
        // 
        //  ĐÃ XÓA TOÀN BỘ PHƯƠNG THỨC OnPostAddToCart TỪ ĐÂY
        //
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\ChiTietSanPhamView.cshtml
================================================================================
﻿@page "{id:int}"
@model WebCafebookApi.Pages.ChiTietSanPhamViewModel
@{
    ViewData["Title"] = Model.SanPham?.TenSanPham ?? "Chi Tiết Sản Phẩm";
    var imgSrc = string.IsNullOrEmpty(Model.SanPham?.HinhAnhUrl) ? "/images/default-food-icon.png" : Model.SanPham.HinhAnhUrl;
}

<div class="container mt-5">
    <div class="main-content-card">

        @if (Model.SanPham != null)
        {
            <div class="row gy-4">
                @* Cột Hình ảnh *@
                <div class="col-lg-5">
                    <div class="detail-img-container">
                        <img src="@imgSrc" class="img-fluid rounded shadow-sm w-100" alt="@Model.SanPham.TenSanPham" style="max-height: 500px; object-fit: cover;">
                    </div>
                </div>

                @* Cột Thông tin *@
                <div class="col-lg-4">
                    <nav aria-label="breadcrumb" class="page-breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a asp-page="/TrangChuView"><span class="material-symbols-outlined">home</span> Trang Chủ</a></li>
                            <li class="breadcrumb-item"><a asp-page="/ThucDonView"><span class="material-symbols-outlined">restaurant_menu</span> Thực Đơn</a></li>
                            <li class="breadcrumb-item active" aria-current="page">@Model.SanPham.TenSanPham</li>
                        </ol>
                    </nav>

                    <h1 class="display-5 fw-bold">@Model.SanPham.TenSanPham</h1>
                    <p class="lead text-muted fs-5">@Model.SanPham.TenLoaiSP</p>
                    <h2 class="text-danger fw-bolder">@Model.SanPham.DonGia.ToString("N0") đ</h2>
                    <p class="mt-4 fs-5">@Model.SanPham.MoTa</p>

                    @if (Model.SanPham.CongThucs != null && Model.SanPham.CongThucs.Any())
                    {
                        <h5 class="mt-4">Thành phần chính:</h5>
                        <ul class="ingredient-list">
                            @foreach (var ingredient in Model.SanPham.CongThucs)
                            {
                                <li><span class="material-symbols-outlined">check_circle</span> @ingredient.TenNguyenLieu</li>
                            }
                        </ul>
                    }
                </div>

                @* Cột Đặt Hàng *@
                <div class="col-lg-3">
                    <div class="card sticky-top" style="top: 20px;">
                        <div class="card-body">
                            <h5 class="card-title">Đặt Món</h5>
                            <hr />

                            @if (TempData["CartMessage"] != null)
                            {
                                <div class="alert alert-success small">@TempData["CartMessage"]</div>
                            }

                            @if (User.Identity?.IsAuthenticated == true)
                            {
                                <form method="post" asp-page-handler="AddToCart">
                                    <input type="hidden" name="idSanPham" value="@Model.SanPham.IdSanPham" />

                                    <div class="mb-3">
                                        <label asp-for="SoLuong" class="form-label">Số lượng:</label>
                                        <input asp-for="SoLuong" type="number" class="form-control" value="1" min="1" />
                                    </div>

                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="bi bi-cart-plus"></i> Thêm vào giỏ
                                    </button>
                                </form>
                                <a asp-page="/GioHangView" class="btn btn-outline-success w-100 mt-2">
                                    <i class="bi bi-box-arrow-right"></i> Tới giỏ hàng
                                </a>
                            }
                            else
                            {
                                <p>Bạn cần đăng nhập để đặt món.</p>
                                <a asp-page="/account/DangNhapView" asp-route-returnUrl="@Url.Page("/ChiTietSanPhamView", new { id = Model.SanPham.IdSanPham })" class="btn btn-success w-100">
                                    Đăng nhập
                                </a>
                            }
                        </div>
                    </div>
                </div>
            </div> @* SỬA LỖI RZ1026: Thẻ div.row gy-4 được đóng ở đây *@

            @* Phần Gợi ý và Đánh giá (Giữ nguyên bên ngoài) *@
            <div class="row mt-5">
                <div class="col-12">
                    <h3 class="border-bottom pb-2 mb-3 section-header justify-content-start px-0">
                        <span class="material-symbols-outlined">reviews</span>
                        Đánh giá sản phẩm
                    </h3>
                    <p class="text-muted">(Tính năng xem và gửi đánh giá sẽ được cập nhật sau.)</p>
                </div>
            </div>
        }
        else
        {
            <div class="alert alert-danger">
                <h4>Không tìm thấy sản phẩm</h4>
                <p>@Model.ErrorMessage</p>
            </div>
            <a asp-page="/ThucDonView" class="btn btn-link">Quay lại thực đơn</a>
        }
    </div>
</div>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\ChiTietSanPhamView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/ChiTietSanPhamView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Json;
using System.Threading.Tasks;
using WebCafebookApi.Services;
using System.Collections.Generic;
using System.Linq;

namespace WebCafebookApi.Pages
{
    public class ChiTietSanPhamViewModel : PageModel
    {
        // ... (Constructor và OnGetAsync giữ nguyên) ...
        private readonly IHttpClientFactory _httpClientFactory;
        public ChiTietSanPhamViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        [BindProperty(SupportsGet = true)]
        public int Id { get; set; }

        [BindProperty]
        public int SoLuong { get; set; } = 1;

        public SanPhamChiTietDto? SanPham { get; set; }
        public string? ErrorMessage { get; set; }

        public async Task<IActionResult> OnGetAsync()
        {
            if (Id <= 0)
            {
                ErrorMessage = "ID sản phẩm không hợp lệ.";
                return Page();
            }

            var httpClient = _httpClientFactory.CreateClient("ApiClient");
            try
            {
                SanPham = await httpClient.GetFromJsonAsync<SanPhamChiTietDto>($"api/web/thucdon/{Id}");
            }
            catch (System.Net.Http.HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                ErrorMessage = "Không tìm thấy sản phẩm bạn yêu cầu.";
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Lỗi khi tải chi tiết: {ex.Message}";
            }

            return Page();
        }


        // === SỬA HÀM XỬ LÝ GIỎ HÀNG (XÓA 'Loai') ===
        public IActionResult OnPostAddToCart(int idSanPham)
        {
            var cart = HttpContext.Session.Get<List<CartItemDto>>(WebCafebookApi.Services.SessionExtensions.CartKey) ?? new List<CartItemDto>();

            // SỬA LỖI CS1061: Xóa 'Loai' khỏi logic tìm kiếm
            var existingItem = cart.FirstOrDefault(i => i.Id == idSanPham);

            if (existingItem != null)
            {
                existingItem.SoLuong += this.SoLuong;
                TempData["CartMessage"] = $"Đã cập nhật số lượng (tổng: {existingItem.SoLuong}).";
            }
            else
            {
                // SỬA LỖI CS0117: Xóa 'Loai' khỏi đối tượng
                cart.Add(new CartItemDto { Id = idSanPham, SoLuong = this.SoLuong });
                TempData["CartMessage"] = "Đã thêm sản phẩm vào giỏ!";
            }

            HttpContext.Session.Set(WebCafebookApi.Services.SessionExtensions.CartKey, cart);
            return RedirectToPage(new { id = idSanPham });
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\DatBanView.cshtml
================================================================================
﻿@page "/dat-ban"
@model WebCafebookApi.Pages.DatBanViewModel
@{
    ViewData["Title"] = "Đặt Bàn";
}

<style>
    /* Style cho nút bấm MẶC ĐỊNH hoặc 'available' */
    .table-select-btn {
        border-color: var(--cf-brown);
        color: var(--cf-dark-brown);
        opacity: 1;
        cursor: pointer;
    }

    /* Style cho DIV cha (cột) khi bàn không khả dụng */
    .table-item.unavailable {
        display: none;
        /* Ẩn hoàn toàn bàn không khả dụng */
    }
</style>

<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="fw-bold" style="color: var(--cf-brown);">ĐẶT BÀN TRỰC TUYẾN</h1>
        <p class="text-muted lead">Chọn thời gian và vị trí yêu thích của bạn</p>
    </div>

    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
            <i class="fa-solid fa-circle-check me-2"></i> @Model.SuccessMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
            <i class="fa-solid fa-circle-exclamation me-2"></i> @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="card shadow-sm border-0 mb-4" style="background-color: var(--cf-white);">
        <div class="card-body p-4">

            <form method="post" asp-page-handler="TimKiem" class="row g-3 align-items-end">
                <div class="col-lg-3 col-md-6">
                    <label asp-for="Search.Date" class="form-label fw-semibold">Ngày đặt</label>
                    <input type="date" class="form-control form-control-lg" asp-for="Search.Date" min="@DateTime.Today.ToString("yyyy-MM-dd")"
                           id="dateInput">
                    <span asp-validation-for="Search.Date" class="text-danger small"></span>
                </div>
                <div class="col-lg-3 col-md-6">
                    <label asp-for="Search.Time" class="form-label fw-semibold">Giờ đến</label>
                    <input type="text" class="form-control form-control-lg" asp-for="Search.Time" id="timeInput"
                           placeholder="HH:mm (ví dụ: 18:05)" />
                    <span asp-validation-for="Search.Time" class="text-danger small"></span>
                </div>
                <div class="col-lg-3 col-md-6">
                    <label asp-for="Search.People" class="form-label fw-semibold">Số người</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="fa-solid fa-user-group"></i></span>
                        <input type="number" class="form-control form-control-lg" asp-for="Search.People" min="1" max="50">
                    </div>
                    <span asp-validation-for="Search.People" class="text-danger small"></span>
                </div>

                <div class="col-lg-3 col-md-6">
                    <button type="submit" class="btn btn-primary w-100 py-3 fw-bold text-uppercase" style="border-radius: 50px;">
                        <i class="fa-solid fa-magnifying-glass me-2"></i> Kiểm tra bàn trống
                    </button>
                </div>
            </form>
        </div>
    </div>


    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 h-100" style="background-color: var(--cf-white);">
                <div class="card-body p-4">
                    <h4 class="card-title fw-bold mb-4" style="color: var(--cf-dark-brown);">
                        <i class="fa-solid fa-filter me-2"></i>Lọc theo khu vực
                    </h4>
                    <div class="list-group list-group-flush" id="areaFilterList">
                        <a class="list-group-item list-group-item-action active" href="#" data-khuvuc-id="all">
                            <i class="fa-solid fa-border-all me-2"></i> Tất cả khu vực
                        </a>
                        @foreach (var kv in Model.KhuVucList)
                        {
                            <a class="list-group-item list-group-item-action" href="#" data-khuvuc-id="@kv.IdKhuVuc">
                                <i class="fa-solid fa-location-dot me-2"></i> @kv.TenKhuVuc (@kv.BanList.Count)
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">

            @if (Model.IsSearched)
            {
                <h5 class="mb-3 text-muted">
                    Kết quả cho <strong>@Model.Search.People người</strong> vào lúc <strong>@Model.Search.Time</strong> ngày <strong>@Model.Search.Date.ToString("dd/MM/yyyy")</strong>:
                </h5>

                @if (!string.IsNullOrEmpty(Model.SearchSuccessMessage))
                {
                    <div class="alert alert-success">@Model.SearchSuccessMessage</div>
                }

            }
            else if (string.IsNullOrEmpty(Model.SuccessMessage) && string.IsNullOrEmpty(Model.ErrorMessage))
            {
                <h5 class="mb-3 text-muted">Vui lòng chọn thời gian để xem bàn trống</h5>
            }


            @foreach (var kv in Model.KhuVucList)
            {
                <div class="mb-4 area-group" data-area-id="@kv.IdKhuVuc">
                    <h4 class="fw-bold" style="color: var(--cf-dark-brown);">@kv.TenKhuVuc</h4>
                    <hr class="mt-2 mb-3">
                    <div class="row row-cols-2 row-cols-md-3 row-cols-xl-4 g-3">
                        @foreach (var ban in kv.BanList)
                        {
                            string tableStatusClass = "";
                            string buttonClass = "table-select-btn";

                            if (Model.IsSearched)
                            {
                                if (!Model.AvailableTableIds.Contains(ban.IdBan))
                                {
                                    tableStatusClass = "unavailable"; // Ẩn DIV cha
                                }
                            }

                            <div class="col table-item @tableStatusClass" data-table-ghe="@ban.SoGhe">
                                <button type="button"
                                        class="btn btn-outline-light w-100 h-100 p-3 text-start shadow-sm @buttonClass"
                                        data-bs-toggle="modal" data-bs-target="#confirmBookingModal"
                                        data-table-id="@ban.IdBan" data-table-name="@ban.SoBan"
                                        style="border-width: 2px;">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="badge bg-success">@ban.KhuVuc</span>
                                        <small class="text-muted"><i class="fa-solid fa-chair me-1"></i>@ban.SoGhe</small>
                                    </div>
                                    <h4 class="fw-bold mb-0">@ban.SoBan</h4>
                                </button>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<div class="modal fade" id="confirmBookingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white border-0">
                <h5 class="modal-title fw-bold">
                    <i class="fa-solid fa-clipboard-check me-2"></i>Xác nhận đặt bàn
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-info border-0 d-flex align-items-center" style="background-color: var(--cf-cream); color: var(--cf-dark-brown);">
                    <i class="fa-solid fa-circle-info me-3 fs-4"></i>
                    <div>
                        Bạn đang đặt <strong>Bàn <span id="modalTableName"></span></strong><br>
                        Vào lúc
                        <strong>@Model.Search.Time</strong> ngày <strong>@Model.Search.Date.ToString("dd/MM/yyyy")</strong>
                    </div>
                </div>

                <form method="post" asp-page-handler="Book" id="bookingForm">
                    <input type="hidden" asp-for="Search.Date" />
                    <input type="hidden" asp-for="Search.Time" />
                    <input type="hidden" asp-for="Search.People" />

                    <input type="hidden" asp-for="Booking.SelectedTableId" id="modalTableIdInput" />

                    @if (!User.Identity.IsAuthenticated)
                    {
                        <div class="mb-3">
                            <label asp-for="Booking.FullName" class="form-label fw-semibold">Họ và tên <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" asp-for="Booking.FullName" required placeholder="Nhập tên của bạn">
                            <span asp-validation-for="Booking.FullName" class="text-danger small"></span>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <label asp-for="Booking.Phone" class="form-label fw-semibold">Số điện thoại <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" asp-for="Booking.Phone" required placeholder="Nhập SĐT liên hệ">
                                <span asp-validation-for="Booking.Phone" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Booking.Email" class="form-label fw-semibold">Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" asp-for="Booking.Email" required placeholder="Nhận xác nhận qua email">
                                <span asp-validation-for="Booking.Email" class="text-danger small"></span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div id="loggedInUserInfo" class="mb-3">
                            <label class="form-label fw-semibold text-muted">Thông tin người đặt:</label>
                            <p class="form-control-plaintext fw-bold mb-0">@Model.Booking.FullName</p>
                            <p class="form-control-plaintext text-muted mt-0">
                                @Model.Booking.Phone
                                @if (!string.IsNullOrEmpty(Model.Booking.Email))
                                {
                                    <text>| @Model.Booking.Email</text>
                                }
                            </p>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="bookForOtherCheck">
                            <label class="form-check-label" for="bookForOtherCheck">
                                Đặt hộ cho người khác?
                            </label>
                        </div>

                        <div id="loggedInUserFields">
                            <input type="hidden" asp-for="Booking.FullName" />
                            <input type="hidden" asp-for="Booking.Phone" />
                            @if (!Model.IsLoggedInUserMissingEmail)
                            {
                                <input type="hidden" asp-for="Booking.Email" />
                            }
                        </div>

                        @if (Model.IsLoggedInUserMissingEmail)
                        {
                            <div class="mb-3" id="loggedInEmailInput">
                                <label asp-for="Booking.Email" class="form-label fw-semibold">Email của bạn <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" asp-for="Booking.Email" required placeholder="Chúng tôi cần email để xác nhận">
                                <span asp-validation-for="Booking.Email" class="text-danger small"></span>
                            </div>
                        }

                        <div id="bookForOtherFields" style="display: none;">
                            <div class="mb-3">
                                <label asp-for="Booking.FullName" class="form-label fw-semibold">Họ tên người được đặt hộ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" asp-for="Booking.FullName" placeholder="Nhập tên" disabled required>
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col-md-6">
                                    <label asp-for="Booking.Phone" class="form-label fw-semibold">SĐT người được đặt hộ <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" asp-for="Booking.Phone" placeholder="Nhập SĐT" disabled required>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="Booking.Email" class="form-label fw-semibold">Email người được đặt hộ <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" asp-for="Booking.Email" placeholder="Nhập Email" disabled required>
                                </div>
                            </div>
                        </div>
                    }

                    <div class="mb-3">
                        <label asp-for="Booking.Note" class="form-label fw-semibold">Ghi chú thêm</label>
                        <textarea class="form-control" asp-for="Booking.Note" rows="2" placeholder="VD: Cần ghế trẻ em, trang trí sinh nhật..."></textarea>
                    </div>

                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-primary py-3 fw-bold" style="border-radius: 50px;">
                            HOÀN TẤT ĐẶT BÀN
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // Logic truyền data vào Modal
            var confirmModal = document.getElementById('confirmBookingModal');
            if (confirmModal) {
                confirmModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    var tableId = button.getAttribute('data-table-id');
                    var tableName = button.getAttribute('data-table-name');
                    document.getElementById('modalTableIdInput').value = tableId;
                    document.getElementById('modalTableName').textContent = tableName;
                });
            }

            // Logic "Đặt Hộ"
            const bookForOtherCheck = document.getElementById('bookForOtherCheck');
            if (bookForOtherCheck) {
                const loggedInInfo = document.getElementById('loggedInUserInfo');
                const loggedInFields = document.getElementById('loggedInUserFields');
                const otherFields = document.getElementById('bookForOtherFields');
                const otherInputs = otherFields.querySelectorAll('input');
                const loggedInEmailInput = document.getElementById('loggedInEmailInput');
                const originalValues = {
                    name: loggedInFields.querySelector('input[name="Booking.FullName"]').value,
                    phone: loggedInFields.querySelector('input[name="Booking.Phone"]').value,
                    email: document.querySelector('input[name="Booking.Email"]').value
                };

                bookForOtherCheck.addEventListener('change', function () {
                    if (this.checked) {
                        loggedInInfo.style.display = 'none';
                        otherFields.style.display = 'block';
                        if (loggedInEmailInput) loggedInEmailInput.style.display = 'none'; // Ẩn ô email
                        otherInputs.forEach(i => { i.disabled = false; i.value = ''; });
                        loggedInFields.querySelectorAll('input').forEach(i => i.disabled = true);
                        if (loggedInEmailInput) loggedInEmailInput.querySelector('input').disabled = true;
                    } else {
                        loggedInInfo.style.display = 'block';
                        otherFields.style.display = 'none';
                        if (loggedInEmailInput) loggedInEmailInput.style.display = 'block'; // Hiện lại ô email
                        otherInputs.forEach(i => i.disabled = true);
                        loggedInFields.querySelectorAll('input').forEach(i => {
                            i.disabled = false;
                            if (i.name === "Booking.FullName") i.value = originalValues.name;
                            if (i.name === "Booking.Phone") i.value = originalValues.phone;
                        });
                        var emailInput = document.querySelector('input[name="Booking.Email"]');
                        if (emailInput) {
                            emailInput.disabled = false;
                            emailInput.value = originalValues.email;
                        }
                    }
                });
            }

            // Logic Lọc Khu Vực
            const areaLinks = document.querySelectorAll('#areaFilterList .list-group-item-action');
            const areaGroups = document.querySelectorAll('.area-group');
            areaLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    areaLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    const targetAreaId = this.getAttribute('data-khuvuc-id');
                    areaGroups.forEach(group => {
                        group.style.display = (targetAreaId === 'all' || group.getAttribute('data-area-id') === targetAreaId) ? 'block' : 'none';
                    });
                });
            });

            // ***** NÂNG CẤP MỚI: TỰ ĐỘNG ĐIỀN SĐT *****
            var phoneInput = document.querySelector('input[asp-for="Booking.Phone"]');
            var nameInput = document.querySelector('input[asp-for="Booking.FullName"]');
            var emailInput = document.querySelector('input[asp-for="Booking.Email"]');

            // Chỉ chạy khi 3 ô này tồn tại (tức là form khách vãng lai)
            if (phoneInput && nameInput && emailInput) {

                phoneInput.addEventListener('blur', function() { // 'blur' là khi người dùng bấm ra ngoài
                    var phone = this.value;
                    if (phone && phone.length >= 9) { // Chỉ tìm khi SĐT có vẻ hợp lệ

                        // Gọi API đã tạo ở DatBanWebController.cs
                        fetch(`/api/web/datban/get-customer-info?phone=${phone}`)
                            .then(response => {
                                if (response.ok) {
                                    return response.json();
                                }
                                throw new Error('Customer not found');
                            })
                            .then(data => {
                                // Tự động điền nếu SĐT tồn tại
                                if (nameInput.value === '') { // Chỉ điền nếu ô tên còn trống
                                    nameInput.value = data.hoTen;
                                }
                                if (emailInput.value === '') { // Chỉ điền nếu ô email còn trống
                                    emailInput.value = data.email;
                                }
                            })
                            .catch(error => {
                                // Không tìm thấy SĐT, không làm gì cả
                                console.log('Không tìm thấy thông tin SĐT.');
                            });
                    }
                });
            }
            // ***** HẾT PHẦN NÂNG CẤP *****

        });
    </script>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\DatBanView.cshtml.cs
================================================================================
﻿/*
* FILE ĐÃ SỬA LỖI LOGIC TRIỆT ĐỂ (V11-FINAL)
*
* GIẢI THÍCH LỖI GỐC:
* Thuộc tính [BindProperty] trên "BookingInfoModel Booking" đã khiến
* ASP.NET Core validate (kiểm tra) model này trên MỌI HÀNH ĐỘNG POST,
* kể cả khi nhấn nút "TimKiem" (vốn không cần Booking).
*
* CÁCH SỬA:
* 1. Đã XÓA [BindProperty] khỏi "public BookingInfoModel Booking".
* 2. Đã thêm [BindProperty] vào tham số của HÀM OnPostBookAsync().
* (public async Task<IActionResult> OnPostBookAsync([Bind(Prefix = "Booking")] BookingInfoModel bookingForm))
* 3. Đã đổi tên OnPostSearchAsync -> OnPostTimKiemAsync để khớp với file .cshtml.
*
* KẾT QUẢ:
* - Nút "TimKiem" sẽ KHÔNG BAO GIỜ validate "Booking" nữa -> Lỗi "Vui lòng nhập Email" sẽ biến mất.
* - Nút "Book" sẽ validate "Booking" như bình thường.
*/

using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.ComponentModel.DataAnnotations;
using System.Net.Http.Json;
using System.Security.Claims;

namespace WebCafebookApi.Pages
{
    public class DatBanViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;
        private readonly HttpClient _apiClient;

        public TimeSpan OpeningTime { get; set; } = new(6, 0, 0);
        public TimeSpan ClosingTime { get; set; } = new(23, 0, 0);


        public DatBanViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
            _apiClient = _httpClientFactory.CreateClient("WebClient");
            _apiClient.BaseAddress = new Uri("http://localhost:5166");
        }

        [BindProperty(SupportsGet = true)]
        public SearchModel Search { get; set; } = new();

        // SỬA LỖI: Đã XÓA [BindProperty] ở đây.
        // Chúng ta sẽ bind nó ở tham số hàm OnPostBookAsync.
        public BookingInfoModel Booking { get; set; } = new();

        public List<KhuVucBanDto> KhuVucList { get; set; } = new();
        public List<int> AvailableTableIds { get; set; } = new();
        public bool IsSearched { get; set; } = false;
        public string? ErrorMessage { get; set; }
        public string? SuccessMessage { get; set; }
        public string? SearchSuccessMessage { get; set; }

        public bool IsLoggedInUserMissingEmail { get; set; } = false;

        public class SearchModel
        {
            [Required(ErrorMessage = "Vui lòng chọn ngày")]
            [DataType(DataType.Date)]
            public DateTime Date { get; set; } = DateTime.Today;

            [Required(ErrorMessage = "Vui lòng chọn giờ")]
            public string Time { get; set; } = "09:00";

            [Required, Range(1, 50, ErrorMessage = "Số người từ 1-50")]
            public int People { get; set; } = 2;
        }

        public class BookingInfoModel
        {
            public int SelectedTableId { get; set; }
            public string? SelectedTableNumber { get; set; }

            [Required(ErrorMessage = "Vui lòng nhập họ tên")]
            public string FullName { get; set; } = string.Empty;

            [Required(ErrorMessage = "Vui lòng nhập SĐT")]
            [Phone(ErrorMessage = "SĐT không hợp lệ")]
            public string Phone { get; set; } = string.Empty;

            [Required(ErrorMessage = "Vui lòng nhập Email")]
            [EmailAddress(ErrorMessage = "Email không hợp lệ")]
            public string Email { get; set; } = string.Empty;

            public string? Note { get; set; }
        }

        public async Task OnGetAsync()
        {
            PopulateBookingInfoForUser();
            await LoadOpeningHoursAsync();
            await LoadAllTablesAsync();

            if (User.Identity?.IsAuthenticated == true && string.IsNullOrEmpty(Booking.Email))
            {
                IsLoggedInUserMissingEmail = true;
            }

            if (!Request.Query.ContainsKey("handler"))
            {
                if (Search.Date == DateTime.Today)
                {
                    Search.Time = GetDefaultStartTime(OpeningTime, ClosingTime);
                }
                else
                {
                    Search.Time = OpeningTime.ToString(@"hh\:mm");
                }
            }

            // SỬA LỖI: Đổi "Search" -> "TimKiem" để khớp với URL
            if (Request.Query.ContainsKey("handler") &&
                Request.Query["handler"] == "TimKiem")
            {
                await OnPostTimKiemAsync();
            }
        }

        // SỬA LỖI: Đổi tên hàm thành "OnPostTimKiemAsync" để khớp với .cshtml
        public async Task<IActionResult> OnPostTimKiemAsync()
        {
            // Populate lại thông tin user đăng nhập (nếu có)
            PopulateBookingInfoForUser();
            await LoadOpeningHoursAsync();
            await LoadAllTablesAsync();
            if (User.Identity?.IsAuthenticated == true && string.IsNullOrEmpty(Booking.Email))
            {
                IsLoggedInUserMissingEmail = true;
            }

            // 1. Kiểm tra validation CHỈ CỦA SearchModel
            // (Vì BookingModel không còn [BindProperty], nó sẽ không bị validate ở đây)
            if (!ModelState.IsValid)
            {
                IsSearched = false;
                ErrorMessage = ModelState.Values.SelectMany(v => v.Errors).FirstOrDefault()?.ErrorMessage ?? "Dữ liệu tìm kiếm không hợp lệ.";
                return Page();
            }

            // 2. Kiểm tra Time
            if (!TimeSpan.TryParse(Search.Time, out TimeSpan time))
            {
                ModelState.AddModelError("Search.Time", "Giờ không hợp lệ, vui lòng nhập dạng HH:mm");
                IsSearched = false;
                ErrorMessage = "Giờ không hợp lệ, vui lòng nhập dạng HH:mm";
                return Page();
            }

            // 3. Gọi API
            var req = new TimBanRequestDto
            {
                NgayDat = Search.Date,
                GioDat = time,
                SoNguoi = Search.People
            };

            var response = await _apiClient.PostAsJsonAsync("/api/web/datban/tim-ban", req);
            IsSearched = true;

            if (response.IsSuccessStatusCode)
            {
                var availableTables = await response.Content.ReadFromJsonAsync<List<BanTrongDto>>() ?? new List<BanTrongDto>();
                AvailableTableIds = availableTables.Select(b => b.IdBan).ToList();
                if (!AvailableTableIds.Any())
                {
                    ErrorMessage = "Rất tiếc, không còn bàn trống phù hợp với lựa chọn của bạn.";
                }
                else
                {
                    SearchSuccessMessage = $"Đã tìm thấy {AvailableTableIds.Count} bàn trống phù hợp.";
                }
            }
            else
            {
                ErrorMessage = await response.Content.ReadAsStringAsync();
            }

            return Page();
        }

        // SỬA LỖI: Thêm [BindProperty] vào tham số hàm
        public async Task<IActionResult> OnPostBookAsync([Bind(Prefix = "Booking")] BookingInfoModel bookingForm)
        {
            // Gán model được bind từ form vào property chính để hiển thị lại
            Booking = bookingForm;

            // Chạy lại logic load trang
            if (User.Identity?.IsAuthenticated == true && string.IsNullOrEmpty(Booking.FullName))
            {
                PopulateBookingInfoForUser();
            }
            if (User.Identity?.IsAuthenticated == true && string.IsNullOrEmpty(Booking.Email))
            {
                IsLoggedInUserMissingEmail = true;
            }
            await LoadOpeningHoursAsync();
            await LoadAllTablesAsync();

            // Luôn set IsSearched = true để hiển thị các bàn
            IsSearched = true;

            // Kiểm tra Time (phải kiểm tra thủ công vì nó thuộc model 'Search')
            if (!TimeSpan.TryParse(Search.Time, out TimeSpan time))
            {
                ModelState.AddModelError("Search.Time", "Giờ không hợp lệ.");
                ErrorMessage = "Giờ đặt bàn không hợp lệ.";
                // Tải lại các bàn trống (nếu có)
                await PopulateAvailableTablesAsync();
                return Page();
            }

            // Giờ kiểm tra ModelState (chỉ check 'Booking' vì nó là tham số, và 'Search' vì nó là [BindProperty])
            if (!ModelState.IsValid)
            {
                if (string.IsNullOrEmpty(ErrorMessage))
                {
                    ErrorMessage = ModelState.Values
                        .SelectMany(v => v.Errors)
                        .FirstOrDefault()?.ErrorMessage ?? "Thông tin không hợp lệ.";
                }
                // Tải lại các bàn trống (nếu có)
                await PopulateAvailableTablesAsync();
                return Page();
            }

            // Nếu mọi thứ hợp lệ, gọi API
            var req = new DatBanWebRequestDto
            {
                IdBan = Booking.SelectedTableId,
                NgayDat = Search.Date,
                GioDat = time,
                SoLuongKhach = Search.People,
                HoTen = Booking.FullName,
                SoDienThoai = Booking.Phone,
                Email = Booking.Email,
                GhiChu = Booking.Note
            };

            var response = await _apiClient.PostAsJsonAsync("/api/web/datban/tao-yeu-cau", req);

            if (response.IsSuccessStatusCode)
            {
                SuccessMessage = "Yêu cầu đặt bàn thành công! Vui lòng chờ xác nhận (qua Email hoặc SĐT).";
                IsSearched = false;
                AvailableTableIds.Clear();
                ModelState.Clear();

                // Đặt lại Search về giá trị mặc định
                Search = new SearchModel();
                await LoadOpeningHoursAsync(); // Tải lại giờ mở cửa để tính toán
                Search.Time = (Search.Date == DateTime.Today)
                    ? GetDefaultStartTime(OpeningTime, ClosingTime)
                    : OpeningTime.ToString(@"hh\:mm");

                // Đặt lại Booking
                Booking = new BookingInfoModel();
                PopulateBookingInfoForUser(); // Điền lại thông tin nếu đăng nhập

                if (User.Identity?.IsAuthenticated == true && string.IsNullOrEmpty(Booking.Email))
                {
                    IsLoggedInUserMissingEmail = true;
                }
            }
            else
            {
                ErrorMessage = await response.Content.ReadAsStringAsync();
                // Tải lại các bàn trống (nếu có)
                await PopulateAvailableTablesAsync();
            }

            return Page();
        }


        /// <summary>
        /// Đây là hàm helper mới, chỉ dùng cho OnPostBookAsync khi bị lỗi
        /// để tải lại danh sách bàn.
        /// </summary>
        private async Task PopulateAvailableTablesAsync()
        {
            if (TimeSpan.TryParse(Search.Time, out TimeSpan time))
            {
                var req = new TimBanRequestDto
                {
                    NgayDat = Search.Date,
                    GioDat = time,
                    SoNguoi = Search.People
                };
                var response = await _apiClient.PostAsJsonAsync("/api/web/datban/tim-ban", req);
                if (response.IsSuccessStatusCode)
                {
                    var tables = await response.Content.ReadFromJsonAsync<List<BanTrongDto>>() ?? new List<BanTrongDto>();
                    AvailableTableIds = tables.Select(b => b.IdBan).ToList();
                }
            }
            // Không set ErrorMessage ở đây, để giữ lỗi gốc (ví dụ: SĐT trùng)
        }


        // --- Helpers (Không đổi) ---
        private void PopulateBookingInfoForUser()
        {
            if (User.Identity?.IsAuthenticated == true)
            {
                // Chỉ điền nếu Booking rỗng (tránh ghi đè khi postback lỗi)
                if (string.IsNullOrEmpty(Booking.FullName) && string.IsNullOrEmpty(Booking.Phone))
                {
                    Booking.FullName = User.FindFirstValue(ClaimTypes.GivenName) ?? User.Identity.Name ?? "";
                    Booking.Phone = User.FindFirstValue(ClaimTypes.MobilePhone) ?? "";
                    Booking.Email = User.FindFirstValue(ClaimTypes.Email) ?? "";
                }
            }
        }

        private async Task LoadOpeningHoursAsync()
        {
            try
            {
                var hours = await _apiClient.GetFromJsonAsync<OpeningHoursDto>("/api/web/datban/get-opening-hours");
                if (hours != null)
                {
                    OpeningTime = hours.Open;
                    ClosingTime = hours.Close;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine("Loi khi tai gio mo cua: " + ex.Message);
            }
        }

        private async Task LoadAllTablesAsync()
        {
            if (!KhuVucList.Any())
            {
                try
                {
                    KhuVucList = await _apiClient.GetFromJsonAsync<List<KhuVucBanDto>>("/api/web/datban/get-all-tables-by-area") ?? new List<KhuVucBanDto>();
                }
                catch (Exception ex)
                {
                    ErrorMessage = "Lỗi khi tải danh sách bàn: " + ex.Message;
                }
            }
        }

        private string GetDefaultStartTime(TimeSpan open, TimeSpan close)
        {
            var now = DateTime.Now;
            var nowPlus10Min = now.AddMinutes(10);

            int minutes = nowPlus10Min.Minute;
            int minutesToAdd = (minutes % 30 == 0) ? 0 : (30 - (minutes % 30));
            var defaultTime = nowPlus10Min.AddMinutes(minutesToAdd);

            var defaultTimeSpan = defaultTime.TimeOfDay;

            if (defaultTimeSpan < open) return open.ToString(@"hh\:mm");
            if (defaultTimeSpan >= close) return open.ToString(@"hh\:mm");

            return defaultTime.ToString("HH:mm");
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\GioHangView.cshtml
================================================================================
﻿@page
@model WebCafebookApi.Pages.GioHangViewPageModel
@{
    ViewData["Title"] = "Giỏ Hàng";
}

<div class="container mt-5">
    <div class="main-content-card">
        <h1 class="display-5 fw-bold">Giỏ Hàng Của Bạn</h1>
        <hr />

        @if (Model.Cart.Items == null || !Model.Cart.Items.Any())
        {
            <div class="alert alert-info text-center" style="padding: 50px;">
                <span class="material-symbols-outlined" style="font-size: 48px;">shopping_cart</span>
                <h4 class="mt-3">Giỏ hàng của bạn đang trống</h4>
                <p>Hãy khám phá thêm sách và thực đơn của Cafebook nhé!</p>
                @* SỬA: Xóa link xem thư viện sách *@
                <a asp-page="/ThucDonView" class="btn btn-success">Xem Thực Đơn</a>
            </div>
        }
        else
        {
            <div class="row">
                <div class="col-lg-8">
                    @foreach (var item in Model.Cart.Items)
                    {
                        <div class="card mb-3 shadow-sm">
                            <div class="row g-0">
                                <div class="col-md-2 d-flex align-items-center justify-content-center p-2">
                                    <img src="@(item.HinhAnhUrl ?? "/images/default-food-icon.png")"
                                         class="img-fluid rounded" alt="@item.TenHienThi" style="max-height: 120px; object-fit: cover;">
                                </div>
                                <div class="col-md-10">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h5 class="card-title mb-1">@item.TenHienThi</h5>

                                                <span class="badge bg-success">Thức uống/Món</span>

                                                <p class="card-text text-muted mb-1">Đơn giá: @item.DonGia.ToString("N0") đ</p>
                                            </div>
                                            <div class="text-end">
                                                <h5 class="text-danger fw-bold">@item.ThanhTien.ToString("N0") đ</h5>
                                                <form method="post" class="mt-2">
                                                    <input type="hidden" name="id" value="@item.Id" />

                                                    <input type="number" name="soLuong" value="@item.SoLuong" min="1" class="form-control-sm" style="width: 60px;" />
                                                    <button type="submit" asp-page-handler="UpdateQuantity" class="btn btn-sm btn-outline-secondary" title="Cập nhật">
                                                        <span class="material-symbols-outlined" style="font-size: 18px;">sync</span>
                                                    </button>

                                                    <button type="submit" asp-page-handler="Remove" class="btn btn-sm btn-outline-danger" title="Xóa">
                                                        <span class="material-symbols-outlined" style="font-size: 18px;">delete</span>
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <div class="col-lg-4">
                    <div class="card sticky-top" style="top: 20px;">
                        <div class="card-body">
                            <h5 class="card-title">Tóm tắt đơn hàng</h5>
                            <hr />
                            <div class="d-flex justify-content-between fs-5 mb-3">
                                <span>Tổng cộng</span>
                                <strong class="text-danger">@Model.Cart.TongTien.ToString("N0") đ</strong>
                            </div>
                            <a asp-page="/Account/ThanhToanView" class="btn btn-primary w-100 btn-lg">
                                Tiến hành thanh toán
                                <span class="material-symbols-outlined" style="vertical-align: middle;">arrow_forward</span>
                            </a>
                            <a asp-page="/ThucDonView" class="btn btn-outline-secondary w-100 mt-2">
                                + Thêm món khác
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\GioHangView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/GioHangView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Collections.Generic;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using WebCafebookApi.Services;
using System.Linq;

namespace WebCafebookApi.Pages
{
    public class GioHangViewPageModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;
        public GioHangViewPageModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        public GioHangViewModel Cart { get; set; } = new();
        public string? ErrorMessage { get; set; }

        public async Task<IActionResult> OnGetAsync()
        {
            var sessionCart = HttpContext.Session.Get<List<CartItemDto>>(WebCafebookApi.Services.SessionExtensions.CartKey);
            if (sessionCart == null || !sessionCart.Any())
            {
                return Page();
            }

            var httpClient = _httpClientFactory.CreateClient("ApiClient");
            var populatedItems = new List<GioHangItemViewModel>();

            foreach (var item in sessionCart)
            {
                try
                {
                    // SỬA: Xóa bỏ logic kiểm tra "Sach"
                    // Giờ chỉ tải "SanPham"
                    var sp = await httpClient.GetFromJsonAsync<SanPhamChiTietDto>($"api/web/thucdon/{item.Id}");
                    if (sp != null)
                    {
                        populatedItems.Add(new GioHangItemViewModel
                        {
                            Id = item.Id,
                            // Xóa "Loai"
                            TenHienThi = sp.TenSanPham,
                            HinhAnhUrl = sp.HinhAnhUrl,
                            DonGia = sp.DonGia,
                            SoLuong = item.SoLuong
                        });
                    }
                }
                catch (System.Exception ex)
                {
                    ErrorMessage = "Lỗi khi tải thông tin giỏ hàng: " + ex.Message;
                }
            }
            Cart.Items = populatedItems;
            return Page();
        }

        // SỬA: Xóa tham số "loai"
        public IActionResult OnPostRemove(int id)
        {
            var sessionCart = HttpContext.Session.Get<List<CartItemDto>>(WebCafebookApi.Services.SessionExtensions.CartKey);
            if (sessionCart != null)
            {
                // SỬA: Tìm chỉ bằng Id
                var itemToRemove = sessionCart.FirstOrDefault(i => i.Id == id);
                if (itemToRemove != null)
                {
                    sessionCart.Remove(itemToRemove);
                    HttpContext.Session.Set(WebCafebookApi.Services.SessionExtensions.CartKey, sessionCart);
                }
            }
            return RedirectToPage();
        }

        // SỬA: Xóa tham số "loai"
        public IActionResult OnPostUpdateQuantity(int id, int soLuong)
        {
            // SỬA: Xóa kiểm tra "Sach"
            if (soLuong <= 0)
            {
                // Nếu cập nhật số lượng về 0, hãy xóa nó
                return OnPostRemove(id);
            }

            var sessionCart = HttpContext.Session.Get<List<CartItemDto>>(WebCafebookApi.Services.SessionExtensions.CartKey);
            if (sessionCart != null)
            {
                // SỬA: Tìm chỉ bằng Id
                var itemToUpdate = sessionCart.FirstOrDefault(i => i.Id == id);
                if (itemToUpdate != null)
                {
                    itemToUpdate.SoLuong = soLuong;
                    HttpContext.Session.Set(WebCafebookApi.Services.SessionExtensions.CartKey, sessionCart);
                }
            }
            return RedirectToPage();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\LienHeView.cshtml
================================================================================
﻿@page
@model WebCafebookApi.Pages.LienHeViewModel
@{
    ViewData["Title"] = "Liên Hệ";
}

@* Thêm Font Awesome (nếu _Layout chưa có) *@
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
}

<style>
    .contact-icon {
        font-size: 1.5rem;
        color: var(--bs-primary, #0d6efd);
        width: 40px; /* Căn chỉnh icon */
    }

    .contact-info li {
        font-size: 1.1rem;
        margin-bottom: 1rem;
    }

    .social-icon {
        font-size: 1.75rem;
        color: #333;
        transition: color .2s;
    }

        .social-icon:hover {
            color: var(--bs-primary, #0d6efd);
        }
</style>

<div class="container mt-5">
    <div class="text-center mb-5">
        <h1>Liên Hệ Với Chúng Tôi</h1>
        <p class="lead">Cafebook luôn sẵn sàng lắng nghe bạn. Đừng ngần ngại gửi phản hồi hoặc ghé thăm chúng tôi!</p>
    </div>

    <div class="row g-5">
        <div class="col-lg-5">
            <h3 class="mb-4">Thông Tin Chung</h3>

            <p>
                @(Model.Info.GioiThieu ?? "⚙️ Thông tin giới thiệu đang được cập nhật...")
            </p>

            <ul class="list-unstyled contact-info mt-4">
                <li class="d-flex align-items-start">
                    <i class="fas fa-map-marker-alt contact-icon text-center me-3"></i>
                    <span>@(Model.Info.DiaChi ?? "⚙️ Địa chỉ đang cập nhật...")</span>
                </li>
                <li class="d-flex align-items-start">
                    <i class="fas fa-phone contact-icon text-center me-3"></i>
                    <span>@(Model.Info.SoDienThoai ?? "⚙️ SĐT đang cập nhật...")</span>
                </li>
                <li class="d-flex align-items-start">
                    <i class="fas fa-envelope contact-icon text-center me-3"></i>
                    <span>@(Model.Info.EmailLienHe ?? "⚙️ Email đang cập nhật...")</span>
                </li>
                <li class="d-flex align-items-start">
                    <i class="fas fa-clock contact-icon text-center me-3"></i>
                    <span>@(Model.Info.GioMoCua ?? "⚙️ Giờ mở cửa đang cập nhật...")</span>
                </li>
            </ul>

            <h5 class="mt-4">Theo dõi chúng tôi</h5>
            <div class="mt-3">
                @if (!string.IsNullOrWhiteSpace(Model.Info.LinkFacebook))
                {
                    <a href="@Model.Info.LinkFacebook" class="social-icon me-3" target="_blank" rel="noopener noreferrer" title="Facebook"><i class="fab fa-facebook-square"></i></a>
                }
                @if (!string.IsNullOrWhiteSpace(Model.Info.LinkInstagram))
                {
                    <a href="@Model.Info.LinkInstagram" class="social-icon me-3" target="_blank" rel="noopener noreferrer" title="Instagram"><i class="fab fa-instagram-square"></i></a>
                }
                @if (!string.IsNullOrWhiteSpace(Model.Info.LinkZalo))
                {
                    <a href="@Model.Info.LinkZalo" class="social-icon me-3" target="_blank" rel="noopener noreferrer" title="Zalo">
                        <i class="fa-solid fa-comment"></i>
                        <small style="font-size: 0.5em; vertical-align: top;">Zalo</small>
                    </a>
                }
                @if (!string.IsNullOrWhiteSpace(Model.Info.LinkYoutube))
                {
                    <a href="@Model.Info.LinkYoutube" class="social-icon" target="_blank" rel="noopener noreferrer" title="Youtube"><i class="fab fa-youtube-square"></i></a>
                }
            </div>
        </div>

        <div class="col-lg-7">
            <h3 class="mb-4">Tìm Chúng Tôi</h3>
            <div class="card shadow-sm mb-4" style="height: 300px;">
                @if (string.IsNullOrWhiteSpace(Model.Info.LinkGoogleMapsEmbed))
                {
                    <div class="card-body d-flex align-items-center justify-content-center text-muted">
                        ⚙️ Bản đồ đang được cập nhật...
                    </div>
                }
                else
                {
                    <iframe src="@Model.Info.LinkGoogleMapsEmbed"
                            height="300" style="border:0; width:100%;"
                            allowfullscreen="" loading="lazy"
                            referrerpolicy="no-referrer-when-downgrade"></iframe>
                }
            </div>

            <h3 class="mb-4">Gửi Góp Ý</h3>
            @if (!string.IsNullOrEmpty(Model.SuccessMessage))
            {
                <div class="alert alert-success">@Model.SuccessMessage</div>
            }
            @if (!string.IsNullOrEmpty(Model.ErrorMessage))
            {
                <div class="alert alert-danger">@Model.ErrorMessage</div>
            }

            <form method="post">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="ModelOnly" class="text-danger mb-3" role="alert"></div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="PhanHoiInput.Ten" class="form-label">Tên của bạn <span class="text-danger">*</span></label>
                        <input type="text" asp-for="PhanHoiInput.Ten" class="form-control" />
                        <span asp-validation-for="PhanHoiInput.Ten" class="text-danger small"></span>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="PhanHoiInput.Email" class="form-label">Email <span class="text-danger">*</span></label>
                        <input type="email" asp-for="PhanHoiInput.Email" class="form-control" />
                        <span asp-validation-for="PhanHoiInput.Email" class="text-danger small"></span>
                    </div>
                    <div class="col-12">
                        <label asp-for="PhanHoiInput.NoiDung" class="form-label">Nội dung <span class="text-danger">*</span></label>
                        <textarea asp-for="PhanHoiInput.NoiDung" class="form-control" rows="5"></textarea>
                        <span asp-validation-for="PhanHoiInput.NoiDung" class="text-danger small"></span>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary mt-3">Gửi Phản Hồi</button>
                <p class="text-muted small mt-2">⚙️ Tính năng này đang được cập nhật. Phản hồi của bạn sẽ được ghi lại trong log hệ thống.</p>
            </form>

        </div>
    </div>
</div>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\LienHeView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/LienHeView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.ComponentModel.DataAnnotations;
using System.Net.Http.Json;
using System.Threading.Tasks;

// SỬA: Đảm bảo namespace chính xác
namespace WebCafebookApi.Pages
{
    public class LienHeViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        public LienHeViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        // SỬA: Dùng DTO mới
        public LienHeDto Info { get; set; } = new LienHeDto();

        [BindProperty]
        public PhanHoiInputModel PhanHoiInput { get; set; } = new PhanHoiInputModel();

        [TempData]
        public string? SuccessMessage { get; set; }
        [TempData]
        public string? ErrorMessage { get; set; }

        public async Task OnGetAsync()
        {
            var httpClient = _httpClientFactory.CreateClient();
            try
            {
                // SỬA: Gọi API mới
                var response = await httpClient.GetFromJsonAsync<LienHeDto>("http://localhost:5166/api/web/lienhe/info");
                if (response != null)
                {
                    Info = response;
                }
            }
            catch (Exception)
            {
                Info = new LienHeDto(); // Khởi tạo rỗng nếu lỗi
            }
        }

        public async Task<IActionResult> OnPostAsync()
        {
            if (!ModelState.IsValid)
            {
                await OnGetAsync();
                return Page();
            }

            try
            {
                // Logic giả lập gửi phản hồi (vì chưa có API)
                System.Diagnostics.Debug.WriteLine($"--- PHAN HOI MOI ---");
                System.Diagnostics.Debug.WriteLine($"Ten: {PhanHoiInput.Ten}");
                System.Diagnostics.Debug.WriteLine($"Email: {PhanHoiInput.Email}");
                System.Diagnostics.Debug.WriteLine($"Noi Dung: {PhanHoiInput.NoiDung}");
                System.Diagnostics.Debug.WriteLine($"---------------------");

                SuccessMessage = "Cảm ơn bạn! Chúng tôi đã nhận được góp ý.";

                ModelState.Clear();
                PhanHoiInput = new PhanHoiInputModel();
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Lỗi: {ex.Message}";
            }

            await OnGetAsync();
            return Page();
        }

        public class PhanHoiInputModel
        {
            [Required(ErrorMessage = "Vui lòng nhập tên của bạn.")]
            public string Ten { get; set; } = string.Empty;

            [Required(ErrorMessage = "Vui lòng nhập email.")]
            [EmailAddress(ErrorMessage = "Email không hợp lệ.")]
            public string Email { get; set; } = string.Empty;

            [Required(ErrorMessage = "Vui lòng nhập nội dung.")]
            [MinLength(10, ErrorMessage = "Nội dung phải có ít nhất 10 ký tự.")]
            public string NoiDung { get; set; } = string.Empty;
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\ThucDonView.cshtml
================================================================================
﻿@page
@model WebCafebookApi.Pages.ThucDonViewModel
@{
    ViewData["Title"] = "Thực Đơn";
    // ... (routeData giữ nguyên) ...
    var routeData = new Dictionary<string, string?>
    {
        { "LoaiId", Model.LoaiId?.ToString() },
        { "Search", Model.Search },
        { "SortBy", Model.SortBy },
        { "GiaMin", Model.GiaMin?.ToString() },
        { "GiaMax", Model.GiaMax?.ToString() }
    };
}

<div class="container mt-4">
    <div class="text-center mb-4">
        <h1>@ViewData["Title"]</h1>
        <p class="lead text-muted">Khám phá các món ăn và đồ uống đặc sắc tại Cafebook.</p>
    </div>

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger">@Model.ErrorMessage</div>
    }

    <div class="row">
        <div class="col-lg-3 mb-4">
            <form method="get" asp-page="/ThucDonView">
                <div class="card sticky-top filter-card" style="top: 20px;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.5rem;">filter_list</span>
                            Tìm & Lọc
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3 material-input-group">
                            <label asp-for="Search" class="form-label fw-bold">Tìm theo tên</label>
                            <input asp-for="Search" class="material-input" placeholder="Cà phê sữa...">
                        </div>

                        <div class="mb-3 material-input-group">
                            <label asp-for="LoaiId" class="form-label fw-bold">Danh mục</label>
                            <select asp-for="LoaiId" asp-items="@Model.LoaiSanPhamsList" class="material-select"></select>
                        </div>

                        <div class="mb-3 material-input-group">
                            <label class="form-label fw-bold">Khoảng giá</label>
                            <div class="input-group">
                                <input asp-for="GiaMin" class="material-input" placeholder="Từ" type="number" step="1000">
                                <input asp-for="GiaMax" class="material-input" placeholder="Đến" type="number" step="1000">
                            </div>
                        </div>

                        <div class="mb-3 material-input-group">
                            <label asp-for="SortBy" class="form-label fw-bold">Sắp xếp</label>
                            <select asp-for="SortBy" class="material-select">
                                <option value="ten_asc">Tên (A-Z)</option>
                                <option value="ten_desc">Tên (Z-A)</option>
                                <option value="gia_asc">Giá (Thấp đến Cao)</option>
                                <option value="gia_desc">Giá (Cao đến Thấp)</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">Áp dụng</button>
                        <a asp-page="/ThucDonView" class="btn btn-link text-muted w-100 mt-2">Xóa bộ lọc</a>
                    </div>
                </div>
            </form>
        </div>

        <div class="col-lg-9">
            <div class="row row-cols-1 row-cols-md-3 g-4">
                @if (Model.MenuResult != null && Model.MenuResult.Items.Any())
                {
                    @foreach (var item in Model.MenuResult.Items)
                    {
                        <div class="col">
                            <a asp-page="/ChiTietSanPhamView" asp-route-id="@item.IdSanPham" class="text-decoration-none">
                                <div class="card h-100 shadow-sm product-card">
                                    @{
                                        var imgSrc = string.IsNullOrEmpty(item.AnhSanPhamUrl)
                                        ? "/images/default-food-icon.png"
                                        : item.AnhSanPhamUrl;
                                    }
                                    <div class="card-img-container">
                                        <img src="@imgSrc" class="card-img-top product-card-img" alt="@item.TenSanPham">
                                    </div>
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title text-decoration-none">@item.TenSanPham</h5>
                                        <p class="card-text text-muted small">@item.TenLoaiSP</p>
                                        <h5 class="card-subtitle mt-auto mb-2 text-danger fw-bold">@item.DonGia.ToString("N0") đ</h5>
                                    </div>
                                </div>
                            </a>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12">
                        <p class="text-center text-muted fs-5 mt-5">Không tìm thấy sản phẩm nào phù hợp.</p>
                    </div>
                }
            </div>

        </div>
    </div>
</div>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\ThucDonView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/ThucDonView.cshtml.cs
using CafebookModel.Model.ModelApp; // For FilterLookupDto
using CafebookModel.Model.ModelWeb; // For ThucDonDto
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.AspNetCore.Mvc.Rendering; // For SelectListItem
using System.Collections.Generic;
using System.Linq;
using System.Net.Http.Json;
using System.Threading.Tasks;

namespace WebCafebookApi.Pages
{
    public class ThucDonViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        // Thuộc tính để hứng dữ liệu từ API
        public ThucDonDto? MenuResult { get; set; }
        public List<SelectListItem> LoaiSanPhamsList { get; set; } = new();
        public string? ErrorMessage { get; set; }

        // --- Thuộc tính [BindProperty] cho Form (Filters) ---
        [BindProperty(SupportsGet = true)]
        public string? Search { get; set; }

        [BindProperty(SupportsGet = true)]
        public int? LoaiId { get; set; }

        [BindProperty(SupportsGet = true)]
        public decimal? GiaMin { get; set; }

        [BindProperty(SupportsGet = true)]
        public decimal? GiaMax { get; set; }

        [BindProperty(SupportsGet = true)]
        public string SortBy { get; set; } = "ten_asc";

        [BindProperty(SupportsGet = true)]
        public int PageNum { get; set; } = 1;
        // ----------------------------------------------------

        public ThucDonViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        public async Task OnGetAsync()
        {
            var httpClient = _httpClientFactory.CreateClient();

            try
            {
                // 1. Tải bộ lọc (Danh mục)
                var filters = await httpClient.GetFromJsonAsync<List<FilterLookupDto>>("http://localhost:5166/api/web/thucdon/filters");
                LoaiSanPhamsList.Add(new SelectListItem("Tất cả danh mục", "0"));
                if (filters != null)
                {
                    LoaiSanPhamsList.AddRange(filters.Select(f => new SelectListItem(f.Ten, f.Id.ToString())));
                }

                // 2. Tải danh sách sản phẩm (có phân trang & lọc)
                var queryString = $"?loaiId={LoaiId ?? 0}&search={Search}&sortBy={SortBy}&giaMin={GiaMin}&giaMax={GiaMax}&pageNum={PageNum}";
                MenuResult = await httpClient.GetFromJsonAsync<ThucDonDto>($"http://localhost:5166/api/web/thucdon/search{queryString}");
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Không thể tải thực đơn. Đảm bảo API (http://localhost:5166) đang chạy. Lỗi: {ex.Message}";
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\ThuVienSachView.cshtml
================================================================================
﻿@page
@model WebCafebookApi.Pages.ThuVienSachViewModel
@{
    ViewData["Title"] = "Thư Viện Sách";
    // ... (routeData giữ nguyên) ...
    var routeData = new Dictionary<string, string?>
    {
        { "TheLoai", Model.TheLoai?.ToString() },
        { "Search", Model.Search },
        { "SortBy", Model.SortBy },
        { "TrangThai", Model.TrangThai }
    };
}

<div class="container mt-5">
    <div class="main-content-card">

        <div class="text-center mb-4">
            <h1 class="page-title">@ViewData["Title"]</h1>
            <p class="page-lead">Khám phá kho tàng tri thức trong khi thưởng thức ly cà phê của bạn.</p>
        </div>

        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="alert alert-danger">@Model.ErrorMessage</div>
        }

        <div class="card filter-card mb-4">
            <div class="card-body">
                <form method="get" asp-page="/ThuVienSachView">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4 material-input-group">
                            <label asp-for="Search" class="form-label">Tìm theo tên, tác giả</label>
                            <input asp-for="Search" class="material-input" placeholder="Dế Mèn Phiêu Lưu Ký...">
                        </div>
                        <div class="col-md-2 material-input-group">
                            <label asp-for="TheLoai" class="form-label">Thể loại</label>
                            <select asp-for="TheLoai" asp-items="@Model.TheLoaiList" class="material-select"></select>
                        </div>
                        <div class="col-md-2 material-input-group">
                            <label asp-for="TrangThai" class="form-label">Tình trạng</label>
                            <select asp-for="TrangThai" asp-items="@Model.TrangThaiList" class="material-select"></select>
                        </div>
                        <div class="col-md-2 material-input-group">
                            <label asp-for="SortBy" class="form-label">Sắp xếp</label>
                            <select asp-for="SortBy" asp-items="@Model.SortList" class="material-select"></select>
                        </div>
                        <div class="col-md-2 d-grid">
                            <button type="submit" class="btn btn-primary">Tìm kiếm</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 g-4">
            @if (Model.SachResult != null && Model.SachResult.Items.Any())
            {
                @foreach (var sach in Model.SachResult.Items)
                {
                    <div class="col">
                        <div class="card h-100 shadow-sm product-card">
                            @{
                                // SỬA: Dùng AnhBiaUrl
                                var imgSrc = string.IsNullOrEmpty(sach.AnhBiaUrl) ? "/images/default-book-cover.png" : sach.AnhBiaUrl;
                            }
                            <a asp-page="/ChiTietSachView" asp-route-id="@sach.IdSach">
                                <div class="card-img-container">
                                    <img src="@imgSrc" class="card-img-top book-card-img" alt="@sach.TieuDe">
                                </div>
                            </a>
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title book-card-title">
                                    <a asp-page="/ChiTietSachView" asp-route-id="@sach.IdSach" class="text-decoration-none text-dark stretched-link">
                                        @sach.TieuDe
                                    </a>
                                </h5>
                                <p class="card-text text-muted small book-card-author">@sach.TacGia</p>
                                <div class="mt-auto d-flex justify-content-between align-items-center">
                                    <span class="text-danger fw-bold">@sach.GiaBia.ToString("N0") đ <small>(Cọc)</small></span>
                                    @if (sach.SoLuongCoSan > 0)
                                    {
                                        <span class="badge bg-success">Còn sách</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Đã thuê hết</span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12">
                    <p class="text-center text-muted fs-5 mt-5">Không tìm thấy cuốn sách nào phù hợp.</p>
                </div>
            }
        </div>

        @if (Model.SachResult != null && Model.SachResult.TotalPages > 1)
        {
            <nav aria-label="Trang thư viện" class="mt-5">
                <ul class="pagination justify-content-center">
                     </ul>
            </nav>
        }

    </div> </div> 
    @section Styles {
    <style>
        .book-card-img {
            height: 300px;
            object-fit: cover;
        }
        .book-card-title {
            font-size: 1rem;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            height: 2.5em; /* 1.25em * 2 */
        }
        .book-card-author {
            font-size: 0.9rem;
            height: 1.5em; /* Giới hạn 1 dòng */
            overflow: hidden;
        }
    </style>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\ThuVienSachView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/ThuVienSachView.cshtml.cs
using CafebookModel.Model.ModelApp; // For FilterLookupDto
using CafebookModel.Model.ModelWeb; // For SachPhanTrangDto
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.AspNetCore.Mvc.Rendering;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http.Json;
using System.Threading.Tasks;

namespace WebCafebookApi.Pages
{
    public class ThuVienSachViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        // Dữ liệu trả về
        public SachPhanTrangDto? SachResult { get; set; }
        public string? ErrorMessage { get; set; }

        // Dữ liệu cho bộ lọc
        public List<SelectListItem> TheLoaiList { get; set; } = new();
        public List<SelectListItem> TrangThaiList { get; set; } = new();
        public List<SelectListItem> SortList { get; set; } = new();

        // --- Thuộc tính [BindProperty] cho Form (Filters) ---
        [BindProperty(SupportsGet = true)]
        public string? Search { get; set; }

        [BindProperty(SupportsGet = true)]
        public int? TheLoai { get; set; } // Dùng int? cho "Tất cả"

        [BindProperty(SupportsGet = true)]
        public string? TrangThai { get; set; }

        [BindProperty(SupportsGet = true)]
        public string SortBy { get; set; } = "ten_asc";

        [BindProperty(SupportsGet = true)]
        public int PageNum { get; set; } = 1;

        public ThuVienSachViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        public async Task OnGetAsync()
        {
            var httpClient = _httpClientFactory.CreateClient();

            try
            {
                // 1. Tải bộ lọc (Thể loại)
                // SỬA LỖI CS0104: Chỉ định rõ namespace ModelWeb
                var filters = await httpClient.GetFromJsonAsync<CafebookModel.Model.ModelWeb.SachFiltersDto>("http://localhost:5166/api/web/thuvien/filters");
                TheLoaiList.Add(new SelectListItem("Tất cả thể loại", "0"));
                if (filters != null)
                {
                    TheLoaiList.AddRange(filters.TheLoais.Select(f => new SelectListItem(f.Ten, f.Id.ToString())));
                }

                // 2. Tải bộ lọc tĩnh (Trạng thái, Sắp xếp)
                TrangThaiList.Add(new SelectListItem("Tất cả", "all"));
                TrangThaiList.Add(new SelectListItem("Còn sách", "con_sach"));
                TrangThaiList.Add(new SelectListItem("Hết sách", "het_sach"));

                SortList.Add(new SelectListItem("Tên (A-Z)", "ten_asc"));
                SortList.Add(new SelectListItem("Tên (Z-A)", "ten_desc"));
                SortList.Add(new SelectListItem("Tiền cọc (Thấp-Cao)", "gia_asc"));
                SortList.Add(new SelectListItem("Tiền cọc (Cao-Thấp)", "gia_desc"));

                // 3. Tải danh sách Sách (có phân trang & lọc)
                var queryString = $"?search={Search}&theLoaiId={TheLoai ?? 0}&trangThai={TrangThai}&sortBy={SortBy}&pageNum={PageNum}";
                SachResult = await httpClient.GetFromJsonAsync<SachPhanTrangDto>($"http://localhost:5166/api/web/thuvien/search{queryString}");
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Không thể tải thư viện sách. Đảm bảo API (http://localhost:5166) đang chạy. Lỗi: {ex.Message}";
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\TimKiemSachView.cshtml
================================================================================
﻿@page "/ThuVien/TimKiemSachView"
@model WebCafebookApi.Pages.TimKiemSachViewModel

@{
    ViewData["Title"] = Model.PageTitle;
}

@section Styles {
    <style>
        /* TRẠNG THÁI THU GỌN — CHỈ 1 DÒNG + DẤU “…” */
        #page-description-wrapper.description-truncated p {
            white-space: nowrap !important;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* TRẠNG THÁI MỞ RỘNG — HIỂN THỊ ĐẦY ĐỦ */
        #page-description-wrapper.description-expanded p {
            white-space: pre-wrap !important;
            overflow: visible;
        }

        /* Ảnh sách */
        .card-img-container img {
            height: 260px;
            width: 100%;
            object-fit: cover;
        }
    </style>
}

<div class="container mt-5">
    <div class="main-content-card">

        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="page-breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a asp-page="/TrangChuView">
                        <span class="material-symbols-outlined">home</span> Trang Chủ
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a asp-page="/ThuVienSachView">
                        <span class="material-symbols-outlined">import_contacts</span> Thư Viện Sách
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Tìm kiếm
                </li>
            </ol>
        </nav>

        <!-- Tiêu đề -->
        <h1 class="display-6 fw-bold">@Model.PageTitle</h1>

        <!-- Mô tả trang -->
        @if (!string.IsNullOrEmpty(Model.PageDescription))
        {
            <div id="page-description-wrapper" class="description-truncated">
                <p class="fs-6 text-muted" style="white-space: pre-wrap;">
                    @Model.PageDescription
                </p>
            </div>

            <a href="javascript:void(0);" id="toggle-page-description"
               class="btn btn-link ps-0" style="display:none;">
                Đọc thêm...
            </a>
        }

        <hr />

        <!-- Lỗi -->
        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="alert alert-danger">@Model.ErrorMessage</div>
        }

        <!-- Danh sách sách -->
        @if (Model.SachList != null && Model.SachList.Any())
        {
            <div class="row row-cols-1 row-cols-md-4 g-4">

                @foreach (var item in Model.SachList)
                {
                    var imgUrl = string.IsNullOrEmpty(item.AnhBiaUrl)
                        ? "/images/default-book-cover.png"
                        : item.AnhBiaUrl;

                    <div class="col">
                        <a asp-page="/ChiTietSachView"
                           asp-route-id="@item.IdSach"
                           class="text-decoration-none">

                            <div class="card h-100 product-card">

                                <div class="card-img-container">
                                    <img src="@imgUrl"
                                         class="card-img-top"
                                         alt="@item.TieuDe" />
                                </div>

                                <div class="card-body d-flex flex-column">
                                    <h6 class="card-title book-card-title">@item.TieuDe</h6>
                                    <p class="card-text text-danger fw-bold mt-auto mb-0">
                                        @item.GiaBia.ToString("N0") đ
                                    </p>
                                </div>

                            </div>

                        </a>
                    </div>
                }

            </div>
        }
        else
        {
            <div class="alert alert-info">
                Không tìm thấy cuốn sách nào khớp với tiêu chí của bạn.
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {

            const $wrapper = $('#page-description-wrapper');
            if ($wrapper.length === 0) return;

            const $content = $wrapper.find('p');
            const $btn = $('#toggle-page-description');

            // Kiểm tra xem nội dung có vượt quá 1 dòng hay không
            if ($content[0].scrollWidth > $wrapper.width()) {
                $btn.show();
            } else {
                $wrapper.removeClass('description-truncated');
            }

            // Toggle mở rộng - thu gọn
            $btn.on("click", function () {
                const expanded = $wrapper.hasClass('description-expanded');

                $wrapper.toggleClass('description-expanded description-truncated');
                $btn.text(expanded ? 'Đọc thêm...' : 'Thu gọn');
            });
        });
    </script>
}

================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\TimKiemSachView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/TimKiemSachView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Collections.Generic;
using System.Net.Http;
using System.Net.Http.Json;
using System.Text;
using System.Threading.Tasks;

namespace WebCafebookApi.Pages
{
    public class TimKiemSachViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        [BindProperty(SupportsGet = true)]
        public int? IdTacGia { get; set; }

        [BindProperty(SupportsGet = true)]
        public int? IdTheLoai { get; set; }

        [BindProperty(SupportsGet = true)]
        public int? IdNXB { get; set; }

        public string PageTitle { get; set; } = "Thư Viện Sách";
        public string? PageDescription { get; set; }
        public List<SachCardDto> SachList { get; set; } = new List<SachCardDto>();
        public string? ErrorMessage { get; set; }

        public TimKiemSachViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        public async Task<IActionResult> OnGetAsync()
        {
            var httpClient = _httpClientFactory.CreateClient();
            var sb = new StringBuilder("http://localhost:5166/api/web/thuvien/filter-by-id?");

            if (IdTacGia.HasValue) sb.Append($"idTacGia={IdTacGia.Value}");
            else if (IdTheLoai.HasValue) sb.Append($"idTheLoai={IdTheLoai.Value}");
            else if (IdNXB.HasValue) sb.Append($"idNXB={IdNXB.Value}");
            else
            {
                return RedirectToPage("/ThuVienSachView");
            }

            try
            {
                var result = await httpClient.GetFromJsonAsync<SachKetQuaTimKiemDto>(sb.ToString());
                if (result != null)
                {
                    PageTitle = result.TieuDeTrang;
                    PageDescription = result.MoTaTrang; // Dòng này sẽ hết lỗi sau khi bạn sửa file DTO
                    SachList = result.SachList;
                }
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Lỗi khi tải dữ liệu: {ex.Message}";
            }
            return Page();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\TrangChuView.cshtml
================================================================================
﻿@page "/"
@model WebCafebookApi.Pages.TrangChuViewModel
@{
    ViewData["Title"] = "Trang Chủ";
    var bannerStyle = string.IsNullOrEmpty(Model.Info?.BannerImageUrl)
        ? "background-color: #4E342E; color: #FFF8E1;"
        : $"background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('{Model.Info.BannerImageUrl}'); background-size: cover; background-position: center; color: white;";
}

<div class="container-fluid px-0 mb-5">
    <div class="text-center p-5" style="@bannerStyle min-height: 40vh; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <h1 class="display-3 fw-bold" style="color: inherit;">
            @(Model.Info?.TenQuan ?? "Chào mừng đến Cafebook")
        </h1>
        <p class="lead fs-4 col-md-8" style="color: inherit; opacity: 0.9;">
            @(Model.Info?.GioiThieu ?? "Nơi bạn có thể thưởng thức cà phê thơm ngon, đọc những cuốn sách hay và tìm thấy không gian yên tĩnh cho riêng mình.")
        </p>
        <div class="mt-4">
            <a asp-page="/ThucDonView" class="btn btn-primary btn-lg me-2">Xem Thực Đơn</a>
            <a asp-page="/ThuVienSachView" class="btn btn-outline-light btn-lg">Khám Phá Sách</a>
        </div>
    </div>
</div>


<div class="container">

    @if (Model.Promotions != null && Model.Promotions.Any())
    {
        <div class="row mt-5 promotion-section">
            <h2 class="text-center mb-4 pb-2 section-header-alt">
                <span class="material-symbols-outlined">stars</span> Khuyến Mãi Đặc Biệt <span class="material-symbols-outlined">stars</span>
            </h2>
            @foreach (var promo in Model.Promotions)
            {
                <div class="col-md-12 promotion-item">
                    <h5 class="promo-title">@promo.TenKhuyenMai</h5>
                    <p class="promo-description">@promo.MoTa</p>
                    <p class="promo-condition">Áp dụng: @promo.dieuKienApDung</p>
                </div>
            }
        </div>
    }

    <div class="row mt-5">
        <h2 class="text-center mb-4 pb-2 section-header">
            <span class="material-symbols-outlined">coffee</span> Món Nổi Bật
        </h2>
        @if (Model.MonNoiBat != null && Model.MonNoiBat.Any())
        {
            @foreach (var item in Model.MonNoiBat)
            {
                <div class="col-lg col-md-4 col-sm-6 mb-4">
                    <a asp-page="/ChiTietSanPhamView" asp-route-id="@item.IdSanPham" class="text-decoration-none">
                        <div class="card h-100">
                            @{
                                var imgSrc = string.IsNullOrEmpty(item.AnhSanPhamUrl)
                                ? "/images/default-food-icon.png"
                                : item.AnhSanPhamUrl;
                            }
                            <div class="card-img-container">
                                <img src="@imgSrc" class="card-img-top" alt="@item.TenSanPham" style="height: 180px; object-fit: cover;">
                            </div>
                            <div class="card-body d-flex flex-column">
                                <h6 class="card-title text-decoration-none">@item.TenSanPham</h6>
                                <p class="card-text text-danger fw-bold mt-auto mb-0">@item.DonGia.ToString("N0") đ</p>
                            </div>
                        </div>
                    </a>
                </div>
            }
        }
        else
        {
            <p class="text-center text-muted">
                <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.1rem;">spark</span>
                Dữ liệu món nổi bật đang được cập nhật...
            </p>
        }
    </div>

    <div class="row mt-5">
        <h2 class="text-center mb-4 pb-2 section-header">
            <span class="material-symbols-outlined">auto_stories</span> Sách Hay Nên Đọc
        </h2>
        @if (Model.SachNoiBat != null && Model.SachNoiBat.Any())
        {
            @foreach (var sach in Model.SachNoiBat)
            {
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card h-100">
                        @{
                            var imgSrc = string.IsNullOrEmpty(sach.AnhBiaUrl)
                            ? "/images/default-book-cover.png"
                            : sach.AnhBiaUrl;
                        }
                        <div class="card-img-container">
                            <img src="@imgSrc" class="card-img-top" alt="@sach.TieuDe" style="height: 250px; object-fit: cover;">
                        </div>
                        <div class="card-body">
                            <h6 class="card-title" style="height: 2.5em; overflow: hidden;">@sach.TieuDe</h6>
                            <p class="card-text text-muted small">@sach.TacGia</p>
                        </div>
                        <div class="card-footer bg-transparent border-0 pb-3">
                            <a asp-page="/ChiTietSachView" asp-route-id="@sach.IdSach" class="btn btn-outline-primary btn-sm w-100">
                                Xem chi tiết
                            </a>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <p class="text-center text-muted">
                <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.1rem;">spark</span>
                Dữ liệu sách nổi bật đang được cập nhật...
            </p>
        }
    </div>

    <div class="row mt-5">
        <div class="col-12">
            <div class="find-space-section card-body">
                <div class="row">
                    <div class="col-md-7">
                        <h2 class="fw-bold">Tìm không gian cho riêng bạn?</h2>
                        <p class="lead text-muted">
                            Hiện chúng tôi đang có <strong>@Model.Info?.SoBanTrong bàn trống</strong> sẵn sàng phục vụ.
                            Và <strong>@Model.Info?.SoSachSanSang đầu sách</strong> đang sẵn sàng để bạn đọc và mượn.
                        </p>
                        <a asp-page="/DatBanView" class="btn btn-success btn-lg">
                            <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 8px;">book_online</span>
                            Đặt Bàn Ngay
                        </a>
                        <p class="text-muted small mt-3">
                            <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.1rem;">spark</span>
                            Chức năng xem sơ đồ bàn trực quan đang được cập nhật.
                        </p>
                    </div>
                    <div class="col-md-5 border-start-md contact-info">
                        <h5 class="fw-bold">Liên hệ nhanh</h5>
                        <ul class="list-unstyled">
                            <li><span class="material-symbols-outlined">call</span> @Model.Info?.SoDienThoai</li>
                            <li><span class="material-symbols-outlined">mail</span> @Model.Info?.EmailLienHe</li>
                            <li><span class="material-symbols-outlined">schedule</span> @Model.Info?.GioMoCua</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-5">
        <h2 class="text-center mb-4 pb-2 section-header-alt">
            Khách Hàng Nói Gì Về Chúng Tôi
        </h2>
        <div class="col-12 text-center">
            <p class="text-muted">
                <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.1rem;">spark</span>
                Chức năng hiển thị đánh giá của khách hàng đang được phát triển.
            </p>
        </div>
    </div>

</div>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\TrangChuView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/TrangChuView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Json;

namespace WebCafebookApi.Pages
{
    public class TrangChuViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;
        public TrangChuViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        public ThongTinChungDto? Info { get; set; }
        public List<KhuyenMaiDto> Promotions { get; set; } = new();
        public List<SanPhamDto> MonNoiBat { get; set; } = new();
        public List<SachDto> SachNoiBat { get; set; } = new();

        public async Task OnGetAsync()
        {
            var httpClient = _httpClientFactory.CreateClient();
            try
            {
                var response = await httpClient.GetFromJsonAsync<TrangChuDto>("http://localhost:5166/api/web/trangchu/data");

                if (response != null)
                {
                    Info = response.Info;
                    Promotions = response.Promotions;
                    MonNoiBat = response.MonNoiBat;
                    SachNoiBat = response.SachNoiBat;
                }
            }
            catch (Exception)
            {
                Info = new ThongTinChungDto();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\_ViewImports.cshtml
================================================================================
﻿@using WebCafebookApi
@namespace WebCafebookApi.Pages
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@using Microsoft.AspNetCore.Mvc.TagHelpers
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\_ViewStart.cshtml
================================================================================
﻿@{
    Layout = "_Layout";
}

================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\DangKyView.cshtml
================================================================================
﻿@page "/Account/Register"
@model WebCafebookApi.Pages.Account.DangKyViewModel
@{
    ViewData["Title"] = "Đăng ký";
    Layout = null;
    // Dùng layout riêng của trang Login
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Cafebook</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body class="login-page-body">

    <div class="login-wrapper">
        <div class="login-container">

            <div class="login-brand-col d-none d-md-flex">
                <img src="/images/logo.png" alt="Cafebook Logo">

                <h1 class="mb-2">Cafebook</h1>
                <p class="fs-5 opacity-75">Tham gia cộng đồng</p>
            </div>

            <div class="login-form-col">

                <h2>@ViewData["Title"]</h2>
                <p class="text-muted">
                    Tạo tài khoản mới để
                    đặt bàn và thuê sách.
                </p>

                <form id="registerForm" asp-route-returnUrl="@Model.ReturnUrl" method="post">

                    <div asp-validation-summary="ModelOnly" class="text-danger mb-2" role="alert"></div>

                    <div class="form-floating-material">
                        <input asp-for="Input.SoDienThoai" class="form-control" autocomplete="tel" aria-required="true" placeholder=" " />
                        <label asp-for="Input.SoDienThoai"></label>
                        <span class="material-symbols-outlined">phone</span>

                        <span asp-validation-for="Input.SoDienThoai" class="text-danger small"></span>
                    </div>

                    <div class="form-floating-material">
                        <input asp-for="Input.Email" class="form-control" autocomplete="email" aria-required="true" placeholder=" " />

                        <label asp-for="Input.Email"></label>
                        <span class="material-symbols-outlined">mail</span>
                        <span asp-validation-for="Input.Email" class="text-danger small"></span>
                    </div>

                    <div class="form-floating-material">
                        <input asp-for="Input.Password" class="form-control" type="password" autocomplete="new-password" aria-required="true" placeholder=" " />

                        <label asp-for="Input.Password"></label>
                        <span class="material-symbols-outlined">lock</span>
                        <span asp-validation-for="Input.Password" class="text-danger small"></span>
                    </div>


                    <div class="form-floating-material">
                        <input asp-for="Input.ConfirmPassword" class="form-control" type="password" autocomplete="new-password" aria-required="true" placeholder=" " />
                        <label asp-for="Input.ConfirmPassword"></label>
                        <span class="material-symbols-outlined">password</span>

                        <span asp-validation-for="Input.ConfirmPassword" class="text-danger small"></span>
                    </div>

                    <div>
                        <button id="registerSubmit" type="submit" class="w-100 btn btn-lg btn-primary">Đăng ký</button>

                    </div>

                    <div class="mt-4 text-center">
                        <p class="text-muted mb-0">
                            Đã có tài khoản?
                            <a asp-page="/account/DangNhapView">Quay lại Đăng nhập</a>
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <partial name="_ValidationScriptsPartial" />
    <script src="~/lib/jquery/dist/jquery.min.js"></script>

    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\DangKyView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/Account/DangKyView.cshtml.cs
using System.ComponentModel.DataAnnotations;
using System.Security.Claims;
using CafebookModel.Model.ModelApi;
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Json;

namespace WebCafebookApi.Pages.Account
{
    public class DangKyViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;
        public DangKyViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        [BindProperty]
        public InputModel Input { get; set; } = new();

        public string? ReturnUrl { get; set; }

        public class InputModel
        {
            // ĐÃ XÓA: HoTen

            [Required(ErrorMessage = "Vui lòng nhập SĐT")]
            [Phone(ErrorMessage = "Số điện thoại không hợp lệ")]
            [Display(Name = "Số điện thoại")]
            public string SoDienThoai { get; set; } = string.Empty;

            [Required(ErrorMessage = "Vui lòng nhập Email")]
            [EmailAddress(ErrorMessage = "Email không hợp lệ")]
            [Display(Name = "Email")]
            public string Email { get; set; } = string.Empty;

            // ĐÃ XÓA: TenDangNhap

            [Required(ErrorMessage = "Vui lòng nhập mật khẩu")]
            [StringLength(100, ErrorMessage = "{0} phải dài từ {2} đến {1} ký tự.", MinimumLength = 6)]
            [DataType(DataType.Password)]
            [Display(Name = "Mật khẩu")]
            public string Password { get; set; } = string.Empty;

            [DataType(DataType.Password)]
            [Display(Name = "Xác nhận mật khẩu")]
            [Compare("Password", ErrorMessage = "Mật khẩu và mật khẩu xác nhận không khớp.")]
            public string ConfirmPassword { get; set; } = string.Empty;
        }

        public void OnGet(string? returnUrl = null)
        {
            ReturnUrl = returnUrl;
        }

        public async Task<IActionResult> OnPostAsync(string? returnUrl = null)
        {
            returnUrl ??= Url.Content("~/");
            if (!ModelState.IsValid)
            {
                return Page();
            }

            var httpClient = _httpClientFactory.CreateClient();
            var apiRequest = new DangKyRequestModel
            {
                // ĐÃ XÓA: HoTen
                Email = Input.Email,
                SoDienThoai = Input.SoDienThoai,
                // ĐÃ XÓA: TenDangNhap
                Password = Input.Password
            };
            var response = await httpClient.PostAsJsonAsync("http://localhost:5166/api/web/taikhoankhach/register", apiRequest);

            if (response.IsSuccessStatusCode)
            {
                var apiResponse = await response.Content.ReadFromJsonAsync<WebLoginResponseModel>();
                if (apiResponse != null && apiResponse.Success && apiResponse.KhachHangData != null)
                {
                    // TỰ ĐỘNG ĐĂNG NHẬP SAU KHI ĐĂNG KÝ
                    var user = apiResponse.KhachHangData;
                    var claims = new List<Claim>
                    {
                        new Claim(ClaimTypes.NameIdentifier, user.IdKhachHang.ToString()),
                        new Claim(ClaimTypes.Name, user.TenDangNhap ?? user.Email ?? ""),
                        new Claim(ClaimTypes.GivenName, user.HoTen),
                        new Claim(ClaimTypes.Email, user.Email ?? ""),
                        new Claim(ClaimTypes.MobilePhone, user.SoDienThoai ?? ""),
                        new Claim(ClaimTypes.Role, "KhachHang")
                    };

                    var claimsIdentity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);

                    await HttpContext.SignInAsync(
                        CookieAuthenticationDefaults.AuthenticationScheme,
                        new ClaimsPrincipal(claimsIdentity));

                    HttpContext.Session.SetString("AvatarUrl", user.AnhDaiDienUrl ?? "");

                    return LocalRedirect(returnUrl);
                }
                else
                {
                    ModelState.AddModelError(string.Empty, apiResponse?.Message ?? "Lỗi đăng ký.");
                    return Page();
                }
            }

            ModelState.AddModelError(string.Empty, "Không thể kết nối máy chủ đăng ký.");
            return Page();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\DangNhapView.cshtml
================================================================================
﻿@page "/Account/Login"
@model WebCafebookApi.Pages.Account.DangNhapViewModel
@{
    ViewData["Title"] = "Đăng nhập";
    Layout = null;
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Cafebook</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body class="login-page-body">

    <div class="login-wrapper">
        <div class="login-container">

            <div class="login-brand-col d-none d-md-flex">
                <img src="/images/logo.png" alt="Cafebook Logo">
                <h1 class="mb-2">Cafebook</h1>
                <p class="fs-5 opacity-75">Awaken your senses</p>
            </div>

            <div class="login-form-col">
                <a asp-page="/TrangChuView" class="text-decoration-none mb-3" style="align-self: flex-start;">
                    <span class="material-symbols-outlined" style="vertical-align: middle;">arrow_back</span>
                    Về Trang Chủ
                </a>

                <h2>@ViewData["Title"]</h2>
                <p class="text-muted">Chào mừng trở lại! Vui lòng nhập thông tin của bạn.</p>

                <form id="account" method="post">

                    <div asp-validation-summary="ModelOnly" class="text-danger mb-2" role="alert"></div>

                    <div class="form-floating-material">
                        <input asp-for="Input.LoginIdentifier" class="form-control" autocomplete="username" aria-required="true" placeholder=" " />
                        <label asp-for="Input.LoginIdentifier" class="form-label">Email, Username hoặc SĐT</label>
                        <span class="material-symbols-outlined">person</span>
                        <span asp-validation-for="Input.LoginIdentifier" class="text-danger small"></span>
                    </div>

                    <div class="form-floating-material">
                        <input asp-for="Input.Password" type="password" class="form-control" autocomplete="current-password" aria-required="true" placeholder=" " />
                        <label asp-for="Input.Password" class="form-label">Mật khẩu</label>
                        <span class="material-symbols-outlined">lock</span>
                        <span asp-validation-for="Input.Password" class="text-danger small"></span>
                    </div>

                    <div class="text-end mb-3">
                        <a asp-page="/account/QuenMatKhauView" class="small">Quên mật khẩu?</a>
                    </div>

                    <div>
                        <button id="login-submit" type="submit" class="w-100 btn btn-lg btn-primary">Đăng nhập</button>
                    </div>

                    <div class="mt-4 text-center">
                        <p class="text-muted mb-0">
                            Chưa có tài khoản?
                            <a asp-page="/account/DangKyView" asp-route-returnUrl="@Model.ReturnUrl">Đăng ký ngay</a>
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <partial name="_ValidationScriptsPartial" />
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\DangNhapView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/Account/DangNhapView.cshtml.cs
using System.ComponentModel.DataAnnotations;
using System.Security.Claims;
using CafebookModel.Model.ModelApi;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Json;

namespace WebCafebookApi.Pages.Account
{
    public class DangNhapViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;
        public DangNhapViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        [BindProperty]
        public InputModel Input { get; set; } = new();

        public string? ReturnUrl { get; set; }

        [TempData]
        public string? ErrorMessage { get; set; }

        public class InputModel
        {
            [Required(ErrorMessage = "Vui lòng nhập Tên đăng nhập, Email hoặc SĐT")]
            [Display(Name = "Tên đăng nhập, Email hoặc SĐT")]
            public string LoginIdentifier { get; set; } = string.Empty;

            [Required(ErrorMessage = "Vui lòng nhập Mật khẩu")]
            [DataType(DataType.Password)]
            [Display(Name = "Mật khẩu")]
            public string Password { get; set; } = string.Empty;

            // ĐÃ XÓA: Thuộc tính RememberMe
        }

        public async Task OnGetAsync(string? returnUrl = null)
        {
            if (!string.IsNullOrEmpty(ErrorMessage))
            {
                ModelState.AddModelError(string.Empty, ErrorMessage);
            }
            returnUrl ??= Url.Content("~/");
            await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
            ReturnUrl = returnUrl;
        }

        public async Task<IActionResult> OnPostAsync(string? returnUrl = null)
        {
            returnUrl ??= Url.Content("~/");
            if (!ModelState.IsValid)
            {
                return Page();
            }

            var httpClient = _httpClientFactory.CreateClient();
            var apiRequest = new LoginRequestModel
            {
                TenDangNhap = Input.LoginIdentifier,
                MatKhau = Input.Password
            };
            var response = await httpClient.PostAsJsonAsync("http://localhost:5166/api/web/taikhoankhach/login", apiRequest);

            if (response.IsSuccessStatusCode)
            {
                var apiResponse = await response.Content.ReadFromJsonAsync<WebLoginResponseModel>();
                if (apiResponse != null && apiResponse.Success && apiResponse.KhachHangData != null && apiResponse.Token != null)
                {
                    var user = apiResponse.KhachHangData;
                    var claims = new List<Claim>
                    {
                        new Claim(ClaimTypes.NameIdentifier, user.IdKhachHang.ToString()),
                        new Claim(ClaimTypes.Name, user.TenDangNhap ?? user.Email ?? ""),
                        new Claim(ClaimTypes.GivenName, user.HoTen),
                        new Claim(ClaimTypes.Email, user.Email ?? ""),
                        new Claim(ClaimTypes.MobilePhone, user.SoDienThoai ?? ""),
                        new Claim(ClaimTypes.Role, "KhachHang") // Gán Role
                    };

                    var claimsIdentity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);

                    // SỬA: Không còn IsPersistent = Input.RememberMe
                    var authProperties = new AuthenticationProperties();

                    // 1. Đăng nhập Cookie cho Frontend
                    await HttpContext.SignInAsync(
                        CookieAuthenticationDefaults.AuthenticationScheme,
                        new ClaimsPrincipal(claimsIdentity),
                        authProperties);

                    // 2. Lưu JWT Token vào Session để ApiClient sử dụng
                    HttpContext.Session.SetString("JwtToken", apiResponse.Token);

                    HttpContext.Session.SetString("AvatarUrl", user.AnhDaiDienUrl ?? "");
                    return LocalRedirect(returnUrl);
                }
                else
                {
                    ModelState.AddModelError(string.Empty, apiResponse?.Message ?? "Lỗi không xác định từ API.");
                    return Page();
                }
            }

            ModelState.AddModelError(string.Empty, "Không thể kết nối đến máy chủ đăng nhập.");
            return Page();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\DangXuat.cshtml
================================================================================
﻿@page
@model WebCafebookApi.Pages.Account.DangXuatModel
@{
    // Trang này không cần hiển thị gì đặc biệt,
    // chỉ cần để PageModel xử lý logic đăng xuất trong OnPost.
    ViewData["Title"] = "Đăng xuất";
}

<header>
    <h1>@ViewData["Title"]</h1>
    <p>Bạn đã đăng xuất thành công.</p>
    @* Có thể thêm nút quay lại trang chủ *@
    <a asp-page="/TrangChuView">Quay lại Trang Chủ</a>
</header>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\DangXuat.cshtml.cs
================================================================================
﻿using System.Threading.Tasks;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;

namespace WebCafebookApi.Pages.Account
{
    public class DangXuatModel : PageModel
    {
        // Sửa lỗi CS8625: string -> string?
        public async Task<IActionResult> OnPostAsync(string? returnUrl = null)
        {
            await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
            HttpContext.Session.Clear();

            if (returnUrl != null)
            {
                return LocalRedirect(returnUrl);
            }
            else
            {
                return RedirectToPage("/TrangChuView");
            }
        }

        public async Task<IActionResult> OnGetAsync(string? returnUrl = null) // Sửa lỗi CS8625
        {
            return await OnPostAsync(returnUrl);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\DatLaiMatKhauView.cshtml
================================================================================
﻿@page "/Account/ResetPassword"
@* SỬA: Namespace *@
@model WebCafebookApi.Pages.Account.DatLaiMatKhauViewModel
@{
    ViewData["Title"] = "Đặt Lại Mật Khẩu";
    Layout = null; // Dùng layout login
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Cafebook</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body class="login-page-body">

    <div class="login-wrapper">
        <div class="login-container">
            <div class="login-brand-col d-none d-md-flex">
                <img src="/images/logo.png" alt="Cafebook Logo">
                <h1 class="mb-2">Cafebook</h1>
                <p class="fs-5 opacity-75">Khôi phục tài khoản</p>
            </div>

            <div class="login-form-col">
                <h2>@ViewData["Title"]</h2>
                <p class="text-muted">Nhập mật khẩu mới cho tài khoản của bạn.</p>

                @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                {
                    <div class="alert alert-danger">@Model.ErrorMessage</div>
                }

                @if (string.IsNullOrEmpty(Model.ErrorMessage))
                {
                    <form method="post">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-2" role="alert"></div>
                        <input type="hidden" asp-for="Input.Email" />
                        <input type="hidden" asp-for="Input.Token" />

                        <div class="form-floating-material">
                            <input asp-for="Input.NewPassword" type="password" class="form-control" autocomplete="new-password" aria-required="true" placeholder=" " />
                            <label asp-for="Input.NewPassword" class="form-label"></label>
                            <span class="material-symbols-outlined">lock</span>
                            <span asp-validation-for="Input.NewPassword" class="text-danger small"></span>
                        </div>

                        <div class="form-floating-material">
                            <input asp-for="Input.ConfirmPassword" type="password" class="form-control" autocomplete="new-password" aria-required="true" placeholder=" " />
                            <label asp-for="Input.ConfirmPassword" class="form-label"></label>
                            <span class="material-symbols-outlined">lock_reset</span>
                            <span asp-validation-for="Input.ConfirmPassword" class="text-danger small"></span>
                        </div>

                        <button type="submit" class="w-100 btn btn-lg btn-primary mt-3">Đặt Lại Mật Khẩu</button>
                    </form>
                }
                else
                {
                    <a asp-page="/Account/QuenMatKhauView" class="btn btn-primary">Yêu cầu mã mới</a>
                }
            </div>
        </div>
    </div>

    <partial name="_ValidationScriptsPartial" />
</body>
</html>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\DatLaiMatKhauView.cshtml.cs
================================================================================
﻿using CafebookModel.Model.ModelWeb; // <-- THÊM
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.Extensions.Caching.Memory;
using System.ComponentModel.DataAnnotations;
using System.Threading.Tasks;
using System.Net.Http; // <-- THÊM
using System.Net.Http.Json; // <-- THÊM
using System; // <-- THÊM

namespace WebCafebookApi.Pages.Account // SỬA: Namespace
{
    public class DatLaiMatKhauViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory; // <-- SỬA
        private readonly IMemoryCache _cache;

        public DatLaiMatKhauViewModel(IHttpClientFactory httpClientFactory, IMemoryCache cache)
        {
            _httpClientFactory = httpClientFactory; // <-- SỬA
            _cache = cache;
        }

        [BindProperty]
        public InputModel Input { get; set; } = new InputModel();

        [TempData]
        public string? ErrorMessage { get; set; }

        public class InputModel
        {
            [Required]
            [HiddenInput]
            public string Email { get; set; } = string.Empty;

            [Required]
            [HiddenInput]
            public string Token { get; set; } = string.Empty;

            [Required(ErrorMessage = "Vui lòng nhập mật khẩu mới")]
            [StringLength(100, ErrorMessage = "Mật khẩu mới phải dài ít nhất 6 ký tự.", MinimumLength = 6)]
            [DataType(DataType.Password)]
            [Display(Name = "Mật khẩu mới")]
            public string NewPassword { get; set; } = string.Empty;

            [DataType(DataType.Password)]
            [Display(Name = "Xác nhận mật khẩu mới")]
            [Compare("NewPassword", ErrorMessage = "Mật khẩu mới và mật khẩu xác nhận không khớp.")]
            public string ConfirmPassword { get; set; } = string.Empty;
        }

        public IActionResult OnGet(string email, string token)
        {
            string resetCacheKey = $"ResetToken_{email}";
            if (string.IsNullOrEmpty(email) || string.IsNullOrEmpty(token) ||
                !_cache.TryGetValue(resetCacheKey, out string? cachedToken) || cachedToken != token)
            {
                ErrorMessage = "Đường dẫn đặt lại mật khẩu không hợp lệ hoặc đã hết hạn. Vui lòng thử lại.";
            }
            else
            {
                Input.Email = email;
                Input.Token = token;
            }
            return Page();
        }

        public async Task<IActionResult> OnPostAsync()
        {
            if (!ModelState.IsValid)
            {
                return Page();
            }

            string email = Input.Email;
            string token = Input.Token;
            string resetCacheKey = $"ResetToken_{email}";

            if (string.IsNullOrEmpty(email) || string.IsNullOrEmpty(token) ||
                !_cache.TryGetValue(resetCacheKey, out string? cachedToken) || cachedToken != token)
            {
                ErrorMessage = "Phiên làm việc đã hết hạn. Vui lòng yêu cầu lại mã.";
                return Page();
            }

            var httpClient = _httpClientFactory.CreateClient();
            var resetRequest = new ResetPasswordRequestDto
            {
                Email = email,
                NewPassword = Input.NewPassword
            };

            try
            {
                var response = await httpClient.PostAsJsonAsync("http://localhost:5166/api/web/password/reset", resetRequest);

                if (response.IsSuccessStatusCode)
                {
                    _cache.Remove(resetCacheKey);
                    TempData["LoginMessage"] = "Mật khẩu của bạn đã được đặt lại thành công. Vui lòng đăng nhập.";
                    return RedirectToPage("./DangNhapView");
                }
                else
                {
                    ErrorMessage = "Đã xảy ra lỗi khi đặt lại mật khẩu. Vui lòng thử lại.";
                    return Page();
                }
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Lỗi kết nối API: {ex.Message}";
                return Page();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\DoiMatKhauView.cshtml
================================================================================
﻿@page "/Account/DoiMatKhauView"
@model WebCafebookApi.Pages.Account.DoiMatKhauViewModel
@{
    ViewData["Title"] = "Đổi mật khẩu";
    Layout = "_Layout_Account"; // Sử dụng layout tài khoản
}

<h3 class="page-title-account">@ViewData["Title"]</h3>
<p class="page-lead-account">Để bảo mật, hãy chọn một mật khẩu mạnh và không sử dụng lại ở nơi khác.</p>

<hr class="my-4" />

<div class="row">
    <div class="col-md-8">
        @if (!string.IsNullOrEmpty(Model.PasswordSuccessMessage))
        {
            <div class="alert alert-success">@Model.PasswordSuccessMessage</div>
        }
        @if (!string.IsNullOrEmpty(Model.PasswordErrorMessage))
        {
            <div class="alert alert-danger">@Model.PasswordErrorMessage</div>
        }

        <form method="post">
            <div asp-validation-summary="ModelOnly" class="text-danger mb-3" role="alert"></div>

            <div class="material-input-group mb-3">
                <label asp-for="PasswordInput.MatKhauCu" class="form-label fw-bold"></label>
                <input asp-for="PasswordInput.MatKhauCu" class="material-input" type="password" />
                <span asp-validation-for="PasswordInput.MatKhauCu" class="text-danger small"></span>
            </div>

            <div class="material-input-group mb-3">
                <label asp-for="PasswordInput.MatKhauMoi" class="form-label fw-bold"></label>
                <input asp-for="PasswordInput.MatKhauMoi" class="material-input" type="password" />
                <span asp-validation-for="PasswordInput.MatKhauMoi" class="text-danger small"></span>
            </div>

            <div class="material-input-group mb-3">
                <label asp-for="PasswordInput.XacNhanMatKhauMoi" class="form-label fw-bold"></label>
                <input asp-for="PasswordInput.XacNhanMatKhauMoi" class="material-input" type="password" />
                <span asp-validation-for="PasswordInput.XacNhanMatKhauMoi" class="text-danger small"></span>
            </div>

            <button type="submit" class="btn btn-primary mt-3">
                <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 4px;">lock_reset</span>
                Đổi Mật Khẩu
            </button>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\DoiMatKhauView.cshtml.cs
================================================================================
﻿using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Json;
using System.Security.Claims;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Authentication;
using System; // <-- THÊM

namespace WebCafebookApi.Pages.Account
{
    [Authorize(Roles = "KhachHang")]
    public class DoiMatKhauViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        [BindProperty]
        public PasswordChangeModel PasswordInput { get; set; } = new();

        [TempData]
        public string? PasswordSuccessMessage { get; set; }
        [TempData]
        public string? PasswordErrorMessage { get; set; }

        public DoiMatKhauViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        public void OnGet()
        {
            // SỬA LỖI CS0103: Xóa dòng "Layout = ..." ở đây.
        }

        private int GetCurrentUserId()
        {
            var userIdClaim = User.FindFirstValue(ClaimTypes.NameIdentifier);
            int.TryParse(userIdClaim, out int userId);
            return userId;
        }

        public async Task<IActionResult> OnPostAsync()
        {
            // SỬA LỖI CS0103: Xóa dòng "Layout = ..." ở đây.
            var userId = GetCurrentUserId();
            if (userId == 0) return Challenge();

            if (!ModelState.IsValid)
            {
                return Page();
            }

            var httpClient = _httpClientFactory.CreateClient();
            try
            {
                var response = await httpClient.PostAsJsonAsync($"http://localhost:5166/api/web/profile/change-password/{userId}", PasswordInput);

                if (response.IsSuccessStatusCode)
                {
                    await HttpContext.SignOutAsync(Microsoft.AspNetCore.Authentication.Cookies.CookieAuthenticationDefaults.AuthenticationScheme);
                    TempData["LoginMessage"] = "Đổi mật khẩu thành công! Vui lòng đăng nhập lại.";
                    return RedirectToPage("/Account/DangNhapView");
                }
                else
                {
                    var error = await response.Content.ReadFromJsonAsync<ApiErrorResponse>();
                    PasswordErrorMessage = error?.Message ?? "Lỗi không xác định.";
                }
            }
            catch (Exception ex)
            {
                PasswordErrorMessage = $"Lỗi: {ex.Message}";
            }

            return Page();
        }

        private class ApiErrorResponse { public string? Message { get; set; } }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\LichSuDatBanView.cshtml
================================================================================
﻿@page "/Account/LichSuDatBanView"
@model WebCafebookApi.Pages.Account.LichSuDatBanViewModel
@{
    ViewData["Title"] = "Lịch sử đặt bàn";
    Layout = "_Layout_Account"; // Sử dụng layout tài khoản
}

<h3 class="page-title-account">@ViewData["Title"]</h3>
<p class="page-lead-account">Theo dõi các phiếu đặt bàn sắp tới và đã hoàn thành của bạn.</p>

<hr class="my-4" />

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

@if (Model.Bookings == null || !Model.Bookings.Any())
{
    <div class="alert alert-info">
        Bạn chưa có lịch sử đặt bàn nào.
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th scope="col">Bàn</th>
                    <th scope="col">Thời gian</th>
                    <th scope="col">Số khách</th>
                    <th scope="col">Trạng thái</th>
                    <th scope="col">Ghi chú</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Bookings)
                {
                    <tr>
                        <td class="fw-bold">@item.TenBan</td>
                        <td>@item.ThoiGianDat.ToString("HH:mm, dd/MM/yyyy")</td>
                        <td>@item.SoLuongKhach</td>
                        <td>
                            <span class="badge @GetBadgeClass(item.TrangThai)">
                                @item.TrangThai
                            </span>
                        </td>
                        <td>@item.GhiChu</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@functions {
    private string GetBadgeClass(string trangThai)
    {
        return trangThai switch
        {
            "Đã xác nhận" => "bg-primary",
            "Đã hủy" => "bg-danger",
            "Khách đã đến" => "bg-success",
            "Đã hoàn thành" => "bg-secondary",
            _ => "bg-dark",
        };
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\LichSuDatBanView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/Account/LichSuDatBanView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Collections.Generic;
using System.Net.Http;
using System.Net.Http.Json;
using System.Security.Claims;
using System.Threading.Tasks;

namespace WebCafebookApi.Pages.Account
{
    [Authorize(Roles = "KhachHang")]
    public class LichSuDatBanViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        public List<LichSuDatBanDto> Bookings { get; set; } = new List<LichSuDatBanDto>();

        [TempData]
        public string? ErrorMessage { get; set; }

        public LichSuDatBanViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        private int GetCurrentUserId()
        {
            var userIdClaim = User.FindFirstValue(ClaimTypes.NameIdentifier);
            int.TryParse(userIdClaim, out int userId);
            return userId;
        }

        public async Task<IActionResult> OnGetAsync()
        {
            var userId = GetCurrentUserId();
            if (userId == 0) return Challenge();

            var httpClient = _httpClientFactory.CreateClient();
            try
            {
                var response = await httpClient.GetAsync($"http://localhost:5166/api/web/profile/booking-history/{userId}");
                if (response.IsSuccessStatusCode)
                {
                    Bookings = await response.Content.ReadFromJsonAsync<List<LichSuDatBanDto>>() ?? new List<LichSuDatBanDto>();
                }
                else
                {
                    ErrorMessage = "Không thể tải lịch sử đặt bàn.";
                }
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Lỗi kết nối: {ex.Message}";
            }

            return Page();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\LichSuDonHangDetailView.cshtml
================================================================================
﻿@page "/Account/LichSuDonHangDetailView/{id:int}"
@model WebCafebookApi.Pages.Account.LichSuDonHangDetailViewModel
@{
    ViewData["Title"] = "Chi Tiết Đơn Hàng";
    Layout = "_Layout_Account";
}

@section Styles {
    <style>
        /* CSS cho thanh tiến trình (Progress Tracker) */
        .progress-tracker {
            display: flex;
            justify-content: space-between;
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
        }

            .progress-step .icon {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background-color: #e0e0e0;
                color: white;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                font-size: 1.2rem;
                border: 4px solid #fff;
                z-index: 2;
                position: relative;
            }

            .progress-step .text {
                display: block;
                margin-top: 5px;
                font-size: 0.9rem;
                color: #757575;
            }

            .progress-step:not(:first-child)::before {
                content: '';
                position: absolute;
                width: 100%;
                height: 4px;
                background-color: #e0e0e0;
                top: 20px; /* (40px + 4px*2) / 2 - 4px/2 */
                right: 50%;
                z-index: 1;
            }
            /* Trạng thái Active/Completed */
            .progress-step.completed .icon,
            .progress-step.active .icon {
                background-color: var(--bs-success);
            }

            .progress-step.completed .text {
                color: var(--bs-success);
                font-weight: 500;
            }

            .progress-step.active .text {
                color: var(--cf-dark-brown);
                font-weight: 700;
            }

            .progress-step.completed:not(:first-child)::before {
                background-color: var(--bs-success);
            }

        /* CSS cho Timeline Vận Chuyển */
        .timeline {
            list-style: none;
            padding: 0;
            position: relative;
        }

            .timeline::before {
                content: '';
                position: absolute;
                top: 0;
                bottom: 0;
                left: 20px;
                width: 4px;
                background-color: #eee;
            }

        .timeline-item {
            position: relative;
            padding-left: 50px;
            margin-bottom: 25px;
        }

        .timeline-icon {
            position: absolute;
            left: 0;
            top: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e0e0e0;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            border: 4px solid #f9f9f9;
            z-index: 2;
        }

        .timeline-item.active .timeline-icon {
            background-color: var(--bs-success);
        }

        .timeline-content {
            padding-top: 5px;
        }

            .timeline-content .status {
                font-weight: 600;
                color: var(--cf-dark-brown);
            }

            .timeline-content .description {
                color: #6c757d;
                font-size: 0.9rem;
            }

            .timeline-content .timestamp {
                font-size: 0.85rem;
                color: #9e9e9e;
            }

        .timeline-item.active .timeline-content .status {
            color: var(--bs-success);
        }

        /* CSS cho thẻ đơn hàng (Copy từ LichSuDonHangView) */
        .order-card {
            background-color: var(--cf-white);
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .order-card-header {
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .order-item {
            padding: 1.25rem;
            display: flex;
            gap: 1rem;
            border-bottom: 1px dashed #eee;
        }

        .order-item-img img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        .order-item-info {
            flex: 1;
        }

            .order-item-info h6 {
                font-weight: 600;
                margin-bottom: 0.25rem;
            }

            .order-item-info .qty {
                font-size: 0.9rem;
                color: #666;
            }

        .order-item-price {
            font-weight: 500;
            color: var(--cf-text);
            font-size: 0.9rem;
        }

        .order-total-summary {
            list-style: none;
            padding: 0;
            font-size: 1.1rem;
        }

            .order-total-summary li {
                display: flex;
                justify-content: space-between;
                margin-bottom: 0.5rem;
            }

                .order-total-summary li span:first-child {
                    color: #6c757d;
                }

                .order-total-summary li.total {
                    font-size: 1.3rem;
                    font-weight: 700;
                    color: var(--bs-danger);
                    border-top: 1px dashed #eee;
                    padding-top: 1rem;
                    margin-top: 0.5rem;
                }
    </style>
}

<h3 class="page-title-account">@ViewData["Title"]</h3>
<p class="page-lead-account">Theo dõi chi tiết đơn hàng giao tận nơi của bạn.</p>

<hr class="my-4" />

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}
else if (Model.OrderDetails != null)
{
    var order = Model.OrderDetails;

    <div class="card order-card">
        <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">Mã đơn hàng: <strong>@order.MaDonHang</strong></h5>
                    <span class="text-muted">Ngày đặt: @order.ThoiGianTao.ToString("dd/MM/yyyy HH:mm")</span>
                </div>
                <div class="text-end">
                    <h5 class="mb-0 text-uppercase" style="color: var(--cf-orange);">@order.TrangThaiGiaoHang</h5>
                </div>
            </div>

            <hr />

            <ul class="progress-tracker">
                @{
                    bool cxn = order.TrangThaiGiaoHang == "Chờ xác nhận";
                    bool clh = order.TrangThaiGiaoHang == "Chờ lấy hàng";
                    bool dg = order.TrangThaiGiaoHang == "Đang giao";
                    bool ht = order.TrangThaiGiaoHang == "Hoàn thành";
                    bool dh = order.TrangThaiGiaoHang == "Đã Hủy";
                }
                <li class="progress-step @(cxn || clh || dg || ht ? "completed" : "") @(cxn ? "active" : "")">
                    <span class="icon"><span class="material-symbols-outlined">receipt_long</span></span>
                    <span class="text">Đã Đặt</span>
                </li>
                <li class="progress-step @(clh || dg || ht ? "completed" : "") @(clh ? "active" : "")">
                    <span class="icon"><span class="material-symbols-outlined">inventory_2</span></span>
                    <span class="text">Chờ Lấy Hàng</span>
                </li>
                <li class="progress-step @(dg || ht ? "completed" : "") @(dg ? "active" : "")">
                    <span class="icon"><span class="material-symbols-outlined">local_shipping</span></span>
                    <span class="text">Đang Giao</span>
                </li>
                <li class="progress-step @(ht ? "completed" : "") @(ht ? "active" : "")">
                    <span class="icon"><span class="material-symbols-outlined">task_alt</span></span>
                    <span class="text">Hoàn Thành</span>
                </li>
            </ul>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="card order-card h-100">
                <div class="card-body p-4">
                    <h5 class="mb-3">Địa Chỉ Nhận Hàng</h5>
                    <h6 class="fw-bold">@order.HoTen</h6>
                    <p class="mb-1 text-muted">@order.SoDienThoai</p>
                    <p class="mb-0 text-muted">@order.DiaChiGiaoHang</p>
                </div>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="card order-card h-100">
                <div class="card-body p-4">
                    <h5 class="mb-4">Lịch sử vận chuyển</h5>
                    <ul class="timeline">
                        @foreach (var tracking in order.TrackingEvents)
                        {
                            <li class="timeline-item @(tracking.IsCurrent ? "active" : "")">
                                <div class="timeline-icon">
                                    <span class="material-symbols-outlined">@(tracking.Status == "Đơn hàng đã đặt" ? "receipt_long" : (tracking.Status == "Giao hàng thành công" ? "task_alt" : "local_shipping"))</span>
                                </div>
                                <div class="timeline-content">
                                    <span class="status">@tracking.Status</span>
                                    <p class="description mb-0">@tracking.Description</p>
                                    <span class="timestamp">@tracking.Timestamp.ToString("HH:mm dd/MM/yyyy")</span>
                                </div>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card order-card">
                <div class="order-card-header">
                    <span class="shop-name">
                        <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.2rem;">storefront</span>
                        Cafebook
                    </span>
                </div>
                <div class="order-items-container">
                    @foreach (var item in order.Items)
                    {
                        var imgUrl = item.HinhAnhUrl ?? "/images/default-food-icon.png";
                        <div class="order-item">
                            <div class="order-item-img">
                                <img src="@imgUrl" alt="@item.TenSanPham" />
                            </div>
                            <div class="order-item-info">
                                <h6>@item.TenSanPham</h6>
                                <div class="qty">x @item.SoLuong</div>
                            </div>
                            <div class="order-item-price">
                                @item.DonGia.ToString("N0") đ
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card order-card">
                <div class="card-body p-4">
                    <h5 class="mb-3">Tổng cộng</h5>
                    <ul class="order-total-summary">
                        <li>
                            <span>Tổng tiền hàng</span>
                            <span>@order.TongTienHang.ToString("N0") đ</span>
                        </li>
                        <li>
                            <span>Giảm giá</span>
                            <span class="text-danger">-@order.GiamGia.ToString("N0") đ</span>
                        </li>
                        <li class="total">
                            <span>Thành tiền</span>
                            <span>@order.ThanhTien.ToString("N0") đ</span>
                        </li>
                    </ul>
                    <hr />
                    <p class="mb-0">
                        <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.2rem; color: #6c757d;">payments</span>
                        <span class="text-muted">Đã thanh toán bằng @order.PhuongThucThanhToan</span>
                    </p>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="alert alert-info">Đang tải chi tiết đơn hàng...</div>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\LichSuDonHangDetailView.cshtml.cs
================================================================================
﻿// TẠO TỆP MỚI: WebCafebookApi/Pages/Account/LichSuDonHangDetailView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;

namespace WebCafebookApi.Pages.Account
{
    [Authorize(Roles = "KhachHang")]
    public class LichSuDonHangDetailViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        public LichSuDonHangDetailViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        [BindProperty(SupportsGet = true)]
        public int Id { get; set; } // IdHoaDon

        public DonHangChiTietWebDto? OrderDetails { get; set; }
        public string? ErrorMessage { get; set; }

        public async Task<IActionResult> OnGetAsync()
        {
            if (Id == 0)
            {
                ErrorMessage = "Mã đơn hàng không hợp lệ.";
                return Page();
            }

            var httpClient = _httpClientFactory.CreateClient("ApiClient");
            try
            {
                // Gọi API mới trong KhachHangProfileController
                OrderDetails = await httpClient.GetFromJsonAsync<DonHangChiTietWebDto>($"/api/web/profile/order-detail/{Id}");
            }
            catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                ErrorMessage = "Không tìm thấy đơn hàng hoặc bạn không có quyền xem đơn hàng này.";
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Lỗi tải chi tiết đơn hàng: {ex.Message}";
            }

            return Page();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\LichSuDonHangView.cshtml
================================================================================
﻿@page "/Account/LichSuDonHangView"
@model WebCafebookApi.Pages.Account.LichSuDonHangViewModel
@{
    ViewData["Title"] = "Lịch sử mua hàng";
    Layout = "_Layout_Account";
}

@section Styles {
    <style>
        /* CSS cho các tab (giống Shopee) */
        .order-tabs .nav-link {
            color: var(--cf-text);
            background-color: var(--cf-white);
            border: none;
            border-bottom: 3px solid transparent;
            border-radius: 0;
            font-weight: 500;
            padding-top: 1rem;
            padding-bottom: 1rem;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

            .order-tabs .nav-link.active {
                color: var(--cf-orange);
                border-bottom-color: var(--cf-orange);
                background-color: var(--cf-white);
            }

            .order-tabs .nav-link:hover {
                color: var(--cf-orange);
            }

        .order-tabs {
            background-color: var(--cf-white);
            border-radius: 8px 8px 0 0;
            box-shadow: 0 1px 3px var(--cf-shadow);
        }

        /* CSS cho thẻ đơn hàng (Order Card) */
        .order-card {
            background-color: var(--cf-white);
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px var(--cf-shadow);
        }

        .order-card-header {
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

            .order-card-header .shop-name {
                font-weight: 600;
                color: var(--cf-dark-brown);
            }

            .order-card-header .status-delivery {
                font-weight: 500;
                color: var(--cf-orange);
                text-transform: uppercase;
                font-size: 0.9rem;
            }

            .order-card-header .status-cancelled {
                color: var(--bs-danger);
            }

            .order-card-header .status-completed {
                color: var(--bs-success);
            }

        /* SỬA: Thêm CSS cho vùng item có thể nhấp */
        a.order-items-link {
            display: block;
            text-decoration: none;
            color: inherit;
        }

            a.order-items-link:hover {
                background-color: #fcfcfc;
            }

        .order-item {
            padding: 1.25rem;
            display: flex;
            gap: 1rem;
            border-bottom: 1px dashed #eee;
        }

            .order-item:last-child {
                border-bottom: none;
            }

        .order-item-img img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        .order-item-info {
            flex: 1;
        }

            .order-item-info h6 {
                font-weight: 600;
                margin-bottom: 0.25rem;
            }

            .order-item-info .qty {
                font-size: 0.9rem;
                color: #666;
            }

        .order-item-price {
            font-weight: 500;
            color: var(--cf-text);
            font-size: 0.9rem;
        }

        .order-card-footer {
            padding: 1rem 1.25rem;
            background-color: #fcfcfc;
            border-top: 1px solid #f0f0f0;
            text-align: right;
        }

        .order-total-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--bs-danger);
        }

        .order-card-actions {
            padding: 1rem 1.25rem;
            border-top: 1px solid #f0f0f0;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            flex-wrap: wrap; /* Đảm bảo các nút xuống dòng nếu không đủ chỗ */
        }
    </style>
}

<h3 class="page-title-account">@ViewData["Title"]</h3>
<p class="page-lead-account">Theo dõi các đơn hàng giao tận nơi của bạn.</p>

<hr class="my-4" />

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

<ul class="nav nav-tabs order-tabs">
    @foreach (var tabName in Model.StatusTabs)
    {
        <li class="nav-item">
            <a class="nav-link @(Model.StatusFilter == tabName ? "active" : "")"
               asp-page="/Account/LichSuDonHangView"
               asp-route-StatusFilter="@tabName">@tabName</a>
        </li>
    }
</ul>

<div class="mt-4">
    @if (!Model.FilteredOrders.Any())
    {
        <div class="alert alert-info text-center" style="padding: 50px;">
            <span class="material-symbols-outlined" style="font-size: 48px;">receipt_long</span>
            <h4 class="mt-3">Không có đơn hàng</h4>
            <p>Không tìm thấy đơn hàng nào trong mục này.</p>
        </div>
    }
    else
    {
        @foreach (var order in Model.FilteredOrders)
        {
            var statusText = order.TrangThaiGiaoHang;
            var statusClass = "status-delivery";

            if (order.TrangThaiThanhToan == "Đã hủy")
            {
                statusText = "Đã Hủy";
                statusClass = "status-cancelled";
            }
            else if (order.TrangThaiGiaoHang == "Hoàn thành")
            {
                statusText = "Giao hàng thành công";
                statusClass = "status-completed";
            }

            <div class="order-card">
                <div class="order-card-header">
                    <span class="shop-name">
                        <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.2rem;">storefront</span>
                        Cafebook
                    </span>
                    <span class="status-delivery @statusClass">
                        @statusText
                    </span>
                </div>

                <a asp-page="/Account/LichSuDonHangDetailView" asp-route-id="@order.IdHoaDon" class="order-items-link">
                    <div class="order-items-container">
                        @foreach (var item in order.Items)
                        {
                            var imgUrl = item.HinhAnhUrl ?? "/images/default-food-icon.png";
                            <div class="order-item">
                                <div class="order-item-img">
                                    <img src="@imgUrl" alt="@item.TenSanPham" />
                                </div>
                                <div class="order-item-info">
                                    <h6>@item.TenSanPham</h6>
                                    <div class="qty">x @item.SoLuong</div>
                                </div>
                                <div class="order-item-price">
                                    @item.DonGia.ToString("N0") đ
                                </div>
                            </div>
                        }
                    </div>
                </a>

                <div class="order-card-footer">
                    <span class="me-2">Thành tiền:</span>
                    <span class="order-total-amount">@order.ThanhTien.ToString("N0") đ</span>
                </div>

                <div class="order-card-actions">
                    <button class="btn btn-outline-secondary btn-sm" disabled>Liên Hệ Shop (Sắp có)</button>

                    @if (order.TrangThaiGiaoHang == "Chờ xác nhận" && order.TrangThaiThanhToan != "Đã hủy")
                    {
                        <button class="btn btn-outline-danger btn-sm" disabled>Hủy Đơn (Sắp có)</button>
                    }

                    @if (order.TrangThaiGiaoHang == "Hoàn thành")
                    {
                        <button class="btn btn-outline-secondary btn-sm" disabled>Mua Lại (Sắp có)</button>
                        <button class="btn btn-primary btn-sm" disabled>Đánh Giá (Sắp có)</button>
                    }

                    <a asp-page="/Account/LichSuDonHangDetailView" asp-route-id="@order.IdHoaDon" class="btn btn-outline-primary btn-sm ms-auto">Xem Chi Tiết</a>
                </div>
            </div>
        }
    }
</div>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\LichSuDonHangView.cshtml.cs
================================================================================
﻿// TẠO TỆP MỚI: WebCafebookApi/Pages/Account/LichSuDonHangView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Json;
using System.Security.Claims;
using System.Threading.Tasks;

namespace WebCafebookApi.Pages.Account
{
    [Authorize(Roles = "KhachHang")]
    public class LichSuDonHangViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        public List<LichSuDonHangWebDto> AllOrders { get; set; } = new List<LichSuDonHangWebDto>();
        public List<LichSuDonHangWebDto> FilteredOrders { get; set; } = new List<LichSuDonHangWebDto>();

        [TempData]
        public string? ErrorMessage { get; set; }

        [BindProperty(SupportsGet = true)]
        public string StatusFilter { get; set; } = "Tất cả";

        // Mảng này để render các tab
        public string[] StatusTabs { get; set; } = {
            "Tất cả", "Chờ xác nhận", "Chờ lấy hàng",
            "Đang giao", "Hoàn thành", "Đã Hủy" 
            // "Trả Hàng" sẽ được thêm khi có nghiệp vụ
        };

        public LichSuDonHangViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        public async Task<IActionResult> OnGetAsync()
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId)) return Challenge();

            var httpClient = _httpClientFactory.CreateClient("ApiClient");
            try
            {
                var response = await httpClient.GetFromJsonAsync<List<LichSuDonHangWebDto>>($"/api/web/profile/order-history/{userId}");
                if (response != null)
                {
                    AllOrders = response;
                }

                // Lọc danh sách đơn hàng dựa trên tab
                FilterOrders();
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Lỗi tải lịch sử đơn hàng: {ex.Message}";
            }
            return Page();
        }

        private void FilterOrders()
        {
            if (StatusFilter == "Tất cả")
            {
                FilteredOrders = AllOrders;
                return;
            }

            if (StatusFilter == "Đã Hủy")
            {
                // Đã hủy là trạng thái thanh toán
                FilteredOrders = AllOrders.Where(o => o.TrangThaiThanhToan == "Đã hủy").ToList();
            }
            else
            {
                // Các trạng thái còn lại là TrangThaiGiaoHang
                // (Và phải đảm bảo đơn đó chưa bị hủy)
                FilteredOrders = AllOrders.Where(o =>
                    o.TrangThaiGiaoHang == StatusFilter &&
                    o.TrangThaiThanhToan != "Đã hủy")
                    .ToList();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\LichSuThueSachView.cshtml
================================================================================
﻿@page "/Account/LichSuThueSachView"
@model WebCafebookApi.Pages.Account.LichSuThueSachViewModel
@{
    ViewData["Title"] = "Lịch sử thuê sách";
    Layout = "_Layout_Account"; // Sử dụng layout tài khoản [cite: 35]
}

<h3 class="page-title-account">@ViewData["Title"]</h3>
<p class="page-lead-account">Theo dõi các phiếu thuê sách và chi phí của bạn.</p>

<hr class="my-4" />

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

@if (Model.Rentals == null || !Model.Rentals.Any())
{
    <div class="alert alert-info">
        Bạn chưa có lịch sử thuê sách nào.
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th scope="col">Mã Phiếu</th>
                    <th scope="col">Ngày Thuê</th>
                    <th scope="col">Trạng Thái</th>
                    <th scope="col">SL Sách</th>
                    <th scope="col">Tiền Cọc</th>
                    <th scope="col">Phí Thuê</th>
                    <th scope="col">Tiền Phạt</th>
                    <th scope="col">Cọc Hoàn</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Rentals)
                {
                    <tr>
                        <td class="fw-bold">#@item.IdPhieuThueSach</td>
                        <td>@item.NgayThue.ToString("dd/MM/yyyy")</td>
                        <td>
                            <span class="badge @GetBadgeClass(item.TrangThai)">
                                @item.TrangThai
                            </span>
                        </td>
                        <td>@item.SoLuongSach</td>
                        <td>@item.TongTienCoc.ToString("N0") đ</td>

                        @if (item.NgayTra.HasValue)
                        {
                            <td class="text-danger">@item.TongPhiThue?.ToString("N0") đ</td>
                            <td class="text-danger fw-bold">@item.TongTienPhat?.ToString("N0") đ</td>
                            <td class="text-success">@item.TongTienCocHoan?.ToString("N0") đ</td>
                        }
                        else
                        {
                            <td colspan="3" class="text-muted text-center small"><em>(Chưa trả)</em></td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@functions {
    private string GetBadgeClass(string trangThai)
    {
        return trangThai.ToLower() switch
        {
            "đang thuê" => "bg-primary",
            "đã trả" => "bg-success",
            "đã hủy" => "bg-danger",
            _ => "bg-secondary",
        };
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\QuenMatKhauView.cshtml
================================================================================
﻿@page "/Account/ForgotPassword"
@* SỬA: Namespace *@
@model WebCafebookApi.Pages.Account.QuenMatKhauViewModel
@{
    ViewData["Title"] = "Quên Mật Khẩu";
    Layout = null; // Dùng layout login
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Cafebook</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body class="login-page-body">

    <div class="login-wrapper">
        <div class="login-container">
            <div class="login-brand-col d-none d-md-flex">
                <img src="/images/logo.png" alt="Cafebook Logo">
                <h1 class="mb-2">Cafebook</h1>
                <p class="fs-5 opacity-75">Khôi phục tài khoản</p>
            </div>

            <div class="login-form-col">
                <a asp-page="/Account/DangNhapView" class="text-decoration-none mb-3" style="align-self: flex-start;">
                    <span class="material-symbols-outlined" style="vertical-align: middle;">arrow_back</span>
                    Về trang Đăng nhập
                </a>

                <h2>@ViewData["Title"]</h2>
                <p class="text-muted">Nhập email của bạn để nhận mã xác nhận.</p>

                <form method="post">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-2" role="alert"></div>

                    <div class="form-floating-material">
                        <input asp-for="Input.Email" class="form-control" autocomplete="email" aria-required="true" placeholder=" " />
                        <label asp-for="Input.Email" class="form-label">Email</label>
                        <span class="material-symbols-outlined">mail</span>
                        <span asp-validation-for="Input.Email" class="text-danger small"></span>
                    </div>

                    <button type="submit" class="w-100 btn btn-lg btn-primary mt-3">Gửi Mã Xác Nhận</button>
                </form>
            </div>
        </div>
    </div>

    <partial name="_ValidationScriptsPartial" />
</body>
</html>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\QuenMatKhauView.cshtml.cs
================================================================================
﻿using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.ComponentModel.DataAnnotations;
using System.Threading.Tasks;
using WebCafebookApi.Services; // SỬA: Namespace
using Microsoft.Extensions.Caching.Memory;
using System;
using System.Net.Http; // <-- THÊM
using System.Net.Http.Json; // <-- THÊM
using CafebookModel.Model.ModelWeb; // <-- THÊM

namespace WebCafebookApi.Pages.Account // SỬA: Namespace
{
    public class QuenMatKhauViewModel : PageModel
    {
        private readonly EmailService _emailService;
        private readonly IHttpClientFactory _httpClientFactory; // <-- SỬA
        private readonly IMemoryCache _cache;
        private readonly Random _random = new Random();

        public QuenMatKhauViewModel(EmailService emailService, IHttpClientFactory httpClientFactory, IMemoryCache cache)
        {
            _emailService = emailService;
            _httpClientFactory = httpClientFactory; // <-- SỬA
            _cache = cache;
        }

        [BindProperty]
        public InputModel Input { get; set; } = new InputModel();

        [TempData]
        public string? StatusMessage { get; set; }

        public class InputModel
        {
            [Required(ErrorMessage = "Vui lòng nhập email.")]
            [EmailAddress(ErrorMessage = "Định dạng email không hợp lệ.")]
            public string Email { get; set; } = string.Empty;
        }

        public void OnGet() { }

        public async Task<IActionResult> OnPostAsync()
        {
            if (!ModelState.IsValid)
            {
                return Page();
            }

            var httpClient = _httpClientFactory.CreateClient();

            // 1. SỬA: Kiểm tra Email có tồn tại và hợp lệ không
            try
            {
                var checkEmail = new CheckEmailRequestDto { Email = Input.Email };
                var apiResponse = await httpClient.PostAsJsonAsync("http://localhost:5166/api/web/password/check-email", checkEmail);

                if (!apiResponse.IsSuccessStatusCode)
                {
                    var error = await apiResponse.Content.ReadFromJsonAsync<ApiErrorResponse>();
                    ModelState.AddModelError(string.Empty, error?.Message ?? "Email không tồn tại hoặc tài khoản bị khóa.");
                    return Page();
                }
            }
            catch (Exception ex)
            {
                ModelState.AddModelError(string.Empty, $"Lỗi kết nối API: {ex.Message}");
                return Page();
            }

            // 2. Tạo mã xác nhận
            string verificationCode = _random.Next(100000, 999999).ToString("D6");

            // 3. Lưu mã vào Cache
            string cacheKey = $"ForgotPassword_{Input.Email}";
            var cacheEntryOptions = new MemoryCacheEntryOptions()
                .SetAbsoluteExpiration(TimeSpan.FromMinutes(5));
            _cache.Set(cacheKey, verificationCode, cacheEntryOptions);

            // 4. Gửi email
            try
            {
                await _emailService.SendVerificationCodeAsync(Input.Email, verificationCode);

                // 5. Chuyển hướng
                TempData["VerificationEmail"] = Input.Email;
                return RedirectToPage("./XacNhanMaView");
            }
            catch (Exception ex)
            {
                ModelState.AddModelError(string.Empty, $"Không thể gửi email. Lỗi: {ex.Message}");
                return Page();
            }
        }

        private class ApiErrorResponse { public string? Message { get; set; } }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\TaiKhoanTongQuanView.cshtml
================================================================================
﻿@page "/Account/TaiKhoanTongQuanView"
@model WebCafebookApi.Pages.Account.TaiKhoanTongQuanViewModel
@{
    ViewData["Title"] = "Tài khoản của tôi";
    Layout = "_Layout_Account"; // Sử dụng layout tài khoản
}

<h3 class="page-title-account">Chào mừng, @Model.HoTen!</h3>
<p class="page-lead-account">Đây là trang tổng quan tài khoản của bạn.</p>

<hr class="my-4" />

<h5 class="mb-3">Thành viên Cafebook</h5>
<div class="row g-4">
    <div class="col-md-6">
        <div class="card overview-card h-100">
            <div class="card-body">
                <div class="overview-card-icon" style="color: var(--cf-orange);">
                    <span class="material-symbols-outlined">stars</span>
                </div>
                <h6 class="text-muted mb-1">Điểm tích lũy</h6>
                <h2 class="fw-bold">@Model.Overview.DiemTichLuy</h2>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card overview-card h-100">
            <div class="card-body">
                <div class="overview-card-icon">
                    <span class="material-symbols-outlined">calendar_month</span>
                </div>
                <h6 class="text-muted mb-1">Ngày tham gia</h6>
                <h2 class="fw-bold">@Model.Overview.NgayTao.ToString("dd/MM/yyyy")</h2>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card overview-card h-100">
            <div class="card-body">
                <div class="overview-card-icon">
                    <span class="material-symbols-outlined">receipt_long</span>
                </div>
                <h6 class="text-muted mb-1">Tổng số hóa đơn</h6>
                <h2 class="fw-bold">@Model.Overview.TongHoaDon</h2>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card overview-card h-100">
            <div class="card-body">
                <div class="overview-card-icon">
                    <span class="material-symbols-outlined">payments</span>
                </div>
                <h6 class="text-muted mb-1">Tổng chi tiêu</h6>
                <h2 class="fw-bold">@Model.Overview.TongChiTieu.ToString("N0") đ</h2>
            </div>
        </div>
    </div>
</div>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\TaiKhoanTongQuanView.cshtml.cs
================================================================================
﻿using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Json;
using System.Security.Claims;
using System.Threading.Tasks;

namespace WebCafebookApi.Pages.Account
{
    [Authorize(Roles = "KhachHang")]
    public class TaiKhoanTongQuanViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        public KhachHangTongQuanDto Overview { get; set; } = new();
        public string HoTen { get; set; } = string.Empty;

        public TaiKhoanTongQuanViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        private int GetCurrentUserId()
        {
            var userIdClaim = User.FindFirstValue(ClaimTypes.NameIdentifier);
            int.TryParse(userIdClaim, out int userId);
            return userId;
        }

        public async Task<IActionResult> OnGetAsync()
        {
            // SỬA LỖI CS0103: Xóa dòng "Layout = ..." ở đây.
            // Layout đã được gán trong file .cshtml
            var userId = GetCurrentUserId();
            if (userId == 0) return Challenge();

            HoTen = User.FindFirstValue(ClaimTypes.GivenName) ?? "Khách hàng";

            var httpClient = _httpClientFactory.CreateClient();
            try
            {
                var result = await httpClient.GetFromJsonAsync<KhachHangTongQuanDto>($"http://localhost:5166/api/web/profile/overview/{userId}");
                if (result != null)
                {
                    Overview = result;
                }
                return Page();
            }
            catch (System.Exception)
            {
                return Page();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\ThanhToanThanhCongView.cshtml
================================================================================
﻿@page "/Account/ThanhToanThanhCong/{id:int}"
@model WebCafebookApi.Pages.Account.ThanhToanThanhCongViewModel
@{
    ViewData["Title"] = "Đặt hàng thành công";
    Layout = "_Layout"; // Dùng layout chính
}

<div class="container mt-5">
    <div class="main-content-card">
        <div class="text-center" style="padding: 40px 20px;">

            @if (Model.ErrorMessage != null)
            {
                <span class="material-symbols-outlined text-danger" style="font-size: 60px;">error</span>
                <h1 class="display-5 fw-bold mt-3">Đã có lỗi xảy ra</h1>
                <p class="lead">@Model.ErrorMessage</p>
                <a asp-page="/GioHangView" class="btn btn-outline-primary mt-3">Quay lại giỏ hàng</a>
            }
            else if (Model.HoaDon != null)
            {
                <span class="material-symbols-outlined text-success" style="font-size: 60px;">task_alt</span>
                <h1 class="display-5 fw-bold mt-3">Đặt hàng thành công!</h1>
                <p class="lead text-muted">
                    Cảm ơn bạn đã đặt hàng.
                    Đơn hàng của bạn <strong>#@Model.HoaDon.IdHoaDonMoi</strong> đã được ghi nhận.
                </p>
                <p>Nhân viên của chúng tôi sẽ gọi điện xác nhận đơn hàng đến SĐT <strong>@Model.HoaDon.SoDienThoai</strong> trong thời gian sớm nhất.</p>

                <hr class="my-4" />

                <div class="row justify-content-center">
                    <div class="col-lg-8 text-start">
                        <h5 class="mb-3">Tóm tắt đơn hàng</h5>
                        <ul class="list-group mb-3">
                            @foreach (var item in Model.HoaDon.Items)
                            {
                                <li class="list-group-item d-flex justify-content-between lh-sm">
                                    <div>
                                        <h6 class="my-0">@item.TenHienThi</h6>
                                        <small class="text-muted">Số lượng: @item.SoLuong</small>
                                    </div>
                                    <span class="text-muted">@item.ThanhTien.ToString("N0") đ</span>
                                </li>
                            }
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Tiền hàng</span>
                                <strong>@Model.HoaDon.TongTienHang.ToString("N0") đ</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between text-danger">
                                <span>Giảm giá (KM + Điểm)</span>
                                <span>-@Model.HoaDon.GiamGia.ToString("N0") đ</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between fs-5">
                                <strong>Tổng cộng</strong>
                                <strong>@Model.HoaDon.ThanhTien.ToString("N0") đ</strong>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="d-flex justify-content-center gap-2 mt-4">
                    <a asp-page="/TrangChuView" class="btn btn-outline-secondary">Tiếp tục mua sắm</a>
                    <a asp-page="/Account/LichSuDonHangDetailView" asp-route-id="@Model.HoaDon.IdHoaDonMoi" class="btn btn-primary">
                        Xem chi tiết đơn hàng
                    </a>
                </div>
            }
        </div>
    </div>
</div>

@section Styles {
    <style>
        .page-title-account {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--cf-dark-brown);
        }

        .page-lead-account {
            font-size: 1.1rem;
            color: var(--cf-text);
            margin-bottom: 0;
        }
    </style>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\ThanhToanThanhCongView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/Account/ThanhToanThanhCongView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;

namespace WebCafebookApi.Pages.Account
{
    [Authorize(Roles = "KhachHang")]
    public class ThanhToanThanhCongViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        public ThanhToanThanhCongViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        [BindProperty(SupportsGet = true)]
        public int Id { get; set; } // Đây là IdHoaDon

        public ThanhToanThanhCongDto? HoaDon { get; set; }
        public string? ErrorMessage { get; set; }

        public async Task<IActionResult> OnGetAsync()
        {
            if (Id == 0)
            {
                ErrorMessage = "Không tìm thấy mã đơn hàng.";
                return Page();
            }

            var httpClient = _httpClientFactory.CreateClient("ApiClient");
            try
            {
                // Gọi API mới để lấy tóm tắt đơn hàng
                HoaDon = await httpClient.GetFromJsonAsync<ThanhToanThanhCongDto>($"api/web/thanhtoan/order-summary/{Id}");
                if (HoaDon == null)
                {
                    ErrorMessage = "Không thể tải thông tin đơn hàng.";
                }
            }
            catch (System.Exception ex)
            {
                // Lỗi 401 (Unauthorized) hoặc 404 (NotFound) cũng sẽ bị bắt ở đây
                ErrorMessage = $"Bạn không có quyền xem đơn hàng này hoặc đơn hàng không tồn tại. ({ex.Message})";
            }

            return Page();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\ThanhToanView.cshtml
================================================================================
﻿@page "/Account/ThanhToanView"
@model WebCafebookApi.Pages.Account.ThanhToanViewModel
@using System.Globalization
@{
    ViewData["Title"] = "Thanh Toán";
    Layout = "_Layout";
}

<div class="container mt-5">
    <div class="main-content-card">

        <h3 class="page-title-account">@ViewData["Title"]</h3>
        <p class="page-lead-account">Hoàn tất thông tin để đặt hàng (Chỉ áp dụng cho Thức uống/Món).</p>

        <hr class="my-4" />
        
        @* (Phần Form Input và Hóa đơn giữ nguyên) *@
        @if (!string.IsNullOrEmpty(Model.SuccessMessage))
        {
            <div class="alert alert-success">@Model.SuccessMessage</div>
        }
        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="alert alert-danger">@Model.ErrorMessage</div>
        }
        
        <form method="post">
            <div class="row g-5">
                
                <div class="col-lg-7">
                    <h4 class="mb-3">Thông tin giao hàng</h4>
                    
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3" role="alert"></div>

                    <div class="row g-3">
                        <div class="col-12">
                            <div class="material-input-group">
                                <label asp-for="Input.HoTen" class="form-label fw-bold"></label>
                                <input asp-for="Input.HoTen" class="material-input" />
                                <span asp-validation-for="Input.HoTen" class="text-danger small"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="material-input-group">
                                <label asp-for="Input.SoDienThoai" class="form-label fw-bold"></label>
                                <input asp-for="Input.SoDienThoai" class="material-input" />
                                <span asp-validation-for="Input.SoDienThoai" class="text-danger small"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="material-input-group">
                                <label asp-for="Input.Email" class="form-label fw-bold"></label>
                                <input asp-for="Input.Email" class="material-input" />
                                <span asp-validation-for="Input.Email" class="text-danger small"></span>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="material-input-group">
                                <label asp-for="Input.DiaChiGiaoHang" class="form-label fw-bold">Địa chỉ giao hàng</label>
                                <input asp-for="Input.DiaChiGiaoHang" class="material-input" placeholder="Số nhà, đường, phường/xã, quận/huyện..." />
                                <span asp-validation-for="Input.DiaChiGiaoHang" class="text-danger small"></span>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="material-input-group">
                                <label asp-for="Input.GhiChu" class="form-label fw-bold">Ghi chú (Không bắt buộc)</label>
                                <textarea asp-for="Input.GhiChu" class="material-input" rows="3" placeholder="Yêu cầu thêm (ít đường, nhiều đá...)"></textarea>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <h4 class="mb-3">Phương thức thanh toán</h4>
                    <div class="my-3">
                        <div class="form-check">
                            <input asp-for="Input.PhuongThucThanhToan" type="radio" value="COD" class="form-check-input" checked />
                            <label class="form-check-label" for="Input_PhuongThucThanhToan_COD">
                                Thanh toán khi nhận hàng (COD)
                            </label>
                        </div>
                        <div class="form-check">
                            <input asp-for="Input.PhuongThucThanhToan" type="radio" value="ChuyenKhoan" class="form-check-input" />
                            <label class="form-check-label" for="Input_PhuongThucThanhToan_ChuyenKhoan">
                                Chuyển khoản (Chúng tôi sẽ gọi xác nhận)
                            </label>
                        </div>
                    </div>
                    <span asp-validation-for="Input.PhuongThucThanhToan" class="text-danger small"></span>
                </div>

                <div class="col-lg-5">
                    <div class="card sticky-top" style="top: 20px;">
                        <div class="card-body">
                            <h4 class="d-flex justify-content-between align-items-center mb-3">
                                <span class="text-primary">Đơn hàng của bạn</span>
                                <span class="badge bg-primary rounded-pill">@Model.PageData.SanPhamItems.Count</span>
                            </h4>

                            <ul class="list-group mb-3">
                                @foreach (var item in Model.PageData.SanPhamItems)
                                {
                                    <li class="list-group-item d-flex justify-content-between lh-sm">
                                        <div>
                                            <h6 class="my-0">@item.TenHienThi</h6>
                                            <small class="text-muted">Số lượng: @item.SoLuong</small>
                                        </div>
                                        <span class="text-muted">@item.ThanhTien.ToString("N0") đ</span>
                                    </li>
                                }
                                
                                <li class="list-group-item d-flex justify-content-between lh-sm">
                                    <h6 class="my-0">Tiền hàng</h6>
                                    <strong>@Model.PageData.TongTienHang.ToString("N0") đ</strong>
                                </li>
                                <li class="list-group-item d-flex justify-content-between lh-sm">
                                    <div>
                                        <h6 class="my-0">Khuyến mãi</h6>
                                        <small class="text-muted" id="selected-promo-name">-- Chưa áp dụng --</small>
                                        <input type="hidden" asp-for="Input.IdKhuyenMai" id="selected-promo-id" value="" />
                                    </div>
                                    <button type="button" class="btn btn-link btn-sm p-0" data-bs-toggle="modal" data-bs-target="#promoModal" id="btn-chon-km">
                                        Chọn mã
                                    </button>
                                </li>
                                <li class="list-group-item d-flex justify-content-between text-success">
                                    <span>Giảm giá (KM)</span>
                                    <span id="discount-amount">- 0 đ</span>
                                </li>
                                
                                <li class="list-group-item d-flex justify-content-between lh-sm">
                                    <div>
                                        <h6 class="my-0">Dùng điểm tích lũy</h6>
                                        <small class="text-muted">Bạn có: @Model.PageData.KhachHang.DiemTichLuy điểm</small>
                                        <div class="input-group input-group-sm mt-1" style="max-width: 150px;">
                                            <input asp-for="Input.DiemSuDung" type="number" class="form-control" value="0" min="0" max="@Model.PageData.KhachHang.DiemTichLuy" id="Input_DiemSuDung" />
                                            <span class="input-group-text">điểm</span>
                                        </div>
                                    </div>
                                </li>
                                <li class="list-group-item d-flex justify-content-between text-info">
                                    <span>Giảm giá (Điểm)</span>
                                    <span id="point-discount-amount">- 0 đ</span>
                                </li>

                                <li class="list-group-item d-flex justify-content-between">
                                    <span>Tổng (VND)</span>
                                    <strong id="total-amount" class="fs-5">@Model.PageData.TongTienHang.ToString("N0") đ</strong>
                                </li>
                            </ul>

                            <button type="submit" class="w-100 btn btn-primary btn-lg">
                                Xác nhận Đặt Hàng
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="promoModal" tabindex="-1" aria-labelledby="promoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="promoModalLabel">Chọn Khuyến Mãi Áp Dụng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="list-group-item list-group-item-action promo-item-modal active" data-id="0">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">-- Không áp dụng --</h6>
                        <span class="badge bg-success">Có thể áp dụng</span>
                    </div>
                    <p class="mb-1 small text-muted">Chọn mục này để gỡ bỏ khuyến mãi hiện tại.</p>
                </div>
                
                @foreach (var promo in Model.PageData.KhuyenMaisHopLe)
                {
                    <div class="list-group-item list-group-item-action promo-item-modal" 
                         data-id="@promo.IdKhuyenMai"
                         data-loai="@promo.LoaiGiamGia"
                         data-giatri="@promo.GiaTriGiam.ToString(CultureInfo.InvariantCulture)"
                         data-giamtoida="@((promo.GiamToiDa ?? 0).ToString(CultureInfo.InvariantCulture))"
                         data-idspapdung="@(promo.IdSanPhamApDung ?? 0)"
                         data-hdttoithieu="@((promo.HoaDonToiThieu ?? 0).ToString(CultureInfo.InvariantCulture))"
                         
                         data-ngaytrongtuan="@(promo.NgayTrongTuan ?? "")"
                         data-giobatdau="@(promo.GioBatDau?.ToString(@"hh\:mm") ?? "")"
                         data-gioketthuc="@(promo.GioKetThuc?.ToString(@"hh\:mm") ?? "")">

                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1 promo-title">@promo.TenChuongTrinh (@promo.MaKhuyenMai)</h6>
                            <span class="badge promo-status"></span>
                        </div>
                        <p class="mb-1 small text-muted promo-description">@promo.DieuKienApDung</p>
                        <small class="text-danger promo-reason"></small>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="btnApplyPromo">Áp dụng</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // 1. Dữ liệu từ Backend
        const subtotal = @Model.PageData.TongTienHang.ToString(CultureInfo.InvariantCulture);
        const tiLeDoiDiem = @Model.PageData.TiLeDoiDiemVND.ToString(CultureInfo.InvariantCulture);
        const maxPoints = @Model.PageData.KhachHang.DiemTichLuy;
        
        const cartItems = {
        @foreach (var item in Model.PageData.SanPhamItems)
        {
            @Html.Raw($"'{item.Id}': {item.ThanhTien.ToString(CultureInfo.InvariantCulture)},")
        }
        };

        // Biến toàn cục lưu trữ KM đã chọn
        let selectedPromo = {
            id: 0,
            name: "-- Chưa áp dụng --",
            discount: 0
        };

        // 2. DOM Elements
        const $diemInput = $('#Input_DiemSuDung');
        const $promoModal = $('#promoModal');
        const $promoAmountText = $('#discount-amount');
        const $diemAmountText = $('#point-discount-amount');
        const $totalAmountText = $('#total-amount');
        const $selectedPromoIdInput = $('#selected-promo-id');
        const $selectedPromoNameText = $('#selected-promo-name');
        const $btnChonKmTrigger = $('#btn-chon-km'); 

        // =======================================
        // === THÊM MỚI: HÀM HELPER THỜI GIAN ===
        // =======================================
        function getCurrentTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        function getCurrentDayOfWeek() {
            const days = ["Chủ nhật", "Thứ 2", "Thứ 3", "Thứ 4", "Thứ 5", "Thứ 6", "Thứ 7"];
            const now = new Date();
            return days[now.getDay()];
        }

        // 3. Hàm kiểm tra điều kiện KM (ĐÃ NÂNG CẤP)
        function checkEligibility(promoData) {
            const minSpend = parseFloat(promoData.hdttoithieu); 
            const idSpApDung = parseInt(promoData.idspapdung);

            // === YÊU CẦU MỚI: KIỂM TRA THỜI GIAN ===
            const ngayTrongTuan = promoData.ngaytrongtuan; // "Thứ 2, Thứ 3"
            const gioBatDau = promoData.giobatdau;       // "14:00"
            const gioKetThuc = promoData.gioketthuc;     // "16:00"

            if (gioBatDau && gioKetThuc) {
                const currentTime = getCurrentTime();
                if (currentTime < gioBatDau || currentTime > gioKetThuc) {
                    return { eligible: false, reason: `Chỉ áp dụng trong khung giờ ${gioBatDau} - ${gioKetThuc}.` };
                }
            }
            if (ngayTrongTuan) {
                const currentDay = getCurrentDayOfWeek(); // "Thứ 5"
                if (!ngayTrongTuan.includes(currentDay)) {
                    return { eligible: false, reason: `Chỉ áp dụng vào các ngày: ${ngayTrongTuan}.` };
                }
            }
            // === KẾT THÚC LOGIC MỚI ===

            if (minSpend > 0 && subtotal < minSpend) {
                return { eligible: false, reason: `Cần hóa đơn tối thiểu ${minSpend.toLocaleString('vi-VN')} đ.` };
            }

            if (idSpApDung > 0 && !cartItems.hasOwnProperty(idSpApDung)) {
                return { eligible: false, reason: "Khuyến mãi này chỉ áp dụng cho một số sản phẩm nhất định (hiện không có trong giỏ)." };
            }

            // Nếu qua hết, tính toán giảm giá
            let subtotalForPromo = subtotal;
            if (idSpApDung > 0) {
                subtotalForPromo = cartItems[idSpApDung] || 0;
            }

            let discount = 0;
            const loai = promoData.loai;
            const giaTri = parseFloat(promoData.giatri);
            const giamToiDa = parseFloat(promoData.giamtoida);

            if (loai.toLowerCase() === 'phantram') {
                discount = subtotalForPromo * (giaTri / 100);
                if (giamToiDa > 0 && discount > giamToiDa) {
                    discount = giamToiDa;
                }
            } else { // SoTien
                discount = giaTri;
            }
            
            discount = Math.min(discount, subtotalForPromo);
            return { eligible: true, reason: null, discount: discount };
        }

        // 4. Hàm cập nhật tổng tiền (ĐÃ SỬA LỖI 50%)
        function updateTotal() {
            // 4.1. Lấy giá trị khuyến mãi (KM)
            const promoDiscount = selectedPromo.discount;
            $promoAmountText.text('- ' + promoDiscount.toLocaleString('vi-VN') + ' đ');
            $selectedPromoNameText.text(selectedPromo.name);
            $btnChonKmTrigger.text(selectedPromo.name); 
            $selectedPromoIdInput.val(selectedPromo.id);

            // 4.2. Lấy giá trị điểm và validate
            let points = parseInt($diemInput.val()) || 0;
            if (points < 0) { points = 0; }
            if (points > maxPoints) { points = maxPoints; $diemInput.val(maxPoints); }
            
            let pointDiscount = points * tiLeDoiDiem;
            const totalAfterPromo = subtotal - promoDiscount; 

            // Logic 50%
            const maxAllowedPointDiscount = totalAfterPromo * 0.5; 
            
            if (pointDiscount > maxAllowedPointDiscount) {
                pointDiscount = maxAllowedPointDiscount;
                let pointsUsed = Math.ceil(pointDiscount / tiLeDoiDiem); 
                if (pointsUsed > maxPoints) { pointsUsed = maxPoints; } 
                
                if (parseInt($diemInput.val()) !== pointsUsed) {
                    $diemInput.val(pointsUsed);
                }
                points = pointsUsed;
            }

            $diemAmountText.text('- ' + pointDiscount.toLocaleString('vi-VN') + ' đ');

            // 4.3. Tính tổng cuối cùng
            let total = subtotal - promoDiscount - pointDiscount; 
            if (total < 0) total = 0;

            $totalAmountText.text(total.toLocaleString('vi-VN') + ' đ');
        }

        // 5. Sự kiện khi mở Modal (Đã sửa)
        $promoModal.on('show.bs.modal', function () {
            const currentPromoId = selectedPromo.id; 

            $('.promo-item-modal').each(function() {
                const $item = $(this);
                const id = parseInt($item.data('id'));
                
                $item.removeClass('active');
                if (id === currentPromoId) {
                    $item.addClass('active'); 
                }

                if (id === 0) return; 

                const promoData = $item.data();
                const result = checkEligibility(promoData);

                const $status = $item.find('.promo-status');
                const $reason = $item.find('.promo-reason');

                if (result.eligible) {
                    $item.removeClass('disabled-promo');
                    $status.text('Có thể áp dụng').removeClass('bg-danger').addClass('bg-success');
                    $reason.text('');
                } else {
                    $item.addClass('disabled-promo');
                    $status.text('Không hợp lệ').removeClass('bg-success').addClass('bg-danger');
                    $reason.text(result.reason);
                }
            });
        });

        // 6. Sự kiện khi click CHỌN 1 KM (Chỉ highlight)
        $('.promo-item-modal').on('click', function() {
            const $item = $(this);
            if ($item.hasClass('disabled-promo')) {
                return; 
            }
            $('.promo-item-modal').removeClass('active');
            $item.addClass('active');
        });

        // 7. SỰ KIỆN MỚI: Khi nhấn nút "Áp dụng"
        $('#btnApplyPromo').on('click', function() {
            const $item = $('.promo-item-modal.active');
            
            if ($item.length === 0) {
                selectedPromo = { id: 0, name: "Chọn mã", discount: 0 };
            } else {
                const id = parseInt($item.data('id'));
                
                if (id === 0) {
                    selectedPromo = { id: 0, name: "Chọn mã", discount: 0 };
                } else {
                    const promoData = $item.data();
                    const result = checkEligibility(promoData); 
                    selectedPromo = {
                        id: id,
                        name: $item.find('.promo-title').text(),
                        discount: result.discount
                    };
                }
            }
            
            updateTotal(); 
            $promoModal.modal('hide'); 
        });

        // 8. Sự kiện khi nhập điểm (Giữ nguyên)
        $diemInput.on('input', updateTotal);
        
        // Chạy lần đầu khi tải trang
        updateTotal();
    </script>
}

@section Styles {
    <style>
        .page-title-account {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--cf-dark-brown);
        }
        .page-lead-account {
            font-size: 1.1rem;
            color: var(--cf-text);
            margin-bottom: 0;
        }
        .material-input-group {
            margin-bottom: 1.5rem !important;
        }
        .promo-item-modal {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .promo-item-modal:hover {
            background-color: #f8f9fa;
        }
        .promo-item-modal.disabled-promo {
            cursor: not-allowed;
            background-color: #f8f8f8;
            opacity: 0.7;
        }
        .promo-item-modal.disabled-promo .promo-title {
            color: #6c757d;
        }
        .promo-item-modal.active {
            background-color: var(--cf-cream, #FFF8E1);
            border-left: 4px solid var(--cf-orange, #D27D2D);
            font-weight: 500;
        }
        #btn-chon-km {
            text-decoration: none;
            font-weight: 500;
        }
    </style>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\ThanhToanView.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/Account/ThanhToanView.cshtml.cs
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http;
using System.Net.Http.Json;
using System.Security.Claims;
using System.Threading.Tasks;
using WebCafebookApi.Services;
using System.Linq;
using System.Collections.Generic;

namespace WebCafebookApi.Pages.Account
{
    [Authorize(Roles = "KhachHang")]
    public class ThanhToanViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        public ThanhToanViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        public ThanhToanLoadDto PageData { get; set; } = new();

        [BindProperty]
        public ThanhToanSubmitDto Input { get; set; } = new();

        [TempData]
        public string? SuccessMessage { get; set; }
        [TempData]
        public string? ErrorMessage { get; set; }

        private HttpClient GetApiClient()
        {
            // ApiClient (từ Program.cs) đã tự động đính kèm JWT Token
            return _httpClientFactory.CreateClient("ApiClient");
        }

        public async Task<IActionResult> OnGetAsync()
        {
            var httpClient = GetApiClient();
            try
            {
                // 1. Tải dữ liệu API (Khách hàng, Khuyến mãi, Tỷ lệ điểm)
                var loadedData = await httpClient.GetFromJsonAsync<ThanhToanLoadDto>("api/web/thanhtoan/load");

                if (loadedData == null)
                {
                    ErrorMessage = "Không thể tải dữ liệu thanh toán.";
                    return Page();
                }
                PageData = loadedData;

                // 2. Tải giỏ hàng từ SESSION (của Frontend)
                var sessionCart = HttpContext.Session.Get<List<CartItemDto>>(WebCafebookApi.Services.SessionExtensions.CartKey)
                                  ?? new List<CartItemDto>();

                // 3. Lấy thông tin chi tiết cho giỏ hàng
                var sanPhamItems = new List<GioHangItemViewModel>();
                // SỬA: Xóa List<GioHangItemViewModel> sachItems

                var publicClient = _httpClientFactory.CreateClient(); // Client không auth

                foreach (var item in sessionCart)
                {
                    // =======================================
                    // === SỬA LỖI CS1061 TẠI ĐÂY ===
                    // Xóa toàn bộ logic if/else (item.Loai), vì giỏ hàng chỉ còn IdSanPham
                    try
                    {
                        var sp = await publicClient.GetFromJsonAsync<SanPhamChiTietDto>($"http://localhost:5166/api/web/thucdon/{item.Id}");
                        if (sp != null)
                        {
                            sanPhamItems.Add(new GioHangItemViewModel
                            {
                                Id = item.Id,
                                // SỬA: Xóa 'Loai'
                                TenHienThi = sp.TenSanPham,
                                HinhAnhUrl = sp.HinhAnhUrl,
                                DonGia = sp.DonGia,
                                SoLuong = item.SoLuong
                            });
                        }
                    }
                    catch (System.Exception ex)
                    {
                        ErrorMessage = "Lỗi khi tải thông tin giỏ hàng: " + ex.Message;
                    }
                    // =======================================
                }

                // 4. Gán giỏ hàng đã xử lý vào PageData
                PageData.SanPhamItems = sanPhamItems;
                PageData.SachItems = new List<GioHangItemViewModel>(); // SỬA: Khởi tạo rỗng
                PageData.TongTienHang = sanPhamItems.Sum(i => i.ThanhTien);


                // 5. Xử lý chuyển hướng nếu giỏ hàng không hợp lệ
                // SỬA: Xóa logic kiểm tra sách
                if (PageData.SanPhamItems.Count == 0)
                {
                    return RedirectToPage("/GioHangView");
                }

                // 6. Điền thông tin mặc định cho form Input
                Input.HoTen = PageData.KhachHang.HoTen;
                Input.SoDienThoai = PageData.KhachHang.SoDienThoai;
                Input.Email = PageData.KhachHang.Email;
                Input.DiaChiGiaoHang = PageData.KhachHang.DiaChi;
                Input.PhuongThucThanhToan = "COD";
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Lỗi tải trang: {ex.Message}";
            }
            return Page();
        }

        public async Task<IActionResult> OnPostAsync()
        {
            var loadTask = OnGetAsync(); // Tải lại dữ liệu nền

            if (!ModelState.IsValid)
            {
                await loadTask;
                return Page();
            }

            var httpClient = GetApiClient();
            try
            {
                var sessionCart = HttpContext.Session.Get<List<CartItemDto>>(WebCafebookApi.Services.SessionExtensions.CartKey)
                                  ?? new List<CartItemDto>();
                Input.ItemsToPurchase = sessionCart; // Gán giỏ hàng vào DTO

                var response = await httpClient.PostAsJsonAsync("api/web/thanhtoan/submit", Input);

                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<ThanhToanResponseDto>();
                    SuccessMessage = result?.Message ?? "Đặt hàng thành công!";

                    // =======================================
                    // === SỬA LỖI CS1061 TẠI ĐÂY ===
                    // Xóa giỏ hàng hoàn toàn (thay vì lọc sách)
                    HttpContext.Session.Remove(WebCafebookApi.Services.SessionExtensions.CartKey);
                    // =======================================

                    // =======================================
                    // === YÊU CẦU MỚI: Chuyển hướng ===
                    // =======================================
                    return RedirectToPage("/Account/ThanhToanThanhCongView", new { id = result.IdHoaDonMoi });
                }
                else
                {
                    var errorResult = await response.Content.ReadFromJsonAsync<ThanhToanResponseDto>();
                    ErrorMessage = errorResult?.Message ?? "Đã xảy ra lỗi khi đặt hàng.";
                }
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Lỗi hệ thống: {ex.Message}";
            }

            await loadTask;
            return Page();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\ThongTinCaNhanView.cshtml
================================================================================
﻿@page "/Account/ThongTinCaNhanView"
@model WebCafebookApi.Pages.Account.ThongTinCaNhanViewModel
@{
    ViewData["Title"] = "Hồ sơ";
    Layout = "_Layout_Account"; // Sử dụng layout tài khoản
}

<h3 class="page-title-account">@ViewData["Title"]</h3>
<p class="page-lead-account">Quản lý thông tin hồ sơ của bạn.</p>

<hr class="my-4" />

@if (!string.IsNullOrEmpty(Model.SuccessMessage))
{
    <div class="alert alert-success">@Model.SuccessMessage</div>
}
@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

@if (Model.IsEditMode)
{
    <form method="post" enctype="multipart/form-data">
        <div class="row g-4">
            <div class="col-md-4">
                <h5 class="mb-3">Ảnh đại diện</h5>
                <div class="avatar-upload-container">
                    <img id="avatarPreview" src="@Model.AvatarHienTaiUrl" alt="Avatar" class="rounded-circle shadow-sm" />
                    <label for="avatarUploadInput" class="btn btn-outline-primary btn-sm mt-3">
                        <span class="material-symbols-outlined" style="font-size: 1rem; vertical-align: middle;">upload</span>
                        Đổi ảnh
                    </label>
                    <input type="file" asp-for="AvatarFile" id="avatarUploadInput" class="d-none" accept="image/png, image/jpeg, image/gif" />
                    <div id="avatarSizeError" class="text-danger small mt-2" style="display: none;">Lỗi: Ảnh không được vượt quá 3MB.</div>
                    <div id="avatarTypeError" class="text-danger small mt-2" style="display: none;">Lỗi: Chỉ chấp nhận file .png, .jpg, .gif.</div>
                </div>
            </div>

            <div class="col-md-8">
                <h5 class="mb-3">Thông tin hồ sơ</h5>
                <div asp-validation-summary="ModelOnly" class="text-danger mb-3" role="alert"></div>

                <div class="material-input-group mb-3">
                    <label asp-for="Input.TenDangNhap" class="form-label fw-bold">Tên đăng nhập</label>
                    @* Xóa "readonly disabled" và thay value bằng asp-for *@
                    <input asp-for="Input.TenDangNhap" class="material-input" />
                    <span asp-validation-for="Input.TenDangNhap" class="text-danger small"></span>
                </div>

                <div class="material-input-group mb-3">
                    <label asp-for="Input.HoTen" class="form-label fw-bold"></label>
                    <input asp-for="Input.HoTen" class="material-input" />
                    <span asp-validation-for="Input.HoTen" class="text-danger small"></span>
                </div>

                <div class="material-input-group mb-3">
                    <label asp-for="Input.Email" class="form-label fw-bold"></label>
                    <input asp-for="Input.Email" class="material-input" placeholder="example@gmail.com" />
                    <span asp-validation-for="Input.Email" class="text-danger small"></span>
                </div>

                <div class="material-input-group mb-3">
                    <label asp-for="Input.SoDienThoai" class="form-label fw-bold"></label>
                    <input asp-for="Input.SoDienThoai" class="material-input" placeholder="090..." />
                    <span asp-validation-for="Input.SoDienThoai" class="text-danger small"></span>
                </div>

                <div class="material-input-group mb-3">
                    <label asp-for="Input.DiaChi" class="form-label fw-bold"></label>
                    <input asp-for="Input.DiaChi" class="material-input" placeholder="Số nhà, đường, phường/xã..." />
                    <span asp-validation-for="Input.DiaChi" class="text-danger small"></span>
                </div>

                <button type="submit" class="btn btn-primary mt-3">
                    <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 4px;">save</span>
                    Lưu Thay Đổi
                </button>
                <a asp-page="/Account/ThongTinCaNhanView" class="btn btn-link text-muted mt-3">Hủy</a>
            </div>
        </div>
    </form>
}
else
{
    <div class="row g-4">
        <div class="col-md-4 text-center">
            <img src="@Model.AvatarHienTaiUrl" alt="Avatar" class="rounded-circle shadow-sm" style="width: 200px; height: 200px; object-fit: cover;" />
        </div>
        <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Thông tin hồ sơ</h5>
                <a asp-page-handler="Edit" class="btn btn-outline-primary btn-sm">
                    <span class="material-symbols-outlined" style="font-size: 1rem; vertical-align: middle;">edit</span>
                    Sửa
                </a>
            </div>

            <div class="profile-display-group">
                <label>Họ tên</label>
                <p>@Model.Input.HoTen</p>
            </div>
            <div class="profile-display-group">
                <label>Tên đăng nhập</label>
                @* Sửa "Model.TenDangNhap" thành "Model.Input.TenDangNhap" *@
                <p>@(string.IsNullOrWhiteSpace(Model.Input.TenDangNhap) ? "(Chưa cập nhật)" : Model.Input.TenDangNhap)</p>
            </div>
            <div class="profile-display-group">
                <label>Email</label>
                <p>@(string.IsNullOrWhiteSpace(Model.Input.Email) ? "(Chưa cập nhật)" : Model.Input.Email)</p>
            </div>
            <div class="profile-display-group">
                <label>Số điện thoại</label>
                <p>@(string.IsNullOrWhiteSpace(Model.Input.SoDienThoai) ? "(Chưa cập nhật)" : Model.Input.SoDienThoai)</p>
            </div>
            <div class="profile-display-group">
                <label>Địa chỉ</label>
                <p>@(string.IsNullOrWhiteSpace(Model.Input.DiaChi) ? "(Chưa cập nhật)" : Model.Input.DiaChi)</p>
            </div>
        </div>
    </div>
}


@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/profile.js" asp-append-version="true"></script>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\ThongTinCaNhanView.cshtml.cs
================================================================================
﻿using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http;
using System.Net.Http.Json;
using System.Security.Claims;
using System.Threading.Tasks;

namespace WebCafebookApi.Pages.Account
{
    [Authorize(Roles = "KhachHang")]
    public class ThongTinCaNhanViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        [BindProperty]
        public ProfileUpdateModel Input { get; set; } = new();

        [BindProperty]
        public IFormFile? AvatarFile { get; set; }

        public string TenDangNhap { get; set; } = string.Empty;
        public string AvatarHienTaiUrl { get; set; } = string.Empty;

        public bool IsEditMode { get; set; } = false;

        [TempData]
        public string? SuccessMessage { get; set; }
        [TempData]
        public string? ErrorMessage { get; set; }

        public ThongTinCaNhanViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        private int GetCurrentUserId()
        {
            var userIdClaim = User.FindFirstValue(ClaimTypes.NameIdentifier);
            int.TryParse(userIdClaim, out int userId);
            return userId;
        }

        public async Task<IActionResult> OnGetAsync(string? handler)
        {
            // SỬA LỖI CS0103: Xóa dòng "Layout = ..." ở đây.
            var userId = GetCurrentUserId();
            if (userId == 0) return Challenge();

            if (handler == "Edit")
            {
                IsEditMode = true;
            }

            var httpClient = _httpClientFactory.CreateClient();
            try
            {
                var profile = await httpClient.GetFromJsonAsync<KhachHangProfileDto>($"http://localhost:5166/api/web/profile/{userId}");
                if (profile != null)
                {
                    Input.HoTen = profile.HoTen;
                    Input.SoDienThoai = profile.SoDienThoai;
                    Input.Email = profile.Email;
                    Input.DiaChi = profile.DiaChi;
                    Input.TenDangNhap = profile.TenDangNhap ?? ""; // Gán vào Input
                    AvatarHienTaiUrl = profile.AnhDaiDienUrl ?? "/images/default-avatar.png";
                }
                return Page();
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Lỗi tải thông tin: {ex.Message}";
                return Page();
            }
        }

        public async Task<IActionResult> OnPostAsync()
        {
            var userId = GetCurrentUserId();
            if (userId == 0) return Challenge();
            if (!ModelState.IsValid)
            {
                return await OnGetAsync("Edit");
            }

            var httpClient = _httpClientFactory.CreateClient();
            using var formData = new MultipartFormDataContent();

            formData.Add(new StringContent(Input.HoTen), nameof(Input.HoTen));
            formData.Add(new StringContent(Input.SoDienThoai ?? ""), nameof(Input.SoDienThoai));
            formData.Add(new StringContent(Input.Email ?? ""), nameof(Input.Email));
            formData.Add(new StringContent(Input.DiaChi ?? ""), nameof(Input.DiaChi));

            // ==================================
            // === THÊM MỚI ===
            // ==================================
            formData.Add(new StringContent(Input.TenDangNhap), nameof(Input.TenDangNhap));
            // ==================================

            if (AvatarFile != null)
            {
                formData.Add(new StreamContent(AvatarFile.OpenReadStream()), "avatarFile", AvatarFile.FileName);
            }

            try
            {
                var response = await httpClient.PutAsync($"http://localhost:5166/api/web/profile/update-info/{userId}", formData);

                if (response.IsSuccessStatusCode)
                {
                    SuccessMessage = "Cập nhật thông tin thành công!";

                    var result = await response.Content.ReadFromJsonAsync<UpdateAvatarResponse>();
                    if (!string.IsNullOrEmpty(result?.newAvatarUrl))
                    {
                        HttpContext.Session.SetString("AvatarUrl", result.newAvatarUrl);
                    }
                    // Cập nhật claims
                    await UpdateClaims(Input.HoTen, Input.TenDangNhap);
                }
                else
                {
                    // ==================================
                    // === SỬA LẠI: Hiển thị lỗi rõ ràng ===
                    // ==================================
                    var errorBody = await response.Content.ReadAsStringAsync();
                    // Thử parse lỗi validation từ API (nếu có)
                    try
                    {
                        var errorResult = System.Text.Json.JsonSerializer.Deserialize<ValidationProblemDetails>(errorBody);
                        if (errorResult?.Errors != null)
                        {
                            foreach (var err in errorResult.Errors)
                            {
                                ModelState.AddModelError($"Input.{err.Key}", err.Value.FirstOrDefault() ?? "Lỗi không xác định");
                            }
                        }
                        else
                        {
                            ModelState.AddModelError(string.Empty, errorBody);
                        }
                    }
                    catch
                    {
                        ModelState.AddModelError(string.Empty, $"Lỗi từ API: {errorBody}");
                    }

                    AvatarHienTaiUrl = HttpContext.Session.GetString("AvatarUrl") ?? "/images/default-avatar.png";
                    IsEditMode = true;
                    return Page();
                    // ==================================
                }
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Lỗi: {ex.Message}";
                return await OnGetAsync("Edit");
            }

            return RedirectToPage();
        }

        // (Hàm helper UpdateClaims và class UpdateAvatarResponse giữ nguyên)
        private async Task UpdateClaims(string newHoTen, string newTenDangNhap)
        {
            var user = User.Identity as ClaimsIdentity;
            if (user != null)
            {
                var oldGivenName = user.FindFirst(ClaimTypes.GivenName);
                if (oldGivenName != null) user.RemoveClaim(oldGivenName);
                user.AddClaim(new Claim(ClaimTypes.GivenName, newHoTen));

                // ==================================
                // === THÊM MỚI: Cập nhật ClaimTypes.Name (dùng cho TenDangNhap) ===
                // ==================================
                var oldName = user.FindFirst(ClaimTypes.Name);
                if (oldName != null) user.RemoveClaim(oldName);
                user.AddClaim(new Claim(ClaimTypes.Name, newTenDangNhap));
                // ==================================

                await HttpContext.SignOutAsync();
                await HttpContext.SignInAsync(new ClaimsPrincipal(user));
            }
        }
        private class UpdateAvatarResponse { public string? newAvatarUrl { get; set; } }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\XacNhanMaView.cshtml
================================================================================
﻿@page "/Account/VerifyCode"
@model WebCafebookApi.Pages.Account.XacNhanMaViewModel
@{
    ViewData["Title"] = "Xác Nhận Mã";
    Layout = null; // Dùng layout login
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Cafebook</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body class="login-page-body">

    <div class="login-wrapper">
        <div class="login-container">
            <div class="login-brand-col d-none d-md-flex">
                <img src="/images/logo.png" alt="Cafebook Logo">
                <h1 class="mb-2">Cafebook</h1>
                <p class="fs-5 opacity-75">Khôi phục tài khoản</p>
            </div>

            <div class="login-form-col">
                <a asp-page="/Account/QuenMatKhauView" class="text-decoration-none mb-3" style="align-self: flex-start;">
                    <span class="material-symbols-outlined" style="vertical-align: middle;">arrow_back</span>
                    Gửi lại mã?
                </a>

                <h2>@ViewData["Title"]</h2>
                <p class="text-muted">Nhập mã 6 chữ số đã được gửi đến @Model.Input.Email</p>

                <form method="post">
                    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                    {
                        <div class="alert alert-danger">@Model.ErrorMessage</div>
                    }

                    <input type="hidden" asp-for="Input.Email" />

                    <div class="form-floating-material">
                        <input asp-for="Input.VerificationCode" class="form-control" autocomplete="one-time-code" aria-required="true" placeholder=" " />
                        <label asp-for="Input.VerificationCode" class="form-label">Mã 6 chữ số</label>
                        <span class="material-symbols-outlined">password</span>
                        <span asp-validation-for="Input.VerificationCode" class="text-danger small"></span>
                    </div>

                    <button type="submit" class="w-100 btn btn-lg btn-primary mt-3">Xác Nhận</button>
                </form>
            </div>
        </div>
    </div>

    <partial name="_ValidationScriptsPartial" />
</body>
</html>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\XacNhanMaView.cshtml.cs
================================================================================
﻿using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.Extensions.Caching.Memory;
using System.ComponentModel.DataAnnotations;
using System;

namespace WebCafebookApi.Pages.Account // SỬA: Namespace
{
    public class XacNhanMaViewModel : PageModel
    {
        private readonly IMemoryCache _cache;

        public XacNhanMaViewModel(IMemoryCache cache)
        {
            _cache = cache;
        }

        [BindProperty]
        public InputModel Input { get; set; } = new InputModel();

        [TempData]
        public string? ErrorMessage { get; set; }

        public class InputModel
        {
            [Required]
            [HiddenInput]
            public string Email { get; set; } = string.Empty;

            [Required(ErrorMessage = "Vui lòng nhập mã xác nhận.")]
            [Display(Name = "Mã Xác Nhận")]
            [RegularExpression(@"^\d{6}$", ErrorMessage = "Mã xác nhận phải gồm 6 chữ số.")]
            public string VerificationCode { get; set; } = string.Empty;
        }

        public IActionResult OnGet()
        {
            var email = TempData["VerificationEmail"] as string;
            if (string.IsNullOrEmpty(email))
            {
                return RedirectToPage("./QuenMatKhauView");
            }

            Input.Email = email;
            TempData.Keep("VerificationEmail");
            return Page();
        }

        public IActionResult OnPostAsync()
        {
            if (!ModelState.IsValid)
            {
                return Page();
            }

            string email = Input.Email;
            string cacheKey = $"ForgotPassword_{email}";

            if (_cache.TryGetValue(cacheKey, out string? cachedCode))
            {
                if (cachedCode == Input.VerificationCode)
                {
                    // Mã ĐÚNG. Tạo token reset
                    string resetToken = Guid.NewGuid().ToString("N");
                    string resetCacheKey = $"ResetToken_{email}";
                    var resetCacheOptions = new MemoryCacheEntryOptions()
                        .SetAbsoluteExpiration(TimeSpan.FromMinutes(10));

                    _cache.Set(resetCacheKey, resetToken, resetCacheOptions);
                    _cache.Remove(cacheKey);
                    TempData.Remove("VerificationEmail");

                    return RedirectToPage("./DatLaiMatKhauView", new { email = email, token = resetToken });
                }
                else
                {
                    ErrorMessage = "Mã xác nhận không đúng.";
                    TempData.Keep("VerificationEmail");
                    return Page();
                }
            }
            else
            {
                ErrorMessage = "Mã xác nhận đã hết hạn hoặc không tồn tại.";
                TempData.Keep("VerificationEmail");
                return Page();
            }
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Account\_Layout_Account.cshtml
================================================================================
﻿@* Tập tin: WebCafebookApi/Pages/Account/_Layout_Account.cshtml *@
@{
    Layout = "_Layout";
    string? CurrentPage()
    {
        return ViewContext.RouteData.Values["page"]?.ToString();
    }
}

<div class="container mt-5">
    <div class="main-content-card">
        <div class="account-layout-container">

            <div class="account-sidebar">
                <nav class="nav flex-column nav-pills">

                    <a class="nav-link @(CurrentPage() == "/Account/TaiKhoanTongQuanView" ? "active" : "")"
                       asp-page="/Account/TaiKhoanTongQuanView">
                        <span class="material-symbols-outlined">person</span>
                        Tài khoản của tôi
                    </a>
                    <a class="nav-link @(CurrentPage() == "/Account/ThongTinCaNhanView" ? "active" : "")"
                       asp-page="/Account/ThongTinCaNhanView">
                        <span class="material-symbols-outlined">badge</span>
                        Hồ sơ
                    </a>
                    <a class="nav-link @(CurrentPage() == "/Account/DoiMatKhauView" ? "active" : "")"
                       asp-page="/Account/DoiMatKhauView">
                        <span class="material-symbols-outlined">lock</span>
                        Đổi mật khẩu
                    </a>
                    <a class="nav-link @(CurrentPage() == "/Account/LichSuDatBanView" ? "active" : "")"
                       asp-page="/Account/LichSuDatBanView">
                        <span class="material-symbols-outlined">event_list</span>
                        Lịch sử đặt bàn
                    </a>
                    <a class="nav-link @(CurrentPage() == "/Account/LichSuThueSachView" ? "active" : "")"
                       asp-page="/Account/LichSuThueSachView">
                        <span class="material-symbols-outlined">menu_book</span>
                        Lịch sử thuê sách
                    </a>

                    <a class="nav-link @(CurrentPage() == "/Account/LichSuDonHangView" ? "active" : "")"
                       asp-page="/Account/LichSuDonHangView">
                        <span class="material-symbols-outlined">receipt_long</span>
                        Lịch sử mua hàng
                    </a>

                </nav>
            </div>

            <div class="account-content">
                @RenderBody()
            </div>

        </div>
    </div>
</div>

@section Scripts {
    @await RenderSectionAsync("Scripts", required: false)
}

@section Styles {
    @await RenderSectionAsync("Styles", required: false)
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\DangNhapEmployee.cshtml
================================================================================
﻿@page "/Employee/Login"
@model WebCafebookApi.Pages.employee.DangNhapEmployeeModel
@{
    ViewData["Title"] = "Đăng nhập Nhân viên";
    Layout = null; // Dùng layout riêng của trang Login
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Cafebook</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body class="login-page-body">

    <div class="login-wrapper" style="max-width: 450px;">
        <div class="login-container" style="flex-direction: column;">

            <div class="login-form-col">
                <a asp-page="/Index" class="text-decoration-none mb-3" style="align-self: flex-start;">
                    <span class="material-symbols-outlined" style="vertical-align: middle;">arrow_back</span>
                    Về Trang Chủ
                </a>

                <h2 class="text-center">@ViewData["Title"]</h2>
                <p class="text-muted text-center">Sử dụng tài khoản nội bộ của bạn.</p>

                <form id="account" method="post">

                    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                    {
                        <div class="alert alert-danger" role="alert">@Model.ErrorMessage</div>
                    }
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-2" role="alert"></div>

                    <div class="form-floating-material">
                        <input asp-for="Input.TenDangNhap" class="form-control" autocomplete="username" aria-required="true" placeholder=" " />
                        <label asp-for="Input.TenDangNhap">Tài khoản (Username, Email hoặc SĐT)</label>
                        <span class="material-symbols-outlined">shield_person</span>
                        <span asp-validation-for="Input.TenDangNhap" class="text-danger small"></span>
                    </div>

                    <div class="form-floating-material">
                        <input asp-for="Input.MatKhau" type="password" class="form-control" autocomplete="current-password" aria-required="true" placeholder=" " />
                        <label asp-for="Input.MatKhau">Mật khẩu</label>
                        <span class="material-symbols-outlined">lock</span>
                        <span asp-validation-for="Input.MatKhau" class="text-danger small"></span>
                    </div>

                    <div>
                        <button id="login-submit" type="submit" class="w-100 btn btn-lg btn-primary">Đăng nhập</button>
                    </div>

                </form>
            </div>
        </div>
    </div>

    <partial name="_ValidationScriptsPartial" />
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\DangNhapEmployee.cshtml.cs
================================================================================
﻿// Tập tin: WebCafebookApi/Pages/employee/DangNhapEmployee.cshtml.cs
using System.ComponentModel.DataAnnotations;
using System.Security.Claims;
using CafebookModel.Model.ModelApi;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Json;
using CafebookModel.Model.Data;

namespace WebCafebookApi.Pages.employee
{
    public class DangNhapEmployeeModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;
        public DangNhapEmployeeModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        [BindProperty]
        public InputModel Input { get; set; } = new();

        [TempData]
        public string? ErrorMessage { get; set; }

        public class InputModel
        {
            [Required(ErrorMessage = "Vui lòng nhập tài khoản")]
            public string TenDangNhap { get; set; } = string.Empty;

            [Required(ErrorMessage = "Vui lòng nhập mật khẩu")]
            [DataType(DataType.Password)]
            public string MatKhau { get; set; } = string.Empty;
        }

        public async Task OnGetAsync()
        {
            await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
        }

        public async Task<IActionResult> OnPostAsync()
        {
            if (!ModelState.IsValid)
            {
                return Page();
            }

            var httpClient = _httpClientFactory.CreateClient();
            var apiRequest = new LoginRequestModel
            {
                TenDangNhap = Input.TenDangNhap,
                MatKhau = Input.MatKhau
            };
            var response = await httpClient.PostAsJsonAsync("http://localhost:5166/api/web/taikhoannv/login", apiRequest);

            if (response.IsSuccessStatusCode)
            {
                var apiResponse = await response.Content.ReadFromJsonAsync<WebLoginResponseModel>();
                if (apiResponse != null && apiResponse.Success && apiResponse.NhanVienData != null)
                {
                    var user = apiResponse.NhanVienData;
                    var claims = new List<Claim>
                    {
                        new Claim(ClaimTypes.NameIdentifier, user.IdNhanVien.ToString()),
                        new Claim(ClaimTypes.Name, user.HoTen ?? ""),
                        new Claim(ClaimTypes.GivenName, user.HoTen ?? ""),
                        new Claim(ClaimTypes.Role, user.TenVaiTro ?? "NhanVien")
                    };
                    foreach (var quyen in user.DanhSachQuyen)
                    {
                        claims.Add(new Claim("Permission", quyen));
                    }

                    var claimsIdentity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
                    var authProperties = new AuthenticationProperties { ExpiresUtc = DateTimeOffset.UtcNow.AddHours(8) };

                    await HttpContext.SignInAsync(
                        CookieAuthenticationDefaults.AuthenticationScheme,
                        new ClaimsPrincipal(claimsIdentity),
                        authProperties);

                    // SỬA: Lưu URL thay vì Base64 và đổi tên Key
                    HttpContext.Session.SetString("AvatarUrl", user.AnhDaiDien ?? "");

                    // Chuyển hướng đến trang Dashboard
                    return LocalRedirect(Url.Content("~/Employee/Dashboard"));
                }
                else
                {
                    ErrorMessage = apiResponse?.Message ?? "Lỗi không xác định từ API.";
                    return Page();
                }
            }

            ErrorMessage = "Không thể kết nối đến máy chủ đăng nhập.";
            return Page();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\DangXuat.cshtml
================================================================================
﻿@page "/Employee/Logout"
@model WebCafebookApi.Pages.employee.DangXuatModel
@{
    ViewData["Title"] = "Đăng xuất";
}
<p>Đang đăng xuất...</p>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\DangXuat.cshtml.cs
================================================================================
﻿using CafebookApi.Data;
using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Threading.Tasks;

namespace WebCafebookApi.Pages.employee
{
    public class DangXuatModel : PageModel
    {
        public async Task<IActionResult> OnPostAsync()
        {
            await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
            HttpContext.Session.Clear();
            return RedirectToPage("/Employee/DangNhapEmployee");
        }

        public async Task<IActionResult> OnGetAsync()
        {
            return await OnPostAsync();
        }
    }
}



================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\SoDoBanView.cshtml
================================================================================
﻿@page "/Employee/SoDoBan"
@model WebCafebookApi.Pages.employee.SoDoBanViewModel
@{
    ViewData["Title"] = "Sơ Đồ Bàn";
    Layout = "_Layout_Employee";
}

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}
else
{
    <div class="sodoban-layout-container">

        <nav class="sodoban-khuvuc-tabs">
            <h6 class="px-3 text-muted text-uppercase small">Khu Vực</h6>
            <ul class="nav flex-column nav-pills">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-khuvuc-id="all">
                        <span class="material-symbols-outlined">apps</span>
                        Tất cả Khu Vực
                    </a>
                </li>
                @foreach (var kv in Model.KhuVucList)
                {
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-khuvuc-id="@kv.IdKhuVuc">
                            <span class="material-symbols-outlined">label</span>
                            @kv.TenKhuVuc
                        </a>
                    </li>
                }
            </ul>
        </nav>

        <div class="sodoban-content">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1 class="page-title" style="border: none; margin: 0;">@ViewData["Title"]</h1>
                <div class="d-none d-md-flex">
                    <div class="me-3"><span class="status-box status-trong"></span> Trống</div>
                    <div class="me-3"><span class="status-box status-co-khach"></span> Có khách</div>
                    <div class="me-3"><span class="status-box status-da-dat"></span> Đã đặt</div>
                    <div class="me-3"><span class="status-box status-bao-tri"></span> Bảo trì</div>
                </div>
            </div>

            <div id="table-layout-container" class="sodoban-grid" data-nhanvien-id="@Model.NhanVienId">
            </div>
        </div>

        <div class="sodoban-panel">
            <div id="order-panel" class="card sticky-top" style="top: 20px;">
                <div class="card-body">
                    <div id="panel-no-selection" class="text-center p-4">
                        <span class="material-symbols-outlined" style="font-size: 48px; color: var(--cf-gray);">touch_app</span>
                        <p class="text-muted mt-2">Vui lòng chọn một bàn để xem chi tiết.</p>
                    </div>

                    <div id="order-panel-info" style="display: none;">
                        <h3 id="ban-so-ban" class="fw-bold">Bàn 101</h3>
                        <p id="ban-trang-thai" class="badge bg-success fs-6">Trống</p>

                        <h4 id="ban-tong-tien" class="text-danger fw-bold" style="display: none;">0 đ</h4>

                        <div id="ban-ghi-chu-group" class="mt-2" style="display:none;">
                            <label class="small fw-bold text-muted">Ghi chú:</label>
                            <p id="ban-ghi-chu" class="fst-italic" style="color: var(--cf-text);"></p>
                        </div>

                        <hr class="my-3" />

                        <div id="actions-trong" class="d-grid gap-2">
                            <button id="btnMoBan" class="btn btn-primary btn-lg p-3">
                                <span class="material-symbols-outlined">add</span> Tạo Hóa Đơn (Mở Bàn)
                            </button>
                        </div>

                        <div id="actions-co-khach" class="d-grid gap-2">
                            <button id="btnGoiMon" class="btn btn-primary btn-lg p-3">
                                <span class="material-symbols-outlined">add_shopping_cart</span> Gọi Món / Xem HĐ
                            </button>
                        </div>

                        <div id="actions-da-dat" class="d-grid gap-2">
                            <button id="btnKhachDen" class="btn btn-primary btn-lg p-3">
                                <span class="material-symbols-outlined">check</span> Khách đến (Mở bàn)
                            </button>
                        </div>

                        <hr class="my-3" />

                        <div class="d-grid gap-2">
                            <div class="row g-2">
                                <div class="col-6 d-grid">
                                    <button id="btnChuyenBan" class="btn btn-outline-secondary p-3">
                                        <span class="material-symbols-outlined">swap_horiz</span> Chuyển Bàn
                                    </button>
                                </div>
                                <div class="col-6 d-grid">
                                    <button id="btnGopBan" class="btn btn-outline-secondary p-3">
                                        <span class="material-symbols-outlined">merge_type</span> Gộp Bàn
                                    </button>
                                </div>
                            </div>
                            <button id="btnBaoCaoSuCo" class="btn btn-outline-warning p-3">
                                <span class="material-symbols-outlined">warning</span> Báo cáo Sự cố
                            </button>
                            <button id="refresh-tables-btn" class="btn btn-link text-muted mt-3">
                                <span class="material-symbols-outlined">refresh</span> Làm mới Sơ đồ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
}

@section Scripts {
    <script>
        // Truyền dữ liệu từ Model C# sang JavaScript
        const khuVucData = @Json.Serialize(Model.KhuVucList);
        const allTables = khuVucData.flatMap(kv => kv.bans);
        let currentSelectedBan = null;

        // Hàm render các thẻ Bàn
        function renderTables(banList) {
            const $container = $("#table-layout-container");
            $container.empty();

            if (!banList || banList.length === 0) {
                $container.html('<p class="text-muted text-center w-100 p-5">Khu vực này không có bàn nào.</p>');
                return;
            }

            banList.forEach(ban => {
                let statusClass = "status-trong";
                let statusText = "Trống";
                let icon = "event_seat";

                switch (ban.trangThai.toLowerCase()) {
                    case "có khách":
                        statusClass = "status-co-khach";
                        statusText = "Có khách";
                        icon = "people";
                        break;
                    case "đã đặt":
                        statusClass = "status-da-dat";
                        statusText = "Đã đặt";
                        icon = "book_online";
                        break;
                    case "bảo trì":
                        statusClass = "status-bao-tri";
                        statusText = "Bảo trì";
                        icon = "build";
                        break;
                }

                // SỬA: Xóa hiển thị TongTien khỏi card
                const cardHtml = `
                    <div class="table-card ${statusClass}" data-ban-id="${ban.idBan}">
                        <div class="table-icon">
                            <span class="material-symbols-outlined">${icon}</span>
                        </div>
                        <h5 class="table-name">${ban.soBan}</h5>
                        <div class="table-status">${statusText}</div>
                    </div>
                `;
                const $card = $(cardHtml);
                $card.data('ban-json', ban);
                $container.append($card);
            });
        }

        // SỬA: Hàm cập nhật Panel Chi tiết
        function updatePanel(ban) {
            currentSelectedBan = ban;

            $("#panel-no-selection").hide();
            $("#order-panel-info").show();

            $("#ban-so-ban").text(ban.soBan);
            // SỬA: Ẩn Tổng Tiền
            $("#ban-tong-tien").hide();

            // SỬA: Hiển thị Ghi chú
            if(ban.ghiChu && ban.ghiChu.trim() !== "") {
                $("#ban-ghi-chu").text(ban.ghiChu);
                $("#ban-ghi-chu-group").show();
            } else {
                $("#ban-ghi-chu-group").hide();
            }

            // Cập nhật Trạng thái (badge)
            const $statusBadge = $("#ban-trang-thai");
            $statusBadge.text(ban.trangThai).removeClass('bg-success bg-danger bg-warning bg-secondary');

            $("#actions-trong, #actions-co-khach, #actions-da-dat").hide();

            switch (ban.trangThai.toLowerCase()) {
                case "trống":
                    $statusBadge.addClass('bg-success');
                    $("#actions-trong").show();
                    break;
                case "có khách":
                    $statusBadge.addClass('bg-danger');
                    $("#actions-co-khach").show();
                    break;
                case "đã đặt":
                    $statusBadge.addClass('bg-warning');
                    $("#actions-da-dat").show();
                    break;
                default: // Bảo trì
                    $statusBadge.addClass('bg-secondary');
                    break;
            }
        }

        // (Hàm resetPanel và logic $(document).ready() giữ nguyên)
        function resetPanel() {
            currentSelectedBan = null;
            $("#panel-no-selection").show();
            $("#order-panel-info").hide();
            $(".table-card").removeClass("selected");
        }

        $(document).ready(function () {

            // 1. Render bàn
            renderTables(allTables);

            // 2. Xử lý click Tab Khu Vực
            $(".sodoban-khuvuc-tabs .nav-link").on("click", function (e) {
                e.preventDefault();
                $(".sodoban-khuvuc-tabs .nav-link").removeClass("active");
                $(this).addClass("active");

                const khuVucId = $(this).data("khuvuc-id");

                if (khuVucId === "all") {
                    renderTables(allTables);
                } else {
                    const selectedKhuVuc = khuVucData.find(kv => kv.idKhuVuc == khuVucId);
                    if(selectedKhuVuc) {
                        renderTables(selectedKhuVuc.bans);
                    }
                }
                resetPanel();
            });

            // 3. Xử lý click Bàn
            $("#table-layout-container").on("click", ".table-card", function () {
                if ($(this).hasClass('status-bao-tri')) return;

                $(".table-card").removeClass("selected");
                $(this).addClass("selected");

                const banData = $(this).data('ban-json');
                updatePanel(banData);
            });

            // 4. Xử lý logic JS (Sử dụng API của WPF)
            const apiBaseUrl = "http://localhost:5166";
            const currentNhanVienId = $("#table-layout-container").data("nhanvien-id");

            // Mở bàn / Khách đến / Gọi món
            $("#btnMoBan, #btnKhachDen, #btnGoiMon").on("click", function () {
                if (!currentSelectedBan || !currentNhanVienId) return;

                // SỬA: Nút "Gọi Món" và "Mở Bàn" giờ làm cùng 1 việc
                const actionText = $(this).attr('id') === 'btnGoiMon' ? "Gọi Món/Xem HĐ" : "Mở Bàn";
                if(!confirm(`Bạn muốn ${actionText} cho bàn ${currentSelectedBan.soBan}?`)) return;

                $(this).prop('disabled', true);
                $.ajax({
                    url: `${apiBaseUrl}/api/app/sodoban/createorder`,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        IdBan: currentSelectedBan.idBan,
                        IdNhanVien: currentNhanVienId,
                        IdKhachHang: 1
                    }),
                    success: function (response) {
                        alert("Thao tác thành công. Đang tải lại sơ đồ...");
                        location.reload();
                    },
                    error: function (xhr) {
                        alert(`Lỗi khi thao tác: ${xhr.responseText}`);
                        $(this).prop('disabled', false);
                    }
                });
            });

            // SỬA: Xóa các nút Hủy

            // Làm mới
            $("#refresh-tables-btn").on("click", function (e) {
                e.preventDefault();
                location.reload();
            });

            // Các nút đang phát triển
            $("#btnDatBan").on("click", function () { alert("Chức năng 'Đặt Bàn' đang được phát triển."); });
            $("#btnBaoCaoSuCo").on("click", function () { alert("Chức năng 'Báo Cáo Sự Cố' đang được phát triển."); });
            $("#btnChuyenBan").on("click", function () { alert("Chức năng 'Chuyển Bàn' đang được phát triển."); });
            $("#btnGopBan").on("click", function () { alert("Chức năng 'Gộp Bàn' đang được phát triển."); });
        });
    </script>
}

@section Styles {
    <style>
        .sodoban-layout-container {
            display: flex;
            gap: 1.5rem;
        }

        /* 1. Tab Khu Vực (Trái) */
        .sodoban-khuvuc-tabs {
            flex: 0 0 220px;
            background-color: var(--cf-white);
            border-radius: 12px;
            padding: 1rem;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

            .sodoban-khuvuc-tabs .nav-link {
                color: var(--cf-text);
                font-weight: 500;
                font-size: 1rem;
                padding: 0.75rem 1rem;
                display: flex;
                align-items: center;
                gap: 1rem;
                border-radius: 8px;
                margin-bottom: 0.25rem;
            }

                .sodoban-khuvuc-tabs .nav-link .material-symbols-outlined {
                    color: var(--cf-orange);
                    font-variation-settings: 'FILL' 0;
                    transition: all 0.2s ease;
                }

                .sodoban-khuvuc-tabs .nav-link:hover {
                    background-color: var(--cf-cream);
                }

                .sodoban-khuvuc-tabs .nav-link.active {
                    background-color: var(--cf-brown);
                    color: var(--cf-white);
                    box-shadow: 0 2px 4px var(--cf-shadow);
                }

                    .sodoban-khuvuc-tabs .nav-link.active .material-symbols-outlined {
                        color: var(--cf-white);
                        font-variation-settings: 'FILL' 1;
                    }

        /* 2. Content (Giữa) */
        .sodoban-content {
            flex: 1;
            min-width: 0;
        }

        .sodoban-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        /* 3. Panel (Phải) */
        .sodoban-panel {
            flex: 0 0 300px;
        }

            .sodoban-panel .card {
                background-color: var(--cf-white);
                border-radius: 12px;
            }

            .sodoban-panel .btn {
                padding-top: 0.75rem;
                padding-bottom: 0.75rem;
            }

            .sodoban-panel .btn-lg {
                padding-top: 1rem;
                padding-bottom: 1rem;
            }

            .sodoban-panel .material-symbols-outlined {
                vertical-align: middle;
                margin-right: 8px;
                font-size: 1.25rem;
            }

        /* 4. Table Card (Ghi đè/Bổ sung từ site.css) */
        .table-card {
            border: 3px solid transparent;
            border-top: 5px solid;
        }

            .table-card.selected {
                border-color: var(--cf-orange) !important;
                box-shadow: 0 8px 20px rgba(210, 125, 45, 0.5) !important;
            }

            .table-card .table-icon .material-symbols-outlined {
                font-size: 28px;
                font-variation-settings: 'FILL' 1;
            }
    </style>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\SoDoBanView.cshtml.cs
================================================================================
﻿using CafebookModel.Model.ModelWeb.QuanLy;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Collections.Generic;
using System.Net.Http;
using System.Net.Http.Json;
using System.Security.Claims;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Authorization;

namespace WebCafebookApi.Pages.employee
{
    [Authorize(Roles = "Quản trị viên, Phục vụ, Thu ngân, Pha chế, Bếp, Quản lý")]
    public class SoDoBanViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        public int NhanVienId { get; set; }
        public string? ErrorMessage { get; set; }
        public List<KhuVucDto> KhuVucList { get; set; } = new();

        public SoDoBanViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        public async Task<IActionResult> OnGetAsync()
        {
            var idNhanVienStr = User.FindFirstValue(ClaimTypes.NameIdentifier);
            int.TryParse(idNhanVienStr, out var id);
            NhanVienId = id;

            var httpClient = _httpClientFactory.CreateClient();
            try
            {
                var response = await httpClient.GetFromJsonAsync<List<KhuVucDto>>("http://localhost:5166/api/web/quanly/sodoban");
                if (response != null)
                {
                    KhuVucList = response;
                }
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Lỗi tải Sơ đồ bàn: {ex.Message}";
            }

            return Page();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\WebQuanLyView.cshtml
================================================================================
﻿@page "/Employee/Dashboard"
@model WebCafebookApi.Pages.employee.WebQuanLyViewModel
@{
    ViewData["Title"] = "Bảng điều khiển";
    Layout = "_Layout_Employee";

    var avatarSrc = string.IsNullOrEmpty(Model.DashboardData.AnhDaiDienUrl)
        ? "/images/default-avatar.png"
        : Model.DashboardData.AnhDaiDienUrl;
}

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}
else
{
    <div class="mb-4">
        <h1 class="page-title">@ViewData["Title"]</h1>
        <p class="page-lead">Tổng quan hoạt động của quán trong ngày.</p>
    </div>

    <div class="row g-4">
        <div class="col-lg-4 col-md-5">
            <div class="card h-100 product-card">
                <div class="card-body text-center d-flex flex-column justify-content-center align-items-center p-4">
                    <img src="@avatarSrc" alt="Avatar" class="rounded-circle mb-3 shadow-sm" style="width: 120px; height: 120px; object-fit: cover;" />
                    <h3 class="card-title fw-bold mb-1">@Model.DashboardData.HoTen</h3>
                    <p class="card-text text-muted fs-5 mb-3">@Model.DashboardData.VaiTro</p>
                    <hr class="w-100" />
                    <p class="card-text fs-5 mb-0">
                        <strong class="text-uppercase">Ca làm việc hôm nay:</strong>
                        <br />
                        <span class="fw-bold fs-4" style="color: var(--cf-orange);">
                            @(Model.DashboardData.CaHienTai ?? "...")
                        </span>
                    </p>
                </div>
            </div>
        </div>

        <div class="col-lg-8 col-md-7">
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="stat-card stat-red">
                        <div class="card-body">
                            <div class="stat-icon">
                                <span class="material-symbols-outlined">group</span>
                            </div>
                            <div>
                                <h1 class="display-5 fw-bold mb-0">@Model.DashboardData.TongBanDangPhucVu</h1>
                                <p class="card-text fs-5 text-muted mb-0">Bàn Đang Phục Vụ</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stat-card stat-blue">
                        <div class="card-body">
                            <div class="stat-icon">
                                <span class="material-symbols-outlined">receipt_long</span>
                            </div>
                            <div>
                                <h1 class="display-5 fw-bold mb-0">@Model.DashboardData.TongDonDangXuLy</h1>
                                <p class="card-text fs-5 text-muted mb-0">Đơn Đang Xử Lý</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-grid">
                <a asp-page="/Employee/SoDoBanView" class="btn btn-primary btn-lg p-4">
                    <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 8px;">grid_view</span>
                    Bắt đầu làm việc (Sơ Đồ Bàn)
                </a>
            </div>
        </div>
    </div>
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\WebQuanLyView.cshtml.cs
================================================================================
﻿using CafebookModel.Model.ModelWeb;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Net.Http.Json;
using System.Security.Claims;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Authorization; // <-- THÊM

namespace WebCafebookApi.Pages.employee
{
    // SỬA: Thêm [Authorize] với các vai trò thực tế từ CSDL
    [Authorize(Roles = "Quản trị viên, Phục vụ, Thu ngân, Pha chế, Bếp, Quản lý")]
    public class WebQuanLyViewModel : PageModel
    {
        private readonly IHttpClientFactory _httpClientFactory;

        public WebQuanLyViewModel(IHttpClientFactory httpClientFactory)
        {
            _httpClientFactory = httpClientFactory;
        }

        [BindProperty]
        public WebQuanLyDashboardDto DashboardData { get; set; } = new();
        public string? ErrorMessage { get; set; }

        public async Task<IActionResult> OnGetAsync()
        {
            var idNhanVienStr = User.FindFirstValue(ClaimTypes.NameIdentifier);
            // SỬA: Không cần kiểm tra ID nữa vì [Authorize] đã làm việc đó

            var httpClient = _httpClientFactory.CreateClient();
            try
            {
                var response = await httpClient.GetFromJsonAsync<WebQuanLyDashboardDto>($"http://localhost:5166/api/web/quanly/dashboard/{idNhanVienStr}");

                if (response != null)
                {
                    DashboardData = response;
                }
                else
                {
                    ErrorMessage = "Không thể tải dữ liệu dashboard.";
                }
            }
            catch (System.Exception ex)
            {
                ErrorMessage = $"Lỗi kết nối API: {ex.Message}";
            }

            return Page();
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\_Layout_Employee.cshtml
================================================================================
﻿@using System.Security.Claims
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Quản lý Cafebook</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    @await RenderSectionAsync("Styles", required: false)
</head>
<body class="employee-body">
    <div class="d-flex">

        <nav class="sidebar-nav">
            <div class="sidebar-header">
                <a class="navbar-brand fs-4" asp-page="/employee/WebQuanLyView">
                    <span class="material-symbols-outlined" style="vertical-align: middle;">coffee</span>
                    Cafebook
                </a>
            </div>

            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link @(ViewData["Title"]?.ToString() == "Bảng điều khiển" ? "active" : "")"
                       asp-page="/Employee/WebQuanLyView">
                        <span class="material-symbols-outlined">analytics</span>
                        Tổng quan
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @(ViewData["Title"]?.ToString() == "Sơ Đồ Bàn" ? "active" : "")"
                       asp-page="/Employee/SoDoBanView">
                        <span class="material-symbols-outlined">grid_view</span>
                        Sơ Đồ Bàn
                    </a>
                </li>
            </ul>
        </nav>

        <div class="main-content">
            <header class="header-nav shadow-sm">
                <span class="navbar-text fw-bold" style="color: var(--cf-text);">
                    <!-- === SỬA LỖI CS8602 (Dòng 44) === -->
                    <!-- Thêm '?' sau User.Identity để kiểm tra null an toàn -->
                    Xin chào, @(User.FindFirstValue(ClaimTypes.GivenName) ?? User.Identity?.Name)!
                </span>
                <form method="post" asp-page="/employee/DangXuat">
                    <button type="submit" class="btn btn-link nav-link text-danger d-flex align-items-center gap-2">
                        <span class="material-symbols-outlined">logout</span>
                        Đăng xuất
                    </button>
                </form>
            </header>

            <main role="main">
                <div class="main-content-card">
                    @RenderBody()
                </div>
            </main>
        </div>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\employee\_ViewStart.cshtml
================================================================================
﻿@{
    Layout = "_Layout_Employee";
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Shared\_Layout.cshtml
================================================================================
﻿@using System.Security.Claims
@using WebCafebookApi.Services     
@using CafebookModel.Model.ModelWeb 
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

@{
    // 4. Đọc giỏ hàng từ Session
    var cart = HttpContextAccessor.HttpContext?.Session.Get<List<CartItemDto>>(WebCafebookApi.Services.SessionExtensions.CartKey);
    var cartCount = cart?.Count ?? 0;
}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Cafebook</title>

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />

    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

    @await RenderSectionAsync("Styles", required: false)
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-white border-bottom box-shadow-sm mb-3">
            <div class="container">
                <a class="navbar-brand" asp-page="/Index">
                    <img src="/images/logo.png" alt="Cafebook Logo" style="height: 30px; margin-right: 8px;">
                    Cafebook
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target=".navbar-collapse" aria-controls="navbarSupportedContent"
                        aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="navbar-collapse collapse d-sm-inline-flex justify-content-between">
                    <ul class="navbar-nav flex-grow-1">
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-page="/TrangChuView">Trang Chủ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-page="/ThucDonView">Thực Đơn</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-page="/ThuVienSachView">Thư Viện Sách</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-page="/DatBanView">Đặt Bàn</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-page="/LienHeView">Liên Hệ</a>
                        </li>
                    </ul>

                    @* === 5. THÊM ICON GIỎ HÀNG VÀ LOGINPARTIAL === *@
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-cart-icon" asp-page="/GioHangView" title="Giỏ hàng">
                                <span class="material-symbols-outlined">shopping_cart</span>
                                @if (cartCount > 0)
                                {
                                    <span class="badge rounded-pill bg-danger">@cartCount</span>
                                }
                            </a>
                        </li>
                        <partial name="_LoginPartial" />
                    </ul>

                </div>
            </div>
        </nav>
    </header>

    <div class="main-container">
        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>

    <footer class="footer text-muted mt-5">
        <div class="container d-flex justify-content-between align-items-center py-4">
            <div>
                &copy; @DateTime.Now.Year - Cafebook
                <a class="footer-link" asp-page="/LienHeView">Liên Hệ</a>
                <a class="footer-link" asp-page="/ChinhSachView">Chính sách</a>
            </div>
            <div>
                <a class="footer-link" asp-page="/Employee/DangNhapEmployee">Đăng nhập nhân viên</a>
            </div>
        </div>
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Shared\_Layout.cshtml.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Shared\_LoginPartial.cshtml
================================================================================
﻿@using System.Security.Claims
@using Microsoft.AspNetCore.Http

<ul class="navbar-nav align-items-center">
    @if (User.Identity?.IsAuthenticated == true && User.IsInRole("KhachHang"))
    {
        var displayName = User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.GivenName)?.Value;
        if (string.IsNullOrWhiteSpace(displayName))
        {
            displayName = User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Name)?.Value ?? "Người dùng";
        }

        // SỬA LỖI: Lấy "AvatarUrl" từ Session thay vì "AvatarBase64"
        var avatarUrl = Context.Session.GetString("AvatarUrl");
        var avatarSrc = string.IsNullOrEmpty(avatarUrl)
        ? "/images/default-avatar.png" // 1. Lấy ảnh MẶC ĐỊNH
        : avatarUrl; // 2. Dùng thẳng URL từ API

        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <img src="@avatarSrc" alt="Avatar" class="rounded-circle" style="width: 30px; height: 30px; object-fit: cover; margin-right: 8px;" />
                Xin chào, @displayName!
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <li>
                    <a class="dropdown-item" asp-page="/account/ThongTinCaNhanView">
                        <span class="material-symbols-outlined" style="vertical-align: sub; font-size: 1.2rem; margin-right: 8px;">account_circle</span>
                        Thông tin cá nhân
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" asp-page="/account/LichSuDatBanView">
                        <span class="material-symbols-outlined" style="vertical-align: sub; font-size: 1.2rem; margin-right: 8px;">history</span>
                        Lịch sử đặt bàn
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" asp-page="/account/LichSuThueSachView">
                        <span class="material-symbols-outlined" style="vertical-align: sub; font-size: 1.2rem; margin-right: 8px;">book</span>
                        Sách đang thuê
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <form class="form-inline" asp-page="/Account/DangXuat" asp-route-returnUrl="@Url.Page("/Index", new { area = "" })" method="post">
                        <button type="submit" class="dropdown-item">
                            <span class="material-symbols-outlined" style="vertical-align: sub; font-size: 1.2rem; margin-right: 8px;">logout</span>
                            Đăng xuất
                        </button>
                    </form>
                </li>
            </ul>
        </li>
    }
    else
    {
        <li class="nav-item">
            <a class="nav-link text-dark" asp-page="/Account/DangKyView">Đăng ký</a>
        </li>
        <li class="nav-item">
            <a class="nav-link text-dark" asp-page="/Account/DangNhapView">Đăng nhập</a>
        </li>
    }
</ul>
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Pages\Shared\_ValidationScriptsPartial.cshtml
================================================================================
﻿<script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
<script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>

================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Properties\launchSettings.json
================================================================================
{
  "$schema": "http://json.schemastore.org/launchsettings.json",
  "iisSettings": {
    "windowsAuthentication": false,
    "anonymousAuthentication": true,
    "iisExpress": {
      "applicationUrl": "http://localhost:20767",
      "sslPort": 0
    }
  },
  "profiles": {
    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "applicationUrl": "http://localhost:5156",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}

================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Services\EmailService.cs
================================================================================
﻿// Đảm bảo file này nằm trong: WebCafebookApi/Services/EmailService.cs
using System.Net;
using System.Net.Mail;
using System.Threading.Tasks;
using Microsoft.Extensions.Options;
using System;

namespace WebCafebookApi.Services
{
    public class EmailService
    {
        private readonly SmtpSettings _smtpSettings;

        public EmailService(IOptions<SmtpSettings> smtpSettings)
        {
            _smtpSettings = smtpSettings.Value;
        }

        public async Task SendEmailAsync(string toEmail, string subject, string body)
        {
            try
            {
                using (var client = new SmtpClient(_smtpSettings.Host, _smtpSettings.Port))
                {
                    client.EnableSsl = _smtpSettings.EnableSsl;
                    client.UseDefaultCredentials = false;
                    client.Credentials = new NetworkCredential(_smtpSettings.Username, _smtpSettings.Password);

                    var mailMessage = new MailMessage
                    {
                        // Lỗi CS1061 xảy ra ở đây nếu _smtpSettings.Username rỗng
                        From = new MailAddress(_smtpSettings.Username, _smtpSettings.FromName),
                        Subject = subject,
                        Body = body,
                        IsBodyHtml = true,
                    };
                    mailMessage.To.Add(toEmail);

                    await client.SendMailAsync(mailMessage);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error sending email to {toEmail}: {ex}");
                throw new ApplicationException($"Không thể gửi email: {ex.Message}", ex);
            }
        }

        // Hàm tiện ích để gửi mã xác nhận
        public Task SendVerificationCodeAsync(string toEmail, string code)
        {
            string subject = "Cafebook - Mã Xác Nhận Đặt Lại Mật Khẩu";
            string body = $@"
                <div style='font-family: Arial, sans-serif; line-height: 1.6;'>
                <p>Xin chào,</p>
                <p>Bạn nhận được email này vì đã yêu cầu đặt lại mật khẩu cho tài khoản Cafebook của bạn.</p>
                <p>Mã xác nhận của bạn là: <strong style='font-size: 1.5em; color: #D27D2D;'>{code}</strong></p>
                <p>Mã này sẽ hết hạn sau 5 phút.</p>
                <p>Nếu bạn không yêu cầu đặt lại mật khẩu, vui lòng bỏ qua email này.</p>
                <p>Trân trọng,<br/>Đội ngũ Cafebook</p>
                </div>";
            return SendEmailAsync(toEmail, subject, body);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Services\SessionHelper.cs
================================================================================
﻿using Microsoft.AspNetCore.Http;
using System.Text.Json;

namespace WebCafebookApi.Services
{
    // Helper để lưu và đọc object từ Session
    public static class SessionExtensions
    {
        public const string CartKey = "CafeBookCart"; // Dùng key này thống nhất

        public static void Set<T>(this ISession session, string key, T value)
        {
            session.SetString(key, JsonSerializer.Serialize(value));
        }

        public static T? Get<T>(this ISession session, string key)
        {
            var value = session.GetString(key);
            return value == null ? default : JsonSerializer.Deserialize<T>(value);
        }
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\Services\SmtpSettings.cs
================================================================================
﻿// Đảm bảo file này nằm trong: WebCafebookApi/Services/SmtpSettings.cs
namespace WebCafebookApi.Services
{
    public class SmtpSettings
    {
        public string Host { get; set; } = string.Empty;
        public int Port { get; set; }
        public string Username { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public bool EnableSsl { get; set; }
        public string FromName { get; set; } = string.Empty;
    }
}
================================================================================

E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\favicon.ico
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\css\site.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\images\default-avatar.png
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\images\default-book-cover.png
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\images\default-food-icon.png
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\images\logo.ico
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\images\logo.png
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\js\profile.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\js\site.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\LICENSE
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-grid.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-grid.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-grid.min.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-grid.min.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-grid.rtl.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-grid.rtl.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-grid.rtl.min.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-grid.rtl.min.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-reboot.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-reboot.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-reboot.min.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-reboot.min.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-reboot.rtl.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-reboot.rtl.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-reboot.rtl.min.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-reboot.rtl.min.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-utilities.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-utilities.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-utilities.min.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-utilities.min.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-utilities.rtl.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-utilities.rtl.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-utilities.rtl.min.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap-utilities.rtl.min.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap.min.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap.min.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap.rtl.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap.rtl.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap.rtl.min.css
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\css\bootstrap.rtl.min.css.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.bundle.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.bundle.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.bundle.min.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.bundle.min.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.esm.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.esm.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.esm.min.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.esm.min.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.min.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\bootstrap\dist\js\bootstrap.min.js.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery\LICENSE.txt
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery\dist\jquery.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery\dist\jquery.min.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery\dist\jquery.min.map
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery-validation\LICENSE.md
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery-validation\dist\additional-methods.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery-validation\dist\additional-methods.min.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery-validation\dist\jquery.validate.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery-validation\dist\jquery.validate.min.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery-validation-unobtrusive\jquery.validate.unobtrusive.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery-validation-unobtrusive\jquery.validate.unobtrusive.min.js
E:\Tai Lieu Hoc Tap\CS 445 AM\Project\WebCafebookApi\wwwroot\lib\jquery-validation-unobtrusive\LICENSE.txt
